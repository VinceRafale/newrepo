var servicesModule=angular.module("groupsService",[]);servicesModule.factory("GroupsService",["$http","$rootScope","$timeout","$translate","authHttp","Environment","AccountService","GeneralService","StorageService",function(e,r,t,o,s,n,i,u,c){function a(e){var r=new Date((new Date).getTime()+9e5);d.nextAllowedPosts[e.id]=r,c.setItem("nextAllowedPosts",JSON.stringify(d.nextAllowedPosts))}function l(e){var r=new Date((new Date).getTime()+3e5);d.nextAllowedComments[e]=r,c.setItem("nextAllowedComments",JSON.stringify(d.nextAllowedComments))}function p(){var e={};return e.success=function(r){return e.successCallback=r,e},e.error=function(r){return e.errorCallback=r,e},e}function f(){var e=i.getUserNotification();if(e.groupNotificationCount=0,e.communityNotificationCount=0,e){if(e.postNotifications)for(var r in e.postNotifications){var t=e.postNotifications[r];t&&(e.communityNotificationCount+=t.actions)}if(e.groupNotifications)for(var o in e.groupNotifications){var s=e.groupNotifications[o];s&&(e.groupNotificationCount+=s.actions)}}}function v(e,r,t){var o=e.curatedGroups[r];o||(o=[],e.curatedCategories.push(r),e.curatedGroups[r]=o),o.push(t)}var d={userGroupContext:void 0,publicGroupContext:void 0,publicGroupsById:{},profileLikes:void 0,profileShares:void 0,profileComments:void 0,lastActiveTab:"communities",nextAllowedPosts:{},nextAllowedComments:{},nextUserGroupUpdate:void 0,nextPublicGroupUpdate:void 0,nextProfileSharesUpdate:void 0,lastProfileSharesOffset:0,nextProfileLikesUpdate:void 0,lastProfileLikesOffset:0,nextProfileCommentsUpdate:void 0,nextProfileCommentsOffset:0};d.logout=function(){d.userGroupContext=void 0,d.publicGroupContext=void 0,d.publicGroupsById={},d.profileLikes=void 0,d.profileShares=void 0,d.nextUserGroupUpdate=void 0,d.nextPublicGroupUpdate=void 0,d.nextProfileSharesUpdate=void 0,d.lastProfileSharesOffset=0,d.nextProfileLikesUpdate=void 0,d.lastProfileLikesOffset=0,d.nextProfileCommentsUpdate=void 0,d.nextProfileCommentsOffset=0,d.lastActiveTab="communities"},r.$on("event:pacificaReady",function(){c.getItem("nextAllowedPosts",function(e){e&&(d.nextAllowedPosts=JSON.parse(e))}),c.getItem("nextAllowedComments",function(e){e&&(d.nextAllowedComments=JSON.parse(e))}),c.getItem("lastActiveGroupsTab",function(e){e&&(d.lastActiveTab=e)})}),d.getLastActiveTab=function(){var e=i.getAccountUser().user,r=new Date(e.createdAtStr).getTime(),t=(new Date).getTime();return!savedLastActiveTab&&t>r+864e5?"groups":d.lastActiveTab},d.setLastActiveTab=function(e){d.lastActiveTab=e,c.setItem("lastActiveGroupsTab",e),savedLastActiveTab=e},d.findPublicGroupName=function(e){var r=d.publicGroupsById[e];return r?r.name:void 0},d.findPublicGroups=function(e){var r=p();return e||!d.publicGroupContext||!d.nextPublicGroupUpdate||d.nextPublicGroupUpdate<new Date?s.get(n.serverURL+"/groups/public").success(function(e){if(d.publicGroupContext=e,d.publicGroupContext.publicGroups)for(var t=0;t<d.publicGroupContext.publicGroups.length;++t){var o=d.publicGroupContext.publicGroups[t];d.publicGroupsById[o.id]=o}d.publicGroupContext.nextAllowedPostStr&&(d.nextAllowedPost=new Date(d.publicGroupContext.nextAllowedPostStr)),d.nextPublicGroupUpdate=new Date((new Date).getTime()+3e5),r.successCallback&&r.successCallback(e)}).error(function(e){r.errorCallback&&r.errorCallback()}):t(function(){r.successCallback&&r.successCallback(d.publicGroupContext)}),r},d.getCachedUserGroups=function(){return d.userGroupContext},d.findUserGroups=function(e){var r=p();return e||!d.userGroupContext||!d.nextUserGroupUpdate||d.nextUserGroupUpdate<new Date?s.get(n.serverURL+"/groups/user").success(function(e){d.userGroupContext=e,d.nextUserGroupUpdate=new Date((new Date).getTime()+6e4),r.successCallback&&r.successCallback(e)}).error(function(e){r.errorCallback&&r.errorCallback()}):(t(function(){r.successCallback&&r.successCallback(d.userGroupContext)}),s.get(n.serverURL+"/groups/invites").success(function(e){d.userGroupContext&&(d.userGroupContext.pendingInvites.length=0,d.userGroupContext.pendingInvites.push.apply(d.userGroupContext.pendingInvites,e))}).error(function(e){})),r};var C,g={},m={};d.storeCachedPost=function(e,r,t){g[e.id]=e,m=r,C=t},d.getCachedPost=function(e){return g[e]},d.getCachedPostData=function(e){return m?m[e]:void 0},d.getCachedUserVotes=function(){return C},d.getGroupImmediate=function(e){for(var r=d.userGroupContext.userGroups,t=0;t<r.length;++t){var o=r[t];if(o.id==e)return o}for(var s=0;s<d.publicGroupContext.publicGroups.length;++s){var n=d.publicGroupContext.publicGroups[s];if(n.id==e)return n}},d.getGroup=function(e){function r(){for(var r=d.userGroupContext.userGroups,t=0;t<r.length;++t){var o=r[t];if(o.id==e){s.successCallback&&s.successCallback(o);break}}}function o(){for(var r=0;r<d.publicGroupContext.publicGroups.length;++r){var t=d.publicGroupContext.publicGroups[r];if(t.id==e){s.successCallback&&s.successCallback(t);break}}}var s=p();return d.userGroupContext?t(r):d.findUserGroups().success(function(){r()}).error(function(){s.errorCallback&&s.errorCallback()}),d.publicGroupContext&&d.publicGroupContext.publicGroups?t(o):d.findPublicGroups().success(function(){o()}).error(function(){s.errorCallback&&s.errorCallback()}),s},d.getGroupPost=function(e){return s.get(n.serverURL+"/groups/post?postId="+e)},d.findGroupPostComments=function(e,r,t,o){return s.get(n.serverURL+"/groups/posts/comments/?postId="+e+"&order="+r+"&limit="+t+"&offset="+o)},d.findGroupPosts=function(e,r,t,o){return s.get(n.serverURL+"/groups/posts?groupId="+e.id+"&order="+r+"&limit="+t+"&offset="+o)},d.findNewerPosts=function(e,r){return s.get(n.serverURL+"/groups/posts/newer?groupId="+e.id+"&lastTime="+r.getTime())},d.canCreatePublicGroupPost=function(e){var r=d.nextAllowedPosts[e.id];return"string"==typeof r&&(r=new Date(r)),!r||new Date>r},d.canCreatePublicComment=function(e){var r=d.nextAllowedComments[e];return"string"==typeof r&&(r=new Date(r)),!r||new Date>r},d.postComment=function(e,r,t){var o=p();return s.post(n.serverURL+"/groups/post/comment",{postId:e,groupId:r,title:t}).success(function(e){l(r),o.successCallback&&o.successCallback(e)}).error(function(){o.errorCallback&&o.errorCallback()}),o},d.createGroupPost=function(e,r,t){var o=p();return s.post(n.serverURL+"/groups/post",{groupId:e,title:r,postData:t}).success(function(r){var t=d.getGroupImmediate(e);t.private||(d.publicGroupContext.userShares++,d.profileShares=void 0,a(t),i.recordActivity("POSTED_TO_COMMUNITY")),o.successCallback&&o.successCallback(r)}).error(function(){o.errorCallback&&o.errorCallback()}),o},d.archiveComment=function(e){return s.post(n.serverURL+"/groups/post/comment/archive",{postCommentId:e})},d.archivePost=function(e){var r=p();return s.post(n.serverURL+"/groups/post/archive",{postId:e}).success(function(e){d.profileShares=void 0,r.successCallback&&r.successCallback(e)}).error(function(){r.errorCallback&&r.errorCallback()}),r},d.reportPost=function(e,r,t){var o=p();return s.post(n.serverURL+"/groups/post/report",{postId:e,reason:r,refer:t}).success(function(e){d.profileLikes=void 0,o.successCallback&&o.successCallback(e)}).error(function(){o.errorCallback&&o.errorCallback()}),o},d.reportComment=function(e,r,t){return s.post(n.serverURL+"/groups/post/comment/report",{postCommentId:e,reason:r,refer:t})},d.archiveGroup=function(e){var r=p();return s.post(n.serverURL+"/groups/archive",{groupId:e}).success(function(){if(d.userGroups)for(var t=0;t<d.userGroups.length;++t){var o=d.userGroups[t];if(o.id==e){d.userGroups.splice(t,1);break}}r.successCallback&&r.successCallback()}).error(function(e){r.errorCallback&&r.errorCallback()}),r},d.editGroup=function(e,r,t,o,i){var u=p();return s.post(n.serverURL+"/groups/edit",{groupId:e,name:r,nickname:t,description:o,searchable:i}).success(function(){var s=d.getGroupImmediate(e);s.name=r,s.nickname=t,s.description=o,s.searchable=i,u.successCallback&&u.successCallback(s)}).error(function(e,r,t,o){u.errorCallback&&u.errorCallback(e,r,t,o)}),u},d.editGroupNickname=function(e,r){var t=p();return s.post(n.serverURL+"/groups/editNickname",{groupId:e,nickname:r}).success(function(){var o=d.getGroupImmediate(e);o.nickname=r,t.successCallback&&t.successCallback(o)}).error(function(e,r,o,s){t.errorCallback&&t.errorCallback(e,r,o,s)}),t},d.createGroup=function(e,r,t,o){var i=p();return s.post(n.serverURL+"/groups/create",{name:e,nickname:r,description:t,searchable:o}).success(function(e){d.userGroupContext.userGroups||(d.userGroupContext.userGroups=[]),d.userGroupContext.userGroups.push(e),i.successCallback&&i.successCallback(e)}).error(function(e,r,t,o){i.errorCallback&&i.errorCallback(e,r,t,o)}),i},d.removeVote=function(e){var r=p();return s.post(n.serverURL+"/groups/post/removeVote",{postId:e.id}).success(function(){d.profileLikes=void 0,r.successCallback&&r.successCallback()}).error(function(){r.errorCallback&&r.errorCallback()}),r},d.voteUp=function(e,r){var t=p();return s.post(n.serverURL+"/groups/post/voteUp",{postId:e,groupId:r}).success(function(){d.profileLikes=void 0,t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},d.clearAllPostNotifications=function(){var e=i.getUserNotification();e&&e.postNotifications&&s.post(n.serverURL+"/groups/post/clearAllNotifications").success(function(){e.postNotifications.cleared=!0}).error(function(){})},d.clearPostNotification=function(e){var r=i.getUserNotification();if(r&&r.postNotifications){var t=r.postNotifications[e];t&&s.post(n.serverURL+"/groups/post/clearNotification",{postId:e}).success(function(){delete r.postNotifications[e],f()}).error(function(){})}},d.clearAllGroupNotifications=function(){var e=i.getUserNotification();e&&e.groupNotifications&&s.post(n.serverURL+"/groups/group/clearAllNotifications").success(function(){e.groupNotifications.cleared=!0}).error(function(){})},d.clearGroupNotification=function(e){var r=i.getUserNotification();if(r&&r.groupNotifications){var t=r.groupNotifications[e];t&&s.post(n.serverURL+"/groups/group/clearNotification",{groupId:e}).success(function(){delete r.groupNotifications[e],f()}).error(function(){})}},d.hasPostNotification=function(e){return d.getPostNotificationCount(e)>0},d.getPostNotificationCount=function(e){var r=i.getUserNotification();if(r.postNotifications){if(!e){if(r.postNotifications.cleared)return 0;var t=0;for(var o in r.postNotifications){var s=r.postNotifications[o];t+=s.actions}return t}var n=r.postNotifications[e];if(n)return n.actions}return 0},d.hasGroupNotification=function(e){var r=i.getUserNotification();if(r.groupNotifications){var t=r.groupNotifications[e];return!!t}return!1},d.getGroupNotificationCount=function(e){var r=i.getUserNotification();if(r.groupNotifications){if(!e){if(r.groupNotifications.cleared)return 0;var t=0;for(var o in r.groupNotifications){var s=r.groupNotifications[o];t+=s.actions}return t}var n=r.groupNotifications[e];if(n)return n.actions}return 0},d.removeCommentVote=function(e){return s.post(n.serverURL+"/groups/post/comment/removeVote",{postCommentId:e.id})},d.voteCommentUp=function(e,r,t){return s.post(n.serverURL+"/groups/post/comment/voteUp",{postCommentId:e,postId:r,groupId:t})},d.inviteExistingUser=function(e,r,t){return s.post(n.serverURL+"/groups/inviteExistingUser",{groupId:e,userId:r,text:t})},d.sendInvites=function(e,r,t){return s.post(n.serverURL+"/groups/sendInvites",{groupId:e,emails:r,text:t})},d.acceptInvite=function(e,r){return s.post(n.serverURL+"/groups/acceptInvite",{groupId:e,nickname:r})},d.joinGroup=function(e,r){return s.post(n.serverURL+"/groups/joinGroup",{groupCode:e,nickname:r})},d.joinRandomGroup=function(e,r){return s.post(n.serverURL+"/groups/joinRandomGroup",{goal:e,language:r})},d.deleteInvite=function(e,r){var t={groupId:e};return r&&(t.email=r),s.post(n.serverURL+"/groups/deleteInvite",t)},d.leaveGroup=function(e){var r=p();return s.post(n.serverURL+"/groups/leave",{groupId:e}).success(function(){if(d.userGroupContext.userGroups)for(var t=0;t<d.userGroupContext.userGroups.length;++t){var o=d.userGroupContext.userGroups[t];if(o.id==e){d.userGroupContext.userGroups.splice(t,1);break}}r.successCallback&&r.successCallback()}).error(function(e){r.errorCallback&&r.errorCallback()}),r},d.getShares=function(e,r,o){var i=p();if(o||!d.profileShares||d.lastProfileSharesOffset!=r||!d.nextProfileSharesUpdate||d.nextProfileSharesUpdate<new Date){d.lastProfileSharesOffset=r;var u=n.serverURL+"/groups/shares?limit="+e+"&offset="+r;o&&(u+="&userId="+o),s.get(u).success(function(e){o||(d.profileShares=e,d.nextProfileSharesUpdate=new Date((new Date).getTime()+3e5)),i.successCallback&&i.successCallback(e)}).error(function(e){i.errorCallback&&i.errorCallback()})}else t(function(){i.successCallback&&i.successCallback(d.profileShares)});return i},d.getUserLikes=function(e){if(!e||0===e.length)return p();for(var r=n.serverURL+"/groups/userLikes?ids=",t=0;t<e.length;++t)t>0&&(r+="&ids="),r+=e[t].id;return s.get(r)},d.getUserCommentLikes=function(e){if(!e||0===e.length)return p();for(var r=n.serverURL+"/groups/userCommentLikes?ids=",t=0;t<e.length;++t)t>0&&(r+="&ids="),r+=e[t].id;return s.get(r)},d.getLikes=function(e,r,o){var i=p();if(o||!d.profileLikes||d.lastProfileLikesOffset!=r||!d.nextProfileLikesUpdate||d.nextProfileLikesUpdate<new Date){d.lastProfileLikesOffset=r;var u=n.serverURL+"/groups/likes?limit="+e+"&offset="+r;o&&(u+="&userId="+o),s.get(u).success(function(e){o||(d.profileLikes=e,d.nextProfileLikesUpdate=new Date((new Date).getTime()+6e4)),i.successCallback&&i.successCallback(e)}).error(function(e){i.errorCallback&&i.errorCallback()})}else t(function(){i.successCallback&&i.successCallback(d.profileLikes)});return i},d.getComments=function(e,r,o){var i=p();if(o||!d.profileComments||d.lastProfileCommentsOffset!=r||!d.nextProfileCommentsUpdate||d.nextProfileCommentsUpdate<new Date){d.lastProfileCommentsOffset=r;var u=n.serverURL+"/groups/comments?limit="+e+"&offset="+r;o&&(u+="&userId="+o),s.get(u).success(function(e){o||(d.profileComments=e,d.nextProfileCommentsUpdate=new Date((new Date).getTime()+6e4)),i.successCallback&&i.successCallback(e)}).error(function(e){i.errorCallback&&i.errorCallback()})}else t(function(){i.successCallback&&i.successCallback(d.profileComments)});return i},d.getGroupUsers=function(e){return s.get(n.serverURL+"/groups/users?groupId="+e)},d.removeUser=function(e,r){return s.post(n.serverURL+"/groups/removeUser",{groupId:e,userId:r})},d.findCuratedGroups=function(){return s.get(n.serverURL+"/groups/curated")},d.initializeCuratedGroups=function(e,r){e.curatedGroups=void 0,e.curatedCategories=[];var t=d.userGroupContext?d.userGroupContext.userGroups:void 0;if(r&&r.length>0){e.curatedGroups={};for(var o=0;o<r.length;++o){var s=r[o],n=!1;if(t)for(var i=0;i<t.length;++i)if(t[i].id==s.id){n=!0;break}if(!n)if(s.curatedCategories){var u=s.curatedCategories.split(";");if(u.length>0)for(var c=0;c<u.length;++c)v(e,u[c],s)}else v(e,"Other",s)}if(e.curatedCategories.length>0){e.curatedCategories.sort();for(var a in e.curatedGroups){var l=e.curatedGroups[a];l.sort(function(e,r){return e.name.localeCompare(r.name)})}}}};var b=0;return d.searchForGroup=function(e){++b;var r=p();return s.get(n.serverURL+"/groups/search?query="+e+"&searchId="+b).success(function(e){e.searchId==b&&r.successCallback&&r.successCallback(e.groups)}).error(function(e){r.errorCallback&&r.errorCallback()}),r},d}]);