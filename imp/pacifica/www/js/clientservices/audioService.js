function createPromise(){var t={};return t.success=function(e){return t.successCallback=e,t},t.error=function(e){return t.errorCallback=e,t},t}var servicesModule=angular.module("audioService",[]);servicesModule.factory("AudioService",["$rootScope","$timeout","$translate","authHttp","TokenService","Environment","GeneralService","StorageService",function(t,e,o,i,u,r,n,a){function h(){if(c.audioContext.thoughts&&c.audioContext.thoughts.length>10){var t=$.extend(!0,{},c.audioContext);t.thoughts.splice(10,t.thoughts.length-10),a.setItem("audioContext",JSON.stringify(t))}else a.setItem("audioContext",JSON.stringify(c.audioContext))}function s(t){if(t.tags){for(var e=0;e<t.tags.length;++e)t.tags[e].recordingId=t.id;return i.post(r.serverURL+"/audio/tag",{tags:t.tags})}}function g(t,e){var o={};if(o.title=t.title,o.type=t.type,o.duration=t.duration,o.thoughtId=e,t.localUrl){var n=function(e){t.id=+e.response,s(t)},a=function(t){alert("An error has occurred: Code = "+t.code)},h=new FileUploadOptions;h.fileKey="file",h.fileName=t.title,h.mimeType=t.title.endsWith(".mp4")?"audio/mp4":"audio/amr",h.params=o;var g={Session:u.getToken()};if(h.headers=g,r.isOnline()&&window.FileTransfer){var c=new FileTransfer;c.upload(t.localUrl,encodeURI(r.serverURL+"/audio/upload"),n,a,h)}}else o.notes=t.notes,i.post(r.serverURL+"/audio/postTextRecording",o).success(function(e){t.id=+e,s(t)}).error(function(t){})}var c={audioContext:{},activeThoughtId:void 0,activeSources:{},activeTextThought:void 0,activeTextHighlights:void 0};c.setActiveThoughtId=function(t){c.activeThoughtId=t},c.getActiveThoughtId=function(){return c.activeThoughtId},c.setActiveSource=function(t,e){c.activeSources[t]=e},c.getActiveSource=function(t){return c.activeSources[t]},t.$on("event:pacificaReady",function(){a.getItem("audioContext",function(t){t&&(c.audioContext=JSON.parse(t))}),a.getItem("activeTextThought",function(t){t&&(c.activeTextThought=t)}),a.getItem("activeTextHighlights",function(t){t&&(c.activeTextHighlights=JSON.parse(t))})}),c.storeActiveTextThought=function(t){c.activeTextThought=t,a.setItem("activeTextThought",t)},c.getActiveTextThought=function(){return c.activeTextThought},c.clearActiveTextThought=function(){c.activeTextThought=void 0,localStorage.removeItem("activeTextThought"),c.clearActiveTextHighlight()},c.clearActiveTextHighlight=function(){c.activeTextHighlights=void 0,localStorage.removeItem("activeTextHighlights")},c.storeActiveTextHighlights=function(t){c.activeTextHighlights=t,a.setItem("activeTextHighlights",JSON.stringify(t))},c.getActiveTextHighlights=function(){return c.activeTextHighlights};var d;return c.setTextThoughtForReview=function(t){d=t},c.getTextThoughtForReview=function(){return d},c.setAudioContext=function(t){var e=[];if(c.audioContext.thoughts)for(var o=c.audioContext.thoughts.length-1;o>=0;--o){var i=c.audioContext.thoughts[o];isNumeric(i.id)||i.saving||e.push(i)}c.audioContext=t,c.audioContext.thoughts||(c.audioContext.thoughts=[]);for(var u=0;u<e.length;++u)c.audioContext.thoughts.push(e[u]);h()},c.logout=function(){c.audioContext={}},c.getThoughts=function(){return c.audioContext.thoughts},c.getThoughtCount=function(){return c.audioContext.totalThoughts},c.clearNonPersistedThoughts=function(){if(c.audioContext.thoughts)for(var t=c.audioContext.thoughts.length-1;t>=0;--t){var e=c.audioContext.thoughts[t];isNumeric(e.id)||e.saving||e.id==c.activeThoughtId||c.audioContext.thoughts.splice(t,1)}h()},c.getThought=function(t){if(c.audioContext.thoughts)for(var e=0;e<c.audioContext.thoughts.length;++e){var o=c.audioContext.thoughts[e];if(o.id==t||o.generatedId==t)return o}},c.createThought=function(t){c.clearNonPersistedThoughts();var e=o.instant(t?t:"THOUGHT_RECORD"),i=e.replace(/ /g,"\\s");i+="\\s[0-9]*";var u=new RegExp(i),r=0;if(c.audioContext.thoughts)for(var n=0;n<c.audioContext.thoughts.length;++n){var a=c.audioContext.thoughts[n].title;if(u.test(a)){var h=a.split(" "),s=parseInt(h[h.length-1]);s>r&&(r=s)}}var g=e+" "+(r+1),d={id:generateGUID(),title:g,createdAt:(new Date).getTime(),createdAtString:(new Date).toString(),recordings:{}};return c.audioContext.thoughts||(c.audioContext.thoughts=[]),c.audioContext.thoughts.splice(0,0,d),++c.audioContext.totalThoughts,d},c.addRecording=function(t,e,o,i,u,r){var n={id:generateGUID(),title:e,type:o,duration:i,recordedAt:(new Date).getTime(),recordedAtString:(new Date).toString(),localUrl:t,url:e,notes:r},a=c.getThought(u);return a.recordings[o]=n,n},c.addTags=function(t,e){for(var o=t.recordings.thought,i=[],u=0;u<e.length;++u){var r=e[u];i.push({tagTypeString:r.positive?"positive":"negative",tagTime:r.tagTime,tagString:r.tags.join(",")})}o.tags?Array.prototype.push.apply(o.tags,i):o.tags=i},c.postThought=function(t,e){var o=c.getThought(t);o.thoughtType=e,o.saving=!0,i.post(r.serverURL+"/audio/createThoughtWithType",{title:o.title,thoughtType:e}).success(function(t){o.generatedId=o.id,o.id=t;for(var e in o.recordings){var i=o.recordings[e];g(i,o.id)}c.clearActiveTextThought()})},c.archiveThought=function(t){var e=createPromise();if(c.audioContext.thoughts)for(var o=0;o<c.audioContext.thoughts.length;++o){var u=c.audioContext.thoughts[o];if(u.id==t){c.audioContext.thoughts.splice(o,1),i.post(r.serverURL+"/audio/archiveThought",t).success(function(){--c.audioContext.totalThoughts,e.successCallback&&e.successCallback()}).error(function(t){e.errorCallback&&e.errorCallback()});break}}return e},c.updateThoughtTitle=function(t,e){if(c.audioContext.thoughts)for(var o=0;o<c.audioContext.thoughts.length;++o){var u=c.audioContext.thoughts[o];if(u.id==t){u.title=e,h(),i.post(r.serverURL+"/audio/updateThoughtTitle",{thoughtId:t,title:e});break}}},c.loadMoreThoughts=function(t,e){var o=createPromise();return i.get(r.serverURL+"/audio/thoughts?offset="+t+"&limit="+e).success(function(t){if(t){c.audioContext.thoughts||(c.audioContext.thoughts=[]);for(var e=0;e<t.length;++e){for(var i=t[e],u=!1,r=0;r<c.audioContext.thoughts.length;++r){var n=c.audioContext.thoughts[r];if(n.id==i.id){u=!0;break}}u||c.audioContext.thoughts.push(i)}}o.successCallback&&o.successCallback()}).error(function(){o.errorCallback&&o.errorCallback()}),o},c}]);