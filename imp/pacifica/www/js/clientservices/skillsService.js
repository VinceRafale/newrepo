function createPromise(){var t={};return t.success=function(a){return t.successCallback=a,t},t.error=function(a){return t.errorCallback=a,t},t}var servicesModule=angular.module("skillsService",[]);servicesModule.factory("SkillsService",["$http","$rootScope","$translate","$timeout","$ionicModal","authHttp","Environment","AccountService","HabitsService","GoalsService","StorageService","GeneralService","Token",function(t,a,i,e,n,s,E,o,l,c,T){function C(){v.skillContext&&T.setItem("skillContext",JSON.stringify(v.skillContext))}function L(t,a,i,e){if(!i||l.metGoalWithHabitData(a)){var n={actionClass:"health",skillSubClass:t.name.toLowerCase(),actionTitle:l.getHabitName(t),actionTimestamp:a.experiencedAt,data:a};if(t.id==l.MOOD_HABIT_ID){var s=l.getHabitValueById(a.habitValueId);n.actionClass=t.name.toLowerCase(),n.skillSubClass=l.getMoodClass(s),n.actionTitle=l.getHabitDisplayById(t,a.habitValueId)}else if(t.id==l.STRESS_HABIT_ID){var s=l.getHabitValueById(a.habitValueId);n.actionClass=t.name.toLowerCase(),n.skillSubClass=l.getStressClass(s),n.actionTitle=l.getHabitDisplayById(t,a.habitValueId)}e.push(n)}}function _(t,a,i,e){e.push({actionClass:i.actionClass,actionTitle:i.actionTitle,actionTimestamp:a,data:t})}function r(t){for(var a=0;a<t.length;++a){var i=t[a];"Date"!=typeof i.actionTimestamp&&(i.actionTimestamp=new Date(i.actionTimestamp))}t.sort(function(t,a){return a.actionTimestamp-t.actionTimestamp});for(var e=!1,n=0;n<t.length;++n){var s=t[n];"mood"==s.actionClass?(0==n&&(s.showActionButton=!0),e&&(s.moodRespondedTo=!0),e=!1):e=!0}}function I(t){var a={COMPLETED_BREATHING:{activityName:"COMPLETED_BREATHING",actionClass:"deep-breathing",actionTitle:i.instant("COMPLETED_DEEP_BREATHING")},COMPLETED_MUSCLE_RELAXATION:{activityName:"COMPLETED_MUSCLE_RELAXATION",actionClass:"muscle-relaxation",actionTitle:i.instant("COMPLETED_MUSCLE_RELAXATION")},COMPLETED_POSITIVE_VISUALIZATION:{activityName:"COMPLETED_POSITIVE_VISUALIZATION",actionClass:"positive-visualization",actionTitle:i.instant("COMPLETED_POSITIVE_VISUALIZATION")},COMPLETED_MINDFULNESS:{activityName:"COMPLETED_MINDFULNESS",actionTitle:i.instant("COMPLETED_MINDFULNESS")},COMPLETED_RETHINK:{activityName:"COMPLETED_RETHINK",actionClass:"thought",actionTitle:i.instant("COMPLETED_THINKING_TRAPS")},COMPLETED_JOURNAL:{activityName:"COMPLETED_JOURNAL",actionClass:"journal",actionTitle:i.instant("COMPLETED_JOURNAL")},COMPLETED_UNGUIDED_MEDITATION:{activityName:"COMPLETED_UNGUIDED_MEDITATION",actionClass:"unguided-meditation",actionTitle:i.instant("COMPLETED_UNGUIDED_MEDITATION")},COMPLETED_SS_SOCIAL_SITUATIONS:{activityName:"COMPLETED_SS_SOCIAL_SITUATIONS",actionClass:"social-situations",actionTitle:i.instant("COMPLETED_SS_SOCIAL_SITUATIONS")},COMPLETED_SS_FLYING:{activityName:"COMPLETED_SS_FLYING",actionClass:"flying",actionTitle:i.instant("COMPLETED_SS_FLYING")},COMPLETED_SS_PUBLIC_SPEAKING:{activityName:"COMPLETED_SS_PUBLIC_SPEAKING",actionClass:"public-speaking",actionTitle:i.instant("COMPLETED_SS_PUBLIC_SPEAKING")},COMPLETED_SS_PUBLIC_TRANSIT:{activityName:"COMPLETED_SS_PUBLIC_TRANSIT",actionClass:"public-transit",actionTitle:i.instant("COMPLETED_SS_PUBLIC_TRANSIT")},COMPLETED_MINDFUL_SENSES:{activityName:"COMPLETED_MINDFUL_SENSES",actionClass:"mindful-senses",actionTitle:i.instant("COMPLETED_MINDFUL_SENSES")},COMPLETED_MINDFUL_BREATHE:{activityName:"COMPLETED_MINDFUL_BREATHE",actionClass:"mindful-breathe",actionTitle:i.instant("COMPLETED_MINDFUL_BREATHE")},COMPLETED_MINDFUL_OBSERVE:{activityName:"COMPLETED_MINDFUL_OBSERVE",actionClass:"mindful-observe",actionTitle:i.instant("COMPLETED_MINDFUL_OBSERVE")},COMPLETED_MINDFUL_BODY_SCAN:{activityName:"COMPLETED_MINDFUL_BODY_SCAN",actionClass:"mindful-body-scan",actionTitle:i.instant("COMPLETED_MINDFUL_BODY_SCAN")},COMPLETED_MINDFUL_WALK:{activityName:"COMPLETED_MINDFUL_WALK",actionClass:"mindful-walk",actionTitle:i.instant("COMPLETED_MINDFUL_WALK")},COMPLETED_CALM_BREATHE:{activityName:"COMPLETED_CALM_BREATHE",actionClass:"calm-breathe",actionTitle:i.instant("COMPLETED_CALM_BREATHE")},COMPLETED_CALM_MIND:{activityName:"COMPLETED_CALM_MIND",actionClass:"calm-mind",actionTitle:i.instant("COMPLETED_CALM_MIND")},COMPLETED_PANIC_EMERGENCY:{activityName:"COMPLETED_PANIC_EMERGENCY",actionClass:"panic-emergency",actionTitle:i.instant("COMPLETED_PANIC_EMERGENCY")},COMPLETED_SLEEP:{activityName:"COMPLETED_SLEEP",actionClass:"sleep",actionTitle:i.instant("COMPLETED_SLEEP")},COMPLETED_GRATITUDE:{activityName:"COMPLETED_GRATITUDE",actionClass:"gratitude",actionTitle:i.instant("COMPLETED_GRATITUDE")},COMPLETED_BECOMING_THE_TREE:{activityName:"COMPLETED_BECOMING_THE_TREE",actionClass:"becoming-the-tree",actionTitle:i.instant("COMPLETED_BECOMING_THE_TREE")},COMPLETED_DIFFICULT_EXPERIENCE:{activityName:"COMPLETED_DIFFICULT_EXPERIENCE",actionClass:"difficult-experience",actionTitle:i.instant("COMPLETED_DIFFICULT_EXPERIENCE")},COMPLETED_SELF_COMPASSION:{activityName:"COMPLETED_SELF_COMPASSION",actionClass:"self-compassion",actionTitle:i.instant("COMPLETED_SELF_COMPASSION")},COMPLETED_EMPATHY:{activityName:"COMPLETED_EMPATHY",actionClass:"empathy",actionTitle:i.instant("COMPLETED_EMPATHY")},COMPLETED_DEFUSION:{activityName:"COMPLETED_DEFUSION",actionClass:"intense-emotions",actionTitle:i.instant("COMPLETED_DEFUSION")},COMPLETED_POSITIVE_RETHINK:{activityName:"COMPLETED_POSITIVE_RETHINK",actionClass:"thoughts",actionTitle:i.instant("COMPLETED_POSITIVE_RETHINK")},POSTED_TO_COMMUNITY:{activityName:"POSTED_TO_COMMUNITY",actionClass:"social",actionTitle:i.instant("POSTED_TO_COMMUNITY")},COMPLETED_GRATITUDE_JOURNAL:{activityName:"COMPLETED_GRATITUDE_JOURNAL",actionClass:"journal",actionTitle:i.instant("COMPLETED_GRATITUDE_JOURNAL")},COMPLETED_POSITIVITY_JOURNAL:{activityName:"COMPLETED_POSITIVITY_JOURNAL",actionClass:"journal",actionTitle:i.instant("COMPLETED_POSITIVITY_JOURNAL")}};return t&&(a.COMPLETED_EXPERIMENT={activityName:"COMPLETED_EXPERIMENT",actionClass:"goals",actionTitle:i.instant("COMPLETED_GOAL")}),a}function M(t,s){function E(t,a){return t=parseInt(t),a=parseInt(a),Math.floor(Math.random()*(a-t+1))+t}function l(t){$.each($(".activityTitle"),function(){for(var a=$(this).width()/50*15,i=0;a>=i;i++){var e=E(30,60);$(this).append('<span class="levelParticle '+t+'" style="bottom:'+E(20,50)+"%; left:"+E(1,99)+"%;width:"+e+"px; height:"+e+"px; font-size:"+e+"px; animation-delay: "+E(0,30)/10+'s;"></span>')}})}if(!(t>=s.length||o.isUMNUser())){var c=a.$new(!0);c.newLevel=s[t].type,c.closeNewLevelModal=function(){++t,t>=s.length?(closeModal(T),T.remove()):(c.newLevel=s[t].type,$(".levelParticle").remove(),e(function(){l(s[t].type)}))},c.getLevelUpButtonText=function(){var a=t>=s.length-1?"DONE":"NEXT";return i.instant(a)},c.getLevelUpTitle=function(){var a=Math.min(t,s.length-1),e=i.instant("ACHIEVED_ACTIVITY_LEVEL");return e=e.replace("XXXLEVELXXX",s[a].level)},c.getLevelUpActivity=function(){var a,e=Math.min(t,s.length-1),n=s[e].type;return"goals"==n?a="EXPERIMENTS_ACTIVITY":"habits"==n?a="HEALTH_ACTIVITY":"relax"==n?a="RELAX_ACTIVITY":"thoughts"==n?a="THOUGHTS_ACTIVITY":"social"==n&&(a="SOCIAL_ACTIVITY"),i.instant(a)};var T=void 0;n.fromTemplateUrl("views/skills/levelUp.modal.html",{scope:c,animation:"slide-in-up"}).then(function(a){T=a,openModal(T),e(function(){l(s[t].type)})})}}function O(t){var a=v.skillContext,i=[];return t&&a&&(t.goalsLevel>a.goalsLevel&&i.push({type:"goals",level:t.goalsLevel}),t.habitsLevel>a.habitsLevel&&i.push({type:"habits",level:t.habitsLevel}),t.relaxLevel>a.relaxLevel&&i.push({type:"relax",level:t.relaxLevel}),t.socialLevel>a.socialLevel&&i.push({type:"social",level:t.socialLevel}),t.thoughtsLevel>a.thoughtsLevel&&i.push({type:"thoughts",level:t.thoughtsLevel}),i.length>0&&M(0,i)),i.length}function D(){var t=createPromise();return E.isOnline()?s.get(E.serverURL+"/skills/context").success(function(a){t.successCallback&&t.successCallback(a)}).error(function(){t.errorCallback&&t.errorCallback()}):e(function(){t.successCallback&&t.successCallback(v.skillContext)}),t}var v={skillContext:void 0,todaysActions:[],todaysActionDate:new Date,suggestedActivityId:void 0};return a.$on("event:pacificaReady",function(){T.getItem("skillContext",function(t){if(t){var a=JSON.parse(t);v.skillContext=a}})}),v.logout=function(){v.skillContext=void 0,v.todaysActions=[],v.todaysActionDate=new Date,v.suggestedActivityId=void 0},v.getSuggestedActivityId=function(){return v.suggestedActivityId},v.setSuggestedActivityId=function(t){v.suggestedActivityId=t},v.getTodaysActions=function(){return v.todaysActions},v.setSkillContext=function(t){if(o.isUMNUser())return 0;var a=O(t);return v.skillContext=t,C(),a},v.getSkillLevel=function(t){var a=v.skillContext;return a?"goals"==t?a.goalsLevel:"health"==t?a.habitsLevel:"relax"==t?a.relaxLevel:"thoughts"==t?a.thoughtsLevel:"social"==t?a.socialLevel:0:0},v.createActionsWithData=function(t,a){var i=[];if(t)for(var e=0;e<t.length;++e){var n=t[e],s=l.getHabitValueById(n.habitValueId),E=l.getAccountHabitById(s.habitId);L(E,n,!1,i)}var o=I(!0);if(a)for(var c=0;c<a.length;++c){var T=a[c],C=o[T.activityName];C&&_(T,T.date,C,i)}return r(i),i},v.recreateTodaysActions=function(){var t=new Date;v.todaysActions=[],v.todaysActionDate=t;for(var a=l.getAccountHabits(),i=0;i<a.length;++i){var e=a[i],n=l.getHabitDataList(e,t);if(n)for(var s=0;s<n.length;++s){var E=n[s];L(e,E,!0,v.todaysActions)}}var T=c.getTodaysAchievedGoals();if(T)for(var C=0;C<T.length;++C){var M=T[C];v.todaysActions.push({actionClass:"goals",actionTitle:M.title,actionTimestamp:M.achievedRecordedAt})}var O=I(!1);for(var D in O){var N=O[D],P=o.getActivities(N.activityName);if(P)for(var u=0;u<P.length;++u){var S=P[u];_(S,S.recordedAt,N,v.todaysActions)}}r(v.todaysActions)},v.checkForLevelUp=function(t,a){o.isUMNUser()?e(function(){t&&t(0)}):D().success(function(a){var i=v.setSkillContext(a);t&&t(i)}).error(function(){a&&a()})},v}]);