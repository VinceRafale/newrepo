!function(){var e=angular.module("loginCtrl",[]);e.controller("LoginCtrl",["$sce","$scope","$rootScope","$state","$timeout","$translate","$ionicPopup","$ionicModal","$ionicLoading","$ionicPlatform","$ionicSlideBoxDelegate","$ionicScrollDelegate","authHttp","AccountService","HabitsService","GoalsService","AudioService","PayService","NotificationService","MediaService","GroupsService","SkillsService","GeneralService","Environment",function(e,o,t,n,i,a,r,s,l,d,c,u,g,p,m,E,f,v,I,_,M,S,R,w){function O(){if(window.StatusBar){{c.$getByHandle("login-slides").currentIndex()}o.creatingAccount?StatusBar.styleDefault():StatusBar.styleLightContent()}}function N(){return o.loginData.email?R.isEmailValid(o.loginData.email)?!0:(o.errorMessage=a.instant("LOGIN_ERROR_INVALID_EMAIL"),i(function(){$("#loginEmail").focus()}),!1):(o.errorMessage=a.instant("LOGIN_ERROR_MISSING_EMAIL"),i(function(){$("#loginEmail").focus()}),!1)}window.$ionicScrollDelegate=u,$("#communitiesPopover").hide(),o.$on("$ionicView.enter",function(){window.StatusBar&&StatusBar.styleLightContent()}),o.loading=!1,o.loginError=!1,o.errorMessage="",o.loginData={},o.signUpData={},o.popup=void 0,o.resetMode=!1,o.userGoal=void 0,o.creatingAccount=!1,o.getLoginTosHTML=function(){return e.trustAsHtml(a.instant("LOGIN_TOS_AGREEMENT"))},o.closePopup=function(){o.popup&&(o.popup.close?o.popup.close():(o.popup.hide(),o.popup.remove())),o.popup=void 0,window.Keyboard&&window.Keyboard.close(),window.StatusBar&&O()},o.advanceSlide=function(){c.$getByHandle("login-slides").next(),O()},o.slideHasChanged=function(e){0===e&&(o.creatingAccount=!1,i(function(){c.$getByHandle("login-slides").update()},20))},o.getSlideIndex=function(){var e="slide"+c.$getByHandle("login-slides").currentIndex();return e},o.startOver=function(){o.creatingAccount=!1,o.userGoal=void 0,o.groupId=void 0,c.$getByHandle("login-slides").update(),c.$getByHandle("login-slides").slide(0),O()},o.setGoal=function(e){o.userGoal=e},o.getGoal=function(){return o.userGoal},o.storeGoal=function(){return o.userGoal?(o.goalError=!1,void o.advanceSlide()):void(o.goalError=!0)},o.toggleResetMode=function(){o.resetMode=!o.resetMode,$(".resetPasswordButton").text(a.instant(o.resetMode?"RESET_PASSWORD":"LOGIN_SIGN_IN")),i(function(){$("#loginEmail").focus(),window.Keyboard&&window.Keyboard.show()})},o.showLogin=function(){return w.isOnline()?(o.resetMode=!1,o.errorMessage="",void(o.popup=r.show({template:'<a href="javascript:;" ng-click="closePopup()" class="go-back">X</a><form name="loginForm" id="loginForm" ng-submit="login()" ><label class="item item-input"><input type="email" placeholder="{{ \'EMAIL\' | translate }}" ng-model="loginData.email" name="email" id="loginEmail" tabindex="1" autofocus></label><label class="item item-input" ng-show="!resetMode"><input type="password" placeholder="{{ \'PASSWORD\' | translate }}" ng-model="loginData.password" tabindex="2" id="loginPassword" name="password"></label><a href="javascript:;" style="padding-left: 15px;" ng-click="toggleResetMode()">{{resetMode ? "CANCEL_LOWER" : "FORGOT_PASSWORD" | translate}}</a><input type="submit" style="visibility:hidden; display: block; padding: 0; margin: 0; height:0; line-height: 0; width: 0;" ng-disabled="loading"></form><div class="error" style="padding-left: 15px;" ng-show="loginError">{{errorMessage}}</div>',title:"",scope:o,buttons:[{text:'<span class="resetPasswordButton">'+a.instant("LOGIN_SIGN_IN")+"</span>",type:"button-default",onTap:function(e){o.resetMode?o.resetPassword():o.login(),e.preventDefault()}}]}))):void r.alert({template:'<div class="pw-pop">'+a.instant("LOGIN_MUST_BE_ONLINE")+"</div>",okText:a.instant("OK_GOT_IT"),okType:"button-default"})},o.closeTermsOfServiceModal=function(){o.tosModal.hide(),o.tosModal.remove(),o.tosModal=void 0},window.showTermsOfService=function(){o.tosModal&&o.tosModal.remove(),s.fromTemplateUrl("views/tos.popup.html",{scope:o,animation:"slide-in-up"}).then(function(e){o.tosModal=e,openModal(o.tosModal)})},o.closePrivacyModal=function(){o.privacyModal.hide(),o.privacyModal.remove(),o.privacyModal=void 0},window.showPrivacyPolicy=function(){o.privacyModal&&o.privacyModal.remove(),s.fromTemplateUrl("views/privacy.popup.html",{scope:o,animation:"slide-in-up"}).then(function(e){o.privacyModal=e,openModal(o.privacyModal)})},o.showCreateSlides=function(){o.creatingAccount=!0,O(),c.$getByHandle("login-slides").update(),i(function(){c.$getByHandle("login-slides").update(),i(function(){c.$getByHandle("login-slides").slide(1)})})},o.showCreateUser=function(){return w.isOnline()?o.userGoal?(o.errorMessage="",s.fromTemplateUrl("views/account/account.createUser.popup.html",{scope:o,animation:"slide-in-up"}).then(function(e){o.popup=e,openModal(o.popup)}),void i(function(){$("#createUserName").focus()},500)):void(o.goalError=!0):void r.alert({template:'<div class="pw-pop">'+a.instant("LOGIN_MUST_BE_ONLINE")+"</div>",okText:a.instant("OK_GOT_IT"),okType:"button-default"})},o.resetPassword=function(){o.loginError=!1,o.errorMessage="";var e=N();return e?(o.loading=!0,l.show({template:a.instant("LOGIN_REQUESTING_PASSWORD_RESET")}),void p.resetPassword(o.loginData.email).success(function(){l.hide(),o.loading=!1,o.closePopup(),i(function(){r.alert({title:a.instant("CHECK_EMAIL"),template:'<div class="pw-pop">'+a.instant("LOGIN_RESET_PASSWORD_CHECK_EMAIL")+"</div>",okText:a.instant("OK_GOT_IT"),okType:"button-default"})},100)}).error(function(){l.hide(),o.loading=!1,o.loginError=!0,o.errorMessage=a.instant("LOGIN_ERROR_RESET_PASSWORD")})):void(o.loginError=!0)},o.login=function(){o.loginError=!1,o.errorMessage="";var e=N();return e?(o.loginData.password||(o.errorMessage=a.instant("LOGIN_ERROR_MISSING_PASSWORD"),document.getElementById("loginPassword").focus()),""!==o.errorMessage?void(o.loginError=!0):(o.loading=!0,l.show({template:a.instant("LOGIN_SIGNING_IN")}),void p.login(o.loginData.email,o.loginData.password).success(function(e,i,a){window.checkedPasscode=!0,l.hide(),o.loading=!1,p.updateToken(a),initializeUserContext(e,t,p,m,E,f,v,I,S,w),n.go("app.home",{},{location:"replace"}),o.closePopup()}).error(function(e,t){l.hide(),o.loading=!1,o.loginError=!0,o.errorMessage=a.instant(401==t?"LOGIN_ERROR_INVALID_CREDENTIALS":"LOGIN_ERROR_GENERIC")}))):void(o.loginError=!0)},o.useSuggestedEmail=function(){o.signUpData.email=o.suggestedEmail,o.createUser(!0)},o.createUser=function(e){return o.loginError=!1,o.errorMessage="",o.signUpData.name?o.signUpData.email?R.isEmailValid(o.signUpData.email)?o.signUpData.password?o.signUpData.password.length<8&&(o.errorMessage=a.instant("LOGIN_ERROR_PASSWORD_LENGTH"),document.getElementById("createUserPassword").focus()):(o.errorMessage=a.instant("LOGIN_ERROR_MISSING_PASSWORD"),document.getElementById("createUserPassword").focus()):(o.errorMessage=a.instant("LOGIN_ERROR_INVALID_EMAIL"),document.getElementById("createUserEmail").focus()):(o.errorMessage=a.instant("LOGIN_ERROR_MISSING_EMAIL"),document.getElementById("createUserEmail").focus()):(o.errorMessage=a.instant("LOGIN_ERROR_MISSING_NAME"),document.getElementById("createUserName").focus()),""!==o.errorMessage?void(o.loginError=!0):(o.$watch("signUpData.email",function(e,t){e!=t&&(o.suggestedEmail=void 0)}),void(e?(l.show({template:a.instant("LOGIN_CREATING_ACCOUNT")}),o.loading=!0,p.createAccount(o.signUpData.email,o.signUpData.password,o.signUpData.name,o.signUpData.referralCode,o.userGoal,o.groupCode).success(function(e,i,a){window.preventNotificationRegistration=!0,localStorage.clear(),l.hide(),o.loading=!1,p.updateToken(a),initializeUserContext(e,t,p,m,E,f,v,I,S,w,!0),n.go("app.home",{},{location:"replace"}),o.closePopup()}).error(function(e,t){l.hide(),o.loading=!1,o.loginError=!0,o.errorMessage=a.instant("LOGIN_ERROR_CREATING_USER"),409==t&&(o.errorMessage=a.instant("LOGIN_ERROR_EMAIL_IN_USE"))})):Mailcheck.run({email:o.signUpData.email,suggested:function(e){o.suggestedEmail=e.full},empty:function(){o.createUser(!0)}})))}}])}();