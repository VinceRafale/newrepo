function checkGroupModal(t,e,o){var n=$("#groupName").val();n&&(n=n.trim());var r=$("#groupNickname").val();return r&&(r=r.trim()),!o||n&&0!==n.length?r&&0!==r.length?/^[a-z0-9]+$/i.test(r)?!1:(t.groupError=e.instant("LOGIN_ERROR_ALPHANUMERIC_NAME"),!0):(t.groupError=e.instant("CREATE_GROUP_NO_NICKNAME"),!0):(t.groupError=e.instant("CREATE_GROUP_NO_NAME"),!0)}function initInviteFunctionality(t,e,o,n,r,i,a,s){t.sendingInvites=!1,t.closeInviteModal=function(){closeModal(t.inviteModal),t.inviteModal.remove(),t.inviteModal=void 0},t.sendInvite=function(){var o=$("#inviteEmails").val().trim(),r=$("#inviteText").val().trim();if(!o||0===o.length)return void(t.inviteError=e.instant("INVITE_ERROR_MISSING_EMAIL"));if(!r||0===r.length)return void(t.inviteError=e.instant("INVITE_ERROR_MISSING_TEXT"));for(var u=i.getAccountUser().user.email,c=o.split(","),l=0;l<c.length;++l){var p=c[l].trim();if(!s.isEmailValid(p)||p==u)return void(t.inviteError=e.instant("INVITE_ERROR_INVALID_EMAIL"));c[l]=p}t.sendingInvites=!0,a.sendInvites(t.group.id,c,r).success(function(){if(i.setUserPreference("sent_group_invitation","true"),t.sendingInvites=!1,t.closeInviteModal(),t.pendingInvites)for(var o=0;o<c.length;++o)t.pendingInvites.push({userGroup:t.group,email:c[o],createdAtStr:(new Date).toString()});n.alert({template:e.instant("SEND_INVITE_SUCCESS"),okText:e.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){t.sendingInvites=!1;n.alert({template:e.instant("SEND_INVITE_ERROR"),okText:e.instant("OK_GOT_IT"),okType:"button-default"})})},t.showInvite=function(){r.show({buttons:[{text:e.instant("INVITE_VIA_EMAIL")},{text:e.instant("INVITE_VIA_SMS")}],titleText:e.instant("INVITE_TO_GROUP_TITLE"),cancelText:e.instant("CANCEL"),cancel:function(){},buttonClicked:function(o){var r=e.instant("INVITE_TEXT")+" "+t.group.code+".",i=e.instant("DOWNLOAD_PACIFICA");return 0===o?window.plugins.socialsharing.shareViaEmail(r+"\n\n"+i,e.instant("INVITE_EMAIL_SUBJECT"),null,null,null,null,function(t){},function(){n.alert({template:e.instant("INVITE_EMAIL_ERROR"),okText:e.instant("OK_GOT_IT"),okType:"button-default"})}):1==o&&window.plugins.socialsharing.shareViaSMS(r+" "+i,null,function(t){},function(){n.alert({template:e.instant("INVITE_SMS_ERROR"),okText:e.instant("OK_GOT_IT"),okType:"button-default"})}),!0}})},t.selectGroupForInvite=function(e){t.selectedGroupForInvite=e},t.isGroupSelectedForInvite=function(e){return t.selectedGroupForInvite==e},t.closeSelectGroupForInviteModal=function(){closeModal(t.selectGroupModal),t.selectGroupModal.remove(),t.selectGroupModal=void 0},t.checkSelectGroupForInvite=function(){return t.selectedGroupForInvite?(t.inviteExistingError=void 0,void t.showInviteExistingUser()):void(t.inviteExistingError=e.instant("SELECT_GROUP_MISSING"))},t.showSelectGroupForInvite=function(){t.loadingGroups=!0,a.findUserGroups().success(function(e){t.userGroups=e.userGroups.slice();for(var o=t.userGroups.length-1;o>=0;--o)t.isGroupOwner(t.userGroups[o])||t.userGroups.splice(o,1);t.loadingGroups=!1}).error(function(){n.alert({template:e.instant("LOADING_GROUPS_ERROR"),okText:e.instant("OK_GOT_IT"),okType:"button-default"});t.loadingGroups=!1}),o.fromTemplateUrl("views/groups/groups.selectGroup.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.selectGroupModal=e,openModal(t.selectGroupModal)})},t.inviteExistingUser=function(){var o=$("#inviteText").val().trim();return o&&0!==o.length?(t.sendingInvites=!0,void a.inviteExistingUser(t.selectedGroupForInvite.id,t.invitingUserId,o).success(function(){i.setUserPreference("sent_group_invitation","true"),t.sendingInvites=!1,t.closeInviteExistingUserModal();n.alert({template:e.instant("SEND_INVITE_SUCCESS"),okText:e.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){t.sendingInvites=!1;n.alert({template:e.instant("SEND_INVITE_ERROR"),okText:e.instant("OK_GOT_IT"),okType:"button-default"})})):void(t.inviteError=e.instant("INVITE_ERROR_MISSING_TEXT"))},t.closeInviteExistingUserModal=function(){closeModal(t.inviteExistingUserModal),t.inviteExistingUserModal.remove(),t.inviteExistingUserModal=void 0},t.showInviteExistingUser=function(){t.selectGroupModal&&t.closeSelectGroupForInviteModal(),o.fromTemplateUrl("views/groups/groups.inviteExistingUser.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.inviteExistingUserModal=e,openModal(t.inviteExistingUserModal)})}}function initEditFunctionality(t,e,o,n,r,i,a){t.closeEditGroupModal=function(){closeModal(t.editGroupModal),t.editGroupModal.remove(),t.editGroupModal=void 0},t.editGroup=function(){var e=t.isOwnerById(t.editGroupId);if(!checkGroupModal(t,o,e)){t.groupError=void 0;var n=t.newGroupData.name,s=t.newGroupData.nickname,u=t.newGroupData.searchable,c=u?t.newGroupData.description:void 0;n=n.trim(),s=s.trim(),c&&""===c.trim()&&(c=void 0);var l=function(){t.editingGroup=!1;var o=i.getGroupImmediate(t.editGroupId);if(e&&(o.name=n),o.nickname=s,t.groupPosts)for(var r=a.getAccountUser().user,u=0;u<t.groupPosts.length;++u){var c=t.groupPosts[u];c.creatorId==r.id&&(c.creatorNickname=s)}t.closeEditGroupModal()},p=function(e,n){t.editingGroup=!1,r.alert(409==n?{template:o.instant("GROUP_CONFLICT_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"}:{template:o.instant("UPDATE_GROUP_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})};t.editingGroup=!0,e?i.editGroup(t.editGroupId,n,s,c,u).success(l).error(p):i.editGroupNickname(t.editGroupId,s).success(l).error(p)}},t.showEditGroup=function(e,o){e.stopPropagation(),e.preventDefault(),t.checkOfflineMode()||(t.newGroupData={nickname:o.nickname,name:o.name,description:o.description,searchable:o.searchable},t.editGroupId=o.id,t.groupError=void 0,n.fromTemplateUrl("views/groups/groups.editGroup.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.editGroupModal=e,openModal(t.editGroupModal)}))}}function initEditNicknameFunctionality(t,e,o,n,r){t.closeNicknameModal=function(){closeModal(t.nicknameModal),t.nicknameModal.remove(),t.nicknameModal=void 0},t.updatePublicNickname=function(){var o=$("#updateUserNickname").val().trim();o&&0!==o.length?/^[a-z0-9]+$/i.test(o)?(t.nicknameError=void 0,t.updatingNickname=!0,e.setPublicNickname(o).success(function(){t.updatingNickname=!1,t.user&&!t.viewingOtherUser&&(t.user.publicName=o),e.updateLocalPublicNickname(o);var n=e.getAccountUser().user.id;if(t.group&&t.groupPosts&&!t.group.private)for(var r=0;r<t.groupPosts.length;++r){var i=t.groupPosts[r];i.creatorId==n&&(i.creatorNickname=o)}if(t.shares)for(var a=0;a<t.shares.length;++a){var s=t.shares[a];s.creatorId==n&&(s.creatorNickname=o)}t.attemptingCommunityPost&&t.showCreatePost(),t.attemptingInvite&&t.showInvitePopup(),t.closeNicknameModal()}).error(function(){t.updatingNickname=!1,t.nicknameError=r.instant("UPDATE_NICKNAME_ERROR")})):t.nicknameError=r.instant("LOGIN_ERROR_ALPHANUMERIC_NAME"):t.nicknameError=r.instant("LOGIN_ERROR_MISSING_NAME")},t.showUpdateNickname=function(){e.setUserPreference("viewed_communities_popup",!0),t.originalNickname=e.getAccountUser().user.publicName,t.originalNickname||(t.originalNickname=e.getAccountUser().user.name),n.fromTemplateUrl("views/groups/groups.updateNickname.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.nicknameModal=e,openModal(t.nicknameModal)})}}function initValidateEmailFunctionality(t,e,o,n,r){t.closeEmailValidationPopup=function(){closeModal(t.emailValidationModal),t.emailValidationModal.remove(),t.emailValidationModal=void 0},t.checkRemoteEmailValidation=function(o){e.checkRemoteEmailValidation().success(function(n){n.validated?e.getAccountUser().user.emailVerifiedAt=new Date:t.showEmailValidationPopup(),o&&o(n.validated)}).error(function(){n.alert({template:r.instant("GENERIC_ERROR"),okText:r.instant("OK_GOT_IT"),okType:"button-default"})})},t.showEmailValidationPopup=function(){$("#postText").blur(),o.fromTemplateUrl("views/groups/groups.validateEmail.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.emailValidationModal=e,openModal(t.emailValidationModal)})},t.isUserEmailValidated=function(){return e.isEmailValidated()},t.resendValidationEmail=function(){e.resendValidationEmail().success(function(){n.alert({template:r.instant("VALIDATION_EMAIL_SENT"),okText:r.instant("OK_GOT_IT"),okType:"button-default"});t.closeEmailValidationPopup()}).error(function(){n.alert({template:r.instant("GENERIC_ERROR"),okText:r.instant("OK_GOT_IT"),okType:"button-default"})})}}function initCreateGroupFunctionality(t,e,o,n,r,i,a,s,u){function c(){t.editingGroup=!1,t.groupError=void 0,r.fromTemplateUrl("views/groups/groups.createGroup.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.createGroupModal=e,openModal(t.createGroupModal)})}t.closeCreateGroupModal=function(){closeModal(t.createGroupModal),t.createGroupModal.remove(),t.createGroupModal=void 0},t.isNewGroupPublic=function(){return t.newGroupData.searchable},t.createGroup=function(){if(!checkGroupModal(t,o,!0)){var e=t.newGroupData.name,r=t.newGroupData.nickname,i=t.newGroupData.searchable,a=i?t.newGroupData.description:void 0;e=e.trim(),r=r.trim(),a&&""===a.trim()&&(a=void 0),t.groupError=void 0,t.creatingGroup=!0,s.createGroup(e,r,a,i).success(function(e){t.creatingGroup=!1,t.userGroups=void 0,t.loadGroups&&t.loadGroups(!0),t.closeCreateGroupModal(),t.invitingUserId&&(t.selectedGroupForInvite=e,t.showInviteExistingUser())}).error(function(e,r){t.creatingGroup=!1,n.alert(409==r?{template:o.instant("GROUP_CONFLICT_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"}:{template:o.instant("CREATE_GROUP_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})})}},t.closeChooseRandomGroupModal=function(){closeModal(t.chooseRandomGroupModal),t.chooseRandomGroupModal.remove(),t.chooseRandomGroupModal=void 0},t.joinRandomGroup=function(e){t.chooseRandomGroupModal&&("depression"==e?e=o.instant("NUX_GOAL_DEPRESSION"):"gad"==e?e=o.instant("NUX_GOAL_GAD"):"social"==e?e=o.instant("NUX_GOAL_SOCIAL"):"health"==e&&(e=o.instant("NUX_GOAL_HEALTH")),t.closeChooseRandomGroupModal()),s.joinRandomGroup(e,u.getUserPreference("preferred_locale")).success(function(){t.userGroups=void 0,t.loadGroups(!0)}).error(function(){n.alert({template:o.instant("ERROR_JOINING_RANDOM_GROUP"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})})},t.showJoinRandomGroup=function(){if(t.userGroups)for(var e=0;e<t.userGroups.length;++e)if(t.userGroups[e].randomized)return void n.alert({template:o.instant("ONLY_ONE_RANDOM_GROUP_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"});r.fromTemplateUrl("views/groups/groups.chooseRandomGroup.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.chooseRandomGroupModal=e,openModal(t.chooseRandomGroupModal)})},t.createOrJoinRandomGroup=function(){if(!t.checkOfflineMode()){if(!u.getAccountUser().user.banned)return t.isUserEmailValidated()?void t.showCreateGroup():void t.checkRemoteEmailValidation(function(e){e&&t.createOrJoinRandomGroup()});{n.alert({template:o.instant("BANNED_USER_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})}}},t.showCreateGroup=function(e){if(!t.checkOfflineMode()){t.newGroupData={nickname:"",name:"",description:"",searchable:!0};var r=u.getAccountUser().user;return t.newGroupData.nickname=r.publicName?r.publicName:r.name,e&&(t.newGroupData.name=e),u.isPremiumEnabled()?void c():(i.show({template:o.instant("LOADING")+"..."}),void s.findUserGroups(!0).success(function(){i.hide(),c(e)}).error(function(){i.hide(),n.alert({template:o.instant("LOADING_GROUPS_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"}),t.loadingGroups=!1}))}}}var ctrl=angular.module("groupsCtrl",[]);ctrl.controller("GroupsCtrl",["$rootScope","$scope","$sce","$state","$http","$timeout","$analytics","$translate","$ionicLoading","$ionicNavBarDelegate","$ionicPopup","$ionicModal","$ionicGesture","$ionicSideMenuDelegate","$ionicActionSheet","$ionicScrollDelegate","AccountService","HabitsService","GoalsService","AudioService","PayService","GroupsService","SkillsService","GeneralService","Environment","TokenService",function(t,e,o,n,r,i,a,s,u,c,l,p,d,m,f,g,v,h,T,O,E,_,I,G,R){function M(){e.loadingGroups=!1,e.userGroups=void 0,e.communities=void 0,e.userLikes=0,e.userShares=0,e.pendingInvites=[]}function P(){_.setLastActiveTab(e.activeTab)}function k(t){for(var o=0;o<e.userGroups.length;++o){var n=e.userGroups[o];if(t==n.id){e.userGroups.splice(o,1);break}}}function C(){S=void 0;var t=e.searchQuery.query;t&&t.trim(),""!==t?(e.hasSearchEntry=!0,e.isSearching=!0,_.searchForGroup(t).success(function(t){e.searchableGroups=t,e.isSearching=!1}).error(function(){e.clearGroupSearch(),e.hasSearchEntry=!1,e.isSearching=!1;l.alert({template:s.instant("GROUP_SEARCH_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})})):(e.isSearching=!1,e.hasSearchEntry=!1)}function D(){v.isLoggedIn()&&R.isOnline()&&(e.showGroups()?e.activateGroups(!0):e.activateCommunities(!0))}e.searchQuery={query:""},e.$on("$ionicView.afterEnter",function(){var o=v.getUserPreference("completed_social_intro");if(o&&"true"==o){if("app.groups"==n.current.name){var r=v.getUserPreference("viewed_groups_popup");r&&"false"!=r||(e.showBrowseIfEmpty=!0)}else if("app.communities"==n.current.name){var a=v.getUserPreference("viewed_communities_popup");if(!a||"false"==a){var s=v.getAccountUser().user.publicName;(!s||(s=""))&&i(function(){e.showUpdateNickname()})}}}else{t.$broadcast("event:viewVideo",{video:v.COMMUNITY_VIDEO}),v.setUserPreference("completed_social_intro",!0);var u=e.$on("event:introVideoModalClosed",function(){"app.communities"==n.current.name?(e.showUpdateNickname(),u&&u()):"app.groups"==n.current.name&&(e.userGroups&&0===e.userGroups.length&&e.browseCuratedGroups(),u&&u())})}}),"app.communities"==n.current.name?e.activeTab="communities":(e.activeTab="groups",_.clearAllGroupNotifications()),e.getSocialLevel=function(){return I.getSkillLevel("social")},e.goToSkills=function(){window.openURL("/progress/mood?tab=skills")},e.showHelp=function(){f.show({buttons:[{text:'<i class="icon ion-ios-help-outline"></i> '+s.instant("WHAT_IS_COMMUNITY")},{text:'<i class="icon ion-ios-play-outline"></i> '+s.instant("WATCH_MILO_IS_LOST")},{text:'<i class="icon ion-ios-list-outline"></i> '+s.instant("VIEW_COMMON_QUESTIONS")},{text:'<i class="icon ion-ios-people-outline"></i> '+s.instant("VIEW_RULES")}],cancelText:s.instant("CANCEL"),cancel:function(){},buttonClicked:function(e){return 0===e?t.$broadcast("event:viewVideo",{video:v.COMMUNITY_VIDEO}):1===e?v.viewVideo(v.COMMUNITY_VIDEO):2==e?window.open("http://help.thinkpacifica.com/hc/en-us/sections/203653507-Groups-Communities","_blank","location=no"):3==e&&n.go("app.communities"==n.current.name?"app.communities-help":"app.groups-help"),!0}})},M(),e.getActiveTabTitle=function(){return s.instant("communities"==e.activeTab?"COMMUNITIES_TITLE":"GROUPS_TITLE")},e.showGroups=function(){return"groups"==e.activeTab},e.showCommunities=function(){return"communities"==e.activeTab},e.hasGroupNotification=function(t){return _.hasGroupNotification(t)},e.getGroupNotificationCount=function(t){return _.getGroupNotificationCount(t)},e.hasAnyPostNotification=function(){return _.hasPostNotification()},e.getPostNotificationCount=function(){return _.getPostNotificationCount()},e.getGroupAvatar=function(t){var e=v.getAvatarCharacter(t.creatorAvatar,t.creatorId);return"avatar_"+e},e.openSideMenu=function(){m.toggleLeft()},e.$on("$destroy",function(){document.removeEventListener("resume",D,!1),window.activateCommunities=void 0,window.activateGroups=void 0}),document.addEventListener("resume",D,!1),e.goToProfile=function(){_.clearAllPostNotifications(),n.go("app.community-profile")},e.checkOfflineMode=function(){if(!R.isOnline()){{l.alert({template:s.instant("GROUPS_OFFLINE_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}return!0}return!1},e.hasUserNickname=function(){return e.getUserNickname()&&e.getUserNickname().length>0},e.getUserNickname=function(){var t=v.getAccountUser();return t&&t.user?t.user.publicName:void 0},e.getUserAvatar=function(){var t=v.getAvatarCharacter(v.getAccountUser().user.avatar,v.getAccountUser().user.id);return"avatar_"+t},e.getUserLikes=function(){return e.userLikes+""},e.getUserShares=function(){return e.userShares+""},e.loadGroups=function(t){e.userGroups||(e.loadingGroups=!0),_.findUserGroups(t).success(function(t){e.userGroups=t.userGroups,e.pendingInvites=t.pendingInvites,!e.showBrowseIfEmpty||e.userGroups&&0!==e.userGroups.length||(e.browseCuratedGroups(),e.showBrowseIfEmpty=!1),e.loadingGroups=!1}).error(function(){l.alert({template:s.instant("LOADING_GROUPS_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});e.loadingGroups=!1})},e.loadCommunities=function(){e.communities||(e.loadingCommunities=!0),_.findPublicGroups().success(function(t){e.communities=t.publicGroups,e.userLikes=t.userLikes,e.userShares=t.userShares,e.loadingCommunities=!1}).error(function(){l.alert({template:s.instant("LOADING_COMMUNITIES_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});e.loadingCommunities=!1})},e.activateGroups=function(t){e.checkOfflineMode()||(a.eventTrack("activateGroups",{category:"group"}),e.activeTab="groups",t||P(),e.loadGroups(),i(function(){$("#groupTitle").addClass("active"),$("#communitiesTitle").removeClass("active")}))},e.activateCommunities=function(t){e.checkOfflineMode()||(a.eventTrack("activateCommunities",{category:"group"}),e.activeTab="communities",t||P(),e.loadCommunities(),i(function(){$("#communitiesTitle").addClass("active"),$("#groupTitle").removeClass("active")}))},e.isOwner=function(t){return t&&t.creatorId==v.getAccountUser().user.id},e.isOwnerById=function(t){var e=_.getGroupImmediate(t);return e.creatorId==v.getAccountUser().user.id},e.getCommunityName=function(t){var e=t.name,o=("COMMUNITY_"+e).replace(/ /g,"_").toUpperCase(),n=s.instant(o);return n==o?e:n},e.getCommunityDescription=function(t){var e=t.name,o=("COMMUNITY_"+e+"_DESCRIPTION").replace(/ /g,"_").toUpperCase(),n=s.instant(o);return n==o?t.description:n},e.archiveGroup=function(t,o){if(t.stopPropagation(),t.preventDefault(),!e.checkOfflineMode()){a.eventTrack("archiveGroupPopup",{category:"group"});var n=l.confirm({template:"<div>"+s.instant("ARCHIVE_GROUP_PROMPT")+"</div>",cancelText:s.instant("CANCEL"),cancelType:"button-default",okText:s.instant("REMOVE"),okType:"button-default"});n.then(function(t){t?o.curated||o.creatorId!=v.getAccountUser().user.id?_.leaveGroup(o.id).success(function(){k(o.id)}).error(function(){l.alert({template:s.instant("ARCHIVE_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}):(_.archiveGroup(o.id).success(function(){k(o.id)}).error(function(){l.alert({template:s.instant("ARCHIVE_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}),a.eventTrack("archiveGroupConfirm",{category:"groups"})):a.eventTrack("archiveGroupCancel",{category:"groups"})})}},initEditFunctionality(e,i,s,p,l,_,v),initCreateGroupFunctionality(e,i,s,l,p,u,f,_,v,E,T),initValidateEmailFunctionality(e,v,p,l,s),initEditNicknameFunctionality(e,v,l,p,s),e.closeJoinGroupModal=function(){closeModal(e.joinModal),e.joinModal.remove(),e.joinModal=void 0,e.groupCodeError=void 0},e.clearGroupSearch=function(){e.searchQuery.query="",e.hasSearchEntry=!1},e.joinGroup=function(){var t;if(e.showGroupCode&&(t=$("#groupCode").val(),!t||0===t.length))return void(e.groupCodeError=s.instant("GROUP_CODE_PLACEHOLDER"));e.groupCodeError=void 0;var o=$("#groupNickname").val().trim();return o&&0!==o.length?(e.joiningGroup=!0,void(e.showGroupCode||e.joinGroupCode?(t||(t=e.joinGroupCode),_.joinGroup(t,o).success(function(){e.loadGroups(!0),e.closeJoinGroupModal(),e.joiningGroup=!1,e.clearGroupSearch()}).error(function(t,o){if(404==o)e.groupCodeError=s.instant("GROUP_CODE_NOT_FOUND");else{l.alert({template:s.instant("JOIN_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}e.joiningGroup=!1})):_.acceptInvite(e.joinGroupId,o).success(function(){e.loadGroups(!0),e.closeJoinGroupModal(),e.joiningGroup=!1}).error(function(){l.alert({template:s.instant("JOIN_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});e.joiningGroup=!1}))):void(e.groupError=s.instant("GROUP_NICKNAME"))},e.showJoinGroup=function(t,o){e.groupError=void 0,e.showGroupCode=!1,e.joinGroupId=t,e.joinGroupCode=o,e.joinGroupNickname=v.getAccountUser().user.publicName,p.fromTemplateUrl("views/groups/groups.joinGroup.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.joinModal=t,openModal(e.joinModal)})},e.showJoinGroupByCode=function(){e.groupError=void 0,e.showGroupCode=!0,e.joinGroupId=void 0,e.joinGroupCode=void 0,p.fromTemplateUrl("views/groups/groups.joinGroup.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.joinModal=t,openModal(e.joinModal)})},e.getGroupDescription=function(t){var e=t.description;return e&&e.length>140&&(e=e.substring(0,140)+"..."),e},e.joinCuratedGroup=function(t,o){e.showJoinGroup(t,o),e.closeBrowseGroupsModal()},e.closeBrowseGroupsModal=function(){closeModal(e.browseGroupsModal),e.browseGroupsModal.remove(),e.browseGroupsModal=void 0},e.browseCuratedGroups=function(){v.setUserPreference("viewed_groups_popup",!0),e.displayingCategories={},e.loadingCuratedGroups=!0,p.fromTemplateUrl("views/groups/groups.browseGroups.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.browseGroupsModal=t,openModal(e.browseGroupsModal),_.findCuratedGroups().success(function(t){_.initializeCuratedGroups(e,t),e.loadingCuratedGroups=!1}).error(function(t){e.loadingCuratedGroups=!1})})},e.displayingCategories={},e.isDisplayingCategory=function(t){return!!e.displayingCategories[t]},e.toggleCategoryDisplay=function(t){e.isDisplayingCategory(t)?delete e.displayingCategories[t]:e.displayingCategories[t]=!0,g.resize()},e.hasSearchEntry=!1,e.isSearching=!1,e.searchableGroups=void 0;var S;e.searchGroups=function(){S&&i.cancel(S),S=i(C,1e3)},e.deleteInvite=function(t){var o=l.confirm({template:"<div>"+s.instant("DELETE_INVITE_PROMPT")+"</div>",cancelText:s.instant("CANCEL"),cancelType:"button-default",okText:s.instant("DELETE"),okType:"button-default"});o.then(function(o){o&&_.deleteInvite(t).success(function(){for(var o=0;o<e.pendingInvites.length;++o){var n=e.pendingInvites[o];n.userGroup.id==t&&e.pendingInvites.splice(o,1)}}).error(function(){l.alert({template:s.instant("DELETE_INVITE_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})})})},e.goToGroup=function(t){if(!e.checkOfflineMode()){var o=t.private?"date":"hotness";if(t.private){var r=v.getUserPreference("viewed_community_rules");r&&"true"==r?n.go("app.group-posts",{groupId:t.id,order:o}):n.go("app.groups-help",{intro:!0,groupId:t.id,order:o})}else{var i=v.getUserPreference("viewed_community_rules");i&&"true"==i?n.go("app.communities-posts",{groupId:t.id,order:o}):n.go("app.communities-help",{intro:!0,groupId:t.id,order:o})}}},e.$on("$ionicView.enter",function(){D()}),e.$on("$ionicView.afterLeave",function(){M()})}]),ctrl.controller("AbstractGroupPostsCtrl",["$scope","$rootScope","$state","$stateParams","$sce","$http","$timeout","$analytics","$translate","$ionicLoading","$ionicPopup","$ionicModal","$ionicGesture","$ionicScrollDelegate","$ionicActionSheet","AccountService","HabitsService","GoalsService","AudioService","PayService","GroupsService","GeneralService","Environment","TokenService",function(t,e,o,n,r,i,a,s,u,c,l,p,d,m,f,g,v,h,T,O,E,_,I){function G(t){return t.lastIndexOf(".")==t.length-1?t+"..":t+"..."}function R(e){var o=t.groupPostData.postText.trim();o&&0!==o.length&&o!=u.instant("DEFAULT_MOOD_SHARE_TEXT")&&o!=u.instant("DEFAULT_THOUGHT_SHARE_TEXT")&&o!=u.instant("DEFAULT_EXPERIMENT_SHARE_TEXT")||(t.groupPostData.postText=e)}function M(e){var o=t.groupPostData.postText.trim();o==e&&(t.groupPostData.postText="")}function P(t,e,o){return t.recordings&&t.recordings[e]?t.recordings[e][o]:void 0}function k(){l.alert({template:u.instant("MISSING_EXPERIMENT_DATA_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}t.showingMenu=void 0,t.showingMore={};var C=140;t.userVotes={},t.userCommentVotes={},t.sharingData={},t.groupPostData={postText:""},t.communityPostData={postText:""},t.reportPostData={postText:""},initValidateEmailFunctionality(t,g,p,l,u),t.isOwnerById=function(t){var e=E.getGroupImmediate(t);return e.creatorId==g.getAccountUser().user.id},t.isOwner=function(t){return t&&t.creatorId==g.getAccountUser().user.id},t.isGroupOwner=function(t){return t.creatorId==g.getAccountUser().user.id},t.hasUserNickname=function(){return t.getUserNickname()&&t.getUserNickname().length>0},t.getUserNickname=function(){return g.getAccountUser().user.publicName},t.hasPostNotification=function(t){return E.hasPostNotification(t)},t.hasGroupNotification=function(t){return E.hasGroupNotification(t)},t.getGroupNotificationCount=function(t){return E.getGroupNotificationCount(t)},t.checkOfflineMode=function(){if(!I.isOnline()){{l.alert({template:u.instant("GROUPS_OFFLINE_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}return!0}return!1},t.getPostCreatorNickname=function(t){return t?t.creatorNickname?t.creatorNickname:"["+u.instant("DELETED")+"]":void 0},t.getPostAvatar=function(t){return t?"avatar_"+g.getAvatarCharacter(t.creatorAvatar,t.creatorId):""},t.getPostDate=function(t){if(t){if(t.momentDate)return t.momentDate;var e="object"==typeof t.createdAt?t.createdAt:new Date(t.createdAt);return t.momentDate=moment(e).calendar(),t.momentDate}};var D={formatHref:function(t){return t},target:function(){return null},linkAttributes:{onClick:"event.stopPropagation(); event.preventDefault(); window.open(event.target.href, '_blank', 'location=no');"},events:{click:function(t){t.preventDefault(),t.stopPropagation()}}};t.getPostTitle=function(e,o){var n=e.title,i=!1;if(t.group&&(i=t.group.private),t.showingMore[e.id]||i||!t.canShowMore(e)||o)return e.linkifiedTitle||(e.linkifiedTitle=linkifyStr(n,D)),r.trustAsHtml(e.linkifiedTitle);if(e.truncatedTitle)return r.trustAsHtml(e.truncatedTitle);var a=n.substring(C),s=a.indexOf(" ");return e.truncatedTitle=s>=0?linkifyStr(G(n.substring(0,C+s)),D):linkifyStr(G(n.substring(0,C)),D),r.trustAsHtml(e.truncatedTitle)},t.canShowMore=function(e){var o=e.title,n="undefined"==typeof t.showingMore[e.id]&&o.length>C;return n},t.showMore=function(e){if(t.group&&t.group.private)t.canShowMore(e)?(t.showingMore[e.id]=e.id,m.resize()):(delete t.showingMore[e.id],m.resize());else{var n;"undefined"==typeof e.groupPostId?(E.storeCachedPost(e,t.postDataObjects?t.postDataObjects[e.id]:void 0,t.userVotes),n=e.id):n=e.groupPostId;var r={postId:n,order:"date"};o.$current.name.indexOf("app.groups")>=0?o.go("app.groups-post-comments",r):o.go("app.communities-post-comments",r)}},t.hasVote=function(e){if(!e)return!1;if("comments"==t.activeTab)return t.hasCommentVote(e);var o=t.userVotes[e.id];return o&&o.up||e.creatorId==g.getAccountUser().user.id},t.removeVote=function(e,o){if(e.stopPropagation(),e.preventDefault(),"comments"==t.activeTab)t.removeCommentVote(e,o);else{if(t.isPostOwner(o)){{l.alert({template:u.instant("REMOVE_OWNED_POST_VOTE_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}return}delete t.userVotes[o.id],--o.ups,--o.score,E.removeVote(o)}},t.addUserVotes=function(e){for(var o=0;o<e.length;++o){var n=e[o];t.userVotes[n.postId]=n}},t.createVoteObject=function(e){t.userVotes[e.id]={postId:e.id,groupId:t.group?t.group.id:e.groupId,up:!0,recordedAt:new Date}},t.voteUp=function(e,o){e.stopPropagation(),e.preventDefault(),"comments"==t.activeTab?t.voteCommentUp(e,o):(++o.ups,++o.score,t.createVoteObject(o),E.voteUp(o.id,t.group?t.group.id:o.groupId))},t.addUserCommentVotes=function(e){for(var o=0;o<e.length;++o){var n=e[o];t.userCommentVotes[n.postCommentId]=n}},t.createCommentVoteObject=function(e){t.userCommentVotes[e.id]={postId:e.id,groupId:t.group?t.group.id:e.groupId,up:!0,recordedAt:new Date}},t.hasCommentVote=function(e){var o=t.userCommentVotes[e.id];return o&&o.up||e.creatorId==g.getAccountUser().user.id},t.voteCommentUp=function(e,o){e.stopPropagation(),e.preventDefault(),++o.ups,++o.score,t.createCommentVoteObject(o),E.voteCommentUp(o.id,o.groupPostId,o.groupId)},t.removeCommentVote=function(e,o){if(e.stopPropagation(),e.preventDefault(),t.isPostOwner(o)){l.alert({template:u.instant("REMOVE_OWNED_POST_VOTE_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}else delete t.userCommentVotes[o.id],--o.ups,--o.score,E.removeCommentVote(o)},initCreateGroupFunctionality(t,a,u,l,p,c,f,E,g,O,h),initInviteFunctionality(t,u,p,l,f,g,E,_),t.viewUserProfile=function(t,e){t.stopPropagation(),t.preventDefault(),e.creatorNickname&&o.go("app.community-profile",{userId:e.creatorId,nickname:e.creatorNickname})},t.showInvitePopup=function(e,o,n){e&&(e.stopPropagation(),e.preventDefault());{if(!g.getAccountUser().user.banned)return t.isUserEmailValidated()?((o||n)&&(t.invitingUserId=o?o.creatorId:n.id,t.invitingUserNickname=o?o.creatorNickname:n.publicName),g.getAccountUser().user.publicName?void f.show({buttons:[{text:u.instant("CREATE_GROUP")},{text:u.instant("SELECT_EXISTING_GROUP")}],titleText:u.instant("INVITE_TO_CHAT"),cancelText:u.instant("CANCEL"),cancel:function(){},buttonClicked:function(e){return 0===e?t.showCreateGroup(g.getAccountUser().user.publicName+" & "+t.invitingUserNickname):1==e&&t.showSelectGroupForInvite(),!0}}):(t.attemptingInvite=!0,void t.showUpdateNickname())):void t.checkRemoteEmailValidation(function(r){r&&t.showInvitePopup(e,o,n)});{l.alert({template:u.instant("BANNED_USER_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}}},t.closeReportModal=function(){closeModal(t.reportModal),t.reportModal.remove(),t.reportModal=void 0},t.reportPost=function(){var e=t.reportPostData.postText.trim();if(!e||0===e.length)return void(t.reportError=u.instant("REPORT_POST_TEXT_ERROR"));var o=t.referUserData.referUser;t.reportError=void 0,E.reportPost(t.reportingPostId,e,o?!0:!1).success(function(){t.closeReportModal(),t.removePostById&&t.removePostById(t.reportingPostId);l.alert({template:u.instant("REPORT_POST_CONFIRM"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){l.alert({template:u.instant("REPORT_POST_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})})},t.showReportPost=function(e,o){if(e.stopPropagation(),e.preventDefault(),t.reportingComment=!1,g.getAccountUser().user.banned){l.alert({template:u.instant("BANNED_USER_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}else{if(!t.isUserEmailValidated())return void t.checkRemoteEmailValidation(function(n){n&&t.showReportPost(e,o)});t.reportingPostId=o.id,t.reportPostData.postText="",t.referUserData={referUser:!1},p.fromTemplateUrl("views/groups/groups.report.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.reportModal=e,openModal(t.reportModal)})}},t.closeSubGoalModal=function(){closeModal(t.goalModal),t.goalModal.remove(),t.goalModal=void 0},t.clearSubGoal=function(){t.viewData.subGoal=""},t.updateGoalOption=function(){t.goalForSubGoal=t.goalOptions.goals[t.goalOptions.goalOptionOrdinal],t.valueData&&t.valueData.redraw&&++t.valueData.redraw},t.getGoalOptionDisplay=function(t){return t.title},t.saveSubGoal=function(){return"?"==t.valueData.value?void(t.noDataError=!0):(t.noDataError=!1,c.show({template:u.instant("EXPERIMENTS_SETTING_EXPERIMENT")+"..."}),h.addSubGoal(t.goalForSubGoal.id,t.viewData.subGoal,_.getDayString(new Date),t.difficultyValues[t.valueData.valueIndex].valueInt).success(function(){t.closeSubGoalModal(),c.hide()}).error(function(){t.closeSubGoalModal(),c.hide()}),void s.eventTrack("addSubGoal",{category:"groups"}))},t.allDifficultyColors=["#60d293","#5fe9c4","#5bdddf","#58caf6","#66edff","#ffe566","#ffbe66","#ff9b73","#ef7d7d","#ff6669"],t.$watch("valueData.valueIndex",function(){if(t.valueData){var e=t.valueData.valueIndex;t.lastValueIndex!=e&&(t.difficultyColors[1]=t.allDifficultyColors[e])
}}),t.addExperiment=function(e,o){e.stopPropagation(),e.preventDefault();var n=t.getExperiment(o);t.goalOptions={goals:h.getAccountGoals(),goalOptionOrdinal:0},t.updateGoalOption(),t.viewData={subGoal:n.title,error:!1,submitting:!1},t.colorPercentages=[0,1],t.difficultyColors=["#c8c8c8",_.getColor("green"),"#c8c8c8"],t.difficultyValues=[10];for(var r=0;10>r;++r)t.difficultyValues[r]=createValue(r,r+1);t.valueData={value:"?",valueIndex:0,percentage:0,redraw:0},t.getSpinnerDifficulty=function(){return t.valueData?t.difficultyValues[t.valueData.valueIndex].valueInt:void 0},p.fromTemplateUrl("views/goals/goals.addCommunitySubGoal.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.goalModal=e,openModal(t.goalModal)})},t.showAddExperiment=function(e){if(t.isPostOwner(e))return!1;var o=t.getExperiment(e);return o&&o.title},t.sharePost=function(t,e){s.eventTrack("sharePostClick",{category:"communities"}),t.preventDefault(),t.stopPropagation();var o;o=I.isDevelopment()?"http://dev.thinkpacifica.com/community/post/":"http://www.thinkpacifica.com/community/post/",o+=e.id,window.plugins.socialsharing.share(u.instant("SHARE_POST_TEXT")+' "'+e.title+'"',null,null,o)},t.deletePost=function(e,o){e.preventDefault(),e.stopPropagation();var n=l.confirm({template:"<div>"+u.instant("ARCHIVE_POST_PROMPT")+"</div>",cancelText:u.instant("CANCEL"),cancelType:"button-default",okText:u.instant("REMOVE"),okType:"button-default"});n.then(function(e){e&&E.archivePost(o.id).success(function(){t.removePost(o)}).error(function(){l.alert({template:u.instant("ARCHIVE_POST_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})})})},t.isPostOwner=function(t){return t&&t.creatorId==g.getAccountUser().user.id},t.showMenu=function(e){return t.showingMenu==e.id},t.toggleMenu=function(e,o){e.stopPropagation(),e.preventDefault(),t.showingMenu=t.showingMenu==o.id?void 0:o.id},t.closeShareMoodModal=function(){closeModal(t.moodModal),t.moodModal.remove(),t.moodModal=void 0},t.hasSharingData=function(e){return t.sharingData[e]},t.shareWeeksMood=function(){var e=v.getAllMoodHabitData(),o=[],n=new Date((new Date).getTime()-5184e5);if(n.setHours(0,0,0,0),e&&e.length>0)for(var r=0;r<e.length;++r){var i=e[r],a=new Date(i.experiencedAtStr);a>n&&o.push(i)}if(0===o.length){l.alert({template:u.instant("MISSING_MOOD_DATA_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}else t.sharingData={},o.sort(function(t,e){return new Date(t.experiencedAtStr)-new Date(e.experiencedAtStr)}),t.sharingData.Mood={moodEntries:o,startDate:n.toString(),numberOfDays:7},t.closeShareMoodModal(),R(u.instant("DEFAULT_MOOD_SHARE_TEXT"))},t.showMoodShare=function(){t.sharingData.Mood?(t.sharingData={},M(u.instant("DEFAULT_MOOD_SHARE_TEXT"))):p.fromTemplateUrl("views/groups/groups.mood.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.moodModal=e,openModal(t.moodModal)})},t.getRecordingSource=function(t,e){return P(t,e,"url")},t.getRecordingDuration=function(t,e){return P(t,e,"duration")},t.getRecordingTags=function(t,e){return P(t,e,"tags")},t.isThoughtExpired=function(e){var o=t.getThought(e);if(o&&o.expiresAtStr){var n=new Date(o.expiresAtStr);return n<new Date}return!1},t.isAudioJournal=function(e){var o=t.getThought(e);return o&&"AUDIO_JOURNAL"==o.thoughtType},t.isAudioThought=function(e){var o=t.getThought(e);return o&&(!o.thoughtType||"AUDIO_DISTORTIONS"==o.thoughtType)},t.isTextThought=function(e){var o=t.getThought(e);return o&&"TEXT_DISTORTIONS"==o.thoughtType},t.isTextJournal=function(e){var o=t.getThought(e);return o&&"TEXT_JOURNAL"==o.thoughtType},t.getTextThoughtDisplay=function(e){var o=t.getThought(e);if(o&&"TEXT_DISTORTIONS"==o.thoughtType){var n=o.recordings.analysis,r=n?n.notes:"";return r.length>250&&(r=r.substring(0,250)+"..."),r}},t.getTextJournalDisplay=function(e){var o=t.getThought(e);if(o&&"TEXT_JOURNAL"==o.thoughtType){var n=o.recordings.journal,r=n?n.notes:"";return r.length>250&&(r=r.substring(0,250)+"..."),r}},t.closeTextThoughtModal=function(){closeModal(t.textThoughtModal),t.textThoughtModal.remove(),t.textThoughtModal=void 0},t.showTextThought=function(e){var o=t.getThought(e);!o||"TEXT_DISTORTIONS"!=o.thoughtType&&"TEXT_JOURNAL"!=o.thoughtType||(T.setTextThoughtForReview(o),"TEXT_DISTORTIONS"==o.thoughtType?p.fromTemplateUrl("views/thoughts/thoughts.text.review.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.textThoughtModal=e,openModal(t.textThoughtModal)}):p.fromTemplateUrl("views/thoughts/thoughts.text.journalreview.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.textThoughtModal=e,openModal(t.textThoughtModal)}))},t.getThoughtDate=function(e){var o=t.getThought(e);return o?moment(new Date(o.createdAtString)).calendar():void 0},t.closeShareThoughtModal=function(){closeModal(t.thoughtModal),t.thoughtModal.remove(),t.thoughtModal=void 0},t.getThoughtItemDisplay=function(t){return t.title},t.updateSelectedThought=function(){t.selectedThought=t.thoughtOptions.thoughts[t.thoughtOptions.thoughtOrdinal]},t.getSelectedThought=function(){return t.selectedThought?t.selectedThought.title:void 0},t.showingModal=function(){return t.moodModal||t.thoughtModal||t.experimentModal},t.shareThought=function(){t.sharingData={},t.sharingData.Thought=t.selectedThought,R(u.instant("DEFAULT_THOUGHT_SHARE_TEXT")),t.closeShareThoughtModal()},t.showThoughtShare=function(){if(t.sharingData.Thought)t.sharingData={},M(u.instant("DEFAULT_THOUGHT_SHARE_TEXT"));else{var e=T.getThoughts();if(e&&0!==e.length)e.sort(function(t,e){var o=new Date(t.createdAtString),n=new Date(e.createdAtString);return n-o}),t.selectedThought=e[0],t.thoughtOptions={thoughts:e,thoughtOrdinal:0},p.fromTemplateUrl("views/groups/groups.thought.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.thoughtModal=e,openModal(t.thoughtModal)});else{l.alert({template:u.instant("MISSING_THOUGHT_DATA_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}}},t.closeShareExperimentModal=function(){closeModal(t.experimentModal),t.experimentModal.remove(),t.experimentModal=void 0},t.getExperimentItemDisplay=function(t){return t.title},t.updateSelectedExperiment=function(){t.selectedExperiment=t.experimentOptions.experiments[t.experimentOptions.experimentOrdinal]},t.getSelectedExperiment=function(){return t.selectedExperiment?t.selectedExperiment.title:void 0},t.shareExperiment=function(){t.group.private?(t.sharingData={},t.sharingData.Experiment=t.selectedExperiment,R(u.instant("DEFAULT_EXPERIMENT_SHARE_TEXT"))):t.createPostInternal(t.selectedExperiment.title,{Experiment:t.selectedExperiment}),t.closeShareExperimentModal()},t.showExperimentShare=function(){if(t.group.private&&t.sharingData.Experiment)t.sharingData={},M(u.instant("DEFAULT_EXPERIMENT_SHARE_TEXT"));else{var e=h.getAccountSubGoals();if(e){var o=[];for(var n in e)for(var r=e[n],i=0;i<r.length;++i){var a=r[i];a.achievedRecordedAt&&o.push(a)}if(0===o.length)return void k();o.sort(function(t,e){var o=new Date(t.achievedRecordedAtString),n=new Date(e.achievedRecordedAtString);return n-o}),t.selectedExperiment=o[0],t.experimentOptions={experiments:o,experimentOrdinal:0},p.fromTemplateUrl("views/groups/groups.experiment.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.experimentModal=e,openModal(t.experimentModal)})}else k()}},t.inputHasFocus=!1,t.inputFocused=function(){return t.isUserEmailValidated()?void 0:void t.checkRemoteEmailValidation(function(e){e&&(t.inputHasFocus=!0)})},t.inputBlurred=function(){t.inputHasFocus=!1},t.isInputFocused=function(){return t.inputHasFocus},t.inputChanged=function(){if(t.websocketSend){var e=t.hasPostText();e&&!t.typing?(t.typing=!0,t.websocketSend("typing")):!e&&t.typing&&(t.typing=!1,t.websocketSend("nottyping"))}},t.hasPostText=function(){var e=t.groupPostData.postText;return e?(e=e.trim(),e.length>0):!1}}]),ctrl.controller("GroupPostCommentsCtrl",["$scope","$rootScope","$sce","$controller","$state","$stateParams","$http","$timeout","$analytics","$translate","$ionicNavBarDelegate","$ionicLoading","$ionicPopup","$ionicModal","$ionicGesture","$ionicScrollDelegate","$ionicActionSheet","AccountService","HabitsService","GoalsService","AudioService","PayService","GroupsService","GeneralService","Environment","TokenService",function(t,e,o,n,r,i,a,s,u,c,l,p,d,m,f,g,v,h,T,O,E,_,I){function G(){t.offset=0}function R(){t.loadingComments=!0,I.findGroupPostComments(t.postId,t.order,t.limit,t.offset).success(function(e){var o=e.postComments;t.loadingComments=!1;e.postComments;t.canLoadMore=o.length==t.limit,t.lastPostLoad=new Date,t.postComments.push.apply(t.postComments,o),t.addUserCommentVotes(e.userVotes),g.resize(),t.$broadcast("scroll.refreshComplete")}).error(function(){t.loadingComments=!1})}n("AbstractGroupPostsCtrl",{$scope:t}),t.postId=+i.postId,t.inputFocused=function(){t.hasUserNickname()?t.checkRemoteEmailValidation(function(e){e&&(t.inputHasFocus=!0)}):(t.showUpdateNickname(),$("#postText").blur(),t.inputHasFocus=!0)},t.post=I.getCachedPost(t.postId),t.post?(t.postData=I.getCachedPostData(t.post.id),t.userVotes=I.getCachedUserVotes()):I.getGroupPost(t.postId).success(function(e){e&&e.groupPostsContext&&e.groupPostsContext.groupPosts&&e.groupPostsContext.groupPosts.length>0&&(t.post=e.groupPostsContext.groupPosts[0],t.addUserVotes(e.userVotes))}).error(function(){d.alert({template:c.instant("LOADING_COMMENTS_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}),t.order=i.order,t.order||(t.order="score"),t.limit=25,t.offset=0,t.canLoadMore=!0,initEditNicknameFunctionality(t,h,d,m,c),t.postComments=[],t.getGroupRemainingPostCharacters=function(){var e=t.groupPostData.postText;return e||(e=""),512-e.length},t.removePost=function(){t.goBack()},t.getCommentPostTitle=function(){return t.post?t.getPostTitle(t.post,!0):c.instant("LOADING")+"..."},t.showNew=function(){"date"!=t.order&&(t.order="date",G(),t.postComments.length=0,R())},t.showAllTime=function(){"score"!=t.order&&(t.order="score",G(),t.postComments.length=0,R())},t.getExperiment=function(){if(t.postData){if(t.postData.experiment)return t.postData.experiment;if("Experiment"==t.postData.type){var e=t.postData.data;if(e){var o=JSON.parse(e);return t.postData.experiment=o,o}t.postData.experiment={}}}return{}},t.postComment=function(o){if(o&&(o.preventDefault(),o.stopPropagation()),!t.checkOfflineMode()){if(h.getAccountUser().user.banned)return void d.alert({template:c.instant("BANNED_USER_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"});if(!t.hasUserNickname())return void t.showUpdateNickname();var n=t.groupPostData.postText.trim();if(0===n.length&&!hasSharingData)return void(t.groupError=c.instant("CREATE_POST_TEXT_ERROR"));$("#postText").blur(),t.postingComment=!0,t.postingCommentText=n,t.groupPostData.postText="",I.postComment(t.postId,t.post.groupId,n).success(function(o){t.postingComment=!1,t.postComments.splice(0,0,o),t.showNew(),t.createVoteObject(o),++t.post.comments,s(function(){e.$broadcast("event:createdMessage")},500)}).error(function(){t.groupPostData.postText=t.postingCommentText;d.alert({template:c.instant("POSTING_COMMENT_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"});t.postingComment=!1})}},t.removeComment=function(e){t.removeCommentById(e.id)},t.removeCommentById=function(e){for(var o=0;o<t.postComments.length;++o)if(t.postComments[o].id==e)return void t.postComments.splice(o,1)},t.deleteComment=function(e,o){e.preventDefault(),e.stopPropagation();var n=d.confirm({template:"<div>"+c.instant("ARCHIVE_COMMENT_PROMPT")+"</div>",cancelText:c.instant("CANCEL"),cancelType:"button-default",okText:c.instant("REMOVE"),okType:"button-default"});n.then(function(e){e&&I.archiveComment(o.id).success(function(){t.removeComment(o),--t.post.comments}).error(function(){d.alert({template:c.instant("ARCHIVE_COMMENT_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})})})},t.closeReportModal=function(){closeModal(t.reportModal),t.reportModal.remove(),t.reportModal=void 0},t.reportComment=function(){var e=t.reportPostData.postText.trim();if(!e||0===e.length)return void(t.reportError=c.instant("REPORT_POST_TEXT_ERROR"));var o=t.referUserData.referUser;t.reportError=void 0,I.reportComment(t.reportingCommentId,e,o?!0:!1).success(function(){t.closeReportModal(),t.removeCommentById(t.reportingCommentId),--t.post.comments;d.alert({template:c.instant("REPORT_POST_CONFIRM"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){d.alert({template:c.instant("REPORT_POST_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})})},t.showReportComment=function(e,o){if(e.stopPropagation(),e.preventDefault(),t.reportingComment=!0,h.getAccountUser().user.banned){d.alert({template:c.instant("BANNED_USER_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}else t.reportingCommentId=o.id,t.referUserData={referUser:!1},m.fromTemplateUrl("views/groups/groups.report.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.reportModal=e,openModal(t.reportModal)})},t.loadMorePostComments=function(){t.offset+=t.limit,R()},R()}]),ctrl.controller("GroupPostsCtrl",["$scope","$rootScope","$sce","$controller","$state","$stateParams","$http","$timeout","$analytics","$translate","$ionicNavBarDelegate","$ionicLoading","$ionicPopup","$ionicModal","$ionicGesture","$ionicScrollDelegate","$ionicActionSheet","$ionicPlatform","AccountService","HabitsService","GoalsService","AudioService","PayService","GroupsService","SkillsService","GeneralService","Environment","TokenService",function(t,e,o,n,r,i,a,s,u,c,l,p,d,m,f,g,v,h,T,O,E,_,I,G,R,M,P,k){function C(){V(),N()}function D(){t.destroying||t.websocketError||!t.chatConnection||N()}function S(){var t=g.getScrollPosition().top,e=g.getScrollView().__maxScrollTop;return t>e-30}function b(e){if(e.data.startsWith("{")){var o=JSON.parse(e.data);t.usersTyping=o.usersTyping;var n=S(),r=o.groupPosts;if(r&&r.length>0){for(var i=0;i<r.length;++i){var a=r[i];a.creatorId!=T.getAccountUser().user.id&&(t.groupPosts.push(a),t.hasNewPosts=!0)}var u=o.groupPostData;u&&(L(u),s(function(){j(!1,!1)})),n&&t.scrollToNewPosts()}t.$$phase||t.$apply()}}function U(e){w(),!t.websocketOpened||t.creatingWebsocket?(t.websocketError=!0,s(A,X)):N()}function y(){A(!0),N(),G.clearGroupNotification(t.groupId)}function N(){if(t.group&&t.group.private&&T.isLoggedIn()&&(!t.chatConnection||0!==t.chatConnection.readyState)){t.creatingWebsocket=!0,t.chatConnection&&w();var e=k.getToken();"notsecure"!=e?(t.chatConnection=new WebSocket(P.websocketURL+"/chat/group/"+t.group.id+"?token="+k.getToken()),t.chatConnection.onclose=D,t.chatConnection.onmessage=b,t.chatConnection.onerror=U,t.chatConnection.onopen=function(){t.websocketOpened=!0},t.creatingWebsocket=!1):s(A,X)}}function w(){if(t.chatConnection){var e=t.chatConnection.readyState;(0===e||1==e)&&t.chatConnection.close(),t.chatConnection=void 0}}function A(e){if(!t.lastPostLoad||!t.group)return void s(A,X);var o;o=t.groupPosts.length>0?new Date(t.groupPosts[t.groupPosts.length-1].createdAt):t.lastPostLoad,G.findNewerPosts(t.group,o).success(function(o){var n=o.groupPostsContext.groupPosts;if(n.length>0){for(var r=S(),i=n.length-1;i>=0;--i)for(var a=n[i],u=t.groupPosts.length-1;u>=0;--u){var c=t.groupPosts[u];a.id!=c.id||n.splice(i,1)}if(n.length>0){t.hasNewPosts=!0,n=n.reverse(),t.groupPosts.push.apply(t.groupPosts,n);var l=o.groupPostsContext.groupPostData;L(l),t.lastPostLoad=new Date,r&&t.scrollToNewPosts(),s(function(){j(!1,!1)})}}e||s(A,X)}).error(function(){})}function x(e,o){var n=0,r=t.getThought(e);if(r&&r.recordings&&r.recordings.thought&&r.recordings.thought.tags)for(var i=r.recordings.thought.tags,a=0;a<i.length;++a){var s=i[a];s.tagTypeString==o&&++n}return n}function L(e){if(e)for(var o=0;o<e.length;++o){var n=e[o],r=t.postDataObjects[n.postId];r||(r={},t.postDataObjects[n.postId]=r),r[n.name]=n.value}}function V(e){if(t.group){var o=0===t.groupPosts.length||e;o&&(t.loadingPosts=!0),G.findGroupPosts(t.group,t.order,t.limit,t.offset).success(function(e){var n=e.groupPostsContext.groupPosts;o&&(t.groupPosts.length=0);var r=e.groupPostsContext.groupPostData;L(r),t.canLoadMore=n.length==t.limit,t.group.private?(t.lastPostLoad=new Date,n=n.reverse(),Array.prototype.splice.apply(t.groupPosts,[0,0].concat(n))):t.groupPosts.push.apply(t.groupPosts,n),t.addUserVotes(e.userVotes),t.loadingPosts=!1,g.resize(),t.group.private&&s(function(){j(o,!o)}),t.$broadcast("scroll.refreshComplete")}).error(function(){d.alert({template:c.instant("LOADING_POSTS_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"});t.loadingPosts=!0,t.$broadcast("scroll.refreshComplete")})}}function F(){t.offset=0}function H(t,e){var o,n=t.getBoundingClientRect();e.changedTouches&&(o=e.changedTouches[0].pageX),o||(o="undefined"!=typeof e.pageX?e.pageX:e.clientX);var r;return e.changedTouches&&(r=e.changedTouches[0].pageY),r||(r="undefined"!=typeof e.pageY?e.pageY:e.clientY),{x:o-n.left,y:r-n.top}}function K(e,o,n,r,i,a,s,u){var c,l=e.data("startdate"),p=new Date(l),d=+e.data("numberofdays"),f=p.getTime(),g=864e5*d,v=+e.data("postid");if(u){var h=function(){var e=c.x/a,o=Math.floor(e*d),n=new Date(p.getTime()+1e3*o*60*60*24);t.moodDetailDate=n;var r=new Date(n.getTime()+864e5),i=t.getPost(v);if(i){var s=t.getMoodEntries(i);if(s){t.modalMoodEntries=[];for(var u={},l=0;l<s.length;++l){var f=s[l],g=new Date(f.experiencedAtStr);if(g>n&&r>g&&(t.modalMoodEntries.push(f),f.habitSubValueIds))for(var h=0;h<f.habitSubValueIds.length;++h){var T=f.habitSubValueIds[h];u[T]=_}}var E=[];for(var _ in u){var I=O.getHabitSubValueName(0,_);I||E.push(_)}E.length>0&&O.getHabitSubValues(E),m.fromTemplateUrl("views/groups/groups.moodDetail.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.moodDetailModal=e,openModal(t.moodDetailModal)})}}},T=function(t){c=H(n[0],t),s=Math.floor(d*(c.x/a)),K(e,o,n,r,i,a,s)},E=function(t){endPos=H(n[0],t),endPos.x==c.x&&endPos.y==c.y&&h(t),s=-1,K(e,o,n,r,i,a,s)};n[0].addEventListener("mousedown",T),n[0].addEventListener("mouseup",E),n[0].addEventListener("touchstart",T),n[0].addEventListener("touchend",E)}for(var _=n[0].getContext("2d"),I=_.canvas.width=a*r,G=_.canvas.height=i*r,R=I/d,P=40,k=0;d>k;++k){var C;C=k==s?"rgba(0, 0, 0, 0.3)":k%2===0?"rgba(0, 0, 0, 0.5)":"rgba(0, 0, 0, 0.55)";var D=k*R;_.fillStyle=C,_.fillRect(D,0,R,G);var S=new Date(p.getTime());S.setDate(S.getDate()+k);var b=moment(S).format("L");_.textAlign="center",_.font="25px sans-serif",_.fillStyle="rgb(150,150,150)",_.fillText(b,D+R/2,30)}for(var U=o.split("|"),y=0;2>y;++y)for(var N=0;N<U.length;++N){var w=U[N].split(";"),A=new Date(w[1]),x=(A.getTime()-f)/g*I,$=G-(P+(+w[0]-1)/6*(G-30-2*P));if(0===y){if(N>0){var L=U[N-1].split(";"),V=new Date(L[1]),F=(V.getTime()-f)/g*I,j=G-(P+(+L[0]-1)/6*(G-30-2*P));_.strokeStyle="rgba(255,255,255, 0.4)",_.beginPath(),_.moveTo(F,j),_.lineTo(x,$),_.stroke()}}else{var X=M.COLORS[7-w[0]],B=hexToRgb(X),J="rgb("+B.r+","+B.g+","+B.b+")";_.fillStyle=J,_.beginPath(),_.arc(x,$,8,0,2*Math.PI),_.closePath(),_.fill()}}}function j(t,e){var o=$(".group-post");if(0!==o.length){for(var n=$("div[data-mooddata]"),r=window.devicePixelRatio,i=120,a=window.innerWidth,u=n.length,c=0;u>c;++c){var l=$(n[c]),p=""+l.data("mooddata"),d=l.data("startdate");if(d){a=l.outerWidth();var m=-1,f=l.find("canvas");f[0].width<100&&(f.css("width",a),f.css("height",i),K(l,p,f,r,i,a,m,!0))}}t&&s(function(){g.scrollBottom(e)})}}var X=3e4;n("AbstractGroupPostsCtrl",{$scope:t}),t.groupId=i.groupId,G.clearGroupNotification(t.groupId),t.loadingGroup=!0,G.getGroup(t.groupId).success(function(e){t.group=e,t.loadingGroup=!1,C()}).error(function(){t.loadingGroup=!1}),t.getGroupTitle=function(){var e=t.group?t.group.name:void 0;return e?e.length>20&&(e=e.substring(0,20)," "==e.substring(19)&&(e=e.substring(0,19))):e="",e},t.getGroupCode=function(){return t.group&&t.isOwner(t.group)?t.group.code:""},t.showGroupTip=function(){if(t.group&&t.group.members>1)return!1;var e=T.getUserPreference("sent_group_invitation");return!e&&t.isOwner(t.group)},t.showManageGroupTooltip=function(){var e=T.getUserPreference("viewed_manage_group_tooltip");return!(t.showGroupTip()||e&&"false"!=e)},t.dismissManageGroupTooltip=function(){t.viewManageGroupTooltip=!1,T.setUserPreference("viewed_manage_group_tooltip","true")},t.websocketSend=function(e){t.chatConnection&&t.chatConnection.send(e)},document.addEventListener("resume",y,!1),h.on("pause",function(){w()}),t.$on("$destroy",function(){t.destroying=!0,document.removeEventListener("resume",y,!1),w()}),t.scrollToNewPosts=function(){g.scrollBottom(!0),t.hasNewPosts=!1},$(".scroll-content").scroll(function(){var e=g.getScrollPosition().top,o=g.getScrollView().__maxScrollTop;e>o-150&&(t.hasNewPosts=!1,t.$$phase||t.$digest())}),t.isOwner=function(){return t.group&&t.group.creatorId==T.getAccountUser().user.id},window.viewGroupUsers=function(e){e.stopPropagation(),e.preventDefault(),t.group&&r.go("app.groups-users",{groupId:t.group.id})},t.groupPosts=[],t.postDataObjects={},t.limit=25,t.offset=0,t.canLoadMore=!0,t.order=i.order,initEditFunctionality(t,s,c,m,d,G,T),t.loadMoreGroupsPosts=function(){t.offset+=t.limit,V()},t.reloadCommunityPosts=function(){t.offset=0,V(!0)},t.isPostType=function(e,o){var n=t.postDataObjects[e.id];return n?n.type==o:!1},t.getCommunityName=function(){if(!t.group)return"";var e=t.group.name,o=("COMMUNITY_"+e).replace(/ /g,"_").toUpperCase(),n=c.instant(o);return n==o?e:n},t.getPost=function(e){for(var o=0;o<t.groupPosts.length;++o){var n=t.groupPosts[o];if(n.id==e)return n}},t.getMoodEntries=function(e){var o=t.postDataObjects[e.id];if(o){if(o.moodEntries)return o.moodEntries;if("Mood"==o.type){var n=o.data;if(n){var r=JSON.parse(n);return o.moodEntries=r,r}}}},t.getMoodStartDate=function(e){var o=t.postDataObjects[e.id];if(o){if(o.startDate)return o.startDate;if("Mood"==o.type){var n=o.data;if(n&&n.startDate){var r=new Date(n.startDate);return o.startDate=r,r}}}},t.getMoodNumberOfDays=function(e){var o=t.postDataObjects[e.id];if(o){if(o.numberOfDays)return o.numberOfDays;if("Mood"==o.type){var n=o.data;if(n){var r=+n.numberOfDays;return o.numberOfDays=r,r}}}},t.getMoodClass=function(e){var o=t.getMoodEntries(e);if(o&&o.length>0){var n=o[o.length-1];return O.getMoodClass(n)}},t.getMoodDisplay=function(e){var o=t.getMoodEntries(e);if(o&&o.length>0){var n=o[o.length-1];return O.getHabitDisplayFromValue(n)}},t.getMoodData=function(e){var o=t.getMoodEntries(e);if(o&&o.length>0){for(var n="",r=0;r<o.length;++r){if(r>0&&(n+="|"),void 0===o[r].valueInt){var i=O.getHabitValueById(o[r].habitValueId);n+=i.valueInt}else n+=o[r].valueInt;n+=";"+o[r].experiencedAtStr}return n}},t.getPositiveFlags=function(t){return x(t,"positive")},t.getNegativeFlags=function(t){return x(t,"negative")},t.getThought=function(e){var o=t.postDataObjects[e.id];if(o){if(o.thought)return o.thought;if("Thought"==o.type){var n=o.data;if(n){var r=JSON.parse(n);return o.thought=r,r}o.thought={}}}return{}},t.getExperiment=function(e){var o=t.postDataObjects[e.id];if(o){if(o.experiment)return o.experiment;if("Experiment"==o.type){var n=o.data;if(n){var r=JSON.parse(n);return o.experiment=r,r}o.experiment={}}}return{}},t.getExperimentCompletionDate=function(e){var o=t.getExperiment(e);if(o){var n=o.achievedRecordedAtString;if(n)return moment(new Date(n)).calendar()}},t.showTop=function(){"hotness"!=t.order&&(t.order="hotness",t.groupPosts.length=0,F(),V(),g.scrollTop())},t.showNew=function(){"date"!=t.order&&(t.order="date",t.groupPosts.length=0,F(),V(),g.scrollTop())},t.showAllTime=function(){"score"!=t.order&&(t.order="score",t.groupPosts.length=0,F(),V(),g.scrollTop())},t.removePost=function(e){t.removePostById(e.id)},t.removePostById=function(e){for(var o=0;o<t.groupPosts.length;++o)if(t.groupPosts[o].id==e)return void t.groupPosts.splice(o,1)},t.createPostInternal=function(o,n){t.submittingPost=!0,t.typing=!1;var r;if(n){r=[];for(var i in n){if(r.push({name:"type",value:i}),r.push({name:"version",value:"1"}),"Mood"==i){var a=n.Mood.moodEntries;r.push({name:"data",value:JSON.stringify(a)}),r.push({name:"startDate",value:n.Mood.startDate}),r.push({name:"numberOfDays",value:n.Mood.numberOfDays})}else if("Thought"==i){var u=n.Thought;r.push({name:"data",value:JSON.stringify(u)});var l=new Date((new Date).getTime()+6048e5);r.push({name:"expiresAtStr",value:l.toString()})}else if("Experiment"==i){var p=n.Experiment;r.push({name:"data",value:JSON.stringify(p)})}break}}$("#postText").blur();var m=t.groupPostData.postText,f=t.communityPostData.postText;t.groupPostData.postText="",t.communityPostData.postText="",G.createGroupPost(t.groupId,o,r).success(function(o){if(t.sharingData={},t.submittingPost=!1,t.group.private){t.groupPosts.push(o),t.postDataObjects[o.id]={};for(var n=0;n<r.length;++n){var i=r[n];t.postDataObjects[o.id][i.name]=i.value}s(function(){g.scrollBottom(!0)})}else R.checkForLevelUp(),t.groupPosts.splice(0,0,o);t.createVoteObject(o),s(j),s(function(){e.$broadcast("event:createdMessage")},500)}).error(function(){t.groupPostData.postText=m,t.communityPostData.postText=f;d.alert({template:c.instant("LOADING_POSTS_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"});t.submittingPost=!1})},t.createPost=function(e){if(e&&(e.preventDefault(),e.stopPropagation()),!t.checkOfflineMode()){if(!T.getAccountUser().user.banned){if(!t.isUserEmailValidated())return void t.checkRemoteEmailValidation(function(e){e&&t.createPost()});var o=!1;t.hasSharingData&&(o=t.hasSharingData("Mood")||t.hasSharingData("Thought")||t.hasSharingData("Experiment"));var n=t.groupPostData.postText.trim();return 0!==n.length||o?void t.createPostInternal(n,t.sharingData):void(t.groupError=c.instant("CREATE_POST_TEXT_ERROR"))}{d.alert({template:c.instant("BANNED_USER_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}}},t.closeCreatePostModal=function(){closeModal(t.createCommunityPostModal),t.createCommunityPostModal.remove(),t.createCommunityPostModal=void 0},t.canCreateCommunityPost=function(){return!T.getAccountUser().user.banned&&G.canCreatePublicGroupPost(t.group)},t.createCommunityPost=function(){var e=t.communityPostData.postText.trim();return 0===e.length?void(t.communityError=c.instant("CREATE_POST_TEXT_ERROR")):e.length>500?void(t.communityError=c.instant("CREATE_POST_LENGTH_ERROR")):(t.communityError=void 0,t.createPostInternal(e),t.closeCreatePostModal(),void t.showNew())},t.getCommunityPostRemainingCharacters=function(){var e=t.communityPostData.postText;return e=e?e.trim():"",500-e.length},t.getGroupRemainingPostCharacters=function(){var e=t.groupPostData.postText;return e||(e=""),500-e.length},t.showCreatePost=function(){if(!t.checkOfflineMode()){if(!t.hasUserNickname())return t.attemptingCommunityPost=!0,void t.showUpdateNickname();if(!t.isUserEmailValidated())return void t.checkRemoteEmailValidation(function(e){e&&t.showCreatePost()});if(t.canCreateCommunityPost())t.group&&"Experiments"==t.group.name?t.showExperimentShare():(t.communityPostData.postText="",m.fromTemplateUrl("views/groups/communities.createPost.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.createCommunityPostModal=e,openModal(t.createCommunityPostModal)}));else if(T.getAccountUser().user.banned){d.alert({template:c.instant("BANNED_USER_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}else{d.alert({template:c.instant("CREATE_POST_COOLOFF_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}}},initEditNicknameFunctionality(t,T,d,m,c),s(function(){$(".community-tabs").css("top",$("ion-header-bar").outerHeight()+"px")}),t.getMoodDetailDate=function(){return t.moodDetailDate?moment(t.moodDetailDate).calendar():void 0},t.getMoodColor=function(t){return M.COLOR_NAMES[7-t.valueInt]},t.getHabitSubValue=function(t){var e=O.getHabitSubValueName(0,t);return c.instant(e?e.toUpperCase():"UNKNOWN")},t.getMoodRatingDisplay=function(t){var e=t.valueString,o="HABITS_VALUES_"+e;return o=o.replace(/ /g,"_").toUpperCase(),c.instant(o)},t.getMoodRatingDateDisplay=function(t){var e=new Date(t.experiencedAtStr);return moment(e).calendar()},t.hasNotes=function(t){return t.habitDataNotes&&t.habitDataNotes.notes&&t.habitDataNotes.notes.length>1},t.closeMoodDetailModal=function(){closeModal(t.moodDetailModal),t.moodDetailModal.remove(),t.moodDetailModal=void 0}}]),ctrl.controller("GroupsProfileCtrl",["$scope","$rootScope","$state","$timeout","$http","$stateParams","$ionicPopup","$ionicModal","$ionicScrollDelegate","$controller","$translate","AccountService","GroupsService",function(t,e,o,n,r,i,a,s,u,c,l,p,d){function m(t,e){if(t)for(var o=p.getAccountUser().user.id,n=0;n<t.length;++n){var r=t[n];r.creatorId==o&&(r.creatorAvatar=e)}}function f(e){d.getUserLikes(e).success(function(e){t.addUserVotes(e)}).error(function(){a.alert({template:l.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})})}function g(e){d.getUserCommentLikes(e).success(function(e){t.addUserCommentVotes(e)}).error(function(){a.alert({template:l.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})})}function v(e){(e||!t.shares)&&((!t.shares||t.otherUserId||0===t.shareOffset)&&(t.shares=[]),t.loadingShares=!0,d.getShares(t.limit,t.shareOffset,t.otherUserId?t.otherUserId:void 0).success(function(e){if(t.canLoadMoreShares=e.length==t.limit,t.shares.push.apply(t.shares,e),t.viewingOtherUser)f(e);else for(var o in e)t.createVoteObject(e[o]);t.loadingShares=!1,u.resize()}).error(function(){a.alert({template:l.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"});t.loadingShares=!1}))}function h(e){if(e||!t.likes)(!t.likes||t.otherUserId||0===t.likeOffset)&&(t.likes=[]),t.loadingLikes=!0,d.getLikes(t.limit,t.likeOffset,t.otherUserId?t.otherUserId:void 0).success(function(e){t.canLoadMoreLikes=e.length==t.limit,t.likes.push.apply(t.likes,e);for(var o in e)t.createVoteObject(e[o]);t.loadingLikes=!1,u.resize()}).error(function(){a.alert({template:l.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"});t.loadingLikes=!1});else for(var o=t.likes.length-1;o>=0;--o)t.hasVote(t.likes[o])||t.likes.splice(o,1)}function T(e){(e||!t.comments)&&((!t.comments||t.otherUserId||0===t.commentOffset)&&(t.comments=[]),t.loadingComments=!0,d.getComments(t.limit,t.commentOffset,t.otherUserId?t.otherUserId:void 0).success(function(e){if(t.canLoadMoreComments=e.length==t.limit,t.comments.push.apply(t.comments,e),t.otherUserId)g(e);else for(var o in e)t.createVoteObject(e[o]);t.loadingComments=!1,u.resize()}).error(function(){a.alert({template:l.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"});t.loadingComments=!1}))}c("AbstractGroupPostsCtrl",{$scope:t}),d.findPublicGroups(),i.userId?(t.loadingUser=!0,t.viewingOtherUser=!0,t.otherUserId=+i.userId,p.getPublicUser(t.otherUserId).success(function(e){t.user=e,i.nickname&&(t.user.publicName=i.nickname),t.loadingUser=!1}).error(function(){a.alert({template:l.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"});t.loadingUser=!1})):t.user=p.getAccountUser().user,t.getUserName=function(){return t.viewingOtherUser&&t.loadingUser?l.instant("LOADING")+"...":i.nickname?i.nickname:t.user.publicName},t.getUserAvatar=function(){if(t.viewingOtherUser&&t.loadingUser)return"";var e=p.getAvatarCharacter(t.user.avatar,t.user.id);return"avatar_"+e},t.isAvatarSelected=function(t){var e=p.getAccountUser().user;return t==p.getAvatarCharacter(e.avatar,e.id)},t.setUserAvatar=function(e){p.setAvatar(e).success(function(){t.user.avatar=e,m(t.shares,e),m(t.likes,e),m(t.comments,e),t.closeAvatarModal()}).error(function(){a.alert({template:l.instant("ERROR_UPDATING_AVATAR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})})},t.closeAvatarModal=function(){closeModal(t.chooseAvatarModal),t.chooseAvatarModal.remove(),t.chooseAvatarModal=void 0},t.showChooseAvatar=function(){s.fromTemplateUrl("views/groups/communities.chooseAvatar.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.chooseAvatarModal=e,openModal(t.chooseAvatarModal)
})},t.getJoinedDate=function(){if(t.user){var e=new Date(t.user.createdAt);return moment(e).format("LL")}return""},t.activeTab="shares",t.limit=25,t.shares=void 0,t.shareOffset=0,t.canLoadMoreShares=!0,t.likes=void 0,t.likeOffset=0,t.canLoadMoreLikes=!0,t.comments=void 0,t.commentOffset=0,t.canLoadMoreComments=!0,initEditNicknameFunctionality(t,p,a,s,l),t.findPublicGroupName=function(t){return d.findPublicGroupName(t)},t.setActiveTab=function(e){t.activeTab=e,"shares"==e?v():"likes"==e?h():T(),u.scrollTop()},t.removePost=function(e){t.removePostById(e.id)},t.removePostById=function(e){if(t.shares)for(var o=0;o<t.shares.length;++o)if(t.shares[o].id==e){t.shares.splice(o,1);break}if(t.likes)for(var n=0;n<t.likes.length&&t.likes[n].id!=e;++n);},t.getActivePosts=function(){return"shares"==t.activeTab?t.shares:"likes"==t.activeTab?t.likes:t.comments},t.isLoading=function(){return t.loadingShares||t.loadingLikes},t.loadMoreLikes=function(){t.likeOffset+=t.limit,h(!0)},t.loadMoreShares=function(){t.shareOffset+=t.limit,v(!0)},t.loadMoreComments=function(){t.commentOffset+=t.limit,T(!0)},t.loadMorePosts=function(){"shares"==t.activeTab?t.loadMoreShares():"likes"==t.activeTab?t.loadMoreLikes():t.loadMoreComments()},t.canLoadMore=function(){return"shares"==t.activeTab?t.canLoadMoreShares:"likes"==t.activeTab?t.canLoadMoreLikes:t.canLoadMoreComments},n(function(){$(".community-tabs").css("top",$("ion-header-bar").outerHeight()+"px")}),t.setActiveTab("shares")}]),ctrl.controller("GroupsUsersCtrl",["$scope","$sce","$rootScope","$state","$timeout","$http","$stateParams","$analytics","$ionicModal","$ionicPopup","$ionicHistory","$ionicActionSheet","$controller","$translate","AccountService","GroupsService","GeneralService","Environment",function(t,e,o,n,r,i,a,s,u,c,l,p,d,m,f,g,v,h){t.group=g.getGroupImmediate(+a.groupId),t.loadingUsers=!0,t.notificationData={};var T=f.getUserPreference("receive_community_notifications");t.notificationData.communityNotification=T?""+("true"==T.toLowerCase()):"true",t.updateCommunityNotifications=function(){f.setUserPreference("receive_community_notifications",t.notificationData.communityNotification).success(function(){t.communityNotificationUpdated=!0,r(function(){t.communityNotificationUpdated=!1},3e3)})},t.checkOfflineMode=function(){if(!h.isOnline()){{c.alert({template:m.instant("GROUPS_OFFLINE_ERROR"),okText:m.instant("OK_GOT_IT"),okType:"button-default"})}return!0}return!1},t.getGroupCode=function(){return t.group.code},t.viewUserProfile=function(t,e,o){t.stopPropagation(),t.preventDefault(),n.go("app.groups-profile",{userId:e.userId,nickname:o})},t.leaveGroup=function(e){if(e.stopPropagation(),e.preventDefault(),!t.checkOfflineMode()){s.eventTrack("archiveGroupPopupFromMembers",{category:"group"});var o=c.confirm({template:"<div>"+m.instant("LEAVE_GROUP_PROMPT")+"</div>",cancelText:m.instant("CANCEL"),cancelType:"button-default",okText:m.instant("LEAVE"),okType:"button-default"});o.then(function(e){e&&g.leaveGroup(t.group.id).success(function(){t.goBack(-2)}).error(function(){c.alert({template:m.instant("LEAVE_GROUP_ERROR"),okText:m.instant("OK_GOT_IT"),okType:"button-default"})})})}},t.copyCodeToClipboard=function(){cordova.plugins.clipboard.copy(t.group.code,function(){c.alert({template:m.instant("GROUP_CODE_COPIED"),okText:m.instant("OK_GOT_IT"),okType:"button-default"})},function(){})},t.isOwner=function(){return t.group.creatorId==f.getAccountUser().user.id},t.isYou=function(t){return t.userId==f.getAccountUser().user.id},initInviteFunctionality(t,m,u,c,p,f,g,v),g.getGroupUsers(+a.groupId).success(function(e){var o=e.groupUsers;t.groupUsers=o;for(var n=0;n<t.groupUsers.length;++n){var r=t.groupUsers[n];if(t.isYou(r)){t.groupUsers.splice(n,1),t.groupUsers.unshift(r);break}}t.pendingInvites=e.pendingInvites,t.loadingUsers=!1}).error(function(){c.alert({template:m.instant("RETRIEVE_USERS_ERROR"),okText:m.instant("OK_GOT_IT"),okType:"button-default"});t.loadingUsers=!1}),t.deletePendingInvite=function(e){var o=c.confirm({template:"<div>"+m.instant("DELETE_INVITE_PROMPT")+"</div>",cancelText:m.instant("CANCEL"),cancelType:"button-default",okText:m.instant("DELETE"),okType:"button-default"});o.then(function(o){o&&g.deleteInvite(t.group.id,e).success(function(){for(var o=0;o<t.pendingInvites.length;++o)if(t.pendingInvites[o].email==e){t.pendingInvites.splice(o,1);break}}).error(function(){c.alert({template:m.instant("DELETE_INVITE_ERROR"),okText:m.instant("OK_GOT_IT"),okType:"button-default"})})})},t.removeUser=function(e){var o=c.confirm({template:"<div>"+m.instant("REMOVE_USER_PROMPT")+"</div>",cancelText:m.instant("CANCEL"),cancelType:"button-default",okText:m.instant("REMOVE"),okType:"button-default"});o.then(function(o){o&&g.removeUser(t.group.id,e).success(function(){for(var o=0;o<t.groupUsers.length;++o)if(t.groupUsers[o].userId==e){t.groupUsers.splice(o,1);break}--t.group.members}).error(function(){c.alert({template:m.instant("REMOVE_USER_ERROR"),okText:m.instant("OK_GOT_IT"),okType:"button-default"})})})}}]),ctrl.controller("GroupsHelpCtrl",["$scope","$sce","$rootScope","$state","$http","$stateParams","$controller","$translate","$ionicHistory","AccountService",function(t,e,o,n,r,i,a,s,u,c){a("HelpCtrl",{$scope:t}),t.getHelpSlide=function(t){var o="GROUPS_HELP_SLIDE_"+t;return e.trustAsHtml(s.instant(o))},t.confirm=function(){c.setUserPreference("viewed_groups_disclaimer","true"),u.currentView(u.backView()),n.go("app.group-posts",{groupId:i.groupId,order:i.order},{location:"replace"})}}]),ctrl.controller("CommunitiesHelpCtrl",["$scope","$sce","$rootScope","$state","$http","$stateParams","$controller","$translate","$ionicHistory","AccountService",function(t,e,o,n,r,i,a,s,u,c){a("HelpCtrl",{$scope:t}),t.getHelpSlide=function(t){var o="COMMUNITIES_HELP_SLIDE_"+t;return e.trustAsHtml(s.instant(o))},t.confirm=function(){c.setUserPreference("viewed_community_rules","true"),u.currentView(u.backView()),"app.communities-help"==n.current.name?n.go("app.communities-posts",{groupId:i.groupId,order:i.order},{location:"replace"}):"app.groups-help"==n.current.name&&n.go("app.group-posts",{groupId:i.groupId,order:i.order},{location:"replace"})}}]);