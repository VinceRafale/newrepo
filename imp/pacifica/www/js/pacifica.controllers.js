function createValue(e,t){return{display:"",ordinate:e,valueInt:t,valueString:null}}function checkGroupModal(e,t,o){var i=$("#groupName").val();i&&(i=i.trim());var n=$("#groupNickname").val();return n&&(n=n.trim()),!o||i&&0!==i.length?n&&0!==n.length?/^[a-z0-9]+$/i.test(n)?!1:(e.groupError=t.instant("LOGIN_ERROR_ALPHANUMERIC_NAME"),!0):(e.groupError=t.instant("CREATE_GROUP_NO_NICKNAME"),!0):(e.groupError=t.instant("CREATE_GROUP_NO_NAME"),!0)}function initInviteFunctionality(e,t,o,i,n,a,r,s){e.sendingInvites=!1,e.closeInviteModal=function(){closeModal(e.inviteModal),e.inviteModal.remove(),e.inviteModal=void 0},e.sendInvite=function(){var o=$("#inviteEmails").val().trim(),n=$("#inviteText").val().trim();if(!o||0===o.length)return void(e.inviteError=t.instant("INVITE_ERROR_MISSING_EMAIL"));if(!n||0===n.length)return void(e.inviteError=t.instant("INVITE_ERROR_MISSING_TEXT"));for(var c=a.getAccountUser().user.email,l=o.split(","),u=0;u<l.length;++u){var d=l[u].trim();if(!s.isEmailValid(d)||d==c)return void(e.inviteError=t.instant("INVITE_ERROR_INVALID_EMAIL"));l[u]=d}e.sendingInvites=!0,r.sendInvites(e.group.id,l,n).success(function(){if(a.setUserPreference("sent_group_invitation","true"),e.sendingInvites=!1,e.closeInviteModal(),e.pendingInvites)for(var o=0;o<l.length;++o)e.pendingInvites.push({userGroup:e.group,email:l[o],createdAtStr:(new Date).toString()});i.alert({template:t.instant("SEND_INVITE_SUCCESS"),okText:t.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){e.sendingInvites=!1;i.alert({template:t.instant("SEND_INVITE_ERROR"),okText:t.instant("OK_GOT_IT"),okType:"button-default"})})},e.showInvite=function(){n.show({buttons:[{text:t.instant("INVITE_VIA_EMAIL")},{text:t.instant("INVITE_VIA_SMS")}],titleText:t.instant("INVITE_TO_GROUP_TITLE"),cancelText:t.instant("CANCEL"),cancel:function(){},buttonClicked:function(o){var n=t.instant("INVITE_TEXT")+" "+e.group.code+".",a=t.instant("DOWNLOAD_PACIFICA");return 0===o?window.plugins.socialsharing.shareViaEmail(n+"\n\n"+a,t.instant("INVITE_EMAIL_SUBJECT"),null,null,null,null,function(e){},function(){i.alert({template:t.instant("INVITE_EMAIL_ERROR"),okText:t.instant("OK_GOT_IT"),okType:"button-default"})}):1==o&&window.plugins.socialsharing.shareViaSMS(n+" "+a,null,function(e){},function(){i.alert({template:t.instant("INVITE_SMS_ERROR"),okText:t.instant("OK_GOT_IT"),okType:"button-default"})}),!0}})},e.selectGroupForInvite=function(t){e.selectedGroupForInvite=t},e.isGroupSelectedForInvite=function(t){return e.selectedGroupForInvite==t},e.closeSelectGroupForInviteModal=function(){closeModal(e.selectGroupModal),e.selectGroupModal.remove(),e.selectGroupModal=void 0},e.checkSelectGroupForInvite=function(){return e.selectedGroupForInvite?(e.inviteExistingError=void 0,void e.showInviteExistingUser()):void(e.inviteExistingError=t.instant("SELECT_GROUP_MISSING"))},e.showSelectGroupForInvite=function(){e.loadingGroups=!0,r.findUserGroups().success(function(t){e.userGroups=t.userGroups.slice();for(var o=e.userGroups.length-1;o>=0;--o)e.isGroupOwner(e.userGroups[o])||e.userGroups.splice(o,1);e.loadingGroups=!1}).error(function(){i.alert({template:t.instant("LOADING_GROUPS_ERROR"),okText:t.instant("OK_GOT_IT"),okType:"button-default"});e.loadingGroups=!1}),o.fromTemplateUrl("views/groups/groups.selectGroup.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.selectGroupModal=t,openModal(e.selectGroupModal)})},e.inviteExistingUser=function(){var o=$("#inviteText").val().trim();return o&&0!==o.length?(e.sendingInvites=!0,void r.inviteExistingUser(e.selectedGroupForInvite.id,e.invitingUserId,o).success(function(){a.setUserPreference("sent_group_invitation","true"),e.sendingInvites=!1,e.closeInviteExistingUserModal();i.alert({template:t.instant("SEND_INVITE_SUCCESS"),okText:t.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){e.sendingInvites=!1;i.alert({template:t.instant("SEND_INVITE_ERROR"),okText:t.instant("OK_GOT_IT"),okType:"button-default"})})):void(e.inviteError=t.instant("INVITE_ERROR_MISSING_TEXT"))},e.closeInviteExistingUserModal=function(){closeModal(e.inviteExistingUserModal),e.inviteExistingUserModal.remove(),e.inviteExistingUserModal=void 0},e.showInviteExistingUser=function(){e.selectGroupModal&&e.closeSelectGroupForInviteModal(),o.fromTemplateUrl("views/groups/groups.inviteExistingUser.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.inviteExistingUserModal=t,openModal(e.inviteExistingUserModal)})}}function initEditFunctionality(e,t,o,i,n,a,r){e.closeEditGroupModal=function(){closeModal(e.editGroupModal),e.editGroupModal.remove(),e.editGroupModal=void 0},e.editGroup=function(){var t=e.isOwnerById(e.editGroupId);if(!checkGroupModal(e,o,t)){e.groupError=void 0;var i=e.newGroupData.name,s=e.newGroupData.nickname,c=e.newGroupData.searchable,l=c?e.newGroupData.description:void 0;i=i.trim(),s=s.trim(),l&&""===l.trim()&&(l=void 0);var u=function(){e.editingGroup=!1;var o=a.getGroupImmediate(e.editGroupId);if(t&&(o.name=i),o.nickname=s,e.groupPosts)for(var n=r.getAccountUser().user,c=0;c<e.groupPosts.length;++c){var l=e.groupPosts[c];l.creatorId==n.id&&(l.creatorNickname=s)}e.closeEditGroupModal()},d=function(t,i){e.editingGroup=!1,n.alert(409==i?{template:o.instant("GROUP_CONFLICT_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"}:{template:o.instant("UPDATE_GROUP_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})};e.editingGroup=!0,t?a.editGroup(e.editGroupId,i,s,l,c).success(u).error(d):a.editGroupNickname(e.editGroupId,s).success(u).error(d)}},e.showEditGroup=function(t,o){t.stopPropagation(),t.preventDefault(),e.checkOfflineMode()||(e.newGroupData={nickname:o.nickname,name:o.name,description:o.description,searchable:o.searchable},e.editGroupId=o.id,e.groupError=void 0,i.fromTemplateUrl("views/groups/groups.editGroup.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.editGroupModal=t,openModal(e.editGroupModal)}))}}function initEditNicknameFunctionality(e,t,o,i,n){e.closeNicknameModal=function(){closeModal(e.nicknameModal),e.nicknameModal.remove(),e.nicknameModal=void 0},e.updatePublicNickname=function(){var o=$("#updateUserNickname").val().trim();o&&0!==o.length?/^[a-z0-9]+$/i.test(o)?(e.nicknameError=void 0,e.updatingNickname=!0,t.setPublicNickname(o).success(function(){e.updatingNickname=!1,e.user&&!e.viewingOtherUser&&(e.user.publicName=o),t.updateLocalPublicNickname(o);var i=t.getAccountUser().user.id;if(e.group&&e.groupPosts&&!e.group.private)for(var n=0;n<e.groupPosts.length;++n){var a=e.groupPosts[n];a.creatorId==i&&(a.creatorNickname=o)}if(e.shares)for(var r=0;r<e.shares.length;++r){var s=e.shares[r];s.creatorId==i&&(s.creatorNickname=o)}e.attemptingCommunityPost&&e.showCreatePost(),e.attemptingInvite&&e.showInvitePopup(),e.closeNicknameModal()}).error(function(){e.updatingNickname=!1,e.nicknameError=n.instant("UPDATE_NICKNAME_ERROR")})):e.nicknameError=n.instant("LOGIN_ERROR_ALPHANUMERIC_NAME"):e.nicknameError=n.instant("LOGIN_ERROR_MISSING_NAME")},e.showUpdateNickname=function(){t.setUserPreference("viewed_communities_popup",!0),e.originalNickname=t.getAccountUser().user.publicName,e.originalNickname||(e.originalNickname=t.getAccountUser().user.name),i.fromTemplateUrl("views/groups/groups.updateNickname.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.nicknameModal=t,openModal(e.nicknameModal)})}}function initValidateEmailFunctionality(e,t,o,i,n){e.closeEmailValidationPopup=function(){closeModal(e.emailValidationModal),e.emailValidationModal.remove(),e.emailValidationModal=void 0},e.checkRemoteEmailValidation=function(o){t.checkRemoteEmailValidation().success(function(i){i.validated?t.getAccountUser().user.emailVerifiedAt=new Date:e.showEmailValidationPopup(),o&&o(i.validated)}).error(function(){i.alert({template:n.instant("GENERIC_ERROR"),okText:n.instant("OK_GOT_IT"),okType:"button-default"})})},e.showEmailValidationPopup=function(){$("#postText").blur(),o.fromTemplateUrl("views/groups/groups.validateEmail.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.emailValidationModal=t,openModal(e.emailValidationModal)})},e.isUserEmailValidated=function(){return t.isEmailValidated()},e.resendValidationEmail=function(){t.resendValidationEmail().success(function(){i.alert({template:n.instant("VALIDATION_EMAIL_SENT"),okText:n.instant("OK_GOT_IT"),okType:"button-default"});e.closeEmailValidationPopup()}).error(function(){i.alert({template:n.instant("GENERIC_ERROR"),okText:n.instant("OK_GOT_IT"),okType:"button-default"})})}}function initCreateGroupFunctionality(e,t,o,i,n,a,r,s,c){function l(){e.editingGroup=!1,e.groupError=void 0,n.fromTemplateUrl("views/groups/groups.createGroup.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.createGroupModal=t,openModal(e.createGroupModal)})}e.closeCreateGroupModal=function(){closeModal(e.createGroupModal),e.createGroupModal.remove(),e.createGroupModal=void 0},e.isNewGroupPublic=function(){return e.newGroupData.searchable},e.createGroup=function(){if(!checkGroupModal(e,o,!0)){var t=e.newGroupData.name,n=e.newGroupData.nickname,a=e.newGroupData.searchable,r=a?e.newGroupData.description:void 0;t=t.trim(),n=n.trim(),r&&""===r.trim()&&(r=void 0),e.groupError=void 0,e.creatingGroup=!0,s.createGroup(t,n,r,a).success(function(t){e.creatingGroup=!1,e.userGroups=void 0,e.loadGroups&&e.loadGroups(!0),e.closeCreateGroupModal(),e.invitingUserId&&(e.selectedGroupForInvite=t,e.showInviteExistingUser())}).error(function(t,n){e.creatingGroup=!1,i.alert(409==n?{template:o.instant("GROUP_CONFLICT_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"}:{template:o.instant("CREATE_GROUP_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})})}},e.closeChooseRandomGroupModal=function(){closeModal(e.chooseRandomGroupModal),e.chooseRandomGroupModal.remove(),e.chooseRandomGroupModal=void 0},e.joinRandomGroup=function(t){e.chooseRandomGroupModal&&("depression"==t?t=o.instant("NUX_GOAL_DEPRESSION"):"gad"==t?t=o.instant("NUX_GOAL_GAD"):"social"==t?t=o.instant("NUX_GOAL_SOCIAL"):"health"==t&&(t=o.instant("NUX_GOAL_HEALTH")),e.closeChooseRandomGroupModal()),s.joinRandomGroup(t,c.getUserPreference("preferred_locale")).success(function(){e.userGroups=void 0,e.loadGroups(!0)}).error(function(){i.alert({template:o.instant("ERROR_JOINING_RANDOM_GROUP"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})})},e.showJoinRandomGroup=function(){if(e.userGroups)for(var t=0;t<e.userGroups.length;++t)if(e.userGroups[t].randomized)return void i.alert({template:o.instant("ONLY_ONE_RANDOM_GROUP_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"});n.fromTemplateUrl("views/groups/groups.chooseRandomGroup.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.chooseRandomGroupModal=t,openModal(e.chooseRandomGroupModal)})},e.createOrJoinRandomGroup=function(){if(!e.checkOfflineMode()){if(!c.getAccountUser().user.banned)return e.isUserEmailValidated()?void e.showCreateGroup():void e.checkRemoteEmailValidation(function(t){t&&e.createOrJoinRandomGroup()});{i.alert({template:o.instant("BANNED_USER_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})}}},e.showCreateGroup=function(t){if(!e.checkOfflineMode()){e.newGroupData={nickname:"",name:"",description:"",searchable:!0};var n=c.getAccountUser().user;return e.newGroupData.nickname=n.publicName?n.publicName:n.name,t&&(e.newGroupData.name=t),c.isPremiumEnabled()?void l():(a.show({template:o.instant("LOADING")+"..."}),void s.findUserGroups(!0).success(function(){a.hide(),l(t)}).error(function(){a.hide(),i.alert({template:o.instant("LOADING_GROUPS_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"}),e.loadingGroups=!1}))}}}var ctrl=angular.module("accountCtrl",[]),EMAIL_REGEX=/^[a-zA-Z0-9.!#$%&’*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;ctrl.controller("MiloVideosCtrl",["$rootScope","$scope","AccountService",function(e,t,o){t.viewMoodVideo=function(){o.viewVideo(o.MOOD_VIDEO)},t.viewRelaxVideo=function(){o.viewVideo(o.RELAX_VIDEO)},t.viewGoalsVideo=function(){o.viewVideo(o.GOALS_VIDEO)},t.viewHealthVideo=function(){o.viewVideo(o.HEALTH_VIDEO)},t.viewThoughtsVideo=function(){o.viewVideo(o.THOUGHTS_VIDEO)},t.viewCommunityVideo=function(){o.viewVideo(o.COMMUNITY_VIDEO)}}]),ctrl.controller("AccountCtrl",["$rootScope","$scope","$state","$http","$timeout","$analytics","$translate","$ionicDeploy","$ionicLoading","$ionicPopup","$ionicModal","$ionicGesture","$ionicSideMenuDelegate","AccountService","HabitsService","GoalsService","GroupsService","AudioService","MediaService","PayService","Environment","Token",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T,m,E,_){function S(){}function I(){}function O(){window.store&&g.canUpgrade()&&_.isIos()&&(c.show({template:r.instant("ACCOUNT_UPGRADE_ATTEMPTING_REFRESH")+"..."}),window.store.forceRefresh(),n(function(){c.hide()},2e3))}t.user=g.getAccountUser(),t.loggedOut=!1,t.openSideMenu=function(){p.toggleLeft()};var A;t.canUpgrade=function(){return g.canUpgrade()},t.upgrade=function(){E.showPremiumModal(t,"account","upgrade",!0)},t.$on("$destroy",function(){d.off(A,"doubletap",O)}),n(function(){for(var e=document.getElementsByClassName("doubleTap"),t=0;t<e.length;++t){var o=e[t];A=d.on("doubletap",O,angular.element(o))}},1),t.closeNicknameModal=function(){closeModal(t.nicknameModal),t.nicknameModal.remove(),t.nicknameModal=void 0},t.updateNickname=function(){var e=$("#updateUserNickname").val();e&&0!==e.length?(t.nicknameError=void 0,g.setNickname(e).success(function(){t.closeNicknameModal()}).error(function(){l.alert({template:r.instant("UPDATE_NICKNAME_ERROR"),okText:r.instant("OK_GOT_IT"),okType:"button-default"})})):t.nicknameError=r.instant("LOGIN_ERROR_MISSING_NAME")},t.showUpdateNickname=function(){t.originalNickname=t.user.user.name,u.fromTemplateUrl("views/account/account.updateNickname.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.nicknameModal=e,openModal(t.nicknameModal)})},t.isEmailValidated=function(){return g.isEmailValidated()},t.closeEmailModal=function(){closeModal(t.emailModal),t.emailModal.remove(),t.emailModal=void 0},t.updateEmail=function(){var e=$("#updateUserEmail").val();EMAIL_REGEX.test(e)?(t.emailError=void 0,g.setEmailAddress(e).success(function(){t.closeEmailModal(),t.user.user.email=e,t.user.user.emailVerifiedAt=void 0}).error(function(){l.alert({template:r.instant("UPDATE_EMAIL_ERROR"),okText:r.instant("OK_GOT_IT"),okType:"button-default"});t.originalEmail&&(t.user.user.email=t.originalEmail)})):t.emailError=r.instant("LOGIN_ERROR_INVALID_EMAIL")},t.resendValidationEmail=function(){g.resendValidationEmail().success(function(){l.alert({template:r.instant("VALIDATION_EMAIL_SENT"),okText:r.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){l.alert({template:r.instant("GENERIC_ERROR"),okText:r.instant("OK_GOT_IT"),okType:"button-default"})})},t.showUpdateEmail=function(){t.originalEmail=t.user.user.email,u.fromTemplateUrl("views/account/account.updateEmail.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.emailModal=e,openModal(t.emailModal)})},t.sendFeedback=function(){window.plugins.socialsharing.shareViaEmail("","Pacifica Feedback",["info@thinkpacifica.com"],null,null,null,S,I)},t.getAccountType=function(){var e;return e=g.isPremiumEnabled()?r.instant("ACCOUNT_TYPE_FULL_ACCESS")+" - "+t.user.account.paymentType:r.instant("ACCOUNT_TYPE_BASIC")},t.getUserTimeZone=function(){return g.getUserTimeZone()},t.getShortTermPrice=function(){var e=E.getShortTermProductPrice();return e?"("+e+")":""},t.displayIntroVideos=function(){return g.completedIntroVideos()},t.isPremium=function(){return g.isPremiumEnabled()},t.getPremiumExpiration=function(){return g.getPremiumExpiration()},t.goToNotifications=function(){o.go("app.notifications")},t.goToTimeZones=function(){o.go("app.timezones")},t.goToLanguages=function(){o.go("app.languages")},t.goToTour=function(){o.go("app.miloVideos")},t.getPasscodeTitle=function(){return r.instant(t.settingNewPasscode?t.verifyingPasscode?"REENTER_PASSCODE":"SET_PASSCODE":"VERIFY_PASSCODE")},t.hasActivePasscode=function(){var e=g.getAccountUser();return e&&e.user&&e.user.passcode},t.getPasscodeRowTitle=function(){return r.instant(t.hasActivePasscode()?"CLEAR_PASSCODE":"SET_PASSCODE")},t.firstPasscode=void 0,t.superShowPasscodeModal=t.showPasscodeModal,t.hasPasscodeEntry=function(e){return t.enteredPasscode.length>=e},t.clearPasscode=function(){t.enteredPasscode=""},t.deletePasscodeCharacter=function(){t.enteredPasscode.length>0&&(t.enteredPasscode=t.enteredPasscode.substring(0,t.enteredPasscode.length-1))},t.canClosePasscodeModal=function(){return!0},t.forgotPasscode=function(){},t.canShowForgotPasscode=function(){return!1},t.addPasscodeEntry=function(e){t.enteredPasscode+=e,t.settingNewPasscode&&(t.verifyingPasscode?t.enteredPasscode.length>=4&&(t.enteredPasscode==t.firstPasscode?(t.closePasscodeModal(),g.setPasscode(t.enteredPasscode)):(t.passcodeError=r.instant("PASSCODE_MATCH_ERROR"),t.enteredPasscode="",t.firstPasscode="",t.verifyingPasscode=!1)):4==t.enteredPasscode.length&&(t.firstPasscode=t.enteredPasscode,t.enteredPasscode="",t.verifyingPasscode=!0))},t.showPasscodeModal=function(){return _.isOnline()?(t.firstPasscode="",t.enteredPasscode="",t.passcodeError=void 0,t.settingNewPasscode=!t.hasActivePasscode(),void(t.settingNewPasscode?(t.verifyingPasscode=!1,t.superShowPasscodeModal(t)):g.clearPasscode())):void l.alert({template:r.instant("PASSCODE_OFFLINE_ERROR"),okText:r.instant("OK_GOT_IT"),okType:"button-default"})},t.goToBackgrounds=function(){o.go("app.backgrounds")},t.logout=function(){function o(){a.eventTrack("logout",{category:"account"}),c.hide(),e.$broadcast("event:loginRequired")}var i=l.confirm({template:"<div>"+r.instant("ACCOUNT_LOGOUT_POPUP")+"</div>",cancelText:r.instant("CANCEL"),cancelType:"button-default",okText:r.instant("SIGN_OUT"),okType:"button-default"});i.then(function(e){e&&(c.show({template:r.instant("SIGNING_OUT")+"..."}),t.loggedOut=!0,g.logout().success(o).error(o))})}}]);var ctrl=angular.module("backgroundsCtrl",[]);ctrl.controller("BackgroundsCtrl",["$scope","$state","$http","$timeout","$translate","$analytics","$ionicLoading","$ionicSlideBoxDelegate","$ionicPopup","AccountService","HabitsService","GoalsService","AudioService","MediaService","PayService","Environment","Token",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f){function v(){S&&(angular.element(S).addClass("hideRemove"),S=void 0)}function h(t){l.setUserPreference("background_video",t.code);var o=t.bgAudio;o&&l.setUserPreference("bg_audio_src",o),g.setBackgroundVideo(t.filename,t.blurMethod),e.data.video=t.code}e.languageUpdated=!1,e.videos=g.getBackgroundVideos(),e.data={video:e.videos[0].code},e.isPremiumVideoEnabled=function(e){return e.free?!0:l.isPremiumEnabled()};var T=l.getUserPreference("background_video");if(T)for(var m=0;m<e.videos.length;++m){var E=e.videos[m];if(E.code==T){g.isDownloaded(E.filename)&&e.isPremiumVideoEnabled(E)&&(e.data.video=T);break}}var _;e.$on("event:downloadProgress",function(t,o){(!_||_.getTime()<(new Date).getTime()-250||o&&o.complete)&&i(function(){_=new Date,e.$$phase||e.$apply()})});var S;e.elementDragged=function(e){if("dragleft"==e.type){v();{angular.element(e.currentTarget).scope()}S=e.currentTarget,angular.element(e.currentTarget).removeClass("hideRemove")}else angular.element(e.currentTarget).addClass("hideRemove"),S=void 0},e.getVideoClass=function(e){return"bgVideo_"+e.code},e.removeDownload=function(t,o){t.stopPropagation(),t.preventDefault();var a=c.confirm({template:"<div>"+n.instant("BACKGROUND_VIDEO_REMOVE_PROMPT")+"</div>",cancelText:n.instant("CANCEL"),cancelType:"button-default",okText:n.instant("REMOVE"),okType:"button-default"});a.then(function(t){t&&(g.removeBackgroundVideo(o.filename),e.isActive(o)&&e.selectVideo(e.videos[0]),i(v,500))})},e.$on("event:downloadRemoved",function(){i(function(){S&&(angular.element(S).addClass("hideRemove"),S=void 0),e.$$phase||e.$apply()})}),e.isActive=function(t){return e.data.video==t.code},e.isDownloading=function(e){return g.isDownloading(e.filename)},e.isDownloaded=function(e){return"ocean"==e.code?!0:g.isDownloaded(e.filename)},e.getDownloadPercentage=function(e){return g.getDownloadPercentage(e.filename)},e.selectVideo=function(t){e.isPremiumVideoEnabled(t)?e.isDownloaded(t)?h(t):e.isDownloading(t)||g.downloadBackgroundVideo(t.filename,function(){h(t)},function(){}):f.showPremiumModal(e,"backgrounds",t.name,!0)},e.updateLanguage=function(){l.setLocale(e.data.locale).success(function(){e.languageUpdated=!0,i(function(){e.languageUpdated=!1},3e3)})}}]);var ctrl=angular.module("goalsCtrl",[]),GOAL_BRONZE_STAR_POINTS=20,GOAL_SILVER_STAR_POINTS=50,GOAL_GOLD_STAR_POINTS=100,CATEGORY_ORDER=["GOAL_LIST_CATEGORY_WORK_SCHOOL","GOAL_LIST_CATEGORY_FRIENDS_FAMILY","GOAL_LIST_CATEGORY_ROMANCE","GOAL_LIST_CATEGORY_STRANGERS","GOAL_LIST_CATEGORY_EATING","GOAL_LIST_CATEGORY_DESTINATIONS","GOAL_LIST_CATEGORY_PERFORMING","GOAL_LIST_CATEGORY_TRANSPORTATION","GOAL_LIST_CATEGORY_RELAX","GOAL_LIST_CATEGORY_WILDCARDS"],MASTER_SUB_GOAL_KEYS=[["GOAL_LIST_WORK_SCHOOL_1","GOAL_LIST_WORK_SCHOOL_2","GOAL_LIST_WORK_SCHOOL_3","GOAL_LIST_WORK_SCHOOL_4","GOAL_LIST_WORK_SCHOOL_5","GOAL_LIST_WORK_SCHOOL_6","GOAL_LIST_WORK_SCHOOL_7","GOAL_LIST_WORK_SCHOOL_8","GOAL_LIST_WORK_SCHOOL_9","GOAL_LIST_WORK_SCHOOL_10","GOAL_LIST_WORK_SCHOOL_11","GOAL_LIST_WORK_SCHOOL_12","GOAL_LIST_WORK_SCHOOL_13"],["GOAL_LIST_FRIENDS_FAMILY_1","GOAL_LIST_FRIENDS_FAMILY_2","GOAL_LIST_FRIENDS_FAMILY_3","GOAL_LIST_FRIENDS_FAMILY_4","GOAL_LIST_FRIENDS_FAMILY_5","GOAL_LIST_FRIENDS_FAMILY_6","GOAL_LIST_FRIENDS_FAMILY_7"],["GOAL_LIST_ROMANCE_1","GOAL_LIST_ROMANCE_2","GOAL_LIST_ROMANCE_3","GOAL_LIST_ROMANCE_4","GOAL_LIST_ROMANCE_5","GOAL_LIST_ROMANCE_6","GOAL_LIST_ROMANCE_7"],["GOAL_LIST_STRANGERS_1","GOAL_LIST_STRANGERS_2","GOAL_LIST_STRANGERS_3","GOAL_LIST_STRANGERS_4","GOAL_LIST_STRANGERS_5","GOAL_LIST_STRANGERS_6","GOAL_LIST_STRANGERS_7"],["GOAL_LIST_EATING_1","GOAL_LIST_EATING_2","GOAL_LIST_EATING_3","GOAL_LIST_EATING_4","GOAL_LIST_EATING_5"],["GOAL_LIST_DESTINATIONS_1","GOAL_LIST_DESTINATIONS_2","GOAL_LIST_DESTINATIONS_3","GOAL_LIST_DESTINATIONS_4","GOAL_LIST_DESTINATIONS_5","GOAL_LIST_DESTINATIONS_6","GOAL_LIST_DESTINATIONS_7","GOAL_LIST_DESTINATIONS_8","GOAL_LIST_DESTINATIONS_9","GOAL_LIST_DESTINATIONS_10","GOAL_LIST_DESTINATIONS_11","GOAL_LIST_DESTINATIONS_12","GOAL_LIST_DESTINATIONS_13","GOAL_LIST_DESTINATIONS_14","GOAL_LIST_DESTINATIONS_15","GOAL_LIST_DESTINATIONS_16","GOAL_LIST_DESTINATIONS_17","GOAL_LIST_DESTINATIONS_18","GOAL_LIST_DESTINATIONS_19","GOAL_LIST_DESTINATIONS_20","GOAL_LIST_DESTINATIONS_21","GOAL_LIST_DESTINATIONS_22","GOAL_LIST_DESTINATIONS_23","GOAL_LIST_DESTINATIONS_24","GOAL_LIST_DESTINATIONS_25","GOAL_LIST_DESTINATIONS_26"],["GOAL_LIST_PERFOMING_1","GOAL_LIST_PERFOMING_2","GOAL_LIST_PERFOMING_3","GOAL_LIST_PERFOMING_4","GOAL_LIST_PERFOMING_5","GOAL_LIST_PERFOMING_6","GOAL_LIST_PERFOMING_7","GOAL_LIST_PERFOMING_8","GOAL_LIST_PERFOMING_9","GOAL_LIST_PERFOMING_10","GOAL_LIST_PERFOMING_11"],["GOAL_LIST_TRANSPORTATION_1","GOAL_LIST_TRANSPORTATION_2","GOAL_LIST_TRANSPORTATION_3","GOAL_LIST_TRANSPORTATION_4","GOAL_LIST_TRANSPORTATION_5","GOAL_LIST_TRANSPORTATION_6","GOAL_LIST_TRANSPORTATION_7","GOAL_LIST_TRANSPORTATION_8","GOAL_LIST_TRANSPORTATION_9","GOAL_LIST_TRANSPORTATION_10"],["GOAL_LIST_RELAX_1","GOAL_LIST_RELAX_2","GOAL_LIST_RELAX_3","GOAL_LIST_RELAX_4","GOAL_LIST_RELAX_5","GOAL_LIST_RELAX_6","GOAL_LIST_RELAX_7","GOAL_LIST_RELAX_8","GOAL_LIST_RELAX_9","GOAL_LIST_RELAX_10","GOAL_LIST_RELAX_11","GOAL_LIST_RELAX_12","GOAL_LIST_RELAX_13","GOAL_LIST_RELAX_14","GOAL_LIST_RELAX_15","GOAL_LIST_RELAX_16","GOAL_LIST_RELAX_17"],["GOAL_LIST_WILDCARDS_1","GOAL_LIST_WILDCARDS_2","GOAL_LIST_WILDCARDS_3","GOAL_LIST_WILDCARDS_4","GOAL_LIST_WILDCARDS_5","GOAL_LIST_WILDCARDS_6","GOAL_LIST_WILDCARDS_7","GOAL_LIST_WILDCARDS_8","GOAL_LIST_WILDCARDS_9","GOAL_LIST_WILDCARDS_10","GOAL_LIST_WILDCARDS_11","GOAL_LIST_WILDCARDS_12","GOAL_LIST_WILDCARDS_13","GOAL_LIST_WILDCARDS_14","GOAL_LIST_WILDCARDS_15","GOAL_LIST_WILDCARDS_16","GOAL_LIST_WILDCARDS_17"]],MASTER_SUB_GOAL_LIST,masterSugGoalListLanguage;ctrl.controller("GoalsCtrl",["$scope","$rootScope","$sce","$controller","$state","$stateParams","$timeout","$location","$analytics","$translate","$ionicLoading","$ionicModal","$ionicPlatform","$ionicPopup","$ionicGesture","$ionicScrollDelegate","$ionicActionSheet","Environment","AccountService","GoalsService","GeneralService","SkillsService","HabitsService",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T,m,E,_,S){function I(){$(".dragContainer").addClass("hideRemove")}function O(t){e.colorPercentages=[0,1],e.allDifficultyColors=["#60d293","#5fe9c4","#5bdddf","#58caf6","#66edff","#ffe566","#ffbe66","#ff9b73","#ef7d7d","#ff6669"],e.difficultyColors=[e.allDifficultyColors[0],e.allDifficultyColors[0],"#c8c8c8"],e.difficultyValues=[10];for(var o=0;10>o;++o)e.difficultyValues[o]=createValue(o,o+1);var i;e.valueData?(i=e.valueData,++i.redraw,e.difficultyColors[1]=e.allDifficultyColors[e.valueData.valueIndex]):(i=e.valueData={},i.redraw=0),i.userInteracted=!1,i.value=t?t.difficulty:"?",i.valueIndex=t?t.difficulty-1:0,i.percentage=0}function A(t){if(u.hide(),e.viewData.submitting=!1,e.closeModifyGoalModal(),e.showingSelectGoal=!1,e.editingGoal)R(e.editingGoal);else if(t){e.goals=E.getAccountGoals();for(var o=0;o<e.goals.length;++o)if(e.goals[o].id==t){R(e.goals[o]);break}}}function D(){e.filteredSubGoalKeys=CATEGORY_ORDER,e.filteredSubGoals=MASTER_SUB_GOAL_LIST}function L(){u.hide(),e.viewData&&(e.viewData.submitting=!1),e.closeModifySubGoalModal(),R(e.currentGoal),e.setActiveTab("active")}function b(){u.hide(),e.viewData.submitting=!1;g.alert({template:l.instant("EXPERIMENTS_ADD_SUB_GOAL_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})}function G(){var t=e.achievingSubGoal.difficulty,o=e.getAchievedGoalDifficulty();if(GOAL_BRONZE_STAR_POINTS>o){if(o+t>=GOAL_BRONZE_STAR_POINTS)return"bronze"}else if(GOAL_SILVER_STAR_POINTS>o){if(o+t>=GOAL_SILVER_STAR_POINTS)return"silver"}else if(GOAL_GOLD_STAR_POINTS>o&&o+t>=GOAL_GOLD_STAR_POINTS)return"gold";return"none"}function R(t){if(e.goals=E.getAccountGoals(),e.goals.sort(function(e,t){return new Date(e.createdAt).getTime()-new Date(t.createdAt).getTime()}),t&&(e.currentGoal=E.getGoal(t.id)),!e.currentGoal){var o=localStorage.getItem("lastActiveGoalId");o&&(e.currentGoal=E.getGoal(+o)),e.currentGoal||(e.currentGoal=e.goals.length>0?e.goals[0]:void 0)}if(e.currentGoal&&localStorage.setItem("lastActiveGoalId",e.currentGoal.id),e.subGoals={},e.currentGoal){var i,n=E.getAccountSubGoals();if(n)for(var a in n)for(var r=n[a],s=0;s<r.length;++s){var c=r[s];i=e.subGoals[c.goalId],i||(e.subGoals[c.goalId]=[]),e.subGoals[c.goalId].push(c)}if(i=e.subGoals[e.currentGoal.id],e.activeSubGoals=[],e.completedSubGoals=[],i){for(var l=_.getDayString(new Date),u=0;u<i.length;++u){var d=i[u],p=_.getDayString(new Date(d.createdAt));(p==l||!E.achievedSubGoal(d)||E.achievedSubGoalToday(d))&&e.activeSubGoals.push(d),E.achievedSubGoal(d)&&e.completedSubGoals.push(d)}e.activeSubGoals.sort(function(t,o){var i=e.achievedSubGoal(t),n=e.achievedSubGoal(o);return i&&n?new Date(o.achievedRecordedAt).getTime()-new Date(t.achievedRecordedAt).getTime():i||n?i?1:-1:new Date(t.createdAt).getTime()-new Date(o.createdAt).getTime()}),e.completedSubGoals.sort(function(e,t){return new Date(t.achievedRecordedAt).getTime()-new Date(e.achievedRecordedAt).getTime()})}}}e.activeTab="active";var y;if(e.$on("$ionicView.afterEnter",function(){y=a.suggestedActivity,y&&(e.modifySubGoal(),r(function(){e.viewData.subGoal=y}))}),!MASTER_SUB_GOAL_LIST||masterSugGoalListLanguage!=moment.locale()){MASTER_SUB_GOAL_LIST=[];for(var N=0;N<MASTER_SUB_GOAL_KEYS.length;++N)!function(){var e=MASTER_SUB_GOAL_KEYS[N],t=[];MASTER_SUB_GOAL_LIST.push(t);for(var o=0;o<e.length;++o)l(e[o]).then(function(e){t.push(e)})}();masterSugGoalListLanguage=moment.locale()}e.getGoalsLevel=function(){return S.getSkillLevel("goals")},e.goToSkills=function(){window.openURL("/progress/mood?tab=skills")},e.getPageTitle=function(){if(e.currentGoal)for(var t=0;t<e.goals.length;++t)if(e.currentGoal==e.goals[t])return l.instant("GOAL")+" "+(t+1);return l.instant("NO_GOAL")},e.showHelp=function(){var o;o=m.isUMNUser()?[{text:'<i class="icon ion-ios-help-outline"></i> '+l.instant("WHAT_IS_GOALS")},{text:'<i class="icon ion-ios-play-outline"></i> '+l.instant("WATCH_MILO_IS_SCARED")},{text:'<i class="icon ion-ios-list-outline"></i> '+l.instant("VIEW_COMMON_QUESTIONS")}]:[{text:'<i class="icon ion-ios-help-outline"></i> '+l.instant("WHAT_IS_GOALS")},{text:'<i class="icon ion-ios-play-outline"></i> '+l.instant("WATCH_MILO_IS_SCARED")},{text:'<i class="icon ion-ios-list-outline"></i> '+l.instant("VIEW_COMMON_QUESTIONS")},{text:'<i class="icon ion-ios-people-outline"></i> '+l.instant("EXPLORE_THE_COMMUNITY")}],h.show({buttons:o,cancelText:l.instant("CANCEL"),cancel:function(){},buttonClicked:function(o){return 0===o?t.$broadcast("event:viewVideo",{video:m.GOALS_VIDEO}):1===o?m.viewVideo(m.GOALS_VIDEO):2==o?window.open("http://help.thinkpacifica.com/hc/en-us/sections/200750797-Goals","_blank","location=no"):3==o&&e.goToCommunity("goals"),!0}})},e.getAchievedSubGoals=function(){var t=0;if(e.completedSubGoals)for(var o=0;o<e.completedSubGoals.length;++o){var i=e.completedSubGoals[o];e.achievedSubGoal(i)&&++t}return t},e.getAchievedGoalDifficulty=function(){var t=0;if(e.completedSubGoals)for(var o=0;o<e.completedSubGoals.length;++o){var i=e.completedSubGoals[o];e.achievedSubGoal(i)&&(t+=i.difficulty)}return t},e.getAchievedGoalClass=function(){var t=e.getAchievedGoalDifficulty();return t>=GOAL_GOLD_STAR_POINTS?"gold":t>=GOAL_SILVER_STAR_POINTS?"silver":t>=GOAL_BRONZE_STAR_POINTS?"bronze":"none"},e.showingSelectGoal=!1,e.selectGoal=function(){I(),e.showingSelectGoal=!e.showingSelectGoal},e.closeSelectGoal=function(){e.showingSelectGoal=!1},e.setCurrentGoal=function(t){e.currentGoal=t,R(e.currentGoal),localStorage.setItem("lastActiveGoalId",e.currentGoal.id),e.showingSelectGoal=!1},e.getCurrentGoalTitle=function(){return e.currentGoal?e.currentGoal.title:l.instant("NO_LONG_TERM_GOAL")},r(I),e.elementDragged=function(e){I(),"dragleft"==e.type&&angular.element(e.target).removeClass("hideRemove")},e.$watch("valueData.valueIndex",function(){if(e.valueData){var t=e.valueData.valueIndex;e.lastValueIndex!=t&&(e.difficultyColors[1]=e.allDifficultyColors[t],++e.valueData.redraw)}}),e.setActiveTab=function(t){I(),e.closeSelectGoal(),t!=e.activeTab&&(e.activeTab=t,v.resize())},e.getPrintableDate=function(e){var t=new Date(e.achievedRecordedAtString);return _.getDateDisplay(t)+" "+l.instant("AT_DESCRIBING_TIME")+" "+_.getMinuteDisplay(t)},e.achievedSubGoal=function(e){return E.achievedSubGoal(e)},e.closeModifySubGoalModal=function(){e.modifySubGoalModal&&(closeModal(e.modifySubGoalModal),e.modifySubGoalModal.remove(),e.modifySubGoalModal=void 0)},e.modifySubGoal=function(t){event.preventDefault(),event.stopPropagation(),e.closeSelectGoal(),t?(e.editingSubGoal=t,e.selectSubGoalDifficulty=!0):(e.editingSubGoal=void 0,e.selectSubGoalDifficulty=!1),e.viewData={subGoal:t?t.title:"",error:!1,submitting:!1},e.difficulty=t?t.difficulty:1,O(t),D(),d.fromTemplateUrl("views/goals/goals.addSubGoal.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modifySubGoalModal=t,openModal(e.modifySubGoalModal)})},e.reAddSubGoal=function(t){event.preventDefault(),event.stopPropagation(),I(),e.closeSelectGoal();var o=g.confirm({template:'<div class="thisisatest">'+l.instant("READD_SUB_GOAL")+"</div>",cancelText:l.instant("CANCEL"),cancelType:"button-default",okText:l.instant("CREATE"),okType:"button-default"});o.then(function(e){e&&(u.show({template:l.instant("EXPERIMENTS_SETTING_EXPERIMENT")+"..."}),E.addSubGoal(t.goalId,t.title,_.getDayString(new Date),t.difficulty).success(function(){L()}).error(b),c.eventTrack("reAddSubGoal",{category:"goals"}))
})},e.closeModifyGoalModal=function(){e.modifyGoalModal&&(closeModal(e.modifyGoalModal),e.modifyGoalModal.remove(),e.modifyGoalModal=void 0)},e.getModifyGoalHeader=function(){return l.instant(e.editingGoal?"EXPERIMENTS_EDIT_GOAL_HEADER":"EXPERIMENTS_ADD_GOAL_HEADER")},e.clearGoal=function(){e.viewData.goal=""},e.setGoalText=function(t){e.viewData.goal=l.instant(t)},e.archiveGoal=function(){if(event.preventDefault(),event.stopPropagation(),!T.isOnline())return void g.alert({template:l.instant("EXPERIMENTS_ARCHIVE_OFFLINE_PROMPT"),okText:l.instant("OK_GOT_IT"),okType:"button-default"});if(1==e.goals.length)return void g.alert({template:l.instant("EXPERIMENTS_ARCHIVE_LAST_GOAL_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"});c.eventTrack("archiveGoalPopup",{category:"goals"});var t=g.confirm({template:'<div class="thisisatest">'+l.instant("EXPERIMENTS_REMOVE_GOAL_PROMPT")+"</div>",cancelText:l.instant("CANCEL"),cancelType:"button-default",okText:l.instant("REMOVE"),okType:"button-default"});t.then(function(o){o?(E.archiveGoal(e.currentGoal.id).success(function(){t.close(),e.currentGoal=void 0,R()}),c.eventTrack("archiveGoalConfirm",{category:"goals"})):c.eventTrack("archiveGoalCancel",{category:"goals"})})},e.saveGoal=function(){e.editingGoal?(E.updateGoal(e.currentGoal.id,e.viewData.goal,e.currentGoal.color).success(A),c.eventTrack("updateGoal",{category:"goals"})):(E.addGoal(e.viewData.goal,"green").success(A),c.eventTrack("addGoal",{category:"goals"}))},e.modifyGoal=function(t){event.preventDefault(),event.stopPropagation(),e.viewData={goal:t?t.title:"",error:!1,submitting:!1},e.editingGoal=t?t:void 0,d.fromTemplateUrl("views/goals/goals.addGoal.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modifyGoalModal=t,openModal(e.modifyGoalModal)}),e.showingSelectGoal=!1},D(),e.getFilteredSubGoalList=function(t){return e.filteredSubGoals[t]};var M={};e.showFilteredSubGoalList=function(t){return""!==e.viewData.subGoal||!!M[t]},e.showingFilteredSubGoalList=function(e){return!!M[e]},e.toggleFilteredSubGoalList=function(t){e.showFilteredSubGoalList(t)?delete M[t]:M[t]=!0,v.resize()},e.updateSubGoalList=function(){e.selectSubGoalDifficulty=!1,e.filteredSubGoalKeys=[],e.filteredSubGoals=[];for(var t=new RegExp(".*"+e.viewData.subGoal.replace(/\s/g,".*")+".*","i"),o=0;o<CATEGORY_ORDER.length;++o){var i=CATEGORY_ORDER[o],n=!1;t.test(i)&&(n=!0);for(var a,r=MASTER_SUB_GOAL_LIST[o],s=!1,c=0;c<r.length;++c){var l=r[c];(n||t.test(l))&&(s||(a=[],e.filteredSubGoals.push(a),e.filteredSubGoalKeys.push(i),s=!0),a.push(l))}}v.resize()},e.selectSubGoal=function(t){e.viewData.subGoal=t,e.selectSubGoalDifficulty=!0,v.resize(),window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&r(function(){$("textarea").blur(),window.Keyboard.close()},405),c.eventTrack("selectSubGoal",{category:"goals",label:t})},e.clearSubGoal=function(){e.viewData.subGoal="",e.selectSubGoalDifficulty=!1,O(e.editingSubGoal),e.updateSubGoalList(),c.eventTrack("clearSubGoal",{category:"goals"})},e.setSubGoal=function(){return""===e.viewData.subGoal?void(e.viewData.error=!0):(e.viewData.error=!1,e.selectSubGoalDifficulty=!0,v.resize(),window.ionic&&window.ionic.keyboard&&window.ionic.keyboard.hide(),window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&r(function(){$("textarea").blur(),window.Keyboard.close()},405),void c.eventTrack("setSubGoal",{category:"goals",label:e.viewData.subGoal}))},e.getAchieveSubGoalMessage=function(){{var e;G()}return e="ACHIEVED_GOAL_MESSAGE",l.instant(e)},e.getAchieveSubGoalTitle=function(){var e,t=(G(),Math.floor(1*Math.random())+1);return e="ACHIEVED_GOAL_TITLE_"+t,o.trustAsHtml(l.instant(e))},e.getAchievedSubGoalClass=function(){return G()},e.closeAchieveSubGoalModal=function(){closeModal(e.achieveSubGoalModal),e.achieveSubGoalModal.remove(),e.achieveSubGoalModal=void 0},e.getSpinnerDifficulty=function(){return e.valueData?e.difficultyValues[e.valueData.valueIndex].valueInt:void 0},e.getOriginalDifficulty=function(){return e.achievingSubGoal.difficulty},e.achieveSubGoal=function(){E.achieveSubGoal(e.achievingSubGoal.id,e.difficultyValues[e.valueData.valueIndex].valueInt).success(function(){R(e.currentGoal),e.closeAchieveSubGoalModal()}).error(function(){g.alert({template:'<div class="thisisatest">'+l.instant("EXPERIMENTS_ACHIEVE_ERROR")+"</div>",okText:l.instant("OK_GOT_IT"),okType:"button-default"})})},e.showAchieveSubGoal=function(t){return e.closeSelectGoal(),e.achievedSubGoal(t)?void e.reAddSubGoal(t):(e.achievingSubGoal=t,O(),c.eventTrack("achieveSubGoalPopup",{category:"goals"}),d.fromTemplateUrl("views/goals/goals.achieveSubGoalModal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.achieveSubGoalModal=t,openModal(e.achieveSubGoalModal)}),void I())},e.archiveSubGoal=function(t){if(event.preventDefault(),event.stopPropagation(),e.closeSelectGoal(),T.isOnline()){c.eventTrack("archiveSubGoalPopup",{category:"goals"});var o=g.confirm({template:'<div class="thisisatest">'+l.instant("EXPERIMENTS_REMOVE_SUB_GOAL_PROMPT")+"</div>",cancelText:l.instant("CANCEL"),cancelType:"button-default",okText:l.instant("REMOVE"),okType:"button-default"});o.then(function(i){i?(E.archiveSubGoal(t.day,t.id).success(function(){o.close(),R(e.currentGoal)}),c.eventTrack("archiveSubGoalConfirm",{category:"goals"})):c.eventTrack("archiveSubGoalCancel",{category:"goals"})})}else{g.alert({template:l.instant("EXPERIMENTS_ARCHIVE_OFFLINE_PROMPT"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})}},e.saveSubGoal=function(){if("?"==e.valueData.value)return void(e.noDataError=!0);if(e.noDataError=!1,u.show({template:l.instant("EXPERIMENTS_SETTING_EXPERIMENT")+"..."}),e.editingSubGoal){var t=new Date(e.editingSubGoal.createdAt);E.updateSubGoal(e.editingSubGoal.id,e.editingSubGoal.goalId,e.viewData.subGoal,_.getDayString(t),e.difficultyValues[e.valueData.valueIndex].valueInt).success(L).error(b),c.eventTrack("updateSubGoal",{category:"goals"})}else E.addSubGoal(e.currentGoal.id,e.viewData.subGoal,_.getDayString(new Date),e.difficultyValues[e.valueData.valueIndex].valueInt).success(L).error(b),c.eventTrack("addSubGoal",{category:"goals"})},R()}]),ctrl.controller("GoalsHelpCtrl",["$scope","$rootScope","$state","$http","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r,s){a("HelpCtrl",{$scope:e}),e.confirm=function(){s.setUserPreference("completed_goals_intro","true"),r.currentView(r.backView()),o.go("app.goals",{},{location:"replace"})}}]);var ctrl=angular.module("groupsCtrl",[]);ctrl.controller("GroupsCtrl",["$rootScope","$scope","$sce","$state","$http","$timeout","$analytics","$translate","$ionicLoading","$ionicNavBarDelegate","$ionicPopup","$ionicModal","$ionicGesture","$ionicSideMenuDelegate","$ionicActionSheet","$ionicScrollDelegate","AccountService","HabitsService","GoalsService","AudioService","PayService","GroupsService","SkillsService","GeneralService","Environment","TokenService",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T,m,E,_,S,I,O,A){function D(){t.loadingGroups=!1,t.userGroups=void 0,t.communities=void 0,t.userLikes=0,t.userShares=0,t.pendingInvites=[]}function L(){S.setLastActiveTab(t.activeTab)}function b(e){for(var o=0;o<t.userGroups.length;++o){var i=t.userGroups[o];if(e==i.id){t.userGroups.splice(o,1);break}}}function G(){y=void 0;var e=t.searchQuery.query;e&&e.trim(),""!==e?(t.hasSearchEntry=!0,t.isSearching=!0,S.searchForGroup(e).success(function(e){t.searchableGroups=e,t.isSearching=!1}).error(function(){t.clearGroupSearch(),t.hasSearchEntry=!1,t.isSearching=!1;u.alert({template:s.instant("GROUP_SEARCH_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})})):(t.isSearching=!1,t.hasSearchEntry=!1)}function R(){h.isLoggedIn()&&A.isOnline()&&(t.showGroups()?t.activateGroups(!0):t.activateCommunities(!0))}t.searchQuery={query:""},t.$on("$ionicView.afterEnter",function(){var o=h.getUserPreference("completed_social_intro");if(o&&"true"==o){if("app.groups"==i.current.name){var n=h.getUserPreference("viewed_groups_popup");n&&"false"!=n||(t.showBrowseIfEmpty=!0)}else if("app.communities"==i.current.name){var r=h.getUserPreference("viewed_communities_popup");if(!r||"false"==r){var s=h.getAccountUser().user.publicName;(!s||(s=""))&&a(function(){t.showUpdateNickname()})}}}else{e.$broadcast("event:viewVideo",{video:h.COMMUNITY_VIDEO}),h.setUserPreference("completed_social_intro",!0);var c=t.$on("event:introVideoModalClosed",function(){"app.communities"==i.current.name?(t.showUpdateNickname(),c&&c()):"app.groups"==i.current.name&&(t.userGroups&&0===t.userGroups.length&&t.browseCuratedGroups(),c&&c())})}}),"app.communities"==i.current.name?t.activeTab="communities":(t.activeTab="groups",S.clearAllGroupNotifications()),t.getSocialLevel=function(){return I.getSkillLevel("social")},t.goToSkills=function(){window.openURL("/progress/mood?tab=skills")},t.showHelp=function(){f.show({buttons:[{text:'<i class="icon ion-ios-help-outline"></i> '+s.instant("WHAT_IS_COMMUNITY")},{text:'<i class="icon ion-ios-play-outline"></i> '+s.instant("WATCH_MILO_IS_LOST")},{text:'<i class="icon ion-ios-list-outline"></i> '+s.instant("VIEW_COMMON_QUESTIONS")},{text:'<i class="icon ion-ios-people-outline"></i> '+s.instant("VIEW_RULES")}],cancelText:s.instant("CANCEL"),cancel:function(){},buttonClicked:function(t){return 0===t?e.$broadcast("event:viewVideo",{video:h.COMMUNITY_VIDEO}):1===t?h.viewVideo(h.COMMUNITY_VIDEO):2==t?window.open("http://help.thinkpacifica.com/hc/en-us/sections/203653507-Groups-Communities","_blank","location=no"):3==t&&i.go("app.communities"==i.current.name?"app.communities-help":"app.groups-help"),!0}})},D(),t.getActiveTabTitle=function(){return s.instant("communities"==t.activeTab?"COMMUNITIES_TITLE":"GROUPS_TITLE")},t.showGroups=function(){return"groups"==t.activeTab},t.showCommunities=function(){return"communities"==t.activeTab},t.hasGroupNotification=function(e){return S.hasGroupNotification(e)},t.getGroupNotificationCount=function(e){return S.getGroupNotificationCount(e)},t.hasAnyPostNotification=function(){return S.hasPostNotification()},t.getPostNotificationCount=function(){return S.getPostNotificationCount()},t.getGroupAvatar=function(e){var t=h.getAvatarCharacter(e.creatorAvatar,e.creatorId);return"avatar_"+t},t.openSideMenu=function(){g.toggleLeft()},t.$on("$destroy",function(){document.removeEventListener("resume",R,!1),window.activateCommunities=void 0,window.activateGroups=void 0}),document.addEventListener("resume",R,!1),t.goToProfile=function(){S.clearAllPostNotifications(),i.go("app.community-profile")},t.checkOfflineMode=function(){if(!A.isOnline()){{u.alert({template:s.instant("GROUPS_OFFLINE_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}return!0}return!1},t.hasUserNickname=function(){return t.getUserNickname()&&t.getUserNickname().length>0},t.getUserNickname=function(){var e=h.getAccountUser();return e&&e.user?e.user.publicName:void 0},t.getUserAvatar=function(){var e=h.getAvatarCharacter(h.getAccountUser().user.avatar,h.getAccountUser().user.id);return"avatar_"+e},t.getUserLikes=function(){return t.userLikes+""},t.getUserShares=function(){return t.userShares+""},t.loadGroups=function(e){t.userGroups||(t.loadingGroups=!0),S.findUserGroups(e).success(function(e){t.userGroups=e.userGroups,t.pendingInvites=e.pendingInvites,!t.showBrowseIfEmpty||t.userGroups&&0!==t.userGroups.length||(t.browseCuratedGroups(),t.showBrowseIfEmpty=!1),t.loadingGroups=!1}).error(function(){u.alert({template:s.instant("LOADING_GROUPS_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});t.loadingGroups=!1})},t.loadCommunities=function(){t.communities||(t.loadingCommunities=!0),S.findPublicGroups().success(function(e){t.communities=e.publicGroups,t.userLikes=e.userLikes,t.userShares=e.userShares,t.loadingCommunities=!1}).error(function(){u.alert({template:s.instant("LOADING_COMMUNITIES_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});t.loadingCommunities=!1})},t.activateGroups=function(e){t.checkOfflineMode()||(r.eventTrack("activateGroups",{category:"group"}),t.activeTab="groups",e||L(),t.loadGroups(),a(function(){$("#groupTitle").addClass("active"),$("#communitiesTitle").removeClass("active")}))},t.activateCommunities=function(e){t.checkOfflineMode()||(r.eventTrack("activateCommunities",{category:"group"}),t.activeTab="communities",e||L(),t.loadCommunities(),a(function(){$("#communitiesTitle").addClass("active"),$("#groupTitle").removeClass("active")}))},t.isOwner=function(e){return e&&e.creatorId==h.getAccountUser().user.id},t.isOwnerById=function(e){var t=S.getGroupImmediate(e);return t.creatorId==h.getAccountUser().user.id},t.getCommunityName=function(e){var t=e.name,o=("COMMUNITY_"+t).replace(/ /g,"_").toUpperCase(),i=s.instant(o);return i==o?t:i},t.getCommunityDescription=function(e){var t=e.name,o=("COMMUNITY_"+t+"_DESCRIPTION").replace(/ /g,"_").toUpperCase(),i=s.instant(o);return i==o?e.description:i},t.archiveGroup=function(e,o){if(e.stopPropagation(),e.preventDefault(),!t.checkOfflineMode()){r.eventTrack("archiveGroupPopup",{category:"group"});var i=u.confirm({template:"<div>"+s.instant("ARCHIVE_GROUP_PROMPT")+"</div>",cancelText:s.instant("CANCEL"),cancelType:"button-default",okText:s.instant("REMOVE"),okType:"button-default"});i.then(function(e){e?o.curated||o.creatorId!=h.getAccountUser().user.id?S.leaveGroup(o.id).success(function(){b(o.id)}).error(function(){u.alert({template:s.instant("ARCHIVE_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}):(S.archiveGroup(o.id).success(function(){b(o.id)}).error(function(){u.alert({template:s.instant("ARCHIVE_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}),r.eventTrack("archiveGroupConfirm",{category:"groups"})):r.eventTrack("archiveGroupCancel",{category:"groups"})})}},initEditFunctionality(t,a,s,d,u,S,h),initCreateGroupFunctionality(t,a,s,u,d,c,f,S,h,_,m),initValidateEmailFunctionality(t,h,d,u,s),initEditNicknameFunctionality(t,h,u,d,s),t.closeJoinGroupModal=function(){closeModal(t.joinModal),t.joinModal.remove(),t.joinModal=void 0,t.groupCodeError=void 0},t.clearGroupSearch=function(){t.searchQuery.query="",t.hasSearchEntry=!1},t.joinGroup=function(){var e;if(t.showGroupCode&&(e=$("#groupCode").val(),!e||0===e.length))return void(t.groupCodeError=s.instant("GROUP_CODE_PLACEHOLDER"));t.groupCodeError=void 0;var o=$("#groupNickname").val().trim();return o&&0!==o.length?(t.joiningGroup=!0,void(t.showGroupCode||t.joinGroupCode?(e||(e=t.joinGroupCode),S.joinGroup(e,o).success(function(){t.loadGroups(!0),t.closeJoinGroupModal(),t.joiningGroup=!1,t.clearGroupSearch()}).error(function(e,o){if(404==o)t.groupCodeError=s.instant("GROUP_CODE_NOT_FOUND");else{u.alert({template:s.instant("JOIN_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})}t.joiningGroup=!1})):S.acceptInvite(t.joinGroupId,o).success(function(){t.loadGroups(!0),t.closeJoinGroupModal(),t.joiningGroup=!1}).error(function(){u.alert({template:s.instant("JOIN_GROUP_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"});t.joiningGroup=!1}))):void(t.groupError=s.instant("GROUP_NICKNAME"))},t.showJoinGroup=function(e,o){t.groupError=void 0,t.showGroupCode=!1,t.joinGroupId=e,t.joinGroupCode=o,t.joinGroupNickname=h.getAccountUser().user.publicName,d.fromTemplateUrl("views/groups/groups.joinGroup.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.joinModal=e,openModal(t.joinModal)})},t.showJoinGroupByCode=function(){t.groupError=void 0,t.showGroupCode=!0,t.joinGroupId=void 0,t.joinGroupCode=void 0,d.fromTemplateUrl("views/groups/groups.joinGroup.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.joinModal=e,openModal(t.joinModal)})},t.getGroupDescription=function(e){var t=e.description;return t&&t.length>140&&(t=t.substring(0,140)+"..."),t},t.joinCuratedGroup=function(e,o){t.showJoinGroup(e,o),t.closeBrowseGroupsModal()},t.closeBrowseGroupsModal=function(){closeModal(t.browseGroupsModal),t.browseGroupsModal.remove(),t.browseGroupsModal=void 0},t.browseCuratedGroups=function(){h.setUserPreference("viewed_groups_popup",!0),t.displayingCategories={},t.loadingCuratedGroups=!0,d.fromTemplateUrl("views/groups/groups.browseGroups.modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.browseGroupsModal=e,openModal(t.browseGroupsModal),S.findCuratedGroups().success(function(e){S.initializeCuratedGroups(t,e),t.loadingCuratedGroups=!1}).error(function(e){t.loadingCuratedGroups=!1})})},t.displayingCategories={},t.isDisplayingCategory=function(e){return!!t.displayingCategories[e]},t.toggleCategoryDisplay=function(e){t.isDisplayingCategory(e)?delete t.displayingCategories[e]:t.displayingCategories[e]=!0,v.resize()},t.hasSearchEntry=!1,t.isSearching=!1,t.searchableGroups=void 0;var y;t.searchGroups=function(){y&&a.cancel(y),y=a(G,1e3)},t.deleteInvite=function(e){var o=u.confirm({template:"<div>"+s.instant("DELETE_INVITE_PROMPT")+"</div>",cancelText:s.instant("CANCEL"),cancelType:"button-default",okText:s.instant("DELETE"),okType:"button-default"});o.then(function(o){o&&S.deleteInvite(e).success(function(){for(var o=0;o<t.pendingInvites.length;++o){var i=t.pendingInvites[o];i.userGroup.id==e&&t.pendingInvites.splice(o,1)}}).error(function(){u.alert({template:s.instant("DELETE_INVITE_ERROR"),okText:s.instant("OK_GOT_IT"),okType:"button-default"})})})},t.goToGroup=function(e){if(!t.checkOfflineMode()){var o=e.private?"date":"hotness";if(e.private){var n=h.getUserPreference("viewed_community_rules");n&&"true"==n?i.go("app.group-posts",{groupId:e.id,order:o}):i.go("app.groups-help",{intro:!0,groupId:e.id,order:o})}else{var a=h.getUserPreference("viewed_community_rules");a&&"true"==a?i.go("app.communities-posts",{groupId:e.id,order:o}):i.go("app.communities-help",{intro:!0,groupId:e.id,order:o})}}},t.$on("$ionicView.enter",function(){R()}),t.$on("$ionicView.afterLeave",function(){D()})}]),ctrl.controller("AbstractGroupPostsCtrl",["$scope","$rootScope","$state","$stateParams","$sce","$http","$timeout","$analytics","$translate","$ionicLoading","$ionicPopup","$ionicModal","$ionicGesture","$ionicScrollDelegate","$ionicActionSheet","AccountService","HabitsService","GoalsService","AudioService","PayService","GroupsService","GeneralService","Environment","TokenService",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T,m,E,_,S,I){function O(e){return e.lastIndexOf(".")==e.length-1?e+"..":e+"..."}function A(t){var o=e.groupPostData.postText.trim();o&&0!==o.length&&o!=c.instant("DEFAULT_MOOD_SHARE_TEXT")&&o!=c.instant("DEFAULT_THOUGHT_SHARE_TEXT")&&o!=c.instant("DEFAULT_EXPERIMENT_SHARE_TEXT")||(e.groupPostData.postText=t)}function D(t){var o=e.groupPostData.postText.trim();o==t&&(e.groupPostData.postText="")}function L(e,t,o){return e.recordings&&e.recordings[t]?e.recordings[t][o]:void 0}function b(){u.alert({template:c.instant("MISSING_EXPERIMENT_DATA_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}e.showingMenu=void 0,e.showingMore={};var G=140;e.userVotes={},e.userCommentVotes={},e.sharingData={},e.groupPostData={postText:""},e.communityPostData={postText:""},e.reportPostData={postText:""},initValidateEmailFunctionality(e,v,d,u,c),e.isOwnerById=function(e){var t=_.getGroupImmediate(e);return t.creatorId==v.getAccountUser().user.id},e.isOwner=function(e){return e&&e.creatorId==v.getAccountUser().user.id},e.isGroupOwner=function(e){return e.creatorId==v.getAccountUser().user.id},e.hasUserNickname=function(){return e.getUserNickname()&&e.getUserNickname().length>0},e.getUserNickname=function(){return v.getAccountUser().user.publicName},e.hasPostNotification=function(e){return _.hasPostNotification(e)},e.hasGroupNotification=function(e){return _.hasGroupNotification(e)},e.getGroupNotificationCount=function(e){return _.getGroupNotificationCount(e)},e.checkOfflineMode=function(){if(!I.isOnline()){{u.alert({template:c.instant("GROUPS_OFFLINE_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}return!0}return!1},e.getPostCreatorNickname=function(e){return e?e.creatorNickname?e.creatorNickname:"["+c.instant("DELETED")+"]":void 0},e.getPostAvatar=function(e){return e?"avatar_"+v.getAvatarCharacter(e.creatorAvatar,e.creatorId):""},e.getPostDate=function(e){if(e){if(e.momentDate)return e.momentDate;var t="object"==typeof e.createdAt?e.createdAt:new Date(e.createdAt);return e.momentDate=moment(t).calendar(),e.momentDate}};var R={formatHref:function(e){return e},target:function(){return null},linkAttributes:{onClick:"event.stopPropagation(); event.preventDefault(); window.open(event.target.href, '_blank', 'location=no');"},events:{click:function(e){e.preventDefault(),e.stopPropagation()}}};e.getPostTitle=function(t,o){var i=t.title,a=!1;if(e.group&&(a=e.group.private),e.showingMore[t.id]||a||!e.canShowMore(t)||o)return t.linkifiedTitle||(t.linkifiedTitle=linkifyStr(i,R)),n.trustAsHtml(t.linkifiedTitle);if(t.truncatedTitle)return n.trustAsHtml(t.truncatedTitle);var r=i.substring(G),s=r.indexOf(" ");return t.truncatedTitle=s>=0?linkifyStr(O(i.substring(0,G+s)),R):linkifyStr(O(i.substring(0,G)),R),n.trustAsHtml(t.truncatedTitle)},e.canShowMore=function(t){var o=t.title,i="undefined"==typeof e.showingMore[t.id]&&o.length>G;return i},e.showMore=function(t){if(e.group&&e.group.private)e.canShowMore(t)?(e.showingMore[t.id]=t.id,g.resize()):(delete e.showingMore[t.id],g.resize());else{var i;"undefined"==typeof t.groupPostId?(_.storeCachedPost(t,e.postDataObjects?e.postDataObjects[t.id]:void 0,e.userVotes),i=t.id):i=t.groupPostId;var n={postId:i,order:"date"};o.$current.name.indexOf("app.groups")>=0?o.go("app.groups-post-comments",n):o.go("app.communities-post-comments",n)}},e.hasVote=function(t){if(!t)return!1;if("comments"==e.activeTab)return e.hasCommentVote(t);var o=e.userVotes[t.id];return o&&o.up||t.creatorId==v.getAccountUser().user.id},e.removeVote=function(t,o){if(t.stopPropagation(),t.preventDefault(),"comments"==e.activeTab)e.removeCommentVote(t,o);else{if(e.isPostOwner(o)){{u.alert({template:c.instant("REMOVE_OWNED_POST_VOTE_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}return}delete e.userVotes[o.id],--o.ups,--o.score,_.removeVote(o)}},e.addUserVotes=function(t){for(var o=0;o<t.length;++o){var i=t[o];e.userVotes[i.postId]=i}},e.createVoteObject=function(t){e.userVotes[t.id]={postId:t.id,groupId:e.group?e.group.id:t.groupId,up:!0,recordedAt:new Date}},e.voteUp=function(t,o){t.stopPropagation(),t.preventDefault(),"comments"==e.activeTab?e.voteCommentUp(t,o):(++o.ups,++o.score,e.createVoteObject(o),_.voteUp(o.id,e.group?e.group.id:o.groupId))},e.addUserCommentVotes=function(t){for(var o=0;o<t.length;++o){var i=t[o];e.userCommentVotes[i.postCommentId]=i}},e.createCommentVoteObject=function(t){e.userCommentVotes[t.id]={postId:t.id,groupId:e.group?e.group.id:t.groupId,up:!0,recordedAt:new Date}},e.hasCommentVote=function(t){var o=e.userCommentVotes[t.id];return o&&o.up||t.creatorId==v.getAccountUser().user.id},e.voteCommentUp=function(t,o){t.stopPropagation(),t.preventDefault(),++o.ups,++o.score,e.createCommentVoteObject(o),_.voteCommentUp(o.id,o.groupPostId,o.groupId)},e.removeCommentVote=function(t,o){if(t.stopPropagation(),t.preventDefault(),e.isPostOwner(o)){u.alert({template:c.instant("REMOVE_OWNED_POST_VOTE_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}else delete e.userCommentVotes[o.id],--o.ups,--o.score,_.removeCommentVote(o)},initCreateGroupFunctionality(e,r,c,u,d,l,f,_,v,E,T),initInviteFunctionality(e,c,d,u,f,v,_,S),e.viewUserProfile=function(e,t){e.stopPropagation(),e.preventDefault(),t.creatorNickname&&o.go("app.community-profile",{userId:t.creatorId,nickname:t.creatorNickname})},e.showInvitePopup=function(t,o,i){t&&(t.stopPropagation(),t.preventDefault());{if(!v.getAccountUser().user.banned)return e.isUserEmailValidated()?((o||i)&&(e.invitingUserId=o?o.creatorId:i.id,e.invitingUserNickname=o?o.creatorNickname:i.publicName),v.getAccountUser().user.publicName?void f.show({buttons:[{text:c.instant("CREATE_GROUP")},{text:c.instant("SELECT_EXISTING_GROUP")}],titleText:c.instant("INVITE_TO_CHAT"),cancelText:c.instant("CANCEL"),cancel:function(){},buttonClicked:function(t){return 0===t?e.showCreateGroup(v.getAccountUser().user.publicName+" & "+e.invitingUserNickname):1==t&&e.showSelectGroupForInvite(),!0}}):(e.attemptingInvite=!0,void e.showUpdateNickname())):void e.checkRemoteEmailValidation(function(n){n&&e.showInvitePopup(t,o,i)});{u.alert({template:c.instant("BANNED_USER_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}}},e.closeReportModal=function(){closeModal(e.reportModal),e.reportModal.remove(),e.reportModal=void 0},e.reportPost=function(){var t=e.reportPostData.postText.trim();if(!t||0===t.length)return void(e.reportError=c.instant("REPORT_POST_TEXT_ERROR"));var o=e.referUserData.referUser;e.reportError=void 0,_.reportPost(e.reportingPostId,t,o?!0:!1).success(function(){e.closeReportModal(),e.removePostById&&e.removePostById(e.reportingPostId);u.alert({template:c.instant("REPORT_POST_CONFIRM"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){u.alert({template:c.instant("REPORT_POST_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})})},e.showReportPost=function(t,o){if(t.stopPropagation(),t.preventDefault(),e.reportingComment=!1,v.getAccountUser().user.banned){u.alert({template:c.instant("BANNED_USER_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}else{if(!e.isUserEmailValidated())return void e.checkRemoteEmailValidation(function(i){i&&e.showReportPost(t,o)});e.reportingPostId=o.id,e.reportPostData.postText="",e.referUserData={referUser:!1},d.fromTemplateUrl("views/groups/groups.report.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.reportModal=t,openModal(e.reportModal)})}},e.closeSubGoalModal=function(){closeModal(e.goalModal),e.goalModal.remove(),e.goalModal=void 0},e.clearSubGoal=function(){e.viewData.subGoal=""},e.updateGoalOption=function(){e.goalForSubGoal=e.goalOptions.goals[e.goalOptions.goalOptionOrdinal],e.valueData&&e.valueData.redraw&&++e.valueData.redraw},e.getGoalOptionDisplay=function(e){return e.title},e.saveSubGoal=function(){return"?"==e.valueData.value?void(e.noDataError=!0):(e.noDataError=!1,l.show({template:c.instant("EXPERIMENTS_SETTING_EXPERIMENT")+"..."}),T.addSubGoal(e.goalForSubGoal.id,e.viewData.subGoal,S.getDayString(new Date),e.difficultyValues[e.valueData.valueIndex].valueInt).success(function(){e.closeSubGoalModal(),l.hide()}).error(function(){e.closeSubGoalModal(),l.hide()}),void s.eventTrack("addSubGoal",{category:"groups"}))},e.allDifficultyColors=["#60d293","#5fe9c4","#5bdddf","#58caf6","#66edff","#ffe566","#ffbe66","#ff9b73","#ef7d7d","#ff6669"],e.$watch("valueData.valueIndex",function(){if(e.valueData){var t=e.valueData.valueIndex;e.lastValueIndex!=t&&(e.difficultyColors[1]=e.allDifficultyColors[t])}}),e.addExperiment=function(t,o){t.stopPropagation(),t.preventDefault();var i=e.getExperiment(o);e.goalOptions={goals:T.getAccountGoals(),goalOptionOrdinal:0},e.updateGoalOption(),e.viewData={subGoal:i.title,error:!1,submitting:!1},e.colorPercentages=[0,1],e.difficultyColors=["#c8c8c8",S.getColor("green"),"#c8c8c8"],e.difficultyValues=[10];for(var n=0;10>n;++n)e.difficultyValues[n]=createValue(n,n+1);e.valueData={value:"?",valueIndex:0,percentage:0,redraw:0},e.getSpinnerDifficulty=function(){return e.valueData?e.difficultyValues[e.valueData.valueIndex].valueInt:void 0},d.fromTemplateUrl("views/goals/goals.addCommunitySubGoal.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.goalModal=t,openModal(e.goalModal)})},e.showAddExperiment=function(t){if(e.isPostOwner(t))return!1;var o=e.getExperiment(t);return o&&o.title},e.sharePost=function(e,t){s.eventTrack("sharePostClick",{category:"communities"}),e.preventDefault(),e.stopPropagation();var o;o=I.isDevelopment()?"http://dev.thinkpacifica.com/community/post/":"http://www.thinkpacifica.com/community/post/",o+=t.id,window.plugins.socialsharing.share(c.instant("SHARE_POST_TEXT")+' "'+t.title+'"',null,null,o)},e.deletePost=function(t,o){t.preventDefault(),t.stopPropagation();var i=u.confirm({template:"<div>"+c.instant("ARCHIVE_POST_PROMPT")+"</div>",cancelText:c.instant("CANCEL"),cancelType:"button-default",okText:c.instant("REMOVE"),okType:"button-default"});i.then(function(t){t&&_.archivePost(o.id).success(function(){e.removePost(o)}).error(function(){u.alert({template:c.instant("ARCHIVE_POST_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})})})},e.isPostOwner=function(e){return e&&e.creatorId==v.getAccountUser().user.id},e.showMenu=function(t){return e.showingMenu==t.id},e.toggleMenu=function(t,o){t.stopPropagation(),t.preventDefault(),e.showingMenu=e.showingMenu==o.id?void 0:o.id},e.closeShareMoodModal=function(){closeModal(e.moodModal),e.moodModal.remove(),e.moodModal=void 0},e.hasSharingData=function(t){return e.sharingData[t]},e.shareWeeksMood=function(){var t=h.getAllMoodHabitData(),o=[],i=new Date((new Date).getTime()-5184e5);if(i.setHours(0,0,0,0),t&&t.length>0)for(var n=0;n<t.length;++n){var a=t[n],r=new Date(a.experiencedAtStr);r>i&&o.push(a)}if(0===o.length){u.alert({template:c.instant("MISSING_MOOD_DATA_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}else e.sharingData={},o.sort(function(e,t){return new Date(e.experiencedAtStr)-new Date(t.experiencedAtStr)}),e.sharingData.Mood={moodEntries:o,startDate:i.toString(),numberOfDays:7},e.closeShareMoodModal(),A(c.instant("DEFAULT_MOOD_SHARE_TEXT"))},e.showMoodShare=function(){e.sharingData.Mood?(e.sharingData={},D(c.instant("DEFAULT_MOOD_SHARE_TEXT"))):d.fromTemplateUrl("views/groups/groups.mood.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.moodModal=t,openModal(e.moodModal)})},e.getRecordingSource=function(e,t){return L(e,t,"url")},e.getRecordingDuration=function(e,t){return L(e,t,"duration")},e.getRecordingTags=function(e,t){return L(e,t,"tags")},e.isThoughtExpired=function(t){var o=e.getThought(t);if(o&&o.expiresAtStr){var i=new Date(o.expiresAtStr);return i<new Date}return!1},e.isAudioJournal=function(t){var o=e.getThought(t);return o&&"AUDIO_JOURNAL"==o.thoughtType},e.isAudioThought=function(t){var o=e.getThought(t);return o&&(!o.thoughtType||"AUDIO_DISTORTIONS"==o.thoughtType)},e.isTextThought=function(t){var o=e.getThought(t);return o&&"TEXT_DISTORTIONS"==o.thoughtType},e.isTextJournal=function(t){var o=e.getThought(t);return o&&"TEXT_JOURNAL"==o.thoughtType},e.getTextThoughtDisplay=function(t){var o=e.getThought(t);if(o&&"TEXT_DISTORTIONS"==o.thoughtType){var i=o.recordings.analysis,n=i?i.notes:"";return n.length>250&&(n=n.substring(0,250)+"..."),n}},e.getTextJournalDisplay=function(t){var o=e.getThought(t);if(o&&"TEXT_JOURNAL"==o.thoughtType){var i=o.recordings.journal,n=i?i.notes:"";return n.length>250&&(n=n.substring(0,250)+"..."),n}},e.closeTextThoughtModal=function(){closeModal(e.textThoughtModal),e.textThoughtModal.remove(),e.textThoughtModal=void 0},e.showTextThought=function(t){var o=e.getThought(t);!o||"TEXT_DISTORTIONS"!=o.thoughtType&&"TEXT_JOURNAL"!=o.thoughtType||(m.setTextThoughtForReview(o),"TEXT_DISTORTIONS"==o.thoughtType?d.fromTemplateUrl("views/thoughts/thoughts.text.review.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.textThoughtModal=t,openModal(e.textThoughtModal)}):d.fromTemplateUrl("views/thoughts/thoughts.text.journalreview.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.textThoughtModal=t,openModal(e.textThoughtModal)}))},e.getThoughtDate=function(t){var o=e.getThought(t);return o?moment(new Date(o.createdAtString)).calendar():void 0},e.closeShareThoughtModal=function(){closeModal(e.thoughtModal),e.thoughtModal.remove(),e.thoughtModal=void 0},e.getThoughtItemDisplay=function(e){return e.title},e.updateSelectedThought=function(){e.selectedThought=e.thoughtOptions.thoughts[e.thoughtOptions.thoughtOrdinal]},e.getSelectedThought=function(){return e.selectedThought?e.selectedThought.title:void 0
},e.showingModal=function(){return e.moodModal||e.thoughtModal||e.experimentModal},e.shareThought=function(){e.sharingData={},e.sharingData.Thought=e.selectedThought,A(c.instant("DEFAULT_THOUGHT_SHARE_TEXT")),e.closeShareThoughtModal()},e.showThoughtShare=function(){if(e.sharingData.Thought)e.sharingData={},D(c.instant("DEFAULT_THOUGHT_SHARE_TEXT"));else{var t=m.getThoughts();if(t&&0!==t.length)t.sort(function(e,t){var o=new Date(e.createdAtString),i=new Date(t.createdAtString);return i-o}),e.selectedThought=t[0],e.thoughtOptions={thoughts:t,thoughtOrdinal:0},d.fromTemplateUrl("views/groups/groups.thought.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.thoughtModal=t,openModal(e.thoughtModal)});else{u.alert({template:c.instant("MISSING_THOUGHT_DATA_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})}}},e.closeShareExperimentModal=function(){closeModal(e.experimentModal),e.experimentModal.remove(),e.experimentModal=void 0},e.getExperimentItemDisplay=function(e){return e.title},e.updateSelectedExperiment=function(){e.selectedExperiment=e.experimentOptions.experiments[e.experimentOptions.experimentOrdinal]},e.getSelectedExperiment=function(){return e.selectedExperiment?e.selectedExperiment.title:void 0},e.shareExperiment=function(){e.group.private?(e.sharingData={},e.sharingData.Experiment=e.selectedExperiment,A(c.instant("DEFAULT_EXPERIMENT_SHARE_TEXT"))):e.createPostInternal(e.selectedExperiment.title,{Experiment:e.selectedExperiment}),e.closeShareExperimentModal()},e.showExperimentShare=function(){if(e.group.private&&e.sharingData.Experiment)e.sharingData={},D(c.instant("DEFAULT_EXPERIMENT_SHARE_TEXT"));else{var t=T.getAccountSubGoals();if(t){var o=[];for(var i in t)for(var n=t[i],a=0;a<n.length;++a){var r=n[a];r.achievedRecordedAt&&o.push(r)}if(0===o.length)return void b();o.sort(function(e,t){var o=new Date(e.achievedRecordedAtString),i=new Date(t.achievedRecordedAtString);return i-o}),e.selectedExperiment=o[0],e.experimentOptions={experiments:o,experimentOrdinal:0},d.fromTemplateUrl("views/groups/groups.experiment.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.experimentModal=t,openModal(e.experimentModal)})}else b()}},e.inputHasFocus=!1,e.inputFocused=function(){return e.isUserEmailValidated()?void 0:void e.checkRemoteEmailValidation(function(t){t&&(e.inputHasFocus=!0)})},e.inputBlurred=function(){e.inputHasFocus=!1},e.isInputFocused=function(){return e.inputHasFocus},e.inputChanged=function(){if(e.websocketSend){var t=e.hasPostText();t&&!e.typing?(e.typing=!0,e.websocketSend("typing")):!t&&e.typing&&(e.typing=!1,e.websocketSend("nottyping"))}},e.hasPostText=function(){var t=e.groupPostData.postText;return t?(t=t.trim(),t.length>0):!1}}]),ctrl.controller("GroupPostCommentsCtrl",["$scope","$rootScope","$sce","$controller","$state","$stateParams","$http","$timeout","$analytics","$translate","$ionicNavBarDelegate","$ionicLoading","$ionicPopup","$ionicModal","$ionicGesture","$ionicScrollDelegate","$ionicActionSheet","AccountService","HabitsService","GoalsService","AudioService","PayService","GroupsService","GeneralService","Environment","TokenService",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T,m,E,_,S,I){function O(){e.offset=0}function A(){e.loadingComments=!0,I.findGroupPostComments(e.postId,e.order,e.limit,e.offset).success(function(t){var o=t.postComments;e.loadingComments=!1;t.postComments;e.canLoadMore=o.length==e.limit,e.lastPostLoad=new Date,e.postComments.push.apply(e.postComments,o),e.addUserCommentVotes(t.userVotes),v.resize(),e.$broadcast("scroll.refreshComplete")}).error(function(){e.loadingComments=!1})}i("AbstractGroupPostsCtrl",{$scope:e}),e.postId=+a.postId,e.inputFocused=function(){e.hasUserNickname()?e.checkRemoteEmailValidation(function(t){t&&(e.inputHasFocus=!0)}):(e.showUpdateNickname(),$("#postText").blur(),e.inputHasFocus=!0)},e.post=I.getCachedPost(e.postId),e.post?(e.postData=I.getCachedPostData(e.post.id),e.userVotes=I.getCachedUserVotes()):I.getGroupPost(e.postId).success(function(t){t&&t.groupPostsContext&&t.groupPostsContext.groupPosts&&t.groupPostsContext.groupPosts.length>0&&(e.post=t.groupPostsContext.groupPosts[0],e.addUserVotes(t.userVotes))}).error(function(){p.alert({template:l.instant("LOADING_COMMENTS_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})}),e.order=a.order,e.order||(e.order="score"),e.limit=25,e.offset=0,e.canLoadMore=!0,initEditNicknameFunctionality(e,T,p,g,l),e.postComments=[],e.getGroupRemainingPostCharacters=function(){var t=e.groupPostData.postText;return t||(t=""),512-t.length},e.removePost=function(){e.goBack()},e.getCommentPostTitle=function(){return e.post?e.getPostTitle(e.post,!0):l.instant("LOADING")+"..."},e.showNew=function(){"date"!=e.order&&(e.order="date",O(),e.postComments.length=0,A())},e.showAllTime=function(){"score"!=e.order&&(e.order="score",O(),e.postComments.length=0,A())},e.getExperiment=function(){if(e.postData){if(e.postData.experiment)return e.postData.experiment;if("Experiment"==e.postData.type){var t=e.postData.data;if(t){var o=JSON.parse(t);return e.postData.experiment=o,o}e.postData.experiment={}}}return{}},e.postComment=function(o){if(o&&(o.preventDefault(),o.stopPropagation()),!e.checkOfflineMode()){if(T.getAccountUser().user.banned)return void p.alert({template:l.instant("BANNED_USER_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"});if(!e.hasUserNickname())return void e.showUpdateNickname();var i=e.groupPostData.postText.trim();if(0===i.length&&!hasSharingData)return void(e.groupError=l.instant("CREATE_POST_TEXT_ERROR"));$("#postText").blur(),e.postingComment=!0,e.postingCommentText=i,e.groupPostData.postText="",I.postComment(e.postId,e.post.groupId,i).success(function(o){e.postingComment=!1,e.postComments.splice(0,0,o),e.showNew(),e.createVoteObject(o),++e.post.comments,s(function(){t.$broadcast("event:createdMessage")},500)}).error(function(){e.groupPostData.postText=e.postingCommentText;p.alert({template:l.instant("POSTING_COMMENT_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"});e.postingComment=!1})}},e.removeComment=function(t){e.removeCommentById(t.id)},e.removeCommentById=function(t){for(var o=0;o<e.postComments.length;++o)if(e.postComments[o].id==t)return void e.postComments.splice(o,1)},e.deleteComment=function(t,o){t.preventDefault(),t.stopPropagation();var i=p.confirm({template:"<div>"+l.instant("ARCHIVE_COMMENT_PROMPT")+"</div>",cancelText:l.instant("CANCEL"),cancelType:"button-default",okText:l.instant("REMOVE"),okType:"button-default"});i.then(function(t){t&&I.archiveComment(o.id).success(function(){e.removeComment(o),--e.post.comments}).error(function(){p.alert({template:l.instant("ARCHIVE_COMMENT_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})})})},e.closeReportModal=function(){closeModal(e.reportModal),e.reportModal.remove(),e.reportModal=void 0},e.reportComment=function(){var t=e.reportPostData.postText.trim();if(!t||0===t.length)return void(e.reportError=l.instant("REPORT_POST_TEXT_ERROR"));var o=e.referUserData.referUser;e.reportError=void 0,I.reportComment(e.reportingCommentId,t,o?!0:!1).success(function(){e.closeReportModal(),e.removeCommentById(e.reportingCommentId),--e.post.comments;p.alert({template:l.instant("REPORT_POST_CONFIRM"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})}).error(function(){p.alert({template:l.instant("REPORT_POST_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})})},e.showReportComment=function(t,o){if(t.stopPropagation(),t.preventDefault(),e.reportingComment=!0,T.getAccountUser().user.banned){p.alert({template:l.instant("BANNED_USER_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})}else e.reportingCommentId=o.id,e.referUserData={referUser:!1},g.fromTemplateUrl("views/groups/groups.report.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.reportModal=t,openModal(e.reportModal)})},e.loadMorePostComments=function(){e.offset+=e.limit,A()},A()}]),ctrl.controller("GroupPostsCtrl",["$scope","$rootScope","$sce","$controller","$state","$stateParams","$http","$timeout","$analytics","$translate","$ionicNavBarDelegate","$ionicLoading","$ionicPopup","$ionicModal","$ionicGesture","$ionicScrollDelegate","$ionicActionSheet","$ionicPlatform","AccountService","HabitsService","GoalsService","AudioService","PayService","GroupsService","SkillsService","GeneralService","Environment","TokenService",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T,m,E,_,S,I,O,A,D,L,b){function G(){k(),C()}function R(){e.destroying||e.websocketError||!e.chatConnection||C()}function y(){var e=v.getScrollPosition().top,t=v.getScrollView().__maxScrollTop;return e>t-30}function N(t){if(t.data.startsWith("{")){var o=JSON.parse(t.data);e.usersTyping=o.usersTyping;var i=y(),n=o.groupPosts;if(n&&n.length>0){for(var a=0;a<n.length;++a){var r=n[a];r.creatorId!=m.getAccountUser().user.id&&(e.groupPosts.push(r),e.hasNewPosts=!0)}var c=o.groupPostData;c&&(H(c),s(function(){K(!1,!1)})),i&&e.scrollToNewPosts()}e.$$phase||e.$apply()}}function M(t){w(),!e.websocketOpened||e.creatingWebsocket?(e.websocketError=!0,s(x,Y)):C()}function P(){x(!0),C(),O.clearGroupNotification(e.groupId)}function C(){if(e.group&&e.group.private&&m.isLoggedIn()&&(!e.chatConnection||0!==e.chatConnection.readyState)){e.creatingWebsocket=!0,e.chatConnection&&w();var t=b.getToken();"notsecure"!=t?(e.chatConnection=new WebSocket(L.websocketURL+"/chat/group/"+e.group.id+"?token="+b.getToken()),e.chatConnection.onclose=R,e.chatConnection.onmessage=N,e.chatConnection.onerror=M,e.chatConnection.onopen=function(){e.websocketOpened=!0},e.creatingWebsocket=!1):s(x,Y)}}function w(){if(e.chatConnection){var t=e.chatConnection.readyState;(0===t||1==t)&&e.chatConnection.close(),e.chatConnection=void 0}}function x(t){if(!e.lastPostLoad||!e.group)return void s(x,Y);var o;o=e.groupPosts.length>0?new Date(e.groupPosts[e.groupPosts.length-1].createdAt):e.lastPostLoad,O.findNewerPosts(e.group,o).success(function(o){var i=o.groupPostsContext.groupPosts;if(i.length>0){for(var n=y(),a=i.length-1;a>=0;--a)for(var r=i[a],c=e.groupPosts.length-1;c>=0;--c){var l=e.groupPosts[c];r.id!=l.id||i.splice(a,1)}if(i.length>0){e.hasNewPosts=!0,i=i.reverse(),e.groupPosts.push.apply(e.groupPosts,i);var u=o.groupPostsContext.groupPostData;H(u),e.lastPostLoad=new Date,n&&e.scrollToNewPosts(),s(function(){K(!1,!1)})}}t||s(x,Y)}).error(function(){})}function U(t,o){var i=0,n=e.getThought(t);if(n&&n.recordings&&n.recordings.thought&&n.recordings.thought.tags)for(var a=n.recordings.thought.tags,r=0;r<a.length;++r){var s=a[r];s.tagTypeString==o&&++i}return i}function H(t){if(t)for(var o=0;o<t.length;++o){var i=t[o],n=e.postDataObjects[i.postId];n||(n={},e.postDataObjects[i.postId]=n),n[i.name]=i.value}}function k(t){if(e.group){var o=0===e.groupPosts.length||t;o&&(e.loadingPosts=!0),O.findGroupPosts(e.group,e.order,e.limit,e.offset).success(function(t){var i=t.groupPostsContext.groupPosts;o&&(e.groupPosts.length=0);var n=t.groupPostsContext.groupPostData;H(n),e.canLoadMore=i.length==e.limit,e.group.private?(e.lastPostLoad=new Date,i=i.reverse(),Array.prototype.splice.apply(e.groupPosts,[0,0].concat(i))):e.groupPosts.push.apply(e.groupPosts,i),e.addUserVotes(t.userVotes),e.loadingPosts=!1,v.resize(),e.group.private&&s(function(){K(o,!o)}),e.$broadcast("scroll.refreshComplete")}).error(function(){p.alert({template:l.instant("LOADING_POSTS_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"});e.loadingPosts=!0,e.$broadcast("scroll.refreshComplete")})}}function V(){e.offset=0}function F(e,t){var o,i=e.getBoundingClientRect();t.changedTouches&&(o=t.changedTouches[0].pageX),o||(o="undefined"!=typeof t.pageX?t.pageX:t.clientX);var n;return t.changedTouches&&(n=t.changedTouches[0].pageY),n||(n="undefined"!=typeof t.pageY?t.pageY:t.clientY),{x:o-i.left,y:n-i.top}}function B(t,o,i,n,a,r,s,c){var l,u=t.data("startdate"),d=new Date(u),p=+t.data("numberofdays"),f=d.getTime(),v=864e5*p,h=+t.data("postid");if(c){var T=function(){var t=l.x/r,o=Math.floor(t*p),i=new Date(d.getTime()+1e3*o*60*60*24);e.moodDetailDate=i;var n=new Date(i.getTime()+864e5),a=e.getPost(h);if(a){var s=e.getMoodEntries(a);if(s){e.modalMoodEntries=[];for(var c={},u=0;u<s.length;++u){var f=s[u],v=new Date(f.experiencedAtStr);if(v>i&&n>v&&(e.modalMoodEntries.push(f),f.habitSubValueIds))for(var T=0;T<f.habitSubValueIds.length;++T){var m=f.habitSubValueIds[T];c[m]=S}}var _=[];for(var S in c){var I=E.getHabitSubValueName(0,S);I||_.push(S)}_.length>0&&E.getHabitSubValues(_),g.fromTemplateUrl("views/groups/groups.moodDetail.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.moodDetailModal=t,openModal(e.moodDetailModal)})}}},m=function(e){l=F(i[0],e),s=Math.floor(p*(l.x/r)),B(t,o,i,n,a,r,s)},_=function(e){endPos=F(i[0],e),endPos.x==l.x&&endPos.y==l.y&&T(e),s=-1,B(t,o,i,n,a,r,s)};i[0].addEventListener("mousedown",m),i[0].addEventListener("mouseup",_),i[0].addEventListener("touchstart",m),i[0].addEventListener("touchend",_)}for(var S=i[0].getContext("2d"),I=S.canvas.width=r*n,O=S.canvas.height=a*n,A=I/p,L=40,b=0;p>b;++b){var G;G=b==s?"rgba(0, 0, 0, 0.3)":b%2===0?"rgba(0, 0, 0, 0.5)":"rgba(0, 0, 0, 0.55)";var R=b*A;S.fillStyle=G,S.fillRect(R,0,A,O);var y=new Date(d.getTime());y.setDate(y.getDate()+b);var N=moment(y).format("L");S.textAlign="center",S.font="25px sans-serif",S.fillStyle="rgb(150,150,150)",S.fillText(N,R+A/2,30)}for(var M=o.split("|"),P=0;2>P;++P)for(var C=0;C<M.length;++C){var w=M[C].split(";"),x=new Date(w[1]),U=(x.getTime()-f)/v*I,H=O-(L+(+w[0]-1)/6*(O-30-2*L));if(0===P){if(C>0){var k=M[C-1].split(";"),$=new Date(k[1]),V=($.getTime()-f)/v*I,K=O-(L+(+k[0]-1)/6*(O-30-2*L));S.strokeStyle="rgba(255,255,255, 0.4)",S.beginPath(),S.moveTo(V,K),S.lineTo(U,H),S.stroke()}}else{var Y=D.COLORS[7-w[0]],W=hexToRgb(Y),X="rgb("+W.r+","+W.g+","+W.b+")";S.fillStyle=X,S.beginPath(),S.arc(U,H,8,0,2*Math.PI),S.closePath(),S.fill()}}}function K(e,t){var o=$(".group-post");if(0!==o.length){for(var i=$("div[data-mooddata]"),n=window.devicePixelRatio,a=120,r=window.innerWidth,c=i.length,l=0;c>l;++l){var u=$(i[l]),d=""+u.data("mooddata"),p=u.data("startdate");if(p){r=u.outerWidth();var g=-1,f=u.find("canvas");f[0].width<100&&(f.css("width",r),f.css("height",a),B(u,d,f,n,a,r,g,!0))}}e&&s(function(){v.scrollBottom(t)})}}var Y=3e4;i("AbstractGroupPostsCtrl",{$scope:e}),e.groupId=a.groupId,O.clearGroupNotification(e.groupId),e.loadingGroup=!0,O.getGroup(e.groupId).success(function(t){e.group=t,e.loadingGroup=!1,G()}).error(function(){e.loadingGroup=!1}),e.getGroupTitle=function(){var t=e.group?e.group.name:void 0;return t?t.length>20&&(t=t.substring(0,20)," "==t.substring(19)&&(t=t.substring(0,19))):t="",t},e.getGroupCode=function(){return e.group&&e.isOwner(e.group)?e.group.code:""},e.showGroupTip=function(){if(e.group&&e.group.members>1)return!1;var t=m.getUserPreference("sent_group_invitation");return!t&&e.isOwner(e.group)},e.showManageGroupTooltip=function(){var t=m.getUserPreference("viewed_manage_group_tooltip");return!(e.showGroupTip()||t&&"false"!=t)},e.dismissManageGroupTooltip=function(){e.viewManageGroupTooltip=!1,m.setUserPreference("viewed_manage_group_tooltip","true")},e.websocketSend=function(t){e.chatConnection&&e.chatConnection.send(t)},document.addEventListener("resume",P,!1),T.on("pause",function(){w()}),e.$on("$destroy",function(){e.destroying=!0,document.removeEventListener("resume",P,!1),w()}),e.scrollToNewPosts=function(){v.scrollBottom(!0),e.hasNewPosts=!1},$(".scroll-content").scroll(function(){var t=v.getScrollPosition().top,o=v.getScrollView().__maxScrollTop;t>o-150&&(e.hasNewPosts=!1,e.$$phase||e.$digest())}),e.isOwner=function(){return e.group&&e.group.creatorId==m.getAccountUser().user.id},window.viewGroupUsers=function(t){t.stopPropagation(),t.preventDefault(),e.group&&n.go("app.groups-users",{groupId:e.group.id})},e.groupPosts=[],e.postDataObjects={},e.limit=25,e.offset=0,e.canLoadMore=!0,e.order=a.order,initEditFunctionality(e,s,l,g,p,O,m),e.loadMoreGroupsPosts=function(){e.offset+=e.limit,k()},e.reloadCommunityPosts=function(){e.offset=0,k(!0)},e.isPostType=function(t,o){var i=e.postDataObjects[t.id];return i?i.type==o:!1},e.getCommunityName=function(){if(!e.group)return"";var t=e.group.name,o=("COMMUNITY_"+t).replace(/ /g,"_").toUpperCase(),i=l.instant(o);return i==o?t:i},e.getPost=function(t){for(var o=0;o<e.groupPosts.length;++o){var i=e.groupPosts[o];if(i.id==t)return i}},e.getMoodEntries=function(t){var o=e.postDataObjects[t.id];if(o){if(o.moodEntries)return o.moodEntries;if("Mood"==o.type){var i=o.data;if(i){var n=JSON.parse(i);return o.moodEntries=n,n}}}},e.getMoodStartDate=function(t){var o=e.postDataObjects[t.id];if(o){if(o.startDate)return o.startDate;if("Mood"==o.type){var i=o.data;if(i&&i.startDate){var n=new Date(i.startDate);return o.startDate=n,n}}}},e.getMoodNumberOfDays=function(t){var o=e.postDataObjects[t.id];if(o){if(o.numberOfDays)return o.numberOfDays;if("Mood"==o.type){var i=o.data;if(i){var n=+i.numberOfDays;return o.numberOfDays=n,n}}}},e.getMoodClass=function(t){var o=e.getMoodEntries(t);if(o&&o.length>0){var i=o[o.length-1];return E.getMoodClass(i)}},e.getMoodDisplay=function(t){var o=e.getMoodEntries(t);if(o&&o.length>0){var i=o[o.length-1];return E.getHabitDisplayFromValue(i)}},e.getMoodData=function(t){var o=e.getMoodEntries(t);if(o&&o.length>0){for(var i="",n=0;n<o.length;++n){if(n>0&&(i+="|"),void 0===o[n].valueInt){var a=E.getHabitValueById(o[n].habitValueId);i+=a.valueInt}else i+=o[n].valueInt;i+=";"+o[n].experiencedAtStr}return i}},e.getPositiveFlags=function(e){return U(e,"positive")},e.getNegativeFlags=function(e){return U(e,"negative")},e.getThought=function(t){var o=e.postDataObjects[t.id];if(o){if(o.thought)return o.thought;if("Thought"==o.type){var i=o.data;if(i){var n=JSON.parse(i);return o.thought=n,n}o.thought={}}}return{}},e.getExperiment=function(t){var o=e.postDataObjects[t.id];if(o){if(o.experiment)return o.experiment;if("Experiment"==o.type){var i=o.data;if(i){var n=JSON.parse(i);return o.experiment=n,n}o.experiment={}}}return{}},e.getExperimentCompletionDate=function(t){var o=e.getExperiment(t);if(o){var i=o.achievedRecordedAtString;if(i)return moment(new Date(i)).calendar()}},e.showTop=function(){"hotness"!=e.order&&(e.order="hotness",e.groupPosts.length=0,V(),k(),v.scrollTop())},e.showNew=function(){"date"!=e.order&&(e.order="date",e.groupPosts.length=0,V(),k(),v.scrollTop())},e.showAllTime=function(){"score"!=e.order&&(e.order="score",e.groupPosts.length=0,V(),k(),v.scrollTop())},e.removePost=function(t){e.removePostById(t.id)},e.removePostById=function(t){for(var o=0;o<e.groupPosts.length;++o)if(e.groupPosts[o].id==t)return void e.groupPosts.splice(o,1)},e.createPostInternal=function(o,i){e.submittingPost=!0,e.typing=!1;var n;if(i){n=[];for(var a in i){if(n.push({name:"type",value:a}),n.push({name:"version",value:"1"}),"Mood"==a){var r=i.Mood.moodEntries;n.push({name:"data",value:JSON.stringify(r)}),n.push({name:"startDate",value:i.Mood.startDate}),n.push({name:"numberOfDays",value:i.Mood.numberOfDays})}else if("Thought"==a){var c=i.Thought;n.push({name:"data",value:JSON.stringify(c)});var u=new Date((new Date).getTime()+6048e5);n.push({name:"expiresAtStr",value:u.toString()})}else if("Experiment"==a){var d=i.Experiment;n.push({name:"data",value:JSON.stringify(d)})}break}}$("#postText").blur();var g=e.groupPostData.postText,f=e.communityPostData.postText;e.groupPostData.postText="",e.communityPostData.postText="",O.createGroupPost(e.groupId,o,n).success(function(o){if(e.sharingData={},e.submittingPost=!1,e.group.private){e.groupPosts.push(o),e.postDataObjects[o.id]={};for(var i=0;i<n.length;++i){var a=n[i];e.postDataObjects[o.id][a.name]=a.value}s(function(){v.scrollBottom(!0)})}else A.checkForLevelUp(),e.groupPosts.splice(0,0,o);e.createVoteObject(o),s(K),s(function(){t.$broadcast("event:createdMessage")},500)}).error(function(){e.groupPostData.postText=g,e.communityPostData.postText=f;p.alert({template:l.instant("LOADING_POSTS_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"});e.submittingPost=!1})},e.createPost=function(t){if(t&&(t.preventDefault(),t.stopPropagation()),!e.checkOfflineMode()){if(!m.getAccountUser().user.banned){if(!e.isUserEmailValidated())return void e.checkRemoteEmailValidation(function(t){t&&e.createPost()});var o=!1;e.hasSharingData&&(o=e.hasSharingData("Mood")||e.hasSharingData("Thought")||e.hasSharingData("Experiment"));var i=e.groupPostData.postText.trim();return 0!==i.length||o?void e.createPostInternal(i,e.sharingData):void(e.groupError=l.instant("CREATE_POST_TEXT_ERROR"))}{p.alert({template:l.instant("BANNED_USER_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})}}},e.closeCreatePostModal=function(){closeModal(e.createCommunityPostModal),e.createCommunityPostModal.remove(),e.createCommunityPostModal=void 0},e.canCreateCommunityPost=function(){return!m.getAccountUser().user.banned&&O.canCreatePublicGroupPost(e.group)},e.createCommunityPost=function(){var t=e.communityPostData.postText.trim();return 0===t.length?void(e.communityError=l.instant("CREATE_POST_TEXT_ERROR")):t.length>500?void(e.communityError=l.instant("CREATE_POST_LENGTH_ERROR")):(e.communityError=void 0,e.createPostInternal(t),e.closeCreatePostModal(),void e.showNew())},e.getCommunityPostRemainingCharacters=function(){var t=e.communityPostData.postText;return t=t?t.trim():"",500-t.length},e.getGroupRemainingPostCharacters=function(){var t=e.groupPostData.postText;return t||(t=""),500-t.length},e.showCreatePost=function(){if(!e.checkOfflineMode()){if(!e.hasUserNickname())return e.attemptingCommunityPost=!0,void e.showUpdateNickname();if(!e.isUserEmailValidated())return void e.checkRemoteEmailValidation(function(t){t&&e.showCreatePost()});if(e.canCreateCommunityPost())e.group&&"Experiments"==e.group.name?e.showExperimentShare():(e.communityPostData.postText="",g.fromTemplateUrl("views/groups/communities.createPost.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.createCommunityPostModal=t,openModal(e.createCommunityPostModal)}));else if(m.getAccountUser().user.banned){p.alert({template:l.instant("BANNED_USER_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})}else{p.alert({template:l.instant("CREATE_POST_COOLOFF_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})}}},initEditNicknameFunctionality(e,m,p,g,l),s(function(){$(".community-tabs").css("top",$("ion-header-bar").outerHeight()+"px")}),e.getMoodDetailDate=function(){return e.moodDetailDate?moment(e.moodDetailDate).calendar():void 0},e.getMoodColor=function(e){return D.COLOR_NAMES[7-e.valueInt]},e.getHabitSubValue=function(e){var t=E.getHabitSubValueName(0,e);return l.instant(t?t.toUpperCase():"UNKNOWN")},e.getMoodRatingDisplay=function(e){var t=e.valueString,o="HABITS_VALUES_"+t;return o=o.replace(/ /g,"_").toUpperCase(),l.instant(o)},e.getMoodRatingDateDisplay=function(e){var t=new Date(e.experiencedAtStr);return moment(t).calendar()},e.hasNotes=function(e){return e.habitDataNotes&&e.habitDataNotes.notes&&e.habitDataNotes.notes.length>1},e.closeMoodDetailModal=function(){closeModal(e.moodDetailModal),e.moodDetailModal.remove(),e.moodDetailModal=void 0}}]),ctrl.controller("GroupsProfileCtrl",["$scope","$rootScope","$state","$timeout","$http","$stateParams","$ionicPopup","$ionicModal","$ionicScrollDelegate","$controller","$translate","AccountService","GroupsService",function(e,t,o,i,n,a,r,s,c,l,u,d,p){function g(e,t){if(e)for(var o=d.getAccountUser().user.id,i=0;i<e.length;++i){var n=e[i];n.creatorId==o&&(n.creatorAvatar=t)}}function f(t){p.getUserLikes(t).success(function(t){e.addUserVotes(t)}).error(function(){r.alert({template:u.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})})}function v(t){p.getUserCommentLikes(t).success(function(t){e.addUserCommentVotes(t)}).error(function(){r.alert({template:u.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})})}function h(t){(t||!e.shares)&&((!e.shares||e.otherUserId||0===e.shareOffset)&&(e.shares=[]),e.loadingShares=!0,p.getShares(e.limit,e.shareOffset,e.otherUserId?e.otherUserId:void 0).success(function(t){if(e.canLoadMoreShares=t.length==e.limit,e.shares.push.apply(e.shares,t),e.viewingOtherUser)f(t);else for(var o in t)e.createVoteObject(t[o]);e.loadingShares=!1,c.resize()}).error(function(){r.alert({template:u.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"});e.loadingShares=!1}))}function T(t){if(t||!e.likes)(!e.likes||e.otherUserId||0===e.likeOffset)&&(e.likes=[]),e.loadingLikes=!0,p.getLikes(e.limit,e.likeOffset,e.otherUserId?e.otherUserId:void 0).success(function(t){e.canLoadMoreLikes=t.length==e.limit,e.likes.push.apply(e.likes,t);for(var o in t)e.createVoteObject(t[o]);e.loadingLikes=!1,c.resize()}).error(function(){r.alert({template:u.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"});e.loadingLikes=!1});else for(var o=e.likes.length-1;o>=0;--o)e.hasVote(e.likes[o])||e.likes.splice(o,1)}function m(t){(t||!e.comments)&&((!e.comments||e.otherUserId||0===e.commentOffset)&&(e.comments=[]),e.loadingComments=!0,p.getComments(e.limit,e.commentOffset,e.otherUserId?e.otherUserId:void 0).success(function(t){if(e.canLoadMoreComments=t.length==e.limit,e.comments.push.apply(e.comments,t),e.otherUserId)v(t);else for(var o in t)e.createVoteObject(t[o]);e.loadingComments=!1,c.resize()}).error(function(){r.alert({template:u.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"});e.loadingComments=!1}))}l("AbstractGroupPostsCtrl",{$scope:e}),p.findPublicGroups(),a.userId?(e.loadingUser=!0,e.viewingOtherUser=!0,e.otherUserId=+a.userId,d.getPublicUser(e.otherUserId).success(function(t){e.user=t,a.nickname&&(e.user.publicName=a.nickname),e.loadingUser=!1}).error(function(){r.alert({template:u.instant("LOAD_PROFILE_CONTENT_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"});e.loadingUser=!1})):e.user=d.getAccountUser().user,e.getUserName=function(){return e.viewingOtherUser&&e.loadingUser?u.instant("LOADING")+"...":a.nickname?a.nickname:e.user.publicName},e.getUserAvatar=function(){if(e.viewingOtherUser&&e.loadingUser)return"";var t=d.getAvatarCharacter(e.user.avatar,e.user.id);return"avatar_"+t},e.isAvatarSelected=function(e){var t=d.getAccountUser().user;return e==d.getAvatarCharacter(t.avatar,t.id)},e.setUserAvatar=function(t){d.setAvatar(t).success(function(){e.user.avatar=t,g(e.shares,t),g(e.likes,t),g(e.comments,t),e.closeAvatarModal()}).error(function(){r.alert({template:u.instant("ERROR_UPDATING_AVATAR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})})},e.closeAvatarModal=function(){closeModal(e.chooseAvatarModal),e.chooseAvatarModal.remove(),e.chooseAvatarModal=void 0},e.showChooseAvatar=function(){s.fromTemplateUrl("views/groups/communities.chooseAvatar.modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.chooseAvatarModal=t,openModal(e.chooseAvatarModal)})},e.getJoinedDate=function(){if(e.user){var t=new Date(e.user.createdAt);return moment(t).format("LL")}return""},e.activeTab="shares",e.limit=25,e.shares=void 0,e.shareOffset=0,e.canLoadMoreShares=!0,e.likes=void 0,e.likeOffset=0,e.canLoadMoreLikes=!0,e.comments=void 0,e.commentOffset=0,e.canLoadMoreComments=!0,initEditNicknameFunctionality(e,d,r,s,u),e.findPublicGroupName=function(e){return p.findPublicGroupName(e)},e.setActiveTab=function(t){e.activeTab=t,"shares"==t?h():"likes"==t?T():m(),c.scrollTop()},e.removePost=function(t){e.removePostById(t.id)},e.removePostById=function(t){if(e.shares)for(var o=0;o<e.shares.length;++o)if(e.shares[o].id==t){e.shares.splice(o,1);break}if(e.likes)for(var i=0;i<e.likes.length&&e.likes[i].id!=t;++i);},e.getActivePosts=function(){return"shares"==e.activeTab?e.shares:"likes"==e.activeTab?e.likes:e.comments},e.isLoading=function(){return e.loadingShares||e.loadingLikes},e.loadMoreLikes=function(){e.likeOffset+=e.limit,T(!0)},e.loadMoreShares=function(){e.shareOffset+=e.limit,h(!0)},e.loadMoreComments=function(){e.commentOffset+=e.limit,m(!0)},e.loadMorePosts=function(){"shares"==e.activeTab?e.loadMoreShares():"likes"==e.activeTab?e.loadMoreLikes():e.loadMoreComments()},e.canLoadMore=function(){return"shares"==e.activeTab?e.canLoadMoreShares:"likes"==e.activeTab?e.canLoadMoreLikes:e.canLoadMoreComments},i(function(){$(".community-tabs").css("top",$("ion-header-bar").outerHeight()+"px")}),e.setActiveTab("shares")}]),ctrl.controller("GroupsUsersCtrl",["$scope","$sce","$rootScope","$state","$timeout","$http","$stateParams","$analytics","$ionicModal","$ionicPopup","$ionicHistory","$ionicActionSheet","$controller","$translate","AccountService","GroupsService","GeneralService","Environment",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T){e.group=v.getGroupImmediate(+r.groupId),e.loadingUsers=!0,e.notificationData={};var m=f.getUserPreference("receive_community_notifications");e.notificationData.communityNotification=m?""+("true"==m.toLowerCase()):"true",e.updateCommunityNotifications=function(){f.setUserPreference("receive_community_notifications",e.notificationData.communityNotification).success(function(){e.communityNotificationUpdated=!0,n(function(){e.communityNotificationUpdated=!1},3e3)})},e.checkOfflineMode=function(){if(!T.isOnline()){{l.alert({template:g.instant("GROUPS_OFFLINE_ERROR"),okText:g.instant("OK_GOT_IT"),okType:"button-default"})}return!0}return!1},e.getGroupCode=function(){return e.group.code},e.viewUserProfile=function(e,t,o){e.stopPropagation(),e.preventDefault(),i.go("app.groups-profile",{userId:t.userId,nickname:o})},e.leaveGroup=function(t){if(t.stopPropagation(),t.preventDefault(),!e.checkOfflineMode()){s.eventTrack("archiveGroupPopupFromMembers",{category:"group"});var o=l.confirm({template:"<div>"+g.instant("LEAVE_GROUP_PROMPT")+"</div>",cancelText:g.instant("CANCEL"),cancelType:"button-default",okText:g.instant("LEAVE"),okType:"button-default"});o.then(function(t){t&&v.leaveGroup(e.group.id).success(function(){e.goBack(-2)}).error(function(){l.alert({template:g.instant("LEAVE_GROUP_ERROR"),okText:g.instant("OK_GOT_IT"),okType:"button-default"})})})}},e.copyCodeToClipboard=function(){cordova.plugins.clipboard.copy(e.group.code,function(){l.alert({template:g.instant("GROUP_CODE_COPIED"),okText:g.instant("OK_GOT_IT"),okType:"button-default"})},function(){})},e.isOwner=function(){return e.group.creatorId==f.getAccountUser().user.id},e.isYou=function(e){return e.userId==f.getAccountUser().user.id},initInviteFunctionality(e,g,c,l,d,f,v,h),v.getGroupUsers(+r.groupId).success(function(t){var o=t.groupUsers;e.groupUsers=o;for(var i=0;i<e.groupUsers.length;++i){var n=e.groupUsers[i];if(e.isYou(n)){e.groupUsers.splice(i,1),e.groupUsers.unshift(n);break}}e.pendingInvites=t.pendingInvites,e.loadingUsers=!1}).error(function(){l.alert({template:g.instant("RETRIEVE_USERS_ERROR"),okText:g.instant("OK_GOT_IT"),okType:"button-default"});e.loadingUsers=!1}),e.deletePendingInvite=function(t){var o=l.confirm({template:"<div>"+g.instant("DELETE_INVITE_PROMPT")+"</div>",cancelText:g.instant("CANCEL"),cancelType:"button-default",okText:g.instant("DELETE"),okType:"button-default"});o.then(function(o){o&&v.deleteInvite(e.group.id,t).success(function(){for(var o=0;o<e.pendingInvites.length;++o)if(e.pendingInvites[o].email==t){e.pendingInvites.splice(o,1);break}}).error(function(){l.alert({template:g.instant("DELETE_INVITE_ERROR"),okText:g.instant("OK_GOT_IT"),okType:"button-default"})})})},e.removeUser=function(t){var o=l.confirm({template:"<div>"+g.instant("REMOVE_USER_PROMPT")+"</div>",cancelText:g.instant("CANCEL"),cancelType:"button-default",okText:g.instant("REMOVE"),okType:"button-default"});o.then(function(o){o&&v.removeUser(e.group.id,t).success(function(){for(var o=0;o<e.groupUsers.length;++o)if(e.groupUsers[o].userId==t){e.groupUsers.splice(o,1);break}--e.group.members}).error(function(){l.alert({template:g.instant("REMOVE_USER_ERROR"),okText:g.instant("OK_GOT_IT"),okType:"button-default"})
})})}}]),ctrl.controller("GroupsHelpCtrl",["$scope","$sce","$rootScope","$state","$http","$stateParams","$controller","$translate","$ionicHistory","AccountService",function(e,t,o,i,n,a,r,s,c,l){r("HelpCtrl",{$scope:e}),e.getHelpSlide=function(e){var o="GROUPS_HELP_SLIDE_"+e;return t.trustAsHtml(s.instant(o))},e.confirm=function(){l.setUserPreference("viewed_groups_disclaimer","true"),c.currentView(c.backView()),i.go("app.group-posts",{groupId:a.groupId,order:a.order},{location:"replace"})}}]),ctrl.controller("CommunitiesHelpCtrl",["$scope","$sce","$rootScope","$state","$http","$stateParams","$controller","$translate","$ionicHistory","AccountService",function(e,t,o,i,n,a,r,s,c,l){r("HelpCtrl",{$scope:e}),e.getHelpSlide=function(e){var o="COMMUNITIES_HELP_SLIDE_"+e;return t.trustAsHtml(s.instant(o))},e.confirm=function(){l.setUserPreference("viewed_community_rules","true"),c.currentView(c.backView()),"app.communities-help"==i.current.name?i.go("app.communities-posts",{groupId:a.groupId,order:a.order},{location:"replace"}):"app.groups-help"==i.current.name&&i.go("app.group-posts",{groupId:a.groupId,order:a.order},{location:"replace"})}}]),function(){function e(e){return e.valueString?e.valueString:e.valueInt}var t=angular.module("habitsCtrl",[]),o=["FEELING_ANXIOUS","FEELING_STRESSED","FEELING_RELAXED","FEELING_HAPPY","FEELING_SAD","FEELING_LOVED","FEELING_GRATEFUL","FEELING_CALM","FEELING_LONELY","FEELING_EXCITED","FEELING_ANGRY","FEELING_PANICKED","FEELING_INSPIRED","FEELING_TIRED","FEELING_DEPRESSED","FEELING_SICK","FEELING_ANNOYED","FEELING_EXHAUSTED","FEELING_NERVOUS","FEELING_WORRIED","FEELING_CONTENT","FEELING_SLEEPY","FEELING_FRUSTRATED","FEELING_BORED","FEELING_CONFUSED","FEELING_NUMB","FEELING_OVERWHELMED","FEELING_EMPTY","FEELING_SCARED","FEELING_IRRITATED","FEELING_HOPEFUL","FEELING_NEUTRAL","FEELING_ACCOMPLISHED","FEELING_ALONE","FEELING_PRODUCTIVE","FEELING_GUILTY","FEELING_DISAPPOINTED","FEELING_UPSET","FEELING_RELIEVED","FEELING_HOPELESS","FEELING_MOTIVATED","FEELING_HURT","FEELING_IRRITABLE","FEELING_RESTLESS","FEELING_PROUD","FEELING_CHILL","FEELING_UNMOTIVATED","FEELING_CONFIDENT","FEELING_DRAINED","FEELING_TENSE","FEELING_PEACEFUL","FEELING_INDIFFERENT","FEELING_INSECURE","FEELING_UNEASY","FEELING_LAZY","FEELING_OPTIMISTIC","FEELING_UNSURE","FEELING_NAUSEOUS","FEELING_UNCOMFORTABLE","FEELING_SATISFIED","FEELING_HEARTBROKEN","FEELING_DETERMINED","FEELING_POSITIVE","FEELING_JEALOUS","FEELING_APATHETIC","FEELING_AGITATED","FEELING_BLESSED","FEELING_UNWANTED","FEELING_ENERGIZED","FEELING_BUSY","FEELING_PARANOID","FEELING_RESTED","FEELING_FOCUSED","FEELING_ALRIGHT","FEELING_GRUMPY","FEELING_CONFLICTED","FEELING_MELANCHOLY","FEELING_EMOTIONAL","FEELING_LETHARGIC","FEELING_EMBARRASSED","FEELING_ENERGETIC","FEELING_FATIGUED","FEELING_ASHAMED","FEELING_AFRAID","FEELING_DISTRACTED","FEELING_UNCERTAIN","FEELING_BETRAYED","FEELING_APPREHENSIVE","FEELING_THOUGHTFUL","FEELING_DEFEATED","FEELING_IMPATIENT","FEELING_NOSTALGIC","FEELING_REGRETFUL","FEELING_IGNORED","FEELING_CONCERNED","FEELING_HELPLESS","FEELING_HOMESICK","FEELING_DISCONNECTED","FEELING_DISCOURAGED","FEELING_AGGRAVATED","FEELING_HEALTHY","FEELING_MELLOW","FEELING_THANKFUL","FEELING_AMAZING","FEELING_WEAK","FEELING_DYSPHORIC","FEELING_ABANDONED","FEELING_INADEQUATE","FEELING_UNPRODUCTIVE","FEELING_EMOTIONLESS","FEELING_REJECTED","FEELING_ANTSY","FEELING_AWKWARD","FEELING_MOODY","FEELING_GROGGY","FEELING_MISERABLE","FEELING_CRANKY","FEELING_TRAPPED","FEELING_AWESOME","FEELING_BUMMED","FEELING_UNFOCUSED","FEELING_DECENT","FEELING_PENSIVE","FEELING_DISGUSTED","FEELING_TERRIFIED","FEELING_CREATIVE","FEELING_SAFE","FEELING_READY","FEELING_EMPOWERED","FEELING_APPRECIATED","FEELING_UNAPPRECIATED","FEELING_BALANCED","FEELING_WELL","FEELING_AMUSED","FEELING_PRESSURED","FEELING_MANIC","FEELING_PATHETIC","FEELING_FULFILLED","FEELING_FURIOUS","FEELING_HOT","FEELING_POSSESSIVE","FEELING_CYNICAL","FEELING_FRIGHTENED","FEELING_OBSESSED","FEELING_INTRIGUED","FEELING_INTIMIDATED","FEELING_LOYAL","FEELING_COMFORTABLE","FEELING_FASCINATED","FEELING_NEGLECTED","FEELING_DISTURBED","FEELING_MANIPULATED","FEELING_WITHDRAWN","FEELING_RESPECTED","FEELING_FESTIVE","FEELING_CRAZY","FEELING_SORRY","FEELING_ECSTATIC","FEELING_RESPONSIBLE","FEELING_CLAUSTROPHOBIC","FEELING_DEVASTATED","FEELING_AMBIVALENT","FEELING_SHY","FEELING_DELIGHTED","FEELING_SILLY","FEELING_INTERESTED","FEELING_HYSTERICAL","FEELING_SHOCKED","FEELING_GUARDED","FEELING_EUPHORIC","FEELING_DISTRESSED","FEELING_SKEPTICAL","FEELING_TEASED","FEELING_SENSITIVE","FEELING_EAGER","FEELING_CHEATED","FEELING_ENVIOUS","FEELING_PATIENT","FEELING_AGGRESSIVE","FEELING_VIOLENT","FEELING_RECKLESS","FEELING_SYMPATHETIC","FEELING_ATTRACTIVE","FEELING_POWERLESS","FEELING_COOL","FEELING_COURAGEOUS","FEELING_SELF-CONSCIOUS","FEELING_HUMILIATED","FEELING_BRAVE","FEELING_AFFECTIONATE","FEELING_PREPARED","FEELING_INSULTED","FEELING_SASSY","FEELING_IMPORTANT","FEELING_SEXY","FEELING_THRILLED","FEELING_ENCOURAGED","FEELING_ENTERTAINED","FEELING_SUSPICIOUS","FEELING_SARCASTIC","FEELING_THREATENED","FEELING_ADVENTUROUS","FEELING_FUNNY","FEELING_PLAYFUL","FEELING_RELUCTANT","FEELING_DEGRADED","FEELING_HUMBLE","FEELING_FLIRTATIOUS","FEELING_RESENTFUL","FEELING_FRISKY","FEELING_HORNY","FEELING_SURPRISED","FEELING_MISUNDERSTOOD","FEELING_FRIENDLY","FEELING_OFFENDED","FEELING_DESPERATE","FEELING_DEFENSIVE","FEELING_HATEFUL","FEELING_TROUBLED","FEELING_FLUSTERED","FEELING_HOSTILE","FEELING_TEMPTED","FEELING_PROVOKED","FEELING_IN_LOVE","FEELING_VENGEFUL","FEELING_BITTER","FEELING_DARING","FEELING_ALIVE","FEELING_REBELLIOUS","FEELING_ALIENATED","FEELING_GRIEVING","FEELING_CURIOUS","FEELING_PASSIONATE","FEELING_CHALLENGED","FEELING_VULNERABLE","FEELING_JUDGMENTAL","FEELING_CARING","FEELING_INVISIBLE","FEELING_IMPRESSED","FEELING_JOYFUL","FEELING_ALARMED","FEELING_WONDERFUL","FEELING_PESSIMISTIC"];t.controller("HabitsCtrl",["$scope","$rootScope","$controller","$state","$timeout","$http","$translate","$analytics","$ionicScrollDelegate","$ionicHistory","$ionicPopup","$ionicModal","$ionicLoading","$ionicPlatform","$ionicActionSheet","AccountService","HabitsService","GeneralService","NotificationService","SkillsService","PayService","Token","Environment",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T,m,E,_,S,I){function O(t){return function(o){o&&(e.habitReminders[t.id]=o,e.$$phase||e.$apply())}}function A(){e.habits=h.getAccountHabits(),e.potentialHabits=h.getPotentialAccountHabits(),h.removeMoodHabit(e),e.habitReminders={};for(var t=0;t<e.habits.length;++t){var o=e.habits[t];m.queryForHabitReminder(o,O(o))}}function D(t){A();for(var o=0;o<e.habits.length;++o){var i=e.habits[o],n=e.getHabitData(i.id);P(i,n,t)}}function L(){var e=v.getSplitTestContext();if(e&&e.splitTestGroups){var t=e.splitTestGroups.habitEntryUI;if(t)return"spinner"==t}return!1}function b(t){t&&m.scheduleHabitReminder(e.habitForReminder,t,function(){e.habitReminders[e.habitForReminder.id]={at:t.getTime()/1e3},e.$$phase||e.$apply(),s.eventTrack("scheduleHabitReminder",{category:"habits"})})}function G(){}function R(){for(var t=[],o=5,i=e.startReminder+o<e.habits.length,a=Math.min(e.habits.length-e.startReminder,o),s=e.startReminder;s<e.startReminder+a;++s){var c,l,u=e.habits[s];e.hasReminder(u)?(c="ion-ios-minus-outline",l=" <span>("+e.getReminderTimeDisplay(u)+")</span>"):(c="ion-ios-plus-outline",l=""),t.push({text:'<i class="icon '+c+'"></i> '+h.getHabitName(u)+l})}if(i){var d=Math.min(e.habits.length-(e.startReminder+o),o);t.push({text:'<i class="icon ion-ios-arrow-thin-right"></i>'+r.instant("NEXT")+" "+d})}f.show({buttons:t,titleText:r.instant("SELECT_A_HABIT"),cancelText:r.instant("CANCEL"),cancel:function(){},buttonClicked:function(a){if(i&&a==t.length-1)e.startReminder+=o,n(R);else{var r=e.startReminder+a,s=e.habits[r];e.hasReminder(s)?e.cancelReminder(s):(e.habitForReminder=s,datePicker.show({date:new Date,mode:"time",allowOldDates:!0,allowFutureDates:!0},b,G))}return!0}})}function y(){n(N)}function N(){if(e.updating)return void(e.requiresUpdate=!0);e.requiresUpdate=!1;var t=[],o=[];for(var i in e.todaysData){var n=e.todaysData[i],a=+n.options.value;if(a>0&&n.updated){var r=n.habitData;r?h.buildMultiHabitDataUpdateArray(o,n.habit,r,a-1,e.date,void 0,void 0,e.isGoalMet(n.habit)):h.buildMultiHabitDataArray(t,n.habit,a-1,e.date,void 0,void 0,e.isGoalMet(n.habit))}}t.length>0&&(e.updating=!0,h.recordMultiHabitData(t).success(function(){D(!0),e.requiresUpdate?(e.updating=!1,y()):o.length>0?h.updateMultiHabitData(o).success(function(){D(!0),e.updating=!1}).error(function(){e.updating=!1}):e.updating=!1}).error(function(){e.updating=!1})),o.length>0&&0===t.length&&(e.updating=!0,h.updateMultiHabitData(o).success(function(){e.updating=!1,D(!0),e.requiresUpdate&&y(),e.updating=!1}).error(function(){e.updating=!1}))}function M(){for(var t=0;t<e.habits.length;++t){var o=e.habits[t],i=e.todaysData[o.id];i.updated&&(o.goalOrdinal=i.habit.goalOrdinal=i.options.value-1,h.updateGoalOrdinal(o))}D(!1)}function P(t,o,i){var n=t.habitValues;t.goalOrdinal>=n.length&&(t.goalOrdinal=n.length-1);var a,r=n[t.goalOrdinal],s=!1,c=r?!!r.valueString:!1;if(o&&!e.editingGoals){var l=h.getHabitValueById(o.habitValueId);l&&(s=!0,a=l.ordinate+1)}s||(a=e.editingGoals?t.goalOrdinal+1:0),e.todaysData[t.id]||(e.todaysData[t.id]={habit:t,options:{value:a}});var u=e.todaysData[t.id];u.hasData=s,u.habitData=s?o:void 0,u.isString=c,++e.redraw,u.options.floor=0,u.options.ceil=n.length,u.options.step=1,u.updated=a!=u.options.value?!0:!1,i||(u.options.value=a)}e.redraw=0;var C;if(e.date=new Date,e.todaysData={},e.updating=!1,"undefined"==typeof e.editingGoals&&(e.editingGoals=!1),h.setIsEditingHabits(!1),e.$on("event:loginRequired",function(){e.habits=[],e.potentialHabits=[],e.todaysData={}}),e.$on("$ionicView.afterEnter",function(){var o=h.getActiveDate();e.date=o?new Date(o):new Date,D(!1);var i=v.getUserPreference("completed_habits_intro");e.nux||i&&"true"==i?(e.nux=!1,window.StatusBar&&StatusBar.styleLightContent()):(t.$broadcast("event:viewVideo",{video:v.HEALTH_VIDEO}),window.StatusBar&&StatusBar.styleDefault(),e.$on("event:introVideoModalClosed",function(){v.setUserPreference("completed_habits_intro",!0),window.StatusBar&&StatusBar.styleLightContent()}))}),e.getHabitsLevel=function(){return E.getSkillLevel("health")},e.goToSkills=function(){window.openURL("/progress/mood?tab=skills")},e.hasReminder=function(t){return!!e.habitReminders[t.id]},e.getReminderTimeDisplay=function(t){var o=e.habitReminders[t.id];if(o){var i=new Date(1e3*o.at);return moment(i).format("LT")}},e.cancelReminder=function(t){s.eventTrack("cancelHabitReminder",{category:"habits"}),m.cancelHabitReminder(t,function(){delete e.habitReminders[t.id],e.$$phase||e.$apply()})},e.showHelp=function(){var o;o=v.isUMNUser()?[{text:'<i class="icon ion-ios-help-outline"></i> '+r.instant("WHAT_IS_HEALTH")},{text:'<i class="icon ion-ios-play-outline"></i> '+r.instant("WATCH_MILO_IS_BUSY")},{text:'<i class="icon ion-ios-list-outline"></i> '+r.instant("VIEW_COMMON_QUESTIONS")}]:[{text:'<i class="icon ion-ios-help-outline"></i> '+r.instant("WHAT_IS_HEALTH")},{text:'<i class="icon ion-ios-play-outline"></i> '+r.instant("WATCH_MILO_IS_BUSY")},{text:'<i class="icon ion-ios-list-outline"></i> '+r.instant("VIEW_COMMON_QUESTIONS")},{text:'<i class="icon ion-ios-people-outline"></i> '+r.instant("EXPLORE_THE_COMMUNITY")}],f.show({buttons:o,cancelText:r.instant("CANCEL"),cancel:function(){},buttonClicked:function(o){return 0===o?t.$broadcast("event:viewVideo",{video:v.HEALTH_VIDEO}):1===o?v.viewVideo(v.HEALTH_VIDEO):2==o?window.open("http://help.thinkpacifica.com/hc/en-us/sections/200750787-Health","_blank","location=no"):3==o&&e.goToCommunity("health"),!0}})},e.getDateString=function(){var t=T.getDayString(e.date),o=T.getDayString(new Date);if(t==o)return r.instant("TODAY");var i=(new Date).addDays(-1),n=T.getDayString(i);if(t==n)return r.instant("YESTERDAY");e.date.getDay(),e.date.getMonth();return moment(e.date).format("dddd, MMMM Do YYYY")},e.previousDay=function(){if(e.canGoBackwards()){if(e.postHabits(),e.date=e.date.addDays(-1),h.setActiveDate(e.date),!C||e.date<C){var t=e.date.addDays(-6);p.show({template:r.instant("LOADING_HISTORY")+"..."}),C=t,h.findHabitData(t,e.date).success(function(t){p.hide(),h.addHabitData(t),D(!1),++e.redraw}).error(function(){p.hide()}),s.eventTrack("previousDay",{category:"habits"})}D(!1)}},e.nextDay=function(){e.canGoForward()&&(e.postHabits(),e.date=e.date.addDays(1),h.setActiveDate(e.date),s.eventTrack("nextDay",{category:"habits"}),D(!1))},e.canGoBackwards=function(){var t=v.getAccountUser();if(!t||!t.user)return!1;var o=new Date(e.date.getFullYear(),e.date.getMonth(),e.date.getDate()),i=new Date(t.user.createdAtStr),n=new Date(i.getFullYear(),i.getMonth(),i.getDate());return o>n},e.canGoForward=function(){var t=new Date,o=t.addDays(-1);return e.date<o},e.showSlider=function(){return e.editingGoals||!L()},e.navigateToHabit=function(t){if(L()&&!e.editingGoals){var o={habitId:t};e.showingTodaysData()||(o.experiencedDate=e.date),i.go("app.habits-generic",o)}},e.showingTodaysData=function(){var t=new Date,o=new Date(t.getTime()+MILLISECONDS_IN_DAY),i=new Date(t.getTime()-MILLISECONDS_IN_DAY);return e.date>i&&e.date<o},e.getHabitName=function(e){return h.getHabitName(e)},e.getEditHabitText=function(t){return e.editingGoals&&e.canEditHabit(t)?""+r.instant("TAP_TO_EDIT"):""},e.getTodaysHabitsClass=function(){var t=0,o=e.habits;for(var i in o){var n=o[i];1!=n.id&&19!=n.id&&++t}var a=e.getCompletedHabits(),r=100*a/t;return 0===t?"zero":0===r?"zero":r>0&&10>r?"one":r>=10&&20>r?"two":r>=20&&30>r?"three":r>=30&&40>r?"four":r>=40&&50>r?"five":r>=50&&60>r?"six":r>=60&&70>r?"seven":r>=70&&80>r?"eight":r>=80&&90>r?"nine":r>=90&&100>r?"ten":"eleven"},e.getCompletedHabits=function(){for(var t=e.habits,o=0,i=0;i<t.length;++i){var n=t[i];if(1!=n.id&&19!=n.id){var a=e.todaysData[n.id],r=a.options.value;(e.editingGoals||r>0&&h.metGoal(n,r-1))&&++o}}return o},e.removeHabit=function(o){var i=u.confirm({template:'<div class="thisisatest">'+r.instant("HABITS_REMOVE_CONFIRMATION")+"</div>",cancelText:r.instant("CANCEL"),cancelType:"button-default",okText:r.instant("REMOVE"),okType:"button-default"});i.then(function(i){i&&(e.cancelReminder(o),h.removeHabit(o.id).success(function(){h.removeLocalHabit(o.id);for(var i in e.todaysData){var a=e.todaysData[o.id];if(a.habit.id==o.id){delete e.todaysData[o.id];break}}A(),n(function(){t.$broadcast("reCalcViewDimensions")})}).error(function(){u.alert({template:r.instant("HABITS_REMOVING_ACTIVITY_ERROR"),okText:r.instant("OK_GOT_IT"),okType:"button-default"})}))})},e.addHabit=function(o){h.addHabit(o.id,!0).success(function(){h.addLocalHabit(o),D(!1),e.stopAddingActivity(),n(function(){t.$broadcast("reCalcViewDimensions")})}).error(function(){window.alert(r.instant("HABITS_ERROR_ADDING_HABIT"))})},e.moveHabit=function(t,o,i){e.habits.splice(o,1),e.habits.splice(i,0,t),h.reorderHabits(e.habits)},e.isGoalMet=function(t){if(e.editingGoals)return!0;var o=e.todaysData[t.id];return 0===o.options.value?!1:h.metGoal(t,o.options.value-1)},e.hasEntry=function(t){var o=e.todaysData[t.id];return o.options.value>0},e.getRangeBackgroundStyle=function(e){var t=e.habitValues.length+1,o=e.goalOrdinal,i=100/t,n=(o+1)*i,a=e.goalMinimized?"green":"red",r=e.goalMinimized?"red":"green";return"background: repeating-linear-gradient(90deg, grey 0%, grey "+i+"%, "+a+" "+i+"%, "+a+" "+n+"%, "+r+" "+n+"%, "+r+" 100%)"},e.showDailyReminders=function(){e.startReminder=0,R()},e.showOptions=function(t,o){t.preventDefault(),t.stopPropagation();var n,a=e.canEditHabit(o),s=a?"EDIT_ACTIVITY":"CUSTOMIZE_ACTIVITY",c=e.hasReminder(o);n=r.instant(c?"REMOVE_DAILY_REMINDER":"SET_DAILY_REMINDER");var l=[{text:'<i class="icon ion-ios-bell-outline"></i> '+n},{text:'<i class="icon ion-ios-checkmark-outline"></i> '+r.instant("CHANGE_DAILY_GOAL")},{text:'<i class="icon ion-ios-trash-outline"></i> '+r.instant("REMOVE_ACTIVITY")},{text:'<i class="icon ion-ios-compose-outline"></i> '+r.instant(s)}];!e.showHealthkitIntegration()||"Sleep"!=o.name&&"Caffeine"!=o.name&&"Exercise"!=o.name||l.push({text:'<i class="icon ion-social-apple-outline"></i> '+r.instant("SYNC_WITH_APPLE_HEALTH")}),f.show({buttons:l,cancelText:r.instant("CANCEL"),cancel:function(){},buttonClicked:function(t){return 0===t?(e.habitForReminder=o,c?e.cancelReminder(o):datePicker.show({date:new Date,mode:"time",allowOldDates:!0,allowFutureDates:!0},b,G)):1==t?e.editGoals():2==t?e.removeHabit(o):3==t?a?e.editHabit(o,!0):i.go("app.habits-create",{habitName:o.name}):4==t&&e.checkHealthKitModal(),!0}})},e.editGoals=function(){e.postHabits(),e.editingGoals=!e.editingGoals,D(!1),++e.redraw,e.date=new Date},e.canAddHabits=function(){return e.potentialHabits.length>0},e.isHabitDisabled=function(t){return e.canEditHabit(t)&&!v.isPremiumEnabled()},e.canEditHabit=function(e){var t=v.getAccountUser();return t&&t.user&&e.creatorId==t.user.id},e.addHabits=function(){return I.isOnline()?void(e.canAddHabits()&&(h.setIsEditingHabits(!0),i.go("app.habits-add"))):void u.alert({template:r.instant("HABITS_ERROR_OFFLINE"),okText:r.instant("OK_GOT_IT"),okType:"button-default"})},e.goToCreateHabit=function(){return I.isOnline()?void i.go("app.habits-create"):void u.alert({template:r.instant("HABITS_ERROR_OFFLINE"),okText:r.instant("OK_GOT_IT"),okType:"button-default"})},e.editHabit=function(t,o){e.canEditHabit(t)&&(e.editingGoals||o)&&(h.setIsEditingHabits(!0),i.go("app.habits-create",{habitId:t.id}))},e.getHabitData=function(t){return h.getHabitDataByHabitId(e.date,t)},e.getTodaysData=function(t){return e.todaysData[t.id]?e.todaysData[t.id]:void 0},e.getTodaysDataDisplay=function(t){return e.todaysData[t.id]?0===e.todaysData[t.id].options.value?r.instant("NO_DATA"):h.getHabitDisplay(t,e.todaysData[t.id].options.value-1):void 0},e.callbacks={valueUpdated:function(t){var o=e.getTodaysData(t);o.updated=!0,c.resize()},valueSet:function(){e.postHabits()},disabledInteraction:function(){_.showPremiumModal(e,"health","disabledHabitInteraction",!0)}},e.$on("$destroy",function(){e.postHabits()}),e.requiresUpdate=!1,e.postHabits=function(){e.editingGoals?M():N()},e.closeHealthKitModal=function(){v.setUserPreference("integrate_with_healthkit","true"),h.initHealthKit(),closeModal(e.healthKitModal),e.healthKitModal.remove(),e.healthKitModal=void 0},e.showHealthkitIntegration=function(){var t=v.getUserPreference("integrate_with_healthkit");return!e.isUMNUser()&&I.isIos()&&!I.isIPad()&&!t},e.checkHealthKitModal=function(){!I.isIos()||I.isIPad()||e.isUMNUser()||e.showHealthkitIntegration()&&d.fromTemplateUrl("views/habits/habits.healthkitModal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.healthKitModal=t,openModal(e.healthKitModal)})},D(!1),h.requiresHabitDataReload()){var w=e.date.addDays(-6);C=w,p.show({template:r.instant("LOADING_HISTORY")+"..."}),h.findHabitData(w,e.date).success(function(e){p.hide(),h.addHabitData(e),h.clearHabitDataReload()}).error(function(){p.hide()})}}]),t.controller("HabitsTypeCtrl",["$scope","$rootScope","$state","$timeout","$analytics","$stateParams","$translate","$ionicModal","$ionicHistory","$ionicNavBarDelegate","AccountService","HabitsService","GeneralService",function(t,o,i,n,a,r,s,c,l,u,d,p,g){function f(t,o,i,n){var a=0,r=!1,s=n?n:new Date;t.editingHabitData="undefined"!=typeof t.habitDataToEdit;var c=t.editingHabitData?t.habitDataToEdit:o.getHabitDataByHabitId(s,i.id),l=c?o.getHabitValueById(c.habitValueId):void 0;if(l&&!n)if(1==i.frequency)r=!0;else{var u;u="object"==typeof c.experiencedAt?c.experiencedAt.getTime():new Date(c.experiencedAt).getTime();var d=(new Date).getTime();(t.editingHabitData||u>d-3e4)&&(r=!0)}if(r){t.editingHabitData=!0;var p=o.getHabitValueById(c.habitValueId);if(a=p.ordinate,"undefined"!=typeof c.habitSubValueIds&&c.habitSubValueIds.length>0&&i.habitSubValues)for(var f=0;f<i.habitSubValues.length;++f){var v=i.habitSubValues[f];if(c.habitSubValueIds)for(var h=0;h<c.habitSubValueIds.length;++h)if(!(c.habitDataNotes&&c.habitDataNotes.notes&&c.habitDataNotes.notes.indexOf("#"+v.valueString)>=0)&&v.id==c.habitSubValueIds[h]){t.selectedSubValues.push(v);break}}}t.valueData={value:e(i.habitValues[a]),valueIndex:a,hasDaysData:r,habitData:r?c:void 0},r?(t.valueData.userInteracted=!0,c.habitDataNotes&&c.habitDataNotes.notes&&(t.valueData.notes=c.habitDataNotes.notes)):t.valueData.value="?",t.colors=i.goalMinimized?["#ffffff","#ff6669"]:["#ff6669","#5ce59d"],i.goalMinimized&&(t.progressColors=["#5ce59d","#ff6669"]),t.colors.push(i.goalMinimized?"#ff6669":"#ffffff"),1==i.id?t.colors[1]=g.COLORS[t.valueData.valueIndex]:19==i.id&&(t.colors[1]=g.STRESS_COLORS[t.valueData.valueIndex]),t.goalPercentage=i.goalMinimized?(i.goalOrdinal+1)/i.habitValues.length:i.goalOrdinal/i.habitValues.length,t.colorPercentages=[t.goalPercentage,1-t.goalPercentage],t.habitClass=1==i.creatorId?i.name.toLowerCase():"",t.habitName=i.name,t.habitQuestionKey=("HABITS_QUESTION_"+i.name).toUpperCase(),t.habitNotes={notes:""},t.valueData&&t.valueData.notes&&(t.habitNotes.notes=t.valueData.notes)}t.submittingData=!1,t.selectedSubValues=[],t.experiencedDate||(t.experiencedDate=r.experiencedDate?new Date(r.experiencedDate):void 0),t.initialized=!1,n(function(){t.initialized=!0},10),t.habit=p.getAccountHabitValuesById("undefined"==typeof r.habitId?i.current.data.habitId:+r.habitId),t.getInteracted=function(){return t.valueData.userInteracted},t.hasNotes=function(){return t.habitNotes.notes&&t.habitNotes.notes.length>0},t.getHabitValueDisplay=function(){return t.valueData?p.getHabitDisplay(t.habit,t.valueData.valueIndex):void 0},t.checkForGoalTest=function(){return!t.habit.goalMinimized&&t.valueData.valueIndex>=t.habit.goalOrdinal||t.habit.goalMinimized&&t.valueData.valueIndex<=t.habit.goalOrdinal},t.checkForGoal=function(){var e=t.checkForGoalTest();e&&a.eventTrack("reachedHabitGoal",{category:"habits",label:t.habit.name}),19==t.habit.id?(l.currentView(l.backView()),i.go("app.habits-Mood",{habitId:1})):t.goBack()},t.submitData=function(e,o){return"?"==t.valueData.value?void(t.noDataError=!0):(t.noDataError=!1,t.submittingData=!0,void(t.valueData.hasDaysData?(p.updateHabitData(t.habit,t.valueData.habitData,t.valueData.valueIndex,void 0,t.experiencedDate,t.habitNotes.notes,t.checkForGoalTest()).success(function(){t.submittingData=!1,t.checkForGoal(),o&&o()}).error(function(){t.submittingData=!1}),a.eventTrack("updateHabitData",{category:"habits",label:t.habit.name,value:t.valueData.valueIndex})):(p.recordHabitData(t.habit,t.valueData.valueIndex,void 0,t.experiencedDate,t.habitNotes.notes,t.checkForGoalTest()).success(function(e){t.submittingData=!1,t.checkForGoal(),o&&o(e)}).error(function(){t.submittingData=!1}),a.eventTrack("recordHabitData",{category:"habits",label:t.habit.name,value:t.valueData.valueIndex}))))},t.goBack=function(){l.goBack()},t.getHabitHeaderName=function(){var e=t.habitName;return e?s.instant(e.toUpperCase()):void 0},19==t.habit.id&&t.$watch("valueData.valueIndex",function(){if(t.initialized){var e=t.valueData.valueIndex;if(t.lastValueIndex!=e){var o=!1;t.colors[1]!=g.STRESS_COLORS[e]&&(o=!0),t.colors[1]=g.STRESS_COLORS[e],t.lastValueIndex=e,o&&t.valueData.redraw++}}});var v=window.innerHeight,h=!1;t.$watch("valueData.userInteracted",function(){t.valueData.userInteracted&&!h&&(h=!0,n(t.resizeTextArea))}),t.resizeTextArea=function(){var e=$("#habitNote");if(e&&e[0]){var t=e[0].getBoundingClientRect();$("#habitNote").css("height",v-t.top),$("#habitNote").css("min-height",v-t.top)}},f(t,p,t.habit,t.experiencedDate)}]),t.controller("HabitsMoodCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$timeout","$analytics","$translate","$ionicHistory","$ionicModal","$ionicPopup","$ionicScrollDelegate","HabitsService","AccountService","GeneralService","NotificationService","Environment",function(e,t,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T){function m(){var t={};e.recentFeelings=g.getRecentFeelings(),e.presetFeelings=[];for(var i=0;i<o.length;++i){var n=!1,a=c.instant(o[i]);if(!t[a]){t[a]=a;for(var r=0;r<e.recentFeelings.length;++r){var s=e.recentFeelings[r];if(s.valueString==a){n=!0;break}}n||e.presetFeelings.push(a)}}}function E(t){M>t?(t=M,e.experiencedDate=t,d.alert({template:c.instant("MOOD_DATE_BEFORE_CREATION"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})):N>t?(t=N,e.experiencedDate=t,d.alert({template:c.instant("MOOD_DATE_IN_PAST_WARNING"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})):e.experiencedDate=t>y?void 0:t,e.$$phase||e.$apply()}function _(e){}function S(){e.selectedSubValues.length>0?$(".feeling-list").css("margin-top",$(".selected-feelings-wrapper").outerHeight()):$(".feeling-list").css("margin-top",0)}function I(){closeModal(e.notificationModal),e.notificationModal.remove(),e.notificationModal=void 0,e.goBack()}function O(){b=void 0,G=[],R={}}function A(){var t=e.habitNotes.notes;return t&&(t=t.replace(/&nbsp;/gm,""),t=t.replace(/<(?:.|\n)*?>/gm,"")),t}function D(){if(!b&&(b=A(),R={},b)){G=b.split(" ");for(var e=0;e<G.length;++e){var t=G[e];0===t.indexOf("#")&&(t=t.substring(1),t=t.replace(/\W+/g,""),t=t.toLowerCase(),R[t]=t)}}}function L(t,o,i){var n;if(t&&t.length>0){n=[];for(var a=0;a<t.length;++a)n.push(t[a].id)}e.valueData.hasDaysData?(e.editingHabitData&&e.habitDataToEdit&&(e.habitDataToEdit.habitValueId=e.habit.habitValues[e.valueData.valueIndex].id,e.habitDataToEdit.habitSubValueIds=n,e.habitDataToEdit.habitDataNotes?e.habitDataToEdit.habitDataNotes.notes=b:e.habitDataToEdit.habitDataNotes={notes:b},e.updateEditedValue&&e.updateEditedValue()),g.updateHabitData(e.habit,e.valueData.habitData,e.valueData.valueIndex,n,e.experiencedDate,b).success(function(){e.submittingData=!1,e.checkForModal(),o&&o()}).error(function(){e.submittingData=!1,d.alert({template:c.instant("MOOD_ENTRY_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"}),i&&i()}),s.eventTrack("updateHabitData",{category:"habits",label:e.habit.name,value:e.valueData.valueIndex})):(g.recordHabitData(e.habit,e.valueData.valueIndex,n,e.experiencedDate,b).success(function(t){e.submittingData=!1,e.checkForModal(),o&&o(t)}).error(function(){e.submittingData=!1,d.alert({template:c.instant("MOOD_ENTRY_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"}),i&&i()}),s.eventTrack("recordHabitData",{category:"habits",label:e.habit.name,value:e.valueData.valueIndex}))}a("HabitsTypeCtrl",{$scope:e}),e.valueData.redraw=0,e.positive=!0,e.neutral=!1;var b="",G=[],R={};m(),e.newFeelingData={text:""};var y=new Date,N=y.addDays(-6);N.setHours(0,0,0,0);var M=new Date(f.getAccountUser().user.createdAt);e.getMoodDate=function(){return e.experiencedDate?moment(e.experiencedDate).calendar():c.instant("RIGHT_NOW")},e.setMoodDate=function(){if(window.datePicker&&!e.isUMNUser()&&!e.editingHabitData){var t=e.experiencedDate?e.experiencedDate:y;datePicker.show({date:t,mode:"datetime",minDate:M>N?M:N,maxDate:y,allowOldDates:!1,allowFutureDates:!1},E,_)}},e.getMoodColor=function(){return v.COLOR_NAMES[e.valueData.valueIndex]},e.getMoodDisplay=function(){var t="MOOD_"+e.valueData.value;return t=t.replace(" ","_"),c.instant(t)},e.closeFeelingPopup=function(){closeModal(e.feelingModal),e.feelingModal.remove(),e.feelingModal=void 0,r(e.resizeTextArea)},e.showFeelingPopup=function(){return T.isOnline()?void u.fromTemplateUrl("views/habits/habits.customFeeling.popup.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.feelingModal=t,openModal(e.feelingModal),r(S)}):void d.alert({template:c.instant("FEELINGS_OFFLINE_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"})},e.clearCustomFeeling=function(){if(e.selectedCustomFeeling){var t=e.selectedSubValues.indexOf(e.selectedCustomFeeling);t>=0&&e.selectedSubValues.splice(t,1),e.selectedCustomFeeling=void 0}},e.inputFocused=function(){p.scrollTop(!0)},e.filterRecentFeelings=function(t){for(var o=!1,i=0;i<e.selectedSubValues.length;++i){var n=e.selectedSubValues[i];if(n.valueString==t.valueString){o=!0;break}}return!o},e.getFilteredPresetFeelings=function(){if(e.newFeelingData.text.length>0){for(var t=new RegExp(".*"+e.newFeelingData.text.replace(/\s/g,".*")+".*","i"),o=[],i=0;i<e.recentFeelings.length;++i){var n=e.recentFeelings[i];t.test(n.valueString)&&o.push(n.valueString.toLowerCase())}for(var a=0;a<e.presetFeelings.length;++a){var r=e.presetFeelings[a];t.test(r)&&o.push(r)}return o}return e.presetFeelings},e.hasFeelings=function(){var t=!1;for(var o in R){t=!0;break}return e.selectedSubValues.length>0||t},e.getFeelingText=function(){for(var t="",o={},i=0;i<e.selectedSubValues.length;++i){var n=g.getHabitSubValue(e.selectedSubValues,e.selectedSubValues[i].id);o[n]=n}D();for(var a in R)o[a]=a;var r=0;for(var s in o)++r;var c=0;for(var l in o)c>0&&r>2&&(t+=","),t+=" ",t+=" "+l,++c;return t},e.saveCustomFeeling=function(t){var o=t?t:e.newFeelingData.text;if(o&&(o=o.trim()),!o||0===o.length)return void(e.customFeelingError=c.instant("CUSTOM_FEELING_LENGTH_ERROR"));for(var i=0;i<e.selectedSubValues.length;++i){var n=e.selectedSubValues[i];if(n.valueString==o)return void(e.customFeelingError=c.instant("CUSTOM_FELING_EXISTING_ERROR"))}e.customFeelingError=void 0,e.savingCustomFeeling=!0;for(var a=0;a<e.recentFeelings.length;++a){var s=e.recentFeelings[a];if(s.valueString==o)return void e.setCustomFeeling(s)}var l="undefined"!=typeof t;g.saveCustomFeeling(o,l).success(function(t){e.setCustomFeeling(t),e.savingCustomFeeling=!1,r(S)}).error(function(){d.alert({template:c.instant("SAVE_CUSTOM_FEELING_ERROR"),okText:c.instant("OK_GOT_IT"),okType:"button-default"});e.savingCustomFeeling=!0})},e.getNotificationTiming=function(){return e.notificationTiming},e.setNotificationTiming=function(t){e.notificationTiming=t},e.closeNotificationModal=function(t){return t?void I():(e.notificationTiming="after7",f.setUserPreference("notification_timing",e.notificationTiming),void(window.PushNotification?PushNotification.hasPermission(function(t){h.registerNotifications(),t.isEnabled?I():e.grantingPermission=!0},function(){I(),h.registerNotifications()}):(T.isDebug()&&window.alert("No Push Notification Service."),I())))},e.checkForModal=function(){var t=e.valueData.valueIndex;1>=t&&!e.isUMNUser()&&f.checkForRatingPrompt(),"app.habits-Mood"==i.current.name&&e.goBack()},e.notesChanged=function(){O()},e.$watch("valueData.valueIndex",function(){if(e.initialized){var t=e.valueData.valueIndex;if(e.lastValueIndex!=t){var o=!1;e.neutral=3==t,e.positive=2>=t,e.colors[1]!=v.COLORS[t]&&(o=!0),e.colors[1]=v.COLORS[t],e.lastValueIndex=t,o&&e.valueData.redraw++}}}),e.habitSubValues=e.habit.habitSubValues,e.getValueClass=function(){return"value"+(e.valueData.valueIndex+1)},e.setCustomFeeling=function(t){for(var o=!1,i=0;i<e.selectedSubValues.length;++i){var n=e.selectedSubValues[i];if(n.id==t.id){o=!0;break}}o||(e.selectedSubValues.push(t),e.newFeelingData.text="",m(),g.updateMoodHabitSubValues([t]),r(S))},e.removeSelectedSubValue=function(t){for(var o=e.selectedSubValues.length-1;o>=0;--o){var i=e.selectedSubValues[o];if(i.valueString==t){e.selectedSubValues.splice(o,1);break}}r(S),s.eventTrack("removeHabitSubValue",{category:"habits",label:t})},e.submitData=function(t,o,i){if("?"==e.valueData.value)return void(e.noDataError=!0);e.noDataError=!1,e.submittingData=!0,O(),D();var n=[],a=[];for(var r in R){for(var s=!1,l=0;l<e.selectedSubValues.length;++l){var u=e.selectedSubValues[l];if(u.valueString.toLowerCase()==r){n.push(u),s=!0;break}}s||a.push(r)}for(var d=0;d<e.selectedSubValues.length;++d){for(var p=e.selectedSubValues[d],f=!1,v=0;v<n.length;++v){var h=n[v];if(p.id==h.id){f=!0;break}}f||n.push(p)}a.length>0&&T.isOnline()?g.saveCustomFeelings(a).success(function(e){for(var t=0;t<e.length;++t)n.push(e[t]);L(n,o,i)}).error(function(){window.alert(c.instant("SAVE_CUSTOM_FEELING_ERROR")),e.savingMoodData=!1}):L(n,o,i)}}]),t.controller("HabitsMoodHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","HabitsService","AccountService",function(e,t,o,i,n,a,r,s){n("HelpCtrl",{$scope:e}),e.confirm=function(){s.setUserPreference("completed_mood_intro","true"),a.currentView(a.backView()),o.go("app.habits-Mood",{habitId:1},{location:"replace"})
}}]),t.controller("HabitsStressHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","HabitsService","AccountService",function(e,t,o,i,n,a,r,s){n("HelpCtrl",{$scope:e}),e.confirm=function(){s.setUserPreference("completed_mood_intro","true"),a.currentView(a.backView()),o.go("app.habits-Stress",{habitId:19},{location:"replace"})}}]),t.controller("HabitsNux1Ctrl",["$scope","$rootScope","$state","$analytics","$translate","$ionicHistory","$ionicLoading","$ionicPopup","HabitsService",function(e,t,o){e.next=function(){o.go("app.habits-nux2")}}]),t.controller("HabitsNux2Ctrl",["$scope","$rootScope","$controller","$state","$analytics","$translate","$ionicHistory","$ionicLoading","$ionicPopup","HabitsService","AccountService","Environment",function(e,t,o,i,n,a,r,s,c,l,u,d){o("HabitsAddCtrl",{$scope:e});for(var p=[2,3,4],g=0;g<e.potentialHabits.length;++g){var f=e.potentialHabits[g];p.indexOf(f.id)>=0&&(e.habitsToAdd[f.id]=f)}e.next=function(){if(!d.isOnline())return void c.alert({template:a.instant("HABITS_ERROR_OFFLINE"),okText:a.instant("OK_GOT_IT"),okType:"button-default"});var t=!1;for(var o in e.habitsToAdd){t=!0;break}t?(e.errorMessage=void 0,e.addHabits(!1,function(){u.setUserPreference("completed_habits_intro",!0),i.go("app.habits")})):e.errorMessage=a.instant("SELECT_HABIT_TO_ADD")}}]),t.controller("HabitsNux3Ctrl",["$scope","$rootScope","$controller","$state","$analytics","$translate","$ionicHistory","$ionicLoading","$ionicPopup","HabitsService","AccountService",function(e,t,o,i,n,a,r,s,c,l,u){e.removeEmptyState=!0,e.nux=!0,e.editingGoals=!0,o("HabitsCtrl",{$scope:e}),window.StatusBar&&StatusBar.styleDefault(),e.finishNUX=function(){e.postHabits(),u.setUserPreference("completed_habits_intro",!0),i.go("app.habits")}}]),t.controller("HabitsCreateCtrl",["$scope","$rootScope","$state","$stateParams","$analytics","$translate","$ionicHistory","$ionicLoading","$ionicPopup","$ionicScrollDelegate","AccountService","HabitsService","PayService",function(e,t,o,i,n,a,r,s,c,l,u,d,p){window.StatusBar&&StatusBar.styleDefault(),e.updating=!1,e.editingHabit=!1,e.showDelete=!1,e.showReorder=!1;var g=!1;if(e.createInputFocused=function(t){g||u.isPremiumEnabled()||(p.showPremiumModal(e,"health","createActivity",!0),g=!0,t&&$(t.target).blur())},e.toggleDelete=function(){e.showReorder=!1,e.showDelete=!e.showDelete},e.toggleReorder=function(){e.showDelete=!1,e.showReorder=!e.showReorder},i.habitId){var f=+i.habitId;e.habit=d.getAccountHabitById(f),e.editingHabit=!0}else e.habit={name:i.habitName?i.habitName:"",goalOrdinal:1,goalMinimized:!1,habitValues:[{valueString:void 0},{valueString:void 0}]};e.isGoalMet=function(t){return d.metGoal(e.habit,t)},e.setGoal=function(t){e.habit.goalOrdinal=e.habit.goalMinimized?t<=e.habit.goalOrdinal&&t>0?t-1:t>0?t:0:t<e.habit.goalOrdinal?t:1==e.habit.habitValues.length?1-e.habit.goalOrdinal:t<e.habit.habitValues.length-1?t+1:e.habit.habitValues.length-1},e.toggleGoalMinimized=function(){e.habit.goalMinimized=!e.habit.goalMinimized,e.habit.goalMinimized?--e.habit.goalOrdinal:++e.habit.goalOrdinal},e.addHabitValue=function(){e.habit.habitValues.push({valueString:""}),l.resize()},e.removeHabitValue=function(t){if(0===t&&1==e.habit.habitValues.length)e.habit.habitValues[0].valueString=void 0;else{var o=e.habit.habitValues[t];o.active=!1,e.habit.habitValues.splice(t,1),e.habit.goalOrdinal>=e.habit.habitValues.length&&(e.habit.goalOrdinal=e.habit.habitValues.length-1),0===e.habit.habitValues.length&&(e.showDelete=!1)}},e.moveHabitValue=function(t,o,i){e.habit.habitValues.splice(o,1),e.habit.habitValues.splice(i,0,t)},e.createHabit=function(){if(!u.isPremiumEnabled())return void p.showPremiumModal(e,"health","createActivity",!0);if(e.habit.name=e.habit.name.trim(),0===e.habit.name.length)return void(e.errorMessage=a.instant("CREATE_HABIT_ERROR_MISSING_NAME"));if(e.habit.habitValues.length<=1)return void(e.errorMessage=a.instant("CREATE_HABIT_ERROR_NO_VALUES"));for(var t=0;t<e.habit.habitValues.length;++t){var o=e.habit.habitValues[t];if(o.valueString&&(o.valueString=o.valueString.trim()),!o.valueString||0===o.valueString.length)return void(e.errorMessage=a.instant("CREATE_HABIT_ERROR_MISSING_VALUE"))}e.updating||(e.updating=!0,e.errorMessage=void 0,e.editingHabit?d.editHabit(e.habit).success(function(){e.updating=!1,r.goBack()}).error(function(){e.updating=!1,c.alert({template:a.instant("HABITS_ERROR_EDITING_HABIT"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})}):d.createHabit(e.habit,!0).success(function(){e.updating=!1,r.goBack()}).error(function(){e.updating=!1,c.alert({template:a.instant("HABITS_ERROR_CREATING_HABIT"),okText:a.instant("OK_GOT_IT"),okType:"button-default"})}))}}]),t.controller("HabitsAddCtrl",["$scope","$rootScope","$state","$analytics","$translate","$ionicHistory","$ionicLoading","$ionicPopup","HabitsService","AccountService","PayService",function(e,t,o,i,n,a,r,s,c,l,u){window.StatusBar&&StatusBar.styleDefault(),e.goBack=function(){window.StatusBar&&StatusBar.styleLightContent(),a.goBack()},e.habits=c.getAccountHabits(),e.potentialHabits=c.getPotentialAccountHabits(),e.potentialHabits.sort(function(e,t){return e.id-t.id}),e.habitsToAdd=[];var d=c.getHabitsToAdd();d&&(e.habitsToAdd=d),c.clearHabitsToAdd();for(var p=c.getCreatedHabits(),g=0;g<p.length;++g){var f=p[g];e.habitsToAdd[f.id]=f}c.clearCreatedHabits(),e.canCreateHabit=function(){return l.isPremiumEnabled()},e.createHabit=function(){return e.canCreateHabit()?(c.setHabitsToAdd(e.habitsToAdd),void o.go("app.habits-create")):void u.showPremiumModal(e,"health","createActivity",!0)},e.getHabitName=function(e){return c.getHabitName(e)},e.toggleHabit=function(t){e.habitsToAdd[t.id]?delete e.habitsToAdd[t.id]:e.habitsToAdd[t.id]=t,e.addHabits(!0)},e.isAddingHabit=function(t){return e.habitsToAdd[t.id]},e.isOwnedHabit=function(e){return e.creatorId==l.getAccountUser().user.id},e.deleteCustomHabit=function(t,o){t.stopPropagation(),t.preventDefault();var i=s.confirm({template:"<div>"+n.instant("CUSTOM_HABIT_REMOVE_CONFIRMATION")+"</div>",cancelText:n.instant("CANCEL"),cancelType:"button-default",okText:n.instant("DELETE"),okType:"button-default"});i.then(function(t){t&&(r.show({template:n.instant("HABITS_REMOVING_ACTIVITY")+"..."}),c.deleteCustomHabit(o.id).success(function(){e.potentialHabits=c.getPotentialAccountHabits(),r.hide()}).error(function(){s.alert({template:n.instant("HABITS_REMOVING_ACTIVITY_ERROR"),okText:n.instant("OK_GOT_IT"),okType:"button-default"}),r.hide()}))})},e.addHabits=function(t,o){var l=[];for(var u in e.habitsToAdd){var d=e.habitsToAdd[u];l.push(d.id)}l.length>0?(r.show({template:n.instant("HABITS_ADDING_ACTIVITY")+"..."}),c.addHabits(l,!0).success(function(){for(var i in e.habitsToAdd){var n=e.habitsToAdd[i];c.addLocalHabit(n)}r.hide(),t&&(window.StatusBar&&StatusBar.styleLightContent(),a.goBack()),o&&o()}).error(function(){s.alert({template:n.instant("HABITS_ERROR_ADDING_HABIT"),okText:n.instant("OK_GOT_IT"),okType:"button-default"})}),i.eventTrack("addHabits",{category:"habits"})):(t&&a.goBack(),o&&o())}}]),t.controller("HabitsHelpCtrl",["$scope","$rootScope","$state","$stateParams","$translate","$ionicHistory","HabitsService","AccountService",function(e,t,o,i,n,a,r,s){e.$on("$ionicView.afterEnter",function(){window.StatusBar&&StatusBar.styleDefault()}),e.$on("$ionicView.beforeLeave",function(){window.StatusBar&&StatusBar.styleLightContent()}),e.intro=!1,i.intro&&(e.intro=i.intro),e.getHabitsHelpLine1=function(){var t=n.instant("HABITS_HELP_LINE_1");return e.isUMNUser()&&(t=t.replace("mood","stress level and mood")),t},e.getHabitsHelpLine2=function(){var t=n.instant("HABITS_HELP_LINE_2");return e.isUMNUser()&&(t=t.replace("mood","stress level and mood")),t},e.confirm=function(){s.setUserPreference("completed_habits_intro","true"),e.intro?(a.currentView(a.backView()),o.go("app.habits",{},{location:"replace"})):t.$ionicGoBack()},e.habits=r.getAccountHabits(),r.removeMoodHabit(e)}]),t.controller("HabitsConfigCtrl",["$scope","$timeout","$analytics","$translate","$ionicHistory","HabitsService",function(e,t,o,i,n,a){e.goalUpdated=!1,e.habits=a.getAccountHabits().slice();for(var r=e.habits.length-1;r>=0;--r){var s=e.habits[r];("Medication"==s.name||"Hygiene"==s.name)&&e.habits.splice(r,1)}e.goBack=function(){n.goBack()},e.getGoalDisplay=function(e){return a.getHabitDisplayFromValue(e)},e.getHabitValues=function(e){var t=e.habitValues.slice();return"Sleep"==e.name?t=t.slice(2):"Exercise"==e.name||"Eating"==e.name||"Water"==e.name||"Outdoors"==e.name||"Family"==e.name||"Friends"==e.name||"Pets"==e.name||"Relationship"==e.name||"Hobbies"==e.name||"Meditation"==e.name?t=t.slice(1):"Alcohol"==e.name||"Caffeine"==e.name||"Cigarettes"==e.name?t=t.slice(0,t.length-2):"Cannabis"==e.name&&(t=t.slice(0,t.length-1)),t},e.updateGoal=function(i){a.updateGoalOrdinal(i).success(function(){e.goalUpdated=!0,t(function(){e.goalUpdated=!1},3e3)}),o.eventTrack("updateHabitGoal",{category:"habits",label:i.name,value:i.goalOrdinal})}}])}();var ctrl=angular.module("helpCtrl",[]);ctrl.controller("HelpCtrl",["$scope","$state","$http","$stateParams","AccountService",function(e,t,o,i){window.StatusBar&&StatusBar.styleDefault(),e.$on("$destroy",function(){window.StatusBar&&StatusBar.styleLightContent()}),e.intro=!1,i.intro&&(e.intro=i.intro)}]),function(){function e(){i&&i()}function t(t,o){a||(a=!0,t.on("resume",e)),i=o}function o(){i=void 0}var i,n=angular.module("homeCtrl",[]),a=!1,r=!1;n.controller("HomeCtrl",["$sce","$scope","$rootScope","$controller","$state","$http","$analytics","$timeout","$translate","$ionicModal","$ionicPopup","$ionicPopover","$ionicPlatform","$ionicHistory","$ionicSlideBoxDelegate","$ionicScrollDelegate","HabitsService","AccountService","GoalsService","GroupsService","PayService","SkillsService","NotificationService","GeneralService","Environment",function(e,i,n,a,s,c,l,u,d,p,g,f,v,h,T,m,E,_,S,I,O,A,D,L,b){function G(){i.grantingPermission=!1,i.savingNotifications=!1,_.setUserPreference("notification_timing","after7"),i.$$phase||i.$apply()}function R(){i.grantingPermission=!1,i.savingNotifications=!1,i.$$phase||i.$apply()}function y(){if(_.isLoggedIn()){var e=_.getUserPreference("last_nux_state");e&&""!==e&&"completed"==e?(i.nux=!1,window.StatusBar&&StatusBar.styleLightContent(),i.setHideTabs(!1)):(a("BackgroundsCtrl",{$scope:i}),$(".item").css("color","#fefefe"),u(function(){$(".item").css("color",""),T.update()}),i.nux=!0,i.setHideTabs(!0),i.lockNux=!1,window.StatusBar&&StatusBar.styleDefault(),i.getNotificationsLine3=function(){var e=d.instant("MOOD_NOTIFICATIONS_LINE_3");return i.isUMNUser()&&(e=e.replace("mood","stress level, mood,")),e},i.getName=function(){return _.getAccountUser().user.name},i.grantingPermission=!1,i.handleNotificationRegistration=function(){i.savingNotifications=!0,D.registerNotifications(G,R)},i.nuxSlideChanged=function(e){T.enableSlide(2==e&&i.grantingPermission?!1:!0)},i.nextNuxSlide=function(){T.next()},window.PushNotification?PushNotification.hasPermission(function(e){e.isEnabled?D.registerNotifications(G,R):i.grantingPermission=!0},function(){D.registerNotifications(G,R)}):b.isDebug()&&window.alert("No Push Notification Service."),T.update())}}function N(e){A.recreateTodaysActions(),r&&u(function(){A.checkForLevelUp(function(e){i.newLevels=e})},500),e&&(r=!0),i.todaysActionList=A.getTodaysActions(),y()}function M(e){var t=i.suggestedActivities[e];if(t){t.sort(function(e,t){return e.sort-t.sort});for(var o,n=_.getUserPreference("completed_core_activity"),a=!n,r=0;r<t.length&&(o=t[r],a&&_.isActivityPremium(o.id));++r);return o}}i.nux=!1,i.newLevels=0,i.savingNotifications=!1,i.closeNux=function(){i.nux=!1,window.StatusBar&&StatusBar.styleLightContent(),i.setHideTabs(!1),_.setUserPreference("last_nux_state","completed")},v.ready(function(){N(!1)}),n.$on("event:userContextInitialized",function(){N(!0)}),i.$on("$ionicView.afterEnter",function(){window.plugins&&window.plugins.bgVideo&&window.plugins.bgVideo.releaseAudio(),A.setSuggestedActivityId(void 0)}),i.resumeListener=function(){i.$$phase||i.$apply()},t(v,i.resumeListener),i.$on("$destroy",function(){o()}),i.$on("event:viewAttempt",function(){i.viewAttempt||(i.viewAttempt=!0,u(function(){i.viewAttempt=!1},2e3))}),E.setActiveDate(void 0),window.StatusBar&&_.getAccountUser().user&&!i.nux&&StatusBar.styleLightContent(),i.showPremiumModal=function(e){O.showPremiumModal(i,"home",e,!0)},i.isShowingActions=function(){var e=_.getUserPreference("display_action_feed");return!e||"true"==e},i.toggleActions=function(){i.isShowingActions()?(_.setUserPreference("display_action_feed",!1),m.resize()):(_.setUserPreference("display_action_feed",!0),m.resize())},i.closeActionsModal=function(){i.actionsModal&&(closeModal(i.actionsModal),i.actionsModal.remove(),i.actionsModal=void 0)},i.showActionPanel=function(){A.setSuggestedActivityId(void 0),i.hideActionsTooltip(),i.suggestedActivities={},i.energyLevel="",p.fromTemplateUrl("views/skills/actions.modal.html",{scope:i,animation:"slide-in-up"}).then(function(e){i.actionsModal=e,openModal(i.actionsModal)})},i.getSuggestedActivityId=function(e){var t=M(e);return t?t.id:void 0},i.getSuggestedActivities=function(e){var t=M(e);if(t){var o="";return o=t.display?d.instant(t.display):_.getDisplayForActivity(t.id)}},i.checkSuggestSub=function(e){var t=i.suggestedActivities[e];return t?!0:!1};for(var P=[],C=0;50>C;++C)P[C]=Math.random();i.setEnergyLevel=function(e){var t,o=E.getTodaysLastMoodEntry();t="Not Good"==o||"Bad"==o||"Awful"==o?"low":"Good"==o||"Okay"==o?"medium":"high",i.suggestedActivities={};var n=0;return i.energyLevel==e?void(i.energyLevel=void 0):(i.energyLevel=e,void(i.suggestedActivities="low"==e?"low"==t?{relax:[{id:"COMPLETED_CALM_BREATHE",sort:P[n++]},{id:"COMPLETED_DIFFICULT_EXPERIENCE",sort:P[n++]},{id:"COMPLETED_SELF_COMPASSION",sort:P[n++]}]}:"medium"==t?{relax:[{id:"COMPLETED_MUSCLE_RELAXATION",sort:P[n++]},{id:"COMPLETED_MINDFUL_SENSES",sort:P[n++]},{id:"COMPLETED_MINDFUL_BODY_SCAN",sort:P[n++]},{id:"COMPLETED_POSITIVE_VISUALIZATION",sort:P[n++]}],habits:[{display:"SUGGESTED_ACTIVITY_GO_FOR_A_WALK",sort:P[n++]},{display:"SUGGESTED_ACTIVITY_GET_SOME_EXERCISE",sort:P[n++]}]}:{relax:[{id:"COMPLETED_POSITIVE_VISUALIZATION",sort:P[n++]},{id:"COMPLETED_MINDFUL_SENSES",sort:P[n++]},{id:"COMPLETED_MINDFUL_BODY_SCAN",sort:P[n++]}],habits:[{display:"SUGGESTED_ACTIVITY_GO_FOR_A_WALK",sort:P[n++]},{display:"SUGGESTED_ACTIVITY_GET_SOME_EXERCISE",sort:P[n++]}],goals:[{display:"SUGGESTED_ACTIVITY_NON_SOCIAL_GOALS",sort:P[n++]}]}:"medium"==e?"low"==t?{relax:[{id:"COMPLETED_CALM_MIND",sort:P[n++]},{id:"COMPLETED_DEFUSION",sort:P[n++]},{id:"COMPLETED_BECOMING_THE_TREE",sort:P[n++]}],thoughts:[{id:"COMPLETED_RETHINK",sort:P[n++]}]}:"medium"==t?{thoughts:[{id:"COMPLETED_RETHINK",sort:P[n++]}],habits:[{display:"SUGGESTED_ACTIVITY_GO_FOR_A_WALK",sort:P[n++]},{display:"SUGGESTED_ACTIVITY_GET_SOME_EXERCISE",sort:P[n++]}]}:{relax:[{id:"COMPLETED_GRATITUDE",sort:P[n++]}],thoughts:[{id:"COMPLETED_POSITIVITY_JOURNAL",sort:P[n++]}],goals:[{display:"SUGGESTED_ACTIVITY_ANY_GOALS",sort:P[n++]}]}:"low"==t?{habits:[{display:"SUGGESTED_ACTIVITY_GO_FOR_A_WALK",sort:P[n++]},{display:"SUGGESTED_ACTIVITY_GET_SOME_EXERCISE",sort:P[n++]}],thoughts:[{id:"COMPLETED_RETHINK",sort:P[n++]}],goals:[{display:"SUGGESTED_ACTIVITY_NON_SOCIAL_GOALS",sort:P[n++]}]}:"medium"==t?{thoughts:[{id:"COMPLETED_RETHINK",sort:P[n++]}],goals:[{display:"SUGGESTED_ACTIVITY_SOCIAL_GOALS",sort:P[n++]}]}:{relax:[{id:"COMPLETED_MINDFUL_WALK",sort:P[n++]}],thoughts:[{id:"COMPLETED_POSITIVITY_JOURNAL",sort:P[n++]},{id:"COMPLETED_GRATITUDE_JOURNAL",sort:P[n++]}],goals:[{display:"SUGGESTED_ACTIVITY_ANY_GOALS",sort:P[n++]}]}))},i.isPremiumEnabled=function(){return _.isPremiumEnabled()},i.getSubClass=function(e){return e.skillSubClass?e.skillSubClass:""},i.getActionTitle=function(e){return"health"==e.actionClass?d.instant("HEALTHY_HABIT")+": "+e.actionTitle:e.actionTitle},i.getActionClass=function(e){return e.actionClass},i.getActionTimeDisplay=function(e){return moment(e.actionTimestamp).calendar()},i.slideLeft=function(){T.previous()},i.slideRight=function(){T.next()},i.getCharacterSplitTestClass=function(){var e=_.getSplitTestContext();if(!e||!e.splitTestGroups)return"characters_B";var t=e.splitTestGroups.illustratedCharacters;return t?"characters_"+t:void 0},i.updateLastActivity=function(){_.getAccountUser().user},i.goToAccount=function(){i.closeActionsModal(),s.go("app.account")},i.goToProgress=function(){i.closeActionsModal();var e={};i.newLevels>0&&(e.tab="skills"),s.go("app.progress-mood",e),i.newLevels=0},i.hasCompletedIntro=function(){return!_.viewedVideoToday()&&i.hasViewedVideo(6)},i.hasViewedVideo=function(e){return _.hasViewedVideo(e)},i.$on("event:goToActivity",function(e,t){var o=t.activity;"mood"==o?i.goToMood():"relax"==o?i.goToRelax():"thoughts"==o?i.goToThoughts():"goals"==o?i.goToGoals():"health"==o?i.goToHabits():"communities"==o&&i.goToCommunities()}),i.showMoodTooltip=function(){var e=_.getUserPreference("viewed_mood_tooltip");return e&&"true"==e?void 0:!0},i.hideMoodTooltip=function(){_.setUserPreference("viewed_mood_tooltip",!0)},i.showActionsTooltip=function(){var e=!1;if(!i.showMoodTooltip()&&!i.isUMNUser()){var t=_.getUserPreference("viewed_mood_actions_tooltip");e=!t||"true"!=t}return e},i.hideActionsTooltip=function(){_.setUserPreference("viewed_mood_actions_tooltip",!0)},i.showRelaxTooltip=function(){var e=!1;return e},i.hideRelaxTooltip=function(){_.setUserPreference("viewed_relax_tooltip",!0)},i.goToMood=function(){i.closeActionsModal(),i.hideMoodTooltip();var e=_.getUserPreference("completed_mood_intro");e&&"true"==e?i.isUMNUser()?s.go("app.habits-Stress",{habitId:19}):s.go("app.habits-Mood",{habitId:1}):(window.pauseVideo(),n.$broadcast("event:viewVideo",{video:_.MOOD_VIDEO}),u(function(){_.setUserPreference("completed_mood_intro",!0)},500))},i.goToHabits=function(e){A.setSuggestedActivityId(e),i.closeActionsModal(),window.openURL("/habits")},i.goToRelax=function(e){i.closeActionsModal(),A.setSuggestedActivityId(e),window.openURL("/relax")},i.goToGroups=function(){if(i.closeActionsModal(),b.isOnline())window.openURL("/groups");else{g.alert({template:d.instant("GROUPS_OFFLINE_ERROR"),okText:d.instant("OK_GOT_IT"),okType:"button-default"})}},i.goToCommunities=function(){if(i.closeActionsModal(),b.isOnline())window.openURL("/communities");else{g.alert({template:d.instant("GROUPS_OFFLINE_ERROR"),okText:d.instant("OK_GOT_IT"),okType:"button-default"})}},i.showThoughts=function(){return i.hasViewedMoodPopup()&&!i.isPacificaLiteUser()},i.goToThoughts=function(e){i.closeActionsModal(),A.setSuggestedActivityId(e);var t=_.getUserPreference("completed_rethink_intro");t&&"true"==t?s.go("app.thoughts-list"):(window.pauseVideo(),n.$broadcast("event:viewVideo",{video:_.THOUGHTS_VIDEO}),_.setUserPreference("completed_rethink_intro",!0))},i.showGoals=function(){return i.hasViewedMoodPopup()&&!i.isPacificaLiteUser()},i.canSkipVideos=function(){var e=_.getUserPreference("can_skip_intro_videos");return"undefined"!=typeof e&&"true"===e},i.goToGoals=function(e){i.closeActionsModal(),A.setSuggestedActivityId(e);var t=_.getUserPreference("completed_goals_intro");t&&"true"==t?s.go("app.goals"):(window.pauseVideo(),n.$broadcast("event:viewVideo",{video:_.GOALS_VIDEO}),_.setUserPreference("completed_goals_intro",!0))},i.goToMeditate=function(){i.closeActionsModal();var e=_.getUserPreference("completed_meditate_intro");e&&"true"==e?s.go("app.meditate"):s.go("app.meditate-help",{intro:!0})},i.hasViewedMoodPopup=function(){var e=_.getUserPreference("completed_mood_intro");return e&&"true"==e},i.hasCompletedMood=function(){var e=_.getUserPreference("viewed_mood_popup");return!!e&&"?"!=E.getTodaysLastMoodEntry()};var w;i.showActivities=function(){var e=_.getUserPreference("viewed_mood_popup");return"undefined"==typeof e||w&&e==w||T.update(),w=e,!!e},i.getActivityName=function(){return d.instant(i.isUMNUser()?"STRESS_ACTIVITY":"MOOD_ACTIVITY")},i.getTodaysLastMoodEntry=function(){var e=E.getTodaysLastMoodEntry();return e=e.replace(" ","_"),d.instant("MOOD_"+e)},i.getTodaysMoodClass=function(){return E.getTodaysMoodClass()},i.getTodaysLastMoodEntryClass=function(){return E.getTodaysLastMoodEntryClass()}}])}();var ctrl=angular.module("languageCtrl",[]);ctrl.controller("LanguageCtrl",["$scope","$state","$http","$timeout","$analytics","$ionicLoading","$ionicPopup","AccountService","HabitsService","GoalsService","AudioService","PayService","Environment","Token",function(e,t,o,i,n,a,r,s){e.languageUpdated=!1,e.data={},e.data.locale=s.getUserPreference("preferred_locale"),e.data.locale="undefined"==typeof e.data.locale?"en":e.data.locale.toLowerCase(),e.updateLanguage=function(){s.setLocale(e.data.locale).success(function(){e.languageUpdated=!0,i(function(){e.languageUpdated=!1},3e3)})}}]),function(){var e=angular.module("loginCtrl",[]);e.controller("LoginCtrl",["$sce","$scope","$rootScope","$state","$timeout","$translate","$ionicPopup","$ionicModal","$ionicLoading","$ionicPlatform","$ionicSlideBoxDelegate","$ionicScrollDelegate","authHttp","AccountService","HabitsService","GoalsService","AudioService","PayService","NotificationService","MediaService","GroupsService","SkillsService","GeneralService","Environment",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T,m,E,_,S,I,O){function A(){if(window.StatusBar){{u.$getByHandle("login-slides").currentIndex()}t.creatingAccount?StatusBar.styleDefault():StatusBar.styleLightContent()}}function D(){return t.loginData.email?I.isEmailValid(t.loginData.email)?!0:(t.errorMessage=a.instant("LOGIN_ERROR_INVALID_EMAIL"),n(function(){$("#loginEmail").focus()}),!1):(t.errorMessage=a.instant("LOGIN_ERROR_MISSING_EMAIL"),n(function(){$("#loginEmail").focus()}),!1)}window.$ionicScrollDelegate=d,$("#communitiesPopover").hide(),t.$on("$ionicView.enter",function(){window.StatusBar&&StatusBar.styleLightContent()}),t.loading=!1,t.loginError=!1,t.errorMessage="",t.loginData={},t.signUpData={},t.popup=void 0,t.resetMode=!1,t.userGoal=void 0,t.creatingAccount=!1,t.getLoginTosHTML=function(){return e.trustAsHtml(a.instant("LOGIN_TOS_AGREEMENT"))},t.closePopup=function(){t.popup&&(t.popup.close?t.popup.close():(t.popup.hide(),t.popup.remove())),t.popup=void 0,window.Keyboard&&window.Keyboard.close(),window.StatusBar&&A()},t.advanceSlide=function(){u.$getByHandle("login-slides").next(),A()},t.slideHasChanged=function(e){0===e&&(t.creatingAccount=!1,n(function(){u.$getByHandle("login-slides").update()},20))},t.getSlideIndex=function(){var e="slide"+u.$getByHandle("login-slides").currentIndex();return e},t.startOver=function(){t.creatingAccount=!1,t.userGoal=void 0,t.groupId=void 0,u.$getByHandle("login-slides").update(),u.$getByHandle("login-slides").slide(0),A()},t.setGoal=function(e){t.userGoal=e},t.getGoal=function(){return t.userGoal},t.storeGoal=function(){return t.userGoal?(t.goalError=!1,void t.advanceSlide()):void(t.goalError=!0)},t.toggleResetMode=function(){t.resetMode=!t.resetMode,$(".resetPasswordButton").text(a.instant(t.resetMode?"RESET_PASSWORD":"LOGIN_SIGN_IN")),n(function(){$("#loginEmail").focus(),window.Keyboard&&window.Keyboard.show()})},t.showLogin=function(){return O.isOnline()?(t.resetMode=!1,t.errorMessage="",void(t.popup=r.show({template:'<a href="javascript:;" ng-click="closePopup()" class="go-back">X</a><form name="loginForm" id="loginForm" ng-submit="login()" ><label class="item item-input"><input type="email" placeholder="{{ \'EMAIL\' | translate }}" ng-model="loginData.email" name="email" id="loginEmail" tabindex="1" autofocus></label><label class="item item-input" ng-show="!resetMode"><input type="password" placeholder="{{ \'PASSWORD\' | translate }}" ng-model="loginData.password" tabindex="2" id="loginPassword" name="password"></label><a href="javascript:;" style="padding-left: 15px;" ng-click="toggleResetMode()">{{resetMode ? "CANCEL_LOWER" : "FORGOT_PASSWORD" | translate}}</a><input type="submit" style="visibility:hidden; display: block; padding: 0; margin: 0; height:0; line-height: 0; width: 0;" ng-disabled="loading"></form><div class="error" style="padding-left: 15px;" ng-show="loginError">{{errorMessage}}</div>',title:"",scope:t,buttons:[{text:'<span class="resetPasswordButton">'+a.instant("LOGIN_SIGN_IN")+"</span>",type:"button-default",onTap:function(e){t.resetMode?t.resetPassword():t.login(),e.preventDefault()}}]}))):void r.alert({template:'<div class="pw-pop">'+a.instant("LOGIN_MUST_BE_ONLINE")+"</div>",okText:a.instant("OK_GOT_IT"),okType:"button-default"})},t.closeTermsOfServiceModal=function(){t.tosModal.hide(),t.tosModal.remove(),t.tosModal=void 0},window.showTermsOfService=function(){t.tosModal&&t.tosModal.remove(),s.fromTemplateUrl("views/tos.popup.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.tosModal=e,openModal(t.tosModal)})},t.closePrivacyModal=function(){t.privacyModal.hide(),t.privacyModal.remove(),t.privacyModal=void 0},window.showPrivacyPolicy=function(){t.privacyModal&&t.privacyModal.remove(),s.fromTemplateUrl("views/privacy.popup.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.privacyModal=e,openModal(t.privacyModal)})},t.showCreateSlides=function(){t.creatingAccount=!0,A(),u.$getByHandle("login-slides").update(),n(function(){u.$getByHandle("login-slides").update(),n(function(){u.$getByHandle("login-slides").slide(1)})})},t.showCreateUser=function(){return O.isOnline()?t.userGoal?(t.errorMessage="",s.fromTemplateUrl("views/account/account.createUser.popup.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.popup=e,openModal(t.popup)}),void n(function(){$("#createUserName").focus()},500)):void(t.goalError=!0):void r.alert({template:'<div class="pw-pop">'+a.instant("LOGIN_MUST_BE_ONLINE")+"</div>",okText:a.instant("OK_GOT_IT"),okType:"button-default"})},t.resetPassword=function(){t.loginError=!1,t.errorMessage="";var e=D();return e?(t.loading=!0,c.show({template:a.instant("LOGIN_REQUESTING_PASSWORD_RESET")}),void g.resetPassword(t.loginData.email).success(function(){c.hide(),t.loading=!1,t.closePopup(),n(function(){r.alert({title:a.instant("CHECK_EMAIL"),template:'<div class="pw-pop">'+a.instant("LOGIN_RESET_PASSWORD_CHECK_EMAIL")+"</div>",okText:a.instant("OK_GOT_IT"),okType:"button-default"})},100)}).error(function(){c.hide(),t.loading=!1,t.loginError=!0,t.errorMessage=a.instant("LOGIN_ERROR_RESET_PASSWORD")})):void(t.loginError=!0)},t.login=function(){t.loginError=!1,t.errorMessage="";var e=D();return e?(t.loginData.password||(t.errorMessage=a.instant("LOGIN_ERROR_MISSING_PASSWORD"),document.getElementById("loginPassword").focus()),""!==t.errorMessage?void(t.loginError=!0):(t.loading=!0,c.show({template:a.instant("LOGIN_SIGNING_IN")}),void g.login(t.loginData.email,t.loginData.password).success(function(e,n,a){window.checkedPasscode=!0,c.hide(),t.loading=!1,g.updateToken(a),initializeUserContext(e,o,g,f,v,h,T,m,S,O),i.go("app.home",{},{location:"replace"}),t.closePopup()}).error(function(e,o){c.hide(),t.loading=!1,t.loginError=!0,t.errorMessage=a.instant(401==o?"LOGIN_ERROR_INVALID_CREDENTIALS":"LOGIN_ERROR_GENERIC")}))):void(t.loginError=!0)},t.useSuggestedEmail=function(){t.signUpData.email=t.suggestedEmail,t.createUser(!0)},t.createUser=function(e){return t.loginError=!1,t.errorMessage="",t.signUpData.name?t.signUpData.email?I.isEmailValid(t.signUpData.email)?t.signUpData.password?t.signUpData.password.length<8&&(t.errorMessage=a.instant("LOGIN_ERROR_PASSWORD_LENGTH"),document.getElementById("createUserPassword").focus()):(t.errorMessage=a.instant("LOGIN_ERROR_MISSING_PASSWORD"),document.getElementById("createUserPassword").focus()):(t.errorMessage=a.instant("LOGIN_ERROR_INVALID_EMAIL"),document.getElementById("createUserEmail").focus()):(t.errorMessage=a.instant("LOGIN_ERROR_MISSING_EMAIL"),document.getElementById("createUserEmail").focus()):(t.errorMessage=a.instant("LOGIN_ERROR_MISSING_NAME"),document.getElementById("createUserName").focus()),""!==t.errorMessage?void(t.loginError=!0):(t.$watch("signUpData.email",function(e,o){e!=o&&(t.suggestedEmail=void 0)}),void(e?(c.show({template:a.instant("LOGIN_CREATING_ACCOUNT")}),t.loading=!0,g.createAccount(t.signUpData.email,t.signUpData.password,t.signUpData.name,t.signUpData.referralCode,t.userGoal,t.groupCode).success(function(e,n,a){window.preventNotificationRegistration=!0,localStorage.clear(),c.hide(),t.loading=!1,g.updateToken(a),initializeUserContext(e,o,g,f,v,h,T,m,S,O,!0),i.go("app.home",{},{location:"replace"}),t.closePopup()}).error(function(e,o){c.hide(),t.loading=!1,t.loginError=!0,t.errorMessage=a.instant("LOGIN_ERROR_CREATING_USER"),409==o&&(t.errorMessage=a.instant("LOGIN_ERROR_EMAIL_IN_USE"))})):Mailcheck.run({email:t.signUpData.email,suggested:function(e){t.suggestedEmail=e.full},empty:function(){t.createUser(!0)}})))}}])}();var ctrl=angular.module("notificationCtrl",[]);ctrl.controller("NotificationCtrl",["$scope","$state","$http","$timeout","$analytics","$ionicLoading","$ionicPopup","AccountService","HabitsService","GoalsService","AudioService","PayService","NotificationService","Environment","Token",function(e,t,o,i,n,a,r,s,c,l,u,d,p){e.notificationsUpdated=!1,e.receiveEmailsUpdated=!1,e.data={},e.data.notifications=s.getUserPreference("notification_timing"),"undefined"==typeof e.data.notifications&&(e.data.notifications="random");var g=s.getUserPreference("eod_notifications");e.data.receiveEODNotifications=g?""+("true"==g.toLowerCase()):"true";var f=s.getUserPreference("receive_emails");e.data.receiveEmails=f?""+("true"==f.toLowerCase()):"true";var v=s.getUserPreference("play_goal_alert");e.data.goalAlert=v?""+("true"==v.toLowerCase()):"true";var h=s.getUserPreference("receive_community_notifications");e.data.communityNotification=h?""+("true"==h.toLowerCase()):"true",e.updateReceiveEmails=function(){s.setUserPreference("receive_emails",""+e.data.receiveEmails).success(function(){e.receiveEmailsUpdated=!0,i(function(){e.receiveEmailsUpdated=!1},3e3)})},e.updateEODNotifications=function(){s.setUserPreference("eod_notifications",e.data.receiveEODNotifications).success(function(){e.notificationsUpdated=!0,i(function(){e.notificationsUpdated=!1},3e3)})},e.updateNotifications=function(){s.setUserPreference("notification_timing",e.data.notifications).success(function(){e.notificationsUpdated=!0,i(function(){e.notificationsUpdated=!1},3e3)}),"none"!=e.data.notifications&&p.registerNotifications()},e.updateGoalAlert=function(){s.setUserPreference("play_goal_alert",e.data.goalAlert).success(function(){e.goalAlertUpdated=!0,i(function(){e.goalAlertUpdated=!1},3e3)})},e.updateCommunityNotifications=function(){s.setUserPreference("receive_community_notifications",e.data.communityNotification).success(function(){e.communityNotificationUpdated=!0,i(function(){e.communityNotificationUpdated=!1},3e3)})}}]);var ctrl=angular.module("nuxCtrl",[]);ctrl.controller("NuxCtrl",["$scope","$state","$http","$timeout","$analytics","$ionicLoading","$ionicPopup","AccountService","HabitsService","GoalsService","AudioService","PayService","Environment","Token",function(){}]),function(){var e=angular.module("progressCtrl",[]),t=864e5;e.controller("ProgressMoodCtrl",["$scope","$stateParams","$controller","$http","$ionicLoading","$ionicModal","$ionicScrollDelegate","$ionicPopup","$ionicGesture","$ionicSideMenuDelegate","$analytics","$timeout","$translate","HabitsService","AccountService","GoalsService","SkillsService","GeneralService","Environment",function(e,o,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T,m,E){function _(e,t){return t.getTime()-60*t.getTimezoneOffset()*1e3-e.getTime()+60*e.getTimezoneOffset()*1e3}function S(){for(var e in Z)l.off(Z[e],"dragleft",I);for(var t in q)l.off(q[t],"dragright",I);Z.length=0,q.length=0}function I(e){if("dragleft"==e.type){Q&&angular.element(Q).addClass("hideRemove");{angular.element(e.target).scope()}Q=e.target,angular.element(e.target).removeClass("hideRemove")}else angular.element(e.target).addClass("hideRemove"),Q=void 0}function O(){S();
for(var e=document.getElementsByClassName("dragContainer"),t=0;t<e.length;++t){var o=e[t],i=l.on("dragright",I,angular.element(o)),n=l.on("dragleft",I,angular.element(o));q.push(i),Z.push(n)}}function A(t){if(t){var o=e.$new();o.experiencedDate=t,i("HabitsMoodCtrl",{$scope:o}),r.fromTemplateUrl("views/habits/habits.mood.popup.html",{scope:o,animation:"none"}).then(function(t){e.moodModal=t,openModal(e.moodModal),p(L)})}}function D(){}function L(){var e=$("#moodNote").offset();e&&$("#moodNote").css("min-height",et-e.top)}function b(){if(e.accountHabits&&e.activeHealthDataIndex<e.accountHabits.length){var t=e.accountHabits[e.activeHealthDataIndex];return t}}function G(t){var o=new Date(e.startMS);return o.setDate(o.getDate()+t),o}function R(e){return e.getMonth()+1+"/"+e.getDate()}function y(){var t=window.innerWidth;e.sectionWidth=t/e.sections,at<e.sections?(e.totalDays=Math.floor(at)+1,e.activeDay=Math.floor(at),e.startDate=K,e.startMS=K.getTime(),e.canLoadPreviousData=!1):at>30?(e.totalDays=31,e.activeDay=e.sections-1,e.startDate=z,e.startMS=z.getTime()):(e.totalDays=Math.ceil(at)+1,e.activeDay=e.sections-1,e.startDate=K,e.startMS=K.getTime(),e.canLoadPreviousData=!1),e.totalHeight=150,e.totalWidth=e.sectionWidth*e.totalDays,e.ctx.canvas.width=window.innerWidth*e.canvasScale,e.ctx.canvas.height=e.totalHeight*e.canvasScale,e.maxLocation=e.currentLocation=(e.totalDays-e.sections)*e.sectionWidth,e.currentLocation<0&&(e.currentLocation=0),e.scale=e.totalDays<e.sections?1:e.totalDays/e.sections,x()}function N(){var t=window.innerWidth,o=200;window.innerWidth>=768&&(o=400);var i=document.getElementById("skillsDisplay"),n=i.getContext("2d");n.canvas.width=t*e.canvasScale,n.canvas.height=o*e.canvasScale,$("#skillsDisplay").width(t),$("#skillsDisplay").height(o);var a=n.canvas.width,r=n.canvas.height;n.clearRect(0,0,a,r),n.scale(e.canvasScale,e.canvasScale),n.translate(t/2,o/2);for(var s=Math.min(t,o)/2*.8,c=1;7>=c;++c){var l=s*(c/7);n.beginPath(),n.arc(0,0,l,0,2*Math.PI),n.lineWidth=1,n.strokeStyle="rgba(255,255,255, 0.3)",n.stroke()}for(var u=0;5>u;++u){var d=-Math.PI/2+u/5*2*Math.PI,p=Math.cos(d)*s,g=Math.sin(d)*s;n.beginPath(),n.moveTo(0,0),n.lineTo(p,g),n.stroke()}for(var f=0;5>f;++f){var v,h=0,T=-Math.PI/2+f/5*2*Math.PI,m=T+2*Math.PI/5;0===f?(h=st.relaxLevel,v="#5fe9c4"):1==f?(h=st.thoughtsLevel,v="#58caf6"):2==f?(h=st.goalsLevel,v="#ff9b73"):3==f?(h=st.habitsLevel,v="#ff6669"):4==f&&(h=st.socialLevel,v="#ffbe66");var E=s*h/7;n.beginPath(),n.arc(0,0,E,T,m),n.lineTo(0,0),n.fillStyle=v,n.fill(),n.closePath()}}function M(t,o,i){var n=30,a=30,r=1.35*Math.PI,s=1.65*Math.PI;e.ctx.beginPath(),e.ctx.arc(t,o+n,a,r,s),e.ctx.lineWidth=3,e.ctx.strokeStyle=i,e.ctx.stroke()}function P(t,o,i){var n=-25,a=30,r=.35*Math.PI,s=.65*Math.PI;e.ctx.beginPath(),e.ctx.arc(t,o+n,a,r,s),e.ctx.lineWidth=3,e.ctx.strokeStyle=i,e.ctx.stroke()}function C(t,o,i){var n=13,a=3;e.ctx.beginPath(),e.ctx.moveTo(t-n,o+a),e.ctx.lineTo(t+n,o+a),e.ctx.strokeStyle=i,e.ctx.stroke()}function w(t,o,i){var n=8,a=-10,r=3;e.ctx.save(),e.ctx.translate(t,o),e.ctx.beginPath(),e.ctx.arc(n,a,r,0,2*Math.PI,!1),e.ctx.restore(),e.ctx.fillStyle=i,e.ctx.fill(),e.ctx.save(),e.ctx.translate(t,o),e.ctx.beginPath(),e.ctx.arc(-n,a,r,0,2*Math.PI,!1),e.ctx.restore(),e.ctx.fillStyle=i,e.ctx.fill()}function x(){if(e.ctx&&e.ctx.canvas){var o=e.ctx.canvas.width,i=e.ctx.canvas.height;e.ctx.clearRect(0,0,o,i),e.ctx.save(),e.ctx.scale(e.canvasScale,e.canvasScale),e.ctx.translate(-e.currentLocation,0);for(var n=-1,a=e.totalDays<e.sections?e.sections:e.totalDays,r=0;a>r;++r){var s=r*e.sectionWidth;if(!(s<e.currentLocation-e.sectionWidth||s>e.currentLocation+8*e.sectionWidth)){var c,l,u=G(r);l=e.scrollLeft?0===e.activeDay?.01:e.sectionWidth-.01:e.activeDay==e.sections-1?.01:e.sectionWidth-.01,(1==e.totalDays||s+l>e.currentLocation)&&0>n?n=0:n>=0&&++n,n==e.activeDay?(c="rgba(0,0,0, 0.3)",e.activeDayDate=u):c=r%2===0?"rgba(0, 0, 0, 0.5)":"rgba(0,0,0, 0.55)",e.ctx.fillStyle=c,e.ctx.fillRect(s,0,e.sectionWidth,e.totalHeight);var d=.15,p=e.sectionWidth*d,v=s+(1-d)/2*e.sectionWidth;if(e.displayingHealthData&&u<new Date){var h=e.getHabitDataForDate(u),T=!1;if(h){var E=b(),S=f.getHabitValueById(E,h.habitValueId);if(S){var I=S.ordinate/E.habitValues.length,O=20+75*I,A=f.metGoal(E,S.ordinate);e.ctx.fillStyle=A?"rgba(92,229,157,0.4)":"rgba(255,102,105,0.4)",e.ctx.fillRect(v,e.totalHeight-O,p,e.totalHeight),T=!0}}if(!T&&e.loaded){var D=10;e.ctx.fillStyle="rgba(255,255,255,0.2)",e.ctx.fillRect(v,e.totalHeight-D,p,e.totalHeight)}}if(e.displayingActivityData&&u<new Date){var L=e.getActivityCountForDate(u);if(L){L>3&&(L=3);var R=L/3,y=20+75*R;e.ctx.fillStyle="rgba(92,229,157,0.4)",e.ctx.fillRect(v,e.totalHeight-y,p,e.totalHeight)}else if(e.loaded){var N=10;e.ctx.fillStyle="rgba(255,255,255,0.2)",e.ctx.fillRect(v,e.totalHeight-N,p,e.totalHeight)}}if(e.viewSimpleProgress&&!e.isUMNUser()){var x=m.getDayString(u),U=e.moodAverages[x];if(U){var H=s+e.sectionWidth/2,k=m.COLORS[m.COLORS.length-U],$=hexToRgb(k),V="rgb("+$.r+","+$.g+","+$.b+")",F=38;w(H,F,V),U>4?P(H,F,V):4==U?C(H,F,V):M(H,F,V)}}var B;if(r==e.totalDays-1)B=g.instant("TODAY_SHORT").toUpperCase();else{if(r>=e.totalDays)continue;var K=G(r);B=moment(K).format("L")}e.ctx.textAlign="center",e.ctx.fillStyle=n==e.activeDay?"rgb(255,255,255)":"rgb(150,150,150)",e.ctx.fillText(B,s+e.sectionWidth/2,15)}}var Y,W,X,z,j=t*e.totalDays,J=0;if(e.viewSimpleProgress){if(e.isUMNUser())for(J=0;2>J;++J)for(var Z=0;Z<e.stressData.length;++Z){var q=e.stressData[Z],Q=new Date(q.experiencedAtStr),et=_(e.startDate,Q)/j*e.totalWidth;if(1!==J||!(et<e.currentLocation||et>e.currentLocation+8*e.sectionWidth)){var tt=35+(q.valueInt-1)/4*95;if(0===J)Z>0&&(e.ctx.strokeStyle="rgba(255,255,255, 0.4)",e.ctx.beginPath(),e.ctx.moveTo(X,z),e.ctx.lineTo(et,tt),e.ctx.stroke());else{var ot=m.STRESS_COLORS[q.valueInt-1],it=hexToRgb(ot),nt="rgb("+it.r+","+it.g+","+it.b+")";e.ctx.fillStyle=nt,e.ctx.beginPath(),e.ctx.arc(et,tt,4,0,2*Math.PI),e.ctx.closePath(),e.ctx.fill()}X=et,z=tt}}}else for(e.ctx.lineWidth=1,J=0;2>J;++J)for(var at=0;at<e.data.length;++at){var rt=e.data[at],st=new Date(rt.experiencedAtStr),ct=_(e.startDate,st)/j*e.totalWidth;if(1!==J||!(ct<e.currentLocation||ct>e.currentLocation+8*e.sectionWidth)){var lt=e.totalHeight-(20+(rt.valueInt-1)/6*95);if(0===J)at>0&&(e.ctx.strokeStyle="rgba(255,255,255, 0.4)",e.ctx.beginPath(),e.ctx.moveTo(Y,W),e.ctx.lineTo(ct,lt),e.ctx.stroke());else{var ut=m.COLORS[7-rt.valueInt],dt=hexToRgb(ut),pt="rgb("+dt.r+","+dt.g+","+dt.b+")";e.ctx.fillStyle=pt,e.ctx.beginPath(),e.ctx.arc(ct,lt,4,0,2*Math.PI),e.ctx.closePath(),e.ctx.fill()}Y=ct,W=lt}}e.ctx.restore()}}function U(t){var o,i=e.canvas.getBoundingClientRect();t.changedTouches&&(o=t.changedTouches[0].pageX),o||(o="undefined"!=typeof t.pageX?t.pageX:t.clientX);var n;return t.changedTouches&&(n=t.changedTouches[0].pageY),n||(n="undefined"!=typeof t.pageY?t.pageY:t.clientY),{x:o-i.left,y:n-i.top}}function H(t){t.preventDefault(),t.stopPropagation();var o=U(t),i=o.x-J.x;e.currentLocation-=i,e.currentLocation>e.maxLocation&&(e.currentLocation=e.maxLocation),e.currentLocation<0&&(e.currentLocation=0),e.currentLocation<e.sectionWidth&&loadPreviousData(),J&&($scrollLeft=J.x>o.x),J=o,x(),e.$$phase||e.$apply()}function k(o){var i=U(o),n=e.currentLocation+i.x,a=G(Math.floor(n/e.sectionWidth));if(!(a>X)){var r=Math.ceil(_(e.activeDayDate,a)/t);0!==r&&(e.activeDay+=r,e.activeDay<0?e.activeDay=0:e.activeDay>7&&(e.activeDay=7),x()),e.$$phase||e.$apply()}}function V(){e.moodAverages={},e.stressAverages={},e.data.length=0,e.stressData.length=0;var t=f.getAccountHabitValues("Mood").habitValues;for(var o in e.healthData){var i=e.healthData[o],n=i.Mood;if(n){for(var a=0,r=0,s=0;s<n.length;++s)e.data.push(n[s]),r+=n[s].valueInt,++a;a>0&&(r=t.length-Math.round(r/a),r=t[r].valueInt,e.moodAverages[o]=r)}var c=i.Stress;if(c&&e.isUMNUser()){var l=(f.getAccountHabitValues("Stress").habitValues,new Date(c.createdAtStr));if(l>W)continue;for(var u=0,d=0,p=0;p<c.length;++p)e.stressData.push(c[p]),d+=c[p].valueInt,++u;u>0&&(d=Math.round(d/u)-1,e.stressAverages[o]=d)}}e.data.length>0&&e.data.sort(function(e,t){return t.experiencedAt-e.experiencedAt}),e.stressData.length>0&&e.stressData.sort(function(e,t){return t.experiencedAt-e.experiencedAt})}function F(t,o){return E.isOnline()?(a.show({template:g.instant("LOADING_HISTORY")+"..."}),void v.getActivityHistory(t,o).success(function(t){var o=t.activityHistory;for(var i in o){var n,r=o[i],c=v.getCategoryForActivity(i);"goals"==c?n=2:"relax"==c?n=0:"thoughts"==c&&(n=1);var l=e.activityHistory[n];l||(l=e.activityHistory[n]={});for(var u=0;u<r.length;++u){var d=r[u],g=new Date(d.date),f=m.getDayString(g),h=l[f];h?h.push(d):l[f]=[d]}}if(e.habitSubValues||(e.habitSubValues={}),t.dailyHabitData.habitSubValues)for(var T=0;T<t.dailyHabitData.habitSubValues.length;++T){var E=t.dailyHabitData.habitSubValues[T];e.habitSubValues[E.id]=E}for(var _ in t.dailyHabitData.data)e.healthData[_]=t.dailyHabitData.data[_];V(),e.loaded=!0,e.showingHistory?x():N(),a.hide(),p(function(){s.resize(),$("ion-scroll").height(window.innerHeight+4-2*$(".progress-header").outerHeight()-$("canvas").height()-$("ion-nav-bar").outerHeight())},1)}).error(function(){a.hide()})):void c.alert({title:"",template:"<div>"+g.instant("HOME_OFFLINE_PROGRESS_ALERT")+"</div>",okText:g.instant("OK_GOT_IT"),okType:"button-default"})}e.openSideMenu=function(){u.toggleLeft()};m.getTodayString();e.loaded=!1,e.showingHistory=!0,"skills"!=o.tab&&E.isOnline()||(e.showingHistory=!1);var B=v.getAccountUser(),K=new Date(B.user.createdAtStr);K.setHours(0,0,0,0),e.canvas=void 0,e.ctx=void 0,e.canvasScale=window.devicePixelRatio,e.totalDays=30,e.displayingHealthData=!1,e.activeHealthDataIndex=e.isUMNUser()?2:1,e.displayingActivityData=!1,e.activeActivityDataIndex=0,e.isPacificaLiteUser()||(e.potentialActivities=["Relax","Thoughts","Experiments"]);var Y=v.getUserPreference("view_simple_progress");e.viewSimpleProgress=Y?"true"==Y.toLowerCase():e.isUMNUser()?!0:!1,e.getActivityTitle=function(){var t;return t=g.instant(e.isUMNUser()?e.viewSimpleProgress?"STRESS_PROGRESS_TITLE":"MOOD_PROGRESS_TITLE":"HISTORY"),t.toUpperCase()},e.showHistory=function(){e.showingHistory=!0,e.loaded?x():F()},e.showSkills=function(){e.showingHistory=!1,N()},e.closeSkillsHelpModal=function(){e.skillsHelpModal&&(closeModal(e.skillsHelpModal),e.skillsHelpModal.remove(),e.skillsHelpModal=void 0)},e.showSkillsHelp=function(){r.fromTemplateUrl("views/progress/skills.help.html",{scope:e,animation:"none"}).then(function(t){e.skillsHelpModal=t,openModal(e.skillsHelpModal)})},e.accountHabits=f.getAccountHabits(),e.accountHabits&&(e.isUMNUser()?e.accountHabits.length>2:e.accountHabits.length>1)?e.displayingHealthData=!0:e.isPacificaLiteUser()||(e.displayingActivityData=!0);var W=new Date,X=(W.getTime(),new Date);X.setHours(0,0,0,0);var z=W.addDays(-30);z.setHours(0,0,0,0),e.data=[],e.stressData=[],e.moodAverages={},e.stressAverages={},e.healthData={},e.requestedDays=[],e.activityHistory=[],e.sections=7,e.maxLocation=void 0,e.currentLocation=void 0,e.activeDay=void 0,e.activeDayDate=void 0,e.canLoadPreviousData=!0;var j=!1;e.userScroll=!1,e.scrollLeft=!0;var J,Z=[],q=[];e.$on("$destroy",function(){S()});var Q;e.updateMoodNotes=function(){e.updatingMoodNotes=!0,f.updateHabitDataNotes(e.editingMoodRating.id,e.moodNotes.notes).success(function(){e.editingMoodRating.habitDataNotes?e.editingMoodRating.habitDataNotes.notes=e.moodNotes.notes:e.editingMoodRating.habitDataNotes={notes:e.moodNotes.notes},e.closeNotesModal(),e.updatingMoodNotes=!1}).error(function(){c.alert({template:g.instant("UPDATE_NOTES_ERROR"),okText:g.instant("OK_GOT_IT"),okType:"button-default"});e.updatingMoodNotes=!1})},e.getMoodDisplay=function(){var t="MOOD_"+e.editingMoodRating.valueString;return t=t.replace(" ","_"),g.instant(t)},e.updateEditedValue=function(){var t=f.getHabitValueById(e.editingMoodRating.habitValueId);e.editingMoodRating.valueInt=t.valueInt,e.editingMoodRating.valueString=t.valueString,V(),x()},e.showProgressTooltip=function(){if(v.isUMNUser())return!1;var e=v.getUserPreference("viewed_progress_tooltop");return e&&"true"==e?!1:!0},e.hideProgressTooltip=function(){v.setUserPreference("viewed_progress_tooltop",!0)},e.canAddMoodEntry=function(){if(v.isUMNUser())return!1;var t=new Date(X);return t=t.addDays(-6),e.activeDayDate>=t},e.addMoodEntry=function(){var t;m.getDayString(e.activeDayDate)==m.getDayString(X)?t=new Date:(t=new Date(e.activeDayDate),t.setHours(12,0,0,0));var o=new Date(X);o=o.addDays(-6);var i=K>o?K:o,n=new Date;window.datePicker?datePicker.show({date:t,mode:"datetime",minDate:E.isAndroid()?i.getTime():i,maxDate:E.isAndroid()?n.getTime():n,allowOldDates:!1,allowFutureDates:!1},A,D):A(new Date)},e.closeMoodModal=function(){closeModal(e.moodModal),e.moodModal.remove(),e.moodModal=void 0},e.finishEditingMood=function(t){e.moodModal.scope.submitData(t,function(t){if(t)for(var o=0;o<t.length;++o){var i=t[o],n=m.getDayString(new Date(i.experiencedAt)),a=e.healthData[n];a||(a=e.healthData[n]={Mood:[]});var r=a.Mood;r||(r=a.Mood=[]),r.splice(0,0,i),r.sort(function(e,t){return t.experiencedAt-e.experiencedAt})}tt=void 0,V(),x(),e.closeMoodModal()},function(){c.alert({template:"<div>"+g.instant("MOOD_ENTRY_ERROR")+"</div>",okText:g.instant("OK_GOT_IT"),okType:"button-default"})})};var et=window.innerHeight;e.canDeleteItem=function(e){return!!e.data.habitValueId},e.canEditItem=function(e){if("mood"!=e.actionClass)return!1;var t=new Date(e.data.experiencedAtStr),o=(new Date).addDays(-6);return o.setHours(0,0,0,0),t>=o},e.editItemNotes=function(t){if(event.stopPropagation(),event.preventDefault(),"mood"==t.actionClass){e.editingMoodRating=t.data,e.moodNotes={notes:t.data.habitDataNotes?t.data.habitDataNotes.notes:void 0};var o=e.$new();o.habitDataToEdit=t.data,i("HabitsMoodCtrl",{$scope:o}),r.fromTemplateUrl("views/habits/habits.mood.popup.html",{scope:o,animation:"none"}).then(function(t){e.moodModal=t,openModal(e.moodModal),p(L)})}},e.deleteItem=function(t){event.stopPropagation(),event.preventDefault();var o="<div>"+g.instant("DELETE_HABIT_RATING_PROMPT")+"</div>",i=c.confirm({template:o,cancelText:g.instant("CANCEL"),cancelType:"button-default",okText:g.instant("DELETE"),okType:"button-default"});i.then(function(o){o&&f.deleteHabitData(t.data).success(function(){for(var o in e.healthData){var i=e.healthData[o];for(var n in i)for(var a=i[n],r=0;r<a.length;++r){var s=a[r];if(s.id==t.data.id){a.splice(r,1);break}}}V(),x()}).error(function(){})})},e.toggleSimpleMode=function(){e.viewSimpleProgress=!e.viewSimpleProgress,v.setUserPreference("view_simple_progress",""+e.viewSimpleProgress),x()},e.isSimpleMode=function(){return e.viewSimpleProgress},e.getMoodColor=function(t){var o=f.getHabitValueById(t.habitValueId);if(o){if(o.habitId==f.MOOD_HABIT_ID)return!t&&e.editingMoodRating&&(t=e.editingMoodRating),m.COLOR_NAMES[7-t.valueInt];if(o.habitId==f.STRESS_HABIT_ID)return m.STRESS_COLOR_NAMES[t.valueInt-1]}},e.getHabitSubValue=function(t){return f.getHabitSubValue(e.habitSubValues,t)},e.getHabitNameFromHabitRating=function(e){var t=f.getHabitValueById(e.habitValueId),o=f.getAccountHabitById(t.habitId);return f.getHabitName(o)},e.getHabitRatingDisplay=function(e){return f.getHabitDisplayFromData(e)},e.getMoodRatingDisplay=function(e){var t=e.valueString,o="HABITS_VALUES_"+t;return o=o.replace(/ /g,"_").toUpperCase(),g.instant(o)},e.getHabitRatingDateDisplay=function(e){var t=new Date(e.experiencedAtStr);return moment(t).calendar()},e.isDisplayingMood=function(){return e.isUMNUser()?!e.viewSimpleProgress:!0},e.getActionTitle=function(e){var t=e.actionTitle;return t},e.getActionSubTitle=function(t){var o="";if(e.canDeleteItem(t)&&"mood"!=t.actionClass&&"stress"!=t.actionClass){var i=t.data,n=f.getHabitValueById(i.habitValueId);o+=" ("+f.getHabitDisplayFromValue(n)+")"}return o},e.getSubClass=function(e){return e.skillSubClass?e.skillSubClass:""},e.getActionClass=function(e){return e.actionClass},e.getActionTimeDisplay=function(e){return moment(e.actionTimestamp).calendar()};var tt,ot,it;e.getActiveDaysData=function(){if(e.activeDayDate==ot&&e.viewSimpleProgress==it)return tt;var t=[];if(e.activeDayDate){var o=m.getDayString(e.activeDayDate),i=[],n=e.healthData[o];if(n)for(var a in n){var r=n[a];r.length>0&&i.push.apply(i,r)}for(var c=[],l=0;l<e.activityHistory.length;++l){var u=e.activityHistory[l];if(u){var d=u[o];d&&d.length>0&&c.push.apply(c,d)}}t=T.createActionsWithData(i,c)}return ot=e.activeDayDate,tt=t,it=e.viewSimpleProgress,p(O),s.scrollTop(),t},e.isItemActive=function(t){if(!e.activeDayDate||"mood"!=t.actionClass&&"stress"!=t.actionClass)return!1;var o=new Date(t.data.experiencedAtStr);return o.setHours(0,0,0,0),0===_(e.activeDayDate,o)},e.hasNotes=function(e){return e.data.habitDataNotes&&e.data.habitDataNotes.notes&&e.data.habitDataNotes.notes.length>1},e.displayItemNotes=function(t){var o="mood"==t.actionClass||"stress"==t.actionClass||"health"==t.actionClass;if(o){var i=e.$new();i.habitRating=t.data;{c.alert({templateUrl:"views/progress/progress.habits.notes.html",okText:g.instant("OK_GOT_IT"),okType:"button-default",scope:i})}}},e.getTodaysMoodClass=function(){var t;if(e.activeDayDate){var o=e.activeDayDate,i=m.getDayString(o);if(e.isDisplayingMood()){var n=e.moodAverages[i];if(n){var a=f.getAccountHabitValues("Mood").habitValues,r=a.length-Math.round(n);r=a[r].valueInt,t=m.COLOR_NAMES[7-r]}}else{var s=e.stressAverages[i];if("undefined"!=typeof s){var c=f.getAccountHabitValues("Stress").habitValues,l=Math.round(s);l=c[l].valueInt,t=m.STRESS_COLOR_NAMES[l-1]}}}return t?t:""},e.rotateHealthData=function ct(){if(e.displayingHealthData||e.displayingActivityData||!(e.isUMNUser()?e.accountHabits.length>2:e.accountHabits.length>1))if(e.displayingActivityData)++e.activeActivityDataIndex,e.activeActivityDataIndex>=e.potentialActivities.length&&(e.activeActivityDataIndex=0,e.displayingHealthData=!1,e.displayingActivityData=!1);else if(e.displayingHealthData)if(++e.activeHealthDataIndex,e.activeHealthDataIndex>=e.accountHabits.length)e.activeHealthDataIndex=e.isUMNUser()?2:1,e.isPacificaLiteUser()||(e.displayingHealthData=!1,e.displayingActivityData=!0);else{var t=e.accountHabits[e.activeHealthDataIndex];if("Stress"==t.name)return void ct()}else e.isPacificaLiteUser()?c.alert({title:"",template:"<div>"+g.instant("PACIFICA_LITE_MISSING_HEALTH_ERROR")+"</div>",okText:g.instant("OK_GOT_IT"),okType:"button-default"}):e.displayingActivityData=!0;else e.displayingHealthData=!0,e.displayingActivityData=!1,e.activeHealthDataIndex=e.isUMNUser()?2:1;x()},e.getActiveHealthName=function(){if(e.displayingHealthData){var t=b();return t?t.name:void 0}if(e.displayingActivityData){var o=e.potentialActivities[e.activeActivityDataIndex];return o}},e.getActiveHealthType=function(){var t=e.getActiveHealthName();return t?(e.displayingActivityData&&(t+="_ACTIVITY"),t=t.toUpperCase(),g.instant(t)):void 0},e.getHabitDataForDate=function(t){var o=e.getActiveHealthName(),i=m.getDayString(t);if(e.displayingHealthData){var n=e.healthData[i];if(n){var a=n[o];if(a)return a=a[0]}}return void 0},e.getActivityCountForDate=function(t){var o=e.activityHistory[e.activeActivityDataIndex];if(o){var i=o[m.getDayString(t)];if(i)return i.length}return void 0},e.getActiveHealthValue=function(){if(e.activeDayDate){if(e.displayingHealthData){var t=e.getHabitDataForDate(e.activeDayDate);if(t)return f.getHabitDisplayById(b(),t.habitValueId)}else if(e.displayingActivityData){var o=e.getActivityCountForDate(e.activeDayDate);if("undefined"!=typeof o)return g.instant("COMPLETED")+" "+o+"X"}return g.instant("NO_DATA")}},e.isTodayActive=function(){if(!e.activeDayDate)return!0;var o=_(e.activeDayDate,X),i=o/t;return 0===i},e.getTodaysMood=function(){var o,i,n;if(e.activeDayDate){var a=_(e.activeDayDate,X),r=a/t;0>=r?i="TODAY I'M":1==r?i="YESTERDAY I WAS":(o=R(e.activeDayDate),i="I WAS");var s=m.getDayString(e.activeDayDate);if(e.isDisplayingMood()){var c=e.moodAverages[s];if(c){var l=f.getAccountHabitValues("Mood").habitValues;n=l.length-Math.round(c),n=l[n].valueString}else n="?";var u="MOOD_"+i+"_"+n;return u=u.replace(/ /g,"_").replace(/'/g,"").toUpperCase(),(o?o:"")+" "+g.instant(u)}var d=e.stressAverages[s];if("undefined"!=typeof d){var p=f.getAccountHabitValues("Stress").habitValues;return n=Math.round(d),n=p[n].valueString,i+" "+n+" stressed"}return i+" ?"}i="TODAY I'M",n="?"},e.canGoToPreviousDay=function(){return e.currentLocation>0||e.activeDay>0},e.previousDay=function(){e.activeDay>0?--e.activeDay:e.canGoToPreviousDay()&&(e.currentLocation-=e.sectionWidth,e.currentLocation<0&&(e.currentLocation=0)),x(),e.currentLocation<e.sectionWidth&&loadPreviousData()},e.canGoToNextDay=function(){return(e.currentLocation<e.maxLocation||e.activeDay<e.sections-1)&&X.getTime()!=e.activeDayDate.getTime()},e.nextDay=function(){e.canGoToNextDay()&&(e.activeDay<e.sections-1?++e.activeDay:e.currentLocation<e.maxLocation&&(e.currentLocation+=e.sectionWidth,e.currentLocation>e.maxLocation&&(e.currentLocation=e.maxLocation)),x())},p(function(){function t(t){j=!0,e.userScroll=!1,J=U(t)}function o(e){j=!1;var t=U(e);J&&t.x==J.x&&t.y==J.y&&k(e)}$("#moodHistory").width(window.innerWidth),$("#moodHistory").height(150),e.canvas=document.getElementById("moodHistory"),e.ctx=e.canvas.getContext("2d"),e.canvas.addEventListener("mousedown",t),e.canvas.addEventListener("mouseup",o),e.canvas.addEventListener("touchstart",t),e.canvas.addEventListener("touchend",o);e.canvas.addEventListener("mousemove",function(e){j&&H(e)});e.canvas.addEventListener("touchmove",function(e){H(e)},!1),y()});var nt=_(K,X),at=nt/t;window.loadPreviousData=e.loadPreviousData=function(){if(e.canLoadPreviousData){{var t,o,i=(e.maxLocation,e.currentLocation,e.totalDays),n=e.startDate;e.startMS}e.totalDays+30>at?(t=at,o=K,e.canLoadPreviousData=!1):(t=e.totalDays+30,o=e.startDate.addDays(-30));var a=m.getDayString(e.startDate);if(!(e.requestedDays.indexOf(a)>=0)){e.totalDays=t,e.startDate=o,e.startMS=e.startDate.getTime(),e.requestedDays.push(a),e.maxLocation=(e.totalDays-e.sections)*e.sectionWidth;var r=(e.totalDays-i)/e.totalDays;e.currentLocation+=r*e.totalDays*e.sectionWidth,e.totalWidth=e.sectionWidth*e.totalDays,e.scale=e.totalDays/e.sections,x(),F(e.startDate,n)}}};var rt=[1,3,5,10,15,20,30],st=T.skillContext;e.getSkillLevel=function(e){var t;return"relax"==e?t=st.relaxLevel:"thoughts"==e?t=st.thoughtsLevel:"goals"==e?t=st.goalsLevel:"habits"==e?t=st.habitsLevel:"social"==e&&(t=st.socialLevel),t},e.getSkillByline=function(e){var t,o,i;"relax"==e?(t=st.relaxLevel,o=st.relaxLevelActions,i="SKILLS_COMPLETE_RELAX"):"thoughts"==e?(t=st.thoughtsLevel,o=st.thoughtsLevelActions,i="SKILLS_COMPLETE_THOUGHTS"):"goals"==e?(t=st.goalsLevel,o=st.goalsLevelActions,i="SKILLS_COMPLETE_GOALS"):"habits"==e?(t=st.habitsLevel,o=st.habitsLevelActions,i="SKILLS_COMPLETE_HABITS"):"social"==e&&(t=st.socialLevel,o=st.socialLevelActions,i="SKILLS_COMPLETE_SOCIAL");var n=rt[t];return g.instant(i).replace("XXXREPLACEXXX",n+"X")},e.getSkillPercentage=function(e){var t,o;"relax"==e?(t=st.relaxLevel,o=st.relaxLevelActions):"thoughts"==e?(t=st.thoughtsLevel,o=st.thoughtsLevelActions):"goals"==e?(t=st.goalsLevel,o=st.goalsLevelActions):"habits"==e?(t=st.habitsLevel,o=st.habitsLevelActions):"social"==e&&(t=st.socialLevel,o=st.socialLevelActions);var i=rt[t],n=100*o/i;return 0===n?2:n},e.showingHistory?F():N()}])}(),function(){function e(e){for(var t in _)for(var o=_[t].exercises,i=0;i<o.length;++i){var n=o[i];if(n.exercise==e)return n}}function t(e){for(var t in _)for(var o=_[t].exercises,i=0;i<o.length;++i){var n=o[i];if(n.audio==e)return n}}function o(e){for(var t in _)for(var o=_[t].exercises,i=0;i<o.length;++i){var n=o[i];if(n.activity==e)return n}}function i(e,t,o,i,n,a){if("none"!=e.bgAudioSource){var r=e.bgAudioSource;r+=a.isAndroid()?".ogg":".aifc",e.bgAudio=o.loadMedia("img/background-sounds/"+r,"bgAudio",n),o.setVolume(e.bgAudio,0),e.volumeData={bgVolume:.4};var s=i.getUserPreference("soundscape_volume");s&&(e.volumeData.bgVolume=+s);var c;e.bgVolumeChanged=function(){c&&(t.cancel(c),c=void 0),c=t(function(){i.setUserPreference("soundscape_volume",e.volumeData.bgVolume)},500),e.started&&e.bgAudio&&o.setVolume(e.bgAudio,e.volumeData.bgVolume)}}}function n(e){e>1?e=1:0>e&&(e=0);var t=R[Math.floor(e*y)];return t}function a(e){return e.replace(/ /g,"_").replace(/\+/g,"").replace(/-/g,"").replace(/:/g,"").replace(/__/g,"_")}function r(e,t){var o="RELAX_ACTIVITY_"+e;o=a(o).toUpperCase();var i=t.instant(o);return i}function s(e,t){var o="RELAX_ACTIVITY_"+e+"_TAGLINE";o=a(o).toUpperCase();var i=t.instant(o);return i}function c(e){var t=e.getUserPreference("breathe_cycle_length");return t=t?+t:8,8*t}function l(e){var t=e.getUserPreference("meditation_length");return t=t?+t:10,60*t}function u(e,t,o){var i=S.indexOf(e),n=O[i];if(n>0)return o.getTimeDisplay(n,!0);if("Deep Breathing"==e||"Visualization"==e){var a=c(t);return o.getTimeDisplay(a,!0)}if("Soundscape Mode"==e){var r=l(t);return o.getTimeDisplay(r,!0)}return""}function d(t,o,i){var n,a=e(t);return n="Deep Breathing"==a.exercise||"Visualization"==a.exercise?c(i):"Soundscape Mode"==a.exercise?l(i):a.audioLength,n>0?(n=Math.round(n/60),n+" "+o.instant(n>1?"HABITS_VALUES_MINUTES":"HABITS_VALUES_MINUTE")):""}function p(e,t){var o="RELAX_ACTIVITY_"+e+"_DESCRIPTION";o=a(o).toUpperCase();var i=t.instant(o);return i}function g(e,t){e.bgAudioSources=T,e.soundOptions={options:m,soundOptionOrdinal:0},e.cycleOptions={options:[5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25],cycleOptionOrdinal:1},e.lengthOptions={options:[5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],lengthOptionOrdinal:1},e.breathingOptions={options:[!0,!1],breathingOptionOrdinal:0},e.continueOptions={options:["Return","Continue Sounds"],continueOptionOrdinal:1},e.enableMeditationMode=!0;var o=t.getUserPreference("bg_audio_src");if(o){var i=e.bgAudioSources.indexOf(o);i>=0&&(e.soundOptions.soundOptionOrdinal=e.bgAudioSources.indexOf(o))}e.bgAudioSource=e.bgAudioSources[e.soundOptions.soundOptionOrdinal];var n=t.getUserPreference("breathe_cycle_length");e.cycleLength=n?parseInt(n):8,e.cycleOptions.cycleOptionOrdinal=e.cycleOptions.options.indexOf(e.cycleLength);var a=t.getUserPreference("meditation_length");e.meditationLength=a?parseInt(a):10,e.lengthOptions.lengthOptionOrdinal=e.lengthOptions.options.indexOf(e.meditationLength);var r=t.getUserPreference("disable_breathing_sounds");e.breathingSoundsOn=r?"false"==r:!0,e.breathingOptions.breathingOptionOrdinal=e.breathingOptions.options.indexOf(e.breathingSoundsOn);var s=t.getUserPreference("enable_meditation_mode");s&&"false"==s&&(e.continueOptions.continueOptionOrdinal=0,e.enableMeditationMode=!1)}var f=angular.module("breatheCtrl",[]),v={playAudioWhenScreenIsLocked:!0},h={playAudioWhenScreenIsLocked:!0,numberOfLoops:1e3},T=["Ocean","SummerNight","Campfire","ForestMorning","Stream","RooftopRain","City","Thunderstorm","Bach","Pinknoise","none"],m=["Ocean Waves","Summer Night","Campfire","Forest Morning","Stream","Rooftop Rain","City","Thunderstorm","Bach Cello Suite #1","White Noise","No Sound"],E=["BASICS","STRESSFUL_SITUATIONS","MINDFULNESS","CALM_DOWN","INNER_STRENGTH"],_={BASICS:{descriptionKey:"RELAX_BASICS_DESC",exercises:[{exercise:"Deep Breathing",audio:"none",audioLength:0,meditation:!1,activeVersion:3,free:!0,activity:"COMPLETED_BREATHING"},{exercise:"Soundscape Mode",audio:"none",audioLength:0,meditation:!1,activeVersion:3,free:!0,activity:"COMPLETED_UNGUIDED_MEDITATION"},{exercise:"Muscle Relaxation",audio:"musclerelaxation.mp3",audioLength:471,meditation:!0,activeVersion:3,free:!0,activity:"COMPLETED_MUSCLE_RELAXATION"}]},CALM_DOWN:{descriptionKey:"RELAX_CALM_DOWN_DESC",exercises:[{exercise:"Calm: Breathe",audio:"calmbreathe.mp3",audioLength:287,meditation:!0,activeVersion:3.1,free:!0,activity:"COMPLETED_CALM_BREATHE"},{exercise:"Calm: Mind",audio:"calmmind.mp3",audioLength:267,meditation:!0,activeVersion:3.1,free:!1,activity:"COMPLETED_CALM_MIND"},{exercise:"Panic: Emergency",audio:"panicemergency.mp3",audioLength:274,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_PANIC_EMERGENCY"},{exercise:"Sleep",audio:"sleep.mp3",audioLength:321,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_SLEEP"},{exercise:"Gratitude",audio:"gratitude.mp3",audioLength:306,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_GRATITUDE"}]},STRESSFUL_SITUATIONS:{descriptionKey:"RELAX_STRESSFUL_SITUATIONS_DESC",exercises:[{exercise:"Social Situations",audio:"ss-social-situations.mp3",audioLength:445,meditation:!0,activeVersion:3.2,free:!0,activity:"COMPLETED_SS_SOCIAL_SITUATIONS"},{exercise:"Flying",audio:"ss-flying.mp3",audioLength:478,meditation:!0,activeVersion:3.2,free:!1,activity:"COMPLETED_SS_FLYING"},{exercise:"Public Speaking",audio:"ss-speaking.mp3",audioLength:556,meditation:!0,activeVersion:3.2,free:!1,activity:"COMPLETED_SS_PUBLIC_SPEAKING"},{exercise:"Public Transit",audio:"ss-public-transit.mp3",audioLength:435,meditation:!0,activeVersion:3.2,free:!1,activity:"COMPLETED_SS_PUBLIC_TRANSIT"},{exercise:"Difficult Experience",audio:"difficultexperience.mp3",audioLength:393,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_DIFFICULT_EXPERIENCE"}]},MINDFULNESS:{descriptionKey:"RELAX_MINDFULNESS_DESC",exercises:[{exercise:"Mindful: Senses",audio:"mindfulsenses.mp3",audioLength:279,meditation:!0,activeVersion:3,free:!0,activity:"COMPLETED_MINDFUL_SENSES"},{exercise:"Mindful: Breathe",audio:"mindfulbreathe.mp3",audioLength:177,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_MINDFUL_BREATHE"},{exercise:"Mindful: Observe",audio:"mindfulobserve.mp3",audioLength:197,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_MINDFUL_OBSERVE"},{exercise:"Mindful: Body Scan",audio:"mindfulbodyscan.mp3",audioLength:209,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_MINDFUL_BODY_SCAN"},{exercise:"Mindful: Walk",audio:"mindfulwalk.mp3",audioLength:575,meditation:!0,activeVersion:3.1,free:!1,activity:"COMPLETED_MINDFUL_WALK"}]},INNER_STRENGTH:{descriptionKey:"RELAX_INNER_STRENGTH_DESC",exercises:[{exercise:"Visualization",audio:"",audioLength:0,meditation:!1,activeVersion:3,free:!0,activity:"COMPLETED_POSITIVE_VISUALIZATION"},{exercise:"Become Tree",audio:"becomingthetree.mp3",audioLength:483,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_BECOMING_THE_TREE"},{exercise:"Empathy",audio:"empathy.mp3",audioLength:358,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_EMPATHY"},{exercise:"Self Compassion",audio:"selfcompassion.mp3",audioLength:340,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_SELF_COMPASSION"},{exercise:"Defusion",audio:"intenseemotions.mp3",audioLength:261,meditation:!0,activeVersion:3,free:!1,activity:"COMPLETED_DEFUSION"}]}},S=[],I=[],O=[],A=0;for(var D in _)for(var L=_[D].exercises,b=0;b<L.length;++b){var G=L[b];S[A]=G.exercise,I[A]=G.audio,O[A]=G.audioLength,++A}var R=[.007,.008,.009,.01,.011,.012,.013,.015,.016,.018,.02,.022,.024,.027,.029,.032,.036,.039,.043,.047,.052,.057,.063,.069,.076,.083,.091,.1,.109,.119,.13,.142,.154,.168,.182,.198,.214,.231,.25,.269,.289,.31,.332,.354,.378,.401,.426,.45,.475,.5,.525,.55,.574,.599,.622,.646,.668,.69,.711,.731,.75,.769,.786,.802,.818,.832,.846,.858,.87,.881,.891,.9,.909,.917,.924,.931,.937,.943,.948,.953,.957,.961,.964,.968,.971,.973,.976,.978,.98,.982,.984,.985,.987,.988,.989,.99,.991,.992,.993,.993],y=R.length-1;f.controller("RelaxActivityConfigCtrl",["$scope","$http","$state","$stateParams","$timeout","$analytics","$translate","$ionicModal","$ionicPopup","AccountService","PayService","Environment",function(t,o,i,n,s,c,l,u,f,v){function h(){v.setUserPreference("bg_audio_src",""+t.bgAudioSource),v.setUserPreference("breathe_cycle_length",""+t.cycleLength),v.setUserPreference("enable_meditation_mode",t.enableMeditationMode),v.setUserPreference("meditation_length",t.meditationLength),v.setUserPreference("disable_breathing_sounds",!t.breathingSoundsOn)
}t.exercise=n.exercise,t.exerciseObj=e(t.exercise),t.exerciseName=t.exerciseObj.exercise;t.exerciseObj.meditation;g(t,v),t.goToHelp=function(){i.go("Deep Breathing"==t.exerciseName?"app.breathe-help":"Visualization"==t.exerciseName?"app.relax-record-help":"app.relax-help")},t.showCycleOptions=function(){return"Deep Breathing"==t.exerciseName||"Visualization"==t.exerciseName},t.showLengthOptions=function(){return"Soundscape Mode"==t.exerciseName},t.showContinueOptions=function(){return!0},t.showBreathingOptions=function(){return"Deep Breathing"==t.exerciseName},t.updateSoundOption=function(){t.soundOptions.soundOptionOrdinal;t.bgAudioSource=t.bgAudioSources[t.soundOptions.soundOptionOrdinal],h(),c.eventTrack("setBackgroundAudio",{category:"relax",label:t.bgAudioSource})},t.updateCycleLength=function(){t.cycleLength=t.cycleOptions.options[t.cycleOptions.cycleOptionOrdinal],h(),c.eventTrack("setCycleLength",{category:"relax",label:""+t.cycleLength})},t.updateBreathingOptions=function(){t.breathingSoundsOn=t.breathingOptions.options[t.breathingOptions.breathingOptionOrdinal],h(),c.eventTrack("setBreathingSounds",{category:"relax",label:""+t.breathingSounds})},t.updateMeditationLength=function(){t.meditationLength=t.lengthOptions.options[t.lengthOptions.lengthOptionOrdinal],h(),c.eventTrack("setMeditationLength",{category:"relax",label:""+t.meditationLength})},t.updateContinueOption=function(){t.continueOption=t.continueOptions.options[t.continueOptions.continueOptionOrdinal],t.enableMeditationMode=1==t.continueOptions.continueOptionOrdinal,h(),c.eventTrack("setContinueOption",{category:"relax",label:t.continueOption})},t.getCycleOptionDisplay=function(e){var t="RELAX_ACTIVITY_SECONDS_BREATHING";return e+" "+l.instant(t)},t.getBreathingOptionDisplay=function(e){return l.instant(e?"YES":"NO")},t.getLengthOptionDisplay=function(e){var t="RELAX_ACTIVITY_MINUTES";return e+" "+l.instant(t)},t.getSoundOptionDisplay=function(e){var t="RELAX_ACTIVITY_SOUND_"+e;t=t.replace(/ /g,"_").replace(/#/g,"").toUpperCase();var o=l.instant(t);return o},t.getContinueOptionDisplay=function(e){var t="RELAX_ACTIVITY_CONTINUATION_"+e;t=t.replace(/ /g,"_").replace(/#/g,"").toUpperCase();var o=l.instant(t);return o},t.getExerciseOptionMinuteDisplay=function(){return d(t.exercise,l,v)},t.getActivityName=function(){return r(t.exerciseName,l)},t.getActivityClass=function(){return a(t.exerciseName)},t.getActivityDescription=function(){return p(t.exerciseName,l)},t.startExercise=function(){function e(){var e=v.getUserPreference("completed_breathe_intro");return"undefined"!=typeof e}function o(){var e=v.getUserPreference("completed_visualization_intro");return"undefined"!=typeof e}var n={cycleLength:t.cycleLength,bgAudioSource:t.bgAudioSource,meditationMode:t.enableMeditationMode};"Deep Breathing"==t.exerciseName?(n.breathingSounds=t.breathingSoundsOn,e()?i.go("app.breathe-exercise",n):(n.intro=!0,i.go("app.breathe-help",n))):"Soundscape Mode"==t.exerciseName?(n.meditationLength=t.meditationLength,i.go("app.narration-exercise",n)):"Visualization"==t.exerciseName?(n.maxTime=t.cycleLength,o()?i.go("app.breathe-record",n):(n.nextState="app.breathe-record",n.intro=!0,i.go("app.relax-record-help",n))):(n.src=t.exerciseObj.audio,i.go("app.narration-exercise",n))}}]),f.controller("RelaxCtrl",["$rootScope","$scope","$http","$state","$stateParams","$timeout","$analytics","$translate","$ionicModal","$ionicPopup","$ionicGesture","$ionicHistory","$ionicActionSheet","$ionicScrollDelegate","AccountService","MediaService","PayService","SkillsService","GeneralService","Environment",function(t,i,n,c,l,d,p,f,v,h,T,m,O,A,D,L,b,G,R,y){function N(e){"dragleft"==e.type?(w&&angular.element(w).addClass("hideRemove"),w=e.target,angular.element(e.target).removeClass("hideRemove")):(angular.element(e.target).addClass("hideRemove"),w=void 0)}function M(){for(var e in x)T.off(x[e],"dragleft",N);for(var t in U)T.off(U[t],"dragright",N)}m.clearHistory(),D.setUserPreference("viewed_relax_tooltip",!0);var P;i.$on("$ionicView.afterEnter",function(){var e=G.getSuggestedActivityId();P=e?o(e):void 0,P&&d(function(){window.sg=A;var e=$(".item.suggested");e&&e.length>0&&A.scrollTo(0,e.position().top-100,!0)})});var C=D.getUserPreference("completed_relax_intro");C&&"true"==C||(t.$broadcast("event:viewVideo",{video:D.RELAX_VIDEO}),D.setUserPreference("completed_relax_intro",!0),window.checkExistingFiles&&window.checkExistingFiles()),i.exerciseCategories=E,i.getRelaxLevel=function(){return G.getSkillLevel("relax")},i.goToSkills=function(){window.openURL("/progress/mood?tab=skills")},i.showHelp=function(){var e;e=D.isUMNUser()?[{text:'<i class="icon ion-ios-help-outline"></i> '+f.instant("WHAT_IS_RELAX")},{text:'<i class="icon ion-ios-play-outline"></i> '+f.instant("WATCH_MILO_IS_STRESSED")},{text:'<i class="icon ion-ios-list-outline"></i> '+f.instant("VIEW_COMMON_QUESTIONS")}]:[{text:'<i class="icon ion-ios-help-outline"></i> '+f.instant("WHAT_IS_RELAX")},{text:'<i class="icon ion-ios-play-outline"></i> '+f.instant("WATCH_MILO_IS_STRESSED")},{text:'<i class="icon ion-ios-list-outline"></i> '+f.instant("VIEW_COMMON_QUESTIONS")},{text:'<i class="icon ion-ios-people-outline"></i> '+f.instant("EXPLORE_THE_COMMUNITY")}],O.show({buttons:e,cancelText:f.instant("CANCEL"),cancel:function(){},buttonClicked:function(e){return 0===e?t.$broadcast("event:viewVideo",{video:D.RELAX_VIDEO}):1===e?D.viewVideo(D.RELAX_VIDEO):2==e?window.open("http://help.thinkpacifica.com/hc/en-us/sections/200750777-Relax","_blank","location=no"):3==e&&i.goToCommunity("relax"),!0}})};var w,x=[],U=[];i.$on("$destroy",function(){M()}),d(function(){for(var e=document.getElementsByClassName("dragContainer"),t=0;t<e.length;++t){var o=e[t],i=T.on("dragright",N,angular.element(o)),n=T.on("dragleft",N,angular.element(o));U.push(i),x.push(n)}},1);var H;i.$on("event:downloadProgress",function(e,t){(!H||H.getTime()<(new Date).getTime()-250||t&&t.complete)&&d(function(){H=new Date,i.$$phase||i.$apply()})}),i.$on("event:downloadRemoved",function(){d(function(){w&&(angular.element(w).addClass("hideRemove"),w=void 0),i.$$phase||i.$apply()})}),i.download=function(e,t){e&&(e.stopPropagation(),e.preventDefault());var o=S.indexOf(t),i=I[o];L.downloadMeditationFile(i,function(){},function(){h.alert({template:f.instant("RELAX_DOWNLOAD_PERMISSION_ERROR"),okText:f.instant("OK_GOT_IT"),okType:"button-default"})})},i.removeDownload=function(e,t){e&&(e.stopPropagation(),e.preventDefault());var o=h.confirm({template:'<div class="thisisatest">'+f.instant("DELETE_AUDIO_CONFIRMATION")+"</div>",cancelText:f.instant("CANCEL"),cancelType:"button-default",okText:f.instant("CONFIRM"),okType:"button-default"});o.then(function(e){if(e){var o=S.indexOf(t),i=I[o];L.removeMeditationFile(i)}})},i.goToExercise=function(e){return"Coming Soon"==e?void h.alert({template:f.instant("RELAX_ACTIVITY_COMING_SOON_ALERT"),okText:f.instant("OK_GOT_IT"),okType:"button-default"}):void(i.isPremiumEnabled(e)?i.isDownloaded(e)?c.go("app.relax-activityConfig",{exercise:e}):y.isOnline()?i.download(void 0,e):h.alert({template:f.instant("RELAX_OFFLINE_DOWNLOAD_ATTTEMPT"),okText:f.instant("OK_GOT_IT"),okType:"button-default"}):i.showPremiumModal(e))},g(i,D),i.isPremiumEnabled=function(t){var o=e(t);return o.free||D.isPremiumEnabled()},i.isMeditateActivity=function(t){var o=e(t);return o?o.meditation:!1},i.isDownloaded=function(e){var t=S.indexOf(e);if(!i.isMeditateActivity(e))return!0;var o=I[t];return L.isDownloaded(o)},i.isDownloading=function(e){var t=S.indexOf(e),o=I[t];return L.isDownloading(o)},i.getExerciseClass=function(e){var t=a(e.exercise);return P&&e.activity==P.activity&&(t+=" suggested"),t},i.displayCategory=function(e){return D.isUMNUser()?"STRESSFUL_SITUATIONS"!=e:!0},i.displayExercise=function(e){return D.isUMNUser()?3==e.activeVersion:!0},i.getDownloadPercentage=function(e){var t=S.indexOf(e),o=I[t],i=L.getDownloadPercentage(o);return i},i.getExerciseCategory=function(e){var t="RELAX_CATEGORY_"+e;return t=a(t).toUpperCase(),f.instant(t)},i.getCategoryDescription=function(e){return f.instant(_[e].descriptionKey)},i.getCategoryExercises=function(e){return _[e].exercises},i.getExerciseOptionDisplay=function(e){return r(e,f)},i.getExerciseOptionTagline=function(e){return s(e,f)},i.getExerciseOptionTimeDisplay=function(e){return u(e,D,R)},i.showPremiumModal=function(e){b.showPremiumModal(i,"relax",e,!0)}}]),f.controller("BreatheExerciseCtrl",["$scope","$rootScope","$controller","$http","$timeout","$state","$stateParams","$translate","$ionicModal","$ionicPopup","$ionicHistory","$analytics","AccountService","MediaService","HabitsService","Environment",function(e,t,o,a,r,s,c,l,u,d,p,g,f,T,m,E){function _(){}function S(e,t){return{display:"",ordinate:e,valueInt:t,valueString:null}}function I(e){for(var t=[],o=0;e>o;++o)t[o]=0===o?S(o,3):S(o,o+1);return t}function O(){var t=e.canvas.getContext("2d"),o=e.canvas.width,i=e.canvas.height;t.clearRect(0,0,o,i);var a=96,r=e.valueData.percentage<.5?e.valueData.percentage/.5:(1-e.valueData.percentage)/.5;r=n(r),t.beginPath(),t.arc(J,J,a*r,0,2*Math.PI,!1),t.fillStyle="rgba(255, 255, 255, 0.3)",t.fill()}function A(){if(!e.paused&&!e.exited){if(0===e.valueData.percentage){if((e.breathingSoundsOn||e.forceAudio)&&e.playInhaleAudio(!0),e.personalAudio){var t=.5+.5*(e.cycle/e.cycles);e.personalAudio.setVolume(t),e.personalAudio.play(v)}e.graphColors[0]=y,e.graphColors[1]=R,e.graphColors[2]=N,e.inhale=!0}else e.valueData.percentage>=M&&e.inhale&&((e.breathingSoundsOn||e.forceAudio)&&e.playExhaleAudio(!0),e.inhale=!1);var o=(new Date).getTime(),i=e.elapsedTime+(o-e.startTime),n=i/1e3/e.cycleLength;n>=.999?e.cycle<e.cycles||e.enableMeditationMode?(e.cycle==e.cycles&&e.preFinishExercise(),e.valueData.percentage=0,e.elapsedTime=0,e.startTime=(new Date).getTime(),++e.cycle,e.advanceCycle&&e.advanceCycle(),e.inhale=!0,r(A,j)):e.preFinishExercise():(e.valueData.percentage=n,r(A,j)),O()}}function D(){e.bgAudio&&T.setVolume(e.bgAudio,e.volumeData.bgVolume*(Q/q)),q>Q?(r(D,30),++Q):Q=0}function L(){e.bgAudio&&T.setVolume(e.bgAudio,e.volumeData.bgVolume*((q-Q)/q)),q>Q?(r(L,30),++Q):Q=0}function b(){et&&G()}function G(){e.paused||e.exited||(et&&(e.bgSoundOn&&e.bgAudio.play(h),D(),et=!1),e.valueData.value>0?(e.valueData.value=e.valueData.value-1,Z=r(G,1e3)):e.started?e.finishExercise():e.startExercise())}window.plugins&&window.plugins.bgVideo&&window.plugins.bgVideo.playAudioInBackground();var R="#eee",y="#333",N="#ccc";e.getExerciseHeader=function(){return e.paused?l.instant("PAUSED"):e.started?l.instant(e.finished?"FINISHED":e.inhale?"INHALE":"EXHALE"):l.instant("GET_READY")+"..."},e.getExerciseInstructions=function(){var t;return t=e.started?e.finished?"FINISHED":e.inhale?"RELAX_ACTIVITY_INHALE_INSTRUCTIONS":"RELAX_ACTIVITY_EXHALE_INSTRUCTIONS":"RELAX_ACTIVITY_READY_INSTRUCTIONS",l.instant(t)},e.graphColors=[y,N,R];var M=.5;e.started=!1,e.finished=!1,e.exited=!1,e.cycle=1,e.paused=!1,e.inhale=!0;var P=c.cycles;e.cycles=P?+P:8;var C=c.cycleLength;e.cycleLength=C?+C:10,e.bgAudioSource=c.bgAudioSource,"undefined"==typeof e.bgAudioSource&&(e.bgAudioSource="Ocean"),c.src&&(c.src.indexOf("narration-visualization")>0?e.personalAudio=T.loadMedia(c.src,"personalAudio",function(e){}):T.loadRecording(E,c.src,"personalAudio",e,function(e){})),e.bgSoundOn="none"!=e.bgAudioSource,e.enableMeditationMode="true"==c.meditationMode,e.breathingSoundsOn="true"==c.breathingSounds;var w,x,U;e.bgAudio=void 0;var H,k,V=0,F=0,B=2,K=3,Y=.15,W=.15;e.cycleLength<10?(H="img/breathing-sounds/Inhale-5.mp3",k="img/breathing-sounds/Exhale-5.mp3"):e.cycleLength<15?(H="img/breathing-sounds/Inhale-10.mp3",k="img/breathing-sounds/Exhale-10.mp3"):e.cycleLength<20?(H="img/breathing-sounds/Inhale-15.mp3",k="img/breathing-sounds/Exhale-15.mp3"):e.cycleLength<25?(H="img/breathing-sounds/Inhale-20.mp3",k="img/breathing-sounds/Exhale-20.mp3"):(H="img/breathing-sounds/Inhale-25.mp3",k="img/breathing-sounds/Exhale-25.mp3"),x=window.inhaleAudio=T.loadMedia(H,"inhaleAudio",function(e){V=e}),T.setVolume(x,Y),U=T.loadMedia(k,"exhaleAudio",function(e){F=e}),T.setVolume(U,W),i(e,r,T,f,_,E),w=T.isNative(),e.$on("$ionicView.enter",function(){window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.keepAwake(),window.backButtonOverride=function(){var t=!1;e.paused||(e.pause(),t=!0);var o=d.confirm({template:'<div class="thisisatest">'+l.instant("EXIT_ACTIVITY_CONFIRM")+"</div>",cancelText:l.instant("CANCEL"),cancelType:"button-default",okText:l.instant("CONFIRM"),okType:"button-default"});o.then(function(o){o?(window.backButtonOverride=void 0,e.goBack()):t&&e.pause()})}}),e.destroyCtrl=function(){w?(x.stop(),x.release(),U.stop(),U.release(),e.bgAudio&&(e.bgAudio.stop(),e.bgAudio.release()),e.personalAudio&&(e.personalAudio.stop(),e.personalAudio.release()),e.finishedAudio&&(e.finishedAudio.stop(),e.finishedAudio.release())):(x.pause(),U.pause(),e.bgAudio.pause(),e.personalAudio&&e.personalAudio.pause()),window.backButtonOverride=void 0,e.exited=!0},e.$on("$destroy",function(){e.destroyCtrl(),window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.allowSleepAgain()});var X=e.cycleLength/3;e.getExerciseTitle=function(){if(e.cycle<=e.cycles){var t=l.instant("RELAX_ACTIVITY_CYCLE_X_OF_Y");return t=t.replace("[X]",e.cycle).replace("[Y]",e.cycles)}return l.instant("RELAX_ACTIVITY_COMPLETE")},e.values=I(e.cycleLength),e.valueData={value:e.values[0],valueIndex:0,percentage:0},e.elapsedTime=0,e.startTime=void 0;var z=.003,j=1e3*X/(M/z);e.pause=function(){e.paused=!e.paused,e.paused?(e.started?(e.elapsedTime+=(new Date).getTime()-e.startTime,e.valueData.percentage=e.elapsedTime/1e3/e.cycleLength):Z&&r.cancel(Z),e.breathingSoundsOn&&(V==B||0===V?x.pause():(F==B||0===F)&&U.pause()),e.bgSoundOn&&e.bgAudio.pause(),e.personalAudio&&e.personalAudio.getCurrentPosition(function(t){e.personalAudioPosition=t,e.personalAudio.pause()}),g.eventTrack("pauseBreatheExercise",{category:"relax"})):(e.startTime=(new Date).getTime(),e.started?(A(),e.breathingSoundsOn&&(V==K?e.playInhaleAudio(!1):F==K&&e.playExhaleAudio(!1)),e.personalAudioPosition>0&&e.personalAudio.play(v)):G(),e.bgSoundOn&&e.bgAudio.play(h),g.eventTrack("playBreatheExercise",{category:"relax"}))},e.playInhaleAudio=function(e){!w&&e&&x.load(),x.play(v)},e.playExhaleAudio=function(e){!w&&e&&U.load(),U.play(v)},e.$on("$ionicView.afterEnter",function(){e.canvas=$("#breathingCanvas")[0]});var J=135;e.finishedExercise=function(){return e.finished},e.startExercise=function(){e.exited||(e.started=!0,e.startTime=(new Date).getTime(),e.values[0].valueInt=1,A())},e.closeRelaxGoalModal=function(){f.setUserPreference("viewed_relax_goal_popup",!0),closeModal(e.relaxGoalModal),e.relaxGoalModal.remove(),e.relaxGoalModal=void 0,e.finishExercise()},e.checkForRelaxGoalModal=function(){var t=!1,o=f.getUserPreference("viewed_relax_goal_popup");if(!o||"false"==o){var i="views/relax/relax.goalModal.html";u.fromTemplateUrl(i,{scope:e,animation:"slide-in-up"}).then(function(t){e.relaxGoalModal=t,openModal(e.relaxGoalModal)}),t=!0}return t},e.preFinishExercise=function(){e.finished=!0,f.recordActivity(e.personalAudio?"COMPLETED_POSITIVE_VISUALIZATION":"COMPLETED_BREATHING"),f.setUserPreference("completed_relax","true"),g.eventTrack("finishBreatheExercise",{category:"relax"}),e.enableMeditationMode||(e.valueData.value=3,r(L,1e3),r(G,1e3))},e.closeHealthKitModal=function(){f.setUserPreference("integrate_with_healthkit","true"),closeModal(e.healthKitModal),e.healthKitModal.remove(),e.healthKitModal=void 0,e.finishExercise()},e.showHealthkitIntegration=function(){var e=f.getUserPreference("integrate_with_healthkit");return!e},e.checkHealthKitModal=function(){return E.isIos()&&!E.isIPad()&&!e.isUMNUser()&&e.showHealthkitIntegration()?(u.fromTemplateUrl("views/habits/habits.healthkitModal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.healthKitModal=t,openModal(e.healthKitModal)}),!0):!1},e.finishExercise=function(){if(!e.checkHealthKitModal()){var t=(new Date).getTime(),o=(e.elapsedTime+(t-e.startTime))/1e3;o+=(e.cycle-1)*e.cycleLength,e.isUMNUser()||m.saveMindfulMinutes(o),s.go("app.relax"),r(function(){window.openURL("/")})}};var Z,q=100,Q=0,et=!0;r(b,2e3)}]),f.controller("BreatheRecordCtrl",["$scope","$state","$stateParams","$http","$controller","$timeout","$translate","AccountService",function(e,t,o,i,n,a,r,s){n("RethinkRecordCtrl",{$scope:e});var c="female";e.playOptions={options:["Record my own","I am calm","I am strong","I am","I believe in myself","I can accomplish anything","I can handle whatever comes my way","I love myself","This too shall pass"],playOptionOrdinal:0},e.getPlayOptionDisplay=function(e){var t="RELAX_RECORD_ACTIVITY_"+e;return t=t.replace(/ /g,"_").toUpperCase(),r.instant(t)},e.updatePlayOption=function(){e.playOptions.playOptionOrdinal>0&&e.nextStep()},g(e,s),e.nextStep=function(){e.mediaRec.stopRecord(),e.clearCache();var i=s.getUserPreference(t.current.data.nextHelpStatePreference),n=e.src;if(e.playOptions.playOptionOrdinal>0){var r="img/breathing-sounds/narration-visualization/"+c+"/"+e.playOptions.options[e.playOptions.playOptionOrdinal]+".mp3";r=r.replace(/ /g,"-"),n=r}var l={src:n,cycleLength:e.cycleLength,bgAudioSource:e.bgAudioSource,cycles:t.current.data.nextStateCycles,meditationMode:o.meditationMode},u=t.current.data.nextState;i||(u=t.current.data.nextHelpState,l.intro=!0),a(function(){t.go(u,l)},1)}}]),f.controller("RelaxNarrationCtrl",["$scope","$rootScope","$state","$http","$stateParams","$controller","$timeout","$translate","$analytics","$ionicHistory","$ionicPopup","$ionicModal","AccountService","MediaService","HabitsService","GeneralService","Environment",function(e,o,n,a,r,s,c,l,u,d,p,g,f,T,m,E,_){function S(){}function A(t){t!==Media.MEDIA_STOPPED||e.exited||e.preFinishExercise()}function D(){e.bgAudio&&T.setVolume(e.bgAudio,e.volumeData.bgVolume*(w/C)),C>w?(c(D,30),++w):w=0}function L(){e.bgAudio&&T.setVolume(e.bgAudio,e.volumeData.bgVolume*((C-w)/C)),C>w?(c(L,30),++w):w=0}function b(){x&&R()}function G(){y&&(e.paused||y.getCurrentPosition(function(t){e.elapsedTime="object"==typeof t?t.status.value:t})),e.exited||(e.narrationTimeout=c(G,100))}function R(){e.paused||e.exited||(x&&(e.bgAudio&&e.bgAudio.play(h),D(),x=!1),U>0?(U-=1,P=c(R,1e3)):e.started?e.finishExercise():e.startExercise())}window.plugins&&window.plugins.bgVideo&&window.plugins.bgVideo.playAudioInBackground(),e.paused=!1,e.started=!1,e.finished=!1,e.exited=!1,e.elapsedTime=0,e.startTime=0,e.enableMeditationMode="true"==r.meditationMode,e.meditationLength=60*+r.meditationLength*1e3,window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.keepAwake(),e.bgAudio=void 0;var y,N=0;if(e.narrationIndex=I.indexOf(r.src),e.expectedNarrationLength=O[e.narrationIndex],e.displayedDownloadPopup=!1,"none"!=r.bgAudioSource&&(e.bgAudioSource=r.bgAudioSource,i(e,c,T,f,S,_)),e.bellSound=T.loadMedia("img/buddhist-bell.mp3",void 0,function(e){}),r.src&&r.src.length>0&&"none"!=r.src){e.exercise=t(r.src);var M="meditations/";y=T.loadMeditationMedia(M+r.src,A),N=y.getDuration(),y.setVolume(.6)}e.getElapsedTime=function(){if(!y){{e.meditationLength}if(!e.started)return"";if(e.paused)return E.getTimeDisplay((e.meditationLength-e.elapsedTime)/1e3);var t=(new Date).getTime(),o=e.meditationLength-(e.elapsedTime+(t-e.startTime));return 0>o&&(o=0,e.preFinishExercise(),e.bellSound&&e.bellSound.play()),E.getTimeDisplay(o/1e3)}if(e.started){if(e.elapsedTime>=0){0>N&&(N=y.getDuration());var i=N-e.elapsedTime;return 0>i&&(i=0),!e.displayedDownloadPopup&&N>0&&N<e.expectedNarrationLength-5&&(p.alert({template:l.instant("RELAX_ACTIVITIY_INCOMPLETE_DOWNLOAD"),okText:l.instant("OK_GOT_IT"),okType:"button-default"}),e.displayedDownloadPopup=!0),E.getTimeDisplay(i)}return E.getTimeDisplay(0)}return 0>N&&(N=y.getDuration()),N>0?E.getTimeDisplay(N):""},e.finishedExercise=function(){return e.finished},e.startExercise=function(){e.exited||(e.started=!0,y&&y.play(v),e.startTime=(new Date).getTime())},e.closeHealthKitModal=function(){f.setUserPreference("integrate_with_healthkit","true"),closeModal(e.healthKitModal),e.healthKitModal.remove(),e.healthKitModal=void 0,e.finishExercise()},e.showHealthkitIntegration=function(){var e=f.getUserPreference("integrate_with_healthkit");return!e},e.checkHealthKitModal=function(){return _.isIos()&&!_.isIPad()&&!e.isUMNUser()&&e.showHealthkitIntegration()?(g.fromTemplateUrl("views/habits/habits.healthkitModal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.healthKitModal=t,openModal(e.healthKitModal)}),!0):!1},e.finishExercise=function(){if(!e.checkHealthKitModal()){if(!e.isUMNUser())if(e.exercise)m.saveMindfulMinutes(e.exercise.audioLength);else{var t=(new Date).getTime(),o=(e.elapsedTime+(t-e.startTime))/1e3;m.saveMindfulMinutes(o)}n.go("app.relax"),c(function(){window.openURL("/")})}},e.preFinishExercise=function(){if(e.finished=!0,u.eventTrack("finishRelaxExercise",{category:"relax"}),!e.enableMeditationMode){U=y?3:10;var t=y?1e3:7e3;c(L,t),c(R,t)}f.recordActivity(e.exercise?e.exercise.activity:"COMPLETED_UNGUIDED_MEDITATION")},e.pause=function(){e.paused=!e.paused,e.paused?(e.bgAudio&&e.bgAudio.pause(),y&&y.pause(),y||(e.elapsedTime+=(new Date).getTime()-e.startTime,e.startTime=0),u.eventTrack("pauseNarration",{category:"relax"})):(e.started?y&&y.play(v):R(),e.bgAudio&&e.bgAudio.play(h),e.startTime=(new Date).getTime(),u.eventTrack("playNarration",{category:"relax"}))},window.backButtonOverride=function(){var t=!1;e.paused||(e.pause(),t=!0);var o=p.confirm({template:'<div class="thisisatest">'+l.instant("EXIT_ACTIVITY_CONFIRM")+"</div>",cancelText:l.instant("CANCEL"),cancelType:"button-default",okText:l.instant("CONFIRM"),okType:"button-default"});o.then(function(o){o?(window.backButtonOverride=void 0,e.goBack()):t&&e.pause()})},e.destroyCtrl=function(){e.bgAudio&&(e.bgAudio.stop(),e.bgAudio.release()),e.bellSound&&(e.bellSound.stop(),e.bellSound.release()),y&&(y.stop(),y.release()),e.narrationTimeout&&c.cancel(e.narrationTimeout),window.backButtonOverride=void 0,e.exited=!0},e.$on("$destroy",function(){e.destroyCtrl(),window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.allowSleepAgain()});var P,C=100,w=0,x=!0,U=3;e.showElapsedTime=function(){return!0},e.narrationTimeout=c(G,100),c(b,2e3)}]),f.controller("RelaxHelpCtrl",["$scope","$rootScope","$state","$http","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r,s){a("HelpCtrl",{$scope:e}),e.confirm=function(){s.setUserPreference("completed_relax_intro","true"),r.currentView(r.backView()),o.go("app.relax",{},{location:"replace"})}}]),f.controller("MeditateHelpCtrl",["$scope","$rootScope","$state","$http","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r,s){a("HelpCtrl",{$scope:e}),e.confirm=function(){s.setUserPreference("completed_meditate_intro","true"),r.currentView(r.backView()),o.go("app.meditate",{},{location:"replace"})}}]),f.controller("RelaxRecordHelpCtrl",["$scope","$rootScope","$state","$http","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r,s){a("HelpCtrl",{$scope:e}),e.confirm=function(){s.setUserPreference("completed_visualization_intro","true"),r.currentView(r.backView()),o.go(n.nextState,{maxTime:n.maxTime,cycleLength:n.cycleLength,bgAudioSource:n.bgAudioSource,meditationMode:n.meditationMode},{location:"replace"})}}]),f.controller("BreatheHelpCtrl",["$scope","$rootScope","$state","$http","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r,s){a("HelpCtrl",{$scope:e}),e.confirm=function(){s.setUserPreference("completed_breathe_intro","true"),r.currentView(r.backView()),o.go("app.breathe-exercise",{exercise:n.exercise,cycleLength:n.cycleLength,bgAudioSource:n.bgAudioSource,meditationMode:n.meditationMode,breathingSounds:n.breathingSounds,src:n.src},{location:"replace"})}}])}(),function(){function e(){$ionicPopup.alert({title:"",template:"<div>"+$translate.instant("THOUGHTS_MIC_ACCESS_PROMPT")+"</div>",okText:$translate.instant("OK_GOT_IT"),okType:"button-default"}).then(function(){("app.rethink-record"==$state.current.name||"app.breathe-record"==$state.current.name||"app.muscles-record"==$state.current.name)&&$ionicHistory.goBack()})}function t(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.diagnostic&&cordova.plugins.diagnostic.requestMicrophoneAuthorization(function(t){t===cordova.plugins.diagnostic.permissionStatus.GRANTED||e()},function(){e()})}function o(e,t,o){var i="";return t.indexOf("catastrophizing")>=0&&(i+=e.instant("THOUGHTS_EMOTIONS_CATASTROPHIZING")),t.indexOf("emotional_reasoning")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_EMOTIONAL_REASONING")),t.indexOf("mind_reading")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_MIND_READING")),t.indexOf("fortune_telling")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_FORTUNE_TELLING")),t.indexOf("extreme_words")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_PRESSURIZED")),t.indexOf("judging")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_LABELLING")),t.indexOf("personalization")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_PERSONALIZATION")),t.indexOf("overgeneralizing")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_GENERALIZING")),t.indexOf("negative_filtering")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_NEGATIVE")),t.indexOf("notsure")>=0&&(i.length>0&&(i+=", "),i+=e.instant("NEGATIVE_THOUGHT")),0===i.length&&(i=e.instant("negative"==o?"NEGATIVE_THOUGHT":"POSITIVE_THOUGHT")),i}function i(e,t){function o(o){o.root.getFile(e,{create:!0,exclusive:!1},function(e){t(e)},function(){})}function i(){}window.LocalFileSystem&&window.requestFileSystem(LocalFileSystem.TEMPORARY,0,o,i)}function n(e,t,o,n){if(d[t])o.mediaRec=d[t],o.elapsedTime=o.mediaRec.__elapsedTime,o.elapsedTime||(o.elapsedTime=0);else{var r=function(e){o.mediaRec=new Media(e,function(){},function(e){},n),o.mediaRec.setVolume(1),a(),d[t]=o.mediaRec};i(t,function(t){e.isAndroid()?(o.nativeSrc=t.nativeURL,r(o.nativeSrc)):(o.nativeSrc=t.nativeURL,r(t.fullPath))})}}function a(){for(var e in d)d[e].release(),delete d[e]}function r(e,t,o,i,n,a,r,s){window.backButtonOverride=function(){r&&r();var t=e.confirm({template:'<div class="thisisatest">'+n+"</div>",cancelText:i.instant("CANCEL"),cancelType:"button-default",okText:i.instant("CONFIRM"),okType:"button-default"});t.then(function(e){e&&(a&&a(),o.goBack())})},window.backButtonOverrideCaller=s}function s(e){e==window.backButtonOverrideCaller&&(window.backButtonOverride=void 0,window.backButtonOverrideCaller=void 0)}function c(){localStorage.removeItem("rethinkReplayState")}var l=angular.module("rethinkCtrl",[]),u=0;l.controller("ThoughtsCtrl",["$scope","$state","$translate","$ionicPopup","$ionicActionSheet","AccountService","AudioService","PayService","SkillsService","Environment",function(e,t,o,i,n,a,r,s,c,l){e.activityOptions={options:["THOUGHTS_ACTIVITY_COGNITIVE_DISTORTIONS","THOUGHTS_ACTIVITY_JOURNAL","THOUGHTS_ACTIVITY_GRATITUDE","THOUGHTS_ACTIVITY_POSITIVITY"],activityOptionOrdinal:0};var u=a.getUserPreference("preferred_thought_activity");if(u){var d=e.activityOptions.options.indexOf(u);d>=0&&(e.activityOptions.activityOptionOrdinal=d)}e.goToGratitudeCommunity=function(){if(l.isOnline()){var e=l.isDevelopment()?9:4;t.go("app.communities-posts",{groupId:e,order:"hotness"}),$analytics.eventTrack("goToGratitudeCommunity",{category:"thoughts"})}else{i.alert({template:o.instant("GROUPS_OFFLINE_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})}},e.updateActivityOption=function(){a.setUserPreference("preferred_thought_activity",e.activityOptions.options[e.activityOptions.activityOptionOrdinal])},e.isActivitySuggested=function(e){var t=c.getSuggestedActivityId();return t?"THOUGHTS_ACTIVITY_COGNITIVE_DISTORTIONS"==e?"COMPLETED_RETHINK"==t:"THOUGHTS_ACTIVITY_JOURNAL"==e?"COMPLETED_JOURNAL"==t:"THOUGHTS_ACTIVITY_GRATITUDE"==e?"COMPLETED_GRATITUDE_JOURNAL"==t:"THOUGHTS_ACTIVITY_POSITIVITY"==e?"COMPLETED_POSITIVITY_JOURNAL"==t:void 0:!1},e.isActivityOption=function(t){return e.activityOptions.activityOptionOrdinal==e.activityOptions.options.indexOf(t)},e.getActivityOptionDescription=function(){return o.instant(e.isActivityOption("THOUGHTS_ACTIVITY_JOURNAL")?"THOUGHTS_JOURNAL_HEADER":e.isActivityOption("THOUGHTS_ACTIVITY_GRATITUDE")?"THOUGHTS_GRATITUDE_DESCRIPTION":e.isActivityOption("THOUGHTS_ACTIVITY_POSITIVITY")?"THOUGHTS_POSITIVITY_DESCRIPTION":"THOUGHTS_RECORD_DESCRIPTION")},e.isPremiumEnabled=function(){return a.isPremiumEnabled()},e.setActivityOption=function(t){var o=e.activityOptions.options.indexOf(t);0===o||e.isPremiumEnabled()?(e.activityOptions.activityOptionOrdinal=o,e.updateActivityOption()):s.showPremiumModal(e,"thoughts","activityOption",!0)},e.getActivityOptionDisplay=function(e){return o.instant(e)},e.inputOptions={options:[o.instant("TEXT"),o.instant("VOICE")],inputOptionOrdinal:0};var p=a.getUserPreference("preffered_thought_input");p&&"VOICE"==p&&(e.inputOptions.inputOptionOrdinal=1),e.updateInputOption=function(){0===e.inputOptions.inputOptionOrdinal?a.setUserPreference("preffered_thought_input","TEXT"):a.setUserPreference("preffered_thought_input","VOICE")},e.getInputOptionDisplay=function(e){var t="INPUT_OPTION_";t+=e==o.instant("TEXT")?"TEXT":"VOICE",t=t.replace(/ /g,"_").replace(/\+/g,"").replace(/-/g,"").replace(/__/g,"_").toUpperCase();var i=o.instant(t);return i},e.startActivity=function(){if(e.updateInputOption(),0===e.activityOptions.activityOptionOrdinal)0===e.inputOptions.inputOptionOrdinal?(r.clearActiveTextThought(),a.getUserPreference("completed_text_thoughts_intro_record")?t.go("app.textthoughts-record"):t.go("app.textthoughts-record-help",{intro:!0})):a.getUserPreference("completed_rethink_intro_record")?t.go("app.rethink-record"):t.go("app.rethink-record-help",{intro:!0});else{var o={},i=e.activityOptions.options[e.activityOptions.activityOptionOrdinal];"THOUGHTS_ACTIVITY_GRATITUDE"==i?o.journalType="gratitude":"THOUGHTS_ACTIVITY_POSITIVITY"==i&&(o.journalType="positivity"),0===e.inputOptions.inputOptionOrdinal?t.go("app.textthoughts-journal",o):t.go("app.journal-record",o)}}}]),l.controller("TextThoughtsJournalCtrl",["$scope","$rootScope","$controller","$state","$stateParams","$timeout","$translate","$ionicNavBarDelegate","$ionicPopup","$ionicModal","AccountService","AudioService","HabitsService","Environment",function(e,t,o,i,n,a,r,s,c,l,u,d){o("TextThoughtsRecordCtrl",{$scope:e}),e.showHelp=function(){return!1},e.getThoughtsRecordHeader=function(){return r.instant("gratitude"==n.journalType?"JOURNAL_GRATITUDE_HEADER":"positivity"==n.journalType?"JOURNAL_POSITIVITY_HEADER":"JOURNAL_RECORD_HEADER")},e.getPageTitle=function(){return r.instant("gratitude"==n.journalType?"THOUGHTS_ACTIVITY_GRATITUDE":"positivity"==n.journalType?"THOUGHTS_ACTIVITY_POSITIVITY":"ADD_JOURNAL")},e.getTextPlaceholder=function(){return r.instant("gratitude"==n.journalType?"GRATITUDE_TEXT_PLACEHOLDER":"positivity"==n.journalType?"POSITIVITY_TEXT_PLACEHOLDER":"JOURNAL_TEXT_PLACEHOLDER")},e.cleanThought=function(){},e.getNextStepText=function(){return r.instant(e.hasText()?"SAVE":"START")},e.nextStep=function(){if(!e.hasText())return void a(function(){$("textarea").focus()});e.textThoughtError=void 0,d.clearActiveTextThought();var t,o;"gratitude"==n.journalType?(o="THOUGHTS_ACTIVITY_GRATITUDE",t="COMPLETED_GRATITUDE_JOURNAL"):"positivity"==n.journalType?(o="THOUGHTS_ACTIVITY_POSITIVITY",t="COMPLETED_POSITIVITY_JOURNAL"):(o="JOURNAL",t="COMPLETED_JOURNAL");{var r=d.createThought(o);d.addRecording(void 0,void 0,"journal",e.thought.length,r.id,e.thought)}d.postThought(r.id,"TEXT_JOURNAL"),u.recordActivity(t),i.go("app.home")}}]),l.controller("TextThoughtsRecordCtrl",["$scope","$state","$timeout","$translate","$ionicNavBarDelegate","$ionicPopup","AccountService","AudioService","HabitsService","Environment",function(e,t,o,i,n,a,r,s,c,l){function u(){l.isAndroid()&&$(".bar-footer").hide()
}function d(){l.isAndroid()&&$(".bar-footer").show()}s.clearActiveTextHighlight(),e.isAndroid=function(){return l.isAndroid()},e.showHelp=function(){return!0},e.isAndroid()&&window.ionic.keyboard&&window.ionic.keyboard.disable(),e.thought=s.getActiveTextThought(),e.thought||(e.thought=""),l.isOnline()||o(function(){a.alert({title:"Warning",template:i.instant("THOUGHTS_OFFLINE_PROMPT"),okText:"OK, GOT IT.",okType:"button-default"})}),e.getPageTitle=function(){return i.instant("THOUGHTS_STEP_ONE_OF_THREE")},e.getThoughtsRecordHeader=function(){return i.instant("THOUGHTS_RECORD_HEADER")},e.getTextPlaceholder=function(){return i.instant("THOUGHTS_RECORD_QUESTIONS")},e.hasText=function(){return e.thought.length>0},e.cleanThought=function(){e.thought=e.thought.replace(/\r?\n|\r/g," "),e.thought=e.thought.replace(/\s\s+/g," ")},e.getNextStepText=function(){return i.instant(e.hasText()?"NEXT_STEP":"START")},e.nextStep=function(){return e.hasText()?(e.textThoughtError=void 0,e.cleanThought(),s.storeActiveTextThought(e.thought),void(r.getUserPreference("completed_text_thoughts_intro_analyze")?t.go("app.textthoughts-analyze"):t.go("app.textthoughts-analyze-help",{intro:!0}))):void o(function(){$("textarea").focus()})},e.goToHelp=function(){e.cleanThought(),s.storeActiveTextThought(e.thought),t.go("app.textthoughts-record-help")};var p=window.innerHeight;window.resizeTextArea=function(){var e=$("ion-content").offset(),t=$("h2").outerHeight(),o=$(".bar-footer").outerHeight();$("textarea").css("height",p-t-e.top-o)},e.$on("$ionicView.afterEnter",function(){o(resizeTextArea,1e3)}),window.addEventListener("native.keyboardshow",u),window.addEventListener("native.keyboardhide",d),e.$on("$destroy",function(){e.isAndroid()&&window.ionic.keyboard&&window.ionic.keyboard.enable(),window.removeEventListener("native.keyboardshow",u),window.removeEventListener("native.keyboardhide",d)})}]),l.controller("TextThoughtsAnalyzeCtrl",["$sce","$scope","$state","$timeout","$translate","$ionicActionSheet","$ionicModal","$ionicPopup","$ionicPopover","$ionicScrollDelegate","AccountService","AudioService","HabitsService","Environment",function(e,t,i,n,a,r,s,c,l,u,d,p,g,f){function v(){t.recording.tags.sort(function(e,t){return e.tagTime-t.tagTime})}function h(){if(0===A.length)t.thoughtHTML=e.trustAsHtml('<span class="thoughtWord">'+O.join('</span> <span class="thoughtWord">')+"</span>");else{for(var o="",i=0;i<O.length;++i){for(var a=!1,r=!1,s=!1,c="",l=0;l<A.length;++l){var u=A[l];if(i>=u.start&&i<=u.end){r=i==u.start,s=i==u.end,a=!0,u.tagType&&(c=u.tagType),r&&(c+=" start"),s&&(c+=" end");break}}o+=a?'<span class="thoughtWord thoughtHighlight '+c+'">':'<span class="thoughtWord">',o+=O[i],a&&!s&&(o+=" "),o+="</span>",(!a||s)&&(o+=" ")}t.thoughtHTML=e.trustAsHtml(o)}n(function(){$(".thoughtWord").click(E)}),t.$$phase||t.$digest()}function T(e,i,n){var r=$.event.fix(e),s=i?i.split(","):[],c=o(a,s,n),u='<ion-popover-view class="platform-ios review-tip"><ion-header-bar> <h1 class="title">'+c+'</h1> </ion-header-bar><ion-content><a href="javascript:;" class="custom-popover-button" onclick="clearHighlight()">Clear</a></ion-content></ion-popover-view>';t.removePopover(),t.popover=l.fromTemplate(u,{scope:t}),t.popover.show(r)}function m(e){var o=$.event.fix(e),i='<ion-popover-view class="platform-ios highlight-tooltip"><ion-header-bar> <h1 class="title">'+a.instant("TEXT_THOUGHTS_ANALYZE_HIGHLIGHT_TOOLTIP")+"</h1> </ion-header-bar></ion-popover-view>";t.removeHighlightPopover(),t.highlightPopover=l.fromTemplate(i,{scope:t}),t.highlightPopover.show(o)}function E(e){var o=$(e.target),i=o.parent().children().index(o);if(o.hasClass("thoughtHighlight")){for(var r=-1,s=0;s<A.length;++s){var l=A[s];if(i>=l.start&&i<=l.end){r=s;break}}window.clearHighlight=function(){r>=0&&(A.splice(r,1),p.storeActiveTextHighlights(A),h(),t.recording.tags&&t.recording.tags.splice(r,1),t.removePopover())};var u=r>=0?t.recording.tags[r]:void 0,g=u?u.tagString:void 0;return void T(e,g,u.tagTypeString)}if(S==i&&t.activeHighlight)S=void 0;else if(void 0===S){S=i;var f=d.getUserPreference("viewed_highlight_tooltip");f&&"false"!=f||(m(e),d.setUserPreference("viewed_highlight_tooltip",!0))}else{for(var v=i>S?i:S,E=i>S?S:i,I=0;I<A.length;++I){var O=A[I];if(E<O.start&&v>O.end)return c.alert({title:"",template:"<div>"+a.instant("THOUGHTS_OVERLAPPING_HIGHLIGHT_ERROR")+"</div>",okText:a.instant("OK_GOT_IT"),okType:"button-default"}),void(S=void 0)}t.activeHighlight={start:E,end:v},A.push(t.activeHighlight),A.sort(function(e,t){return e.start-t.start}),p.storeActiveTextHighlights(A),h(),S=void 0,n(_)}}function _(){t.hideSheet=r.show({buttons:[{text:a.instant("NEGATIVE")}],cancelText:a.instant("CANCEL"),cancel:function(){var e=A.indexOf(t.activeHighlight);A.splice(e,1),t.activeHighlight=void 0,h(),t.hideSheet(),p.storeActiveTextHighlights(A)},buttonClicked:function(){return t.activeHighlight.tagType="negative",t.showEmotionModal(),p.storeActiveTextHighlights(A),h(),!0}})}t.isAndroid=function(){return f.isAndroid()};var S,I=p.getActiveTextThought(),O=I.split(" "),A=[],D=p.getActiveTextHighlights();if(D&&(A=D),t.negativeThoughts=[],t.showingHelp=[],t.thought=p.createThought(),t.recording=p.addRecording(void 0,void 0,"thought",O.length,t.thought.id,I),A.length>0){t.recording.tags||(t.recording.tags=[]);for(var L=0;L<A.length;++L){var b=A[L];t.recording.tags.push({tagTypeString:b.tagType,tagTime:b.start,tagSpan:b.end-b.start+1,tagString:b.tagString})}v()}p.setActiveThoughtId(t.thought.id),h(),t.removePopover=function(){t.popover&&(t.popover.remove(),t.popover=void 0)},t.$on("$destroy",function(){t.removePopover(),t.removeHighlightPopover(),window.showTagToolTip=void 0,window.clearHighlight=void 0}),t.removeHighlightPopover=function(){t.highlightPopover&&(t.highlightPopover.remove(),t.highlightPopover=void 0)},t.isSelected=function(e){return t.negativeThoughts.indexOf(e)>=0},t.showReplayHelp=function(e){if(t.isShowingHelp(e)){var o=t.showingHelp.indexOf(e);t.showingHelp.splice(o,1)}else t.showingHelp.push(e);event.stopPropagation(),event.preventDefault()},t.isShowingHelp=function(e){return t.showingHelp.indexOf(e)>=0},t.setNegativeThought=function(e){if("notsure"!=e&&t.isSelected("notsure")){var o=t.negativeThoughts.indexOf("notsure");o>=0&&t.negativeThoughts.splice(o,1)}else"notsure"==e&&(t.negativeThoughts.length=0);if(t.isSelected(e)){var i=t.negativeThoughts.indexOf(e);t.negativeThoughts.splice(i,1)}else t.negativeThoughts.push(e)},t.assignThoughts=function(){if(t.activeHighlight){t.recording.tags||(t.recording.tags=[]);var e;"negative"==t.activeHighlight.tagType&&(e=t.negativeThoughts.join(",")),t.recording.tags.push({tagTypeString:t.activeHighlight.tagType,tagTime:t.activeHighlight.start,tagSpan:t.activeHighlight.end-t.activeHighlight.start+1,tagString:e}),v(),t.activeHighlight.tagString=e,p.storeActiveTextHighlights(A),t.activeHighlight=void 0}t.closeEmotionModal()},t.showEmotionModal=function(){t.negativeThoughts.length=0,t.showingHelp.length=0,t.setNegativeThought("notsure"),s.fromTemplateUrl("views/thoughts/rethink.emotions.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.emotionsModal=e,openModal(t.emotionsModal)})},t.closeEmotionModal=function(e){t.emotionsModal&&(closeModal(t.emotionsModal),t.emotionsModal.remove(),t.emotionsModal=void 0),e&&(A.length=A.length-1,t.activeHighlight=void 0,h(),p.storeActiveTextHighlights(A))},t.getTagCount=function(e){var o=0;if(t.recording.tags)for(var i=0;i<t.recording.tags.length;++i){var n=t.recording.tags[i];e&&"positive"==n.tagTypeString?++o:e||"negative"!=n.tagTypeString||++o}return o},t.canGoToNextStep=function(){return t.recording.tags&&t.recording.tags.length>0},t.nextStep=function(){d.getUserPreference("completed_text_thoughts_intro_rethink")?i.go("app.textthoughts-rethink",{thoughtId:t.thought.id}):i.go("app.textthoughts-rethink-help",{intro:!0,thoughtId:t.thought.id})};var G=window.innerHeight;window.resizeTextArea=function(){var e=$("ion-content").offset(),t=$("h2").outerHeight(),o=$(".bar-footer").outerHeight();$(".thought-highlight-box").css("height",G-t-e.top-o)},t.$on("$ionicView.afterEnter",function(){n(resizeTextArea,1e3)})}]),l.controller("TextThoughtsRethinkCtrl",["$sce","$scope","$rootScope","$state","$controller","$stateParams","$timeout","$translate","$ionicActionSheet","$ionicModal","$ionicPopover","$ionicPopup","AccountService","AudioService","HabitsService","Environment",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g,f,v){function h(){var o="";I="";for(var i=-1,n=0;n<E.length;++n){for(var a=!1,s=!1,c=!1,l="",u=0;u<O.length;++u){var d=O[u];if(n>=d.tagTime&&n<=d.tagTime+d.tagSpan-1){s=n==d.tagTime,c=n==d.tagTime+d.tagSpan-1,a=!0,d.tagTypeString&&(l=d.tagTypeString),s&&(++i,_[i]?l+=" replaced":"negative"==d.tagTypeString&&(l+=" toReplace"));break}}if(s?o+='<span class="thoughtWord thoughtHighlight start end original '+l+'">':a||(o+='<span class="thoughtWord">'),o+=E[n],I+=E[n],a&&!c&&(o+=" "),s){var p=I.split(" "),g={tagTime:p.length-1,tagSpan:O[i].tagSpan,tagTypeString:O[i].tagTypeString,tagString:O[i].tagString};S[i]=g}if(n<E.length&&(I+=" "),(c||!a)&&(o+="</span>",c&&_[i])){var f=I.split(" "),h=_[i],A=h.content.split(" ");h.tagTime=f.length-1,h.tagSpan=A.length,I+=h.content+" ",o+=' <span class="thoughtWord thoughtHighlight positive replacement">'+h.content+"</span>"}(!a||c)&&(o+=" ")}t.thoughtHTML=e.trustAsHtml(o),r(function(){$(".toReplace").click(m),v.isAndroid()||v.isIos()?$(".replacement").on("tap",T):$(".replacement").click(T)}),t.$$phase||t.$digest()}function T(e){var o=$(e.target),i=o.prev(),n=i.parent().children(".original").index(i),a='<ion-popover-view class="platform-ios review-tip"><ion-header-bar> <h1 class="title">'+s.instant("POSITIVE_THOUGHT")+'</h1> </ion-header-bar><ion-content><a href="javascript:;" class="custom-popover-button" onclick="removeReplacement('+n+')">Clear</a></ion-content></ion-popover-view>';t.removePopover(),t.popover=u.fromTemplate(a,{scope:t});var r=$.event.fix(e);t.popover.show(r)}function m(e){var o=$(e.target);t.thoughtToReplace=o[0].innerText,t.tagIndexToReplace=o.parent().children(".original").index(o),t.replaceWrapper={thoughtReplacement:""},l.fromTemplateUrl("views/thoughts/thoughts.text.replace.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.replaceModal=e,openModal(t.replaceModal)})}t.isAndroid=function(){return v.isAndroid()},t.thought=g.getThought(a.thoughtId),t.thoughtRecording=t.thought.recordings.thought;var E=t.thoughtRecording.notes.split(" "),_={},S={};t.analyzeRecording=g.addRecording(void 0,void 0,"analysis",E.length,t.thought.id);var I="",O=t.thoughtRecording.tags;O||(O=[]),O.sort(function(e,t){return e.tagTime-t.tagTime}),t.closeReplaceModal=function(){closeModal(t.replaceModal),t.replaceModal.remove(),t.replaceModal=void 0},t.replacethought=function(){var e=(t.thoughtRecording.tags[t.tagIndexToReplace],t.replaceWrapper.thoughtReplacement.trim());e=e.replace(/\s\s+/g," "),_[t.tagIndexToReplace]={tagTypeString:"positive",content:e},h(),t.closeReplaceModal()},t.removePopover=function(){t.popover&&(t.popover.remove(),t.popover=void 0)},t.$on("$destroy",function(){t.removePopover(),window.removeReplacement=void 0}),window.removeReplacement=function(e){delete _[e],h(),t.removePopover()},t.hasReplacementText=function(){return t.replaceWrapper&&t.replaceWrapper.thoughtReplacement&&t.replaceWrapper.thoughtReplacement.length>0},h(),t.getTextThoughtsRethinkTitle=function(){return e.trustAsHtml(s.instant("TEXT_THOUGHTS_RETHINK_TITLE"))},t.getTagCount=function(e){var t=0;if(e){for(var o=0;o<O.length;++o)"positive"==O[o].tagTypeString&&++t;for(var i in _)++t}else for(var n=0;n<O.length;++n)"negative"==O[n].tagTypeString&&(_[n]||++t);return t},t.finish=function(){t.analyzeRecording.notes=I;for(var e=[],o=0;o<O.length;++o){var n=S[o];if(e.push(n),_[o]){n.replaced=!0;var a=$.extend({},_[o]);delete a.content,e.push(a)}}t.analyzeRecording.tags=e,g.postThought(t.thought.id,"TEXT_DISTORTIONS"),p.recordActivity("COMPLETED_RETHINK"),i.go("app.home")},t.closeCompletedRethinkModal=function(){p.setUserPreference("completed_rethink","true"),closeModal(t.completedRethinkModal),t.completedRethinkModal.remove(),t.completedRethinkModal=void 0,i.go("app.home")};var A=window.innerHeight;window.resizeTextArea=function(){var e=$("ion-content").offset(),t=$("h2").outerHeight(),o=$(".bar-footer").outerHeight();$(".thought-highlight-box").css("height",A-t-e.top-o)},t.$on("$ionicView.afterEnter",function(){r(resizeTextArea,1e3)})}]),l.controller("TextThoughtsJournalReviewCtrl",["$sce","$scope","$rootScope","$state","$controller","$stateParams","$timeout","$translate","$ionicActionSheet","$ionicModal","$ionicPopup","$ionicPopover","AccountService","AudioService","HabitsService",function(e,t,o,i,n,a,r,s,c,l,u,d,p,g){t.thought=a.thoughtId?g.getThought(a.thoughtId):g.getTextThoughtForReview();var f=t.thought.recordings.journal;t.journal=f.notes,t.getToughtTitle=function(){return t.thought.title}}]),l.controller("TextThoughtsReviewCtrl",["$sce","$scope","$rootScope","$state","$controller","$stateParams","$timeout","$translate","$ionicActionSheet","$ionicModal","$ionicPopup","$ionicPopover","AccountService","AudioService","HabitsService",function(e,t,i,n,a,r,s,c,l,u,d,p,g,f){t.thought=r.thoughtId?f.getThought(r.thoughtId):f.getTextThoughtForReview(),t.analysisRecording=t.thought.recordings.analysis,t.thoughtRecording=t.thought.recordings.thought;var v;t.analysisRecording?v=t.analysisRecording.notes.split(" "):t.thoughtRecording&&(v=t.thoughtRecording.notes.split(" "));var h="",T=-1,m=t.analysisRecording?t.analysisRecording.tags:[];m.sort(function(e,t){return e.tagTime-t.tagTime});for(var E=0;E<v.length;++E){for(var _=!1,S=!1,I=!1,O="",A="",D=0;D<m.length;++D){var L=m[D];if(E>=L.tagTime&&E<=L.tagTime+L.tagSpan-1){S=E==L.tagTime,I=E==L.tagTime+L.tagSpan-1,_=!0,L.tagTypeString&&(O=L.tagTypeString,"negative"==L.tagTypeString&&(A="onClick=\"showTagToolTip(event, '"+L.tagString+"', '"+L.tagTypeString+"')\"")),S&&(++T,L.replaced&&(O+=" replaced"));break}}E>0&&(h+=" "),S&&(h+='<span class="thoughtWord thoughtHighlight start end '+O+'" '+A+">"),h+=v[E],I&&(h+="</span>")}t.thoughtHTML=e.trustAsHtml(h),t.getToughtTitle=function(){return t.thought.title},t.removePopover=function(){t.popover&&(t.popover.remove(),t.popover=void 0)},window.showTagToolTip=function(e,i,n){var a=$.event.fix(e),r=i?i.split(","):[],s=o(c,r,n),l='<ion-popover-view class="platform-ios"><ion-header-bar> <h1 class="title">'+s+"</h1> </ion-header-bar></ion-popover-view>";t.removePopover(),t.popover=p.fromTemplate(l,{scope:t}),t.popover.show(a)},t.$on("$destroy",function(){t.removePopover(),window.showTagToolTip=void 0})}]),l.controller("RethinkCtrl",["$scope","$state","$translate","$ionicPopup","AccountService",function(e,t,o,i,n){e.goToRecord=function(){n.getUserPreference("completed_rethink_intro_record")?t.go("app.rethink-record"):t.go("app.rethink-record-help",{intro:!0})},e.recordingInfo=function(){i.alert({title:"",template:"<div>"+o.instant("THOUGHTS_RECORD_PRIVATE_PLACE_PROMPT")+"</div>",okText:o.instant("OK_GOT_IT"),okType:"button-default"})}}]),l.controller("RethinkHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r){n("HelpCtrl",{$scope:e}),e.confirm=function(){r.setUserPreference("completed_rethink_intro","true"),e.intro?(a.currentView(a.backView()),o.go("app.thoughts-list",{},{location:"replace"})):a.goBack()}}]),l.controller("TextThoughtsRecordHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r){n("HelpCtrl",{$scope:e}),e.confirm=function(){r.setUserPreference("completed_text_thoughts_intro_record","true"),a.currentView(a.backView()),o.go("app.textthoughts-record",{},{location:"replace"})}}]),l.controller("TextThoughtsAnalyzeHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r){n("HelpCtrl",{$scope:e}),e.confirm=function(){r.setUserPreference("completed_text_thoughts_intro_analyze","true"),a.currentView(a.backView()),o.go("app.textthoughts-analyze",{},{location:"replace"})}}]),l.controller("TextThoughtsRethinkHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r){n("HelpCtrl",{$scope:e}),e.confirm=function(){r.setUserPreference("completed_text_thoughts_intro_rethink","true"),a.currentView(a.backView()),o.go("app.textthoughts-rethink",{thoughtId:i.thoughtId},{location:"replace"})}}]),l.controller("RethinkRecordHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r){n("HelpCtrl",{$scope:e}),e.confirm=function(){r.setUserPreference("completed_rethink_intro_record","true"),a.currentView(a.backView()),o.go("app.rethink-record",{},{location:"replace"})}}]),l.controller("RethinkReplayHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,a,r){n("HelpCtrl",{$scope:e}),e.confirm=function(){r.setUserPreference("completed_rethink_intro_replay","true"),a.currentView(a.backView()),o.go("app.rethink-replay",{duration:+i.duration},{location:"replace"})}}]),l.controller("RethinkAnalyzeHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService","AudioService",function(e,t,o,i,n,a,r,s){n("HelpCtrl",{$scope:e}),e.confirm=function(){r.setUserPreference("completed_rethink_intro_analyze","true"),a.currentView(a.backView());var e=s.getActiveThoughtId();o.go("app.rethink-analyze",{thoughtId:e},{location:"replace"})}}]),l.controller("ThoughtsListCtrl",["$rootScope","$scope","$http","$state","$stateParams","$controller","$timeout","$analytics","$translate","$ionicPopup","$ionicGesture","$ionicScrollDelegate","$ionicActionSheet","AccountService","AudioService","SkillsService","GeneralService","Environment",function(e,t,i,n,a,r,s,c,l,u,d,p,g,f,v,h,T,m){function E(){t.thoughts.sort(function(e,t){var o=new Date(e.createdAtString),i=new Date(t.createdAtString);return i-o})}function _(){v.clearNonPersistedThoughts(),t.thoughts=v.getThoughts().slice(0),t.thoughtCount=v.getThoughtCount(),E(),p.resize()}function S(){O&&(angular.element(O).addClass("hideRemove"),O=void 0)}function I(e,t,o){return e.recordings&&e.recordings[t]?e.recordings[t][o]:void 0}t.showHelp=function(){g.show({buttons:[{text:'<i class="icon ion-ios-help-outline"></i> '+l.instant("WHAT_IS_THOUGHTS")},{text:'<i class="icon ion-ios-play-outline"></i> '+l.instant("WATCH_MILO_HAS_DOUBTS")},{text:'<i class="icon ion-ios-list-outline"></i> '+l.instant("VIEW_COMMON_QUESTIONS")}],cancelText:l.instant("CANCEL"),cancel:function(){},buttonClicked:function(t){return 0===t?e.$broadcast("event:viewVideo",{video:f.THOUGHTS_VIDEO}):1===t?f.viewVideo(f.THOUGHTS_VIDEO):2==t&&window.open("http://help.thinkpacifica.com/hc/en-us/sections/200763778-Thoughts","_blank","location=no"),!0}})},t.goToGratitudeCommunity=function(){if(m.isOnline()){var e=m.isDevelopment()?9:4;n.go("app.communities-posts",{groupId:e,order:"hotness"}),c.eventTrack("goToGratitudeCommunity",{category:"thoughts"})}else{u.alert({template:l.instant("GROUPS_OFFLINE_ERROR"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})}},t.thoughts=[],_(),e.$on("event:userContextInitialized",_),t.getThoughtsLevel=function(){return h.getSkillLevel("thoughts")},t.goToSkills=function(){window.openURL("/progress/mood?tab=skills")},t.hasMoreThoughts=function(){return t.thoughts.length<t.thoughtCount},t.loadMoreThoughts=function(){return m.isOnline()?(t.loadingMoreThoughts=!0,void v.loadMoreThoughts(t.thoughts.length,10).success(function(){_(),p.resize(),t.loadingMoreThoughts=!1}).error(function(e){t.loadingMoreThoughts=!1})):void u.alert({title:"Warning",template:l.instant("THOUGHTS_OFFLINE_LOAD_MORE_PROMPT"),okText:"OK, GOT IT.",okType:"button-default"})},t.showingDetails={};var O;t.elementDragged=function(e){for(var o in t.showingDetails)delete t.showingDetails[o];if("dragleft"==e.type){S();{angular.element(e.currentTarget).scope()}O=e.currentTarget,angular.element(e.currentTarget).removeClass("hideRemove")}else angular.element(e.currentTarget).addClass("hideRemove"),O=void 0},t.getThoughtDay=function(e){var t=new Date(e.createdAtString);return T.getDateDisplay(t)},t.getThoughtTime=function(e){var t=new Date(e.createdAtString);return T.getMinuteDisplay(t)},t.getMarks=function(e,t){var o=0,i=e.recordings,n=i.thought;if(n&&n.tags)for(var a=0;a<n.tags.length;++a){var r=n.tags[a];t&&"positive"==r.tagTypeString?++o:t||"negative"!=r.tagTypeString||++o}return o},t.getRecordingSource=function(e,t){return I(e,t,"url")},t.getRecordingDuration=function(e,t){return I(e,t,"duration")},t.getRecordingTags=function(e,t){return I(e,t,"tags")},t.getRecordingTagLabel=function(e){var t=e.tagString?e.tagString.split(","):[];return o(l,t,e.tagTypeString)},t.getRecordingTagTimeDisplay=function(e){var t=e.tagTime;0>t&&(t=0);var o=Math.floor(t/60),i=Math.floor(t-60*o);return(10>o?"0"+o:o)+":"+(10>i?"0"+i:i)},t.showDetails=function(e){if("AUDIO_DISTORTIONS"==e.thoughtType||"AUDIO_JOURNAL"==e.thoughtType){"AUDIO_DISTORTIONS"==e.thoughtType?c.eventTrack("toggleThoughtDetails",{category:"thoughts"}):c.eventTrack("toggleJournalDetails",{category:"thoughts"}),S();var o,i=!1;for(var a in t.showingDetails)a==e.id?i=!0:o=a;i||(o&&delete t.showingDetails[o],t.showingDetails[e.id]=!0),p.resize()}else"TEXT_DISTORTIONS"==e.thoughtType?(c.eventTrack("showTextThoughtDetails",{category:"thoughts"}),n.go("app.textthoughts-review",{thoughtId:e.id})):"TEXT_JOURNAL"==e.thoughtType&&(c.eventTrack("showTextJournalDetails",{category:"thoughts"}),n.go("app.textthoughts-journalreview",{thoughtId:e.id}))},t.isShowingDetails=function(e){return t.showingDetails[e.id]},t.renameThought=function(e){event.stopPropagation(),event.preventDefault(),t.renamePopupData={title:e.title},u.show({template:l.instant("THOUGHTS_RENAME_THOUGHT_PROMPT")+':<br><input type="text" ng-model="renamePopupData.title" autofocus><br>',scope:t,buttons:[{text:l.instant("CANCEL")},{text:l.instant("SAVE"),type:"button-default",onTap:function(){e.title=t.renamePopupData.title,v.updateThoughtTitle(e.id,e.title)}}]}),event.preventDefault(),event.stopPropagation()},t.archiveThought=function(e){function t(){if(m.isOnline())v.archiveThought(e.id).success(function(){_()});else{u.alert({template:l.instant("THOUGHTS_REMOVE_OFFLINE_PROMPT"),okText:l.instant("OK_GOT_IT"),okType:"button-default"})}}event.stopPropagation(),event.preventDefault();var o=u.confirm({template:'<div class="thisisatest">'+l.instant("THOUGHTS_REMOVE_PROMPT")+"</div>",cancelText:l.instant("CANCEL"),cancelType:"button-default",okText:l.instant("REMOVE"),okType:"button-default"});o.then(function(e){e&&t()})}}]);var d={};l.controller("RethinkRecordCtrl",["$sce","$scope","$rootScope","$controller","$state","$stateParams","$http","$timeout","$location","$analytics","$translate","$ionicHistory","$ionicModal","$ionicPopup","$ionicNavBarDelegate","AccountService","AudioService","GeneralService","HabitsService","Environment",function(e,o,l,p,g,f,v,h,T,m,E,_,S,I,O,A,D,L,b,G){if(window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.keepAwake(),t(I,_,g,E),o.mediaRec=void 0,o.recording=!1,o.elapsedTime=0,o.src=void 0,o.maxTime=f.maxTime,o.maxTime||(o.maxTime=300),o.audioPrefix=g.current.data.audioPrefix,o.nextState=g.current.data.nextState,o.helpState=g.current.data.helpState,o.clearRethinkState=g.current.data.clearRethinkState,!G.isOnline()&&"thoughts"==o.audioPrefix){I.alert({title:"Warning",template:E.instant("THOUGHTS_OFFLINE_PROMPT"),okText:"OK, GOT IT.",okType:"button-default"})}var R=D.getActiveThoughtId();R&&(o.thoughtId=R),o.getThoughtsRecordHeader=function(){return E.instant("THOUGHTS_RECORD_HEADER")},o.initializeSource=function(e){if(e&&d[e])o.src=e,n(G,o.src,o),o.elapsedTime>0&&(o.finishedRecording=!0);else{a();var t=G.isAndroid()?".amr":".m4a";o.src=o.audioPrefix+ ++u+t,o.finishedRecording=!1,n(G,o.src,o)}D.setActiveSource(o.audioPrefix,o.src)},o.initializeSource(D.getActiveSource(o.audioPrefix)),r(I,O,_,E,E.instant("THOUGHTS_GO_BACK_PROMPT"),function(){a()},function(){o.stopRecording()},"record"),o.clearRethinkState&&c(),o.resetRecording=function(){m.eventTrack("resetRecordingPopup",{category:"thoughts"});var e=I.confirm({template:'<div class="thisisatest">'+E.instant("THOUGHTS_RESET_PROMPT")+"</div>",cancelText:E.instant("CANCEL"),cancelType:"button-default",okText:E.instant("RESET"),okType:"button-default"});e.then(function(e){e?(o.initializeSource(void 0,!0),o.recording=!1,o.elapsedTime=0,m.eventTrack("resetThought",{category:"thoughts",label:o.audioPrefix}),m.eventTrack("resetRecordingConfirm",{category:"thoughts"})):m.eventTrack("resetRecordingCancel",{category:"thoughts"})})},o.$on("$ionicView.beforeLeave",function(){s("record"),window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.allowSleepAgain()}),o.$on("$destroy",function(){}),o.stopRecording=function(){o.mediaRec.pauseRecord(),o.recording=!1,o.finishedRecording=!0},o.recordAudio=function(){o.canRecord()&&(o.finishedRecording?(o.finishedRecording=!1,o.mediaRec.resumeRecord(),m.eventTrack("resumeRecordThought",{category:"thoughts",label:o.audioPrefix})):(o.mediaRec.startRecord(),m.eventTrack("recordThought",{category:"thoughts",label:o.audioPrefix})),o.recording=!0,h(o.updateTime,1e3))},o.showRecordHelp=function(){o.recording=!1,o.mediaRec&&o.mediaRec.pauseRecord(),g.go(o.helpState)},o.clearCache=function(){a()},o.closeCompletedRethinkModal=function(){A.setUserPreference("completed_rethink","true"),closeModal(o.completedRethinkModal),o.completedRethinkModal.remove(),o.completedRethinkModal=void 0,g.go(o.nextState,{src:o.src,duration:o.elapsedTime})},o.nextStep=function(){o.mediaRec.stopRecord(),a();var e=!0;if("rethink"==o.audioPrefix&&(c(),A.recordActivity("COMPLETED_RETHINK"),A.setUserPreference("completed_rethink",!0),o.thoughtId&&i(o.src,function(e){D.addRecording(e.toURL(),o.src,"analysis",o.elapsedTime,o.thoughtId),D.postThought(o.thoughtId,"AUDIO_DISTORTIONS")})),g.current.data.nextHelpStatePreference){var t=A.getUserPreference(g.current.data.nextHelpStatePreference);t||(e=!1,g.go(g.current.data.nextHelpState,{src:o.src,duration:o.elapsedTime,intro:!0}))}e&&g.go(o.nextState,{src:o.src,duration:o.elapsedTime})},o.getElapsedTime=function(){return L.getTimeDisplay(o.elapsedTime)},o.canRecord=function(){return o.elapsedTime<o.maxTime},o.updateTime=function(){o.recording&&(o.elapsedTime+=1,o.mediaRec.__elapsedTime=o.elapsedTime,o.elapsedTime>=o.maxTime?o.stopRecording():h(o.updateTime,1e3))}}]),l.controller("JournalRecordCtrl",["$scope","$rootScope","$state","$stateParams","$http","$controller","$timeout","$translate","$ionicModal","AccountService","AudioService","HabitsService",function(e,t,o,n,a,r,s,c,l,u,d){r("RethinkRecordCtrl",{$scope:e}),e.getJournalHeader=function(){return c.instant("gratitude"==n.journalType?"JOURNAL_GRATITUDE_HEADER":"positivity"==n.journalType?"JOURNAL_POSITIVITY_AUDIO_HEADER":"JOURNAL_RECORD_HEADER")},e.getJournalTitle=function(){return c.instant("gratitude"==n.journalType?"THOUGHTS_ACTIVITY_GRATITUDE":"positivity"==n.journalType?"THOUGHTS_ACTIVITY_POSITIVITY":"ADD_JOURNAL")},e.nextStep=function(){e.mediaRec.stopRecord(),e.clearCache();u.getUserPreference(o.current.data.nextHelpStatePreference);e.thought=d.createThought("AUDIO_JOURNAL"),i(e.src,function(t){d.addRecording(t.toURL(),e.src,"journal",e.elapsedTime,e.thought.id),d.postThought(e.thought.id,"AUDIO_JOURNAL"),u.recordActivity("COMPLETED_JOURNAL"),o.go("app.home")})}}]),l.controller("RethinkReplayCtrl",["$scope","$state","$sce","$http","$timeout","$location","$stateParams","$analytics","$translate","$ionicModal","$ionicPopup","$ionicHistory","$ionicLoading","$ionicNavBarDelegate","Environment","AudioService","GeneralService","AccountService",function(e,t,o,c,l,u,d,p,g,f,v,h,T,m,E,_,S,I){function O(t,o){var i=angular.element(document.querySelector("#waveform"))[0].offsetWidth,n=e.wavesurfer.getDuration()/i;return e.wavesurfer.addRegion({color:t,start:o-2*n,end:o+2.9*n})}function A(){for(var t=0;t<e.state.marks.length;++t){var o=e.state.marks[t],i="#d04b51";o.positive&&(i="#60d293"),O(i,e.state.marks[t].tagTime)}}function D(){var t,o=e.currentTime;if(o>0)for(var i=e.wavesurfer.getDuration(),n=angular.element(document.querySelector("#waveform"))[0].offsetWidth,a=i/n,r=10*a,s=Number.MAX_VALUE,c=0;c<e.state.marks.length;++c){var l=e.state.marks[c],u=Math.abs(l.tagTime-o);!l.positive&&r>u&&s>u&&(t=l,s=u)}return t}function L(){!e.nativeSrc&&5>R?(++R,l(L,1e3)):e.loadAudio(e.nativeSrc)}function b(t){i(e.src,function(o){_.addRecording(o.toURL(),e.src,"thought",t,e.thought.id)})}e.src=_.getActiveSource("thoughts"),e.status=0,e.getTitleHTML=function(){return o.trustAsHtml(g.instant("THOUGHTS_REPLAY_INSTRUCTIONS"))},n(E,e.src,e,function(t){e.status=t,t==Media.MEDIA_RUNNING?e.playing=!0:(e.playing=!1,t==Media.MEDIA_STOPPED&&(e.state.finishedPlaying=!0)),e.$$phase||e.$apply()}),e.wavesurfer=void 0,e.playing=!1,e.loadedData=!1,e.showingHelp=[],e.showError=!1,e.status=void 0,e.currentTime=0,e.duration=d.duration,e.playSeek=!1,e.loading=!0,e.negativeThoughts=[],e.updatingMark=void 0,e.performReset=function(){e.state={finishedPlaying:!1,marks:[],position:0},e.wavesurfer&&e.wavesurfer.clearRegions()},e.resetReplay=function(){p.eventTrack("resetReplayPopup",{category:"thoughts"});var t=v.confirm({template:'<div class="thisisatest">'+g.instant("THOUGHTS_RESET_PROMPT")+"</div>",cancelText:g.instant("CANCEL"),cancelType:"button-default",okText:g.instant("RESET"),okType:"button-default"});t.then(function(t){t?(e.performReset(),p.eventTrack("resetReplayConfirm",{category:"thoughts"})):p.eventTrack("resetReplayCancel",{category:"thoughts"})})},e.performReset();var G=localStorage.getItem("rethinkReplayState");G&&(e.state=JSON.parse(G)),e.waveform=void 0,e.freqData=void 0,e.waveformData=void 0,f.fromTemplateUrl("views/thoughts/rethink.emotions.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.openEmotionModal=function(){e.playing&&e.playPause(),e.negativeThoughts.length=0,e.showingHelp.length=0,e.setNegativeThought("notsure"),openModal(e.modal)},e.openModalWithMark=function(t){e.playing&&e.playPause(),e.updatingMark=t,e.negativeThoughts=t.tags,e.showingHelp.length=0,openModal(e.modal)},e.closeEmotionModal=function(){closeModal(e.modal)},r(v,m,h,g,g.instant("THOUGHTS_GO_BACK_PROMPT"),function(){a()},void 0,"replay"),e.$on("$ionicView.beforeLeave",function(){s("replay")}),e.$on("$destroy",function(){e.playing&&e.playPause(),a(),e.modal.remove(),e.wavesurfer&&(e.wavesurfer.unAll(),e.wavesurfer=void 0,window.wavesurfer=void 0)}),e.$on("modal.hidden",function(){}),e.$on("modal.removed",function(){}),e.assignThoughts=function(t){if(e.updatingMark)e.updatingMark.tags=e.negativeThoughts.slice(0);else{var o="#d04b51";t&&(o="#60d293");var i=O(o,e.currentTime),n={tagTime:i.start,tags:e.negativeThoughts.slice(0),positive:t?t:!1};n.tagTime<0&&(n.tagTime=0),p.eventTrack("tagRecording",{category:"thoughts",label:t?"positive":n.tags.toString()}),e.state.marks.push(n)}e.updatingMark=void 0,e.negativeThoughts.length=0,e.closeEmotionModal()},e.setNegativeThought=function(t){if("notsure"!=t&&e.isSelected("notsure")){var o=e.negativeThoughts.indexOf("notsure");o>=0&&e.negativeThoughts.splice(o,1)}else"notsure"==t&&(e.negativeThoughts.length=0);if(e.isSelected(t)){var i=e.negativeThoughts.indexOf(t);e.negativeThoughts.splice(i,1)}else e.negativeThoughts.push(t)},e.showReplayHelp=function(t){if(e.isShowingHelp(t)){var o=e.showingHelp.indexOf(t);e.showingHelp.splice(o,1)}else e.showingHelp.push(t);event.stopPropagation(),event.preventDefault()},e.isSelected=function(t){return e.negativeThoughts.indexOf(t)>=0},e.isShowingHelp=function(t){return e.showingHelp.indexOf(t)>=0},e.setPosition=function(t){var o=t.pageX-t.target.offsetLeft,i=o/t.target.offsetWidth;
e.wavesurfer&&(e.wavesurfer.seekTo(i),e.mediaRec.seekTo(i*e.mediaRec.getDuration()*1e3))},e.monitorPlay=function(){e.mediaRec.getCurrentPosition(function(t){var o=e.mediaRec.getDuration();0>t&&(t=0),(0!==t||e.status!=Media.MEDIA_PAUSED)&&(e.currentTime=t,e.playSeek=!0,e.wavesurfer&&e.wavesurfer.seekTo(t/o),e.playing&&l(e.monitorPlay,5))})},e.playPause=function(){e.playing?(e.mediaRec.pause(),p.eventTrack("pausePlayback",{category:"thoughts"})):(e.mediaRec.play(),e.monitorPlay(),p.eventTrack("startPlayback",{category:"thoughts"})),e.playing=!e.playing,e.playing&&e.monitorPlay()},e.markAudio=function(){var t=D();t?e.openModalWithMark(t):e.openEmotionModal()},e.getAudioTime=function(){return e.loading?g.instant("LOADING")+"...":e.loadedData?S.getTimeDisplay(e.currentTime):"00:00"},e.getMarkCount=function(t){for(var o=0,i=0;i<e.state.marks.length;++i){var n=e.state.marks[i];t&&n.positive?++o:t||n.positive||++o}return o},e.loadAudio=function(o){var i=o,n=new XMLHttpRequest;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){function o(){var t=e.wavesurfer.getDuration();if(t>0){e.loadedData=!0,e.wavesurfer.seekTo(e.state.position/e.wavesurfer.getDuration()),e.mediaRec.seekTo(1e3*e.state.position),A();var i=Object.create(WaveSurfer.Timeline);i.init({wavesurfer:e.wavesurfer,container:"#waveform-timeline",fontFamily:'"Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;',primaryColor:"#ccc",secondaryColor:"#ccc",primaryFontColor:"#ccc",secondaryFontColor:"#ccc",height:10,duration:e.wavesurfer.getDuration()}),e.thought||(e.thought=_.createThought(),_.setActiveThoughtId(e.thought.id)),b(t),e.loading=!1,e.$$phase||e.$apply()}else E.isAndroid()&&(e.mediaRec.play(),e.mediaRec.pause()),5>a&&(l(o,5),++a)}e.wavesurfer=Object.create(WaveSurfer),window.wavesurfer=e.wavesurfer;var i={container:document.querySelector("#waveform"),waveColor:"#ccc",progressColor:"#fff",normalize:!0};e.wavesurfer.init(i),e.wavesurfer.on("seek",function(t){if(e.loadedData){if(e.playSeek)return void(e.playSeek=!1);if(e.currentTime=t*e.mediaRec.getDuration(),e.mediaRec&&e.mediaRec.seekTo(t*e.mediaRec.getDuration()*1e3),0!==t){var o=D();o&&e.openModalWithMark(o)}}});var a=0;e.wavesurfer.on("ready",function(){o()}),e.wavesurfer.on("progress",function(){e.$$phase||e.$apply()}),e.showHelp=function(){e.playing&&e.playPause(),e.state.position=e.currentTime,localStorage.setItem("rethinkReplayState",JSON.stringify(e.state)),t.go("app.rethink-replay-help")},e.nextStep=function(){e.state.position=e.currentTime,localStorage.setItem("rethinkReplayState",JSON.stringify(e.state)),e.thought&&_.addTags(e.thought,e.state.marks);var o=I.getUserPreference("completed_rethink_intro_analyze");o?t.go("app.rethink-analyze",{thoughtId:e.thought.id}):t.go("app.rethink-analyze-help",{thoughtId:e.thought.id,intro:!0})},window.webkitAudioContext||window.AudioContext?e.wavesurfer.loadArrayBuffer(n.response):v.alert({title:"",template:"<div>"+g.instant("THOUGHTS_PHONE_RENDERING_PROMPT")+"</div>",okText:g.instant("OK_GOT_IT"),okType:"button-default"})},n.send()};var R=0;l(L,1)}])}();var ctrl=angular.module("timeZoneCtrl",[]);ctrl.controller("TimeZoneCtrl",["$scope","$state","$http","$timeout","$analytics","$ionicLoading","$ionicPopup","AccountService","HabitsService","GoalsService","AudioService","PayService","Environment","Token",function(e,t,o,i,n,a,r,s){e.data={timeZone:""};var c=s.getUserPreference("preferred_timezone");c&&(timeZone=c),e.getUserTimeZone=function(){return s.getUserTimeZone()},e.updateTimeZone=function(){""===e.data.timeZone?s.clearUserPreference("preferred_timezone"):s.setUserPreference("preferred_timezone",e.data.timeZone)}}]);