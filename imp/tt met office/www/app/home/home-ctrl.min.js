angular.module("ionic.metApp").controller("HomeCtrl",["$cordovaSplashscreen","IonicClosePopupService","weatherHelperService","metApi","$scope","$timeout","$rootScope","Weather","Geo","Flickr","$ionicModal","$ionicPlatform","$ionicPopup","$interval","$ionicBackdrop","$state","$ionicHistory","$route","metCodes","$localstorage",function(t,e,a,o,r,n,c,s,m,u,l,d,g,f,_,p,h,v,b,x){r.activeBgImageIndex=0,r.isFlipped=!1,c.t="Today",f(function(){c.cdate=new Date}),ionic.Platform.ready(function(){n(function(){t.hide()},300)}),r.showAlert=function(t,e){g.alert({title:t,template:e})},r.closeModal=function(t){r[t].hide()},r.myGoBack=function(){h.goBack()},r.$on("modal.hidden",function(){_.release()}),r.format_updated_at=function(t){var e=[];e[0]=t.split(" ")[1],e[1]=Number(e[0].substring(0,2)),e[2]=Number(e[0].substring(2,4))-4,e[3]=Number(e[0].substring(4,6));var a=new Date;return new Date(Number(a.getFullYear()),Number(a.getMonth()),e[1],e[2],e[3])},r.searchTag=function(){var t=x.getObject("fcast"),e=a.timeOfDaySimple();if(t.forecastid){var o=a.am_pm_to_hours(t.sunrise,"hour"),r=a.am_pm_to_hours(t.sunrise,"minute");e=a.timeOfDay()?a.timeOfDay():e;var n=new Date,i=n.getHours();"morning"==e&&i>o&&7>i&&n.getMinutes()<=r&&(e="sunrise"),i>=0&&o>=i&&(e="night"),"morning"==e&&(e="mid day")}return e},r.day_string=function(t,e){var a=new Date,o=a.getHours(),r=(a.getMinutes(),a.getDay()),n=r+t;(o>=0||7>=o)&&"05:30PM"==e.forecastTime&&(r--,n=r+t);var i=["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun","Mon"];return i[n]},r.is_word_in_string=function(t,e){return new RegExp("\\b"+e+"\\b","i").test(t)},r.inArray=function(t,e){for(i=0;i<e.length;i++)if(e[i]==t)return e[i];return!1},r.metars_cloud=b.all(),c.go_toForecastHome=function(){p.go("app.forecast_home",{})},c.get_fcast=function(){o.get_forecast().then(function(t){c.fcast_result=t.data.items[0],x.setObject("fcast",c.fcast_result),c.$broadcast("f_cast_ready",c.fcast_result)},function(){c.doAlert("Error loading latest forecast"),c.fcast_result=x.getObject("fcast"),c.$broadcast("f_cast_ready",c.fcast_result)})},c.get_metars=function(){o.get_metar().then(function(t){c.metars_result=t.data.items,x.setObject("metars",c.metars_result),c.$broadcast("metars_loaded",c.metars_result)},function(){c.doAlert("Error loading latest metars"),c.metars_result=x.getObject("metars"),c.$broadcast("metars_loaded",c.metars_result)})},c.globalRefresh=function(){c.get_fcast(),c.get_metars()}}]).controller("TrinCtrl",["$filter","weatherHelperService","$cordovaSocialSharing","metApi","$scope","$timeout","$rootScope","Weather","Geo","Flickr","$ionicModal","$ionicPlatform","$ionicPopup","$interval","$ionicBackdrop","$state","$ionicHistory","$route","$window","$ionicLoading","$localstorage","$cordovaDialogs","metTT","$ionicPopover",function(t,e,a,o,r,n,c,s,m,u,l,d,g,f,_,p,h,v,b,y,T,w,$,C){function M(t,e){return(" "+t.className+" ").indexOf(" "+e+" ")>-1}var O=this,k=O;k.show=!0,r.fcastbago="sunny";var B=6e5;f(function(){h.clearCache().then(function(){v.reload(),O.refreshData(),c.get_fcast(),c.get_metars(),O.getBackgroundImage("Trinidad, "+r.searchTag()),v.reload()}),h.clearHistory()},B),c.ref_trin=function(){O.refreshData()},r.refreshImgTrin=function(){O.getBackgroundImage("Trinidad, "+r.searchTag()),r.popover.hide()},r.closePopover=function(){r.popover.hide()},r.share=function(){a.share("message","subject","file","link").then(function(t){},function(t){})},c.$on("metars_loaded",function(t,e){O.metars_trin()}),c.$on("f_cast_ready",function(t,a){O.trin_3day(),r.fcasttrin="night"==e.timeOfDay()?"fair-night":"fair"}),O.refreshData=function(){n(function(){O.get_uv_index()},1e3),O.getCurrent(null,null),c.get_fcast(),c.get_metars(),h.clearCache().then(function(){v.reload()})},O.getCurrent=function(t,e){c.$broadcast("scroll.refreshComplete")},O.cycleBgImages=function(){n(function(){if(r.bgImages){var t=Math.floor(Math.random()*r.bgImages.length)+0;r.activeBgImage=r.bgImages[t],n(function(){},2e3)}})},this.getBackgroundImage=function(t){u.search(t).then(function(t){var e=t.photos;r.bgImages=e.photo,O.cycleBgImages()},function(t){})},O.get_uv_index=function(){var t=[],e=new Date;r.has_index=!0;var a=document.getElementById("uv-index"),n=e.getDate()+"."+(e.getMonth()+1<9?"0"+(e.getMonth()+1):e.getMonth()+1)+"."+e.getFullYear(),i=["c1","c2","c3","c4","c5","c6","c7","c8","c9","c10","c11"];if(o.get_uv_index(function(e){for(var o=0;o<e.items.length;o++){var c=e.items[o].uv_date.trim();n==c&&t.push(e.items[o])}if(t.length){r.uv_index=t[t.length-1];var s=Number(r.uv_index.uv_value),o=s.toFixed(0);r.uv_index.uv_value=o;var m=0==o||1==o?0:11==o||o>11?10:o-1;for(r.uv_color=i[m],x=0;x<i.length;x++)M(a,i[x])&&a.classList.remove(i[x]);r.$watch("uv_color",function(){a.className=a.className+"  "+r.uv_color})}}),!t.length){r.has_index=!1;var c=[{uv_value:0}];r.uv_index=c[0],a.className=a.className+" c1"}},r.current_temp_trin="Loading..",O.metars_trin=function(){var t=T.getObject("metars"),a=$.all();O.mdata=[];var o=0;for(i=0;i<t.length;i++)if("TTPP"==t[i].station){if("Clouds"==t[o].label.replace(":","")){var n=t[o].value.toLowerCase();t[o].value=n.replace("agl","above ground level")}O.mdata.push({id:t[o].id,label:"Dewpoint"==t[o].label.replace(":","")?"Relative Humidity":t[o].label.replace(":",""),station:t[o].station,value:t[o].value,icon:a[o].icon,el:a[o].el,show:a[o].show}),o++}r.updated_at=r.format_updated_at(O.mdata[1].value),r.current_temp_trin=O.mdata[2].value.substring(0,3),O.mdata[2].txt="Feels like a "+e.cTemp(Number(r.current_temp_trin)),O.mdata[5].value=e.cWind(O.mdata[5].value),O.mdata[8].value=e.capFLetter(O.mdata[8].value),r.dew_point_trin=e.set_dew_point(3,O.mdata),O.mdata[3].value=r.dew_point_trin;var c=[];for(i=0;i<r.metars_cloud.length;i++)O.mdata[1].value.indexOf(r.metars_cloud[i].code)>-1&&c.push(r.metars_cloud[i].code);for(r.cc,i=0;i<c.length;i++)for("FEW"==c[i]&&(r.inArray("SCT",c)||r.inArray("BKN",c)||r.inArray("OVC",c)||(r.cc="FEW")),"SCT"==c[i]&&(r.inArray("BKN",c)||r.inArray("OVC",c)||(r.cc="SCT")),r.inArray("BKN",c)&&(r.cc="BKN"),r.inArray("OVC",c)&&(r.cc="OVC"),x=0;x<r.metars_cloud.length;x++)c[c.length-1]==r.metars_cloud[x].code&&(r.cc=r.metars_cloud[x].code);var s="";for(x=0;x<r.metars_cloud.length;x++)r.cc==r.metars_cloud[x].code&&(s=r.metars_cloud[x].desc,r.summary_text_trin=s);s||(s="Clear",r.summary_text_trin=s);var m=new Date;r.fcasttrin="Clear"==s||"Fair"==s?s+"-"+e.timeOfDay():s;var u=T.getObject("fcast"),l=e.am_pm_to_hours(u.sunrise,"hour"),d=e.am_pm_to_hours(u.sunrise,"minute");if(("Clear"==s||"Fair"==s)&&m.getHours()>=0&&m.getHours()<=l&&m.getMinutes()<=d&&(r.fcasttrin=s+"-night"),O.mdata[1].value.indexOf("NOSIG")>-1){var g=r.summary_text_trin;r.summary_text_trin=e.capFLetter(g)}else r.summary_text_trin=e.capFLetter(O.mdata[9]?O.mdata[9].value.match(/\(([^)]+)\)/)[1]:r.summary_text_trin).replace("(","");if(r.summary_text_trin.indexOf("Haze")>-1&&(r.summary_text_trin="Dust, smoke and other dry particles may be in the air"),r.fcasttrin.indexOf("Cloudy")>-1||r.fcasttrin.indexOf("cloudy")>-1){var f="night"==e.timeOfDay()?"-night":"";r.fcasttrin=r.fcasttrin+f,m.getHours()>=0&&m.getHours()<=l&&m.getMinutes()<=d&&(r.fcasttrin=r.fcasttrin+"-night")}},r.showMetarsTrin=function(){_.retain(),r.mettrin_modal?r.mettrin_modal.show():l.fromTemplateUrl("app/home/metars-trin.html",function(t){r.mettrin_modal=t,r.mettrin_modal.show()},{animation:"slide-in-up",scope:r})},r.open_trin_popover=function(t){C.fromTemplateUrl("app/home/trin_popover.html",{scope:r}).then(function(e){r.popover=e,r.popover.show(t)})},O.trin_3day=function(t){var e=T.getObject("fcast");r.tm=r.day_string(1,e),r.nd=r.day_string(2,e),O.ftime_trin=e.forecastTime,"05:30PM"==O.ftime_trin&&(c.t="Tonight",O.th=e.PiarcoFcstMxTemp,O.tl=e.PiarcoFcstMnTemp,O.maxtm=e.TmPiarcoMxTemp,O.mintm=e.TmPiarcoMnTemp,r.trin_tm_icon=e.TmWeatherPiarcoMx?e.TmWeatherPiarcoMx:"sunny",O.max24=e.maxTrin24look,O.min24=e.minTrin24look,r.trin_24_icon=e.wx24?e.wx24:"sunny"),"05:30PM"!=O.ftime_trin&&(c.t="Today",O.th=e.PiarcoFcstMxTemp,O.tl=e.TmPiarcoMnTemp,O.maxtm=e.maxTrin24look,O.mintm=e.minTrin24look,r.trin_tm_icon=e.wx24?e.wx24:"sunny",O.max24=e.maxTrin48look,O.min24=e.minTrin48look,r.trin_24_icon=e.wx48?e.wx48:"sunny"),r.trin_icon_today=e.imageTrin?e.imageTrin:"sunny"},O.refreshData(),n(function(){O.getBackgroundImage("Trinidad, "+r.searchTag())},300),d.on("resume",function(){O.refreshData(),n(function(){O.getBackgroundImage("Trinidad, "+r.searchTag())},300)})}]).controller("BagoCtrl",["weatherHelperService","metApi","$scope","$timeout","$rootScope","Weather","Geo","Flickr","$ionicModal","$ionicPlatform","$ionicPopup","$interval","$ionicBackdrop","$state","$ionicHistory","$route","$ionicLoading","$localstorage","metTB","$ionicPopover",function(t,e,a,o,r,n,c,s,m,u,l,d,g,f,_,p,h,v,b,y){var T=this,w=T;w.show=!0,a.fcastbago="sunny";var $=6e5;d(function(){_.clearCache().then(function(){r.get_fcast(),r.get_metars(),p.reload(),T.getBackgroundImage("Tobago, "+a.searchTag())}),_.clearHistory()},$),r.ref_bago=function(){T.refreshData()},a.open_bago_popover=function(t){y.fromTemplateUrl("app/home/bago_popover.html",{scope:a}).then(function(e){a.popover=e,a.popover.show(t)})},a.refreshImgBago=function(){T.getBackgroundImage("Tobago, "+a.searchTag()),a.popover.hide()},a.closePopover=function(){a.popover.hide()},r.$on("metars_loaded",function(t,e){T.metars_bago()}),r.$on("f_cast_ready",function(e,o){T.bago_3day(),a.fcastbago="night"==t.timeOfDay()?"fair-night":"fair"}),T.refreshData=function(){T.getCurrent(null,null),r.get_fcast(),r.get_metars()},T.getCurrent=function(t,e){r.$broadcast("scroll.refreshComplete")},T.cycleBgImages=function(){o(function(){if(a.bgImages){var t=Math.floor(Math.random()*a.bgImages.length)+0;a.activeBgImage=a.bgImages[t],setTimeout(function(){},2e3)}})},this.getBackgroundImage=function(t){s.search(t).then(function(t){var e=t.photos;a.bgImages=e.photo,T.cycleBgImages()},function(t){})},a.current_temp="Loading..",T.metars_bago=function(){var e=v.getObject("metars"),o=b.all();T.mdatab=null,T.mdatab=[];var r=0;for(i=0;i<e.length;i++)if("TTCP"==e[i].station){if("Clouds"==e[i].label.replace(":","")){var n=e[i].value.toLowerCase();e[i].value=n.replace("agl","above ground level")}T.mdatab.push({id:e[i].id,label:"Dewpoint"==e[i].label.replace(":","")?"Relative Humidity":e[i].label.replace(":",""),station:e[i].station,value:e[i].value,icon:void 0!=o[r]?o[r].icon:"",el:void 0!=o[r]?o[r].el:"",show:void 0!=o[r]?o[r].show:""}),r++}a.updated_at=a.format_updated_at(T.mdatab[1].value),a.current_temp=T.mdatab[2].value.substring(0,3),T.mdatab[2].txt="Looks like a "+t.cTemp(Number(a.current_temp)),T.mdatab[5].value=t.cWind(T.mdatab[5].value),T.mdatab[8].value=t.capFLetter(T.mdatab[8].value),a.dew_point=t.set_dew_point(3,T.mdatab),T.mdatab[3].value=a.dew_point;var c=[];for(i=0;i<a.metars_cloud.length;i++)T.mdatab[1].value.indexOf(a.metars_cloud[i].code)>-1&&c.push(a.metars_cloud[i].code);for(a.cd,i=0;i<c.length;i++)for("FEW"==c[i]&&(a.inArray("SCT",c)||a.inArray("BKN",c)||a.inArray("OVC",c)||(a.cc="FEW")),"SCT"==c[i]&&(a.inArray("BKN",c)||a.inArray("OVC",c)||(a.cc="SCT")),a.inArray("BKN",c)&&(a.cc="BKN"),a.inArray("OVC",c)&&(a.cc="OVC"),x=0;x<a.metars_cloud.length;x++)c[c.length-1]==a.metars_cloud[x].code&&(a.cd=a.metars_cloud[x].code);var s="";for(x=0;x<a.metars_cloud.length;x++)a.cd==a.metars_cloud[x].code&&(s=a.metars_cloud[x].desc,a.summary_text=s);s||(s="Clear",a.summary_text=s);var m=new Date;a.fcastbago="Clear"==s||"Fair"==s?s+"-"+t.timeOfDay():s;var u=v.getObject("fcast"),l=t.am_pm_to_hours(u.sunrise,"hour"),d=t.am_pm_to_hours(u.sunrise,"minute");if(("Clear"==s||"Fair"==s)&&m.getHours()>=0&&m.getHours()<=l&&m.getMinutes()<=d&&(a.fcastbago=s+"-night"),T.mdatab[1].value.indexOf("NOSIG")>-1){var g=a.summary_text;a.summary_text=t.capFLetter(g)}else a.summary_text=t.capFLetter(T.mdatab[9]?T.mdatab[9].value.match(/\(([^)]+)\)/)[1]:a.summary_text).replace("(","");if(a.summary_text.indexOf("Haze")>-1&&(a.summary_text="Dust, smoke and other dry particles may be in the air"),a.fcastbago.indexOf("Cloudy")>-1||a.fcastbago.indexOf("cloudy")>-1){var f="night"==t.timeOfDay()?"-night":"";a.fcastbago=a.fcastbago+f,m.getHours()>=0&&m.getHours()<=l&&m.getMinutes()<=d&&(a.fcastbago=a.fcastbago+"-night")}},a.showMetarsBago=function(){g.retain(),a.metbago_modal?a.metbago_modal.show():m.fromTemplateUrl("app/home/metars-bago.html",function(t){a.metbago_modal=t,a.metbago_modal.show()},{animation:"slide-in-up"})},T.bago_3day=function(t){var e=[],e=v.getObject("fcast");a.tm=a.day_string(1,e),a.nd=a.day_string(2,e),T.ftime_bago=e.forecastTime,"05:30PM"==T.ftime_bago&&(r.t="Tonight",T.th=e.CrownFcstMxTemp?e.CrownFcstMxTemp:" - ",T.tl=e.CrownFcstMnTemp?e.CrownFcstMnTemp:" - ",T.maxtm=e.TmCrownMxTemp,T.mintm=e.TmCrownMnTemp,a.bago_tm_icon=e.TmWeatherCpMx?e.TmWeatherCpMx:"sunny",T.max24=e.maxTob24look,T.min24=e.minTob24look,a.bago_24_icon=e.wx24cp?e.wx48cp:"sunny"),"05:30PM"!=T.ftime_bago&&(r.t="Today",T.th=e.CrownFcstMxTemp?e.CrownFcstMxTemp:" - ",ff=v.getObject("530pm_fcast"),T.tl=e.TmCrownMnTemp?e.TmCrownMnTemp:" - ",T.maxtm=e.maxTob24look,T.mintm=e.minTob24look,a.bago_tm_icon=e.wx24cp?e.wx24cp:"sunny",T.max24=e.maxTob48look,T.min24=e.minTob48look,a.bago_24_icon=e.wx48cp?e.wx48cp:"sunny"),a.bago_icon_today=e.imagebago},T.metars_bago(),T.bago_3day(),T.getBackgroundImage("Tobago, "+a.searchTag())}]);