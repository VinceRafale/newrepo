angular.module("app.controllers",[]).controller("appCtrl",["$scope","$rootScope","$translate","$ionicPlatform","$timeout","$interval","$ionicPopup","Share","ConnectivityMonitor","dataService","$ionicSideMenuDelegate","$ionicScrollDelegate","$ionicHistory","$filter","$state","auth","$localStorage","$location","wfConfig","$window","storeLocalData","$cordovaSQLite","$q",function(e,t,n,a,o,i,r,l,s,c,d,u,p,m,f,h,g,w,_,I,O,R,b){function T(){for(var n=0;n<y.length;n++)if(0==y[n].disabled&&"22"==y[n].source_id&&"ios"==ionic.Platform.platform()&&!t.accessHealthData){t.accessHealthData=!0,e.getHealthData(),t.healthkit_interval=setInterval(function(){e.getHealthData()},36e5);break}}function S(e){var t=b.defer();return window.plugins.healthkit.checkAuthStatus({type:e.value},function(){window.plugins.healthkit.querySampleTypeAggregated({startDate:new Date((new Date).getTime()-5184e5),endDate:new Date,aggregation:"day",sampleType:e.value,unit:e.unit},function(e){t.resolve(e)},function(e){t.resolve()})},function(){t.resolve()}),t.promise}function C(){var e=b.defer();return window.plugins.healthkit.findWorkouts({},function(t){e.resolve(t)},function(t){e.resolve()}),e.promise}function E(n){var a={id:t.localData.healthConnectionId,workouts:{workouts:n.workouts||[],daily:n.daily}},o={headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:[function(e){for(var t="",n=Object.keys(e),a=0;a<n.length;a++){var o=angular.isObject(e[n[a]])?JSON.stringify(e[n[a]]):e[n[a]];t=t+n[a]+"="+o,a!=n.length-1&&(t+="&")}return t}]};a.id&&c.post("connections/healthkit_activity",a,o).then(function(e){})["finally"](function(t){e.loading=!1})}e.$storage=g,t.localData&&t.localData.byRefer&&(t.isRefer=t.localData.byRefer),e.referPageDone=function(){e.isReferVisited=!0},a.ready(function(){o(function(t){_.ONLINE=s.isOnline(),e.netwokState={offline:!_.ONLINE}}),s.startWatching(function(){e.netwokState.offline=!0,_.ONLINE=!1,e.$apply()},function(){e.netwokState.offline=!1,_.ONLINE=!0,e.$apply()})},!1),e.me=e.$storage.boot?e.$storage.boot.profile[0]:{},t.profileImage=e.$storage.boot.profile[0].image_url,t.localData.point={totalPoints:e.$storage.boot?parseInt(e.$storage.boot.dashboard.user[0].total_points,10):t.localData.point.totalPoints,lastUp:0,lastDown:0},O.set("point",JSON.stringify(t.localData.point)),t.localData.regions=e.$storage.boot?e.$storage.boot.regions:null,O.set("regions",JSON.stringify(t.localData.regions));var y=[];c.get("connections").then(function(e){y=e.data.content,T()}),e.totalConnections=function(e){var t=e.filter(function(e){return 0==parseInt(e.disabled)?e.source_id:void 0});return t.length},t.localData.deviceConnected=e.$storage.boot&&!t.localData.deviceConnected?e.totalConnections(e.$storage.boot.connections)>0:t.localData.deviceConnected,O.set("deviceConnected",JSON.stringify(t.localData.deviceConnected)),e.userLang=n.proposedLanguage()||n.use(),e.totalPoints=function(e){return e&&t.localData.point&&(t.localData.point.totalPoints=parseInt(e,10),O.set("point",JSON.stringify(t.localData.point))),t.localData.point?t.localData.point.totalPoints:0},e.pointDeduct=function(e){var n=t.localData.point.totalPoints-parseInt(e,10);return t.localData.point.lastDown=e,t.localData.point.totalPoints=n,O.set("point",JSON.stringify(t.localData.point)),n},e.pointAdd=function(e){var n=t.localData.point.totalPoints+parseInt(e,10);return t.localData.point.lastUp=e,t.localData.point.totalPoints=n,O.set("point",JSON.stringify(t.localData.point)),n},e.pointsExplanation=function(){if(!t.localData.pointInstructions){var n=r.alert({title:m("translate")("DASHBOARD.POINTS_INSTRUCTIONS_TITLE"),content:m("translate")("DASHBOARD.POINTS_INSTRUCTIONS_TEXT"),okType:"button-positive big-button",okText:m("translate")("ACTION.OK")});n.then(function(e){t.localData.pointInstructions=!0,O.set("pointInstructions",JSON.stringify(t.localData.pointInstructions))})}window.mixpanel&&window.mixpanel.track("Bar points",{userId:e.me.user_id,email:e.me.email}),e.goToDashboard()},e.toggleAccountMenu=function(t){t.preventDefault(),e.showAccountMenu=!e.showAccountMenu},e.closeSubMenu=function(){e.showAccountMenu=!1},e.$watch(function(){return d.isOpenRight()},function(t){t||(e.showAccountMenu=!1)}),e.goToDashboard=function(){p.nextViewOptions({disableBack:!0}),f.go("app.dashboard")},e.logoutAndClearData=function(){p.nextViewOptions({historyRoot:!0,disableBack:!0}),p.clearCache().then(function(){h.logout(),p.clearHistory(),I.localStorage.clear(),g.$reset(),t.localData.intro=!0,t.localData.hasOpenedApp=!0,t.localData.hasAccessedApp=!0,t.healthkit_interval&&(t.accessHealthData=!1,clearInterval(t.healthkit_interval)),R.execute(db,"DELETE FROM localStorage").then(function(e){O.set("intro",JSON.stringify(t.localData.intro)),O.set("hasOpenedApp",JSON.stringify(t.localData.hasOpenedApp)),O.set("hasAccessedApp",JSON.stringify(t.localData.hasAccessedApp))},function(e){}),f.go("auth.login",{},{reload:!0})})},e.logout=function(){r.confirm({title:m("translate")("NAV.LOGOUT"),template:"{{ 'ACTION.LOGOUT_MSG' | translate }}",cancelType:"big-button button-stable",cancelText:m("translate")("ACTION.CANCEL"),okType:"big-button button-positive",okText:m("translate")("NAV.LOGOUT")}).then(function(t){t&&(window.mixpanel&&window.mixpanel.track("Logout",{userId:e.me.user_id,email:e.me.email}),e.logoutAndClearData())})},e.doRefresh=function(t,n){return n&&(n.neverCache=!0,n.params&&(n.params=angular.extend(n.params,{limit:10,offset:0}))),c.get(t,n)["finally"](function(){e.$broadcast("scroll.refreshComplete")})},t.localData.shareVia={twitter:t.localData.shareVia?t.localData.shareVia.twitter:!1,fb:t.localData.shareVia?t.localData.shareVia.fb:!1},O.set("shareVia",JSON.stringify(t.localData.shareVia)),e.shareIt=l.shareIt,e.goBack=function(){p.goBack()},e.skipTourStep=function(t){window.mixpanel&&window.mixpanel.track("Tour: skip step",{userId:e.me.user_id,email:e.me.email,step:t})},e.getSupport=function(t,n){window.mixpanel&&window.mixpanel.track("Get support button",{userId:e.me.user_id,email:e.me.email,concept:t,location:n})},e.openLink=function(e){return window.open(e,"_system","location=yes,toolbar=yes"),!1},e.getHealthData=function(){var e=[{key:"workouts"},{key:"steps",value:"HKQuantityTypeIdentifierStepCount",unit:"count"},{key:"calories",value:"HKQuantityTypeIdentifierActiveEnergyBurned",unit:"kcal"},{key:"distance_walking",value:"HKQuantityTypeIdentifierDistanceWalkingRunning",unit:"m"},{key:"distance_biking",value:"HKQuantityTypeIdentifierDistanceCycling",unit:"m"}],t=[C(),S(e[1]),S(e[2]),S(e[3]),S(e[4])];b.all(t).then(function(t){for(var n={workouts:t[0],daily:{}},a=1;a<t.length;a++)t[a]&&(n.daily[e[a].key]=t[a]);E(n)},function(e){})}}]).controller("loginCtrl",["$scope","$rootScope","auth","$localStorage","$state","$ionicPopup","$translate","$filter","$ionicLoading","$ionicHistory","wfConfig","dataService","storeLocalData","$ionicModal","$ionicConfig",function(e,t,n,a,o,i,r,l,s,c,d,u,p,m,f){function h(){facebookConnectPlugin.login(["email","user_birthday","user_location","user_friends"],function(n){var a=n.authResponse.accessToken,o={lang:e.userLang,token:a,clientId:"1428206187458527",redirectUri:"http://localhost:8100/"};t.localData.countryCode&&(o.region=t.localData.countryCode),t.referraldata.referral_code&&(o.referral_code=t.referraldata.referral_code),u.post("user/facebook_login",o).then(function(t){var n=t.data.content.signup===!0;e.setupProfile(t,n)})["catch"](function(e){i.alert({title:l("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data?e.data.summary.message:l("translate")("LOGIN.LOGIN_FB_FAILED")})})["finally"](function(){})},function(e){i.alert({title:l("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data?e.data.summary.message:l("translate")("LOGIN.LOGIN_FB_FAILED")})})}e.$on("$ionicView.enter",function(e,t){c.clearHistory(),c.clearCache()}),e.defaultIcon=f.backButton.icon(),t.localData.hasOpenedApp||(t.localData.hasOpenedApp=!0,p.set("hasOpenedApp",JSON.stringify(t.localData.hasOpenedApp))),t.localData.signup&&(e.currentTab=!0),e.userLang=r.proposedLanguage()||r.use(),e.user={lang:e.userLang,region:t.localData.countryCode},e.errorRegister={},e.errorLogin={},e.errorSignup={},e.errorSignin={},e.tabCallback=function(t){e.isLogin="login"==t,e.isLogin?window.mixpanel&&window.mixpanel.track("Login"):window.mixpanel&&window.mixpanel.track("Signup")},m.fromTemplateUrl("templates/auth/signup.html",function(t){e.signupModal=t},{scope:e,animation:"slide-in-right"}),m.fromTemplateUrl("templates/auth/signin.html",function(t){e.signinModal=t},{scope:e,animation:"slide-in-right"}),e.isLogin=!1,e.errorRegister.show=!1,e.errorLogin.show=!1,e.errorSignup.show=!1,e.errorSignin.show=!1,e.validCredentials=!1;e.signInForm;e.signUp=function(){s.show({template:l("translate")("ACTION.LOADING")}),e.login.signInForm&&e.login.signInForm.email.$error.required?(e.errorSignup.show=!0,e.errorMsg=l("translate")("LOGIN.EMPTY_EMAIL"),s.hide()):e.login.signInForm&&e.login.signInForm.password.$error.required?(e.errorSignup.show=!0,e.errorMsg=l("translate")("LOGIN.EMPTY_PASSWORD"),s.hide()):e.login.signInForm&&!e.login.signInForm.email.$valid?(e.errorSignup.show=!0,e.errorMsg=l("translate")("LOGIN.INVALID_EMAIL"),s.hide()):(e.closeSignupModal(),e.user.referral_code=e.getReferralCode(),e.user.os=ionic.Platform.platform(),e.user.os_version=ionic.Platform.version(),n.signup(e.user,{ignoreLoadingBar:!0,headers:{"X-Wefitter-ApiToken":d.API_TOKEN}}).then(function(t){e.setupProfile(t,!0)})["catch"](function(t){400==t.data.summary.status&&"Email already in use"==t.data.summary.message&&(e.errorRegister.show=!0,e.errorMsg=l("translate")("REGISTER.EMAIL_IN_USE"),s.hide())})["finally"](function(){s.hide()}))},e.signIn=function(){s.show({template:l("translate")("ACTION.LOADING")}),e.login.signInForm&&e.login.signInForm.email.$error.required?(e.errorSignin.show=!0,e.errorMsg=l("translate")("LOGIN.EMPTY_EMAIL"),s.hide()):e.login.signInForm&&e.login.signInForm.password.$error.required?(e.errorSignin.show=!0,e.errorMsg=l("translate")("LOGIN.EMPTY_PASSWORD"),s.hide()):e.login.signInForm&&!e.login.signInForm.email.$valid?(e.errorSignin.show=!0,e.errorMsg=l("translate")("LOGIN.INVALID_EMAIL"),s.hide()):(e.closeSigninModal(),e.user.os=ionic.Platform.platform(),e.user.os_version=ionic.Platform.version(),n.login(e.user,{ignoreLoadingBar:!0,headers:{"X-Wefitter-ApiToken":d.API_TOKEN}}).then(function(t){e.setupProfile(t,!1)})["catch"](function(t){401==t.data.summary.status&&"Invalid email or password"==t.data.summary.message&&(e.errorLogin.show=!0,e.errorMsg=l("translate")("LOGIN.WRONG_CREDENTIALS"),s.hide())})["finally"](function(){s.hide()}),e.errorLogin.show=!1)},e.openSignupModal=function(){e.errorRegister.show=!1,e.signupModal.show()},e.closeSignupModal=function(){e.errorSignup.show=!1,e.signupModal.hide()},e.openSigninModal=function(){e.errorLogin.show=!1,e.signinModal.show()},e.closeSigninModal=function(){e.errorSignin.show=!1,e.signinModal.hide()},e.authenticate=function(a){if("facebook"==a&&(ionic.Platform.isIOS()||ionic.Platform.isAndroid()))facebookConnectPlugin.logout(function(e){h()},function(e){h()});else{var o={lang:e.userLang};t.localData.countryCode&&(o.region=t.localData.countryCode),t.referraldata.referral_code&&(o.referral_code=e.getReferralCode()),n.authenticate(a,o).then(function(t){var n=t.data.content.signup===!0;e.setupProfile(t,n)})["catch"](function(e){i.alert({title:l("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data?e.data.summary.message:l("translate")("LOGIN.LOGIN_FB_FAILED")})})}},e.getReferralCode=function(){var e=null;if(t.referraldata.referral_code)e=t.referraldata.referral_code;else{var n=localStorage.getItem("branchData"),a=JSON.parse(n);a&&""!=a&&"invite"==a.element&&(e=a.id,t.localData.byRefer=!0,t.localData.referData=a,p.set("byRefer",JSON.stringify(t.localData.byRefer)),p.set("referData",JSON.stringify(t.localData.referData)),localStorage.removeItem("branchData"))}return e},e.setupProfile=function(a,i){t.localData.hasAccessedApp=!0,p.set("hasAccessedApp",JSON.stringify(t.localData.hasAccessedApp)),t.localData.isSignup=i,p.set("isSignup",JSON.stringify(t.localData.isSignup)),t.localData.point={totalPoints:parseInt(a.data.content.total_points,10),lastUp:0,lastDown:0},p.set("point",JSON.stringify(t.localData.point)),i===!0?(t.localData.intro=!1,window.mixpanel&&(window.mixpanel.alias(a.data.content.id,null,function(){},function(){}),window.mixpanel.people.set({$created:new Date,$last_login:new Date}),window.mixpanel.track("Signed up",{userId:a.data.content.id})),window.fbq&&fbq("track","CompleteRegistration",{content_name:"app",value:.5,currency:"USD"})):(t.localData.intro=!0,p.set("intro",JSON.stringify(t.localData.intro)),window.mixpanel&&(window.mixpanel.identify(a.data.content.id,function(){},function(){}),window.mixpanel.people.set({$last_login:new Date}),window.mixpanel.track("Logged in",{userId:a.data.content.id}))),n.setToken(a),e.errorLogin.show=!1,e.errorRegister.show=!1,c.nextViewOptions({disableBack:!0}),document.addEventListener("deviceready",function(){window.plugins&&window.plugins.OneSignal&&a.data.content.id&&window.plugins.OneSignal.sendTags({userId:a.data.content.id,client:"app"})},!1);var r=localStorage.getItem("branchData"),l=JSON.parse(r);return t.localData.intro?void(l&&""!=l?(localStorage.removeItem("branchData"),("entity"==l.element||"challenge"==l.element||"reward"==l.element)&&(location.href="#/"+l.element+"/"+l.id)):o.go("app.dashboard",{},{reload:!0})):a.data.content.entity_id?(t.localData.byRefer=!0,t.localData.referData=a.data.content,p.set("byRefer",JSON.stringify(t.localData.byRefer)),o.go("intro.entity",{id:a.data.content.entity_id},{reload:!0})):a.data.content.challenge_id?(t.localData.byRefer=!0,t.localData.referData=a.data.content,p.set("byRefer",JSON.stringify(t.localData.byRefer)),o.go("intro.challenge",{id:a.data.content.challenge_id},{reload:!0})):a.data.content.friend_id?(t.localData.byRefer=!0,t.localData.referData=a.data.content,p.set("byRefer",JSON.stringify(t.localData.byRefer)),p.set("referData",JSON.stringify(t.localData.referData)),o.go("intro.friend-request",{},{reload:!0})):(t.localData.byRefer=!1,p.set("byRefer",JSON.stringify(t.localData.byRefer)),o.go("intro.start",{},{reload:!0}))}}]).controller("forgotCtrl",["$scope","$rootScope","auth","$state","$ionicPopup","$ionicLoading","$filter","$ionicHistory","wfConfig","storeLocalData",function(e,t,n,a,o,i,r,l,s,c){e.user={},e.errorForgot={},e.goBack=function(){l.goBack()},e.recoverPass=function(a){i.show({template:r("translate")("ACTION.LOADING")}),n.recover(e.user.email,{ignoreLoadingBar:!0,headers:{"X-Wefitter-ApiToken":s.API_TOKEN}}).then(function(e){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.close(),t.localData.hasAccessedApp=!0,c.set("hasAccessedApp",JSON.stringify(t.localData.hasAccessedApp)),o.alert({title:r("translate")("FORGOT_PASSWORD.SUCCESS"),okType:"button-positive big-button",content:"<div>{{ 'FORGOT_PASSWORD.SUCCESS_MSG' | translate }}</div>"})})["catch"](function(t){e.errorForgot.show=!0,e.errorMsg=t.data.summary.message})["finally"](function(){i.hide(),window.mixpanel&&window.mixpanel.track("Forgot password request")})}}]).controller("introCtrl",["$scope","$state","$rootScope","$localStorage","dataService","storeLocalData",function(e,t,n,a,o,i){e.isSignup=n.localData.isSignup,e.introStarted=function(){window.mixpanel&&window.mixpanel.track("Tour: started",{userId:e.me.user_id,email:e.me.email})},e.introDone=function(){n.localData.intro=!0,i.set("intro",JSON.stringify(n.localData.intro)),window.mixpanel&&window.mixpanel.track("Tour: finished",{userId:e.me.user_id,email:e.me.email}),window.fbq&&fbq("trackCustom","TourFinished",{content_name:"app",value:.5,currency:"USD"});var a=localStorage.getItem("branchData"),o=JSON.parse(a);o&&""!=o?(localStorage.removeItem("branchData"),"reward"==o.element&&(location.href="#/"+o.element+"/"+o.id)):t.go("app.dashboard",{},{reload:!0})}}]).controller("friend-requestCtrl",["$scope","$rootScope","$localStorage","dataService","$translate",function(e,t,n,a,o){e.referData=t.localData.referData,o("INTRO.FRIEND_TEXT_HEAD",{name:e.referData.friend_first_name}).then(function(t){e.friend_request_text_head=t}),o("INTRO.FRIEND_TEXT",{name:e.referData.friend_first_name,referral_code:e.me.referral_code}).then(function(t){e.friend_request_text=t})}]).controller("loginSlidesCtrl",["$scope","$rootScope","$localStorage","$ionicSlideBoxDelegate","$state","storeLocalData",function(e,t,n,a,o,i){e.activeSlide=0,n.hasOpenedApp||(n.hasOpenedApp=!0,window.mixpanel&&window.mixpanel.track("App opened first time")),e.finishSlides=function(){window.mixpanel&&window.mixpanel.track("Slides finished")},e.skipIntro=function(e){"login"==e?(t.localData.signup=!1,window.mixpanel&&window.mixpanel.track("slides skipped to login")):"signup"==e&&(t.localData.signup=!0,window.mixpanel&&window.mixpanel.track("Slides skipped to signup")),o.go("auth.login")}}]).controller("dashboardCtrl",["$scope","$rootScope","$timeout","wfConfig","$ionicPopup","$ionicLoading","dataService","$filter","$ionicScrollDelegate","$ionicSlideBoxDelegate","getDays",function(e,t,n,a,o,i,r,l,s,c,d){function u(e,t,n){return e>t?n>e?e:n:t}e.dash=e.$storage.boot.dashboard,c.update(),e.deviceConnected=t.localData.deviceConnected,e.$on("$ionicView.enter",function(){a.ONLINE&&e.pullRefresh("dashboard",0)}),document.addEventListener("deviceready",function(){window.plugins&&window.plugins.OneSignal&&e.me.user_id&&window.plugins.OneSignal.sendTags({userId:e.me.user_id,client:"app"})},!1),e.pullRefresh=function(t,n){var a={cache:!1,params:{update_activities:n}};n&&(i.show({template:l("translate")("DASHBOARD.UPDATE_ACTIVITIES_MSG"),duration:2500}),window.mixpanel&&window.mixpanel.track("Refresh activities",{userId:e.me.user_id,email:e.me.email})),e.doRefresh(t,a).then(function(t){e.$storage.boot.dashboard=e.dash=t.data.content,c.update(),e.totalPoints(e.$storage.boot.dashboard.user[0].total_points),n&&(r.flushRelatedCache(t),r.flushCacheByEndpoint("/workouts?")),t.data.content.summary.totals&&t.data.content.summary.totals.workouts>0&&o.alert({title:"Success",content:l("translate")("DASHBOARD.NEW_ACTIVITIES")+": "+t.data.content.summary.totals.workouts+"<br>"+l("translate")("DASHBOARD.NEW_POINTS")+": "+t.data.content.summary.totals.points}),e.tabCallback(e.dashTab)})["catch"](function(e){})},e.tabCallback=function(t){e.dashTab=t;var a=e.dash.stats[t].calories.value/e.dash.stats[t].goal*100;e.dash.stats[t].val=0,n(function(){e.dash.stats[t].val=isNaN(a)?0:u(a.toFixed(),0,100)},10)},window.mixpanel&&(window.mixpanel.identify(e.me.user_id,function(){},function(){}),window.mixpanel.people.set({$last_login:new Date,$email:e.me.email,$first_name:e.me.first_name,$last_name:e.me.last_name,gender:e.me.gender,birth_date:e.me.birth_date,langId:e.lang,points:e.dash.user[0].total_points}),window.mixpanel.track("Dashboard",{userId:e.me.user_id,email:e.me.email}))}]).controller("howDashboardCtrl",["$scope","$filter",function(e,t){e.how=t("translate")("DASHBOARD.HOW_IT_WORKS_TEXT")}]).controller("rewardsCtrl",["$scope","$rootScope","$filter","$state","$ionicPopup","$ionicModal","storeLocalData",function(e,t,n,a,o,i,r){if(!t.localData.rewardInstructions){var l=o.alert({title:n("translate")("REWARDS.REWARDS_INSTRUCTIONS_TITLE"),content:n("translate")("REWARDS.REWARDS_INSTRUCTIONS_TEXT"),okType:"button-positive big-button",okText:n("translate")("ACTION.GOT_IT")});l.then(function(e){t.localData.rewardInstructions=!0,r.set("rewardInstructions",JSON.stringify(t.localData.rewardInstructions))})}e.$on("$ionicView.afterEnter",function(t,n){window.mixpanel&&window.mixpanel.track("Rewards",{userId:e.me.user_id,email:e.me.email})}),e.goToReward=function(e,t){return"purchases"==t?a.go("app.purchase",{id:e}):a.go("app.reward",{id:e})}}]).controller("rewardsAllCtrl",["$scope","$state","$ionicModal","dataService","$ionicScrollDelegate","dataService",function(e,t,n,a,o,a){a.get("rewards?filter=none&limit=10",{cache:!1}).then(function(t){e.rewards=t.data.content}),e.$on("$ionicView.afterEnter",function(t,n){a.get("entities/?filter=mine",{cache:!1}).then(function(t){e.userEntities=t.data.content}),window.mixpanel&&window.mixpanel.track("Rewards",{userId:e.me.user_id,email:e.me.email})}),e.pullRefresh=function(){e.doRefresh("rewards?filter=none&limit=10").then(function(t){e.rewards=t.data.content,e.filter={type:"0",group:"0",order:"0"}})},e.filter={type:"0",group:"0",order:"0"},e.showFilter=!0,e.params={filter:"none"},e.url="rewards",e.applyFilters=function(){e.rewards=[],e.params=angular.extend(e.params,e.filter),e.closeFilter(),window.mixpanel&&window.mixpanel.track("Rewards filter applied",{userId:e.me.user_id,email:e.me.email,group:e.filter.group,order:e.filter.order,type:e.filter.type})},n.fromTemplateUrl("templates/rewards/filter-modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.openFilter=function(){e.modal.show(),window.mixpanel&&window.mixpanel.track("Rewards filter",{userId:e.me.user_id,email:e.me.email})},e.closeFilter=function(){e.modal.hide()},e.goToGroups=function(){e.closeFilter(),t.go("app.entities")},e.$on("$destroy",function(){e.modal&&e.modal.remove()})}]).controller("rewardsMineCtrl",["$scope","dataService",function(e,t){t.get("purchases?filter=none&limit=10",{cache:!1}).then(function(t){e.rewards=t.data.content,window.mixpanel&&window.mixpanel.track("Purchases",{userId:e.me.user_id,email:e.me.email})}),e.pullRefresh=function(){e.doRefresh("purchases?filter=none&limit=10").then(function(t){e.rewards=t.data.content})},e.url="purchases",e.params={filter:"none"}}]).controller("singleRewardCtrl",["$scope","dataService","$stateParams","$filter","$ionicPopup","dataService","$ionicScrollDelegate","$location","$timeout","$translate",function(e,t,n,a,o,t,i,r,l,s){t.get("rewards/"+n.id,{cache:!1}).then(function(t){e.reward=t.data.content,"11"!=e.reward.group_id&&("3"===e.reward.group_type?s("REWARDS.REWARD_EXCLUSIVE_EMP",{merchant:e.reward.merchant}).then(function(t){e.rewardExTxt=t}):s("REWARDS.REWARD_EXCLUSIVE_MEMBER",{merchant:e.reward.merchant}).then(function(t){e.rewardExTxt=t})),e.share={text:e.reward.share,subject:e.reward.title,img:e.reward.image_url,link:e.reward.reward_url,element:"reward",id:e.reward.id},window.mixpanel&&window.mixpanel.track("Reward",{userId:e.me.user_id,email:e.me.email,rewardId:e.reward.id,value:e.reward.goal})}),e.pullRefresh=function(){e.doRefresh("rewards/"+e.reward.id).then(function(t){e.reward=t.data.content})},e.purchaseRewardToggle=function(n){if(e.loading=!0,"0"==e.reward.group_joined)e.rewardNotInGroup="",s("REWARDS.NOT_IN_GROUP",{group:e.reward.merchant}).then(function(t){e.rewardNotInGroup=t,o.confirm({title:a("translate")("ACTION.UPS"),template:e.rewardNotInGroup,cancelType:"big-button button-stable",cancelText:a("translate")("ACTION.CANCEL"),okType:"big-button button-positive",okText:a("translate")("ACTION.JOIN")}).then(function(t){t&&r.path("/entity/"+e.reward.group_id+"#desc")})});else{var i="1"===n.purchased?0:1;t.put("purchases/"+n.id,{}).then(function(t){e.reward.purchased=i.toString(),e.pointDeduct(n.goal),e.totalPoints(t.data.content.user_total_points),window.mixpanel&&window.mixpanel.track("Purchase done",{userId:e.me.user_id,rewardId:n.id,value:n.goal},function(){},function(){}),window.fbq&&fbq("track","Purchase",{content_name:"app",value:.5,currency:"USD",num_items:1});var s=o.alert({title:a("translate")("ACTION.SUCCESS"),content:a("translate")("REWARDS.PURCHASE_MSG")+"<br><br><strong>"+n.title+"</strong>",okType:"button-positive big-button",okText:a("translate")("ACTION.SEE_IT")});s.then(function(n){l(function(){r.path("/purchase/"+t.data.content.id),e.$apply()})})})["catch"](function(e){o.alert({title:a("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data.summary.message})})["finally"](function(){e.loading=!1})}}}]).controller("singlePurchaseCtrl",["$scope","dataService","$stateParams",function(e,t,n){e.$on("$ionicView.beforeEnter",function(e,t){t.enableBack=!0}),t.get("purchases/"+n.id,{cache:!1}).then(function(t){e.reward=t.data.content,e.share={text:e.reward.share,subject:e.reward.title,img:e.reward.image_url,link:e.reward.reward_url,element:"purchase",id:e.reward.id},window.mixpanel&&window.mixpanel.track("Purchase",{userId:e.me.user_id,email:e.me.email,rewardId:e.reward.id})}),e.pullRefresh=function(){e.doRefresh("purchases/"+e.reward.id).then(function(t){e.reward=t.data.content})},e.openVoucher=function(e){window.open(e,"_system")}}]).controller("shareCtrl",["$scope","$rootScope","$stateParams","$timeout","$ionicLoading","$ionicHistory","$cordovaSocialSharing","$ionicPopup","$filter","$window","dataService","storeLocalData",function(e,t,n,a,o,i,r,l,s,c,d,u){function p(e){g(e,"twitter")}function m(e){g(e,"facebook")}function f(e){g(e,"whatsapp")}function h(e){g(e,"other")}function g(t,n){o.hide(),element=e.share.element,id=e.share.id,""!=element&&""!=id&&void 0!==n&&d.post("bonus/social",{via:n,element:element,id:id}).then(function(t){e.pointAdd(t.data.content.points),i.goBack(1)})["catch"](function(e){})["finally"](function(){}),window.mixpanel&&window.mixpanel.track("Share done",{userId:e.me.user_id,email:e.me.email,element:element,via:void 0!==n?n:"other"})}function w(e){o.hide(),a(function(){l.alert({title:s("translate")("SHARE.ERROR"),okType:"button-positive big-button",okText:s("translate")("ACTION.OK"),content:s("translate")("SHARE.ERROR")})})}e.share=n,e.shareVia=t.localData.shareVia,o.show({template:s("translate")("ACTION.LOADING"),duration:3e3});var _=null;if("ios"==ionic.Platform.platform()||"android"==ionic.Platform.platform()){var I={canonicalIdentifier:e.share.element||"",title:e.share.subject,contentDescription:e.share.text,contentImageUrl:e.share.img,contentMetadata:{element:e.share.element||"",id:e.share.id||""}};Branch.createBranchUniversalObject(I).then(function(t){_=t,_.generateShortUrl({feature:"sharing"},{$desktop_url:e.share.link||"http://www.wefitter.com"}).then(function(t){e.share.text=e.share.text,e.share.link=t.url,o.hide()})})}e.share.link||(e.share.link="https://www.wefitter.com"),e.shareOther=function(){o.show({template:s("translate")("ACTION.SHARING"),duration:1e3}),r.share(e.share.text,e.share.subject,e.share.img,e.share.link).then(h,w)},e.shareTwitter=function(){o.show({template:s("translate")("ACTION.SHARING"),duration:1e3});var t=e.share.text.substring(0,90);r.shareViaTwitter(t,e.share.img,e.share.link).then(p,w)},e.shareFb=function(){o.show({template:s("translate")("ACTION.SHARING"),duration:1e3}),r.shareViaFacebookWithPasteMessageHint(e.share.text,null,e.share.link).then(m,w)},e.shareWhatsApp=function(){o.show({template:s("translate")("ACTION.SHARING"),duration:1e3}),r.shareViaWhatsApp(e.share.text,null,e.share.link).then(f,w)}}]).controller("challengesCtrl",["$scope","$state",function(e,t){e.$on("$ionicView.afterEnter",function(t,n){window.mixpanel&&window.mixpanel.track("Challenges",{userId:e.me.user_id,email:e.me.email})})}]).controller("challengesAllCtrl",["$scope","dataService",function(e,t){t.get("challenges?filter=all&limit=10",{cache:!1}).then(function(t){e.challenges=t.data.content}),e.pullRefresh=function(){e.doRefresh("challenges?filter=all&limit=10").then(function(t){e.challenges=t.data.content})},e.url="challenges",e.params={filter:"all"}}]).controller("challengesMineCtrl",["$scope","dataService",function(e,t){t.get("challenges?filter=mine&limit=10",{cache:!1}).then(function(t){e.challenges=t.data.content}),e.pullRefresh=function(){e.doRefresh("challenges?filter=mine&limit=10").then(function(t){e.challenges=t.data.content})},e.url="challenges",e.params={filter:"mine"}}]).controller("singleChallengeCtrl",["$scope","$rootScope","$stateParams","popup","$filter","dataService","$ionicPopup","$ionicScrollDelegate","$location","$translate","dataService","$window",function(e,t,n,a,o,i,r,l,s,c,i,d){e.wHeight=d.innerHeight-95,e.refresh=!1,i.get("challenges/"+n.id+"?limit=5",{cache:!1}).then(function(i){if(e.challenge=i.data.content,e.resMeta=i.data.params,"11"!=e.challenge.group_id&&("3"===e.challenge.group_type?c("CHALLENGE.CHALLENGE_EXCLUSIVE_EMP",{merchant:e.challenge.merchant}).then(function(t){e.challengeExTxt=t}):c("CHALLENGE.CHALLENGE_EXCLUSIVE_MEMBER",{merchant:e.challenge.merchant}).then(function(t){e.challengeExTxt=t})),e.setUnits(),e.share={text:e.challenge.share,subject:e.challenge.title,img:e.challenge.cover_url,link:e.challenge.challenge_url,element:"challenge",id:n.id},"intro.challenge"==t.currentState&&t.localData.referData.challenge_id){var r=o("translate")("INTRO.CHALLENGE_POPUP_TITLE"),l=o("translate")("INTRO.CHALLENGE_POPUP_TEXT");a.imagePopup("wf-challenges",r,l)}window.mixpanel&&window.mixpanel.track("Challenge",{userId:e.me.user_id,email:e.me.email,challengeId:n.id})}),e.setUnits=function(){"kcal"==e.challenge.goal_unit?e.unit=o("translate")("UNIT.KCAL"):"distance"==e.challenge.goal_unit?e.unit=o("translate")("UNIT.KM"):"points"==e.challenge.goal_unit?e.unit=o("translate")("UNIT.POINTS"):"duration"==e.challenge.goal_unit&&(e.unit=o("translate")("UNIT.HOURS"))},e.url="challenges/"+n.id,e.pullRefresh=function(){e.doRefresh(e.url).then(function(t){e.challenge=t.data.content,e.resMeta=t.data.params})},e.refreshLeaderboard=function(){e.refresh=!e.refresh,e.$broadcast("scroll.refreshComplete")},e.tabCallback=function(t){e.activeTab=t},e.joinChallengeToggle=function(t){if(e.loading=!0,"0"==e.challenge.group_joined)e.challengeNotInGroup="",c("CHALLENGE.NOT_IN_GROUP",{group:e.challenge.merchant}).then(function(t){e.challengeNotInGroup=t,r.confirm({title:o("translate")("ACTION.UPS"),template:e.challengeNotInGroup,cancelType:"big-button button-stable",cancelText:o("translate")("ACTION.CANCEL"),okType:"big-button button-positive",okText:o("translate")("ACTION.JOIN")}).then(function(t){t&&s.path("/entity/"+e.challenge.group_id+"/"+e.challenge.name+"#desc")})});else{var a="1"===t.joined?0:1;i.post("challenges/"+n.id,{join:a}).then(function(t){e.challenge.joined=a.toString(),r.alert({title:o("translate")("CHALLENGE.CHALLENGE_ACCEPTED"),content:o("translate")("CHALLENGE.CHALLENGE_ACCEPTED_MSG")}),e.challenge=t.data.content,e.$storage&&e.$storage.boot&&(e.challengeInDash=o("filter")(e.$storage.boot.dashboard.challenges,{id:n.id},!0),e.challengeInDash&&e.challengeInDash.length>0&&(e.challengeInDash[0].joined="1")),window.mixpanel&&window.mixpanel.track("Challenge joined",{userId:e.me.user_id,email:e.me.email,challengeId:e.challenge.id}),window.fbq&&fbq("trackCustom","ChallengeJoined",{content_name:"app",value:.5,currency:"USD"})})["catch"](function(e){r.alert({title:o("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data.summary.message})})["finally"](function(){e.loading=!1,l.scrollTop(!0)})}}}]).controller("howChallengeCtrl",["$scope","$filter",function(e,t){e.how=t("translate")("CHALLENGE.HOW_IT_WORKS_TEXT")}]).controller("activitiesCtrl",["$scope","$rootScope","$ionicScrollDelegate","dataService","moment","$filter",function(e,t,n,a,o,i){a.get("workouts?limit=10&offset=0&period=week",{cache:!1}).then(function(t){e.activity=t.data.content}),e.$on("$ionicView.afterEnter",function(t,n){window.mixpanel&&window.mixpanel.track("Activities",{userId:e.me.user_id,email:e.me.email},function(){},function(){})}),e.loading=!1,e.isDataAvailable=!0,e.offset=20,e.perPage=20;var r=0,l=!0;e.period="week",e.pullRefresh=function(t){e.doRefresh(t,{params:{period:e.period}}).then(function(t){e.$storage.boot.activities=t.data.content,e.activity=t.data.content})},e.getTabData=function(t){e.offset=20,e.perPage=20,e.period=t,e.url="workouts",e.params={period:t},l=!1,a.get("workouts",{params:{period:t},cache:!1}).then(function(t){n.scrollTop(),e.activity=t.data.content})["catch"](function(e){var t=$ionicPopup.alert({title:i("translate")("ACTION.ERROR"),okType:"button-positive big-button",okText:i("translate")("INTRO.LETS_DO_IT"),content:i("translate")("ACTION.UNKNOWN_ERROR_MSG")
});t.then(function(e){$window.location.reload(!0)})})["finally"](function(){l=!0})},e.loadMore=function(){l&&e.isDataAvailable?a.get(e.url,{params:angular.extend(e.params,{limit:e.perPage,offset:e.offset})}).then(function(t){e.errorMsg=null;var n=t.data;if(n&&n.content.activity_history.length>0){for(var a=n.content.activity_history.length,o=0;a>o;o++)e.activity.activity_history.push(n.content.activity_history[o]);e.offset=e.perPage+e.offset,n.content.activity_history.length<e.perPage&&(e.isDataAvailable=!1)}else e.isDataAvailable=!1})["catch"](function(t){e.$broadcast("scroll.infiniteScrollComplete"),r>=3&&(e.isDataAvailable=!1,e.errorMsg=i("translate")("ACTION.NO_DATA_FROM_API")),r++})["finally"](function(){l=!0,e.$broadcast("scroll.infiniteScrollComplete")}):e.$broadcast("scroll.infiniteScrollComplete")}}]).controller("singleActivityCtrl",["$scope","dataService","$stateParams",function(e,t,n){t.get("workouts/"+n.id,{cache:!1}).then(function(t){e.activity=t.data.content,e.share={text:e.activity.share,subject:e.activity.title,img:null,link:"https://www.wefitter.com",element:"workout",id:e.activity.id}}),e.pullRefresh=function(){e.doRefresh("workouts/"+e.activity.id).then(function(t){e.activity=t.data.content})}}]).controller("connectionCtrl",["$scope","dataService","$ionicPopup","$state","$filter","storeLocalData","$rootScope","URIScheme","$cordovaAppAvailability","$ionicPopup","$translate","$cordovaHealthKit","$interval",function(e,t,n,a,o,i,r,l,s,n,c,d,u){function p(){if(r.localData&&!r.localData.isTrackerPopupShow)if("android"==r.currentPlatform){var e=l.android;f(e,0)}else if("ios"==r.currentPlatform){var e=l.ios;r.localData.isDetect||r.localData.deviceConnected||m(e)}}function m(e){r.localData.isDetect=!0,window.plugins.healthkit.available(function(e){h(-1,{})},function(t){f(e,0)})}function f(e,t){if(t<e.length){var n=e[t].scheme;s.check(n).then(function(){h(t,e)},function(){f(e,++t)})}}function h(t,l){if(-1==t)var s=_.findLastIndex(e.connections,{name:"Apple Health"});else var s=_.findLastIndex(e.connections,{name:l[t].name});if(s){c("CONNECT.TRACKER_FOUND_TEXT",{conn_name:e.connections[s].name}).then(function(t){e.tracker_text=t});var d=n.confirm({template:'<div class="text-center"><span ng-bind-html="tracker_text"></span></div><div class="trackerPopup"><ion-checkbox ng-model="localData.isTrackerPopupShow">{{ "ACTION.DONT_SHOW" | translate}}</ion-checkbox></div>',scope:e,title:o("translate")("CONNECT.TRACKER_FOUND_TITLE"),buttons:[{text:o("translate")("ACTION.LATER"),type:"big-button button-stable",onTap:function(e){d.close()}},{text:o("translate")("ACTION.ADD_NOW"),type:"big-button button-positive",onTap:function(e){return s}}]});d.then(function(t){r.localData&&r.localData.isTrackerPopupShow&&i.set("isTrackerPopupShow",JSON.stringify(r.localData.isTrackerPopupShow)),t&&(d.close(),"app.connect"==r.currentState?a.go("app.connectIt",{id:e.connections[t].source_id}):a.go("intro.connectIt",{id:e.connections[t].source_id}))})}}e.init=function(){t.get("connections").then(function(t){e.connections=t.data.content,p(),r.localData.deviceConnected=e.totalConnections(e.connections)>0,i.set("deviceConnected",JSON.stringify(r.localData.deviceConnected))})},e.introCheckConnected=function(){r.localData.isSignup===!0&&r.localData.deviceConnected===!1?n.confirm({title:o("translate")("INTRO.CONNECT"),template:"{{ 'INTRO.CONNECT_MSG' | translate }}",cancelText:o("translate")("ACTION.CANCEL"),okText:o("translate")("NAV.LATER")}).then(function(t){t&&(window.mixpanel&&window.mixpanel.track("Tour: Skip connection step",{userId:e.me.user_id,email:e.me.email}),a.go("intro.done"))}):a.go("intro.done")},e.pullRefresh=function(t){e.doRefresh(t).then(function(t){e.connections=t.data.content,r.localData.deviceConnected=e.totalConnections(e.connections)>0,i.set("deviceConnected",JSON.stringify(r.localData.deviceConnected))})},e.init(),r.localData.intro?window.mixpanel&&window.mixpanel.track("Connections",{userId:e.me.user_id,email:e.me.email}):window.mixpanel&&window.mixpanel.track("Tour: Connections",{userId:e.me.user_id,email:e.me.email})}]).controller("singleConnectionCtrl",["$scope","$rootScope","auth","dataService","$ionicModal","$ionicLoading","$ionicPopup","$stateParams","$filter","wfConfig","$ionicNavBarDelegate","storeLocalData","$state","$q","$ionicScrollDelegate",function(e,t,n,a,o,i,r,l,s,c,d,u,p,m,f){function h(){e.openModal()}function g(){e.openModal()}function w(n){r.alert({title:s("translate")("ACTION.SUCCESS"),okType:"button-positive big-button",content:s("translate")("CONNECT.CONNECTIONS_SUCCESS_MSG")+e.connection.name+" !"}),e.connection.disabled=e.initialState="0",e.setBtnTxt(),a.flushCacheByEndpoint("/workouts?"),e.connection.id=n.data.content,window.mixpanel&&window.mixpanel.track("Connection done",{userId:e.me.user_id,email:e.me.email,connectionName:e.connection.name,connectionType:e.connection.connection_type}),window.fbq&&fbq("trackCustom","Connection",{content_name:"app",value:.5,currency:"USD"}),t.localData.deviceConnected=!0,u.set("deviceConnected",JSON.stringify(t.localData.deviceConnected))}function _(t){r.alert({title:s("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:t.data&&t.data.summary&&t.data.summary.message?t.data.summary.message:s("translate")("CONNECT.CONNECTIONS_ERROR_MSG")}),window.mixpanel&&window.mixpanel.track("Connection failed",{userId:e.me.user_id,email:e.me.email,connectionName:e.connection.name,connectionType:e.connection.connection_type})}function I(t){"oauth2"==e.connection.connection_type||"oauth1"==e.connection.connection_type?n.authenticate(t,{userId:e.me.user_id||0}).then(w)["catch"](_):"private"==e.connection.connection_type?h():"gym"==e.connection.connection_type&&g()}function O(){a.post("connections/activate/22").then(function(n){e.healthConnectionId=n.data.content,t.localData.healthConnectionId=n.data.content,u.set("healthConnectionId",JSON.stringify(t.localData.healthConnectionId)),e.connection.disabled=0,e.setBtnTxt(),t.accessHealthData=!0,w(n),e.getHealthData(),t.healthkit_interval=setInterval(function(){e.getHealthData()},36e5)},_)["finally"](function(t){e.loading=!1})}function R(){window.plugins.healthkit.available(function(e){window.plugins.healthkit.requestAuthorization({readTypes:["HKWorkoutTypeIdentifier","HKQuantityTypeIdentifierStepCount","HKQuantityTypeIdentifierDistanceWalkingRunning","HKQuantityTypeIdentifierDistanceCycling","HKQuantityTypeIdentifierActiveEnergyBurned","HKQuantityTypeIdentifierAppleExerciseTime"],writeTypes:[]},function(e){O()},function(e){})},function(e){r.alert({title:s("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:s("translate")("CONNECT.APPLE_HEALTH_UNAVAILABLE")})})}a.get("connections/"+l.id,{cache:!1}).then(function(t){e.connection=t.data.content,e.screens=e.connection.connection_screenshot_url,e.initialState=e.connection.disabled,e.setBtnTxt(),window.mixpanel&&window.mixpanel.track("Connection",{userId:e.me.user_id,email:e.me.email,connectionName:e.connection.name,connectionType:e.connection.connection_type})}),e.setBtnTxt=function(){0==e.connection.disabled?(e.connectBtnTxt=s("translate")("ACTION.DISCONNECT"),e.connectStatus=s("translate")("CONNECT.CONNECTOK")):(e.connectBtnTxt=s("translate")("ACTION.CONNECT"),e.connectStatus=s("translate")("CONNECT.NOTCONNECTED")),2==e.connection.status&&(e.connectStatus=e.connection.status_message)},e.pullRefresh=function(){e.doRefresh("connections/"+l.id).then(function(t){e.connection=t.data.content,e.setBtnTxt(),e.initialState=e.connection.disabled})},e.actionUrl=c.CALLBACK_URL+l.id,e.params={},e.loading=!1,e.connectLogin=function(t){t.preventDefault(),e.loading=!0,a.postAbsolute(e.actionUrl,e.params).then(function(t){e.closeModal(),w(t)})["catch"](_)["finally"](function(t){e.loading=!1})},e.goHelp=function(){"3rd_party_app"==e.connection.connection_type||p.go("app.connectionFAQ")},e.updateActivities=function(){var t={cache:!1,params:{update_activities:!0}},n="dashboard";e.doRefresh(n,t).then(function(t){e.$storage.boot.dashboard=t.data.content,e.totalPoints(e.$storage.boot.dashboard.user[0].total_points),a.flushRelatedCache(t),t.data.content.summary.totals&&t.data.content.summary.totals.workouts>0&&r.alert({title:"Success",content:s("translate")("DASHBOARD.NEW_ACTIVITIES")+": "+t.data.content.summary.totals.workouts+"<br>"+s("translate")("DASHBOARD.NEW_POINTS")+": "+t.data.content.summary.totals.points})})["catch"](function(e){})},e.connectBtnHandle=function(){"0"==e.connection.disabled?e.remove(e.connection.id):"22"==l.id?R():e.handleConnect()},e.handleConnect=function(){if(window.mixpanel&&window.mixpanel.track("New connection",{userId:e.me.user_id,email:e.me.email,connectionName:e.connection.name,connectionType:e.connection.connection_type}),"-1"===e.initialState)I(e.connection.name);else if("3rd_party"===e.connection.connection_type){var t=r.confirm({title:s("translate")("CONNECT.DISCONNECT"),template:e.connection.description});t.then(function(e){})}},e.remove=function(n){var o=r.confirm({title:s("translate")("CONNECT.REMOVE_CONNECTION"),template:s("translate")("CONNECT.REMOVE_CONFIRM_MSG")+e.connection.name+"?",cancelText:s("translate")("ACTION.CANCEL"),okText:s("translate")("CONNECT.DISCONNECT")});o.then(function(n){n&&(e.loading=!0,a.post("connections/delete/"+l.id).then(function(n){e.connection=n.data.content,e.initialState=e.connection.disabled,e.setBtnTxt(),"22"==l.id&&t.healthkit_interval&&(t.accessHealthData=!1,clearInterval(t.healthkit_interval))})["catch"](_)["finally"](function(t){e.loading=!1}))})},o.fromTemplateUrl("templates/connect/login/modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.openModal=function(){e.modal.show()},e.closeModal=function(){e.modal.hide()},e.$on("$destroy",function(){e.modal&&e.modal.remove()})}]).controller("profileCtrl",["$scope","$rootScope","dataService","$ionicModal","$state","Upload","$ionicPopup","auth","$ionicLoading","$cordovaDatePicker","$timeout","$filter","$ionicScrollDelegate","wfConfig","storeLocalData","cropDimension",function(e,t,n,a,o,i,r,l,s,c,d,u,p,m,f,h){function g(e,t){var n,a="NA";if(e>0&&t>0)return n=e/(t/100*t/100),16>n?a=u("translate")("PROFILE.BMI_MSG.SEVERE_THINNESS"):n>=16&&17>n?a=u("translate")("PROFILE.BMI_MSG.MODERATE_THINNESS"):n>=17&&18.5>n?a=u("translate")("PROFILE.BMI_MSG.MILD_THINNESS"):n>=18.5&&25>n?a=u("translate")("PROFILE.BMI_MSG.NORMAL"):n>=25&&30>n?a=u("translate")("PROFILE.BMI_MSG.OVERWEIGHT"):n>=30&&35>n?a=u("translate")("PROFILE.BMI_MSG.OBESE_I"):n>=35&&40>n?a=u("translate")("PROFILE.BMI_MSG.OBESE_II"):n>40&&(a=u("translate")("PROFILE.BMI_MSG.OBESE_III")),{bmi:n.toFixed(2),msg:a};throw new Error("weight in KG and height in Centimeter to calculate BMI")}function w(){var t=!!(e.me.first_name&&e.me.region&&e.me.gender&&e.me.birth_date&&e.me.weight.value&&e.me.height.value);return t&&(e.bmi=g(e.me.weight.value,e.me.height.value)),t}e.pullRefresh=function(t){e.doRefresh(t,{params:{period:e.period}}).then(function(t){e.me=t.data.content[0]})},n.get("profile",{cache:!1}).then(function(t){e.me=t.data.content[0]}),e.formattedBirthDate=e.me.birth_date?moment(e.me.birth_date).format("DD/MM/YYYY").toString():null,e.$on("$ionicView.beforeEnter",function(a,i){t.localData.regions||n.get("boot").then(function(n){e.boot=n.data.content,t.localData.regions=e.boot.regions,f.set("regions",JSON.stringify(t.localData.regions)),o.go(o.current,{},{reload:!0})},function(e){s.hide()})}),e.regions=t.localData.regions,e.completed=w(),e.completed&&(e.profileWasCompleted=!0,e.bmi=g(e.me.weight.value,e.me.height.value),e.showBMI=!0),t.localData.intro?window.mixpanel&&window.mixpanel.track("Edit profile",{userId:e.me.user_id,email:e.me.email}):window.mixpanel&&window.mixpanel.track("Tour: Profile",{userId:e.me.user_id,email:e.me.email}),e.changeProfilePic=function(){e.loading=!0,i.fileTo("profile/photo",h.profile).then(function(t){t&&t.data.content&&t.data.content.image_url?e.$storage.boot?e.$storage.boot.dashboard.user[0].image_url=e.me.image_url=t.data.content.image_url:e.me.image_url=t.data.content.image_url:d(function(){r.alert({title:u("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:"<span translate='PROFILE.ERROR_PIC_UPLOAD'></span>"})}),e.loading=!1},function(t){if("string"==typeof t){if("no image selected"===t||"Selection cancelled."===t)return void(e.loading=!1);d(function(){r.alert({title:u("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:t})})}else{if(t.cancel)return void(e.loading=!1);d(function(){r.alert({title:u("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:"<span translate='PROFILE.ERROR_PIC_UPLOAD'></span>"})})}e.loading=!1})},e.dataChanged=0,e.$watch("me",function(t,n){t!==n&&(e.dataChanged++,e.completed=w())},!0),e.saveChanges=function(a){a||s.show({template:u("translate")("ACTION.SAVING")}),n.post("profile",{first_name:e.me.first_name,last_name:e.me.last_name,description:e.me.description,gender:e.me.gender?e.me.gender.toLowerCase():null,city:e.me.city,region:e.me.region,birth_date:e.me.birth_date,weight:e.me.weight.value,height:e.me.height.value}).then(function(n){e.$storage.boot&&(e.$storage.boot.dashboard.user[0]=e.me,t.profileImage=e.me.image_url),a||d(function(){var t=r.alert({title:u("translate")("ACTION.SUCCESS"),okType:"button-positive big-button",content:"<span translate='PROFILE.CHANGES_SAVED'></span>"});t.then(function(t){p.scrollBottom(),e.showBMI=!0})}),e.dataChanged=0,e.completed=w(),e.completed&&!e.hasOwnProperty("profileWasCompleted")&&(e.profileWasCompleted=!0,window.mixpanel&&window.mixpanel.people.setOnce({"profile completed":"1"}))})["catch"](function(t){a||(d(function(){r.alert({title:u("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:"<span translate='PROFILE.CHANGES_NOT_SAVED'></span>"})}),e.showError=!0)})["finally"](function(){s.hide()})},a.fromTemplateUrl("templates/auth/pop_sex.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.sexModal=t}),e.openSexModal=function(){e.sexModal.show()},e.closeSexModal=function(){e.sexModal.hide()},e.showDatePicker=function(){if(e.date=new Date,e.me.birth_date&&(e.date=moment(e.me.birth_date).toDate()),!ionic.Platform.isWebView())return alert("Native DatePicker don't work in browser, try on device/emulator"),!1;var t={date:e.date,mode:"date",minDate:moment().subtract(100,"years").toDate(),allowOldDates:!0,allowFutureDates:!1};c.show(t).then(function(t){e.me.birth_date=moment(t).format("YYYY-MM-DD").toString(),e.formattedBirthDate=moment(t).format("DD/MM/YYYY").toString()})},a.fromTemplateUrl("templates/auth/pop_age.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.ageModal=t}),e.openAgeModal=function(){e.ageModal.show()},e.closeAgeModal=function(){e.ageModal.hide()},a.fromTemplateUrl("templates/auth/pop_weight.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.weightModal=t}),e.openWeightModal=function(){e.weightModal.show()},e.closeWeightModal=function(){e.weightModal.hide()},e.$on("$destroy",function(){e.ageModal.remove(),e.sexModal.remove(),e.weightModal.remove()})}]).controller("settingsCtrl",["$scope","$state","$ionicHistory","auth","$window","dataService","$filter","$ionicLoading","$ionicPopup","$ionicPlatform",function(e,t,n,a,o,i,r,l,s,c){e.$on("$ionicView.afterEnter",function(t,n){i.get("settings",{cache:!1}).then(function(t){e.setting=t.data.content,e.setting.lang=e.lang}),window.mixpanel&&window.mixpanel.track("Settings",{userId:e.me.user_id,email:e.me.email})}),e.showError={show:!1},e.save=function(){return/(.+)@(.+){2,}\.(.+){2,}/.test(e.setting.email)?(e.showError.show=!1,l.show({template:'<div translate="ACTION.SAVING"></div>'}),window.plugins&&window.plugins.OneSignal&&window.plugins.OneSignal.setSubscription(e.setting.push_notifications),void i.post("settings",e.setting).then(function(e){s.alert({okType:"button-positive big-button",title:r("translate")("ACTION.SUCCESS"),content:"<span translate='PROFILE.CHANGES_SAVED'></span>"})})["catch"](function(t){e.showError=!0})["finally"](function(){l.hide()})):(e.showError.show=!0,!1)},e.addBonusCode=function(){e.bonusResponse="",e.data={};var t=s.confirm({template:'<div class="text-center"><span translate="SETTINGS.BONUS_EXPLANATION"></span><label class="med-padding item item-input on-light"><input type="text" name="bonus" ng-model="data.bonus" placeholder="{{ \'SETTINGS.BONUS_PLACEHOLDER\' | translate}}"></label><span ng-if="bonusResponse != \'\'">{{ bonusResponse }}</span></div>',scope:e,title:r("translate")("SETTINGS.BONUS"),buttons:[{text:r("translate")("ACTION.CLOSE"),type:"big-button button-stable",onTap:function(e){t.close()}},{text:r("translate")("ACTION.USE"),type:"big-button button-positive",onTap:function(t){return e.data.bonus?e.data.bonus:(e.bonusResponse=r("translate")("SETTINGS.BONUS_EMPTY"),void t.preventDefault())}}]});t.then(function(t){t&&(l.show({template:'<div translate="ACTION.WAITING"></div>'}),i.post("bonus/code",{code:e.data.bonus}).then(function(t){s.alert({okType:"button-positive big-button",title:r("translate")("SETTINGS.BONUS_OK"),subTitle:'<i class="wf wf-coins"></i> +'+t.data.content}),e.pointAdd(t.data.content)})["catch"](function(e){s.alert({okType:"button-positive big-button",title:r("translate")("ACTION.ERROR"),content:"Error: "+e.data.summary.message})})["finally"](function(){l.hide()}))})},e.rateUs=function(){window.mixpanel&&window.mixpanel.track("Rate app",{userId:e.me.user_id,email:e.me.email,os:ionic.Platform.platform()}),c.is("ios")?window.open("itms-apps://itunes.apple.com/es/app/id1090432973","_system"):c.is("android")&&window.open("market://details?id=com.wefitter.app","_system")},e.removeAccount=function(){s.confirm({title:r("translate")("SETTINGS.REMOVE_ACCOUNT"),template:"{{ 'ACTION.DISABLE_MSG' | translate }}"}).then(function(t){t&&(l.show({template:'<div translate="ACTION.WAITING"></div>'}),i.post("user/disable",{}).then(function(t){e.logoutAndClearData()})["catch"](function(){s.alert({okType:"button-positive big-button",title:r("translate")("ACTION.ERROR"),content:"<span translate='SETTINGS.ERROR_REMOVE_ACCOUNT'></span>"})})["finally"](function(){l.hide()}))})},e.updateNotificationSubscription=function(){window.plugins&&window.plugins.OneSignal&&window.plugins.OneSignal.setSubscription(e.setting.push_notifications)}}]).controller("helpCtrl",["$scope",function(e){e.supportMail=function(){window.open("mailto:help@wefitter.com","_system")},e.$on("$ionicView.afterEnter",function(t,n){window.mixpanel&&window.mixpanel.track("Help",{userId:e.me.user_id,email:e.me.email})})}]).controller("achievementsCtrl",["$scope","$ionicPopup","$filter","$timeout",function(e,t,n,a){e.url="achievements"}]).controller("achievementsChallengeCtrl",["$scope",function(e){e.achievements=[],e.params={type:"challenge"},e.pullRefresh=function(){e.doRefresh("achievements?type=challenge").then(function(t){e.achievements=t.data.content})},e.pullRefresh(),window.mixpanel&&window.mixpanel.track("Achievements",{userId:e.me.user_id,email:e.me.email,type:"challenges"})}]).controller("achievementsProgressCtrl",["$scope",function(e){e.achievements=[],e.params={type:"progress"},e.pullRefresh=function(){e.doRefresh("achievements?type=progress").then(function(t){e.achievements=t.data.content})},e.pullRefresh(),window.mixpanel&&window.mixpanel.track("Achievements",{userId:e.me.user_id,email:e.me.email,type:"progress"})}]).controller("achievementsEventCtrl",["$scope",function(e){e.achievements=[],e.params={type:"event"},e.pullRefresh=function(){e.doRefresh("achievements?type=event").then(function(t){e.achievements=t.data.content})},e.pullRefresh(),window.mixpanel&&window.mixpanel.track("Achievements",{userId:e.me.user_id,email:e.me.email,type:"event"})}]).controller("entityCtrl",["$scope","$rootScope","dataService","$filter","$state","$translate","$timeout","$ionicViewSwitcher",function(e,t,n,a,o,i,r,l){e.search={name:""},e.searchPlaceholder=a("translate")("ACTION.SEARCH"),e.addEntityText="",e.title=a("translate")("GROUPS.TITLE_SINGLE");var s;i("GROUPS.TITLE_SINGLE").then(function(t){e.title=t,i("GROUPS.SEARCH_PLACEHOLDER",{type:e.title}).then(function(t){e.searchPlaceholder=t})}),e.updateInterface=function(){s&&r.cancel(s),s=r(function(){t.$broadcast("updateResult")},500)},window.mixpanel&&window.mixpanel.track("Groups",{userId:e.me.user_id,email:e.me.email}),e.giveEntityFeedback=function(){"fitness"==$stateParams.type?window.open("http://goo.gl/forms/i6ZCMTxCDV","_system"):"company"==$stateParams.type?window.open("http://goo.gl/forms/CHhgfebIUL","_system"):window.open("http://goo.gl/forms/v8hWbH8y39","_system")},e.createGroup=function(){l.nextDirection("forward"),o.go("app.create-group")},e.openGroupDetail=function(e,t){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.close(),r(function(){l.nextDirection("forward"),o.go("app.entity",{id:e})},100)}}]).controller("entityAllCtrl",["$scope","$rootScope","dataService","$filter","$state","$translate","$ionicModal","$ionicPopup","$ionicScrollDelegate","storeLocalData",function(e,t,n,a,o,i,r,l,s,c){if(e.search.name="",e.showCreateGroup=!0,n.get("entities?limit=10",{cache:!1}).then(function(t){e.entities=t.data.content}),!t.localData.groupInstructions){var d=l.alert({title:a("translate")("GROUPS.TITLE"),content:a("translate")("INTRO.GROUPS_INTRO"),okType:"button-positive big-button",okText:a("translate")("ACTION.GOT_IT")});d.then(function(e){t.localData.groupInstructions=!0,c.set("rewardInstructions",JSON.stringify(t.localData.groupInstructions))})}e.pullRefresh=function(){e.doRefresh("entities?limit=10").then(function(t){e.challenges=t.data.content})},e.url="entities",e.filter={type:"none"},e.showFilter=!0,e.params={filter:"none"},e.applyFilters=function(){e.entities=[],e.params=angular.extend(e.params,e.filter),e.closeFilter(),window.mixpanel&&window.mixpanel.track("Groups filter applied",{userId:e.me.user_id,email:e.me.email,type:e.filter.type})},r.fromTemplateUrl("templates/entity/filter-modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.openFilter=function(){window.mixpanel&&window.mixpanel.track("Groups filter",{userId:e.me.user_id,email:e.me.email}),e.modal.show()},e.closeFilter=function(){e.modal.hide()},t.$on("updateResult",function(){e.params.search!=e.search.name&&(e.entities=[]),e.filter.search=e.search.name,e.params=angular.extend(e.params,e.filter)}),e.$on("$destroy",function(){e.modal&&e.modal.remove(),t.$$listeners.updateResult=null})}]).controller("entityMineCtrl",["$scope","$rootScope","dataService","$filter","$state","$translate","$ionicModal","$ionicScrollDelegate",function(e,t,n,a,o,i,r,l){e.search.name="",e.showCreateGroup=!1,n.get("entities?filter=mine&limit=10",{cache:!1}).then(function(t){e.entities=t.data.content}),e.pullRefresh=function(){e.doRefresh("entities?filter=mine&limit=10").then(function(t){e.challenges=t.data.content})},e.url="entities",e.params={filter:"mine"},e.filter={type:"none"},e.showFilter=!1,t.$on("updateResult",function(){e.entities=[],e.filter.search=e.search.name,e.params=angular.extend(e.params,e.filter)}),e.$on("$destroy",function(){t.$$listeners.updateResult=null})}]).controller("entitySingleCtrl",["$scope","dataService","$filter","popup","$stateParams","$rootScope","$state","$ionicModal","$ionicHistory","$window","$ionicTabsDelegate","$ionicScrollDelegate","$timeout",function(e,t,n,a,o,i,r,l,s,c,d,u,p){e.name="",e.groupId=o.id,e.wHeight=c.innerHeight-95,e.limit=5,e.showShare=!0,e.iserrorMsg=!1,e.refreshfeed=!0,t.get("entities/"+o.id,{cache:!1}).then(function(t){if(e.item=t.data.content,e.name=e.item.name,e.showShare&&(e.share={text:e.item.share,subject:e.item.name,img:e.item.image_url,link:"https://www.wefitter.com",element:"entity",id:e.item.id},window.mixpanel&&window.mixpanel.track("Groups",{userId:e.me.user_id,email:e.me.email,groupId:o.id})),"intro.entity"==i.currentState&&i.localData.referData.entity_id){var r=n("translate")("INTRO.GROUP_POPUP_TITLE"),l=n("translate")("INTRO.GROUP_POPUP_TEXT");a.imagePopup("wf-people",r,l)}}),t.get("leaderboard/?limit=5",{neverCache:!0,params:{group:o.id}}).then(function(t){e.leaderboard=t.data.content,e.resMeta=t.data.params})["catch"](function(t){401==t.data.summary.status&&(e.iserrorMsg=!0)}),e.refresh=!1,e.pullRefresh=function(){e.doRefresh("entities/"+o.id).then(function(t){e.item=t.data.content,e.name=e.item.name})},e.refreshLeaderboard=function(){e.refresh=!e.refresh,e.$broadcast("scroll.refreshComplete")},e.survey={question:{}},e.params={group:o.id},e.feed_params={},e.filter={mode:"user"},e.url="leaderboard",e.feed_url="entities/comments/"+o.id,e.applyFilters=function(){"user"==e.filter.mode?(e.filter.mode="group",e.filter.top=0,e.limit=5):(e.filter.mode="user",e.filter.top=1,e.limit=10),e.params=angular.extend(e.params,e.filter)},e.loadLeaders=function(){e.filter.mode="user",e.filter.top=1,e.limit=10,e.params=angular.extend(e.params,e.filter),window.mixpanel&&window.mixpanel.track("Group leaderboard",{userId:e.me.user_id,email:e.me.email,group_id:e.item.id})},e.changeState=function(){i.isRefer?e.isReferVisited?r.go("intro.entities"):r.go("intro.start"):r.go("intro.entities")},l.fromTemplateUrl("templates/entity/edit-modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.openModal=function(){e.modal.show()},e.closeModal=function(){e.modal.hide()},e.tabCallback=function(t){"feed"==t&&(e.refreshfeed=!e.refreshfeed,window.mixpanel&&window.mixpanel.track("Group feed",{userId:e.me.user_id,email:e.me.email,group_id:e.item.id}))}}]).controller("entityMembersCtrl",["$scope","$stateParams","dataService","$translate","$ionicScrollDelegate","$timeout",function(e,t,n,a,o,i){e.groupId=t.id,e.teamUrl="entities/teams/"+e.groupId,e.userUrl="profile/search",e.filter={mode:"team"},e.teamParams={},e.search={params:""},e.params={group:e.groupId,team:""};var r;a("FRIENDS.SEARCH_PLACEHOLDER").then(function(t){e.searchPlaceholder=t}),a("PUBLIC_PROFILE.FOLLOW").then(function(t){e.follow_btn_txt=t}),a("PUBLIC_PROFILE.UNFOLLOW").then(function(t){e.unfollow_btn_txt=t}),e.loadData=function(t,a){n.get(t+"?limit=10",{params:a}).then(function(t){e.teams=t.data.content,o.scrollTop()})},e.getTeamUser=function(t){e.params.team=t,e.filter.mode="user",e.teams=[],e.loadData(e.userUrl,e.params)},e.applyFilters=function(){e.teams=[],e.search.params="",e.params.team="",e.params.params="","user"==e.filter.mode?(e.filter.mode="team",e.loadData(e.teamUrl,{})):(e.filter.mode="user",e.loadData(e.userUrl,e.params))},e.updateInterface=function(){"team"==e.filter.mode&&(e.teams=[]),e.filter.mode="user",r&&i.cancel(r),e.search.params?r=i(function(){e.params.params!=e.search.params&&(e.teams=[]),e.params=angular.extend(e.params,e.search)},500):(e.teams=[],e.params=angular.extend(e.params,e.search))},e.changeFollow=function(t){e.teams[t].follow_btn_disable=!0;var a={};0==e.teams[t].following_him?a.follow=1:a.follow=0,n.post("profile/follow/"+e.teams[t].id,a).then(function(n){e.teams[t].following_him=a.follow})["catch"](function(e){$ionicPopup.alert({title:$filter("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data?e.data.summary.message:$filter("translate")("PUBLIC_PROFILE.FOLLOW_ERROR")})})["finally"](function(){e.teams[t].follow_btn_disable=!1})},e.loadData(e.teamUrl,{}),window.mixpanel&&window.mixpanel.track("Group members",{userId:e.me.user_id,email:e.me.email,group_id:e.groupId})}]).controller("create-groupCtrl",["$scope","$state","dataService","Upload","$ionicPopup","$timeout","$filter","$ionicLoading","cropDimension",function(e,t,n,a,o,i,r,l,s){e.title=r("translate")("GROUPS.CREATE_GROUP"),e.isCreate=!0,e.isEdit=!1,e.unitList=[{key:r("translate")("UNIT.DISTANCE"),value:"distance"},{key:r("translate")("UNIT.DURATION"),value:"duration"},{key:r("translate")("UNIT.CAL"),value:"calories"},{key:r("translate")("UNIT.POINTS"),value:"points"}],e.group={default_unit:e.unitList[0]},window.mixpanel&&window.mixpanel.track("Create group",{userId:e.me.user_id,email:e.me.email}),e.changeProfilePic=function(){e.loading=!0,a.fileTo("entities/photo",s.group).then(function(t){t&&t.data.content&&t.data.content.image_url?e.group.image_url=t.data.content.image_url:i(function(){o.alert({title:r("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:"<span translate='PROFILE.ERROR_PIC_UPLOAD'></span>"})}),e.loading=!1},function(t){if("string"==typeof t){if("no image selected"===t||"Selection cancelled."===t)return void(e.loading=!1);i(function(){o.alert({title:r("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:t})})}else{if(t.cancel)return void(e.loading=!1);i(function(){o.alert({title:r("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:"<span translate='PROFILE.ERROR_PIC_UPLOAD'></span>"})})}e.loading=!1})},e.createGroup=function(){if(e.group.create&&e.group.create.name.$error.required)o.alert({title:r("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:r("translate")("GROUPS.CREATE_GROUP_TITLE_ERROR")});else{l.show({template:r("translate")("ACTION.LOADING")});var a={name:e.group.name,referral_code:e.group.name,default_unit:e.group.default_unit.value};e.group.description&&(a.description=e.group.description),e.group.image_url&&(a.picture=e.group.image_url),n.post("entities",a).then(function(n){window.mixpanel&&window.mixpanel.track("Group created",{userId:e.me.user_id,email:e.me.email,groupId:n.data.content.id});var a=n.data.content;l.hide();var i=o.alert({title:r("translate")("ACTION.SUCCESS"),okType:"button-positive big-button",content:"<span translate='GROUPS.CREATE_GROUP_SUCCESS'></span>"});i.then(function(e){t.go("app.entity",{id:a.id})})})["catch"](function(e){l.hide(),o.alert({title:r("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data?e.data.summary.message:r("translate")("GROUPS.CREATE_GROUP_ERROR")})})["finally"](function(){l.hide()})}}}]).controller("edit-groupCtrl",["$scope","$stateParams","$state","dataService","Upload","$ionicPopup","$timeout","$filter","$ionicLoading","cropDimension","$location",function(e,t,n,a,o,i,r,l,s,c,d){e.title=l("translate")("GROUPS.EDIT_GROUP"),e.isCreate=!1,e.isEdit=!0,e.unitList=[{key:l("translate")("UNIT.DISTANCE"),value:"distance"},{key:l("translate")("UNIT.DURATION"),value:"duration"},{key:l("translate")("UNIT.CAL"),value:"calories"},{key:l("translate")("UNIT.POINTS"),value:"points"}],e.group={},a.get("entities/"+t.id,{cache:!1}).then(function(t){e.item=t.data.content,e.group.name=e.item.name,e.group.description=e.item.description,e.group.default_unit=e.unitList[_.findLastIndex(e.unitList,{value:e.item.default_unit})],e.group.image_url=e.item.image_url}),e.dataChanged=0,e.$watch("group",function(t,n){t!==n&&e.dataChanged++},!0),e.changeProfilePic=function(){e.loading=!0,o.fileTo("entities/photo",c.group).then(function(t){t&&t.data.content&&t.data.content.image_url?e.group.image_url=t.data.content.image_url:r(function(){i.alert({title:l("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:"<span translate='PROFILE.ERROR_PIC_UPLOAD'></span>"})}),e.loading=!1},function(t){if("string"==typeof t){if("no image selected"===t||"Selection cancelled."===t)return void(e.loading=!1);r(function(){i.alert({title:l("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:t})})}else{if(t.cancel)return void(e.loading=!1);r(function(){i.alert({title:l("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:"<span translate='PROFILE.ERROR_PIC_UPLOAD'></span>"})})}e.loading=!1})},e.editGroup=function(){if(e.group.create&&e.group.create.name.$error.required)i.alert({title:l("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:l("translate")("GROUPS.CREATE_GROUP_TITLE_ERROR")});else{s.show({template:l("translate")("ACTION.LOADING")});var n={};e.group.description&&(n.description=e.group.description),e.group.image_url&&(n.picture=e.group.image_url);var o={headers:{"Content-Type":"application/x-www-form-urlencoded"
},transformRequest:[function(e){for(var t="",n=Object.keys(e),a=0;a<n.length;a++){var o=angular.isObject(e[n[a]])?JSON.stringify(e[n[a]]):e[n[a]];t=t+n[a]+"="+o,a!=n.length-1&&(t+="&")}return t}]};a.put("entities/"+t.id,n,o).then(function(t){var n=t.data.content;s.hide(),e.dataChanged=0;var a=i.alert({title:l("translate")("ACTION.SUCCESS"),okType:"button-positive big-button",content:"<span translate='GROUPS.EDIT_GROUP_SUCCESS'></span>"});a.then(function(e){d.path("/entity/"+n.id+"#desc")})})["catch"](function(e){s.hide(),i.alert({title:l("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data?e.data.summary.message:l("translate")("GROUPS.CREATE_GROUP_ERROR")})})["finally"](function(){s.hide()})}}}]).controller("leaderboardCtrl",["$scope","$state","dataService","$ionicPopup","$ionicScrollDelegate","$ionicModal","popup",function(e,t,n,a,o,i,r){n.get("leaderboard/?limit=5",{neverCache:!0}).then(function(t){e.leaderboard=t.data.content,e.resMeta=t.data.params}),n.get("entities/?filter=mine",{cache:!1}).then(function(t){e.userEntities=t.data.content}),window.mixpanel&&window.mixpanel.track("Leaderboard",{userId:e.me.user_id,email:e.me.email}),e.refresh=!1,e.pullRefresh=function(){e.refresh=!e.refresh,e.$broadcast("scroll.refreshComplete")},e.filter={rank_unit:"distance"},e.url="leaderboard",e.params={},e.applyFilters=function(){e.params=angular.extend(e.params,e.filter),e.closeFilter(),window.mixpanel&&window.mixpanel.track("Leaderboard filter applied",{userId:e.me.user_id,email:e.me.email,group:e.filter.group,period:e.filter.period,rank_unit:e.filter.rank_unit})},i.fromTemplateUrl("templates/leaderboard/filter-modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.openFilter=function(){e.modal.show(),window.mixpanel&&window.mixpanel.track("Leaderboard filter",{userId:e.me.user_id,email:e.me.email})},e.closeFilter=function(){e.modal.hide()},e.goToGroups=function(){e.closeFilter(),t.go("app.entities")},e.$on("$destroy",function(){e.modal&&e.modal.remove()})}]).controller("connectionFAQCtrl",["$scope","$filter",function(e,t){e.faq=t("translate")("CONNECT.CONNECTIONS_FAQ_TEXT")}]).controller("userProfileCtrl",["$scope","dataService","$translate",function(e,t,n){e.pullRefresh=function(){e.doRefresh("profile/public/"+e.me.user_id).then(function(t){e.publicData=t.data.content})},n("PROFILE.EDIT_PROFILE").then(function(t){e.profileEdit_btn_txt=t}),n("PROFILE.SETTINGS").then(function(t){e.setting_btn_txt=t}),t.get("profile/public/"+e.me.user_id).then(function(t){e.publicData=t.data.content,window.mixpanel&&window.mixpanel.track("Profile seen",{user_id:e.me.user_id,email:e.me.email})})}]).controller("publicProfileCtrl",["$scope","dataService","$translate","$stateParams","$ionicPopup","$filter",function(e,t,n,a,o,i){e.follow_btn_disable=!1,n("PUBLIC_PROFILE.FOLLOW").then(function(t){e.follow_btn_txt=t}),n("PUBLIC_PROFILE.UNFOLLOW").then(function(t){e.unfollow_btn_txt=t}),n("PUBLIC_PROFILE.MESSAGE").then(function(t){e.message_btn_txt=t}),t.get("profile/public/"+a.id).then(function(t){e.publicData=t.data.content}),window.mixpanel&&window.mixpanel.track("Public profile seen",{user_id:e.me.user_id,email:e.me.email,user_seen:a.id}),e.changeFollow=function(){e.follow_btn_disable=!0;var n={};0==e.publicData.ImFollowing?n.follow=1:n.follow=0,t.post("profile/follow/"+a.id,n).then(function(t){e.publicData.ImFollowing=n.follow,1==n.follow?(e.publicData.friends_summary[0].followers++,window.mixpanel&&window.mixpanel.track("Follow",{user_id:e.me.user_id,email:e.me.email,user_followed:a.id})):(e.publicData.friends_summary[0].followers--,window.mixpanel&&window.mixpanel.track("Unfollow",{user_id:e.me.user_id,email:e.me.email,user_unfollowed:a.id}))})["catch"](function(e){o.alert({title:i("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data?e.data.summary.message:i("translate")("PUBLIC_PROFILE.FOLLOW_ERROR")})})["finally"](function(){e.follow_btn_disable=!1})},e.privateMsg=function(){o.alert({title:i("translate")("ACTION.MESSAGE"),okType:"button-positive big-button",content:i("translate")("PUBLIC_PROFILE.MESSAGE_TEXT")}),window.mixpanel&&window.mixpanel.track("Private message",{user_id:e.me.user_id,email:e.me.email,user_seen:a.id})}}]).controller("friendsCtrl",["$scope","$filter","$translate","$stateParams","dataService","$ionicPopup",function(e,t,n,a,o,i){n("FRIENDS.SEARCH_PLACEHOLDER").then(function(t){e.searchPlaceholder=t}),n("PUBLIC_PROFILE.FOLLOW").then(function(t){e.follow_btn_txt=t}),n("PUBLIC_PROFILE.UNFOLLOW").then(function(t){e.unfollow_btn_txt=t}),e.showError=!1,e.userId=a.id,e.search={name:""},e.userId==e.me.user_id?e.url="profile/friends":(e.url="profile/public/"+e.userId+"/friends",e.userName=a.name+"&#39;s"),e.getFriendsData=function(n){e.friends=[],e.showError=!1,o.get(n).then(function(t){e.friends=t.data.content})["catch"](function(e){i.alert({title:t("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data?e.data.summary.message:t("translate")("PUBLIC_PROFILE.FOLLOW_ERROR")})})["finally"](function(){e.showError=!0})},e.changeFollow=function(n){e.friends[n].follow_btn_disable=!0;var r={};0==e.friends[n].following?r.follow=1:r.follow=0,o.post("profile/follow/"+e.friends[n].id,r).then(function(t){e.friends[n].following=r.follow,1==r.follow?window.mixpanel&&window.mixpanel.track("Follow",{user_id:e.me.user_id,email:e.me.email,user_followed:a.id}):window.mixpanel&&window.mixpanel.track("Unfollow",{user_id:e.me.user_id,email:e.me.email,user_unfollowed:a.id})})["catch"](function(e){i.alert({title:t("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data?e.data.summary.message:t("translate")("PUBLIC_PROFILE.FOLLOW_ERROR")})})["finally"](function(){e.friends[n].follow_btn_disable=!1})}}]).controller("friendsFollowersCtrl",["$scope","$filter",function(e,t){e.showAddFriend=!1,e.url=e.url+"?type=followers",e.getFriendsData(e.url)}]).controller("friendsFollowingCtrl",["$scope","$filter",function(e,t){e.showAddFriend=!0,e.url=e.url+"?type=following",e.getFriendsData(e.url)}]).controller("addFriendCtrl",["$scope","$rootScope","$filter","$translate","$timeout","dataService","$ionicPopup",function(e,t,n,a,o,i,r){e.$on("$ionicView.afterEnter",function(t,n){window.mixpanel&&window.mixpanel.track("Add friends",{userId:e.me.user_id,email:e.me.email})}),e.search={params:""},e.searchResult=[],e.url="profile/search",e.params={};var l;a("FRIENDS.SEARCH_PLACEHOLDER").then(function(t){e.searchPlaceholder=t}),a("ADD_FRIEND.SHARE_TITLE").then(function(t){e.addFriendTitle=t}),a("ADD_FRIEND.SHARE_TEXT",{code:e.me.referral_code}).then(function(t){e.addFriendText=t,e.share={text:e.addFriendText,subject:n("translate")("ADD_FRIEND.SHARE_TITLE"),img:"",link:"https://www.wefitter.com",element:"invite",id:e.me.referral_code}}),a("PUBLIC_PROFILE.FOLLOW").then(function(t){e.follow_btn_txt=t}),a("PUBLIC_PROFILE.UNFOLLOW").then(function(t){e.unfollow_btn_txt=t}),e.share={text:e.addFriendText,subject:e.addFriendTitle,img:"",link:"https://www.wefitter.com",element:"invite",id:e.me.id},e.updateInterface=function(){l&&o.cancel(l),e.search.params?l=o(function(){e.params.params!=e.search.params&&(e.searchResult=[]),e.params=angular.extend(e.params,e.search)},500):e.searchResult=[]},e.changeFollow=function(t){e.searchResult[t].follow_btn_disable=!0;var a={};0==e.searchResult[t].following_him?a.follow=1:a.follow=0,i.post("profile/follow/"+e.searchResult[t].id,a).then(function(n){e.searchResult[t].following_him=a.follow,1==a.follow?window.mixpanel&&window.mixpanel.track("Follow",{user_id:e.me.user_id,email:e.me.email,user_followed:e.searchResult[t].id}):window.mixpanel&&window.mixpanel.track("Unfollow",{user_id:e.me.user_id,email:e.me.email,user_unfollowed:e.searchResult[t].id})})["catch"](function(e){r.alert({title:n("translate")("ACTION.ERROR"),okType:"button-positive big-button",content:e.data?e.data.summary.message:n("translate")("PUBLIC_PROFILE.FOLLOW_ERROR")})})["finally"](function(){e.searchResult[t].follow_btn_disable=!1})},e.openEmail=function(){window.mixpanel&&window.mixpanel.track("Invite by email",{user_id:e.me.user_id,email:e.me.email}),"ios"==ionic.Platform.platform()?window.open("mailto://","_system","location=no"):"android"==ionic.Platform.platform()&&window.open("mailto:","_system")},e.trackFbFriends=function(){window.mixpanel&&window.mixpanel.track("Invite fb friends",{user_id:e.me.user_id,email:e.me.email})}}]).controller("findFriendCtrl",["$scope","$stateParams","$translate",function(e,t,n){function a(){window.mixpanel&&window.mixpanel.track("Invite fb friends",{user_id:e.me.user_id,email:e.me.email}),facebookConnectPlugin.login(["email","user_birthday","user_location","user_friends"],function(t){facebookConnectPlugin.api("/me/friends?fields=id,picture,name",["user_friends"],function(t){for(var n=[],a=0;a<t.data.length;a++){var o={first_name:t.data[a].name,image_url:t.data[a].picture?t.data[a].picture.data.url:t.data[a].picture};n.push(o)}e.searchResult=n,e.showError=!0,e.$apply()},function(t){e.showError=!0,e.$apply()})},function(t){e.showError=!0,e.$apply()})}function o(){function t(t){for(var n=0;n<t.length;n++)t[n].first_name=t[n].displayName,t[n].image_url=t[n].photos,t[n].photos&&(t[n].image_url=t[n].photos[0].value),delete t[n].displayName,delete t[n].photos;e.searchResult=t,e.showError=!0,e.$apply()}function n(t){e.showError=!0,e.$apply()}window.mixpanel&&window.mixpanel.track("Invite contacts",{user_id:e.me.user_id,email:e.me.email});var a=[navigator.contacts.fieldType.displayName,navigator.contacts.fieldType.name];navigator.contacts.find(a,t,n)}n("ADD_FRIEND.SEARCH_PLACEHOLDER").then(function(t){e.searchPlaceholder=t}),n("PUBLIC_PROFILE.FOLLOW").then(function(t){e.follow_btn_txt=t}),n("PUBLIC_PROFILE.UNFOLLOW").then(function(t){e.unfollow_btn_txt=t}),e.showError=!1,e.search={name:""},e.searchResult=[],"fb"==t.type?a():"contact"==t.type&&o()}]);