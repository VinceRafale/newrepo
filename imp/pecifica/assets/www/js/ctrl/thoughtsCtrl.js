!function(){function e(){$ionicPopup.alert({title:"",template:"<div>"+$translate.instant("THOUGHTS_MIC_ACCESS_PROMPT")+"</div>",okText:$translate.instant("OK_GOT_IT"),okType:"button-default"}).then(function(){("app.rethink-record"==$state.current.name||"app.breathe-record"==$state.current.name||"app.muscles-record"==$state.current.name)&&$ionicHistory.goBack()})}function t(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.diagnostic&&cordova.plugins.diagnostic.requestMicrophoneAuthorization(function(t){t===cordova.plugins.diagnostic.permissionStatus.GRANTED||e()},function(){e()})}function o(e,t,o){var i="";return t.indexOf("catastrophizing")>=0&&(i+=e.instant("THOUGHTS_EMOTIONS_CATASTROPHIZING")),t.indexOf("emotional_reasoning")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_EMOTIONAL_REASONING")),t.indexOf("mind_reading")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_MIND_READING")),t.indexOf("fortune_telling")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_FORTUNE_TELLING")),t.indexOf("extreme_words")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_PRESSURIZED")),t.indexOf("judging")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_LABELLING")),t.indexOf("personalization")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_PERSONALIZATION")),t.indexOf("overgeneralizing")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_GENERALIZING")),t.indexOf("negative_filtering")>=0&&(i.length>0&&(i+=", "),i+=e.instant("THOUGHTS_EMOTIONS_NEGATIVE")),t.indexOf("notsure")>=0&&(i.length>0&&(i+=", "),i+=e.instant("NEGATIVE_THOUGHT")),0===i.length&&(i=e.instant("negative"==o?"NEGATIVE_THOUGHT":"POSITIVE_THOUGHT")),i}function i(e,t){function o(o){o.root.getFile(e,{create:!0,exclusive:!1},function(e){t(e)},function(){})}function i(){}window.LocalFileSystem&&window.requestFileSystem(LocalFileSystem.TEMPORARY,0,o,i)}function n(e,t,o,n){if(g[t])o.mediaRec=g[t],o.elapsedTime=o.mediaRec.__elapsedTime,o.elapsedTime||(o.elapsedTime=0);else{var a=function(e){o.mediaRec=new Media(e,function(){},function(e){},n),o.mediaRec.setVolume(1),r(),g[t]=o.mediaRec};i(t,function(t){e.isAndroid()?(o.nativeSrc=t.nativeURL,a(o.nativeSrc)):(o.nativeSrc=t.nativeURL,a(t.fullPath))})}}function r(){for(var e in g)g[e].release(),delete g[e]}function a(e,t,o,i,n,r,a,c){window.backButtonOverride=function(){a&&a();var t=e.confirm({template:'<div class="thisisatest">'+n+"</div>",cancelText:i.instant("CANCEL"),cancelType:"button-default",okText:i.instant("CONFIRM"),okType:"button-default"});t.then(function(e){e&&(r&&r(),o.goBack())})},window.backButtonOverrideCaller=c}function c(e){e==window.backButtonOverrideCaller&&(window.backButtonOverride=void 0,window.backButtonOverrideCaller=void 0)}function s(){localStorage.removeItem("rethinkReplayState")}var u=angular.module("rethinkCtrl",[]),l=0;u.controller("ThoughtsCtrl",["$scope","$state","$translate","$ionicPopup","$ionicActionSheet","AccountService","AudioService","PayService","SkillsService","Environment",function(e,t,o,i,n,r,a,c,s,u){e.activityOptions={options:["THOUGHTS_ACTIVITY_COGNITIVE_DISTORTIONS","THOUGHTS_ACTIVITY_JOURNAL","THOUGHTS_ACTIVITY_GRATITUDE","THOUGHTS_ACTIVITY_POSITIVITY"],activityOptionOrdinal:0};var l=r.getUserPreference("preferred_thought_activity");if(l){var g=e.activityOptions.options.indexOf(l);g>=0&&(e.activityOptions.activityOptionOrdinal=g)}e.goToGratitudeCommunity=function(){if(u.isOnline()){var e=u.isDevelopment()?9:4;t.go("app.communities-posts",{groupId:e,order:"hotness"}),$analytics.eventTrack("goToGratitudeCommunity",{category:"thoughts"})}else{i.alert({template:o.instant("GROUPS_OFFLINE_ERROR"),okText:o.instant("OK_GOT_IT"),okType:"button-default"})}},e.updateActivityOption=function(){r.setUserPreference("preferred_thought_activity",e.activityOptions.options[e.activityOptions.activityOptionOrdinal])},e.isActivitySuggested=function(e){var t=s.getSuggestedActivityId();return t?"THOUGHTS_ACTIVITY_COGNITIVE_DISTORTIONS"==e?"COMPLETED_RETHINK"==t:"THOUGHTS_ACTIVITY_JOURNAL"==e?"COMPLETED_JOURNAL"==t:"THOUGHTS_ACTIVITY_GRATITUDE"==e?"COMPLETED_GRATITUDE_JOURNAL"==t:"THOUGHTS_ACTIVITY_POSITIVITY"==e?"COMPLETED_POSITIVITY_JOURNAL"==t:void 0:!1},e.isActivityOption=function(t){return e.activityOptions.activityOptionOrdinal==e.activityOptions.options.indexOf(t)},e.getActivityOptionDescription=function(){return o.instant(e.isActivityOption("THOUGHTS_ACTIVITY_JOURNAL")?"THOUGHTS_JOURNAL_HEADER":e.isActivityOption("THOUGHTS_ACTIVITY_GRATITUDE")?"THOUGHTS_GRATITUDE_DESCRIPTION":e.isActivityOption("THOUGHTS_ACTIVITY_POSITIVITY")?"THOUGHTS_POSITIVITY_DESCRIPTION":"THOUGHTS_RECORD_DESCRIPTION")},e.isPremiumEnabled=function(){return r.isPremiumEnabled()},e.setActivityOption=function(t){var o=e.activityOptions.options.indexOf(t);0===o||e.isPremiumEnabled()?(e.activityOptions.activityOptionOrdinal=o,e.updateActivityOption()):c.showPremiumModal(e,"thoughts","activityOption",!0)},e.getActivityOptionDisplay=function(e){return o.instant(e)},e.inputOptions={options:[o.instant("TEXT"),o.instant("VOICE")],inputOptionOrdinal:0};var h=r.getUserPreference("preffered_thought_input");h&&"VOICE"==h&&(e.inputOptions.inputOptionOrdinal=1),e.updateInputOption=function(){0===e.inputOptions.inputOptionOrdinal?r.setUserPreference("preffered_thought_input","TEXT"):r.setUserPreference("preffered_thought_input","VOICE")},e.getInputOptionDisplay=function(e){var t="INPUT_OPTION_";t+=e==o.instant("TEXT")?"TEXT":"VOICE",t=t.replace(/ /g,"_").replace(/\+/g,"").replace(/-/g,"").replace(/__/g,"_").toUpperCase();var i=o.instant(t);return i},e.startActivity=function(){if(e.updateInputOption(),0===e.activityOptions.activityOptionOrdinal)0===e.inputOptions.inputOptionOrdinal?(a.clearActiveTextThought(),r.getUserPreference("completed_text_thoughts_intro_record")?t.go("app.textthoughts-record"):t.go("app.textthoughts-record-help",{intro:!0})):r.getUserPreference("completed_rethink_intro_record")?t.go("app.rethink-record"):t.go("app.rethink-record-help",{intro:!0});else{var o={},i=e.activityOptions.options[e.activityOptions.activityOptionOrdinal];"THOUGHTS_ACTIVITY_GRATITUDE"==i?o.journalType="gratitude":"THOUGHTS_ACTIVITY_POSITIVITY"==i&&(o.journalType="positivity"),0===e.inputOptions.inputOptionOrdinal?t.go("app.textthoughts-journal",o):t.go("app.journal-record",o)}}}]),u.controller("TextThoughtsJournalCtrl",["$scope","$rootScope","$controller","$state","$stateParams","$timeout","$translate","$ionicNavBarDelegate","$ionicPopup","$ionicModal","AccountService","AudioService","HabitsService","Environment",function(e,t,o,i,n,r,a,c,s,u,l,g){o("TextThoughtsRecordCtrl",{$scope:e}),e.showHelp=function(){return!1},e.getThoughtsRecordHeader=function(){return a.instant("gratitude"==n.journalType?"JOURNAL_GRATITUDE_HEADER":"positivity"==n.journalType?"JOURNAL_POSITIVITY_HEADER":"JOURNAL_RECORD_HEADER")},e.getPageTitle=function(){return a.instant("gratitude"==n.journalType?"THOUGHTS_ACTIVITY_GRATITUDE":"positivity"==n.journalType?"THOUGHTS_ACTIVITY_POSITIVITY":"ADD_JOURNAL")},e.getTextPlaceholder=function(){return a.instant("gratitude"==n.journalType?"GRATITUDE_TEXT_PLACEHOLDER":"positivity"==n.journalType?"POSITIVITY_TEXT_PLACEHOLDER":"JOURNAL_TEXT_PLACEHOLDER")},e.cleanThought=function(){},e.getNextStepText=function(){return a.instant(e.hasText()?"SAVE":"START")},e.nextStep=function(){if(!e.hasText())return void r(function(){$("textarea").focus()});e.textThoughtError=void 0,g.clearActiveTextThought();var t,o;"gratitude"==n.journalType?(o="THOUGHTS_ACTIVITY_GRATITUDE",t="COMPLETED_GRATITUDE_JOURNAL"):"positivity"==n.journalType?(o="THOUGHTS_ACTIVITY_POSITIVITY",t="COMPLETED_POSITIVITY_JOURNAL"):(o="JOURNAL",t="COMPLETED_JOURNAL");{var a=g.createThought(o);g.addRecording(void 0,void 0,"journal",e.thought.length,a.id,e.thought)}g.postThought(a.id,"TEXT_JOURNAL"),l.recordActivity(t),i.go("app.home")}}]),u.controller("TextThoughtsRecordCtrl",["$scope","$state","$timeout","$translate","$ionicNavBarDelegate","$ionicPopup","AccountService","AudioService","HabitsService","Environment",function(e,t,o,i,n,r,a,c,s,u){function l(){u.isAndroid()&&$(".bar-footer").hide()}function g(){u.isAndroid()&&$(".bar-footer").show()}c.clearActiveTextHighlight(),e.isAndroid=function(){return u.isAndroid()},e.showHelp=function(){return!0},e.isAndroid()&&window.ionic.keyboard&&window.ionic.keyboard.disable(),e.thought=c.getActiveTextThought(),e.thought||(e.thought=""),u.isOnline()||o(function(){r.alert({title:"Warning",template:i.instant("THOUGHTS_OFFLINE_PROMPT"),okText:"OK, GOT IT.",okType:"button-default"})}),e.getPageTitle=function(){return i.instant("THOUGHTS_STEP_ONE_OF_THREE")},e.getThoughtsRecordHeader=function(){return i.instant("THOUGHTS_RECORD_HEADER")},e.getTextPlaceholder=function(){return i.instant("THOUGHTS_RECORD_QUESTIONS")},e.hasText=function(){return e.thought.length>0},e.cleanThought=function(){e.thought=e.thought.replace(/\r?\n|\r/g," "),e.thought=e.thought.replace(/\s\s+/g," ")},e.getNextStepText=function(){return i.instant(e.hasText()?"NEXT_STEP":"START")},e.nextStep=function(){return e.hasText()?(e.textThoughtError=void 0,e.cleanThought(),c.storeActiveTextThought(e.thought),void(a.getUserPreference("completed_text_thoughts_intro_analyze")?t.go("app.textthoughts-analyze"):t.go("app.textthoughts-analyze-help",{intro:!0}))):void o(function(){$("textarea").focus()})},e.goToHelp=function(){e.cleanThought(),c.storeActiveTextThought(e.thought),t.go("app.textthoughts-record-help")};var h=window.innerHeight;window.resizeTextArea=function(){var e=$("ion-content").offset(),t=$("h2").outerHeight(),o=$(".bar-footer").outerHeight();$("textarea").css("height",h-t-e.top-o)},e.$on("$ionicView.afterEnter",function(){o(resizeTextArea,1e3)}),window.addEventListener("native.keyboardshow",l),window.addEventListener("native.keyboardhide",g),e.$on("$destroy",function(){e.isAndroid()&&window.ionic.keyboard&&window.ionic.keyboard.enable(),window.removeEventListener("native.keyboardshow",l),window.removeEventListener("native.keyboardhide",g)})}]),u.controller("TextThoughtsAnalyzeCtrl",["$sce","$scope","$state","$timeout","$translate","$ionicActionSheet","$ionicModal","$ionicPopup","$ionicPopover","$ionicScrollDelegate","AccountService","AudioService","HabitsService","Environment",function(e,t,i,n,r,a,c,s,u,l,g,h,p,d){function T(){t.recording.tags.sort(function(e,t){return e.tagTime-t.tagTime})}function v(){if(0===y.length)t.thoughtHTML=e.trustAsHtml('<span class="thoughtWord">'+H.join('</span> <span class="thoughtWord">')+"</span>");else{for(var o="",i=0;i<H.length;++i){for(var r=!1,a=!1,c=!1,s="",u=0;u<y.length;++u){var l=y[u];if(i>=l.start&&i<=l.end){a=i==l.start,c=i==l.end,r=!0,l.tagType&&(s=l.tagType),a&&(s+=" start"),c&&(s+=" end");break}}o+=r?'<span class="thoughtWord thoughtHighlight '+s+'">':'<span class="thoughtWord">',o+=H[i],r&&!c&&(o+=" "),o+="</span>",(!r||c)&&(o+=" ")}t.thoughtHTML=e.trustAsHtml(o)}n(function(){$(".thoughtWord").click(O)}),t.$$phase||t.$digest()}function f(e,i,n){var a=$.event.fix(e),c=i?i.split(","):[],s=o(r,c,n),l='<ion-popover-view class="platform-ios review-tip"><ion-header-bar> <h1 class="title">'+s+'</h1> </ion-header-bar><ion-content><a href="javascript:;" class="custom-popover-button" onclick="clearHighlight()">Clear</a></ion-content></ion-popover-view>';t.removePopover(),t.popover=u.fromTemplate(l,{scope:t}),t.popover.show(a)}function m(e){var o=$.event.fix(e),i='<ion-popover-view class="platform-ios highlight-tooltip"><ion-header-bar> <h1 class="title">'+r.instant("TEXT_THOUGHTS_ANALYZE_HIGHLIGHT_TOOLTIP")+"</h1> </ion-header-bar></ion-popover-view>";t.removeHighlightPopover(),t.highlightPopover=u.fromTemplate(i,{scope:t}),t.highlightPopover.show(o)}function O(e){var o=$(e.target),i=o.parent().children().index(o);if(o.hasClass("thoughtHighlight")){for(var a=-1,c=0;c<y.length;++c){var u=y[c];if(i>=u.start&&i<=u.end){a=c;break}}window.clearHighlight=function(){a>=0&&(y.splice(a,1),h.storeActiveTextHighlights(y),v(),t.recording.tags&&t.recording.tags.splice(a,1),t.removePopover())};var l=a>=0?t.recording.tags[a]:void 0,p=l?l.tagString:void 0;return void f(e,p,l.tagTypeString)}if(R==i&&t.activeHighlight)R=void 0;else if(void 0===R){R=i;var d=g.getUserPreference("viewed_highlight_tooltip");d&&"false"!=d||(m(e),g.setUserPreference("viewed_highlight_tooltip",!0))}else{for(var T=i>R?i:R,O=i>R?R:i,_=0;_<y.length;++_){var H=y[_];if(O<H.start&&T>H.end)return s.alert({title:"",template:"<div>"+r.instant("THOUGHTS_OVERLAPPING_HIGHLIGHT_ERROR")+"</div>",okText:r.instant("OK_GOT_IT"),okType:"button-default"}),void(R=void 0)}t.activeHighlight={start:O,end:T},y.push(t.activeHighlight),y.sort(function(e,t){return e.start-t.start}),h.storeActiveTextHighlights(y),v(),R=void 0,n(S)}}function S(){t.hideSheet=a.show({buttons:[{text:r.instant("NEGATIVE")}],cancelText:r.instant("CANCEL"),cancel:function(){var e=y.indexOf(t.activeHighlight);y.splice(e,1),t.activeHighlight=void 0,v(),t.hideSheet(),h.storeActiveTextHighlights(y)},buttonClicked:function(){return t.activeHighlight.tagType="negative",t.showEmotionModal(),h.storeActiveTextHighlights(y),v(),!0}})}t.isAndroid=function(){return d.isAndroid()};var R,_=h.getActiveTextThought(),H=_.split(" "),y=[],A=h.getActiveTextHighlights();if(A&&(y=A),t.negativeThoughts=[],t.showingHelp=[],t.thought=h.createThought(),t.recording=h.addRecording(void 0,void 0,"thought",H.length,t.thought.id,_),y.length>0){t.recording.tags||(t.recording.tags=[]);for(var I=0;I<y.length;++I){var w=y[I];t.recording.tags.push({tagTypeString:w.tagType,tagTime:w.start,tagSpan:w.end-w.start+1,tagString:w.tagString})}T()}h.setActiveThoughtId(t.thought.id),v(),t.removePopover=function(){t.popover&&(t.popover.remove(),t.popover=void 0)},t.$on("$destroy",function(){t.removePopover(),t.removeHighlightPopover(),window.showTagToolTip=void 0,window.clearHighlight=void 0}),t.removeHighlightPopover=function(){t.highlightPopover&&(t.highlightPopover.remove(),t.highlightPopover=void 0)},t.isSelected=function(e){return t.negativeThoughts.indexOf(e)>=0},t.showReplayHelp=function(e){if(t.isShowingHelp(e)){var o=t.showingHelp.indexOf(e);t.showingHelp.splice(o,1)}else t.showingHelp.push(e);event.stopPropagation(),event.preventDefault()},t.isShowingHelp=function(e){return t.showingHelp.indexOf(e)>=0},t.setNegativeThought=function(e){if("notsure"!=e&&t.isSelected("notsure")){var o=t.negativeThoughts.indexOf("notsure");o>=0&&t.negativeThoughts.splice(o,1)}else"notsure"==e&&(t.negativeThoughts.length=0);if(t.isSelected(e)){var i=t.negativeThoughts.indexOf(e);t.negativeThoughts.splice(i,1)}else t.negativeThoughts.push(e)},t.assignThoughts=function(){if(t.activeHighlight){t.recording.tags||(t.recording.tags=[]);var e;"negative"==t.activeHighlight.tagType&&(e=t.negativeThoughts.join(",")),t.recording.tags.push({tagTypeString:t.activeHighlight.tagType,tagTime:t.activeHighlight.start,tagSpan:t.activeHighlight.end-t.activeHighlight.start+1,tagString:e}),T(),t.activeHighlight.tagString=e,h.storeActiveTextHighlights(y),t.activeHighlight=void 0}t.closeEmotionModal()},t.showEmotionModal=function(){t.negativeThoughts.length=0,t.showingHelp.length=0,t.setNegativeThought("notsure"),c.fromTemplateUrl("views/thoughts/rethink.emotions.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.emotionsModal=e,openModal(t.emotionsModal)})},t.closeEmotionModal=function(e){t.emotionsModal&&(closeModal(t.emotionsModal),t.emotionsModal.remove(),t.emotionsModal=void 0),e&&(y.length=y.length-1,t.activeHighlight=void 0,v(),h.storeActiveTextHighlights(y))},t.getTagCount=function(e){var o=0;if(t.recording.tags)for(var i=0;i<t.recording.tags.length;++i){var n=t.recording.tags[i];e&&"positive"==n.tagTypeString?++o:e||"negative"!=n.tagTypeString||++o}return o},t.canGoToNextStep=function(){return t.recording.tags&&t.recording.tags.length>0},t.nextStep=function(){g.getUserPreference("completed_text_thoughts_intro_rethink")?i.go("app.textthoughts-rethink",{thoughtId:t.thought.id}):i.go("app.textthoughts-rethink-help",{intro:!0,thoughtId:t.thought.id})};var E=window.innerHeight;window.resizeTextArea=function(){var e=$("ion-content").offset(),t=$("h2").outerHeight(),o=$(".bar-footer").outerHeight();$(".thought-highlight-box").css("height",E-t-e.top-o)},t.$on("$ionicView.afterEnter",function(){n(resizeTextArea,1e3)})}]),u.controller("TextThoughtsRethinkCtrl",["$sce","$scope","$rootScope","$state","$controller","$stateParams","$timeout","$translate","$ionicActionSheet","$ionicModal","$ionicPopover","$ionicPopup","AccountService","AudioService","HabitsService","Environment",function(e,t,o,i,n,r,a,c,s,u,l,g,h,p,d,T){function v(){var o="";_="";for(var i=-1,n=0;n<O.length;++n){for(var r=!1,c=!1,s=!1,u="",l=0;l<H.length;++l){var g=H[l];if(n>=g.tagTime&&n<=g.tagTime+g.tagSpan-1){c=n==g.tagTime,s=n==g.tagTime+g.tagSpan-1,r=!0,g.tagTypeString&&(u=g.tagTypeString),c&&(++i,S[i]?u+=" replaced":"negative"==g.tagTypeString&&(u+=" toReplace"));break}}if(c?o+='<span class="thoughtWord thoughtHighlight start end original '+u+'">':r||(o+='<span class="thoughtWord">'),o+=O[n],_+=O[n],r&&!s&&(o+=" "),c){var h=_.split(" "),p={tagTime:h.length-1,tagSpan:H[i].tagSpan,tagTypeString:H[i].tagTypeString,tagString:H[i].tagString};R[i]=p}if(n<O.length&&(_+=" "),(s||!r)&&(o+="</span>",s&&S[i])){var d=_.split(" "),v=S[i],y=v.content.split(" ");v.tagTime=d.length-1,v.tagSpan=y.length,_+=v.content+" ",o+=' <span class="thoughtWord thoughtHighlight positive replacement">'+v.content+"</span>"}(!r||s)&&(o+=" ")}t.thoughtHTML=e.trustAsHtml(o),a(function(){$(".toReplace").click(m),T.isAndroid()||T.isIos()?$(".replacement").on("tap",f):$(".replacement").click(f)}),t.$$phase||t.$digest()}function f(e){var o=$(e.target),i=o.prev(),n=i.parent().children(".original").index(i),r='<ion-popover-view class="platform-ios review-tip"><ion-header-bar> <h1 class="title">'+c.instant("POSITIVE_THOUGHT")+'</h1> </ion-header-bar><ion-content><a href="javascript:;" class="custom-popover-button" onclick="removeReplacement('+n+')">Clear</a></ion-content></ion-popover-view>';t.removePopover(),t.popover=l.fromTemplate(r,{scope:t});var a=$.event.fix(e);t.popover.show(a)}function m(e){var o=$(e.target);t.thoughtToReplace=o[0].innerText,t.tagIndexToReplace=o.parent().children(".original").index(o),t.replaceWrapper={thoughtReplacement:""},u.fromTemplateUrl("views/thoughts/thoughts.text.replace.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.replaceModal=e,openModal(t.replaceModal)})}t.isAndroid=function(){return T.isAndroid()},t.thought=p.getThought(r.thoughtId),t.thoughtRecording=t.thought.recordings.thought;var O=t.thoughtRecording.notes.split(" "),S={},R={};t.analyzeRecording=p.addRecording(void 0,void 0,"analysis",O.length,t.thought.id);var _="",H=t.thoughtRecording.tags;H||(H=[]),H.sort(function(e,t){return e.tagTime-t.tagTime}),t.closeReplaceModal=function(){closeModal(t.replaceModal),t.replaceModal.remove(),t.replaceModal=void 0},t.replacethought=function(){var e=(t.thoughtRecording.tags[t.tagIndexToReplace],t.replaceWrapper.thoughtReplacement.trim());e=e.replace(/\s\s+/g," "),S[t.tagIndexToReplace]={tagTypeString:"positive",content:e},v(),t.closeReplaceModal()},t.removePopover=function(){t.popover&&(t.popover.remove(),t.popover=void 0)},t.$on("$destroy",function(){t.removePopover(),window.removeReplacement=void 0}),window.removeReplacement=function(e){delete S[e],v(),t.removePopover()},t.hasReplacementText=function(){return t.replaceWrapper&&t.replaceWrapper.thoughtReplacement&&t.replaceWrapper.thoughtReplacement.length>0},v(),t.getTextThoughtsRethinkTitle=function(){return e.trustAsHtml(c.instant("TEXT_THOUGHTS_RETHINK_TITLE"))},t.getTagCount=function(e){var t=0;if(e){for(var o=0;o<H.length;++o)"positive"==H[o].tagTypeString&&++t;for(var i in S)++t}else for(var n=0;n<H.length;++n)"negative"==H[n].tagTypeString&&(S[n]||++t);return t},t.finish=function(){t.analyzeRecording.notes=_;for(var e=[],o=0;o<H.length;++o){var n=R[o];if(e.push(n),S[o]){n.replaced=!0;var r=$.extend({},S[o]);delete r.content,e.push(r)}}t.analyzeRecording.tags=e,p.postThought(t.thought.id,"TEXT_DISTORTIONS"),h.recordActivity("COMPLETED_RETHINK"),i.go("app.home")},t.closeCompletedRethinkModal=function(){h.setUserPreference("completed_rethink","true"),closeModal(t.completedRethinkModal),t.completedRethinkModal.remove(),t.completedRethinkModal=void 0,i.go("app.home")};var y=window.innerHeight;window.resizeTextArea=function(){var e=$("ion-content").offset(),t=$("h2").outerHeight(),o=$(".bar-footer").outerHeight();$(".thought-highlight-box").css("height",y-t-e.top-o)},t.$on("$ionicView.afterEnter",function(){a(resizeTextArea,1e3)})}]),u.controller("TextThoughtsJournalReviewCtrl",["$sce","$scope","$rootScope","$state","$controller","$stateParams","$timeout","$translate","$ionicActionSheet","$ionicModal","$ionicPopup","$ionicPopover","AccountService","AudioService","HabitsService",function(e,t,o,i,n,r,a,c,s,u,l,g,h,p){t.thought=r.thoughtId?p.getThought(r.thoughtId):p.getTextThoughtForReview();var d=t.thought.recordings.journal;t.journal=d.notes,t.getToughtTitle=function(){return t.thought.title}}]),u.controller("TextThoughtsReviewCtrl",["$sce","$scope","$rootScope","$state","$controller","$stateParams","$timeout","$translate","$ionicActionSheet","$ionicModal","$ionicPopup","$ionicPopover","AccountService","AudioService","HabitsService",function(e,t,i,n,r,a,c,s,u,l,g,h,p,d){t.thought=a.thoughtId?d.getThought(a.thoughtId):d.getTextThoughtForReview(),t.analysisRecording=t.thought.recordings.analysis,t.thoughtRecording=t.thought.recordings.thought;var T;t.analysisRecording?T=t.analysisRecording.notes.split(" "):t.thoughtRecording&&(T=t.thoughtRecording.notes.split(" "));var v="",f=-1,m=t.analysisRecording?t.analysisRecording.tags:[];m.sort(function(e,t){return e.tagTime-t.tagTime});for(var O=0;O<T.length;++O){for(var S=!1,R=!1,_=!1,H="",y="",A=0;A<m.length;++A){var I=m[A];if(O>=I.tagTime&&O<=I.tagTime+I.tagSpan-1){R=O==I.tagTime,_=O==I.tagTime+I.tagSpan-1,S=!0,I.tagTypeString&&(H=I.tagTypeString,"negative"==I.tagTypeString&&(y="onClick=\"showTagToolTip(event, '"+I.tagString+"', '"+I.tagTypeString+"')\"")),R&&(++f,I.replaced&&(H+=" replaced"));break}}O>0&&(v+=" "),R&&(v+='<span class="thoughtWord thoughtHighlight start end '+H+'" '+y+">"),v+=T[O],_&&(v+="</span>")}t.thoughtHTML=e.trustAsHtml(v),t.getToughtTitle=function(){return t.thought.title},t.removePopover=function(){t.popover&&(t.popover.remove(),t.popover=void 0)},window.showTagToolTip=function(e,i,n){var r=$.event.fix(e),a=i?i.split(","):[],c=o(s,a,n),u='<ion-popover-view class="platform-ios"><ion-header-bar> <h1 class="title">'+c+"</h1> </ion-header-bar></ion-popover-view>";t.removePopover(),t.popover=h.fromTemplate(u,{scope:t}),t.popover.show(r)},t.$on("$destroy",function(){t.removePopover(),window.showTagToolTip=void 0})}]),u.controller("RethinkCtrl",["$scope","$state","$translate","$ionicPopup","AccountService",function(e,t,o,i,n){e.goToRecord=function(){n.getUserPreference("completed_rethink_intro_record")?t.go("app.rethink-record"):t.go("app.rethink-record-help",{intro:!0})},e.recordingInfo=function(){i.alert({title:"",template:"<div>"+o.instant("THOUGHTS_RECORD_PRIVATE_PLACE_PROMPT")+"</div>",okText:o.instant("OK_GOT_IT"),okType:"button-default"})}}]),u.controller("RethinkHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,r,a){n("HelpCtrl",{$scope:e}),e.confirm=function(){a.setUserPreference("completed_rethink_intro","true"),e.intro?(r.currentView(r.backView()),o.go("app.thoughts-list",{},{location:"replace"})):r.goBack()}}]),u.controller("TextThoughtsRecordHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,r,a){n("HelpCtrl",{$scope:e}),e.confirm=function(){a.setUserPreference("completed_text_thoughts_intro_record","true"),r.currentView(r.backView()),o.go("app.textthoughts-record",{},{location:"replace"})}}]),u.controller("TextThoughtsAnalyzeHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,r,a){n("HelpCtrl",{$scope:e}),e.confirm=function(){a.setUserPreference("completed_text_thoughts_intro_analyze","true"),r.currentView(r.backView()),o.go("app.textthoughts-analyze",{},{location:"replace"})}}]),u.controller("TextThoughtsRethinkHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,r,a){n("HelpCtrl",{$scope:e}),e.confirm=function(){a.setUserPreference("completed_text_thoughts_intro_rethink","true"),r.currentView(r.backView()),o.go("app.textthoughts-rethink",{thoughtId:i.thoughtId},{location:"replace"})}}]),u.controller("RethinkRecordHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,r,a){n("HelpCtrl",{$scope:e}),e.confirm=function(){a.setUserPreference("completed_rethink_intro_record","true"),r.currentView(r.backView()),o.go("app.rethink-record",{},{location:"replace"})}}]),u.controller("RethinkReplayHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService",function(e,t,o,i,n,r,a){n("HelpCtrl",{$scope:e}),e.confirm=function(){a.setUserPreference("completed_rethink_intro_replay","true"),r.currentView(r.backView()),o.go("app.rethink-replay",{duration:+i.duration},{location:"replace"})}}]),u.controller("RethinkAnalyzeHelpCtrl",["$scope","$rootScope","$state","$stateParams","$controller","$ionicHistory","AccountService","AudioService",function(e,t,o,i,n,r,a,c){n("HelpCtrl",{$scope:e}),e.confirm=function(){a.setUserPreference("completed_rethink_intro_analyze","true"),r.currentView(r.backView());var e=c.getActiveThoughtId();o.go("app.rethink-analyze",{thoughtId:e},{location:"replace"})}}]),u.controller("ThoughtsListCtrl",["$rootScope","$scope","$http","$state","$stateParams","$controller","$timeout","$analytics","$translate","$ionicPopup","$ionicGesture","$ionicScrollDelegate","$ionicActionSheet","AccountService","AudioService","SkillsService","GeneralService","Environment",function(e,t,i,n,r,a,c,s,u,l,g,h,p,d,T,v,f,m){function O(){t.thoughts.sort(function(e,t){var o=new Date(e.createdAtString),i=new Date(t.createdAtString);return i-o})}function S(){T.clearNonPersistedThoughts(),t.thoughts=T.getThoughts().slice(0),t.thoughtCount=T.getThoughtCount(),O(),h.resize()}function R(){H&&(angular.element(H).addClass("hideRemove"),H=void 0)}function _(e,t,o){return e.recordings&&e.recordings[t]?e.recordings[t][o]:void 0}t.showHelp=function(){p.show({buttons:[{text:'<i class="icon ion-ios-help-outline"></i> '+u.instant("WHAT_IS_THOUGHTS")},{text:'<i class="icon ion-ios-play-outline"></i> '+u.instant("WATCH_MILO_HAS_DOUBTS")},{text:'<i class="icon ion-ios-list-outline"></i> '+u.instant("VIEW_COMMON_QUESTIONS")}],cancelText:u.instant("CANCEL"),cancel:function(){},buttonClicked:function(t){return 0===t?e.$broadcast("event:viewVideo",{video:d.THOUGHTS_VIDEO}):1===t?d.viewVideo(d.THOUGHTS_VIDEO):2==t&&window.open("http://help.thinkpacifica.com/hc/en-us/sections/200763778-Thoughts","_blank","location=no"),!0}})},t.goToGratitudeCommunity=function(){if(m.isOnline()){var e=m.isDevelopment()?9:4;n.go("app.communities-posts",{groupId:e,order:"hotness"}),s.eventTrack("goToGratitudeCommunity",{category:"thoughts"})}else{l.alert({template:u.instant("GROUPS_OFFLINE_ERROR"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}},t.thoughts=[],S(),e.$on("event:userContextInitialized",S),t.getThoughtsLevel=function(){return v.getSkillLevel("thoughts")},t.goToSkills=function(){window.openURL("/progress/mood?tab=skills")},t.hasMoreThoughts=function(){return t.thoughts.length<t.thoughtCount},t.loadMoreThoughts=function(){return m.isOnline()?(t.loadingMoreThoughts=!0,void T.loadMoreThoughts(t.thoughts.length,10).success(function(){S(),h.resize(),t.loadingMoreThoughts=!1}).error(function(e){t.loadingMoreThoughts=!1})):void l.alert({title:"Warning",template:u.instant("THOUGHTS_OFFLINE_LOAD_MORE_PROMPT"),okText:"OK, GOT IT.",okType:"button-default"})},t.showingDetails={};var H;t.elementDragged=function(e){for(var o in t.showingDetails)delete t.showingDetails[o];if("dragleft"==e.type){R();{angular.element(e.currentTarget).scope()}H=e.currentTarget,angular.element(e.currentTarget).removeClass("hideRemove")}else angular.element(e.currentTarget).addClass("hideRemove"),H=void 0},t.getThoughtDay=function(e){var t=new Date(e.createdAtString);return f.getDateDisplay(t)},t.getThoughtTime=function(e){var t=new Date(e.createdAtString);return f.getMinuteDisplay(t)},t.getMarks=function(e,t){var o=0,i=e.recordings,n=i.thought;if(n&&n.tags)for(var r=0;r<n.tags.length;++r){var a=n.tags[r];t&&"positive"==a.tagTypeString?++o:t||"negative"!=a.tagTypeString||++o}return o},t.getRecordingSource=function(e,t){return _(e,t,"url")},t.getRecordingDuration=function(e,t){return _(e,t,"duration")},t.getRecordingTags=function(e,t){return _(e,t,"tags")},t.getRecordingTagLabel=function(e){var t=e.tagString?e.tagString.split(","):[];return o(u,t,e.tagTypeString)},t.getRecordingTagTimeDisplay=function(e){var t=e.tagTime;0>t&&(t=0);var o=Math.floor(t/60),i=Math.floor(t-60*o);return(10>o?"0"+o:o)+":"+(10>i?"0"+i:i)},t.showDetails=function(e){if("AUDIO_DISTORTIONS"==e.thoughtType||"AUDIO_JOURNAL"==e.thoughtType){"AUDIO_DISTORTIONS"==e.thoughtType?s.eventTrack("toggleThoughtDetails",{category:"thoughts"}):s.eventTrack("toggleJournalDetails",{category:"thoughts"}),R();var o,i=!1;for(var r in t.showingDetails)r==e.id?i=!0:o=r;i||(o&&delete t.showingDetails[o],t.showingDetails[e.id]=!0),h.resize()}else"TEXT_DISTORTIONS"==e.thoughtType?(s.eventTrack("showTextThoughtDetails",{category:"thoughts"}),n.go("app.textthoughts-review",{thoughtId:e.id})):"TEXT_JOURNAL"==e.thoughtType&&(s.eventTrack("showTextJournalDetails",{category:"thoughts"}),n.go("app.textthoughts-journalreview",{thoughtId:e.id}))},t.isShowingDetails=function(e){return t.showingDetails[e.id]},t.renameThought=function(e){event.stopPropagation(),event.preventDefault(),t.renamePopupData={title:e.title},l.show({template:u.instant("THOUGHTS_RENAME_THOUGHT_PROMPT")+':<br><input type="text" ng-model="renamePopupData.title" autofocus><br>',scope:t,buttons:[{text:u.instant("CANCEL")},{text:u.instant("SAVE"),type:"button-default",onTap:function(){e.title=t.renamePopupData.title,T.updateThoughtTitle(e.id,e.title)}}]}),event.preventDefault(),event.stopPropagation()},t.archiveThought=function(e){function t(){if(m.isOnline())T.archiveThought(e.id).success(function(){S()});else{l.alert({template:u.instant("THOUGHTS_REMOVE_OFFLINE_PROMPT"),okText:u.instant("OK_GOT_IT"),okType:"button-default"})}}event.stopPropagation(),event.preventDefault();var o=l.confirm({template:'<div class="thisisatest">'+u.instant("THOUGHTS_REMOVE_PROMPT")+"</div>",cancelText:u.instant("CANCEL"),cancelType:"button-default",okText:u.instant("REMOVE"),okType:"button-default"});o.then(function(e){e&&t()})}}]);var g={};u.controller("RethinkRecordCtrl",["$sce","$scope","$rootScope","$controller","$state","$stateParams","$http","$timeout","$location","$analytics","$translate","$ionicHistory","$ionicModal","$ionicPopup","$ionicNavBarDelegate","AccountService","AudioService","GeneralService","HabitsService","Environment",function(e,o,u,h,p,d,T,v,f,m,O,S,R,_,H,y,$,A,I,w){if(window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.keepAwake(),t(_,S,p,O),o.mediaRec=void 0,o.recording=!1,o.elapsedTime=0,o.src=void 0,o.maxTime=d.maxTime,o.maxTime||(o.maxTime=300),o.audioPrefix=p.current.data.audioPrefix,o.nextState=p.current.data.nextState,o.helpState=p.current.data.helpState,o.clearRethinkState=p.current.data.clearRethinkState,!w.isOnline()&&"thoughts"==o.audioPrefix){_.alert({title:"Warning",template:O.instant("THOUGHTS_OFFLINE_PROMPT"),okText:"OK, GOT IT.",okType:"button-default"})}var E=$.getActiveThoughtId();E&&(o.thoughtId=E),o.getThoughtsRecordHeader=function(){return O.instant("THOUGHTS_RECORD_HEADER")
},o.initializeSource=function(e){if(e&&g[e])o.src=e,n(w,o.src,o),o.elapsedTime>0&&(o.finishedRecording=!0);else{r();var t=w.isAndroid()?".amr":".m4a";o.src=o.audioPrefix+ ++l+t,o.finishedRecording=!1,n(w,o.src,o)}$.setActiveSource(o.audioPrefix,o.src)},o.initializeSource($.getActiveSource(o.audioPrefix)),a(_,H,S,O,O.instant("THOUGHTS_GO_BACK_PROMPT"),function(){r()},function(){o.stopRecording()},"record"),o.clearRethinkState&&s(),o.resetRecording=function(){m.eventTrack("resetRecordingPopup",{category:"thoughts"});var e=_.confirm({template:'<div class="thisisatest">'+O.instant("THOUGHTS_RESET_PROMPT")+"</div>",cancelText:O.instant("CANCEL"),cancelType:"button-default",okText:O.instant("RESET"),okType:"button-default"});e.then(function(e){e?(o.initializeSource(void 0,!0),o.recording=!1,o.elapsedTime=0,m.eventTrack("resetThought",{category:"thoughts",label:o.audioPrefix}),m.eventTrack("resetRecordingConfirm",{category:"thoughts"})):m.eventTrack("resetRecordingCancel",{category:"thoughts"})})},o.$on("$ionicView.beforeLeave",function(){c("record"),window.plugins&&window.plugins.insomnia&&window.plugins.insomnia.allowSleepAgain()}),o.$on("$destroy",function(){}),o.stopRecording=function(){o.mediaRec.pauseRecord(),o.recording=!1,o.finishedRecording=!0},o.recordAudio=function(){o.canRecord()&&(o.finishedRecording?(o.finishedRecording=!1,o.mediaRec.resumeRecord(),m.eventTrack("resumeRecordThought",{category:"thoughts",label:o.audioPrefix})):(o.mediaRec.startRecord(),m.eventTrack("recordThought",{category:"thoughts",label:o.audioPrefix})),o.recording=!0,v(o.updateTime,1e3))},o.showRecordHelp=function(){o.recording=!1,o.mediaRec&&o.mediaRec.pauseRecord(),p.go(o.helpState)},o.clearCache=function(){r()},o.closeCompletedRethinkModal=function(){y.setUserPreference("completed_rethink","true"),closeModal(o.completedRethinkModal),o.completedRethinkModal.remove(),o.completedRethinkModal=void 0,p.go(o.nextState,{src:o.src,duration:o.elapsedTime})},o.nextStep=function(){o.mediaRec.stopRecord(),r();var e=!0;if("rethink"==o.audioPrefix&&(s(),y.recordActivity("COMPLETED_RETHINK"),y.setUserPreference("completed_rethink",!0),o.thoughtId&&i(o.src,function(e){$.addRecording(e.toURL(),o.src,"analysis",o.elapsedTime,o.thoughtId),$.postThought(o.thoughtId,"AUDIO_DISTORTIONS")})),p.current.data.nextHelpStatePreference){var t=y.getUserPreference(p.current.data.nextHelpStatePreference);t||(e=!1,p.go(p.current.data.nextHelpState,{src:o.src,duration:o.elapsedTime,intro:!0}))}e&&p.go(o.nextState,{src:o.src,duration:o.elapsedTime})},o.getElapsedTime=function(){return A.getTimeDisplay(o.elapsedTime)},o.canRecord=function(){return o.elapsedTime<o.maxTime},o.updateTime=function(){o.recording&&(o.elapsedTime+=1,o.mediaRec.__elapsedTime=o.elapsedTime,o.elapsedTime>=o.maxTime?o.stopRecording():v(o.updateTime,1e3))}}]),u.controller("JournalRecordCtrl",["$scope","$rootScope","$state","$stateParams","$http","$controller","$timeout","$translate","$ionicModal","AccountService","AudioService","HabitsService",function(e,t,o,n,r,a,c,s,u,l,g){a("RethinkRecordCtrl",{$scope:e}),e.getJournalHeader=function(){return s.instant("gratitude"==n.journalType?"JOURNAL_GRATITUDE_HEADER":"positivity"==n.journalType?"JOURNAL_POSITIVITY_AUDIO_HEADER":"JOURNAL_RECORD_HEADER")},e.getJournalTitle=function(){return s.instant("gratitude"==n.journalType?"THOUGHTS_ACTIVITY_GRATITUDE":"positivity"==n.journalType?"THOUGHTS_ACTIVITY_POSITIVITY":"ADD_JOURNAL")},e.nextStep=function(){e.mediaRec.stopRecord(),e.clearCache();l.getUserPreference(o.current.data.nextHelpStatePreference);e.thought=g.createThought("AUDIO_JOURNAL"),i(e.src,function(t){g.addRecording(t.toURL(),e.src,"journal",e.elapsedTime,e.thought.id),g.postThought(e.thought.id,"AUDIO_JOURNAL"),l.recordActivity("COMPLETED_JOURNAL"),o.go("app.home")})}}]),u.controller("RethinkReplayCtrl",["$scope","$state","$sce","$http","$timeout","$location","$stateParams","$analytics","$translate","$ionicModal","$ionicPopup","$ionicHistory","$ionicLoading","$ionicNavBarDelegate","Environment","AudioService","GeneralService","AccountService",function(e,t,o,s,u,l,g,h,p,d,T,v,f,m,O,S,R,_){function H(t,o){var i=angular.element(document.querySelector("#waveform"))[0].offsetWidth,n=e.wavesurfer.getDuration()/i;return e.wavesurfer.addRegion({color:t,start:o-2*n,end:o+2.9*n})}function y(){for(var t=0;t<e.state.marks.length;++t){var o=e.state.marks[t],i="#d04b51";o.positive&&(i="#60d293"),H(i,e.state.marks[t].tagTime)}}function $(){var t,o=e.currentTime;if(o>0)for(var i=e.wavesurfer.getDuration(),n=angular.element(document.querySelector("#waveform"))[0].offsetWidth,r=i/n,a=10*r,c=Number.MAX_VALUE,s=0;s<e.state.marks.length;++s){var u=e.state.marks[s],l=Math.abs(u.tagTime-o);!u.positive&&a>l&&c>l&&(t=u,c=l)}return t}function A(){!e.nativeSrc&&5>E?(++E,u(A,1e3)):e.loadAudio(e.nativeSrc)}function I(t){i(e.src,function(o){S.addRecording(o.toURL(),e.src,"thought",t,e.thought.id)})}e.src=S.getActiveSource("thoughts"),e.status=0,e.getTitleHTML=function(){return o.trustAsHtml(p.instant("THOUGHTS_REPLAY_INSTRUCTIONS"))},n(O,e.src,e,function(t){e.status=t,t==Media.MEDIA_RUNNING?e.playing=!0:(e.playing=!1,t==Media.MEDIA_STOPPED&&(e.state.finishedPlaying=!0)),e.$$phase||e.$apply()}),e.wavesurfer=void 0,e.playing=!1,e.loadedData=!1,e.showingHelp=[],e.showError=!1,e.status=void 0,e.currentTime=0,e.duration=g.duration,e.playSeek=!1,e.loading=!0,e.negativeThoughts=[],e.updatingMark=void 0,e.performReset=function(){e.state={finishedPlaying:!1,marks:[],position:0},e.wavesurfer&&e.wavesurfer.clearRegions()},e.resetReplay=function(){h.eventTrack("resetReplayPopup",{category:"thoughts"});var t=T.confirm({template:'<div class="thisisatest">'+p.instant("THOUGHTS_RESET_PROMPT")+"</div>",cancelText:p.instant("CANCEL"),cancelType:"button-default",okText:p.instant("RESET"),okType:"button-default"});t.then(function(t){t?(e.performReset(),h.eventTrack("resetReplayConfirm",{category:"thoughts"})):h.eventTrack("resetReplayCancel",{category:"thoughts"})})},e.performReset();var w=localStorage.getItem("rethinkReplayState");w&&(e.state=JSON.parse(w)),e.waveform=void 0,e.freqData=void 0,e.waveformData=void 0,d.fromTemplateUrl("views/thoughts/rethink.emotions.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.openEmotionModal=function(){e.playing&&e.playPause(),e.negativeThoughts.length=0,e.showingHelp.length=0,e.setNegativeThought("notsure"),openModal(e.modal)},e.openModalWithMark=function(t){e.playing&&e.playPause(),e.updatingMark=t,e.negativeThoughts=t.tags,e.showingHelp.length=0,openModal(e.modal)},e.closeEmotionModal=function(){closeModal(e.modal)},a(T,m,v,p,p.instant("THOUGHTS_GO_BACK_PROMPT"),function(){r()},void 0,"replay"),e.$on("$ionicView.beforeLeave",function(){c("replay")}),e.$on("$destroy",function(){e.playing&&e.playPause(),r(),e.modal.remove(),e.wavesurfer&&(e.wavesurfer.unAll(),e.wavesurfer=void 0,window.wavesurfer=void 0)}),e.$on("modal.hidden",function(){}),e.$on("modal.removed",function(){}),e.assignThoughts=function(t){if(e.updatingMark)e.updatingMark.tags=e.negativeThoughts.slice(0);else{var o="#d04b51";t&&(o="#60d293");var i=H(o,e.currentTime),n={tagTime:i.start,tags:e.negativeThoughts.slice(0),positive:t?t:!1};n.tagTime<0&&(n.tagTime=0),h.eventTrack("tagRecording",{category:"thoughts",label:t?"positive":n.tags.toString()}),e.state.marks.push(n)}e.updatingMark=void 0,e.negativeThoughts.length=0,e.closeEmotionModal()},e.setNegativeThought=function(t){if("notsure"!=t&&e.isSelected("notsure")){var o=e.negativeThoughts.indexOf("notsure");o>=0&&e.negativeThoughts.splice(o,1)}else"notsure"==t&&(e.negativeThoughts.length=0);if(e.isSelected(t)){var i=e.negativeThoughts.indexOf(t);e.negativeThoughts.splice(i,1)}else e.negativeThoughts.push(t)},e.showReplayHelp=function(t){if(e.isShowingHelp(t)){var o=e.showingHelp.indexOf(t);e.showingHelp.splice(o,1)}else e.showingHelp.push(t);event.stopPropagation(),event.preventDefault()},e.isSelected=function(t){return e.negativeThoughts.indexOf(t)>=0},e.isShowingHelp=function(t){return e.showingHelp.indexOf(t)>=0},e.setPosition=function(t){var o=t.pageX-t.target.offsetLeft,i=o/t.target.offsetWidth;e.wavesurfer&&(e.wavesurfer.seekTo(i),e.mediaRec.seekTo(i*e.mediaRec.getDuration()*1e3))},e.monitorPlay=function(){e.mediaRec.getCurrentPosition(function(t){var o=e.mediaRec.getDuration();0>t&&(t=0),(0!==t||e.status!=Media.MEDIA_PAUSED)&&(e.currentTime=t,e.playSeek=!0,e.wavesurfer&&e.wavesurfer.seekTo(t/o),e.playing&&u(e.monitorPlay,5))})},e.playPause=function(){e.playing?(e.mediaRec.pause(),h.eventTrack("pausePlayback",{category:"thoughts"})):(e.mediaRec.play(),e.monitorPlay(),h.eventTrack("startPlayback",{category:"thoughts"})),e.playing=!e.playing,e.playing&&e.monitorPlay()},e.markAudio=function(){var t=$();t?e.openModalWithMark(t):e.openEmotionModal()},e.getAudioTime=function(){return e.loading?p.instant("LOADING")+"...":e.loadedData?R.getTimeDisplay(e.currentTime):"00:00"},e.getMarkCount=function(t){for(var o=0,i=0;i<e.state.marks.length;++i){var n=e.state.marks[i];t&&n.positive?++o:t||n.positive||++o}return o},e.loadAudio=function(o){var i=o,n=new XMLHttpRequest;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){function o(){var t=e.wavesurfer.getDuration();if(t>0){e.loadedData=!0,e.wavesurfer.seekTo(e.state.position/e.wavesurfer.getDuration()),e.mediaRec.seekTo(1e3*e.state.position),y();var i=Object.create(WaveSurfer.Timeline);i.init({wavesurfer:e.wavesurfer,container:"#waveform-timeline",fontFamily:'"Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;',primaryColor:"#ccc",secondaryColor:"#ccc",primaryFontColor:"#ccc",secondaryFontColor:"#ccc",height:10,duration:e.wavesurfer.getDuration()}),e.thought||(e.thought=S.createThought(),S.setActiveThoughtId(e.thought.id)),I(t),e.loading=!1,e.$$phase||e.$apply()}else O.isAndroid()&&(e.mediaRec.play(),e.mediaRec.pause()),5>r&&(u(o,5),++r)}e.wavesurfer=Object.create(WaveSurfer),window.wavesurfer=e.wavesurfer;var i={container:document.querySelector("#waveform"),waveColor:"#ccc",progressColor:"#fff",normalize:!0};e.wavesurfer.init(i),e.wavesurfer.on("seek",function(t){if(e.loadedData){if(e.playSeek)return void(e.playSeek=!1);if(e.currentTime=t*e.mediaRec.getDuration(),e.mediaRec&&e.mediaRec.seekTo(t*e.mediaRec.getDuration()*1e3),0!==t){var o=$();o&&e.openModalWithMark(o)}}});var r=0;e.wavesurfer.on("ready",function(){o()}),e.wavesurfer.on("progress",function(){e.$$phase||e.$apply()}),e.showHelp=function(){e.playing&&e.playPause(),e.state.position=e.currentTime,localStorage.setItem("rethinkReplayState",JSON.stringify(e.state)),t.go("app.rethink-replay-help")},e.nextStep=function(){e.state.position=e.currentTime,localStorage.setItem("rethinkReplayState",JSON.stringify(e.state)),e.thought&&S.addTags(e.thought,e.state.marks);var o=_.getUserPreference("completed_rethink_intro_analyze");o?t.go("app.rethink-analyze",{thoughtId:e.thought.id}):t.go("app.rethink-analyze-help",{thoughtId:e.thought.id,intro:!0})},window.webkitAudioContext||window.AudioContext?e.wavesurfer.loadArrayBuffer(n.response):T.alert({title:"",template:"<div>"+p.instant("THOUGHTS_PHONE_RENDERING_PROMPT")+"</div>",okText:p.instant("OK_GOT_IT"),okType:"button-default"})},n.send()};var E=0;u(A,1)}])}();