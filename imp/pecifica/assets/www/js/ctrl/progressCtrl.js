!function(){var t=angular.module("progressCtrl",[]),a=864e5;t.controller("ProgressMoodCtrl",["$scope","$stateParams","$controller","$http","$ionicLoading","$ionicModal","$ionicScrollDelegate","$ionicPopup","$ionicGesture","$ionicSideMenuDelegate","$analytics","$timeout","$translate","HabitsService","AccountService","GoalsService","SkillsService","GeneralService","Environment",function(t,e,i,o,n,r,s,c,l,v,d,u,g,h,D,f,y,p,S){function m(t,a){return a.getTime()-60*a.getTimezoneOffset()*1e3-t.getTime()+60*t.getTimezoneOffset()*1e3}function b(){for(var t in J)l.off(J[t],"dragleft",x);for(var a in Q)l.off(Q[a],"dragright",x);J.length=0,Q.length=0}function x(t){if("dragleft"==t.type){Z&&angular.element(Z).addClass("hideRemove");{angular.element(t.target).scope()}Z=t.target,angular.element(t.target).removeClass("hideRemove")}else angular.element(t.target).addClass("hideRemove"),Z=void 0}function M(){b();for(var t=document.getElementsByClassName("dragContainer"),a=0;a<t.length;++a){var e=t[a],i=l.on("dragright",x,angular.element(e)),o=l.on("dragleft",x,angular.element(e));Q.push(i),J.push(o)}}function H(a){if(a){var e=t.$new();e.experiencedDate=a,i("HabitsMoodCtrl",{$scope:e}),r.fromTemplateUrl("views/habits/habits.mood.popup.html",{scope:e,animation:"none"}).then(function(a){t.moodModal=a,openModal(t.moodModal),u(A)})}}function L(){}function A(){var t=$("#moodNote").offset();t&&$("#moodNote").css("min-height",ta-t.top)}function T(){if(t.accountHabits&&t.activeHealthDataIndex<t.accountHabits.length){var a=t.accountHabits[t.activeHealthDataIndex];return a}}function I(a){var e=new Date(t.startMS);return e.setDate(e.getDate()+a),e}function w(t){return t.getMonth()+1+"/"+t.getDate()}function P(){var a=window.innerWidth;t.sectionWidth=a/t.sections,na<t.sections?(t.totalDays=Math.floor(na)+1,t.activeDay=Math.floor(na),t.startDate=F,t.startMS=F.getTime(),t.canLoadPreviousData=!1):na>30?(t.totalDays=31,t.activeDay=t.sections-1,t.startDate=q,t.startMS=q.getTime()):(t.totalDays=Math.ceil(na)+1,t.activeDay=t.sections-1,t.startDate=F,t.startMS=F.getTime(),t.canLoadPreviousData=!1),t.totalHeight=150,t.totalWidth=t.sectionWidth*t.totalDays,t.ctx.canvas.width=window.innerWidth*t.canvasScale,t.ctx.canvas.height=t.totalHeight*t.canvasScale,t.maxLocation=t.currentLocation=(t.totalDays-t.sections)*t.sectionWidth,t.currentLocation<0&&(t.currentLocation=0),t.scale=t.totalDays<t.sections?1:t.totalDays/t.sections,N()}function R(){var a=window.innerWidth,e=200;window.innerWidth>=768&&(e=400);var i=document.getElementById("skillsDisplay"),o=i.getContext("2d");o.canvas.width=a*t.canvasScale,o.canvas.height=e*t.canvasScale,$("#skillsDisplay").width(a),$("#skillsDisplay").height(e);var n=o.canvas.width,r=o.canvas.height;o.clearRect(0,0,n,r),o.scale(t.canvasScale,t.canvasScale),o.translate(a/2,e/2);for(var s=Math.min(a,e)/2*.8,c=1;7>=c;++c){var l=s*(c/7);o.beginPath(),o.arc(0,0,l,0,2*Math.PI),o.lineWidth=1,o.strokeStyle="rgba(255,255,255, 0.3)",o.stroke()}for(var v=0;5>v;++v){var d=-Math.PI/2+v/5*2*Math.PI,u=Math.cos(d)*s,g=Math.sin(d)*s;o.beginPath(),o.moveTo(0,0),o.lineTo(u,g),o.stroke()}for(var h=0;5>h;++h){var D,f=0,y=-Math.PI/2+h/5*2*Math.PI,p=y+2*Math.PI/5;0===h?(f=sa.relaxLevel,D="#5fe9c4"):1==h?(f=sa.thoughtsLevel,D="#58caf6"):2==h?(f=sa.goalsLevel,D="#ff9b73"):3==h?(f=sa.habitsLevel,D="#ff6669"):4==h&&(f=sa.socialLevel,D="#ffbe66");var S=s*f/7;o.beginPath(),o.arc(0,0,S,y,p),o.lineTo(0,0),o.fillStyle=D,o.fill(),o.closePath()}}function O(a,e,i){var o=30,n=30,r=1.35*Math.PI,s=1.65*Math.PI;t.ctx.beginPath(),t.ctx.arc(a,e+o,n,r,s),t.ctx.lineWidth=3,t.ctx.strokeStyle=i,t.ctx.stroke()}function _(a,e,i){var o=-25,n=30,r=.35*Math.PI,s=.65*Math.PI;t.ctx.beginPath(),t.ctx.arc(a,e+o,n,r,s),t.ctx.lineWidth=3,t.ctx.strokeStyle=i,t.ctx.stroke()}function E(a,e,i){var o=13,n=3;t.ctx.beginPath(),t.ctx.moveTo(a-o,e+n),t.ctx.lineTo(a+o,e+n),t.ctx.strokeStyle=i,t.ctx.stroke()}function C(a,e,i){var o=8,n=-10,r=3;t.ctx.save(),t.ctx.translate(a,e),t.ctx.beginPath(),t.ctx.arc(o,n,r,0,2*Math.PI,!1),t.ctx.restore(),t.ctx.fillStyle=i,t.ctx.fill(),t.ctx.save(),t.ctx.translate(a,e),t.ctx.beginPath(),t.ctx.arc(-o,n,r,0,2*Math.PI,!1),t.ctx.restore(),t.ctx.fillStyle=i,t.ctx.fill()}function N(){if(t.ctx&&t.ctx.canvas){var e=t.ctx.canvas.width,i=t.ctx.canvas.height;t.ctx.clearRect(0,0,e,i),t.ctx.save(),t.ctx.scale(t.canvasScale,t.canvasScale),t.ctx.translate(-t.currentLocation,0);for(var o=-1,n=t.totalDays<t.sections?t.sections:t.totalDays,r=0;n>r;++r){var s=r*t.sectionWidth;if(!(s<t.currentLocation-t.sectionWidth||s>t.currentLocation+8*t.sectionWidth)){var c,l,v=I(r);l=t.scrollLeft?0===t.activeDay?.01:t.sectionWidth-.01:t.activeDay==t.sections-1?.01:t.sectionWidth-.01,(1==t.totalDays||s+l>t.currentLocation)&&0>o?o=0:o>=0&&++o,o==t.activeDay?(c="rgba(0,0,0, 0.3)",t.activeDayDate=v):c=r%2===0?"rgba(0, 0, 0, 0.5)":"rgba(0,0,0, 0.55)",t.ctx.fillStyle=c,t.ctx.fillRect(s,0,t.sectionWidth,t.totalHeight);var d=.15,u=t.sectionWidth*d,D=s+(1-d)/2*t.sectionWidth;if(t.displayingHealthData&&v<new Date){var f=t.getHabitDataForDate(v),y=!1;if(f){var S=T(),b=h.getHabitValueById(S,f.habitValueId);if(b){var x=b.ordinate/S.habitValues.length,M=20+75*x,H=h.metGoal(S,b.ordinate);t.ctx.fillStyle=H?"rgba(92,229,157,0.4)":"rgba(255,102,105,0.4)",t.ctx.fillRect(D,t.totalHeight-M,u,t.totalHeight),y=!0}}if(!y&&t.loaded){var L=10;t.ctx.fillStyle="rgba(255,255,255,0.2)",t.ctx.fillRect(D,t.totalHeight-L,u,t.totalHeight)}}if(t.displayingActivityData&&v<new Date){var A=t.getActivityCountForDate(v);if(A){A>3&&(A=3);var w=A/3,P=20+75*w;t.ctx.fillStyle="rgba(92,229,157,0.4)",t.ctx.fillRect(D,t.totalHeight-P,u,t.totalHeight)}else if(t.loaded){var R=10;t.ctx.fillStyle="rgba(255,255,255,0.2)",t.ctx.fillRect(D,t.totalHeight-R,u,t.totalHeight)}}if(t.viewSimpleProgress&&!t.isUMNUser()){var N=p.getDayString(v),k=t.moodAverages[N];if(k){var U=s+t.sectionWidth/2,V=p.COLORS[p.COLORS.length-k],W=hexToRgb(V),$="rgb("+W.r+","+W.g+","+W.b+")",G=38;C(U,G,$),k>4?_(U,G,$):4==k?E(U,G,$):O(U,G,$)}}var B;if(r==t.totalDays-1)B=g.instant("TODAY_SHORT").toUpperCase();else{if(r>=t.totalDays)continue;var F=I(r);B=moment(F).format("L")}t.ctx.textAlign="center",t.ctx.fillStyle=o==t.activeDay?"rgb(255,255,255)":"rgb(150,150,150)",t.ctx.fillText(B,s+t.sectionWidth/2,15)}}var X,Y,K,q,z=a*t.totalDays,j=0;if(t.viewSimpleProgress){if(t.isUMNUser())for(j=0;2>j;++j)for(var J=0;J<t.stressData.length;++J){var Q=t.stressData[J],Z=new Date(Q.experiencedAtStr),ta=m(t.startDate,Z)/z*t.totalWidth;if(1!==j||!(ta<t.currentLocation||ta>t.currentLocation+8*t.sectionWidth)){var aa=35+(Q.valueInt-1)/4*95;if(0===j)J>0&&(t.ctx.strokeStyle="rgba(255,255,255, 0.4)",t.ctx.beginPath(),t.ctx.moveTo(K,q),t.ctx.lineTo(ta,aa),t.ctx.stroke());else{var ea=p.STRESS_COLORS[Q.valueInt-1],ia=hexToRgb(ea),oa="rgb("+ia.r+","+ia.g+","+ia.b+")";t.ctx.fillStyle=oa,t.ctx.beginPath(),t.ctx.arc(ta,aa,4,0,2*Math.PI),t.ctx.closePath(),t.ctx.fill()}K=ta,q=aa}}}else for(t.ctx.lineWidth=1,j=0;2>j;++j)for(var na=0;na<t.data.length;++na){var ra=t.data[na],sa=new Date(ra.experiencedAtStr),ca=m(t.startDate,sa)/z*t.totalWidth;if(1!==j||!(ca<t.currentLocation||ca>t.currentLocation+8*t.sectionWidth)){var la=t.totalHeight-(20+(ra.valueInt-1)/6*95);if(0===j)na>0&&(t.ctx.strokeStyle="rgba(255,255,255, 0.4)",t.ctx.beginPath(),t.ctx.moveTo(X,Y),t.ctx.lineTo(ca,la),t.ctx.stroke());else{var va=p.COLORS[7-ra.valueInt],da=hexToRgb(va),ua="rgb("+da.r+","+da.g+","+da.b+")";t.ctx.fillStyle=ua,t.ctx.beginPath(),t.ctx.arc(ca,la,4,0,2*Math.PI),t.ctx.closePath(),t.ctx.fill()}X=ca,Y=la}}t.ctx.restore()}}function k(a){var e,i=t.canvas.getBoundingClientRect();a.changedTouches&&(e=a.changedTouches[0].pageX),e||(e="undefined"!=typeof a.pageX?a.pageX:a.clientX);var o;return a.changedTouches&&(o=a.changedTouches[0].pageY),o||(o="undefined"!=typeof a.pageY?a.pageY:a.clientY),{x:e-i.left,y:o-i.top}}function U(a){a.preventDefault(),a.stopPropagation();var e=k(a),i=e.x-j.x;t.currentLocation-=i,t.currentLocation>t.maxLocation&&(t.currentLocation=t.maxLocation),t.currentLocation<0&&(t.currentLocation=0),t.currentLocation<t.sectionWidth&&loadPreviousData(),j&&($scrollLeft=j.x>e.x),j=e,N(),t.$$phase||t.$apply()}function V(e){var i=k(e),o=t.currentLocation+i.x,n=I(Math.floor(o/t.sectionWidth));if(!(n>K)){var r=Math.ceil(m(t.activeDayDate,n)/a);0!==r&&(t.activeDay+=r,t.activeDay<0?t.activeDay=0:t.activeDay>7&&(t.activeDay=7),N()),t.$$phase||t.$apply()}}function W(){t.moodAverages={},t.stressAverages={},t.data.length=0,t.stressData.length=0;var a=h.getAccountHabitValues("Mood").habitValues;for(var e in t.healthData){var i=t.healthData[e],o=i.Mood;if(o){for(var n=0,r=0,s=0;s<o.length;++s)t.data.push(o[s]),r+=o[s].valueInt,++n;n>0&&(r=a.length-Math.round(r/n),r=a[r].valueInt,t.moodAverages[e]=r)}var c=i.Stress;if(c&&t.isUMNUser()){var l=(h.getAccountHabitValues("Stress").habitValues,new Date(c.createdAtStr));if(l>Y)continue;for(var v=0,d=0,u=0;u<c.length;++u)t.stressData.push(c[u]),d+=c[u].valueInt,++v;v>0&&(d=Math.round(d/v)-1,t.stressAverages[e]=d)}}t.data.length>0&&t.data.sort(function(t,a){return a.experiencedAt-t.experiencedAt}),t.stressData.length>0&&t.stressData.sort(function(t,a){return a.experiencedAt-t.experiencedAt})}function G(a,e){return S.isOnline()?(n.show({template:g.instant("LOADING_HISTORY")+"..."}),void D.getActivityHistory(a,e).success(function(a){var e=a.activityHistory;for(var i in e){var o,r=e[i],c=D.getCategoryForActivity(i);"goals"==c?o=2:"relax"==c?o=0:"thoughts"==c&&(o=1);var l=t.activityHistory[o];l||(l=t.activityHistory[o]={});for(var v=0;v<r.length;++v){var d=r[v],g=new Date(d.date),h=p.getDayString(g),f=l[h];f?f.push(d):l[h]=[d]}}if(t.habitSubValues||(t.habitSubValues={}),a.dailyHabitData.habitSubValues)for(var y=0;y<a.dailyHabitData.habitSubValues.length;++y){var S=a.dailyHabitData.habitSubValues[y];t.habitSubValues[S.id]=S}for(var m in a.dailyHabitData.data)t.healthData[m]=a.dailyHabitData.data[m];W(),t.loaded=!0,t.showingHistory?N():R(),n.hide(),u(function(){s.resize(),$("ion-scroll").height(window.innerHeight+4-2*$(".progress-header").outerHeight()-$("canvas").height()-$("ion-nav-bar").outerHeight())},1)}).error(function(){n.hide()})):void c.alert({title:"",template:"<div>"+g.instant("HOME_OFFLINE_PROGRESS_ALERT")+"</div>",okText:g.instant("OK_GOT_IT"),okType:"button-default"})}t.openSideMenu=function(){v.toggleLeft()};p.getTodayString();t.loaded=!1,t.showingHistory=!0,"skills"!=e.tab&&S.isOnline()||(t.showingHistory=!1);var B=D.getAccountUser(),F=new Date(B.user.createdAtStr);F.setHours(0,0,0,0),t.canvas=void 0,t.ctx=void 0,t.canvasScale=window.devicePixelRatio,t.totalDays=30,t.displayingHealthData=!1,t.activeHealthDataIndex=t.isUMNUser()?2:1,t.displayingActivityData=!1,t.activeActivityDataIndex=0,t.isPacificaLiteUser()||(t.potentialActivities=["Relax","Thoughts","Experiments"]);var X=D.getUserPreference("view_simple_progress");t.viewSimpleProgress=X?"true"==X.toLowerCase():t.isUMNUser()?!0:!1,t.getActivityTitle=function(){var a;return a=g.instant(t.isUMNUser()?t.viewSimpleProgress?"STRESS_PROGRESS_TITLE":"MOOD_PROGRESS_TITLE":"HISTORY"),a.toUpperCase()},t.showHistory=function(){t.showingHistory=!0,t.loaded?N():G()},t.showSkills=function(){t.showingHistory=!1,R()},t.closeSkillsHelpModal=function(){t.skillsHelpModal&&(closeModal(t.skillsHelpModal),t.skillsHelpModal.remove(),t.skillsHelpModal=void 0)},t.showSkillsHelp=function(){r.fromTemplateUrl("views/progress/skills.help.html",{scope:t,animation:"none"}).then(function(a){t.skillsHelpModal=a,openModal(t.skillsHelpModal)})},t.accountHabits=h.getAccountHabits(),t.accountHabits&&(t.isUMNUser()?t.accountHabits.length>2:t.accountHabits.length>1)?t.displayingHealthData=!0:t.isPacificaLiteUser()||(t.displayingActivityData=!0);var Y=new Date,K=(Y.getTime(),new Date);K.setHours(0,0,0,0);var q=Y.addDays(-30);q.setHours(0,0,0,0),t.data=[],t.stressData=[],t.moodAverages={},t.stressAverages={},t.healthData={},t.requestedDays=[],t.activityHistory=[],t.sections=7,t.maxLocation=void 0,t.currentLocation=void 0,t.activeDay=void 0,t.activeDayDate=void 0,t.canLoadPreviousData=!0;var z=!1;t.userScroll=!1,t.scrollLeft=!0;var j,J=[],Q=[];t.$on("$destroy",function(){b()});var Z;t.updateMoodNotes=function(){t.updatingMoodNotes=!0,h.updateHabitDataNotes(t.editingMoodRating.id,t.moodNotes.notes).success(function(){t.editingMoodRating.habitDataNotes?t.editingMoodRating.habitDataNotes.notes=t.moodNotes.notes:t.editingMoodRating.habitDataNotes={notes:t.moodNotes.notes},t.closeNotesModal(),t.updatingMoodNotes=!1}).error(function(){c.alert({template:g.instant("UPDATE_NOTES_ERROR"),okText:g.instant("OK_GOT_IT"),okType:"button-default"});t.updatingMoodNotes=!1})},t.getMoodDisplay=function(){var a="MOOD_"+t.editingMoodRating.valueString;return a=a.replace(" ","_"),g.instant(a)},t.updateEditedValue=function(){var a=h.getHabitValueById(t.editingMoodRating.habitValueId);t.editingMoodRating.valueInt=a.valueInt,t.editingMoodRating.valueString=a.valueString,W(),N()},t.showProgressTooltip=function(){if(D.isUMNUser())return!1;var t=D.getUserPreference("viewed_progress_tooltop");return t&&"true"==t?!1:!0},t.hideProgressTooltip=function(){D.setUserPreference("viewed_progress_tooltop",!0)},t.canAddMoodEntry=function(){if(D.isUMNUser())return!1;var a=new Date(K);return a=a.addDays(-6),t.activeDayDate>=a},t.addMoodEntry=function(){var a;p.getDayString(t.activeDayDate)==p.getDayString(K)?a=new Date:(a=new Date(t.activeDayDate),a.setHours(12,0,0,0));var e=new Date(K);e=e.addDays(-6);var i=F>e?F:e,o=new Date;window.datePicker?datePicker.show({date:a,mode:"datetime",minDate:S.isAndroid()?i.getTime():i,maxDate:S.isAndroid()?o.getTime():o,allowOldDates:!1,allowFutureDates:!1},H,L):H(new Date)},t.closeMoodModal=function(){closeModal(t.moodModal),t.moodModal.remove(),t.moodModal=void 0},t.finishEditingMood=function(a){t.moodModal.scope.submitData(a,function(a){if(a)for(var e=0;e<a.length;++e){var i=a[e],o=p.getDayString(new Date(i.experiencedAt)),n=t.healthData[o];n||(n=t.healthData[o]={Mood:[]});var r=n.Mood;r||(r=n.Mood=[]),r.splice(0,0,i),r.sort(function(t,a){return a.experiencedAt-t.experiencedAt})}aa=void 0,W(),N(),t.closeMoodModal()},function(){c.alert({template:"<div>"+g.instant("MOOD_ENTRY_ERROR")+"</div>",okText:g.instant("OK_GOT_IT"),okType:"button-default"})})};var ta=window.innerHeight;t.canDeleteItem=function(t){return!!t.data.habitValueId},t.canEditItem=function(t){if("mood"!=t.actionClass)return!1;var a=new Date(t.data.experiencedAtStr),e=(new Date).addDays(-6);return e.setHours(0,0,0,0),a>=e},t.editItemNotes=function(a){if(event.stopPropagation(),event.preventDefault(),"mood"==a.actionClass){t.editingMoodRating=a.data,t.moodNotes={notes:a.data.habitDataNotes?a.data.habitDataNotes.notes:void 0};var e=t.$new();e.habitDataToEdit=a.data,i("HabitsMoodCtrl",{$scope:e}),r.fromTemplateUrl("views/habits/habits.mood.popup.html",{scope:e,animation:"none"}).then(function(a){t.moodModal=a,openModal(t.moodModal),u(A)})}},t.deleteItem=function(a){event.stopPropagation(),event.preventDefault();var e="<div>"+g.instant("DELETE_HABIT_RATING_PROMPT")+"</div>",i=c.confirm({template:e,cancelText:g.instant("CANCEL"),cancelType:"button-default",okText:g.instant("DELETE"),okType:"button-default"});i.then(function(e){e&&h.deleteHabitData(a.data).success(function(){for(var e in t.healthData){var i=t.healthData[e];for(var o in i)for(var n=i[o],r=0;r<n.length;++r){var s=n[r];if(s.id==a.data.id){n.splice(r,1);break}}}W(),N()}).error(function(){})})},t.toggleSimpleMode=function(){t.viewSimpleProgress=!t.viewSimpleProgress,D.setUserPreference("view_simple_progress",""+t.viewSimpleProgress),N()},t.isSimpleMode=function(){return t.viewSimpleProgress},t.getMoodColor=function(a){var e=h.getHabitValueById(a.habitValueId);if(e){if(e.habitId==h.MOOD_HABIT_ID)return!a&&t.editingMoodRating&&(a=t.editingMoodRating),p.COLOR_NAMES[7-a.valueInt];if(e.habitId==h.STRESS_HABIT_ID)return p.STRESS_COLOR_NAMES[a.valueInt-1]}},t.getHabitSubValue=function(a){return h.getHabitSubValue(t.habitSubValues,a)},t.getHabitNameFromHabitRating=function(t){var a=h.getHabitValueById(t.habitValueId),e=h.getAccountHabitById(a.habitId);return h.getHabitName(e)},t.getHabitRatingDisplay=function(t){return h.getHabitDisplayFromData(t)},t.getMoodRatingDisplay=function(t){var a=t.valueString,e="HABITS_VALUES_"+a;return e=e.replace(/ /g,"_").toUpperCase(),g.instant(e)},t.getHabitRatingDateDisplay=function(t){var a=new Date(t.experiencedAtStr);return moment(a).calendar()},t.isDisplayingMood=function(){return t.isUMNUser()?!t.viewSimpleProgress:!0},t.getActionTitle=function(t){var a=t.actionTitle;return a},t.getActionSubTitle=function(a){var e="";if(t.canDeleteItem(a)&&"mood"!=a.actionClass&&"stress"!=a.actionClass){var i=a.data,o=h.getHabitValueById(i.habitValueId);e+=" ("+h.getHabitDisplayFromValue(o)+")"}return e},t.getSubClass=function(t){return t.skillSubClass?t.skillSubClass:""},t.getActionClass=function(t){return t.actionClass},t.getActionTimeDisplay=function(t){return moment(t.actionTimestamp).calendar()};var aa,ea,ia;t.getActiveDaysData=function(){if(t.activeDayDate==ea&&t.viewSimpleProgress==ia)return aa;var a=[];if(t.activeDayDate){var e=p.getDayString(t.activeDayDate),i=[],o=t.healthData[e];if(o)for(var n in o){var r=o[n];r.length>0&&i.push.apply(i,r)}for(var c=[],l=0;l<t.activityHistory.length;++l){var v=t.activityHistory[l];if(v){var d=v[e];d&&d.length>0&&c.push.apply(c,d)}}a=y.createActionsWithData(i,c)}return ea=t.activeDayDate,aa=a,ia=t.viewSimpleProgress,u(M),s.scrollTop(),a},t.isItemActive=function(a){if(!t.activeDayDate||"mood"!=a.actionClass&&"stress"!=a.actionClass)return!1;var e=new Date(a.data.experiencedAtStr);return e.setHours(0,0,0,0),0===m(t.activeDayDate,e)},t.hasNotes=function(t){return t.data.habitDataNotes&&t.data.habitDataNotes.notes&&t.data.habitDataNotes.notes.length>1},t.displayItemNotes=function(a){var e="mood"==a.actionClass||"stress"==a.actionClass||"health"==a.actionClass;if(e){var i=t.$new();i.habitRating=a.data;{c.alert({templateUrl:"views/progress/progress.habits.notes.html",okText:g.instant("OK_GOT_IT"),okType:"button-default",scope:i})}}},t.getTodaysMoodClass=function(){var a;if(t.activeDayDate){var e=t.activeDayDate,i=p.getDayString(e);if(t.isDisplayingMood()){var o=t.moodAverages[i];if(o){var n=h.getAccountHabitValues("Mood").habitValues,r=n.length-Math.round(o);r=n[r].valueInt,a=p.COLOR_NAMES[7-r]}}else{var s=t.stressAverages[i];if("undefined"!=typeof s){var c=h.getAccountHabitValues("Stress").habitValues,l=Math.round(s);l=c[l].valueInt,a=p.STRESS_COLOR_NAMES[l-1]}}}return a?a:""},t.rotateHealthData=function ca(){if(t.displayingHealthData||t.displayingActivityData||!(t.isUMNUser()?t.accountHabits.length>2:t.accountHabits.length>1))if(t.displayingActivityData)++t.activeActivityDataIndex,t.activeActivityDataIndex>=t.potentialActivities.length&&(t.activeActivityDataIndex=0,t.displayingHealthData=!1,t.displayingActivityData=!1);else if(t.displayingHealthData)if(++t.activeHealthDataIndex,t.activeHealthDataIndex>=t.accountHabits.length)t.activeHealthDataIndex=t.isUMNUser()?2:1,t.isPacificaLiteUser()||(t.displayingHealthData=!1,t.displayingActivityData=!0);else{var a=t.accountHabits[t.activeHealthDataIndex];if("Stress"==a.name)return void ca()}else t.isPacificaLiteUser()?c.alert({title:"",template:"<div>"+g.instant("PACIFICA_LITE_MISSING_HEALTH_ERROR")+"</div>",okText:g.instant("OK_GOT_IT"),okType:"button-default"}):t.displayingActivityData=!0;else t.displayingHealthData=!0,t.displayingActivityData=!1,t.activeHealthDataIndex=t.isUMNUser()?2:1;N()},t.getActiveHealthName=function(){if(t.displayingHealthData){var a=T();return a?a.name:void 0}if(t.displayingActivityData){var e=t.potentialActivities[t.activeActivityDataIndex];return e}},t.getActiveHealthType=function(){var a=t.getActiveHealthName();return a?(t.displayingActivityData&&(a+="_ACTIVITY"),a=a.toUpperCase(),g.instant(a)):void 0},t.getHabitDataForDate=function(a){var e=t.getActiveHealthName(),i=p.getDayString(a);if(t.displayingHealthData){var o=t.healthData[i];if(o){var n=o[e];if(n)return n=n[0]}}return void 0},t.getActivityCountForDate=function(a){var e=t.activityHistory[t.activeActivityDataIndex];if(e){var i=e[p.getDayString(a)];if(i)return i.length}return void 0},t.getActiveHealthValue=function(){if(t.activeDayDate){if(t.displayingHealthData){var a=t.getHabitDataForDate(t.activeDayDate);if(a)return h.getHabitDisplayById(T(),a.habitValueId)}else if(t.displayingActivityData){var e=t.getActivityCountForDate(t.activeDayDate);if("undefined"!=typeof e)return g.instant("COMPLETED")+" "+e+"X"}return g.instant("NO_DATA")}},t.isTodayActive=function(){if(!t.activeDayDate)return!0;var e=m(t.activeDayDate,K),i=e/a;return 0===i},t.getTodaysMood=function(){var e,i,o;if(t.activeDayDate){var n=m(t.activeDayDate,K),r=n/a;0>=r?i="TODAY I'M":1==r?i="YESTERDAY I WAS":(e=w(t.activeDayDate),i="I WAS");var s=p.getDayString(t.activeDayDate);if(t.isDisplayingMood()){var c=t.moodAverages[s];if(c){var l=h.getAccountHabitValues("Mood").habitValues;o=l.length-Math.round(c),o=l[o].valueString}else o="?";var v="MOOD_"+i+"_"+o;return v=v.replace(/ /g,"_").replace(/'/g,"").toUpperCase(),(e?e:"")+" "+g.instant(v)}var d=t.stressAverages[s];if("undefined"!=typeof d){var u=h.getAccountHabitValues("Stress").habitValues;return o=Math.round(d),o=u[o].valueString,i+" "+o+" stressed"}return i+" ?"}i="TODAY I'M",o="?"},t.canGoToPreviousDay=function(){return t.currentLocation>0||t.activeDay>0},t.previousDay=function(){t.activeDay>0?--t.activeDay:t.canGoToPreviousDay()&&(t.currentLocation-=t.sectionWidth,t.currentLocation<0&&(t.currentLocation=0)),N(),t.currentLocation<t.sectionWidth&&loadPreviousData()},t.canGoToNextDay=function(){return(t.currentLocation<t.maxLocation||t.activeDay<t.sections-1)&&K.getTime()!=t.activeDayDate.getTime()},t.nextDay=function(){t.canGoToNextDay()&&(t.activeDay<t.sections-1?++t.activeDay:t.currentLocation<t.maxLocation&&(t.currentLocation+=t.sectionWidth,t.currentLocation>t.maxLocation&&(t.currentLocation=t.maxLocation)),N())},u(function(){function a(a){z=!0,t.userScroll=!1,j=k(a)}function e(t){z=!1;var a=k(t);j&&a.x==j.x&&a.y==j.y&&V(t)}$("#moodHistory").width(window.innerWidth),$("#moodHistory").height(150),t.canvas=document.getElementById("moodHistory"),t.ctx=t.canvas.getContext("2d"),t.canvas.addEventListener("mousedown",a),t.canvas.addEventListener("mouseup",e),t.canvas.addEventListener("touchstart",a),t.canvas.addEventListener("touchend",e);t.canvas.addEventListener("mousemove",function(t){z&&U(t)});t.canvas.addEventListener("touchmove",function(t){U(t)},!1),P()});var oa=m(F,K),na=oa/a;window.loadPreviousData=t.loadPreviousData=function(){if(t.canLoadPreviousData){{var a,e,i=(t.maxLocation,t.currentLocation,t.totalDays),o=t.startDate;t.startMS}t.totalDays+30>na?(a=na,e=F,t.canLoadPreviousData=!1):(a=t.totalDays+30,e=t.startDate.addDays(-30));var n=p.getDayString(t.startDate);if(!(t.requestedDays.indexOf(n)>=0)){t.totalDays=a,t.startDate=e,t.startMS=t.startDate.getTime(),t.requestedDays.push(n),t.maxLocation=(t.totalDays-t.sections)*t.sectionWidth;var r=(t.totalDays-i)/t.totalDays;t.currentLocation+=r*t.totalDays*t.sectionWidth,t.totalWidth=t.sectionWidth*t.totalDays,t.scale=t.totalDays/t.sections,N(),G(t.startDate,o)}}};var ra=[1,3,5,10,15,20,30],sa=y.skillContext;t.getSkillLevel=function(t){var a;return"relax"==t?a=sa.relaxLevel:"thoughts"==t?a=sa.thoughtsLevel:"goals"==t?a=sa.goalsLevel:"habits"==t?a=sa.habitsLevel:"social"==t&&(a=sa.socialLevel),a},t.getSkillByline=function(t){var a,e,i;"relax"==t?(a=sa.relaxLevel,e=sa.relaxLevelActions,i="SKILLS_COMPLETE_RELAX"):"thoughts"==t?(a=sa.thoughtsLevel,e=sa.thoughtsLevelActions,i="SKILLS_COMPLETE_THOUGHTS"):"goals"==t?(a=sa.goalsLevel,e=sa.goalsLevelActions,i="SKILLS_COMPLETE_GOALS"):"habits"==t?(a=sa.habitsLevel,e=sa.habitsLevelActions,i="SKILLS_COMPLETE_HABITS"):"social"==t&&(a=sa.socialLevel,e=sa.socialLevelActions,i="SKILLS_COMPLETE_SOCIAL");var o=ra[a];return g.instant(i).replace("XXXREPLACEXXX",o+"X")},t.getSkillPercentage=function(t){var a,e;"relax"==t?(a=sa.relaxLevel,e=sa.relaxLevelActions):"thoughts"==t?(a=sa.thoughtsLevel,e=sa.thoughtsLevelActions):"goals"==t?(a=sa.goalsLevel,e=sa.goalsLevelActions):"habits"==t?(a=sa.habitsLevel,e=sa.habitsLevelActions):"social"==t&&(a=sa.socialLevel,e=sa.socialLevelActions);var i=ra[a],o=100*e/i;return 0===o?2:o},t.showingHistory?G():R()}])}();