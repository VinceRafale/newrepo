function createPromise(){var e={};return e.success=function(t){return e.successCallback=t,e},e.error=function(t){return e.errorCallback=t,e},e}var servicesModule=angular.module("accountService",[]);servicesModule.factory("AccountService",["$http","$rootScope","$translate","$timeout","authHttp","Environment","StorageService","GeneralService","Token",function(e,t,r,i,n,a,o,c,s){function u(e){var t=e?e:{};return window.device&&(t.appVersion=a.getAppVersion(),t.cordovaVersion=device.cordova,t.model=device.model,t.platform=device.platform,t.uuid=device.uuid,t.version=device.version),t}function E(){I.offlineActivities.length>0&&n.post(a.serverURL+"/account/offline",{activities:I.offlineActivities}).success(function(){I.offlineActivities.length=0,o.removeItem("offlineActivities")})}function p(){o.setItem("accountUser",JSON.stringify(I.accountUser))}function T(){o.setItem("userPreferences",JSON.stringify(I.userPreferences))}function f(){o.setItem("offlineActivities",JSON.stringify(I.offlineActivities))}function l(){o.setItem("activityContext",JSON.stringify(I.activityContext))}function d(e,t){var r="";return e&&(r+="?startTime="+e.getTime()),t&&(r+=r.length>0?"&":"?",r+="endTime="+t.getTime()),r}function m(e){return e=e.toLowerCase(),e.startsWith("es")?e="es":e.startsWith("fr")?e="fr":"en-us"!=e&&"en-gb"!=e&&(e="en-us"),e}function _(e){I.setUserPreference("last_viewed_intro_date",c.getTodayString());var t=1<<e,r=+I.getUserPreference("viewed_intro_videos");r||(r=0);var i=r|t;I.setUserPreference("viewed_intro_videos",i)}var I={accountUser:{},userPreferences:{},experienceTips:{},activityContext:{},splitTestContext:{},userNotification:{},offlineActivities:[],refreshedStore:!1,locale:void 0,MOOD_VIDEO:0,RELAX_VIDEO:1,THOUGHTS_VIDEO:2,GOALS_VIDEO:3,HEALTH_VIDEO:4,COMMUNITY_VIDEO:5,FINAL_VIDEO:5,activities:{LOGIN:{name:"LOGIN",id:1,type:"account"},LOGOUT:{name:"LOGOUT",id:2,type:"account"},COMPLETED_BREATHING:{name:"COMPLETED_BREATHING",displayKey:"RELAX_ACTIVITY_DEEP_BREATHING",id:3,type:"relax",premium:!1},COMPLETED_RETHINK:{name:"COMPLETED_RETHINK",displayKey:"COMPLETE_A_THOUGHT_ENTRY",id:4,type:"thoughts",premium:!1},COMPLETED_EXPERIMENT:{name:"COMPLETED_EXPERIMENT",displayKey:"COMPLETE_AN_EXPERIMENT",id:5,type:"goals",premium:!1},COMPLETED_MUSCLE_RELAXATION:{name:"COMPLETED_MUSCLE_RELAXATION",displayKey:"RELAX_ACTIVITY_MUSCLE_RELAXATION",id:6,type:"relax",premium:!1},COMPLETED_POSITIVE_VISUALIZATION:{name:"COMPLETED_POSITIVE_VISUALIZATION",displayKey:"RELAX_VISUALIZE_HELP_TITLE",id:7,type:"relax",premium:!1},COMPLETED_MINDFULNESS:{name:"COMPLETED_MINDFULNESS",id:8,type:"relax",premium:!1},COMPLETED_JOURNAL:{name:"COMPLETED_JOURNAL",id:9,type:"thoughts",premium:!1},COMPLETED_UNGUIDED_MEDITATION:{name:"COMPLETED_UNGUIDED_MEDITATION",id:10,type:"relax",premium:!1},COMPLETED_SS_SOCIAL_SITUATIONS:{name:"COMPLETED_SS_SOCIAL_SITUATIONS",displayKey:"RELAX_ACTIVITY_SOCIAL_SITUATIONS",id:11,type:"relax",premium:!1},COMPLETED_SS_FLYING:{name:"COMPLETED_SS_FLYING",displayKey:"RELAX_ACTIVITY_FLYING",id:12,type:"relax",premium:!0},COMPLETED_SS_PUBLIC_SPEAKING:{name:"COMPLETED_SS_PUBLIC_SPEAKING",displayKey:"RELAX_ACTIVITY_PUBLIC_SPEAKING",id:13,type:"relax",premium:!0},COMPLETED_SS_PUBLIC_TRANSIT:{name:"COMPLETED_SS_PUBLIC_TRANSIT",displayKey:"RELAX_ACTIVITY_PUBLIC_TRANSIT",id:14,type:"relax",premium:!0},COMPLETED_MINDFUL_SENSES:{name:"COMPLETED_MINDFUL_SENSES",displayKey:"RELAX_ACTIVITY_MINDFUL_SENSES",id:15,type:"relax",premium:!1},COMPLETED_MINDFUL_BREATHE:{name:"COMPLETED_MINDFUL_BREATHE",displayKey:"RELAX_ACTIVITY_MINDFUL_BREATHE",id:16,type:"relax",premium:!0},COMPLETED_MINDFUL_OBSERVE:{name:"COMPLETED_MINDFUL_OBSERVE",displayKey:"RELAX_ACTIVITY_MINDFUL_OBSERVE",id:17,type:"relax",premium:!0},COMPLETED_MINDFUL_BODY_SCAN:{name:"COMPLETED_MINDFUL_BODY_SCAN",displayKey:"RELAX_ACTIVITY_MINDFUL_BODY_SCAN",id:18,type:"relax",premium:!0},COMPLETED_MINDFUL_WALK:{name:"COMPLETED_MINDFUL_WALK",displayKey:"RELAX_ACTIVITY_MINDFUL_WALK",id:19,type:"relax",premium:!0},COMPLETED_CALM_BREATHE:{name:"COMPLETED_CALM_BREATHE",displayKey:"RELAX_ACTIVITY_CALM_BREATHE",id:20,type:"relax",premium:!1},COMPLETED_CALM_MIND:{name:"COMPLETED_CALM_MIND",displayKey:"RELAX_ACTIVITY_CALM_MIND",id:21,type:"relax",premium:!0},COMPLETED_PANIC_EMERGENCY:{name:"COMPLETED_PANIC_EMERGENCY",displayKey:"RELAX_ACTIVITY_PANIC_EMERGENCY",id:22,type:"relax",premium:!0},COMPLETED_SLEEP:{name:"COMPLETED_SLEEP",displayKey:"RELAX_ACTIVITY_SLEEP",id:23,type:"relax",premium:!0},COMPLETED_GRATITUDE:{name:"COMPLETED_GRATITUDE",displayKey:"RELAX_ACTIVITY_GRATITUDE",id:24,type:"relax",premium:!0},COMPLETED_BECOMING_THE_TREE:{name:"COMPLETED_BECOMING_THE_TREE",displayKey:"RELAX_ACTIVITY_BECOME_TREE",id:25,type:"relax",premium:!0},COMPLETED_DIFFICULT_EXPERIENCE:{name:"COMPLETED_DIFFICULT_EXPERIENCE",displayKey:"RELAX_ACTIVITY_DIFFICULT_EXPERIENCE",id:26,type:"relax",premium:!0},COMPLETED_SELF_COMPASSION:{name:"COMPLETED_SELF_COMPASSION",displayKey:"RELAX_ACTIVITY_SELF_COMPASSION",id:27,type:"relax",premium:!0},COMPLETED_EMPATHY:{name:"COMPLETED_EMPATHY",displayKey:"RELAX_ACTIVITY_EMPATHY",id:31,type:"relax",premium:!0},COMPLETED_DEFUSION:{name:"COMPLETED_DEFUSION",displayKey:"RELAX_ACTIVITY_DEFUSION",id:28,type:"relax",premium:!0},COMPLETED_POSITIVE_RETHINK:{name:"COMPLETED_POSITIVE_RETHINK",displayKey:"COMPLETE_A_POSITIVE_THOUGHT_ENTRY",id:29,type:"thoughts",premium:!1},COMPLETED_GRATITUDE_JOURNAL:{name:"COMPLETED_GRATITUDE_JOURNAL",displayKey:"THOUGHTS_ACTIVITY_GRATITUDE",id:32,type:"thoughts",premium:!0},COMPLETED_POSITIVITY_JOURNAL:{name:"COMPLETED_POSITIVITY_JOURNAL",displayKey:"THOUGHTS_ACTIVITY_POSITIVITY",id:32,type:"thoughts",premium:!0}}};t.$on("event:pacificaReady",function(){o.getItem("accountUser",function(e){if(e){var t=JSON.parse(e);I.accountUser=t}}),o.getItem("userPreferences",function(e){if(e){var t=JSON.parse(e);I.userPreferences=t}}),o.getItem("offlineActivities",function(e){if(e){var t=JSON.parse(e);I.offlineActivities=t}}),o.getItem("activityContext",function(e){if(e){var t=JSON.parse(e);I.activityContext=t}}),o.getItem("splitTestContext",function(e){if(e)try{var t=JSON.parse(e);I.splitTestContext=t}catch(r){}})}),t.$on("event:online",function(){E()}),I.enablePremiumAccount=function(e,t){I.accountUser.account.premium=!0,I.accountUser.account.paymentType=t?t:"PURCHASE",I.accountUser.account.premiumExpiresAt=e,p()},I.getCategoryForActivity=function(e){var e=I.activities[e];return e?e.type:void 0},I.getDisplayForActivity=function(e){var e=I.activities[e];if(e){var t=e.displayKey;if(t)return r.instant(t)}},I.isActivityPremium=function(e){var e=I.activities[e];return e?e.premium:!1},I.enablePremiumFeatures=function(e,t,r,i){I.canUpgrade()?e&&("ios-appstore"==e.type?n.post(a.serverURL+"/account/verifyIOSPurchase",{transactionId:e.id,subscriptionId:t,receipt:e.appStoreReceipt,price:r},{transformResponse:void 0}).success(function(e){e&&"false"!=e&&I.enablePremiumAccount(e),i&&i(e)}).error(function(){i&&i(!1)}):"android-playstore"==e.type&&n.post(a.serverURL+"/account/verifyAndroidPurchase",{transactionId:e.id,subscriptionId:t,purchaseToken:e.purchaseToken,price:r}).success(function(e){e&&"false"!=e&&I.enablePremiumAccount(e),i&&i(e)}).error(function(){i&&i(!1)})):i(!0)},I.isLoggedIn=function(){return a.isWeb()?s.hasToken():!!I.accountUser.user},I.isPremiumEnabled=function(){var e=I.accountUser.account&&I.accountUser.account.premium===!0;if(e){var r=new Date(I.accountUser.account.premiumExpiresAt);e=r>new Date,e||"PURCHASE"!=I.accountUser.account.paymentType||I.refreshedStore||(I.refreshedStore=!0,t.$broadcast("event:refreshStore"))}return e},I.getPremiumExpiration=function(){var e=I.isPremiumEnabled()?new Date(I.accountUser.account.premiumExpiresAt):void 0;return e?moment(e).format("LLLL"):""},I.canUpgrade=function(){return!I.isPremiumEnabled()||"TRIAL"==I.accountUser.account.paymentType},I.findUserContext=function(){var e=u();return n.post(a.serverURL+"/account/context",e)},I.createAccount=function(t,r,i,o,c,s){var E={};n.addTimezone(E);var p={email:t,password:r,name:i,goal:c,lang:I.getLocale(),joinGroupCode:s,preventDefaultHabits:!1};return o&&(p.referralCode=o),u(p),E.withCredentials=!0,e.post(a.serverURL+"/account/createV2",p,E)},I.resetPassword=function(t){return e.post(a.serverURL+"/account/requestPasswordReset",t)},I.updateToken=function(e){n.update(e)},I.setNickname=function(e){var t=createPromise();return n.post(a.serverURL+"/account/name",e).success(function(){I.accountUser.user.name=e,p(),t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},I.setPublicNickname=function(e){return n.post(a.serverURL+"/account/publicName",e)},I.updateLocalPublicNickname=function(e){I.accountUser.user.publicName=e,p()},I.setAvatar=function(e){return I.getAccountUser().user.avatar=e,p(),n.post(a.serverURL+"/account/avatar",e)},I.getAvatarCharacter=function(e,t){if(1==t||1003==t||1001==t)return"pacifica";if(!e){var r=t%26;e=String.fromCharCode(97+r)}return e},I.setEmailAddress=function(e){var t=createPromise();return n.post(a.serverURL+"/account/email",e).success(function(){I.accountUser.user.email=e,I.accountUser.user.emailVerifiedAt=void 0,p(),t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},I.isEmailValidated=function(){var e=I.getAccountUser();return e&&e.user&&!!e.user.emailVerifiedAt},I.checkRemoteEmailValidation=function(){return n.get(a.serverURL+"/account/isEmailValidated")},I.setAccountUser=function(e){I.accountUser=e,p()},I.getAccountUser=function(){return I.accountUser},I.setUserPreferences=function(e){if(I.userPreferences={},e)for(var t=0;t<e.length;++t){var r=e[t];I.userPreferences[r.preference]=r.value}T()},I.getUserPreference=function(e){return I.userPreferences[e]},I.setUserNotification=function(e){I.userNotification=e},I.getUserNotification=function(){return I.userNotification},I.setSplitTestContext=function(e){I.splitTestContext=e,e&&o.setItem("splitTestContext",JSON.stringify(e))},I.getSplitTestContext=function(){return I.splitTestContext},I.isUMNUser=function(){var e=I.getSplitTestContext();return e&&e.splitTestGroups?!!e.splitTestGroups.umnPilot:!1},I.login=function(t,r){var i={};n.addTimezone(i),i.withCredentials=!0;var o={email:t,password:r};return u(o),e.post(a.serverURL+"/account/login",o,i)},I.clearData=function(){I.accountUser={},I.userPreferences={},I.activityContext={},I.splitTestContext={},I.userNotification={},I.offlineActivities=[],p(),T(),l(),f(),o.removeItem("lastAppRatingDay"),o.removeItem("offlineActivities")},I.setOffline=function(){return n.post(a.serverURL+"/account/setOffline")},I.logout=function(){return I.clearData(),n.post(a.serverURL+"/account/logout")},I.ping=function(){return n.get(a.serverURL+"/ping")},I.clearUserPreference=function(e){return delete I.userPreferences[e],n.post(a.serverURL+"/account/clearPreference",{preference:e})},I.setUserPreference=function(e,t){if("undefined"!=typeof t){if("boolean"==typeof t&&(t+=""),I.isLoggedIn()&&("undefined"==typeof I.userPreferences[e]||I.userPreferences[e]!=t)&&(I.userPreferences[e]=t,T(),I.isLoggedIn()))return n.post(a.serverURL+"/account/preference",{preference:e,value:t});var r,o={success:function(e){return r=e,this},error:function(){return this}};return i(function(){r&&r()}),o}},I.registerGCMToken=function(e,t){return n.post(a.serverURL+"/account/gcmToken",e).then(function(){},t)},I.registerAPNSToken=function(e){return n.post(a.serverURL+"/account/apnsToken",e)},I.recordActivity=function(e){var t=I.activityContext[e];t||(t=[],I.activityContext[e]=t),t.push({recordedAt:new Date}),l(),a.isOnline()?n.post(a.serverURL+"/account/activity",e):(I.offlineActivities.push({activity:e,timestamp:new Date}),f())},I.setActivityContext=function(e){I.activityContext=e.dailyActivities,l()},I.getActivities=function(e){return I.activityContext[e]},I.getActivityCount=function(e){var t=I.getActivities(e),r=0;if(t)for(var i=c.getTodayString(),n=0;n<t.length;++n){var a=t[n],o=new Date(a.recordedAtString?a.recordedAtString:a.recordedAt),s=c.getDayString(o);s==i&&++r}return r},I.getActivityContextV2=function(e,t){var r=d(e,t);return n.get(a.serverURL+"/activity/contextV2"+r)},I.getActivityHistory=function(e,t){var r="";return e&&(r+="?startTime="+e.getTime()),t&&(r+=r.length>0?"&":"?",r+="endTime="+t.getTime()),n.get(a.serverURL+"/activity/history"+r)},I.getDaysSinceSignup=function(){var e=0;if(I.accountUser.user){var t=I.accountUser.user,r=c.getDayString(new Date(t.createdAtStr)),i=new Date(r),n=new Date(c.getTodayString());e=c.getDifferenceInDays(i,n)}return e},I.getLang=function(e){var t=e,r=t.indexOf("-");return r>0&&(t=t.substring(0,r)),t},I.getLocale=function(){return I.locale},I.updateLocale=function(e){I.locale=m(e);var t=I.getLang(I.locale);$("body").removeClass("en"),$("body").removeClass("es"),$("body").removeClass("fr"),$("body").addClass(t),r.use(t),moment.locale(I.locale)},I.setLocale=function(e){I.locale=e,I.updateLocale(I.locale);var t=createPromise();e=m(e);var r=I.setUserPreference("preferred_locale",e);return r&&r.success(function(){t.successCallback&&t.successCallback()}).error(function(){t.errorCallback&&t.errorCallback()}),t},I.getPublicUser=function(e){return n.get(a.serverURL+"/account/publicUser?userId="+e)},I.getUserTimeZone=function(){var e,t=I.getUserPreference("preferred_timezone");if(t)e=t;else{var r=jstz.determine();jstz&&(e=r.name())}return e},I.resendValidationEmail=function(){return n.post(a.serverURL+"/account/sendValidateEmail")},I.checkForRatingPrompt=function(){var e=I.getUserPreference("viewed_rate_app_popup");e&&"false"!=e||window.AppRate&&o.getItem("lastAppRatingDay",function(e){if(e!=c.getTodayString()&&I.getDaysSinceSignup()>=3){var t,r=function(e){t=e},i=function(e){1==e||3==e?I.setUserPreference("viewed_rate_app_popup",!0):o.setItem("lastAppRatingDay",c.getTodayString())};AppRate.preferences.storeAppURL.ios="922968861",AppRate.preferences.storeAppURL.android="market://details?id=com.pacificalabs.pacifica",AppRate.preferences.callbacks.onRateDialogShow=r,AppRate.preferences.callbacks.onButtonClicked=i,AppRate.promptForRating(!0)}})},I.clearPasscode=function(){return I.getAccountUser().user.passcode=void 0,p(),n.post(a.serverURL+"/account/clearPasscode")},I.setPasscode=function(e){return I.getAccountUser().user.passcode=e,p(),n.post(a.serverURL+"/account/setPasscode",{passcode:e})},I.getDownloadGiftCodeToken=function(){return n.get(a.serverURL+"/payment/getGiftCodeDownloadToken")},I.redeemGiftCode=function(e){return n.post(a.serverURL+"/payment/redeemGiftCode",{code:e})},I.bulkPurchaseWithtoken=function(e,t,r,i,o,c,s,u,E,p,T,f){return n.post(a.serverURL+"/payment/bulkPurchase",{token:e,firstName:t,lastName:r,address1:i,address2:o,city:c,state:s,postalCode:u,country:E,subscription:p,coupon:T,purchases:f})},I.subscribeWithToken=function(e,t,r,i,o,c,s,u,E,p,T){return n.post(a.serverURL+"/payment/subscribeWithToken",{token:e,firstName:t,lastName:r,address1:i,address2:o,city:c,state:s,postalCode:u,country:E,subscription:p,coupon:T})},I.cancelSubscription=function(){return n.post(a.serverURL+"/payment/cancelSubscription")},I.hasViewedVideo=function(e){var t=+I.getUserPreference("viewed_intro_videos");t||(t=0);var r=1<<e;return(t&r)>0},I.completedIntroVideos=function(){return I.getLastViewedVideo()>=I.FINAL_VIDEO},I.getLastViewedVideo=function(){var e=I.getUserPreference("last_viewed_intro_video");return"undefined"==typeof e?-1:("string"==typeof e&&(e=+e),e)},I.canViewVideo=function(){return!0},I.viewedVideoToday=function(){var e=I.getUserPreference("last_viewed_intro_date");return e==c.getTodayString()};var L=["MOOD_ACTIVITY","RELAX_ACTIVITY","THOUGHTS_ACTIVITY","EXPERIMENTS_ACTIVITY","HEALTH_ACTIVITY","COMMUNITY","WEEK_ONE_COMPLETE"],C=["https://thinkpacifica.com/milo/mood","https://thinkpacifica.com/milo/relax","https://thinkpacifica.com/milo/thoughts","https://thinkpacifica.com/milo/goals","https://thinkpacifica.com/milo/health","https://thinkpacifica.com/milo/community","https://thinkpacifica.com/milo/summary"];return I.getVideoTitle=function(e){return r.instant(0==e&&I.isUMNUser()?"STRESS_ACTIVITY":L[e])},I.getShareableVideoLink=function(e){return C[e]},I.skipVideo=function(e){I.hasViewedVideo(e)||_(e)},I.viewVideo=function(e,t){function r(e){"boolean"!=typeof e&&(e="true"===e),e&&t&&t()}if(!(0>e||e>=6))if(window.plugins&&window.plugins.streamingMedia){var i=a.serverURL+"/media/introVideo/stream/"+e;n.get(i).success(function(t){I.hasViewedVideo(e)||_(e),window.plugins.streamingMedia.playVideo(t.url,{successCallback:r,shouldAutoClose:!0})}).error(function(){})}else _(e)},I.postJSError=function(e,t,r){n.post(a.serverURL+"/support/jserror",{msg:e,url:t,line:r})},I}]);