var mod=angular.module("mediaService",[]);mod.factory("MediaService",["$rootScope","$timeout","$translate","authHttp","AccountService","Environment",function(e,n,i,o,t,a){function d(){var e=E.getBackgroundVideos(),n=t.getUserPreference("background_video");n||(n=e[0].code);for(var i=0;i<e.length;++i){var o=e[i];if(o.code==n){E.isDownloaded(o.filename)&&(t.isPremiumEnabled()||o.free)||(o=e[0]),E.setBackgroundVideo(o.filename,o.blurMethod);break}}}function r(e){for(var n=0;n<e.length;n++){var i=e[n];i.isFile&&(E.downloadedFiles[i.name]={filename:i.name,location:i.fullPath,nativeURL:i.nativeURL})}f()}function s(){f()}function l(e,n){window.resolveLocalFileSystemURL(cordova.file.dataDirectory,function(e){e.getDirectory(n,{create:!1,exclusive:!1},function(e){var i=e.createReader();i.readEntries(function(e){r(e),"backgrounds"==n&&d()},s)},function(){f()})})}function c(e){l(e,"meditations"),l(e,"backgrounds")}function u(){}function f(){}function m(e,n,i){function o(e){e.root.getFile(n,{create:!0,exclusive:!1},function(e){i(e)},function(){})}function t(){}window.LocalFileSystem&&window.requestFileSystem(e,0,o,t)}function g(n,i,t,d,r){E.downloadingFiles[t]={filename:t,progress:0,complete:!1},o.get(a.serverURL+n+"?filename="+t).success(function(n){if(window.cordova){var o=p+i+t,a=new FileTransfer;a.onprogress=function(n){if(n.lengthComputable){var i={filename:t,progress:n.loaded/n.total,complete:!1};E.downloadingFiles[t]=i,e.$broadcast("event:downloadProgress",i)}},a.download(n.url,o,function(n){delete E.downloadingFiles[t],E.downloadedFiles[t]={filename:t,location:o,nativeURL:n.nativeURL},e.$broadcast("event:downloadProgress",{filename:t,progress:1,complete:!0}),d&&d()},function(e){r&&r()})}}).error(function(e){})}function w(e,n,i,o,t){E.downloadingFiles[i]||(E.downloadedFiles[i],a.isAndroid()&&cordova.plugins.diagnostic?cordova.plugins.diagnostic.requestRuntimePermission(function(a){switch(a){case cordova.plugins.diagnostic.runtimePermissionStatus.GRANTED:g(e,n,i,o,t);break;case cordova.plugins.diagnostic.runtimePermissionStatus.NOT_REQUESTED:break;case cordova.plugins.diagnostic.runtimePermissionStatus.DENIED:t&&t();break;case cordova.plugins.diagnostic.runtimePermissionStatus.DENIED_ALWAYS:t&&t()}},function(e){},cordova.plugins.diagnostic.runtimePermission.WRITE_EXTERNAL_STORAGE):g(e,n,i,o,t))}function v(n,i){window.resolveLocalFileSystemURL(n,function(n){n&&n.remove(function(){delete E.downloadedFiles[i],e.$broadcast("event:downloadRemoved",i)},function(){})})}var p,E={downloadedFiles:{},downloadingFiles:{}};E.getBackgroundVideos=function(){return[{name:i.instant("BG_VIDEO_OCEAN"),code:"ocean",filename:"ocean.mp4",bgAudio:"Ocean",blurMethod:"light",free:!0},{name:i.instant("BG_VIDEO_OCEAN")+" 2",code:"ocean2",filename:"ocean2.mp4",bgAudio:"Ocean",blurMethod:"light",free:!0},{name:i.instant("BG_VIDEO_TROPICAL"),code:"tropical",filename:"tropical.mp4",bgAudio:"Ocean",blurMethod:"dark",free:!0},{name:i.instant("BG_VIDEO_STREAM"),code:"stream",filename:"forest.mp4",bgAudio:"ForestMorning",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_CLOUDS"),code:"clouds",filename:"clouds.mp4",bgAudio:"Pinknoise",blurMethod:"dark",free:!1},{name:i.instant("BG_VIDEO_CAMPFIRE"),code:"campfire",filename:"campfire.mp4",bgAudio:"campfire",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_MOUNTAINS"),code:"mountains",filename:"mountains.mp4",bgAudio:"ForestMorning",blurMethod:"dark",free:!1},{name:i.instant("BG_VIDEO_WATER"),code:"water",filename:"pond.mp4",bgAudio:"Bach",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_SUNSET"),code:"sunset",filename:"summernight.mp4",bgAudio:"SummerNight",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_WATERFALL"),code:"waterfall",filename:"waterfall.mp4",bgAudio:"Stream",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_LIGHTNING"),code:"thunderstorm",filename:"thunderstorm.mp4",bgAudio:"Thunderstorm",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_FIELD"),code:"field",filename:"field.mp4",bgAudio:"SummerNight",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_LAKE"),code:"lake",filename:"lake.mp4",bgAudio:"ForestMorning",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_REEF"),code:"reef",filename:"reef.mp4",bgAudio:"Pinknoise",blurMethod:"light",free:!1},{name:i.instant("BG_VIDEO_FLOWERS"),code:"flowers",filename:"flowers.mp4",bgAudio:"ForestMorning",blurMethod:"light",free:!1}]};var b=!1;window.checkExistingFiles=function(){var e=!1;return(!a.isOnline()||window.LocalFileSystem&&!b)&&(e=!0,b=!0,a.isAndroid()?cordova.plugins.diagnostic.getPermissionAuthorizationStatus(function(e){switch(e){case cordova.plugins.diagnostic.permissionStatus.GRANTED:window.requestFileSystem(LocalFileSystem.PERSISTENT,0,c,u);break;case cordova.plugins.diagnostic.permissionStatus.NOT_REQUESTED:break;case cordova.plugins.diagnostic.permissionStatus.DENIED:break;case cordova.plugins.diagnostic.permissionStatus.DENIED_ALWAYS:}},function(e){},cordova.plugins.diagnostic.runtimePermission.READ_EXTERNAL_STORAGE):window.requestFileSystem(LocalFileSystem.PERSISTENT,0,c,u)),e},e.$on("event:userContextInitialized",function(){p=window.cordova?cordova.file.dataDirectory:"";var e=window.checkExistingFiles();e||d()}),e.$on("event:pacificaReady",function(){a.isOnline()||window.checkExistingFiles()});var h={playAudioWhenScreenIsLocked:!1};return E.isNative=function(){return"undefined"!=typeof window.Media},E.loadMeditationMedia=function(e,n){return window.Media?(e=a.isAndroid()?cordova.file.dataDirectory+e:"cdvfile://localhost/library-nosync/"+e,new Media(e,function(){},function(e){},n)):void 0},E.loadMedia=function(e,n,i){var o="";return!e.startsWith("http")&&window.device&&window.device.platform&&"android"==window.device.platform.toLowerCase()&&(o="/android_asset/www/"),window.Media?new Media(o+e,function(){},function(e){},i):void 0},E.loadRecording=function(e,n,i,o,t){var a=function(e){o[i]=new Media(e,function(){},function(e){},t),o[i].setVolume(1)};m(LocalFileSystem.TEMPORARY,n,function(n){a(e.isAndroid()?n.nativeURL:n.fullPath)})},E.setVolume=function(e,n){e&&(e.setVolume?e.setVolume(n):e.volume=n)},E.fadeIn=function(e,i){function o(){d?e.setVolume(i*(a/t)):e.volume=i*(a/t),t>a?(n(o,3e3/t),++a):a=0}if(e){var t=100,a=0,d=E.isNative();o()}},E.fadeOut=function(e,i,o,t){function a(){l?e.setVolume(i*((r-s)/r)):e.volume=i*((r-s)/r),r>s?(n(a,d/r),++s):(s=0,o&&o())}if(e){var d=t?t:3e3,r=100,s=0,l=E.isNative();a()}},E.replayMedia=function(e,n){E.isNative()?(n||(n=h),e.play(n)):(e.load(),e.play())},E.isDownloaded=function(e){var n=E.downloadedFiles[e];return!!n},E.isDownloading=function(e){var n=E.downloadingFiles[e];return!!n},E.getDownloadPercentage=function(e){var n=E.downloadingFiles[e];return n?Math.round(100*n.progress):0},E.getStreamingMeditationURL=function(e){return o.get(a.serverURL+"/media/meditationStream?filename="+e)},E.getStreamingBackgroundURL=function(e){return o.get(a.serverURL+"/media/backgroundStream?filename="+e)},E.downloadBackgroundVideo=function(e,n,i){w("/media/backgroundVideoURL","backgrounds/",e,n,i)},E.setBackgroundVideo=function(e,n){if("ocean.mp4"==e)window.plugins&&window.plugins.bgVideo&&window.plugins.bgVideo.setVideo(void 0);else{if(!E.isDownloaded(e))return;if(window.plugins&&window.plugins.bgVideo){var i=E.downloadedFiles[e].nativeURL;0==i.indexOf("file")&&(i=i.substring(7)),window.plugins.bgVideo.setVideo(i,n)}}},E.downloadMeditationFile=function(e){w("/media/meditationURL","meditations/",e)},E.removeMeditationFile=function(e){var n="meditations/"+e;n=cordova.file.dataDirectory+n,v(n,e)},E.removeBackgroundVideo=function(e){var n="backgrounds/"+e;n=cordova.file.dataDirectory+n,v(n,e)},E}]);