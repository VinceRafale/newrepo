function createPromise(){var a={};return a.success=function(e){return a.successCallback=e,a},a.error=function(e){return a.errorCallback=e,a},a}var servicesModule=angular.module("goalsService",[]);servicesModule.factory("GoalsService",["$http","$rootScope","$timeout","authHttp","Environment","GeneralService","StorageService","AccountService",function(a,e,c,o,t,n,r,u){function i(){r.setItem("accountGoals",JSON.stringify(b.accountGoals))}function l(){r.setItem("accountSubGoals",JSON.stringify(b.accountSubGoals))}function s(a){isNumeric(a.id)&&isNumeric(a.goalId)&&a.achievedRecordedAtRequestUpdate&&G(a)}function f(){function a(a){a.createdOffline&&!isNumeric(a.id)&&isNumeric(a.goalId)&&(a.createdOffline=!1,o.post(t.serverURL+"/goals/account/addSubGoal",a).success(function(e){a.id=+e,l(),s(a)}).error(function(e){a.createdOffline=!1}))}var e=b.accountSubGoals;for(var c in e)for(var n=e[c],r=0;r<n.length;++r){var u=n[r];a(u)}}function d(a,e){function c(c){isNumeric(c.id)||c.goalId!=a?s(c):(c.goalId=e,l(),o.post(t.serverURL+"/goals/account/addSubGoal",c).success(function(a){c.id=+a,l(),s(c)}).error(function(a){}))}var n=b.accountSubGoals;for(var r in n)for(var u=n[r],i=0;i<u.length;++i){var f=u[i];c(f)}}function v(){function a(a){a.id&&isNumeric(a.id)||o.post(t.serverURL+"/goals/account/addGoal",{title:a.title,color:a.color}).success(function(e){var c=a.id;a.id=+e,d(c,a.id),i()}).error(function(a){})}f();for(var e=b.accountGoals,c=0;c<e.length;++c){var n=e[c];a(n)}}function G(a,e){if(a&&(b.achievedSubGoal(a)||(a.achievedRecordedAt=(new Date).getTime(),a.achievedRecordedAtString=(new Date).toString(),a.actualDifficulty=e,l(),u.recordActivity("COMPLETED_EXPERIMENT"))),t.isOnline())return o.post(t.serverURL+"/goals/account/achieveSubGoalWithDifficulty",{subGoalId:a.id,actualDifficulty:e});a.achievedRecordedAtRequestUpdate=!0;var n=createPromise();return c(function(){n.successCallback&&n.successCallback()}),n}var b={accountGoals:[],accountSubGoals:{},lastActiveTab:void 0};return e.$on("event:pacificaReady",function(){r.getItem("accountGoals",function(a){a&&(b.accountGoals=JSON.parse(a))}),r.getItem("accountSubGoals",function(a){a&&(b.accountSubGoals=JSON.parse(a))})}),b.logout=function(){b.accountGoals=[],b.accountSubGoals={}},b.getLastActiveTab=function(){return b.lastActiveTab},b.setLastActiveTab=function(a){b.lastActiveTab=a},b.setGoalContext=function(a){var e=b.accountGoals,c=b.accountSubGoals;b.accountGoals=a.accountGoals,b.accountSubGoals=a.accountSubGoals;for(var o=0;o<e.length;++o){var t=e[o];if(t.createdOffline&&!isNumeric(t.createdOffline)){for(var n=!1,r=0;r<b.accountGoals.length;++r)if(b.accountGoals[r].id==t.id){n=!0;break}n||b.accountGoals.push(t)}}for(var u in c)for(var s=c[u],f=0;f<s.length;++f){var d=s[f];if(d.createdOffline&&!isNumeric(d.id)){for(var v=!1,G=b.accountSubGoals[u],g=0;s>g;++g)if(G[g].id==d.id){v=!0;break}v||(b.accountSubGoals[u]||(b.accountSubGoals[u]=[]),b.accountSubGoals[u].push(d))}}i(),l()},b.getAccountGoals=function(){return b.accountGoals},b.getAccountSubGoals=function(){return b.accountSubGoals},b.getGoal=function(a){for(var e,c=b.accountGoals,o=0;o<c.length;++o)if(c[o].id==a){e=c[o];break}return e},b.getSubGoalById=function(a){for(var e in b.accountSubGoals)for(var c=b.accountSubGoals[e],o=0;o<c.length;++o){var t=c[o];if(t.id==a)return t}return void 0},b.getSubGoal=function(a,e){var c,o=b.accountSubGoals[a];if(o)for(var t=0;t<o.length;++t)if(o[t].id==e){c=o[t];break}return c},b.getTodaysAchievedGoals=function(){var a=[],e=b.accountSubGoals;for(var c in e)for(var o=e[c],t=0;t<o.length;++t){var n=o[t];b.achievedSubGoalToday(n)&&a.push(n)}return a},b.achievedSubGoal=function(a){return null!==a.achievedRecordedAt&&"undefined"!=typeof a.achievedRecordedAt},b.achievedSubGoalToday=function(a){if(b.achievedSubGoal(a)){var e=new Date(a.achievedRecordedAtString),c=n.getDayString(e);return c==n.getDayString(new Date)}return!1},e.$on("event:online",function(){v()}),b.addGoal=function(a,e){var n={title:a,color:e,createdAt:(new Date).getTime()};b.accountGoals.push(n),i();var r,u=createPromise();return t.isOnline()?o.post(t.serverURL+"/goals/account/addGoal",{title:a,color:e}).success(function(a){n.id=+a,i(),u.successCallback&&u.successCallback(a)}).error(function(a){u.errorCallback&&u.errorCallback()}):(n.id=generateGUID(),n.createdOffline=!0,i(),c(function(){r&&r()})),u},b.archiveGoal=function(a){for(var e=b.accountGoals,c=0;c<e.length;++c)if(e[c].id==a){e.splice(c,1),i();for(var n in b.accountSubGoals)for(var r=b.accountSubGoals[n],u=r.length-1;u>=0;--u){var s=r[u];s.goalId==a&&r.splice(u,1)}l();break}return o.post(t.serverURL+"/goals/account/archiveGoal",a)},b.updateGoal=function(a,e,c){var n=b.getGoal(a);return n?(n.title=e,n.color=c,i(),t.isOnline()?o.post(t.serverURL+"/goals/account/updateGoal",{goalId:n.id,title:n.title,color:n.color}):{success:function(a){a&&a()}}):void 0},b.addSubGoal=function(a,e,n,r){var u={goalId:a,title:e,day:n,difficulty:r,createdAt:(new Date).getTime()},i=b.accountSubGoals[n];i||(i=[],b.accountSubGoals[n]=i),i.push(u),l();var s=createPromise();return t.isOnline()?o.post(t.serverURL+"/goals/account/addSubGoal",u).success(function(a){u.id=+a,l(),s.successCallback&&s.successCallback()}).error(function(a,e,c,o){s.errorCallback&&s.errorCallback(a,e,c,o)}):(u.id=generateGUID(),u.createdOffline=!0,l(),c(function(){s.successCallback&&s.successCallback()})),s},b.achieveSubGoal=function(a,e){var c=b.getSubGoalById(a);return G(c,e)},b.archiveSubGoal=function(a,e){var c=b.accountSubGoals[a];if(c){var n=b.getSubGoal(a,e),r=c.indexOf(n);if(r>=0)return c.splice(r,1),l(),o.post(t.serverURL+"/goals/account/archiveSubGoal",e)}},b.updateSubGoal=function(a,e,n,r,u){var i=b.getSubGoal(r,a);if(i&&(i.goalId=e,i.day=r,i.title=n,i.difficulty=u,l(),t.isOnline()))return o.post(t.serverURL+"/goals/account/updateSubGoal",{subGoalId:a,goalId:e,title:n,day:r,difficulty:u});var s=createPromise();return c(function(){s.successCallback&&s.successCallback()}),s},b}]);