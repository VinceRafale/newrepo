$.cloudinary.config().cloud_name="mellon",$.cloudinary.config().upload_preset="kfxizvq0";var appInfoTmp={};document.addEventListener("deviceready",function(){function e(){var e=document.getElementsByTagName("body");angular.bootstrap(e,["mellonapp"])}function t(e){var t=cordova.getAppVersion,n={name:t.getAppName,"package":t.getPackageName,versionNumber:t.getVersionNumber,versionCode:t.getVersionCode},i=Object.keys(n).length;for(var o in n)!function(t){n[t](function(n){appInfoTmp[t]=n,i--,i||e()})}(o)}t(e)},!1),angular.module("mellonapp",["ionic","ngCordova","angularMoment","mellonapp.auth","mellonapp.api","angular.filter","cloudinary","monospaced.elastic","angular-cache","pascalprecht.translate"]).constant("DEBUG",!1).constant("PACKAGE_NAME","com.mellon.app").constant("ITUNES_ID","963447409").constant("PUSH_EVENT",!0).constant("REG_START_STATE","register-phonenumber").value("appInfo",{name:"","package":"",versionNumber:"",versionCode:""}).config(["$ionicConfigProvider","$logProvider","$compileProvider","DEBUG",function(e,t,n,i){t.debugEnabled(i),n.debugInfoEnabled(i),e.tabs.position("bottom"),e.tabs.style("standard"),e.form.toggle("large"),e.backButton.icon("ion-chevron-left"),e.backButton.text(""),e.views.swipeBackEnabled(!1)}]).factory("$exceptionHandler",["$log","$injector",function(e,t){return function(n,i){e.error(i),e.error(n.message),e.error(n.stack);var o={e_cause:i,e_msg:n.message,e_stack:n.stack},a=t.get("ApiCommon");a.remoteLog("exception",o)}}]).config(["$translateProvider",function(e){e.useStaticFilesLoader({prefix:"./translations/mellon-",suffix:".json"}),e.fallbackLanguage("en-US").registerAvailableLanguageKeys(["en-US","it-IT"],{"en-*":"en-US","it-*":"it-IT"}).useSanitizeValueStrategy("sanitizeParameters")}]).constant("CLOUDINARY_CONFIGS",function(){return{UPLOAD_PRESET:"kfxizvq0",API_IMAGE_URL:"https://api.cloudinary.com/v1_1/mellon/image/upload",API_VIDEO_URL:"https://api.cloudinary.com/v1_1/mellon/video/upload"}}()).constant("$ionicLoadingConfig",{templateUrl:"./templates/loading.html",delay:500}).run(["$http","$rootScope","$translate","$cordovaGoogleAnalytics","$log","appInfo",function(e,t,n,i,o,a){a.name=appInfoTmp.name,a["package"]=appInfoTmp["package"],a.versionNumber=appInfoTmp.versionNumber,a.versionCode=appInfoTmp.versionCode,delete window.appInfoTmp,t.isAndroid=ionic.Platform.isAndroid(),t.isIOS=ionic.Platform.isIOS(),window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!1),cordova.plugins.Keyboard.disableScroll(!0)),window.addEventListener("native.keyboardshow",function(){document.body.classList.add("keyboard-open")}),o.debug("SETTING CUSTOM HEADERS"),e.defaults.headers.common["Accept-Language"]=n.use(),e.defaults.headers.common["X-Mellon"]=a.versionNumber,e.defaults.headers.common["X-Platform"]=t.isIOS?"ios":"android",i.startTrackerWithId("UA-64308832-2")}]).run(["$rootScope","$log","$ionicLoading","$timeout","DEBUG",function(e,t,n,i,o){o&&(e.$on("$stateChangeError",function(e,n,i,o,a,r){t.debug("stateChangeError:"),t.debug(r),t.debug("from:"),t.debug(o),t.debug("to:"),t.debug(n)}),e.$on("$stateNotFound",function(e,n,i,o){t.debug("ROUTER: $stateNotFound->"+n.name),t.debug(n)}),e.$on("$stateChangeStart",function(e,n,i,o,a){t.debug("ROUTER: $stateChangeStart->"+n.name),t.debug(n)}),e.$on("$stateChangeSuccess",function(e,n,i,o,a){t.debug("ROUTER: $stateChangeSuccess->"+n.name),t.debug(n)}),e.$on("$viewContentLoading",function(e,n){t.debug("ROUTER: $viewContentLoading->"+n.targetView)}),e.$on("$viewContentLoaded",function(e){}))}]).run(["$ionicPlatform","$rootScope","$stateParams","$state","$localStorage","$cordovaDialogs","$cordovaNetwork","AuthService","ApiLogin","AddressBook","Notifications","Push","PUSH_EVENT","$log","AutoRefresh","Language","$timeout",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m,h){function v(e){r.getNetwork()!==Connection.NONE&&(t.FBing||c.fbCheckBadToken().then(function(t){p.debug("FB token check: invalid (revalidating...) "+e),s.fbConnect().then(function(e){switch(e){case"create":i.go("register-addressbook",{},{reload:!0});break;case"login":default:i.go("main.wall",{},{reload:!0})}},function(e){a.alert(e.error,e.domain+" Error","OK")})["finally"](function(){p.debug("FB token end revalidation"+e)})},function(){p.debug("FB token check: OK (or not present) "+e)}))}function y(){var e=1,t=864e5;if(s.hasAddressbookAutoupdate()){var n=(new Date).getTime(),i=o.getObject("addressbookLastUpdate",0),a=Math.abs(n-i)/t;return a>e}return!1}t.FBing=!1,e.on("deviceready",function(e){var t=Math.floor(Math.random()*Math.pow(10,16));p.debug("App Start - Device Ready"),m.set(),s.isAuthenticated()?(v(t),y()?u["export"]().then(function(){o.set("addressbookLastUpdate",(new Date).getTime())}):u.reparse(),h(function(){if(0==f){var e=d.getPushNotificationStateParams(),t=null,n=null;Object.keys(e).length>0&&(t=e.state,n=e.params),null!==t&&i.transitionTo(t,n,{reload:!0,inherit:!1,notify:!0}),d.setPushNotificationStateParams({})}},50),h(function(){p.debug("SHOULD RATE"),c.shouldRateApp().then(function(e){p.debug("Rate id: "+e),e>0&&h(function(){i.go("rate-mellon",{rateId:e})})})})):i.go("intro")}),e.on("pause",function(e){g.stopAll()}),e.on("resume",function(e){var t=Math.floor(Math.random()*Math.pow(10,16));if(p.debug("App resume: "+t),l.countNewNotifications(),l.setStopRefresh(!1),s.isAuthenticated()){v(t);var o=null,a=null;if(i.current.data&&i.current.data.refreshOnResume&&(p.debug("View refresh on resume: "+i.current.name),o=i.current,a=n),0==f){var r=d.getPushNotificationStateParams();Object.keys(r).length>0&&(o=r.state,a=r.params)}null!==o&&(console.log("transitionTo refresh"),i.transitionTo(o,a,{reload:!0,inherit:!1,notify:!0})),0==f&&d.setPushNotificationStateParams({})}else i.go("intro")})}]).run(["$rootScope","$state","$cordovaGoogleAnalytics","AuthService","REG_START_STATE",function(e,t,n,i,o){e.$on("$stateChangeStart",function(e,n,a,r){i.isAuthenticated()?i.hasRegCompleted()||0===n.name.indexOf("register-")||(e.preventDefault(),t.go(o)):"data"in n&&"noAuth"in n.data&&n.data.noAuth===!0||(e.preventDefault(),t.go("start")),window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!1)}),e.$on("$stateChangeSuccess",function(e,t,i,o,a){n.trackView(t.name)})}]).run(["$rootScope","$state","$stateParams","$overlay","$ionicLoading","$log","NotificationCountRealtime",function(e,t,n,i,o,a,r){e.network={},e.$on("mellon:offline",function(){i.isShown()||i.show("no-connection")}),e.$on("mellon:online",function(){i.hide()});var s=0;e.$on("$cordovaNetwork:offline",function(t,n){s>=0&&(a.warn("Network: gone offline"),s=-1,e.$emit("mellon:offline"))}),e.$on("$cordovaNetwork:online",function(i,o){0>=s&&(a.warn("Network: back online"),s=1,e.$emit("mellon:online"),t.transitionTo(t.current,n,{reload:!0,inherit:!1,notify:!0}))})}]).factory("ReqInterceptor",["$rootScope","$cordovaNetwork","$q","$log","ApiUrl",function(e,t,n,i,o){return{request:function(a){var r=n.defer();return!angular.isUndefined(navigator.connection)&&a.url.match(/^https?:\/\//)&&t.getNetwork()===Connection.NONE?(i.warn("API: network not present\n"+a.url),a.timeout=r.promise,e.$emit("mellon:offline"),r.resolve()):o.isApiUrl(a.url)||(a.headers["X-Mellon"]=void 0,a.headers["X-Platform"]=void 0,a.headers.Authorization=void 0,a.headers["X-ApritiSesamo"]=void 0),a}}}]).config(["$httpProvider",function(e){e.interceptors.push("ReqInterceptor")}]).run(function(){moment.locale("en-US",{relativeTime:{future:" in %s",past:" %s ago",s:" 1 second",m:" 1 minute",mm:" %d minutes",h:" 1 hour",hh:" %d hours",d:" 1 day",dd:" %d days",M:" 1 month",MM:" %d months",y:" 1 year",yy:" %d years"}}),moment.locale("it-IT",{relativeTime:{future:" fra %s",past:" %s fa",s:" 1 secondo",m:" 1 minuto",mm:" %d minuti",h:" 1 ora",hh:" %d ore",d:" 1 giorno",dd:" %d giorni",M:" 1 mese",MM:" %d mesi",y:" 1 anno",yy:" %d anni"}})}).run(["$log","$rootScope","$timeout","$state","Notifications","NotificationCountRealtime","AuthService","Push","PUSH_EVENT",function(e,t,n,i,o,a,r,s,c){t.$on("mellon:logged",function(){o.setStopRefresh(!1),o.countNewNotifications(),e.log("logged in!"),t.$on("updateNotificationCount",function(e,n){o.countNewNotificationsCalculation(n),t.$apply()})}),r.loadUser()}]).run(["$ionicPlatform","PARSE","$log",function(e,t,n){var i;i=angular.isDefined(window.localStorage.devhost)?t.dev:t.prod,Parse.initialize(i.parse_appkey,i.parse_jskey),Parse._getInstallationId().then(function(e){t.parseInstallationId=e,n.debug("Parse InstallationId= "),n.debug(t.parseInstallationId)})}]).config(["$provide",function(e){e.decorator("$cordovaFacebook",["$delegate",function(e){e.login;return e.appInvite=function(e){var t=angular.injector(["ng"]).get("$q"),n=t.defer();return facebookConnectPlugin.appInvite(e,function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},e}])}]),angular.module("mellonapp").config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/main/wall/"),e.state("start",{url:"/",onEnter:["$state",function(e){e.go("intro")}],data:{noAuth:!0}}).state("access",{url:"/access","abstract":!0,templateUrl:"templates/access.html",data:{noAuth:!0}}).state("access.login",{url:"/login",views:{"tab-login":{templateUrl:"templates/login.html",controller:"LoginCtrl"}},data:{noAuth:!0},resolve:{introText:function(){}}}).state("access.register",{url:"/register",views:{"tab-register":{templateUrl:"templates/register.html",controller:"RegisterCtrl",resolve:{phoneCountryCodes:function(){},welcomeText:function(){}}}},data:{noAuth:!0}}).state("forgot-pwd",{url:"/forgot-pwd/:email",templateUrl:"templates/forgot-pwd.html",controller:"LoginCtrl",data:{noAuth:!0},resolve:{introText:function(){}}}).state("register-phonenumber",{url:"/register-phonenumber/:returnOKState/:returnCancelState",templateUrl:"templates/reg-01-phonenumber.html",controller:"RegisterCtrl",resolve:{checkForContactsPerms:["$state","$q","$timeout","$ionicLoading","AddressBook",function(e,t,n,i,o){return t(function(t,a){i.show(),o.testPermission().then(function(){t(!0)},function(){n(function(){e.go("register-sys-settings")}),a("Redirect to register-sys-settings")})})}],phoneCountryCodes:["ApiLogin","checkForContactsPerms",function(e,t){return t?e.getPhoneCountryCodes():[]}],welcomeText:function(){}}}).state("register-addressbook",{url:"/register-addressbook/:returnOKState/:returnCancelState",templateUrl:"templates/reg-02-addrbook.html",controller:"RegisterCtrl",resolve:{phoneCountryCodes:function(){},welcomeText:function(){}}}).state("register-fb",{url:"/register-fb/:returnOKState/:returnCancelState",templateUrl:"templates/reg-03-bindFB.html",controller:"LoginCtrl",resolve:{introText:function(){}}}).state("register-houston",{url:"/register-houston",templateUrl:"templates/reg-04-houston.html",controller:"RegisterCtrl",resolve:{setSeenHouston:["$q","ApiLogin",function(e,t){return t.setSeenHoustonScreen(),e.when()}],phoneCountryCodes:function(){},welcomeText:function(){}}}).state("register-welcome",{url:"/register-welcome",templateUrl:"templates/reg-05-welcome.html",controller:"RegisterCtrl",resolve:{hasRegComp:["$state","$q","$timeout","AuthService",function(e,t,n,i){return i.hasRegCompleted()?t.when():(n(function(){e.go("register-houston")}),t.reject("Redirect to register-houston"))}],phoneCountryCodes:["$q",function(e){return e.when()}],welcomeText:["Text","$ionicLoading",function(e,t){return t.show(),e.getRegistrationWelcome(!0)}]}}).state("register-privacy",{url:"/register-privacy",templateUrl:"templates/reg-06-privacy.html"}).state("register-sys-settings",{url:"/register-sys-settings",templateUrl:"templates/reg-07-system-settings.html",controller:"RegisterCtrl",resolve:{phoneCountryCodes:function(){},welcomeText:function(){}}}).state("rate-mellon",{url:"/rate-mellon/:rateId",templateUrl:"templates/rate-mellon.html",controller:"RateCtrl"}).state("intro",{url:"/intro",templateUrl:"templates/intro.html",controller:"LoginCtrl",data:{noAuth:!0},resolve:{introText:["Text",function(e){return e.getIntro(!0)}]}}).state("main",{url:"/main","abstract":!0,templateUrl:"templates/main.html",controller:"MainCtrl"}).state("main.wall",{url:"/wall/:search",views:{"tab-wall":{templateUrl:"templates/wall.html",controller:"WallCtrl"}},data:{refreshOnResume:!0}}).state("main.profile",{url:"/profile",views:{"tab-profile":{templateUrl:"templates/profile.html",controller:"ProfileCtrl"}}}).state("main.profile-settings",{url:"/profile/settings",views:{"tab-profile":{templateUrl:"templates/profile-settings.html",controller:"ProfileSettingsCtrl"}}}).state("main.profile-settings-notifications",{url:"/profile/settings/notifications",views:{"tab-profile":{templateUrl:"templates/profile-settings-notifications.html",controller:"ProfileSettingsCtrl"}}}).state("main.profile-settings-ads",{url:"/profile/settings/ads",views:{"tab-profile":{templateUrl:"templates/profile-settings-ads.html",controller:"ProfileSettingsCtrl"}}}).state("main.profile-settings-language",{url:"/profile/settings/language",views:{"tab-profile":{templateUrl:"templates/profile-settings-language.html",controller:"ProfileSettingsCtrl"}}}).state("main.profile-settings-currency",{url:"/profile/settings/currency",views:{"tab-profile":{templateUrl:"templates/profile-settings-currency.html",controller:"ProfileSettingsCtrl"}}}).state("main.profile-settings-paypal",{url:"/profile/settings/paypal",views:{"tab-profile":{templateUrl:"templates/profile-settings-paypal.html",controller:"ProfileSettingsCtrl"}}}).state("main.profile-settings-delete-account",{url:"/profile/settings/delete-account",views:{"tab-profile":{templateUrl:"templates/profile-settings-delete-account.html",controller:"ProfileSettingsCtrl"}}}).state("main.profile-edit",{url:"/profile/edit",views:{"tab-profile":{templateUrl:"templates/profile-edit.html",controller:"ProfileEditCtrl"}}}).state("main.profile-edit-changepassword",{url:"/profile/edit/changepassword",views:{"tab-profile":{templateUrl:"templates/profile-edit-change-password.html",controller:"ProfileEditCtrl"}}}).state("main.saved-drafts",{url:"/profile/saved-drafts",views:{"tab-saved-drafts":{templateUrl:"templates/saved-drafts.html",controller:"ProfileSavedDraftsCtrl"}}}).state("main.sell",{url:"/sell/:transactionTypeId",views:{"tab-sell":{templateUrl:"templates/sell.html",controller:"SellCtrl"}}}).state("main.friends",{url:"/friends",views:{"tab-friends":{templateUrl:"templates/friends.html",controller:"FriendsCtrl"}},data:{refreshOnResume:!0}}).state("main.friend-detail",{url:"/friends/:friendId",views:{"tab-friend":{templateUrl:"templates/friend-detail.html",controller:"FriendDetailCtrl"}}}).state("main.friend-detail-via",{url:"/friends-detail-via/:friendId",views:{"tab-friend-detail-via":{templateUrl:"templates/friends-detail-via.html",controller:"FriendDetailViaCtrl"}}}).state("main.friend-settings",{url:"/friends/settings/:friendId",views:{"tab-friend":{templateUrl:"templates/friend-settings.html",controller:"FriendSettingsCtrl",resolve:{friendSettingData:["Friends","$stateParams","$ionicLoading",function(e,t,n){return n.show(),e.getUser(t.friendId,!0)}]}}}}).state("main.friend-block-friend",{url:"/friends/settings/:friendId/block",views:{"tab-friend":{templateUrl:"templates/friends-block-friend.html",controller:"FriendSettingsCtrl",resolve:{friendSettingData:["Friends","$stateParams","$ionicLoading",function(e,t,n){return n.show(),e.getUser(t.friendId,!0)}]}}}}).state("main.message-tabs",{url:"/message-tabs",views:{"tab-messages":{templateUrl:"templates/message-tabs.html",controller:"MessageTabsCtrl"}}}).state("main.message-threads",{url:"/message-threads",parent:"main.message-tabs",views:{"subtab-messages":{templateUrl:"templates/message-threads.html",controller:"MessageThreadsCtrl",resolve:{messageThreadData:["MessageThreads","$ionicLoading",function(e,t){var n;return n}]}}},onEnter:function(){},onExit:["$ionicLoading","$timeout",function(e,t){t(function(){},0)}],data:{refreshOnResume:!1}}).state("main.messages",{url:"/messages/:userId/:productId/:productTitle/:friendInformationId/:friendName",views:{"tab-chat":{templateUrl:"templates/messages.html",controller:"MessagesCtrl",resolve:{messageData:["Messages","$stateParams","$ionicLoading",function(e,t,n){var i;return n.show(),console.log("messages $ionicLoading.show()"),i}],friendData:["Friends","$stateParams","$ionicLoading","$q",function(e,t,n,i){return n.show(),i(function(i,o){e.getUser(t.userId,!1,!1).then(function(e){i(e)},function(e){o(e),n.hide()})})}]}}},data:{refreshOnResume:!1}}).state("main.notifications",{url:"/notifications",parent:"main.message-tabs",views:{"subtab-notifications":{templateUrl:"templates/notifications.html",controller:"NotificationsCtrl"}},onEnter:function(){},onExit:["$ionicLoading","$timeout",function(e,t){t(function(){},0)}],data:{refreshOnResume:!1}}).state("main.help",{url:"/help",views:{"tab-profile":{templateUrl:"templates/help.html",controller:"ProfileHelpCtrl"}}}).state("terms",{url:"/terms",templateUrl:"templates/terms.html",data:{noAuth:!0}}).state("privacy",{url:"/privacy",templateUrl:"templates/privacy.html",data:{noAuth:!0}}).state("main.library",{url:"/library",views:{"tab-profile":{templateUrl:"templates/library.html"}}}).state("main.product",{url:"product/:prodId",views:{"tab-product":{templateUrl:"templates/product-detail.html",controller:"ProductCtrl",resolve:{data:["Wall","$stateParams","$ionicLoading",function(e,t,n){return n.show(),e.getDetail(t.prodId)}],connectionLevel:["Friends","data","AuthService",function(e,t,n){var i=n.getUser();return i.id==t.user.id?null:e.getConnectionLevel(t.user.id)}],friendsList:["Friends","connectionLevel","data",function(e,t,n){return 2==t?e.getFollowingFirstLevel(n.user.id):null}]}}}}).state("main.product-update",{url:"product/update/:prodId",views:{"tab-product":{templateUrl:"templates/product-update.html",controller:"ProductUpdateCtrl"}}})}]),angular.module("mellonapp").constant("FB",{appID:"1441413772841337",ver:"v2.2",scopeRead:["public_profile","email","user_friends"],scopePublish:["publish_actions"]}),angular.module("mellonapp").value("PARSE",{dev:{parse_appkey:"xQeS7Ww6rGFz1qYbyrQqfe3CAdPg1pF0hZjv22Bt",parse_MASTER_key:"",parse_restkey:"2HuZyM8W6GNvbyvGixMfUzrypFXEccVjZhfXYuYk",parse_jskey:"GzDKhreRBWhSV4Q2ztId9vSDqY4ihlXYwp2yh2sh"},prod:{parse_appkey:"yePRwPV0CoaWvv4HoDxgJuop0LyMX6dWEF0hr81R",parse_MASTER_key:"",parse_restkey:"XFPNALQsn3HnXFjyVL4O1RrTdIK7gd8NQ3pvtAGA",parse_jskey:"VMLnjzVDryAcPEBYylsQhYiM07YSxSLcF9Wt67kJ"},parseInstallationId:null}),angular.module("mellonapp").filter("nl2br",["$filter",function(e){return function(e){return e?e.replace(/\n\r?/g,"<br />"):e}}]),angular.module("mellonapp").filter("emojioneToImage",["$filter",function(e){return function(e){return emojione.imagePathPNG="./img/emojione/png/",emojione.imageType="png",emojione.sprites=!1,e?emojione.toImage(e):e}}]).filter("emojioneToShort",["$filter",function(e){return function(e){return e?emojione.toShort(e):e}}]),angular.module("mellonapp").filter("trusted",["$sce",function(e){return function(t){return e.trustAsResourceUrl(t)}}]),angular.module("mellonapp").filter("emailAutoLink",function(){return function(e){return e.replace(/(.+@.+\..+)/gi,'<a class="autoLink" href="mailto:$1">$1</a>')}}),angular.module("mellonapp").filter("phoneAutoLink",function(){return function(e){return e.replace(/(\+?[0-9\-\/\(\)\s]{7,}[^\s])[\s\.-]*$/gi,'<a class="autoLink" href="tel:$1">$1</a>')}}),angular.module("mellonapp").directive("iphoneSizeDetect",["$ionicPlatform","iphoneModel","$log",function(e,t,n){return{restrict:"A",link:function(i,o,a,r,s){e.ready(function(){var e=t.get();n.debug(e),e&&o.addClass("size-"+e.size)})}}}]).directive("iframeAjaxLoading",["$rootScope","$ionicLoading","$timeout","$http","$log",function(e,t,n,i,o){return{restrict:"A",scope:{iframeAjaxSrc:"@"},link:function(a,r,s,c,u){function l(){o.debug("iframeAjaxLoading UPDATING...");var e=Math.floor(Math.random()*Math.pow(10,16)).toString(16);n(function(){t.show(),i.get(a.iframeAjaxSrc+"?"+e).then(function(e){r.contents().find("html").html(e.data)},function(){o.error("Cannot load "+a.iframeAjaxSrc)})["finally"](function(){t.hide()})})}l(),e.$on("$translateChangeSuccess",function(){l()})}}}]).directive("compile",["$compile",function(e){return function(t,n,i){t.$watch(function(e){return e.$eval(i.compile)},function(i){n.html(i),e(n.contents())(t)})}}]),angular.module("mellonapp").directive("mlnGallerySlider",["$log","$cordovaSocialSharing","$ionicActionSheet","$ionicModal","$ionicLoading","$state","Product","$translate","$window",function(e,t,n,i,o,a,r,s,c){return{restrict:"E",scope:{prod:"=prod"},templateUrl:"templates/gallery-slider.html",link:function(u,l,d){var f=d;u.showMoreButton=void 0!==f.showMoreButton?Number(f.showMoreButton):0,u.chatOnPrice=void 0!==f.chatOnPrice?Number(f.chatOnPrice):0,u.Math=window.Math,u.productVideo={media:!1,padding:0},u.isIOS=ionic.Platform.isIOS(),u.maxHeight=0,u.maxWidth=0,u.getMaxWidth=function(){return u.maxWidth||(u.maxWidth=l.parent()[0].offsetWidth),u.maxWidth},u.getMaxHeight=function(){return u.maxHeight?u.maxHeight:(angular.forEach(u.prod.media,function(e){var t=u.getMaxWidth()*e.height/e.width;t>u.maxHeight&&(u.maxHeight=t)}),u.maxHeight)},u.getMediaHeight=function(e){return u.getMaxWidth()*e.height/e.width},u.getMediaPadding=function(e){return u.getMaxHeight()>u.getMediaHeight(e)?(u.getMaxHeight()-u.getMediaHeight(e))/2:0},u.reportProduct={description:""},u.share=function(n){t.share(s.instant("Hi! I’ve just found this deal on Mellon, take a look:"),null,null,n.frontendUrl).then(function(t){e.debug("Share ok - "+t)},function(t){e.debug("Share error - "+t)})},u.showReportActionSheet=function(){n.show({buttons:[{text:s.instant("Report deal"),view:"modalReportProduct"}],cancelText:s.instant("Cancel"),cancel:function(){},buttonClicked:function(e){return"modalReportProduct"===this.buttons[e].view&&u.openModalReportProduct(),!0}})},i.fromTemplateUrl("templates/report-product.html",{scope:u,animation:"slide-in-up"}).then(function(e){u.modalReportProduct=e}),u.openModalReportProduct=function(){u.reportProduct.description="",u.modalReportProduct.show()},u.closeModalReportProduct=function(e){e.$setPristine(),u.modalReportProduct.hide()},i.fromTemplateUrl("templates/product-video.html",{scope:u,animation:"slide-in-right"}).then(function(e){u.modalProductVideo=e}),u.openModalProductVideo=function(e){u.productVideo.media=e,u.productVideo.padding=u.getModalVideoPadding(),u.modalProductVideo.show()},u.closeModalProductVideo=function(){u.productVideo.media=!1,u.productVideo.padding=0,u.modalProductVideo.hide()},u.$on("$destroy",function(){u.modalReportProduct.remove(),u.modalProductVideo.remove()}),u.getModalVideoPadding=function(){var e=c.innerHeight-80,t=c.innerWidth*u.productVideo.media.height/u.productVideo.media.width;return e>t?(e-t)/2+40:40},u.playVideo=function(e){o.show({duration:1e3});var t=angular.element(e.srcElement).parent().parent().next().find("video");t[0].play()},u.sendReportProduct=function(e){if(u.reportProduct.description){var t={id:u.prod.id,description:u.reportProduct.description};o.show(),r.reportProduct(t).then(function(){o.show({template:s.instant("Your report has been sent"),templateUrl:"",duration:3e3}),u.closeModalReportProduct(e)},function(e){o.show({template:s.instant("Error!"),templateUrl:"",duration:3e3})})}},u.goToThread=function(e,t){var n={userId:e,productId:u.prod.id,productTitle:u.prod.title};a.go("main.messages",n)}}}}]),angular.module("mellonapp").directive("mlnGalleryThumb",["$log","$cordovaSocialSharing","$ionicPopover","$ionicScrollDelegate","$ionicActionSheet","$ionicModal","$ionicLoading","$state","Product","$translate",function(e,t,n,i,o,a,r,s,c,u){return{restrict:"E",scope:{prod:"=prod",showThumb:"=showThumb"},templateUrl:"templates/gallery-thumb.html",link:function(n,l,d){var f=d;n.showMoreButton=void 0!==f.showMoreButton?Number(f.showMoreButton):0,n.chatOnPrice=void 0!==f.chatOnPrice?Number(f.chatOnPrice):0,n.activePhoto=0,n.bigImageWidth=0,n.Math=window.Math,n.reportProduct={description:""},n.getWidth=function(){return 0==n.bigImageWidth&&(n.bigImageWidth=l.parent()[0].offsetWidth),n.bigImageWidth},n.changeImage=function(e){n.activePhoto=e;var t=l[0].querySelector(".image-container");t&&i.scrollTo(0,l[0].offsetParent.offsetTop+t.offsetTop,!0)},n.share=function(n){t.share(u.instant("Hi! I’ve just found this deal on Mellon, take a look:"),null,null,n.frontendUrl).then(function(t){e.debug("Share ok - "+t)},function(t){e.debug("Share error - "+t)})},n.showReportActionSheet=function(){o.show({buttons:[{text:u.instant("Report deal"),view:"modalReportProduct"}],cancelText:u.instant("Cancel"),cancel:function(){},buttonClicked:function(e){return"modalReportProduct"===this.buttons[e].view&&n.openModalReportProduct(),!0}})},a.fromTemplateUrl("templates/report-product.html",{scope:n,animation:"slide-in-up"}).then(function(e){n.modalReportProduct=e}),n.openModalReportProduct=function(){n.reportProduct.description="",n.modalReportProduct.show()},n.closeModalReportProduct=function(e){e.$setPristine(),n.modalReportProduct.hide()},n.$on("$destroy",function(){n.modalReportProduct.remove()}),n.sendReportProduct=function(e){if(n.reportProduct.description){var t={id:n.prod.id,description:n.reportProduct.description};r.show(),c.reportProduct(t).then(function(){r.show({template:u.instant("Your report has been sent"),templateUrl:"",duration:3e3}),n.closeModalReportProduct(e)},function(e){r.show({template:u.instant("Error!"),templateUrl:"",duration:3e3})})}},n.goToThread=function(e,t){var i={userId:e,productId:n.prod.id,productTitle:n.prod.title};s.go("main.messages",i)}}}}]),angular.module("mellonapp").directive("mlnVideo",["$log",function(e){return{restrict:"E",scope:{videoId:"=videoId"},link:function(t,n,i){e.debug("larghezza "+n.parent(".item")[0].offsetWidth);var o=0;n.parent(".item")[0].offsetWidth<=300?o=300:n.parent(".item")[0].offsetWidth<=400&&(o=360),n.append($.cloudinary.video(t.videoId+".webm",{width:700,crop:"scale",duration:"100p",controls:"controls",secure:"secure",protocol:"https://"}))}}}]),angular.module("mellonapp").directive("mlnVideoModal",["$log","$window",function(e,t){return{restrict:"E",scope:{videoId:"=videoId"},link:function(e,n,i){e.appendVideo=function(){e.videoId?n.empty().append($.cloudinary.video(e.videoId+".webm",{width:700,crop:"scale",duration:"100p",controls:"controls",secure:"secure",protocol:"https://",autoplay:!0})).find("video").css("max-height",t.innerHeight-80+"px").css("width","auto"):n.empty()},e.appendVideo(),e.$watch("videoId",function(t,n){e.appendVideo()})}}}]),angular.module("mellonapp").directive("mlnProductsWall",["$state","$ionicLoading","$log","$timeout","$ionicScrollDelegate","$cordovaSocialSharing","$ionicPopover","$cordovaDialogs","$q","$rootScope","Product","$translate",function(e,t,n,o,a,r,s,c,u,l,d,f){return{restrict:"E",transclude:!0,templateUrl:"templates/products-wall.html",link:function(r,s,c){function d(e,t){var n=e;for(t=t.toLowerCase();n&&n.prop("tagName").toLowerCase()!==t;)n=n.parent();return n}r.platform=ionic.Platform,r.pageSize=10,r.page=1,r.searchProductList=function(){cordova.plugins.Keyboard.close(),r.search.searchProductInput!=r.search.lastSearchProductInput&&(t.show(),r.apiCalling?(n.debug("searchProductList busy - TIMEOUT"),o(function(){r.searchProductList()},100)):(r.setApiCalling(!0),r.setLastSearchInput(r.search.searchProductInput),a.$getByHandle(v).scrollTop(!1),t.show(),r.apiWallCall(1,1,!0,r.transactionTypeSelected,1).then(function(){r.page=1,r.listLimit=r.getListLimit()})["finally"](function(){r.setApiCalling(!1),t.hide()})))};var p=c;r.showUserInfo=!(void 0!==p.showUserInfo||"false"===p.showUserInfo),r.showThumb=void 0!==p.showThumb&&"true"===p.showThumb,r.showAllCount=void 0!==p.showAllCount&&"true"===p.showAllCount,r.emptySearchResultString=f.instant("Your search did not match any Deals."),l.$on("$translateChangeSuccess",function(){r.emptySearchResultString=f.instant("Your search did not match any Deals."),"undefined"!=typeof r.emptyWallCache&&r.emptyWallCache(),r.doRefresh()});var g=d(s,"ion-view"),m=g[0],h=g.find("ion-content"),v=h.attr("delegate-handle");r.goProdDetail=function(t){e.go("main.product",{prodId:t})},r.getListLimit=function(){return r.page*r.pageSize},r.listLimit=r.getListLimit(),r.loadMoreTimeout=function(){r.page++,r.listLimit=r.getListLimit(),o(function(){r.$broadcast("scroll.infiniteScrollComplete")}),n.debug("loadMore finished, page "+r.page+", listLimit "+r.listLimit)},r.loadMoreUpdate=function(){r.setApiCalling(!0),r.checkNewWallProducts().then(function(e){if(!e)return r.wallNextPage(r.transactionTypeSelected)["finally"](function(){r.setApiCalling(!1)});for(var t=1,o=[];t<=r.apiCurrentPage;)o.push(r.wallPageRefresh(t,r.transactionTypeSelected)),t++;u.all(o).then(function(e){var t=[];for(i=0;i<r.apiCurrentPage;i++)t=t.concat(e[i]);return r.setProductsList(t),r.wallNextPage(r.transactionTypeSelected)["finally"](function(){r.setApiCalling(!1)})},function(){n.debug("wallPageRefresh serial error"),r.setApiCalling(!1)})},function(e){r.setApiCalling(!1)})},r.loadMore=function(){n.debug("loadMore");var e=r.productsList.length-r.page*r.pageSize;0>=e?r.apiCalling?(n.debug("loadMore busy - TIMEOUT"),o(function(){r.loadMore()},100)):r.apiCurrentPage<r.apiPageCount&&u.when(r.loadMoreUpdate()).then(function(){r.loadMoreTimeout()},function(){o(function(){r.$broadcast("scroll.infiniteScrollComplete")})}):(o(function(){r.loadMoreTimeout()},500),e>0&&e<=r.pageSize&&r.apiCurrentPage<r.apiPageCount&&!r.apiCalling&&r.loadMoreUpdate())},r.moreDataCanBeLoaded=function(){return null!==r.productsList&&r.productsList.length>0?r.page*r.pageSize<r.productsList.length||r.apiCurrentPage<r.apiPageCount:!1},r.typeChange=function(e){e!=r.transactionTypeSelected&&(r.apiCalling?n.debug("typeChange apiCalling busy - ABORTED"):(t.show(),r.setApiCalling(!0),r.setTransactionTypeSelected(e),r.apiWallCall(!1,1,!0,r.transactionTypeSelected,1).then(function(){a.$getByHandle(v).scrollTop(!1),r.page=1,r.listLimit=r.getListLimit(),t.hide()})["finally"](function(){r.setApiCalling(!1)})))},r.isSelType=function(e){return void 0!==e?r.transactionTypeSelected===e:!0},r.getWidth=function(){return h[0].querySelector(".wall-card .list").offsetWidth},r.goToProductUpdate=function(t){e.go("main.product-update",{prodId:t}),r.closePopover()},r.goFriendDetail=function(t){t!=r.userLoggedId?e.go("main.friend-detail",{friendId:t}):e.go("main.profile")},r.initWallTabScroll=function(){if(!r.initialized){var e=angular.element(m.querySelector(".wall-tabs")),t=m.querySelector("#wall-tabs-position"),n=angular.element(m.querySelector(".wall-tabs-container")),i=void 0!==p.hasSubheader&&"true"===p.hasSubheader,o=44;ionic.Platform.isIOS()&&(o+=20),i&&(o+=61),h.bind("scroll",function(a){!e.hasClass("fixed")&&t.getBoundingClientRect().top<=o?(e.addClass("fixed"),i||(e.removeClass("has-subheader"),e.addClass("bar-subheader")),g.prepend(e)):e.hasClass("fixed")&&t.getBoundingClientRect().top>o&&(e.removeClass("fixed"),i||(e.removeClass("bar-subheader"),e.addClass("has-subheader")),n.prepend(e))}),r.initialized=!0}},r.$parent.initWallTabScroll=r.initWallTabScroll,r.initialized=!1,r.clearSearch=function(){r.apiCalling?n.debug("clearSearch busy - ABORTED"):(r.setSearchInput(""),t.show(),r.setApiCalling(!0),a.$getByHandle(v).scrollTop(!1),r.apiWallCall(!1,1,!0,r.transactionTypeSelected,1).then(function(){r.page=1,r.listLimit=r.getListLimit()})["finally"](function(){r.setApiCalling(!1),t.hide()}))},r.doRefresh=function(){n.debug("doRefresh"),r.apiCalling?n.debug("doRefresh busy - ABORTED"):(r.setApiCalling(!0),t.show(),r.apiWallCall(!0,1,!0,r.transactionTypeSelected,!0).then(function(e){r.page=1,r.listLimit=r.getListLimit(),n.debug("doRefresh finished")})["finally"](function(){r.$broadcast("scroll.refreshComplete"),r.$parent.$broadcast("scroll.refreshComplete"),r.setApiCalling(!1),t.hide()}))},r.$parent.doRefresh=r.doRefresh,r.wallPageRefresh=function(e,t){
return n.debug("wallPageRefresh page "+e),r.apiWallCall(!0,e,!1,t,!1).then(function(e){return e.items},function(e){return n.debug("wallPageRefresh error"),e})},r.wallNextPage=function(e){return n.debug("loadMore Wall.update "+(r.apiCurrentPage+1)),r.apiWallCall(!0,r.apiCurrentPage+1,!1,e,!1).then(function(e){n.debug("loadMore Wall.update "+(r.apiCurrentPage+1)+" finished"),r.setProductsList(r.productsList.concat(e.items)),r.setApiCounter(e)},function(e){n.debug("loadMore Wall.update "+(r.apiCurrentPage+1)+" error")})}}}}]),angular.module("mellonapp").directive("mlnProductForm",["$state","$filter","$ionicLoading","$ionicActionSheet","$ionicModal","$q","$log","$ionicScrollDelegate","$timeout","$cordovaDialogs","$window","$rootScope","CommonService","Product","Camera","ImageUploadService","FBPermssions","$translate","$log",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m,h,v,r){return{restrict:"E",transclude:!0,templateUrl:"templates/product-form.html",link:function(f,y,S){function b(e){if(e.split("://").length<2&&(e="file://"+e),"content://com.android"===e.substring(0,21)){var t=e.substring(e.lastIndexOf("/")+1),n=t.split("%3A");e="image"===n[0]?"content://media/external/images/media/"+n[1]:"content://media/external/video/media/"+n[1]}return e}f.setVisibilityTypes=function(){f.visibilityTypes=[{value:1,name:v.instant("Friends")},{value:0,name:v.instant("Friends & Friends of Friends")}]},f.setVisibilityTypes(),f.cameraSourceType=1,f.productFormDom=!1,f.productUrl=!1,f.date=new Date,f.isAndroid=ionic.Platform.isAndroid(),f.maxPrice=99999.99,f.formSending=!1,d.$on("$translateChangeSuccess",function(){f.setVisibilityTypes()}),h.hasFullWrite().then(function(e){f.FBPublishAllowed=e.result}),f.setCategory=function(e){f.product.category_id!=e&&(f.product.category_id=e,f.product.mainCategory=t("filter")(f.main_categories,{id:f.product.category_id},!0)[0],f.updateSubcategories()),f.openModalSubcategory()},f.updateSubcategories=function(){f.subcategories=[],f.product.subcategory_id=0,f.product.subCategory=!1,f.subcategories=t("filter")(f.all_subcategories,{parent_id:f.product.category_id},!0)},f.setSubcategory=function(e){f.product.subcategory_id=e,f.product.subCategory=t("filter")(f.subcategories,{id:f.product.subcategory_id},!0)[0],f.closeModalSubcategory(),f.closeModalCategory()},f.checkExistsCategory=function(){return!(!f.product.category_id||!f.product.subcategory_id)},f.checkExistsCondition=function(){return!!f.product.condition_id},f.setTransactionType=function(e){f.product.transaction_type_id=e,f.transactionType=t("filter")(f.transactionTypes,{id:f.product.transaction_type_id},!0)[0],f.$parent.transactionType=f.transactionType,f.closeModalTransactionType()},f.setCondition=function(e){f.product.condition_id=e,f.product.condition=t("filter")(f.conditions,{id:Number(e)},!0)[0],f.closeModalCondition()},o.fromTemplateUrl("templates/product-form-categories.html",{scope:f,animation:"slide-in-right"}).then(function(e){f.modalCategory=e}),o.fromTemplateUrl("templates/product-form-subcategories.html",{scope:f,animation:"slide-in-right"}).then(function(e){f.modalSubcategory=e}),o.fromTemplateUrl("templates/product-form-transactiontypes.html",{scope:f,animation:"slide-in-right"}).then(function(e){f.modalTransactionType=e}),o.fromTemplateUrl("templates/product-form-conditions.html",{scope:f,animation:"slide-in-right"}).then(function(e){f.modalCondition=e}),f.openModalCategory=function(){f.modalCategory.show(),s.$getByHandle("categoryScroll").scrollTop(!1)},f.closeModalCategory=function(){f.modalCategory.hide()},f.openModalSubcategory=function(){f.subcategories&&f.subcategories.length||(f.subcategories=t("filter")(f.all_subcategories,{parent_id:f.product.category_id},!0)),f.modalSubcategory.show(),s.$getByHandle("subcategoryScroll").scrollTop(!1)},f.closeModalSubcategory=function(){f.modalSubcategory.hide()},f.openModalTransactionType=function(){f.modalTransactionType.show()},f.closeModalTransactionType=function(){f.modalTransactionType.hide()},f.openModalCondition=function(){f.modalCondition.show()},f.closeModalCondition=function(){f.modalCondition.hide()},o.fromTemplateUrl("templates/product-form-share.html",{scope:f,animation:"slide-in-right"}).then(function(e){f.modalShare=e}),f.openModalShare=function(){f.modalShare.show()},f.closeModalShare=function(){f.modalShare.hide()},f.$on("$destroy",function(){f.modalCategory.remove(),f.modalSubcategory.remove(),f.modalShare.remove(),f.modalTransactionType.remove()}),f.changeNoPrice=function(){f.product.no_price&&(f.product.price="")},f.checkExistsShippingType=function(){return!!t("filter")(f.product.shippingTypes,{checked:!0}).length},f.checkShippingTypeOptions=function(){var e=t("filter")(f.product.shippingTypes,{checked:!0}),n=1;return e&&angular.forEach(e,function(e){e.has_custom_value&&!e.custom_value&&(n=0),e.has_price&&!e.price&&(n=0)}),n},f.checkExistsPaymentType=function(){return 3!=f.product.transaction_type_id&&4!=f.product.transaction_type_id?!!t("filter")(f.product.paymentTypes,{checked:!0}).length:!0},f.checkPaypalPaymentType=function(){return f.user.paypal_account?!0:!t("filter")(f.product.paymentTypes,{checked:!0,id:2},!0).length},f.checkPrice=function(e){return!(parseFloat(e)>f.maxPrice)},f.checkFormIsValid=function(e){return e.$valid&&f.checkPrice(f.product.price)&&f.checkShippingTypeOptions()&&f.checkExistsPaymentType()&&f.checkPaypalPaymentType()&&f.checkExistsCategory()&&f.checkExistsCondition()?!f.product.publish||f.user.status:!1},f.checkMediaType=function(e){var t=a.defer();return e.match(/\.(jpg|png|gif)$/i)?t.resolve("image"):e.match(/\.(3gp|mp4|ts|webm|mkv|m4v|mov)$/i)?t.resolve("video"):(r.debug("checkMediaType url "+e),window.resolveLocalFileSystemURL(e,function(e){e.file(function(e){!e.type||e.type.match(/image/)?t.resolve("image"):e.type.match(/video/)?t.resolve("video"):t.resolve(e.type)})},function(e){r.debug("checkMediaType resolveLocalFileSystemURL err "),r.error(e),t.reject(e)})),t.promise},f.uploadMediaToCloudinary=function(e,t,n){var i=a.defer();return m.uploadImage(e,t).then(function(e){"image"==e.resource_type?(f.product.images[n].url=e.url,f.product.images[n].public_id=e.public_id,f.product.images[n].type="image",f.product.images[n].width=e.width,f.product.images[n].height=e.height):(f.product.images[n].url=e.url.replace(/\.(\w)+$/,".jpg"),f.product.images[n].public_id=e.public_id,f.product.images[n].type="video",f.product.images[n].width=e.width,f.product.images[n].height=e.height),i.resolve(e)},function(e){r.error(e),i.reject(n)}),i.promise},f.getPhoto=function(e){var t=0;f.cameraSourceType&&"undefined"!=typeof f.user.settings.save_photo&&(t=f.user.settings.save_photo);var n={quality:80,mediaType:2,sourceType:f.cameraSourceType,correctOrientation:!1,encodingType:navigator.camera.EncodingType.JPEG,targetWidth:1024,targetHeight:768,destinationType:1,saveToPhotoAlbum:t};g.getPicture(n).then(function(t){var n=b(t);e===!1&&angular.forEach(f.product.images,function(t,n){t.url||e!==!1||(e=n)}),f.checkMediaType(n).then(function(t){f.product.images[e].type=t,f.product.images[e].public_id="",f.product.images[e].saved=!1,"image"===f.product.images[e].type?f.product.images[e].url=n:f.uploadMediaToCloudinary(n,1,e)},function(t){f.uploadMediaToCloudinary(n,1,e)})},function(e){r.debug(e)})},f.showUploadActionSheet=function(e){var t=[{text:v.instant("Take photo"),value:1,mediaIndex:e},{text:v.instant("Photo/Video Library"),value:0,mediaIndex:e}];e!==!1&&f.product.images[e].url&&t.push({text:v.instant("Delete"),value:2,mediaIndex:e});i.show({buttons:t,cancelText:v.instant("Cancel"),cancel:function(){},buttonClicked:function(e){return 2==this.buttons[e].value?f.deleteImage(this.buttons[e].mediaIndex):(f.cameraSourceType=this.buttons[e].value,f.getPhoto(this.buttons[e].mediaIndex)),!0}})},f.deleteImage=function(e){f.product.images[e]={public_id:"",url:"",saved:!1}},f.confirmCancel=function(e){if(!f.formSending)if(f.formSending=!0,e.$pristine)f.cancel(e);else{if("create"==f.action)var t=v.instant("Discard deal?"),n=v.instant("If you proceed your deal will be lost. Are you sure?");else var t=v.instant("Discard edits?"),n=v.instant("If you proceed your edits will be lost. Are you sure?");u.confirm(n,t,[v.instant("Yes"),v.instant("No")]).then(function(t){1==t?f.cancel(e):f.formSending=!1})}},f.cancel=function(t){f.initializeProduct(),t.$setPristine(),f.formSending=!1,"create"==f.action?e.go("main.wall"):e.go("main.product",{prodId:f.product.id})},f.closeKeyboard=function(){cordova.plugins.Keyboard.close()},f.saveDraft=function(e){f.formSending||(f.formSending=!0,f.closeKeyboard(),f.product.publish=0,f.save(e))},f.savePublic=function(e){f.formSending||(f.formSending=!0,f.closeKeyboard(),f.product.publish=1,f.save(e))},f.getMedia=function(){var e=[];angular.forEach(f.product.images,function(t,n){!t.public_id&&t.url&&e.push(f.uploadMediaToCloudinary(t.url,0,n))});var t=a.defer();return e.length?a.all(e).then(function(e){r.debug("all upload ok"),t.resolve(f.getUploadedMediaArray())},function(e){var n="";angular.forEach(e,function(e){n+=v.instant("Error upload media mediaNumber. ",{mediaNumber:Number(e)+1})}),t.reject(n)}):t.resolve(f.getUploadedMediaArray()),t.promise},f.getUploadedMediaArray=function(){var e=[];return angular.forEach(f.product.images,function(t,n){t.public_id&&e.push(t)}),e},f.save=function(e){if(f.checkFormIsValid(e)){n.show();var i=[],o=[],a=[];angular.forEach(f.product.shippingTypes,function(e){e.checked&&(i.push(e.id),e.has_custom_value&&o.push({id:e.id,value:e.custom_value}),e.has_price&&a.push({id:e.id,value:e.price}))});var u=[];angular.forEach(f.product.paymentTypes,function(e){e.checked&&u.push(e.id)}),f.getMedia().then(function(s){var l=s,d={transaction_type_id:f.product.transaction_type_id,category_id:f.product.category_id,subcategory_id:f.product.subcategory_id,title:f.product.title,condition_id:f.product.condition.id,price:f.product.price,no_price:f.product.no_price,description:f.product.description,web_url:f.product.web_url,location:f.product.location,custom_hashtags:f.product.custom_hashtags,available_from_date:t("date")(f.product.available_from_date,"yyyy-MM-dd"),expiration_date:t("date")(f.product.expiration_date,"yyyy-MM-dd"),shipping_type:i,shipping_type_custom_value:o,shipping_type_price:a,payment_type:u,visibility:f.product.visibility,allow_posting_on_facebook:f.product.allow_posting_on_facebook,facebook_comment:f.product.facebook_comment,animated_gif_on_facebook:f.product.animated_gif_on_facebook,temp_media_cloudinary:l,currency_id:f.product.currency.id,share_email:f.product.share_email,share_sms:f.product.share_sms,publish:f.product.publish},g="create"==f.action?p.create(d):p.update(f.product.id,d);g.then(function(t){r.debug(t),1!=t.status||f.product.status?(n.show({template:v.instant("Saved"),templateUrl:"",duration:3e3}),c(function(){f.goAhead(e)},3e3)):(f.productFormDom=e,f.productUrl=t.frontendUrl,n.hide(),f.openModalShare()),f.formSending=!1},function(e){for(var t="Errors:",i=0;i<e.length;i++)t+=" "+e[i].message;r.debug(t),n.show({template:v.instant("Error!"),templateUrl:"",duration:3e3}),f.formSending=!1})},function(e){n.show({template:e,templateUrl:"",duration:3e3}),f.formSending=!1})}else angular.forEach(f.boxShowErrors,function(e,t){f.boxShowErrors[t]=1}),f.boxShowErrors.publish=f.product.publish,c(function(){var e=y[0].querySelector(".item-divider.error");e&&s.scrollTo(0,e.offsetTop,!0)},0),f.formSending=!1},f.goAhead=function(t){f.initializeProduct(),t.$setPristine(),f.productFormDom=!1,f.productUrl=!1,"create"==f.action?e.go("main.wall"):e.go("main.product",{prodId:f.product.id},{reload:!0})},f.shareSms=function(){ionic.Platform.isAndroid()?l.open("sms:?body="+encodeURIComponent(f.productUrl),"_system"):ionic.Platform.isIOS()?ionic.Platform.version()>=8?l.open("sms:&body="+encodeURIComponent(f.productUrl),"_system"):l.open("sms:;body="+encodeURIComponent(f.productUrl),"_system"):l.open("sms:?body="+encodeURIComponent(f.productUrl),"_system")},f.shareEmail=function(){l.open("mailto:?subject=Mellon&body="+encodeURIComponent(f.productUrl),"_system")},f.shareSkip=function(){f.closeModalShare(),f.goAhead(f.productFormDom)},f.countImages=function(){var e=0;return angular.forEach(f.product.images,function(t,n){t.url&&e++}),e}}}}]),angular.module("mellonapp").directive("mlnPaypalPayment",["$log","$ionicLoading","$rootScope","$cordovaInAppBrowser","$cordovaDialogs","$timeout","Product","Wall","$translate",function(e,t,n,o,a,r,s,c,u){return{restrict:"A",link:function(l,d,f){l.product&&(l.product.pendingPayment=!1),l.justProcessed=!1,l.successUrl=!1,l.cancelUrl=!1,l.exitUrl=!1,l.payKey=!1,l.product_id=!1,l.confirmMakePaypalPaymentByRequest=function(e){a.confirm(u.instant("Do you want to pay for this deal using PayPal?"),u.instant("Pay Now"),[u.instant("Yes, I do"),u.instant("No")]).then(function(t){1===t&&l.makePaypalPaymentByPaymentRequest(e)})},l.confirmMakePaypalPayment=function(e){a.confirm(u.instant("Do you want to pay for this deal using PayPal?"),u.instant("Pay Now"),[u.instant("Yes, I do"),u.instant("No")]).then(function(t){1===t&&l.makePaypalPayment(e)})},l.makePaypalPaymentByPaymentRequest=function(e){t.show(),s.preparePaymentByRequest({payment_request_id:e}).then(function(e){l.successPreparePayment(e)},function(e){l.errorPreparePayment(e)})},l.makePaypalPayment=function(e){t.show(),s.preparePayment({id:e}).then(function(e){l.successPreparePayment(e)},function(e){l.errorPreparePayment(e)})},l.successPreparePayment=function(a){l.successUrl=a.successUrl,l.cancelUrl=a.cancelUrl,l.exitUrl=a.exitUrl,l.payKey=a.payKey,l.product_id=a.product_id,l.justProcessed=!1,o.open(a.url,"_blank",{location:ionic.Platform.isIOS()?"no":"yes",clearcache:"yes",toolbar:"yes",toolbarposition:"top",hidden:"yes"}),n.$on("$cordovaInAppBrowser:loadstop",function(n,a){for(e.debug("loadstop"),e.debug(a),t.hide(),o.show(),i=0;i<l.successUrl.length;i++)-1!=a.url.indexOf(l.successUrl[i])&&(e.debug("is successUrl"),r(function(){t.show(),o.close(),l.checkPayment(l.product_id,l.payKey,1,!1)},2e3));for(i=0;i<l.cancelUrl.length;i++)-1!=a.url.indexOf(l.cancelUrl[i])&&(e.debug("is cancelUrl"),r(function(){o.close(),t.show({template:u.instant("We're sorry but the payment was not received (user canceled)"),templateUrl:"",duration:5e3}),l.justProcessed=!0,s.setPaymentCanceled({product_id:l.product_id,pay_key:l.payKey})},2e3));for(i=0;i<l.exitUrl.length;i++)-1!=a.url.indexOf(l.exitUrl[i])&&(e.debug("is exitUrl"),t.show(),o.close(),l.checkPayment(l.product_id,l.payKey,1,!0))}),n.$on("$cordovaInAppBrowser:exit",function(n,i){e.debug("exit"),l.justProcessed||(t.show(),l.checkPayment(l.product_id,l.payKey,1,!0))})},l.errorPreparePayment=function(e){t.hide(),a.alert(e,u.instant("Pay Now"),u.instant("Ok")).then(function(){})},l.checkPayment=function(n,i,o,d){l.justProcessed=!0,s.checkPayment({product_id:n,pay_key:i}).then(function(e){e.success?e.processed?(l.product&&(l.product.status=e.product.status,l.product.pendingPayment=!1),c.updateDetail(n,!1),t.hide(),a.alert(u.instant("All Set! We received your Payment, thanks."),u.instant("Pay Now"),u.instant("Ok")).then(function(){})):1===o?r(function(){l.checkPayment(n,i,2,d)},1500):d?(t.hide(),a.alert(u.instant("PayPal Process Completed."),u.instant("Pay Now"),u.instant("Ok")).then(function(){})):(l.product.pendingPayment=!0,t.hide(),a.alert(u.instant("Thank you, we’re still processing your payment. Please hold on."),u.instant("Pay Now"),u.instant("Ok")).then(function(){})):(t.hide(),a.alert(u.instant("Oops something went to wrong. [1]"),u.instant("Pay Now"),u.instant("Ok")).then(function(){}))},function(n){e.error(n),t.hide(),a.alert(u.instant("Oops something went to wrong. [2]"),u.instant("Pay Now"),u.instant("Ok")).then(function(){})})}}}}]),angular.module("mellonapp").directive("loadMoreAtTop",["$timeout",function(e){return{restrict:"E",scope:{onScroll:"&onScroll"},require:"^$ionicScroll",template:function(){return'<ion-refresher pulling-text="More..." on-refresh="growBounds()"></ion-refresher>'},link:function(t,n,i,o){function a(){var e=c.scrollHeight,t=e-s;console.log("difference",t,"height",e,"lastHeight",s),o.scrollTo(o.getScrollPosition().left,t,!0)}function r(){u&&e(function(){u=!1,a(),t.$broadcast("scroll.refreshComplete")},0)}var s,c=o.$element[0],u=!1;t.growBounds=function(){u=!0,s=c.scrollHeight,console.log("lastHeight",s),t.onScroll()},t.$parent.$on("scroll.loaded",r)}}}]),angular.module("mellonapp").controller("AppCtrl",["$timeout","$log","$scope","$rootScope","$state","$cordovaDialogs","$ionicLoading","AuthService","AUTH_EVENTS","ApiUtils","$overlay","$translate",function(e,t,n,i,o,a,r,s,c,u,l,d){function f(){i.outOfService&&(i.apiPingId=e(function(){u.apiPing()["finally"](function(){f()})},5e3))}var p=!1;n.$on(c.notAuthenticated,function(e){s.destroyUser(),t.log("Session Expired"),p||(p=!0,o.go("intro"),a.alert(d.instant("Sorry, for some reasons you have been logged out. Please login again."),d.instant("Session Expired!"),d.instant("OK")).then(function(){p=!1}))}),i.outOfService=!1,i.apiPingPromise=null,n.$on(c.serviceUnavailable,function(e){t.debug("receiver ServiceUnavailable"),i.outOfService||(i.outOfService=!0,f(),l.show("no-api-service"))}),n.$on(c.serviceAvailable,function(e){t.debug("receiver ServiceAvailable"),i.outOfService=!1,l.hide()})}]),angular.module("mellonapp").factory("$localStorage",["$window",function(e){return{set:function(t,n){e.localStorage[t]=n},get:function(t,n){return e.localStorage[t]||n},remove:function(t){e.localStorage.removeItem(t)},clear:function(){e.localStorage.clear()},setObject:function(t,n){e.localStorage[t]=angular.toJson(n)},getObject:function(t,n){return angular.fromJson(e.localStorage[t])||n}}}]).factory("Camera",["$q",function(e){return{getPicture:function(t){var n=e.defer();return navigator.camera.getPicture(function(e){n.resolve(e)},function(e){n.reject(e)},t),n.promise}}}]).factory("ImageUploadService",["$q","$log","$ionicLoading","$translate","$cordovaFileTransfer","CLOUDINARY_CONFIGS",function(e,t,n,i,o,a){function r(t,r){function s(e,r){if(e)var s={params:{upload_preset:a.UPLOAD_PRESET,resource_type:"video"}},d=a.API_VIDEO_URL;else var s={params:{upload_preset:a.UPLOAD_PRESET}},d=a.API_IMAGE_URL;o.upload(d,t,s).then(function(e){r&&n.show({template:i.instant("Upload Completed"),templateUrl:"",delay:0,duration:1e3});var t=JSON.parse(decodeURIComponent(e.response));l.resolve(t)},function(e){r&&n.show({template:i.instant("Upload Failed"),templateUrl:"",delay:0,duration:3e3}),l.reject(e)},function(t){u=Math.floor(t.loaded/c*100),r&&n.show({template:i.instant("Uploading ")+(e?i.instant("Video"):i.instant("Photo"))+" : "+u+"%",templateUrl:"",delay:0})})}var c,u,l=e.defer();return window.resolveLocalFileSystemURL(t,function(e){e.file(function(e){c=e.size,e.type&&e.type.match(/video/)||t.match(/\.(3gp|mp4|ts|webm|mkv|m4v|mov)$/i)?(r&&n.show({template:i.instant("Uploading Video: ")+0+"%",templateUrl:"",delay:0}),s(1,r)):(r&&n.show({template:i.instant("Uploading Photo: ")+0+"%",templateUrl:"",delay:0}),s(0,r))})},function(){l.reject("resolveLocalFileSystemURL error")}),l.promise}var s={};return s.uploadImage=r,s}]).factory("AppInstalled",["$q","$cordovaAppAvailability","$log",function(e,t,n){function i(t){return e(function(e){r.promise.then(function(){e(a[t]?a[t].available:!1)})})}function o(){ionic.Platform.ready(function(){var n=ionic.Platform.platform(),i=[];for(var o in a){var s=function(e){return t.check(a[e][n]).then(function(){a[e].available=!0},function(){a[e].available=!1})}(o);i.push(s)}e.all(i)["finally"](function(){r.resolve()})})}var a={whatsapp:{ios:"whatsapp://",android:"com.whatsapp"},facebook:{ios:"fb://",android:"com.facebook.katana"},"fb-messenger":{ios:"fb-messenger://",android:"com.facebook.orca"}},r=e.defer();return o(),{query:i}}]).factory("SIM",["$q","$window","$ionicPlatform","$log",function(e,t,n,i){function o(){var o=e.defer();return n.ready(function(){t.plugins.sim.getSimInfo(function(e){o.resolve({countryCode:e.countryCode.toUpperCase(),phoneNumber:e.phoneNumber}),i.debug(e)},function(){o.reject()})}),o.promise}return{query:o}}]).factory("AddressBook",["$q","$cordovaContacts","ApiLogin","$log","$translate","AuthService",function(e,t,n,i,o,a){function r(){var e={fields:["displayName","name"],filter:"",multiple:!0,desiredFields:["id","displayName","name","phoneNumbers","emails"]};return ionic.Platform.isAndroid()&&(e.hasPhoneNumber=!0),t.find(e)}function s(e){var t={name:"",surname:"",emails:[],phone_numbers:[]},n=e.name&&e.name.familyName?e.name.familyName:"",i=e.name&&e.name.givenName?e.name.givenName:"",o=null!==e.phoneNumbers,a=null!==e.emails;if(n||i){if(t.name=i,t.surname=n,o)for(var r in e.phoneNumbers)t.phone_numbers.indexOf(e.phoneNumbers[r].value)<0&&t.phone_numbers.push(e.phoneNumbers[r].value);if(a)for(var r in e.emails)t.emails.push(e.emails[r].value);return t}return!1}function c(){return r()}function u(){return e(function(e,t){r().then(function(t){i.debug("ABOOK dump:"),i.debug(t);var n=[];for(var o in t){var a=s(t[o]);a!==!1&&n.push(a)}i.debug("ABOOK filtered:"),i.debug(n),e(n)},function(e){i.warn("Phone Contacts Access Denied!"),t()})})}var l=function(){return e(function(e,t){u().then(function(a){i.debug(a.length+" contacts found"),n.importAddressBook(a).then(function(){i.debug("Phone Contacts imported"),e()},function(){t(o.instant("Error importing Phone Contacts"))})},function(e){t(o.instant("Error accessing Phone Contacts"))})})},d=function(){return e(function(e,t){n.reparseAddressBook().then(function(){i.debug("Phone Contacts reparsing: OK"),e()},function(e){i.error("Phone Contacts reparsing: ERR ("+e+")"),t(o.instant("Phone Contacts reparsing: ERR (errMsg)",{errMsg:e}))})})},f=function(){return e(function(e,t){n.emptyAddressBook().then(function(t){a.updateUser(t),e()},function(e){t(o.instant("Phone Contacts emptying: ERR (errMsg)",{errMsg:e}))})})};return{"export":l,reparse:d,testPermission:c,empty:f}}]).factory("iphoneModel",["$cordovaDevice","$log",function(e,t){function n(){var t,n,a="iphone",r="ipad",s="ipod",c=e.getDevice(),u=c.model;if(0===u.toLowerCase().indexOf(a))t=u.substr(a.length),n=t.split(",");else if(0===u.toLowerCase().indexOf(r))t="3,1",n=t.split(",");else{if(0!==u.toLowerCase().indexOf(s))return!1;t="5,1",n=t.split(",")}return{cordova:u,version:t,major:n[0],minor:n[1],model:i[t],size:o[t]}}var i={"1,1":"iphone","1,2":"iphone3g","2,1":"iphone3gs","3,1":"iphone4","3,2":"iphone4","3,3":"iphone4","4,1":"iphone4s","5,1":"iphone5","5,2":"iphone5","5,3":"iphone5c","5,4":"iphone5c","6,1":"iphone5s","6,2":"iphone5c","7,2":"iphone6","7,1":"iphone6p","8,1":"iphone6s","8,2":"iphone6sp"},o={"1,1":"iphone1","1,2":"iphone1","2,1":"iphone1","3,1":"iphone4","3,2":"iphone4","3,3":"iphone4","4,1":"iphone4","5,1":"iphone5","5,2":"iphone5","5,3":"iphone5","5,4":"iphone5","6,1":"iphone5","6,2":"iphone5","7,2":"iphone6","7,1":"iphone6p","8,1":"iphone6s","8,2":"iphone6sp"};return{get:n}}]).factory("AutoRefresh",["$rootScope","$timeout","Notifications",function(e,t,n){function i(){n.setStopRefresh(!0),t(function(){n.cancelCountNewNotifications()}),e.updateNotificationsListRefresh=!1,t(function(){t.cancel(e.updateNotificationsListTimeout)}),e.updateMessagestRefresh=!1,t(function(){t.cancel(e.updateMessagesTimeout)}),e.updateMessageThreadsRefresh=!1,t(function(){t.cancel(e.updateMessageThreadsTimeout)})}return{stopAll:i}}]).factory("$overlay",["$rootScope","$ionicBackdrop","$ionicBody","$ionicPlatform","$log","$translate",function(e,t,n,i,o,a){function r(){u={"no-connection":{title:a.instant("You can't connect to the Internet"),text:a.instant("Currently your internet connection doesn't appear to be working. As soon as you're back online, you'll be able to use Mellon again.")},"no-api-service":{title:a.instant("We are sorry but Mellon is temporarily out of service"),text:a.instant("We're working on it to make it better. Please try again in a few minutes.")}}}function s(e,a){var r,s;if(angular.isUndefined(a)){if("undefined"==typeof u[e])return void o.log("Overlay template not found");r=u[e].title,s=u[e].text}else r=e,s=a;f||(f=angular.element(l),n.append(f)),g||t.retain();var c=d.replace("{{title}}",r).replace("{{text}}",s);p(),p=i.registerBackButtonAction(angular.noop,1e3),f.html(c),f.addClass("visible"),g=!0}function c(){p(),g&&(t.release(),f.removeClass("visible"),f.html("")),g=!1}var u,l='<div class="overlay-container"></div>',d='<div class="overlay-content"><h1>{{title}}</h1><p>{{text}}</p></div>';r(),e.$on("$translateChangeSuccess",function(){r()});var f,p=angular.noop,g=!1;return{show:s,hide:c,isShown:function(){return g}}}]).factory("FBPermssions",["$cordovaFacebook","$q","$log","FB",function(e,t,n,i){function o(i){return i=angular.isDefined(i)?i:!1,l&&!i?t.when(l):(null===d&&(d=t.defer(),e.getLoginStatus().then(function(t){n.debug("FB status: "+t.status),"connected"===t.status?(n.debug("GET /me/permissions"),e.api("/me/permissions").then(function(e){l=e.data,n.debug("RESULT /me/permissions"),d.resolve(l)},function(e){n.error(e),d.reject(e)})["finally"](function(){d=null})):(d.reject("User not logged on FB"),d=null)},function(e){d.reject("FB getloginstatus call error"),d=null})),d.promise)}function a(e,t){var n={perms:{},result:!0};for(var i in e){for(var o in t){var a=!1;if(t[o].permission===e[i]){n.perms[e[i]]="granted"===t[o].status,a=!0;break}}n.result=n.result&&a&&n.perms[e[i]]}return n}function r(e,t){return angular.isString(e)&&(e=[e]),o(t).then(function(t){return a(e,t)},function(e){return e})}function s(e){return r(i.scopePublish,e)}function c(e){return r(i.scopeRead,e)}function u(e){return r(i.scopeRead.concat(i.scopePublish),e)}var l=null,d=null;return{has:r,hasFullWrite:s,hasFullRead:c,hasFull:u}}]).factory("Language",["$http","$log","$translate","$localStorage","AuthService","amMoment",function(e,t,n,i,o,a){function r(o){n.use(o).then(function(n){t.debug("Lang: change OK -> "+n),e.defaults.headers.common["Accept-Language"]=o,a.changeLocale(o),i.set(c,o)},function(e){t.debug("Lang: change ERR -> "+e)})}function s(){var e=i.get(c);e?(t.debug("Lang: set by local storage"),r(e)):angular.isDefined(navigator.globalization)&&(t.debug("Lang: set by system default"),navigator.globalization.getPreferredLanguage(function(e){r(e.value)},null))}var c="lang",u=function(e){if(angular.isUndefined(e))if(o.isAuthenticated()){var n=o.getUser();n.language&&n.language.code?(t.debug("Lang: set by user auth data"),r(n.language.code)):(t.debug("Lang: no lang in user auth data"),s())}else s();else t.debug("Lang: set by user choice"),r(e)},l=function(){return n.use()};return{set:u,get:l}}]),angular.module("mellonapp.auth",["ngCordova","mellonapp.api"]).constant("AUTH_EVENTS",{notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized",serviceUnavailable:"service-unavailable",serviceAvailable:"service-available"}).constant("LOGIN_PROVIDERS",{password:1,facebook:2}).service("AuthService",["CacheFactory","$q","$rootScope","$localStorage","$injector","$timeout","LOGIN_PROVIDERS","FB","$cordovaFacebook","$ionicLoading","$log","ApiLogin","ApiSettings","ApiCommon","FBPermssions","NotificationCountRealtime","NotificationRealtime","MessageThreadRealtime","MessageRealtime",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m,h,v,y){function S(){var e=i.getObject(U);e&&(C(e),w=i.get(A))}function b(e,t){e.access_token||(e.access_token=$),i.setObject(U,e),C(e)}function P(e){w=e,i.set(A,w)}function C(e){L=e,R=!0,$=e.access_token,f.setBasicAuth($),n.$emit("mellon:logged")}function T(){$=void 0,w=void 0,L={},R=!1,f.unsetBasicAuth(),i.remove(U),i.remove(A)}function _(){c.getLoginStatus().then(function(e){"connected"===e.status&&c.logout()})}var $,w,E,U="user",A="fbtok",L={},R=!1,M=function(){function e(){u.show(),I(r).then(function(e){o.resolve(e)},function(e){o.reject({domain:"Mellon Login",error:e})})["finally"](function(){u.hide(),n.FBing=!1})}function i(){g.hasFullWrite(!0).then(function(t){t.result?e():(l.log("fbConnect: requesting Publish permissions"),c.login(s.scopePublish).then(function(e){e&&e.authResponse&&e.authResponse.accessToken&&e.authResponse.userID?(l.log("fbConnect: Publish permissions granted"),g.hasFull(!0),r=e):p.remoteLog("login",{msg:"FB publish request has failed",fbUserDataPublish:e})},function(e){l.log("fbConnect: Publish permissions denied by user")})["finally"](function(){e()}))},function(t){p.remoteLog("login",{msg:"FBPermssions.hasFullWrite has failed",reason:t}),e()})}var o=t.defer(),r={};return n.FBing=!0,l.log("fbConnect: requesting Read permissions"),c.login(s.scopeRead).then(function(e){l.log("fbConnect: Read permissions granted"),r=e,u.show(),a(function(){u.hide(),i()},1500)},function(e){o.reject({domain:"Facebook Connect",error:e.errorMessage})}),o.promise},I=function(e){var n=0;return e&&e.email&&e.password?n=r.password:e&&e.authResponse&&e.authResponse.accessToken&&e.authResponse.userID&&(n=r.facebook),t(function(t,i){function o(e){b(e.user),P(e.facebook_token||""),t(e.action)}switch(n){case r.password:d.login(e.email,e.password).then(o,function(e){i(e)});break;case r.facebook:d.fblogin(e,R).then(o,function(e){"logout:"===e.substring(0,7)&&(_(),e=e.substring(7)),i(e)});break;default:p.remoteLog("login",{msg:"Cannot detect login provider",creds:e}),i("AuthService: malformed credentials")}})},k=function(){return E=E?E:o.get("AutoRefresh"),t(function(t,i){E.stopAll(),d.logout().then(function(){_(),n.$emit("mellon:logout"),e.clearAll(),T(),m.closeSocket(),h.closeSocket(),v.closeSocket(),y.closeSocket(),t()},function(){i()})})},N=function(e){return t(function(t,n){function i(e){b(e),t("Login success.")}function o(e){n(e)}d.register(e.email,e.password,e.name,e.surname).then(i,o)})};return{login:I,logout:k,destroyUser:T,register:N,fbConnect:M,isAuthenticated:function(){return R},getUser:function(){return L},updateUser:b,loadUser:S,hasFBToken:function(){return angular.isDefined(w)&&""!==w},hasRegCompleted:function(){return L.phone_number_confirmed||L.facebook_id},hasAddressbookAutoupdate:function(){return angular.isDefined(L.settings)&&angular.isDefined(L.settings.addressbook_autoupdate)&&"1"===L.settings.addressbook_autoupdate}}}]).factory("AuthInterceptor",["$rootScope","$q","$log","AUTH_EVENTS","ApiUrl",function(e,t,n,i,o){return{response:function(a){return e.outOfService&&o.isApiUrl(a.config.url)&&(e.$broadcast(i.serviceAvailable),n.warn("broadcast ServiceAvailable")),a.data&&a.data.statusCode&&(401===a.data.statusCode||403===a.data.statusCode)?(a.status=a.data.statusCode,e.$broadcast({401:i.notAuthenticated,403:i.notAuthorized}[a.status],a),t.reject(a)):a||t.when(a)},responseError:function(a){return e.outOfService&&o.isApiUrl(a.config.url)&&503!==a.status&&(e.$broadcast(i.serviceAvailable),n.warn("broadcast ServiceAvailable")),e.$broadcast({401:i.notAuthenticated,403:i.notAuthorized,503:i.serviceUnavailable}[a.status],a),t.reject(a)}}}]).config(["$httpProvider",function(e){e.interceptors.push("AuthInterceptor")}]),angular.module("mellonapp.api",[]).service("ApiUrl",["$rootScope",function(e){function t(t){t?(r=c.dev,s=u.dev,window.localStorage.setItem("devhost","1")):(r=c.prod,s=u.prod,window.localStorage.removeItem("devhost")),e.devApi=t}function n(){return r+"/"+l}function i(e){return r+"/"+l+f[e]}function o(e){return r+":"+s+p[e]}function a(e){for(var t in c)if(0===e.indexOf(c[t]))return!0;return!1}var r,s,c={dev:"http://api-dev.mellonapp.com",prod:"https://api2.mellonapp.com"},u={dev:"3000",prod:"3000"},l="v1.2",d=angular.isDefined(window.localStorage.devhost);t(d);var f={ROOT:"/",API_PING:"/users/ping",USER_DETAIL:"/users",USER_LOGIN:"/users/login",USER_FB_LOGIN:"/users/login-facebook",USER_FB_ADD:"/users/add-facebook",USER_FB_CHECK_TOKEN:"/users/check-facebook-token",USER_FB_UNLINK:"/users/unlink-fb",USER_REGISTER:"/users",USER_FORGOT_PWD:"/users/forgot-password",USER_LOGOUT:"/users/logout",USER_FRIEND_LIST:"/users/get-all-friends",USER_AVATAR:"/users/avatar",USER_SETTINGS:"/users/settings",USER_CHECKMAIL:"/users/check-email",USER_CHECKPASS:"/users/check-password",USER_GET_PHONE_COUNTRY_CODES:"/users/get-phone-country-options",
USER_SET_PHONE_NUMBER:"/users/set-phone-number",USER_CONFIRM_PHONE_NUMBER:"/users/confirm-phone-number",USER_RESEND_CONFIRM_PHONE_NUMBER:"/users/resend-phone-number-confirm-token",USER_IMPORT_ADDRESS_BOOK:"/users/import-address-book",USER_REPARSE_ADDRESS_BOOK:"/users/reparse-address-book",USER_EMPTY_ADDRESS_BOOK:"/users/empty-address-book",USER_SET_HOUSTON_SCREEN:"/users/set-houston-screen",USER_SECONDLEV_CONNECTION:"/users/get-second-level-connection-info",USER_CHG_FOLLOWING:"/users/change-following",USER_CHG_FOLLOWER:"/users/change-follower",USER_CHG_BLOCK:"/users/block-follower",USER_CHG_BESTFRIEND:"/users/best-friend",USER_ALLOW_FRIEND:"/users/allow-user",USER_REPORT_FRIEND:"/users/report-follower",USER_CONTACT_US:"/users/contact-us",USER_SHOULD_RATE:"/users/should-rate",USER_RATE_FEEDBACK:"/users/rate-feedback",FOLLOW_FRIEND_REQUEST:"/follow-friend-requests",PRODUCTS_WALL:"/products/my-wall-xs",MESSAGE_THREADS:"/message-threads/get-threads",LAST_THREAD_MESSAGE:"/messages/get-last-thread-message",MESSAGES:"/messages/get-thread-messages-only-new",SEND_MESSAGE:"/messages/send-message",MY_PRODUCTS:"/products/my-products",CHECK_NEW_MY_PRODUCTS:"/products/check-new-my-products",PRODUCTS_BY_USER:"/products/get-user-products",CHECK_NEW_PRODUCTS_BY_USER:"/products/check-new-user-products",GET_CURRENCIES:"/products/get-currencies",GET_LANGUAGES:"/users/get-languages",MAIN_CATEGORIES:"/categories/get-main-categories",SUB_CATEGORIES:"/categories/get-subcategories",PRODUCT_CONDITIONS:"/products/get-conditions",PRODUCT_SHIPPING_TYPES:"/products/get-shipping-type-options",PRODUCT_PAYMENT_TYPES:"/products/get-payment-types",PRODUCT_CREATE:"/products",FIRST_LEVEL_FRIENDS:"/users/get-following-first-level",FRIEND_CONNECTION_LEVEL:"/users/get-connection-level",NOTIFICATIONS:"/users/get-notifications",NOTIFICATIONS_TAB_LIST:"/notifications/get-notifications-tab-list",SET_NOTIFICATION_READ:"/notifications/set-notification-read",SET_NOTIFICATION_TYPE_READ:"/notifications/set-notification-type-read",SET_NOTIFICATION_MESSAGE_THREAD_READ:"/notifications/set-notification-message-thread-read",COUNT_NOTIFICATIONS:"/notifications/count-new-notifications",GET_PRODUCT:"/products/",CHECK_NEW_WALL_PRODUCTS:"/products/check-new-wall-products",PRODUCT_UPDATE:"/products/",SELL_PRODUCT:"/products/sell-product",PRODUCT_PUBLISH:"/products/publish",PRODUCT_UNPUBLISH:"/products/unpublish",PRODUCT_DELETE:"/products/",PRODUCT_SET_SOLD:"/products/set-sold",PRODUCT_SET_UNSOLD:"/products/set-unsold",PRODUCT_REPORT:"/products/report",PRODUCT_SAVE_VIEW:"/products/save-view/",ORDER_PREPARE_PAYMENT:"/orders/prepare-payment",ORDER_PREPARE_PAYMENT_BY_REQUEST:"/orders/prepare-payment-by-request",ORDER_CHECK_PAYMENT:"/orders/check-payment-status",ORDER_DO_PAYMENT:"/orders/do-payment",ORDER_SET_PAYMENT_CANCELED:"/orders/set-payment-canceled",ORDER_GET_FEES:"/orders/get-fees",GET_FAQS:"/faqs",FAQ_SET_VIEW:"/faqs/set-faq-view",TEXT_INTRO:"/texts/intro",TEXT_WALL_BASILICATA_MODAL:"/texts/wall-basilicata-modal",TEXT_FRIENDS_BASILICATA_MODAL:"/texts/friends-basilicata-modal",TEXT_REGISTRATION_WELCOME:"/texts/registration-welcome",REMOTE_LOGS_SAVE:"/remote-logs/save"},p={NOTIFICATION:"/notification",NOTIFICATIONS_COUNT:"/notifications-count",MESSAGE_THREAD:"/message-thread",MESSAGE:"/message"};return{setDevRoot:t,getRoot:n,get:i,getSocket:o,isApiUrl:a}}]).service("ApiRoot",["$log","ApiUrl",function(e,t){return{log:function(){e.debug(t.get("ROOT"))}}}]).service("ApiSettings",["$http","$log",function(e,t){function n(n){t.debug("SETTING AUTHORIZATION HEADER"),e.defaults.headers.common.Authorization="Basic "+btoa(n+":")}function i(){e.defaults.headers.common.Authorization=void 0}return{setBasicAuth:n,unsetBasicAuth:i}}]).service("ApiUtils",["$q","$http","$log","ApiUrl",function(e,t,n,i){function o(){return e(function(e,n){t.get(i.get("API_PING")).then(function(t){e(t)},function(){n($translate.instant("Server call failed!"))})})}return{apiPing:o}}]).service("ApiLogin",["$q","$http","$log","$translate","ApiUrl",function(e,t,n,i,o){function a(n,a){return e(function(e,r){t.post(o.get("USER_LOGIN"),{email:n,password:a}).then(function(t){var n=t.data;n.success?n.data.success?e(n.data):r(i.instant("Login failed")):r(i.instant("API call failed"))},function(){r(i.instant("Server call failed!"))})})}function r(){return e(function(e,n){t.get(o.get("USER_LOGOUT")).then(function(t){e()},function(){n(i.instant("Server call failed!"))})})}function s(n,a){return e(function(e,r){var s=angular.fromJson({facebook_id:n.authResponse.userID,facebook_token:n.authResponse.accessToken}),c=o.get(a?"USER_FB_ADD":"USER_FB_LOGIN");t.post(c,s).then(function(t){var n=t.data;if(n.success)if(n.data.success)e(n.data);else{var o=n.data.message;o=a?"logout:"+o:o,r(o)}else r(i.instant("API call failed"))},function(){r(i.instant("Server call failed!"))})})}function c(n){return e(function(e,a){t.post(o.get("USER_FORGOT_PWD"),{email:n}).then(function(t){var n=t.data;n.success?n.data.success?e():a(i.instant("Not present.")):a(i.instant("API call failed"))},function(){a(i.instant("Server call failed!"))})})}function u(n,a,r,s){return e(function(e,c){t.post(o.get("USER_REGISTER"),{email:n,password:a,name:r,surname:s}).then(function(t){var n=t.data;n.success?e(n.data):c(i.instant("Registration failed!"))},function(){c(i.instant("Server call failed!"))})})}function l(){return e(function(e,n){t.get(o.get("USER_FB_CHECK_TOKEN")).then(function(t){var i=t.data.data===!1;i?e():n()},function(){n(i.instant("Server call failed!"))})})}function d(n){return e(function(e,a){t.post(o.get("USER_CHECKMAIL"),{email:n}).then(function(t){var n=t.data;n.data.success?e():a(n.data.error)},function(){a(i.instant("Server call failed!"))})})}function f(n){return e(function(e,a){t.post(o.get("USER_CHECKPASS"),{password:n}).then(function(t){var n=t.data;n.data.success?e():a(n.data.error)},function(){a(i.instant("Server call failed!"))})})}function p(){return e(function(e,n){T.length?e(T):t.get(o.get("USER_GET_PHONE_COUNTRY_CODES")).then(function(t){var i=t.data;i.success?(T=i.data,e(T)):n()},function(){n(i.instant("Server call failed!"))})})}function g(n,a){return e(function(e,r){t.post(o.get("USER_SET_PHONE_NUMBER"),{phone_country_id:n,phone_number:a}).then(function(t){var n=t.data;n.success?e(n.data):r(n.data[0].message)},function(){r(i.instant("Server call failed!"))})})}function m(){return e(function(e,a){t.get(o.get("USER_RESEND_CONFIRM_PHONE_NUMBER")).then(function(t){var i=t.data;i.success===!0&&i.data.success===!0?(n.debug("resendPhoneConfirmationCode"),e()):a()},function(){a(i.instant("Server call failed!"))})})}function h(n){return e(function(e,a){t.post(o.get("USER_CONFIRM_PHONE_NUMBER"),{token:n}).then(function(t){var n=t.data;n.success?1===n.data.phone_number_confirmed?e(n.data):a("Verification code not valid."):a(i.instant("API call failed"))},function(){a(i.instant("Server call failed!"))})})}function v(a){return e(function(e,r){t.post(o.get("USER_IMPORT_ADDRESS_BOOK"),{address_book:a}).then(function(t){var o=t.data;o.success?(n.log("Address Book Imported"),n.debug(o.data),e(o.data)):r(i.instant("API call failed"))},function(){r(i.instant("Server call failed!"))})})}function y(){return e(function(e,n){t.get(o.get("USER_REPARSE_ADDRESS_BOOK")).then(function(t){var o=t.data;o.data?e():n(i.instant("API reparseAddressBook: Api call failed"))},function(){n(i.instant("API reparseAddressBook: Server call failed!"))})})}function S(){return e(function(e,n){t.get(o.get("USER_EMPTY_ADDRESS_BOOK")).then(function(t){var o=t.data;o.success?e(o.data):n(i.instant("API emptyAddressBook: Api call failed"))},function(){n(i.instant("API emptyAddressBook: Server call failed!"))})})}function b(){return e(function(e,a){t.get(o.get("USER_SET_HOUSTON_SCREEN")).then(function(t){var o=t.data;o.success&&o.data.success?e():(n.debug("Error: Houston Seen Screen not set."),a(i.instant("Api call failed")))},function(){a(i.instant("Server call failed!"))})})}function P(){return e(function(e,n){t.get(o.get("USER_SHOULD_RATE")).then(function(t){var o=t.data;o.success?e(o.data.success?o.data.id:-1):n(i.instant("Api call failed"))},function(){n(i.instant("Server call failed!"))})})}function C(n,a){return e(function(e,r){t.post(o.get("USER_RATE_FEEDBACK"),{id:n,result:a}).then(function(t){t.data;e()},function(){r(i.instant("Server call failed!"))})})}var T=[];return{login:a,logout:r,fblogin:s,forgotPWD:c,fbCheckBadToken:l,register:u,checkUserMail:d,checkPwdPolicy:f,getPhoneCountryCodes:p,setPhoneNumber:g,resendPhoneConfirmationCode:m,confirmPhoneNumber:h,importAddressBook:v,reparseAddressBook:y,setSeenHoustonScreen:b,emptyAddressBook:S,shouldRateApp:P,rateFeedback:C}}]),angular.module("mellonapp").service("InviteService",["$window","$localStorage","$log","$cordovaFacebook","$rootScope","$translate","AuthService","Language","$cordovaGoogleAnalytics",function(e,t,n,i,o,a,r,s,c){function u(){p={subject:a.instant("Mellon, a new app you may really like"),text:a.instant("Take a look at this app for making deals just with your friends and their friends. Available for iOS and Android here:")+"%0Ahttp://discover.mellonapp.com%0A%0A"+a.instant("Cheers")+",%0A{{user}}",url:"http://discover.mellonapp.com"}}function l(){g=!0,t.set("has_invited","1")}function d(){return angular.isDefined(g)?g:void(g=!!parseInt(t.get("has_invited","0")))}function f(e){return e.replace("{{user}}",r.getUser().name)}var p;u(),o.$on("$translateChangeSuccess",function(){u()});var g,m=function(){c.trackEvent("invite","click","facebook");var e="?"+s.get();i.appInvite({url:"https://public.mellonapp.com/app_invite/applinks.html"+e,picture:"https://public.mellonapp.com/app_invite/appinvite.png"+e}).then(function(e){n.debug("FB invite OK:"),n.debug(e)},function(e){n.debug("FB invite KO: "),n.debug(e)}),l()},h=function(){c.trackEvent("invite","click","fbmessenger"),i.showDialog({method:"send",caption:"Mellon",link:p.url,description:f(p.text)}).then(function(e){n.debug("FB messenger OK: "+e)},function(e){n.debug("FB messenger ERR: "+e)}),l()},v=function(){c.trackEvent("invite","click","whatsapp"),e.open("whatsapp://send?text="+f(p.text)+"%0A%0A"+p.url,"_system"),l()},y=function(){c.trackEvent("invite","click","email"),e.open("mailto:?subject="+p.subject+"&body="+f(p.text),"_system"),l()},S=function(){c.trackEvent("invite","click","sms"),ionic.Platform.isAndroid()?e.open("sms:?body="+encodeURIComponent(f(p.text)),"_system"):ionic.Platform.isIOS()?ionic.Platform.version()>=8?e.open("sms:&body="+encodeURIComponent(f(p.text)),"_system"):e.open("sms:;body="+encodeURIComponent(f(p.text)),"_system"):e.open("sms:?body="+encodeURIComponent(f(p.text)),"_system"),l()};return{Facebook:m,FBmessenger:h,Whatsapp:v,Email:y,SMS:S,hasInvited:d}}]),angular.module("mellonapp").service("Push",["PARSE","$http","$log","$state","$rootScope","$cordovaDialogs","$ionicHistory","AuthService",function(e,t,n,i,o,a,r,s){function c(i,o){var a,r=s.getUser().id;a=angular.isDefined(window.localStorage.devhost)?e.dev:e.prod;var c={deviceType:i,deviceToken:o,installationId:e.parseInstallationId,userDevice:"mellonId"+r,channels:["mellon"]};ionic.Platform.isAndroid()&&(c.pushType="gcm",c.GCMSenderId="78044973348"),n.debug(c);var u={"X-Parse-Application-Id":a.parse_appkey,"X-Parse-REST-API-Key":a.parse_restkey,"Content-Type":"application/json"};t({url:"https://api.parse.com/1/installations",method:"POST",data:c,headers:u}).success(function(e,t){a.installation=e,n.debug("Registered in Parse for push notifications")}).error(function(e,t){n.error("Error storing device token."+e+" "+t)})}var u={},l=function(e){return PushNotification.init(e)},d=function(e,t){var n=angular.extend({},t,v);e.on("registration",n.registration),e.on("notification",n.notification),e.on("error",n.error)},f=function(e){n.debug("Push registration start"),n.debug(e);var t;ionic.Platform.isAndroid()?t="android":ionic.Platform.isIOS()&&(t="ios"),n.debug("Registered for push notifications"),c(t,e.registrationId)},p=function(e){if(console.log(e),0==e.additionalData.foreground){switch(r.nextViewOptions({disableAnimate:!0,historyRoot:!0}),e.additionalData.type){case"message":u={state:"main.messages",params:{userId:e.additionalData.paramKey}};break;case"new-friend":case"link-friend":case"follow-friend-request":case"new-deal":u={state:"main.friend-detail",params:{friendId:e.additionalData.paramKey}}}console.log("$rootScope.$emit('pushNotification', pushNotificationStateParams)"),o.$emit("pushNotification",u)}},g=function(e){n.debug("Push error callback"),n.debug(e)},m=function(){return u},h=function(e){u=e},v={registration:f,notification:p,error:g};return{register:l,callbacksInit:d,getPushNotificationStateParams:m,setPushNotificationStateParams:h}}]),angular.module("mellonapp").service("CommonService",["$log","$rootScope","$q","$timeout","AuthService","ApiCommon","$translate","$localStorage",function(e,t,n,i,o,a,r,s){function c(){u=[{name:r.instant("Sales"),id:1,code:"sale",menuLabel:r.instant("Sell"),filterLabel:r.instant("Sales"),chatLabel:r.instant("buy")},{name:r.instant("Rentals"),id:2,code:"rent",menuLabel:r.instant("Rent"),filterLabel:r.instant("Rentals"),chatLabel:r.instant("rent")},{name:r.instant("Gifts"),id:3,code:"gift",menuLabel:r.instant("Give Away"),filterLabel:r.instant("Freebies"),chatLabel:r.instant("get it")},{name:r.instant("Lend"),id:4,code:"lend",menuLabel:r.instant("Lend"),filterLabel:r.instant("Freebies"),chatLabel:r.instant("borrow")}],o.isAuthenticated&&i(function(){g(),h(),b(),T(),w()})}var u;t.$on("$translateChangeSuccess",function(){c()});var l=function(){return e.debug("Transaction TYPES"),e.debug(u),u},d=[],f=[],p=function(e){return"undefined"==typeof e&&(e=0),n(!d.length||e?function(e,t){g().then(function(t){e(t)})}:function(e,t){e(d)})},g=function(){return n(function(e,t){a.getMainCategories().then(function(t){d=t,e(t)},function(e){t(r.instant("Main categories find error: errorMsg",{errorMsg:e}))})})},m=function(e){return"undefined"==typeof e&&(e=0),n(!f.length||e?function(e,t){h().then(function(t){e(t)})}:function(e,t){e(f)})},h=function(){return n(function(e,t){a.getAllSubCategories().then(function(t){f=t,e(t)},function(e){t(r.instant("All Subcategories find error: errorMsg",{errorMsg:e}))})})},v=function(e){return n(function(t,n){a.getSubCategories(e).then(function(e){subCategories=e,t(e)},function(e){n(r.instant("Subcategories find error: errorMsg",{errorMsg:e}))})})},y=[],S=function(e){return"undefined"==typeof e&&(e=0),n(!y.length||e?function(e,t){b().then(function(t){e(t)})}:function(e,t){e(y)})},b=function(){return n(function(e,t){a.getProductConditions().then(function(t){y=t,e(t)},function(e){t(r.instant("Product conditions find error: errorMsg",{errorMsg:e}))})})},P=[],C=function(e){return"undefined"==typeof e&&(e=0),n(!P.length||e?function(e,t){T().then(function(t){e(t)})}:function(e,t){e(P)})},T=function(){return n(function(e,t){a.getShippingTypes().then(function(t){P=t,e(t)},function(e){t(r.instant("Shipping types find error: errorMsg",{errorMsg:e}))})})},_=[],$=function(e){return"undefined"==typeof e&&(e=0),n(!_.length||e?function(e,t){w().then(function(t){e(t)})}:function(e,t){e(_)})},w=function(){return n(function(e,t){a.getPaymentTypes().then(function(t){_=t,e(t)},function(e){t(r.instant("Payment types find error: errorMsg",{errorMsg:e}))})})},E=[],U=function(e){return"undefined"==typeof e&&(e=0),n(!E.length||e?function(e,t){A().then(function(t){e(t)})}:function(e,t){e(E)})},A=function(){return n(function(e,t){a.getLanguages().then(function(t){E=t,e(t)},function(e){t(r.instant("Languages find error: errorMsg",{errorMsg:e}))})})},L=[],R=function(e){return"undefined"==typeof e&&(e=0),n(!L.length||e?function(e,t){M().then(function(t){e(t)})}:function(e,t){e(L)})},M=function(){return n(function(e,t){a.getCurrencies().then(function(t){L=t,e(t)},function(e){t(r.instant("Currencies find error: errorMsg",{errorMsg:e}))})})},I=function(e){return n(function(t,n){a.setUserSetting(e).then(function(e){e.success?(o.updateUser(e.user),t(e)):n(r.instant("API call failed"))},function(e){n(e)})})},k=function(e,t){return n(function(n,i){a.setUserDetail(e,t).then(function(e){o.updateUser(e),n(e)},function(e){i(e)})})},N=function(){return n(function(e,t){a.setUserUnlinkFb().then(function(t){t.success&&o.updateUser(t.user),e(t)},function(e){t(e)})})},O=function(e){return n(function(t,n){a.deleteAccount(e).then(function(e){e.success},function(e){n(e)})})},D=function(e){return n(function(t,n){a.contactUs(e).then(function(e){e.success&&t(e)},function(e){n(e)})})},F=[],B=function(e){return"undefined"==typeof e&&(e=0),n(!F.length||e?function(e,t){x().then(function(t){e(t)})}:function(e,t){e(F)})},x=function(){return n(function(e,t){a.getFaqs().then(function(t){F=t,e(t)},function(e){t(r.instant("Faqs find error: errorMsg",{errorMsg:e}))})})},W=function(t){return n(function(n,i){a.updateFaqViews(t).then(function(t){e.debug(t),n(t)},function(e){i(e)})})};return c(),{getTransactionTypes:l,getMainCategories:p,findMainCategories:g,getAllSubCategories:m,findAllSubCategories:h,findSubCategories:v,getProductConditions:S,findProductConditions:b,getShippingTypes:C,findShippingTypes:T,getPaymentTypes:$,findPaymentTypes:w,getCurrencies:R,findCurrencies:M,getLanguages:U,findLanguages:A,setUserSetting:I,setUserDetail:k,setUserUnlinkFb:N,deleteAccount:O,contactUs:D,getFaqs:B,findFaqs:x,updateFaqViews:W}}]),angular.module("mellonapp.api").service("ApiCommon",["$q","$http","ApiUrl","$translate","appInfo","$log","$injector",function(e,t,n,i,o,a,r){function s(){return e(function(e,o){t.get(n.get("MAIN_CATEGORIES")).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get main categories"))},function(){o(i.instant("Server call failed!"))})})}function c(){return e(function(e,o){t.get(n.get("SUB_CATEGORIES")).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get all subcategories"))},function(){o(i.instant("Server call failed!"))})})}function u(o){return e(function(e,a){t.get(n.get("SUB_CATEGORIES")+"/"+o).then(function(t){t.data.success?e(t.data.data):a(i.instant("Cannot get subcategories"))},function(){a(i.instant("Server call failed!"))})})}function l(){return e(function(e,o){t.get(n.get("PRODUCT_CONDITIONS")).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get product conditions"))},function(){o(i.instant("Server call failed!"))})})}function d(){return e(function(e,o){t.get(n.get("PRODUCT_SHIPPING_TYPES")).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get product shipping types"))},function(){o(i.instant("Server call failed!"))})})}function f(){return e(function(e,o){t.get(n.get("PRODUCT_PAYMENT_TYPES")).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get product payment types"))},function(){o(i.instant("Server call failed!"))})})}function p(){return e(function(e,o){t.get(n.get("GET_CURRENCIES")).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get currencies"))},function(){o(i.instant("Server call failed!"))})})}function g(){return e(function(e,o){t.get(n.get("GET_LANGUAGES")).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get languages"))},function(){o(i.instant("Server call failed!"))})})}function m(o){return e(function(e,a){t.post(n.get("USER_SETTINGS"),o).then(function(t){t.data.success?e(t.data.data):a(i.instant("Cannot set settings."))},function(){a(i.instant("Server call failed!"))})})}function h(o,a){return e(function(e,r){t.put(n.get("USER_DETAIL")+"/"+o,a).then(function(t){t.data.success?e(t.data.data):r(i.instant("Cannot set settings."))},function(){r(i.instant("Server call failed!"))})})}function v(){return e(function(e,o){t.get(n.get("USER_FB_UNLINK")).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot unlink Facebook."))},function(){o(i.instant("Server call failed!"))})})}function y(o){return e(function(e,r){t["delete"](n.get("USER_DETAIL")+"/"+o).then(function(t){t.data.success?e(t.data.data):(r(i.instant("Cannot unlink Facebook.")),a.debug(t.data))},function(){r(i.instant("Server call failed!"))})})}function S(o){return e(function(e,a){t.post(n.get("USER_CONTACT_US"),o).then(function(t){t.data.success?e(t.data):a(i.instant("Failed."))},function(){a(i.instant("Server call failed!"))})})}function b(){return e(function(e,o){t.get(n.get("GET_FAQS")).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get faqs"))},function(){o(i.instant("Server call failed!"))})})}function P(o){return e(function(e,a){t.post(n.get("FAQ_SET_VIEW"),o).then(function(t){t.data.success?e(t.data.data):a(i.instant("Cannot update faq views."))},function(){a(i.instant("Server call failed!"))})})}function C(n,i){var a=r.get("ApiUrl"),s=r.get("AuthService"),c=s.getUser(),u={appver:o.versionNumber,apiroot:a.getRoot(),platform:ionic.Platform.platform()+" "+ionic.Platform.version(),device:ionic.Platform.device()};c&&(u.user={id:c.id,access_token:c.access_token});var l={type:n,data:i,context:u};return e(function(e,n){t.post(a.get("REMOTE_LOGS_SAVE"),l).then(function(t){var n=t.data;e(n.data.status)},function(){n()})})}return{getMainCategories:s,getAllSubCategories:c,getSubCategories:u,getProductConditions:l,getShippingTypes:d,getPaymentTypes:f,getCurrencies:p,getLanguages:g,setUserSetting:m,setUserDetail:h,setUserUnlinkFb:v,deleteAccount:y,contactUs:S,getFaqs:b,updateFaqViews:P,remoteLog:C}}]),angular.module("mellonapp").controller("MainCtrl",["$scope","$ionicActionSheet","$state","CommonService","$translate",function(e,t,n,i,o){e.showSellActionSheet=function(){var e=[];angular.forEach(i.getTransactionTypes(),function(t){e.push({text:t.menuLabel,view:"main.sell",viewparam:t.id})}),e.push({text:o.instant("Saved Drafts"),view:"main.saved-drafts",viewparam:!1});t.show({buttons:e,cancelText:o.instant("Cancel"),cancel:function(){},buttonClicked:function(e){return this.buttons[e].viewparam?n.go(this.buttons[e].view,{transactionTypeId:this.buttons[e].viewparam}):n.go(this.buttons[e].view),!0}})},e.goToWall=function(){n.is("main.wall")||n.go("main.wall",{search:""})}}]),angular.module("mellonapp").controller("LoginCtrl",["$scope","$state","$timeout","$stateParams","$cordovaDialogs","$ionicHistory","$ionicLoading","$log","AuthService","$localStorage","$rootScope","ApiUrl","ApiLogin","ApiRoot","Language","$translate","DEBUG","introText",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m,h,v){e.$on("$ionicView.enter",function(){function n(e){return"false"===e&&(e=!1),e||!1}switch(l.hideTabs=!0,e.introText=v,e.returnOKState=n(i.returnOKState),e.returnCancelState=n(i.returnCancelState),s.debug("$stateParams.returnOKState: "+i.returnOKState),s.debug("$stateParams.returnCancelState: "+i.returnCancelState),s.debug("returnOKState: "+e.returnOKState),s.debug("returnCancelState: "+e.returnCancelState),t.current.name){case"intro":e.devTapCount=10,a.clearCache(),a.clearHistory();break;case"forgot-pwd":e.resetEmail=i.email}}),e.toggleDevApi=function(){h&&(e.devTapCount-=1,s.debug(e.devTapCount+" taps remaing..."),e.devTapCount||(e.devTapCount=10,o.prompt(" ","Do you know what to do...",["OK","Cancel"],"").then(function(e){var t=e.input1,n=e.buttonIndex;if(s.debug(n),1===n&&"capuzzella"===t){var i=!angular.isDefined(u.get("devhost"));d.setDevRoot(i),s.debug(i?"Dev API":"Production API"),p.log(),o.alert("You are now using "+(i?"DEV":"PRODUCTION")+" API","API","OK")}})))},e.data={},e.logout=function(){c.logout()},e.login=function(n,i){i=angular.isUndefined(i)?null:i,n.email&&n.password?(n.email=n.email.trim(),n.password=n.password.trim(),c.login(n).then(function(n){g.set(),e.data={},i=angular.isString(i)?i:"main.wall",t.go(i,{},{reload:!0})},function(e){s.debug("Login failed!"),o.alert(e,m.instant("Ooops! Login failed"),"OK")})):o.alert(m.instant("Please fill in all fields."),"Login","OK")},e.FBlogin=function(e){e=angular.isUndefined(e)?null:e,c.fbConnect().then(function(i){if(g.set(),angular.isString(e))t.go(e,{},{reload:!0});else switch(i){case"create":n(function(){t.go("register-phonenumber",{},{reload:!0})});break;case"login":default:n(function(){t.go("main.wall",{},{reload:!0})})}},function(e){o.alert(e.error,m.instant("Ooops! Login failed")+" ("+e.domain+").",m.instant("OK"))})},e.forgotPWD=function(e){e.trim().length?(r.show(),f.forgotPWD(e).then(function(){o.alert(m.instant("We've sent you an email. Please check your mailbox (even SPAM!)"),m.instant("Password reset"),m.instant("OK")).then(function(){t.go("access.login")})},function(e){s.debug("Password recovery failed: "+e)})["finally"](function(){r.hide()})):o.alert(m.instant("Please fill in the required field "),m.instant("Reset password"),m.instant("OK"))}}]).controller("RegisterCtrl",["$rootScope","$window","$stateParams","$scope","$state","$cordovaDialogs","$ionicLoading","$ionicHistory","$q","$log","$localStorage","ApiLogin","AuthService","SIM","AddressBook","AppInstalled","InviteService","phoneCountryCodes","CommonService","$translate","welcomeText","REG_START_STATE",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m,h,v,y,S,b,P){function C(){var e=v;i.cCodes=e,p.query().then(function(t){for(var n in e)if(e[n].iso==t.countryCode){i.countryCodeId=e[n].id;break}i.phoneNumber=""})}function T(e){var t=e.name.length<=1,n=e.surname.length<=1,i=[];return t&&i.push(S.instant("Your First Name is too short.")),n&&i.push(S.instant("Your Surname is too short.")),i.length&&a.alert(i.join("\n"),S.instant("Oops, Something went wrong!"),S.instant("OK")),!i.length}i.data={},i.firstPage=!0;var _=!1;i.welcomeText=b,i.$on("$ionicView.beforeEnter",function(){function t(e){return"false"===e&&(e=!1),e||!1}switch(e.hideTabs=!0,r.hide(),i.returnOKState=t(n.returnOKState),i.returnCancelState=t(n.returnCancelState),u.debug("$stateParams.returnOKState: "+n.returnOKState),u.debug("$stateParams.returnCancelState: "+n.returnCancelState),u.debug("returnOKState: "+i.returnOKState),u.debug("returnCancelState: "+i.returnCancelState),_=f.hasFBToken(),i.hasFBLogin=_,C(),o.current.name){case"register-addressbook":i.phonenumber=f.getUser().phone_number_normalized;break;case"register-facebook":u.debug(n)}}),i.doBlur=function(e,t){var n=e.target;4===t.length&&n.blur()},i.goIntro=function(){o.go("intro")},i.openContactsPrefs=function(){e.isIOS&&(l.set("iosPrefsContacts","1"),t.open("prefs:root=Privacy&path=CONTACTS","_system"))},i.logout=function(){f.logout()["finally"](function(){o.go("intro")})};var $=!1;i.register=function(e){$||($=!0,T(e)&&(r.show(),f.register(e).then(function(e){i.data={},o.go(P,{},{reload:!0})},function(e){a.alert(S.instant("Please check your data!"),S.instant("Registration failed!"),S.instant("OK"))})["finally"](function(){r.hide(),$=!1})))},i.validateCreds=function(e){r.show();var t=[],n=c.defer(),o=c.defer();d.checkUserMail(e.email)["catch"](function(e){t.push(e)})["finally"](function(){n.resolve()}),d.checkPwdPolicy(e.password)["catch"](function(e){t.push(e)})["finally"](function(){o.resolve()}),c.all([n.promise,o.promise]).then(function(){t.length?a.alert(t.join("\n"),S.instant("Oops, Something went wrong!"),S.instant("OK")):i.firstPage=!1,r.hide()})},i.sendPhoneNumber=function(e,t){r.show(),d.setPhoneNumber(e,t).then(function(e){f.updateUser(e),i.canVerify=!0,o.go("register-addressbook",{returnOKState:i.returnOKState,returnCancelState:i.returnCancelState})},function(e){a.alert(e,S.instant("Phone number"),S.instant("OK"))})["finally"](function(){r.hide()})},i.resendPhoneConfirmationCode=function(){a.confirm(S.instant("Would you like to receive a new verification code?"),S.instant("Verification code"),[S.instant("Skip"),S.instant("Get code")]).then(function(e){switch(e){case 1:o.go(i.returnCancelState||"register-welcome");break;case 2:r.show(),d.resendPhoneConfirmationCode().then(function(){},function(e){a.alert(S.instant("Error: Cannot resend verification code"),S.instant("Verification code"),S.instant("OK"))})["finally"](function(){r.hide()})}})},i.verifyAndImport=function(e){var t=i.returnOKState||(_?"register-welcome":"register-fb"),n=i.returnCancelState||(_?"register-welcome":"register-fb");r.show(),d.confirmPhoneNumber(e).then(function(e){f.updateUser(e),u.debug("Exporting Address Book"),g["export"]().then(function(){a.confirm(S.instant("We'll sync your phone contacts from time to time so we can always suggest new people to connect to. You can turn off syncing any time in Settings."),S.instant("Would you like us to find people to connect to?"),[S.instant("Yes"),S.instant("No, thanks")]).then(function(e){var n=1===e?"1":"0";y.setUserSetting({name:"addressbook_autoupdate",value:n})["finally"](function(){o.go(t)})})},function(e){u.debug(e),o.go(n)})["finally"](function(){r.hide()})},function(e){u.debug(e),r.hide(),a.alert(S.instant("Invalid verification code."),S.instant("Phone number"),S.instant("OK"))})},i.getPhonePrefixFromId=function(e){for(var t in i.cCodes)if(i.cCodes[t].id==e)return i.cCodes[t].phone_prefix},i.begin=function(){o.go("main.wall",{},{reload:!0}),s.clearHistory()},m.query("facebook").then(function(e){i.hasFB=e}),m.query("fb-messenger").then(function(e){i.hasFBmessenger=e}),m.query("whatsapp").then(function(e){i.hasWA=e}),i.FBinvite=function(){h.Facebook()},i.FBmesssenger=function(){h.FBmessenger()},i.WAinvite=function(){h.Whatsapp()},i.MAILinvite=function(){h.Email()},i.SMSinvite=function(){h.SMS()}}]).controller("RateCtrl",["$scope","$state","$stateParams","$window","$log","$cordovaDialogs","$translate","ApiLogin","ITUNES_ID","PACKAGE_NAME",function(e,t,n,i,o,a,r,s,c,u){e.rate=function(e){function l(e){o.debug("Rate FeedBack: "+e),s.rateFeedback(d,e),t.go(f)}var d=parseInt(n.rateId),f=d?"main.wall":"main.profile-settings";if(e){var p;p=ionic.Platform.isAndroid()?"market://details?id="+u:"itms-apps://itunes.apple.com/it/app/mellon-deals-among-friends/id"+c+"?mt=8&uo=4",i.open(p,"_system")}0!==d||e?e?l(1):a.confirm(r.instant("Your opinion on Mellon is important for us. Can we remind you in the future to rate Mellon?"),"Mellon",[r.instant("Yep, but very rarely"),r.instant("No way, and don’t ask it again!")]).then(function(e){var t=2===e?-1:0;l(t)}):t.go(f)}}]),angular.module("mellonapp").controller("WallCtrl",["$scope","$stateParams","$ionicHistory","$log","$timeout","$ionicLoading","$rootScope","$filter","$state","Wall","AuthService","CommonService","Push","Friends","InviteService","$translate","PUSH_EVENT","$ionicModal","Text",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m,h,v,y){function S(){o(function(){e.noProductString=m.instant("No one has posted any deals yet!")})}r.$on("$translateChangeSuccess",function(){S()}),S();var b=!1;e.productsList=null,e.transactionTypes=[],e.transactionTypeSelected=0,e.search={searchProductInput:"",lastSearchProductInput:""},e.userLoggedId=l.getUser().id,e.notifications=[],e.apiCurrentPage=1,e.apiPageCount=0,e.apiTotalCount=0,e.apiPerPage=0,e.apiCalling=!1,e.basilicataOverlayShown=!1,e.getNow=function(){var e=new Date;return new Date(e.getFullYear(),e.getMonth(),e.getDate())},e.$on("$ionicView.beforeEnter",function(){"undefined"!=typeof t.clearHistory&&t.clearHistory===!0&&n.clearHistory(),p.hasNoFriendsAsync().then(function(t){e.hasNoFriends=t&&0==l.getUser().friend_to_all,!e.hasNoFriends||e.basilicataOverlayShown&&+e.basilicataOverlayShown==+e.getNow()||y.getWallBasilicataModal().then(function(t){e.modalTitle=t.title,e.modalText=t.text,e.openModal(),e.basilicataOverlayShown=e.getNow()})}),i.debug("search input "+e.search.searchProductInput),"undefined"!=typeof t.search&&""!=t.search&&t.search!=e.search.searchProductInput&&(e.setSearchInput(t.search),i.debug("$stateParams.search "+t.search),i.debug("search input "+e.search.searchProductInput),e.setLastSearchInput(t.search),e.productsList=null,e.apiCurrentPage=1,e.apiPageCount=0,e.apiTotalCount=0,e.apiPerPage=0),e.transactionTypes=d.getTransactionTypes(),e.apiCalling?(i.debug("WALL beforeEnter busy - TIMEOUT"),o(function(){e.productsListBeforeEnter()},100)):e.productsListBeforeEnter()}),e.$on("$ionicView.enter",function(){r.hideTabs=!1,b||o(function(){1==h&&r.$on("pushNotification",function(e,t){o(function(){
c.transitionTo(t.state,t.params,{reload:!0,inherit:!1,notify:!0})},0)}),e.registerPush(),o(function(){if(0==h){var e=f.getPushNotificationStateParams(),t=null,n=null;Object.keys(e).length>0&&(t=e.state,n=e.params),null!==t&&c.transitionTo(t,n,{reload:!0,inherit:!1,notify:!0}),f.setPushNotificationStateParams({})}},0)},0)}),e.productsListBeforeEnter=function(){e.productsList&&e.productsList.length&&!u.isCacheEmpty()?e.checkNewWallProducts().then(function(t){t&&e.apiWallBeforeEnter(!0)},function(e){}):e.apiWallBeforeEnter()},e.apiWallBeforeEnter=function(t){t="undefined"!=typeof t?t:!1,e.apiCalling=!0,a.show(),e.apiWallCall(t,1,!0,e.transactionTypeSelected,!0).then(function(t){o(function(){e.initWallTabScroll()})})["finally"](function(){a.hide(),e.apiCalling=!1})},e.setApiCounter=function(t){e.apiCurrentPage=t._meta.currentPage,e.apiPageCount=t._meta.pageCount,e.apiTotalCount=t._meta.totalCount,e.apiPerPage=t._meta.perPage},e.setProductsList=function(t){t=s("unique")(t,"id"),e.productsList=t},e.setTransactionTypeSelected=function(t){e.transactionTypeSelected=t},e.setApiCalling=function(t){e.apiCalling=t},e.setSearchInput=function(t){e.search.searchProductInput=t},e.setLastSearchInput=function(t){e.search.lastSearchProductInput=t},e.apiWallCall=function(t,n,o,a,r){return u.update(t,n,o,a,e.apiPerPage,e.search.searchProductInput).then(function(t){return i.debug("WALL apiWallCall data.fromCache "+t.fromCache),r&&(e.productsList=t.items,e.setApiCounter(t)),t},function(e){return e})},e.checkNewWallProducts=function(){return u.checkNewWallProducts(u.getLastUpdateTime(e.transactionTypeSelected,e.search.searchProductInput),e.transactionTypeSelected,e.apiPerPage,e.search.searchProductInput).then(function(e){return e.newElements>0},function(e){return e})},e.emptyWallCache=function(){u.emptyCache()},e.registerPush=function(){var e={};ionic.Platform.isAndroid()?e={android:{senderID:"78044973348",icon:"www/img/notification_icon.png"}}:ionic.Platform.isIOS()&&(e={ios:{alert:"true",badge:!0,clearBadge:!0}});var t=f.register(e);f.callbacksInit(t),b=!0},e.updateSlider=function(){},v.fromTemplateUrl("templates/wall-basilicata-modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.openModal=function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!1),e.modal.show()},e.closeModal=function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),e.modal.hide()},e.$on("modal.hidden",function(){}),e.$on("modal.removed",function(){})}]),angular.module("mellonapp").service("Wall",["$q","$log","ApiProduct","CacheFactory","CommonService",function(e,t,n,o,a){var r=a.getTransactionTypes();for(o("ApiProductCache",{maxAge:9e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive"}),i=0;i<r.length;i++)o("ApiProductCache"+i,{maxAge:9e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive"});var s={},c=function(){return s},u=function(t,i,a,r,s,c){return e(function(e,u){t="undefined"!=typeof t?t:!1,i="undefined"!=typeof i?i:1,a="undefined"!=typeof a?a:!0,r="undefined"!=typeof r?r:0,c="undefined"!=typeof c?c:"",(i>1||c)&&(t=!0),s="undefined"!=typeof s?s:0;var l=o.get("ApiProductCache"+(r?r:""));if(t||l.info().size<=0)d(i,a,r,c,e,u);else{var p=f(r,c);n.checkNewWallProducts(p,r,s,c).then(function(t){if(t.newElements>0)d(i,a,r,c,e,u);else{var t=l.get("wallCache");t.fromCache=!0,e(t)}},function(e){u("Cannot check new products - error: "+e)})}})},l=function(t,i,o,a){return i="undefined"!=typeof i?i:0,o="undefined"!=typeof o?o:0,a="undefined"!=typeof a?a:"",e(function(e,r){n.checkNewWallProducts(t,i,o,a).then(function(t){e(t)},function(e){r("Wall update error: "+e)})})},d=function(e,i,a,r,c,u){n.getWall(["user","media","currency"],e,i,a,r).then(function(i){if(1==e&&!r){var u=o.get("ApiProductCache"+(a?a:""));u.put("wallCache",i)}i.fromCache=!1,s=i,t.log(n.getUpdateTime(a,r)+" "+moment.unix(n.getUpdateTime(a,r)/1e3).format("MMMM Do YYYY, HH:mm:ss")),c(i)},function(e){u("Wall update error: "+e)})},f=function(e,t){var i=n.getUpdateTime(e,t);return i>0?Math.floor(i/1e3):0},p=function(){},g=function(i){return e(function(e,o){n.getProduct(i,["user","transactionType","condition","currency","purchaseRequest"]).then(function(n){t.debug("Wall getDetail resolve da service"),e(n)},function(e){o(e)})})},m=function(t,i){return e(function(e,o){var a=!1;if(void 0!==s.items)for(var r=0;r<s.items.length;r++)s.items[r].id===parseInt(t)&&(a=r,i?(s.items[r]=i,e(!0)):n.getProduct(t,["user","transactionType","condition","currency","purchaseRequest"]).then(function(t){s.items[a]=t,e(!0)},function(e){o(e)}));a||e(!0)})},h=function(e){if(void 0!==s.items)for(var t=0;t<s.items.length;t++)s.items[t].id===parseInt(e)&&s.items.splice(t,1)},v=function(){var e=o.get("ApiProductCache");for(e.remove("wallCache"),i=0;i<r.length;i++){var e=o.get("ApiProductCache"+i);e.remove("wallCache")}},y=function(){var e=o.get("ApiProductCache");return!(e.info().size>0)};return{get:c,update:u,checkNewWallProducts:l,hasUpdates:p,getDetail:g,updateDetail:m,deleteDetail:h,getLastUpdateTime:f,emptyCache:v,isCacheEmpty:y}}]),angular.module("mellonapp").controller("ProfileCtrl",["$scope","$log","$timeout","$ionicLoading","$filter","$rootScope","$q","AuthService","Product","CommonService","$translate",function(e,t,n,i,o,a,r,s,c,u,l){function d(){e.noProductString=l.instant("You still haven’t published any deals. What are you waiting for? Post a Deal now!")}e.productsList=null,e.transactionTypes=[],d(),a.$on("$translateChangeSuccess",function(){d()}),e.transactionTypeSelected=0,e.apiCalling=!1,e.expand=["user","media","currency"],e.initApiCounter=function(){e.apiCurrentPage=1,e.apiPageCount=0,e.apiTotalCount=0,e.apiPerPage=0},e.initApiCounter(),e.$on("$ionicView.beforeEnter",function(i){a.hideTabs=!1,e.transactionTypes=u.getTransactionTypes(),e.user=s.getUser(),e.apiCalling?n(function(){t.debug("PROFILE beforeEnter busy"),e.productsListBeforeEnter()},100):e.productsListBeforeEnter()}),e.productsListBeforeEnter=function(){e.productsList&&e.productsList.length?e.checkNewWallProducts().then(function(t){t&&e.apiWallBeforeEnter(!0)},function(e){}):e.apiWallBeforeEnter()},e.apiWallBeforeEnter=function(t){t="undefined"!=typeof t?t:!1,i.show(),e.apiCalling=!0,e.apiWallCall(t,1,!0,e.transactionTypeSelected,!0).then(function(t){n(function(){e.initWallTabScroll()})})["finally"](function(){i.hide(),e.apiCalling=!1})},e.setApiCounter=function(t){e.apiCurrentPage=t._meta.currentPage,e.apiPageCount=t._meta.pageCount,e.apiTotalCount=t._meta.totalCount,e.apiPerPage=t._meta.perPage},e.setProductsList=function(t){t=o("unique")(t,"id"),e.productsList=t},e.setTransactionTypeSelected=function(t){e.transactionTypeSelected=t},e.setApiCalling=function(t){e.apiCalling=t},e.apiWallCall=function(t,n,i,o,a){return c.getMyProducts(t,n,o,e.apiPerPage,e.expand,[{key:"draft",value:0}]).then(function(t){return a&&(e.productsList=t.items,e.setApiCounter(t)),t},function(e){return e})},e.checkNewWallProducts=function(){return c.checkNewMyProducts(c.getLastUpdateTime(e.transactionTypeSelected,"me"),e.transactionTypeSelected,e.apiPerPage,[{key:"draft",value:0}]).then(function(e){return e.newElements>0},function(e){return e})}}]).controller("ProfileHelpCtrl",["$scope","$rootScope","CommonService","$timeout","$cordovaInAppBrowser","$sce",function(e,t,n,i,o,a){e.$on("$ionicView.beforeEnter",function(o){var r=new RegExp('(href)(=)("http:\\/\\/www\\.paypal\\.com")( )(target)(=)("blank")',["gmi"]);n.getFaqs().then(function(t){i(function(){angular.forEach(t,function(e){angular.forEach(e.children,function(e){e.answer=e.answer.replace(r,'ng-click="goToPaypalSite()"'),e.answer=a.trustAsHtml(e.answer)})})}),e.faqs=t},function(){}),t.$on("$translateChangeSuccess",function(){i(function(){n.getFaqs(!0).then(function(t){i(function(){angular.forEach(t,function(e){angular.forEach(e.children,function(e){e.answer=e.answer.replace(r,'ng-click="goToPaypalSite()"'),e.answer=a.trustAsHtml(e.answer)})})}),e.faqs=t},function(){})})})}),e.toggleFaq=function(t){e.isFaqShown(t)?e.shownFaq=null:(e.shownFaq=t,n.updateFaqViews({id:t}))},e.isFaqShown=function(t){return e.shownFaq===t},e.goToPaypalSite=function(){o.open("http://www.paypal.com","_system")}}]).controller("ProfileSettingsCtrl",["$scope","$state","$ionicHistory","$ionicLoading","$cordovaDialogs","$log","$rootScope","$cordovaInAppBrowser","$ionicModal","AuthService","CommonService","AddressBook","Product","FBPermssions","Language","$translate","appInfo","Wall",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m,h,v){e.paypalOk=!1,e.handShake=!1;var y=null;e.languages=[],e.payPalUser="",e.contactUs={description:"",platform:ionic.Platform.isIOS()?"ios":ionic.Platform.isAndroid()?"android":"",version:h.versionNumber},e.versionNumber=h.versionNumber,e.versionCode=h.versionCode,e.orderFees=[],e.$on("$ionicView.beforeEnter",function(t){if(r.hideTabs=!0,e.isIOS=ionic.Platform.isIOS(),e.isAndroid=ionic.Platform.isAndroid(),p.hasFullWrite().then(function(t){e.FBPublishAllowed=t.result}),e.user=u.getUser(),e.noSmsNotification=!0,y=e.user.paypal_account,e.payPalUser=e.user.paypal_account,l.getLanguages().then(function(t){if(e.languages=t,!e.user.language)for(var n in t)t[n].code===g.get()&&(e.user.language=angular.copy(t[n]))},function(){}),l.getCurrencies().then(function(t){if(e.currencies=t,angular.isUndefined(e.user.settings.currency))for(var n in t)if(t[n].is_default){e.user.settings.currency=t[n].id;break}},function(){}),angular.isDefined(e.user.settings.payment_type))for(var n=0;n<e.user.settings.payment_type.length;n++)2===e.user.settings.payment_type[n]&&null===e.user.paypal_account&&(e.user.settings.payment_type[n]=0);angular.isUndefined(e.user.settings.product_visibility_type_1)&&(e.user.settings.product_visibility_type_1=0),angular.isUndefined(e.user.settings.product_visibility_type_2)&&(e.user.settings.product_visibility_type_2=0),angular.isUndefined(e.user.settings.product_visibility_type_3)&&(e.user.settings.product_visibility_type_3=0),angular.isUndefined(e.user.settings.product_visibility_type_4)&&(e.user.settings.product_visibility_type_4=0),angular.isUndefined(e.user.settings.allow_posting_on_facebook)&&(e.user.settings.allow_posting_on_facebook="1"),angular.isUndefined(e.user.settings.animated_gif_on_facebook)&&(e.user.settings.animated_gif_on_facebook="1"),f.getOrderFees().then(function(t){e.orderFees=t})}),e.$on("$ionicView.leave",function(t){angular.isUndefined(e.user.paypal_account)&&!angular.isUndefined(e.payPalUser)&&(e.user.paypal_account=e.payPalUser)});var S=function(){angular.isUndefined(e.user.settings.product_visibility_type_1)&&(e.user.settings.product_visibility_type_1=0),angular.isUndefined(e.user.settings.product_visibility_type_2)&&(e.user.settings.product_visibility_type_2=0),angular.isUndefined(e.user.settings.product_visibility_type_3)&&(e.user.settings.product_visibility_type_3=0),angular.isUndefined(e.user.settings.product_visibility_type_4)&&(e.user.settings.product_visibility_type_4=0)};e.setUserPayment=function(){for(var t=[],n=0;n<e.user.settings.payment_type.length;n++)0!==e.user.settings.payment_type[n]&&t.push(e.user.settings.payment_type[n]);e.setUserSetting({name:"payment_type",value:t})},e.setEmailNotification=function(t){if(0===e.user.email_notifications){o.confirm(m.instant("Do you really want to turn off email notifications? You will need to open the Mellon app to check your deals"),m.instant("Email notifications"),[m.instant("No emails please!"),m.instant("Keep sending 'em!")]).then(function(n){var i=n;1===i?e.setUserSetting(t):1===e.user.email_notifications?e.user.email_notifications=0:e.user.email_notifications=1})}else e.setUserSetting(t)},e.setLanguage=function(t){var n;l.setUserSetting({name:"language_id",value:t}).then(function(){angular.forEach(e.languages,function(e){e.id==t&&(n=e.code)}),g.set(n)},function(){})},e.setUserSetting=function(e,t){l.setUserSetting(e).then(function(n){S(),"function"==typeof t&&t(n),"hide_sold_deals"==e.name&&(v.emptyCache(),f.resetUpdateTime())},function(e){})},e.setPaypalAccount=function(){cordova.plugins.Keyboard.close(),i.show(),l.setUserDetail(e.user.id,{paypal_account:e.user.paypal_account}).then(function(t){e.user=u.getUser(),S(),i.show({template:m.instant("Saved"),templateUrl:"",duration:3e3}),e.payPalUser=e.user.paypal_account},function(t){i.hide(),o.alert(m.instant("The email address you provided is not valid. Please check it again."),m.instant("PayPal Account"),m.instant("OK")).then(function(){e.user.paypal_account=y})})},e.setUserDetail=function(t,n){l.setUserDetail(t,n).then(function(t){e.user=u.getUser(),S()},function(e){})},e.alertNoPaypal=function(){o.confirm(m.instant("You should register your PayPal account"),m.instant("Paypal Account"),[m.instant("OK"),m.instant("Not now")]).then(function(n){var i=n;1===i?t.go("main.profile-settings-paypal"):e.user.settings.payment_type[1]=0})},e.logout=function(){o.confirm(m.instant("Are you sure?"),m.instant("Logout"),[m.instant("Logout"),m.instant("Cancel")]).then(function(e){var n=e;1===n&&(i.show(),u.logout().then(function(){i.hide(),t.go("intro")}))})},e.setUserUnlinkFb=function(){o.confirm(m.instant("Do you really want to unlink your Facebook account?"),m.instant("Unlink Facebook Account"),[m.instant("OK"),m.instant("Cancel")]).then(function(n){var r=n;1===r&&(a.debug("unlinked"),l.setUserUnlinkFb().then(function(n){u.hasRegCompleted()?e.user=u.getUser():o.alert(m.instant("You don't have any other connection!"),m.instant("Mellon"),m.instant("Logout")).then(function(){i.show(),u.logout().then(function(){i.hide(),t.go("intro")})})},function(e){o.alert(m.instant("We are sorry, for some reason we can't unlink your Facebook account. Please try again later or report the problem."),m.instant("An error has occurred"))}))})},e.importAddressBook=function(){o.confirm(m.instant("Do you want to update your phone contacts now? This may require a minute."),m.instant("Update Phone Contacts"),[m.instant("Ok"),m.instant("Cancel")]).then(function(e){var t=e;1===t&&(a.debug("importing"),i.show(),a.debug("IMPORTING ADDRESS BOOK"),d["export"]().then(function(){},function(e){a.error(e)})["finally"](function(){i.hide(),o.alert(m.instant("Phone contacts update completed successfully."),m.instant("Phone contacts update"),m.instant("OK")).then(function(){})}))})},e.emptyAddressBook=function(){o.confirm(m.instant("Do you want to empty your phone contacts now?"),m.instant("Empty Phone Contacts"),[m.instant("Ok"),m.instant("Cancel")]).then(function(t){var n=t;1===n&&(i.show(),d.empty().then(function(){e.user=u.getUser()},function(e){a.error(e)})["finally"](function(){i.hide(),o.alert(m.instant("Phone contacts empty completed successfully."),m.instant("Phone contacts empty"),m.instant("OK")).then(function(){})}))})},e.deleteAccount=function(){a.debug(e.user.id),o.confirm(m.instant("LAST CHANCE: Do you really want to delete your account?"),m.instant("Delete Account Confirmation"),[m.instant("Yes, I'm sure"),m.instant("No!")]).then(function(n){var i=n;1===i&&(l.deleteAccount(e.user.id),u.logout(),t.go("intro"))})},e.goBack=function(){n.goBack()},e.goProfileNotificationsSettings=function(){t.go("main.profile-settings-notifications")},e.goProfileAdsSettings=function(){t.go("main.profile-settings-ads")},e.goCurrencyPage=function(){t.go("main.profile-settings-currency")},e.goHelpPage=function(){t.go("main.help")},e.goRate=function(){t.go("rate-mellon",{rateId:0})},e.goTermsPage=function(){t.go("terms")},e.goPrivacyPage=function(){t.go("privacy")},e.goCookiePage=function(){t.go("main.cookie")},e.goLanguagePage=function(){t.go("main.profile-settings-language")},e.goLibraryPage=function(){t.go("main.library")},e.goProfileEdit=function(){t.go("main.profile-edit")},e.goSavedDrafts=function(){t.go("main.saved-drafts")},e.goPaypalEdit=function(){t.go("main.profile-settings-paypal")},e.goDeleteAccountPage=function(){t.go("main.profile-settings-delete-account")},e.addFbFromSettings=function(){t.go("register-fb",{returnOKState:"main.profile-settings",returnCancelState:"main.profile-settings"})},e.addAddressBookFromSettings=function(){t.go("register-phonenumber",{returnOKState:"main.profile-settings",returnCancelState:"main.profile-settings"})},c.fromTemplateUrl("templates/contact-us-modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modalContactUs=t}),e.openContactUs=function(){e.contactUs.description="",e.modalContactUs.show()},e.closeModalContactUs=function(t){t.$setPristine(),e.modalContactUs.hide()},e.$on("$destroy",function(){e.modalContactUs.remove()}),e.sendContactUs=function(t){e.contactUs.description&&(i.show(),l.contactUs(e.contactUs).then(function(){i.show({template:m.instant("Your message has been sent"),templateUrl:"",duration:3e3}),e.closeModalContactUs(t)},function(e){i.show({template:m.instant("Error!"),templateUrl:"",duration:3e3})}))},e.goToPaypalSite=function(){s.open("http://www.paypal.com","_system")}}]).controller("ProfileEditCtrl",["$scope","$log","$window","$state","$cordovaDialogs","$ionicActionSheet","$rootScope","AuthService","CommonService","Camera","ImageUploadService","$q","$translate",function(e,t,n,i,o,a,r,s,c,u,l,d,f){e.$on("$ionicView.beforeEnter",function(p){function g(e){if(e.split("://").length<2&&(e="file://"+e),"content://com.android"===e.substring(0,21)){var t=e.substring(e.lastIndexOf("/")+1),n=t.split("%3A");e="image"===n[0]?"content://media/external/images/media/"+n[1]:"content://media/external/video/media/"+n[1]}return e}e.user=s.getUser(),e.$on("$ionicView.beforeEnter",function(e){r.hideTabs=!0}),e.setUserDetail=function(t,n){c.setUserDetail(t,n).then(function(t){e.user=s.getUser()},function(e){})},e.setVisibility=function(t,n){e.textPopup=1===e.user.visibility?f.instant("Everyone in your network will be able to see your deals on Mellon. You will no longer need to approve followers."):f.instant("When your account is private, only people you approve can see your deals and friends on Mellon. Do you want to proceed?");o.confirm(e.textPopup,f.instant("Change Visibility"),[f.instant("OK"),f.instant("Cancel")]).then(function(i){var o=i;1===o?e.setUserDetail(t,{visibility:n}):e.user.visibility=1===e.user.visibility?0:1})},e.checkMediaType=function(e){var i=d.defer();return e.match(/\.(jpg|png|gif)$/i)?i.resolve("image"):(t.debug("checkMediaType url "+e),n.resolveLocalFileSystemURL(e,function(e){e.file(function(e){!e.type||e.type.match(/image/)?i.resolve("image"):i.resolve(e.type)})},function(e){t.debug("checkMediaType resolveLocalFileSystemURL err "),t.debug(e),i.reject(e)})),i.promise},e.uploadMediaToCloudinary=function(n,i,o){var a=d.defer();return l.uploadImage(n,i).then(function(n){e.user.imageUrl=n.public_id,c.setUserDetail(e.user.id,{image:n.public_id}).then(function(t){e.user=s.getUser()},function(e){}),t.debug("image:"+e.user.imageUrl),a.resolve(n)},function(e){t.error(e),a.reject(o)}),a.promise},e.getPhoto=function(n){var i=0;"undefined"!=typeof e.user.settings.save_photo&&(i=e.user.settings.save_photo);var o={quality:80,mediaType:2,sourceType:e.cameraSourceType,correctOrientation:!0,encodingType:navigator.camera.EncodingType.JPEG,targetWidth:1024,targetHeight:768,destinationType:1,saveToPhotoAlbum:i};u.getPicture(o).then(function(t){var t=g(t);e.uploadMediaToCloudinary(t,1,n)},function(e){t.error(e)})},e.showUploadActionSheet=function(n){t.debug("showUploadActionSheet");var i=[{text:f.instant("Camera"),value:1,mediaIndex:n},{text:f.instant("Photolibrary"),value:0,mediaIndex:n}];a.show({buttons:i,cancelText:f.instant("Cancel"),cancel:function(){},buttonClicked:function(t){return e.cameraSourceType=this.buttons[t].value,e.getPhoto(this.buttons[t].mediaIndex),!0}})},e.goChangePassPage=function(){i.go("main.profile-edit-changepassword")}})}]).controller("ProfileSavedDraftsCtrl",["$scope","$ionicLoading","$filter","$rootScope","$timeout","$log","AuthService","Product","$translate",function(e,t,n,i,o,a,r,s,c){e.productsList=null,e.transactionTypes=[],e.transactionTypeSelected=0,e.noProductString=c.instant("You haven’t saved any drafts yet."),e.apiCalling=!1,e.expand=["user","media","currency"],e.initApiCounter=function(){e.apiCurrentPage=1,e.apiPageCount=0,e.apiTotalCount=0,e.apiPerPage=0},e.initApiCounter(),e.$on("$ionicView.beforeEnter",function(t){i.hideTabs=!0,e.user=r.getUser(),e.apiCalling?o(function(){a.debug("DRAFT beforeEnter busy"),e.productsListBeforeEnter()},100):e.productsListBeforeEnter()}),e.productsListBeforeEnter=function(){e.productsList&&e.productsList.length?e.checkNewWallProducts().then(function(t){t&&e.apiWallBeforeEnter(!0)},function(e){}):e.apiWallBeforeEnter()},e.apiWallBeforeEnter=function(n){n="undefined"==typeof n?!1:n,t.show(),e.apiCalling=!0,e.apiWallCall(n,1,!0,e.transactionTypeSelected,!0).then(function(t){o(function(){e.initWallTabScroll()})})["finally"](function(){t.hide(),e.apiCalling=!1})},e.setApiCounter=function(t){e.apiCurrentPage=t._meta.currentPage,e.apiPageCount=t._meta.pageCount,e.apiTotalCount=t._meta.totalCount,e.apiPerPage=t._meta.perPage},e.setProductsList=function(t){t=n("unique")(t,"id"),e.productsList=t},e.setApiCalling=function(t){e.apiCalling=t},e.apiWallCall=function(t,n,i,o,a){return s.getMyProducts(t,n,o,e.apiPerPage,e.expand,[{key:"draft",value:1}]).then(function(t){return a&&(e.productsList=t.items,e.setApiCounter(t)),t},function(e){return e})},e.checkNewWallProducts=function(){return s.checkNewMyProducts(s.getLastUpdateTime(e.transactionTypeSelected,"me_draft"),e.transactionTypeSelected,e.apiPerPage,[{key:"draft",value:1}]).then(function(e){return e.newElements>0},function(e){return e})}}]),angular.module("mellonapp").controller("ProductCtrl",["$log","$scope","data","connectionLevel","friendsList","$stateParams","$state","$ionicLoading","$ionicSlideBoxDelegate","$ionicActionSheet","$ionicModal","$timeout","$ionicHistory","$cordovaDialogs","$ionicScrollDelegate","$filter","$rootScope","Wall","Friends","AuthService","Product","CommonService","$translate",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m,h,v,y,S,b,P,C){t.isMyProduct=!1,t.userIfSecondLevel=!1,t.user=S.getUser(),t.userLoggedId=t.user.id,t.checkIsFriendSecondLevel=function(e){2==e&&(t.userIfSecondLevel=!0,t.friendsList=o)},t.$on("$ionicView.beforeEnter",function(){h.hideTabs=!0,e.debug("ProductCtrl beforeEnter"),t.product=n,t.transactionType=m("filter")(P.getTransactionTypes(),{id:t.product.transaction_type_id},!0)[0],d(function(){c.update()},50),t.isMyProduct=t.product.user_id==t.userLoggedId,t.checkIsFriendSecondLevel(i),t.isMyProduct||b.saveView(t.product.id),s.hide()}),t.$on("$ionicView.enter",function(){e.debug("ProductCtrl enter")}),t.$on("$ionicView.beforeLeave",function(){}),t.goToThread=function(e,n){var i={userId:e};void 0==n?(i.productId=a.prodId,i.productTitle=t.product.title):(i.friendInformationId=n,i.friendName=t.product.user.name+" "+t.product.user.surname),r.go("main.messages",i),t.closeModalFriends()},t.showProductContactActionSheet=function(e){u.show({buttons:[{text:'<i class="ion-ios-email-outline"></i>'+C.instant(" Chat with seller")},{text:'<i class="ion-ios-email-outline"></i><i class="ion-ios-person"></i>'+C.instant(" Chat with seller's friend")}],cancelText:"Cancel",cancel:function(){},buttonClicked:function(n){switch(n){case 0:return t.goToThread(e),!0;case 1:return t.openModalFriends(),!0}}})},t.goFriendDetail=function(e){e!=t.userLoggedId?r.go("main.friend-detail",{friendId:e}):r.go("main.profile")},l.fromTemplateUrl("templates/product-detail-friends.html",{scope:t,animation:"slide-in-right"}).then(function(e){t.modalFriends=e}),t.openModalFriends=function(e){t.modalFriends.show()},t.closeModalFriends=function(){t.modalFriends.hide()},t.$on("$destroy",function(){t.modalFriends.remove()}),t.setFriendInformation=function(e){t.goToThread(e,t.product.user_id)},t.goToProductUpdate=function(){r.go("main.product-update",{prodId:t.product.id})},t.confirmPublish=function(){if(t.user.status)var e=C.instant("Do you want to publish your deal now?");else var e=C.instant("To Publish a Deal you need to confirm your account (check your email inbox!).");p.confirm(e,C.instant("Publish now"),[C.instant("Yes! Go ahead"),C.instant("Not yet")]).then(function(e){1==e&&t.publish()})},t.publish=function(){s.show(),b.publishProduct(t.product.id).then(function(e){e.user=S.getUser(),t.product=e,s.show({template:C.instant("Your deal is now live on Mellon"),templateUrl:"",duration:3e3})},function(e){s.show({template:e.message,templateUrl:"",duration:3e3})})},t.confirmUnpublish=function(){p.confirm(C.instant("This will remove your deal from the Marketplace. Do you want to proceed?"),C.instant("Delist deal"),[C.instant("Yes"),C.instant("No")]).then(function(e){1==e&&t.unpublish()})},t.unpublish=function(){s.show(),b.unpublishProduct(t.product.id).then(function(e){e.user=S.getUser(),t.product=e,s.show({template:C.instant("Your deal has been saved as a draft"),templateUrl:"",duration:3e3})},function(e){s.show({template:e.message,templateUrl:"",duration:3e3})})},t.confirmDelete=function(){if(1==t.product.status){p.confirm(C.instant("Do you really want to delete this deal or mark it as gone?"),C.instant("Delete deal"),[C.instant("Delete it"),C.instant("Gone!"),C.instant("Cancel")]).then(function(e){1==e&&t["delete"](),2==e&&t.setSold()})}else{p.confirm(C.instant("This action cannot be undone! Do you really want delete this deal?"),C.instant("Delete deal"),[C.instant("Yes, I'm sure"),C.instant("No")]).then(function(e){1==e&&t["delete"]()})}},t["delete"]=function(){s.show(),b.deleteProduct(t.product.id).then(function(e){s.show({template:C.instant("Your deal has been deleted"),templateUrl:"",duration:3e3}),d(function(){t.product={},f.goBack()},3e3)},function(e){s.show({template:e.message,templateUrl:"",duration:3e3})})},t.confirmSetSold=function(){p.confirm(C.instant("Do you want to mark this deal as gone?"),C.instant("Mark as gone"),[C.instant("Yes"),C.instant("No")]).then(function(e){1==e&&t.setSold()})},t.setSold=function(){s.show(),b.setSoldProduct(t.product.id).then(function(e){t.product=e,s.show({template:C.instant("Your deal has been marked as gone"),templateUrl:"",duration:3e3})},function(e){s.show({template:e.message,templateUrl:"",duration:3e3})})},t.confirmUnsold=function(){p.confirm(C.instant("Do you want to make this deal available again?"),C.instant("Make available again"),[C.instant("Yes"),C.instant("No")]).then(function(e){1==e&&t.setUnsold()})},t.setUnsold=function(){s.show(),b.setUnsoldProduct(t.product.id).then(function(e){t.product=e,s.show({template:C.instant("Your deal has been published"),templateUrl:"",duration:3e3})},function(e){s.show({template:e.message,templateUrl:"",duration:3e3})})},t.openVia=function(e){r.go("main.friend-detail-via",{friendId:e})}}]).controller("ProductUpdateCtrl",["$scope","$state","$stateParams","$filter","$ionicScrollDelegate","$ionicLoading","$timeout","$rootScope","CommonService","Product","AuthService",function(e,t,n,i,o,a,r,s,c,u,l){e.action="update",e.user=l.getUser(),e.main_categories=[],e.all_subcategories=[],e.subcategories=[],e.conditions=[],e.shippingTypes=[],e.paymentTypes=[],e.currencies=[],e.product={},e.transactionTypes=[],e.$on("$ionicView.loaded",function(){e.transactionTypes=c.getTransactionTypes()}),e.$on("$ionicView.beforeEnter",function(){c.getMainCategories().then(function(t){e.main_categories=t}),c.getAllSubCategories().then(function(t){e.all_subcategories=t}),c.getProductConditions().then(function(t){e.conditions=t}),c.getShippingTypes().then(function(t){e.shippingTypes=t,e.initializeProductShippingTypes()}),c.getPaymentTypes().then(function(t){e.paymentTypes=t,e.initializeProductPaymentTypes()}),c.getCurrencies().then(function(t){e.currencies=t,e.initializeProductCurrency()}),s.hideTabs=!0,r(function(){o.$getByHandle("productUpdateScroll").scrollTop()},0),a.show(),e.user=l.getUser(),e.boxShowErrors={category:0,title:0,price:0,conditions:0,delivery:0,payment:0,publish:0},e.product={},u.findProduct(n.prodId).then(function(t){e.product=t,e.transactionType=i("filter")(e.transactionTypes,{id:e.product.transaction_type_id},!0)[0],e.initializeProduct(),a.hide()})}),e.initializeProduct=function(){null===e.product.price?(e.product.no_price=1,e.product.price=""):e.product.no_price=0,e.product.images=[{public_id:"",url:"",saved:!1},{public_id:"",url:"",saved:!1},{public_id:"",url:"",saved:!1},{public_id:"",url:"",saved:!1}],angular.forEach(e.product.media,function(t,n){var i=t.mediaUrl;"video"===t.type&&(i="https://res.cloudinary.com/mellon/video/upload/w_80,h_80/"+t.path+".jpg"),e.product.images[n]={public_id:t.path,url:i,type:t.type,saved:!0,width:t.width,height:t.height}}),e.initializeProductShippingTypes(),e.initializeProductPaymentTypes()},e.initializeProductShippingTypes=function(){if(e.shippingTypes.length&&!angular.equals({},e.product)){var t=e.product.shippingTypes;e.product.shippingTypes=angular.copy(e.shippingTypes),angular.forEach(e.product.shippingTypes,function(e){e.checked=!1,angular.forEach(t,function(t){Number(t.id)==Number(e.id)&&(e.checked=!0,e.custom_value=t.custom_value,e.price=t.price)})})}},e.initializeProductPaymentTypes=function(){if(e.paymentTypes.length&&!angular.equals({},e.product)){var t=e.product.paymentTypes;e.product.paymentTypes=angular.copy(e.paymentTypes),angular.forEach(e.product.paymentTypes,function(e){e.checked=!1,angular.forEach(t,function(t){Number(t.id)==Number(e.id)&&(e.checked=!0)})})}},e.initializeProductCurrency=function(){e.currencies.length&&!angular.equals({},e.product)&&(e.product.currency=i("filter")(e.currencies,{id:e.product.currency.id},!0)[0])},e.$on("$ionicView.beforeLeave",function(){})}]),angular.module("mellonapp").controller("SellCtrl",["$scope","$stateParams","$filter","$ionicScrollDelegate","$timeout","$cordovaDialogs","$state","$rootScope","CommonService","AuthService",function(e,t,n,i,o,a,r,s,c,u){e.action="create",e.user=u.getUser(),e.masterProduct={visibility:0,allow_posting_on_facebook:1,animated_gif_on_facebook:1,no_price:0,price:"",transaction_type_id:0,images:[{public_id:"",url:"",saved:!1},{public_id:"",url:"",saved:!1},{public_id:"",url:"",saved:!1},{public_id:"",url:"",saved:!1}],share_email:"",share_sms:""},e.product={},e.main_categories=[],e.all_subcategories=[],e.subcategories=[],e.conditions=[],e.shippingTypes=[],e.paymentTypes=[],e.currencies=[],e.boxShowErrors={category:0,title:0,price:0,conditions:0,delivery:0,payment:0,publish:0},e.changeStateOk=!1,e.$on("$ionicView.loaded",function(){}),e.$on("$ionicView.beforeEnter",function(){c.getMainCategories().then(function(t){e.main_categories=t,e.initializeMainCategory()}),c.getAllSubCategories().then(function(t){e.all_subcategories=t,e.initializeSubCategory()}),c.getProductConditions().then(function(t){e.conditions=t,e.initializeProductConditions()}),c.getShippingTypes().then(function(t){e.shippingTypes=t,e.initializeProductShippingTypes()}),c.getPaymentTypes().then(function(t){e.paymentTypes=t,e.initializeProductPaymentTypes()}),c.getCurrencies().then(function(t){e.currencies=t,e.initializeProductCurrency()}),s.hideTabs=!1,e.changeStateOk=!1,e.user=u.getUser(),e.transactionTypeId=Number(t.transactionTypeId)||1,e.transactionType=n("filter")(c.getTransactionTypes(),{id:e.transactionTypeId},!0)[0],o(function(){i.$getByHandle("sellScroll").scrollTop()},0),angular.equals({},e.product)&&(e.boxShowErrors={category:0,title:0,price:0,conditions:0,delivery:0,payment:0,publish:0},e.initializeProduct())}),e.initializeProduct=function(){e.product=angular.copy(e.masterProduct),e.product.transaction_type_id=e.transactionTypeId,e.initializeProductCurrency(),e.setProductDefaultVisibility(),e.setProductDefaultAllowPostingOnFacebook(),e.product.location=e.user.location,e.initializeProductConditions(),e.initializeProductShippingTypes(),e.initializeProductPaymentTypes()},e.setProductDefaultVisibility=function(){var t=e.user.settings["product_visibility_type_"+e.product.transaction_type_id];e.product.visibility="undefined"==typeof t?0:Number(t);
},e.setProductDefaultAllowPostingOnFacebook=function(){if(e.user.facebook_id)var t=e.user.settings.allow_posting_on_facebook;else var t=0;if(e.product.allow_posting_on_facebook="undefined"==typeof t?1:Number(t),e.user.facebook_id)var t=e.user.settings.animated_gif_on_facebook;else var t=0;e.product.animated_gif_on_facebook="undefined"==typeof t?1:Number(t)},e.initializeMainCategory=function(){e.main_categories.length&&e.product.mainCategory&&e.product.category_id&&(e.product.mainCategory=n("filter")(e.main_categories,{id:e.product.category_id})[0])},e.initializeSubCategory=function(){e.all_subcategories.length&&e.product.subCategory&&e.product.subcategory_id&&(e.product.subCategory=n("filter")(e.all_subcategories,{id:e.product.subcategory_id})[0])},e.initializeProductConditions=function(){(!e.conditions.length||angular.equals({},e.product)||e.product.condition)&&e.conditions.length&&e.product.condition&&e.product.condition_id&&(e.product.condition=n("filter")(e.conditions,{id:e.product.condition_id})[0])},e.initializeProductCurrency=function(){if(e.currencies.length&&!angular.equals({},e.product)&&!e.product.currency){var t=e.user.settings.currency;if("undefined"!=typeof t){var i=Number(t);angular.forEach(e.currencies,function(t){t.id==i&&(e.product.currency=t)})}else{var o=n("filter")(e.currencies,{is_default:1},!0)[0];e.product.currency=o}}},e.initializeProductShippingTypes=function(){if(!e.shippingTypes.length||angular.equals({},e.product)||e.product.shippingTypes){if(e.shippingTypes.length&&e.product.shippingTypes){var t=angular.copy(e.product.shippingTypes);e.product.shippingTypes=angular.copy(e.shippingTypes),angular.forEach(e.product.shippingTypes,function(e){e.checked=n("filter")(t,{id:e.id})[0].checked})}}else e.product.shippingTypes=angular.copy(e.shippingTypes),angular.forEach(e.product.shippingTypes,function(e){e.checked=!1})},e.initializeProductPaymentTypes=function(){if(!e.paymentTypes.length||angular.equals({},e.product)||e.product.paymentTypes){if(e.paymentTypes.length&&e.product.paymentTypes){var t=angular.copy(e.product.paymentTypes);e.product.paymentTypes=angular.copy(e.paymentTypes),angular.forEach(e.product.paymentTypes,function(e){e.checked=n("filter")(t,{id:e.id})[0].checked})}}else{e.product.paymentTypes=angular.copy(e.paymentTypes);var i=e.user.settings.payment_type;"undefined"==typeof i&&(i=[]),angular.forEach(e.product.paymentTypes,function(t){var n=0;3!=e.product.transaction_type_id&&4!=e.product.transaction_type_id&&angular.forEach(i,function(e){Number(e)==t.id&&(t.checked=!0,n=1)}),n||(t.checked=!1)})}}}]),angular.module("mellonapp").service("Product",["$q","$filter","ApiProduct","Wall","$translate",function(e,t,n,i,o){var a=function(t){return e(function(e,i){n.createProduct(t).then(function(t){e(t)},function(e){i(e)})})},r=function(t,i){return e(function(e,o){n.updateProduct(t,i).then(function(t){e(t)},function(e){o(e)})})},s=[],c=function(e,n,i,a,r,c){if("undefined"==typeof e&&(e=0),(n>1||i)&&(e=1),!s.length||e)return p(n,i,r,c);var u=t("filter")(c,{key:"draft"});u&&(u=u[0].value);var l=f(i,null,"me"+(u?"_draft":""));return d(l,i,a,c).then(function(e){return e.newElements>0?p(n,i,r,c):s},function(e){return o.instant("Cannot check new products - error: errorMsg",{errorMsg:e})})},u=function(t,i,a,r){return e(function(e,s){n.userProducts(t,i,a,r).then(function(t){e(t)},function(e){s(o.instant("Find users products error: errorMsg",{errorMsg:e}))})})},l=function(t,i,a){return e(function(e,r){n.checkNewUserProducts(t,i,a).then(function(t){e(t)},function(e){r(o.instant("Wall update error: errorMsg",{errorMsg:e}))})})},d=function(t,i,a,r){return e(function(e,s){n.checkNewMyProducts(t,i,a,r).then(function(t){e(t)},function(e){s(o.instant("Wall update error: errorMsg",{errorMsg:e}))})})},f=function(e,t){var i=n.getUpdateTime(e,null,t);return i>0?Math.floor(i/1e3):0},p=function(t,i,a,r){return e(function(e,c){n.myProducts(t,i,a,r).then(function(t){s=t,e(t)},function(e){c(o.instant("Find my products error: errorMsg",{errorMsg:e}))})})},g=function(t,i){return e(function(e,o){n.getProduct(t,i).then(function(t){e(t)},function(e){o(e)})})},m=function(t){return e(function(e,i){n.sellProduct(t).then(function(t){e(t)},function(e){i(e)})})},h=function(t){return e(function(e,i){n.publish(t).then(function(t){e(t)},function(e){i(e)})})},v=function(t){return e(function(e,i){n.unpublish(t).then(function(t){e(t)},function(e){i(e)})})},y=function(t){return e(function(e,i){n.setSold(t).then(function(t){e(t)},function(e){i(e)})})},S=function(t){return e(function(e,i){n.setUnsold(t).then(function(t){e(t)},function(e){i(e)})})},b=function(t){return e(function(e,i){n.deleteProduct(t).then(function(t){e(t)},function(e){i(e)})})},P=function(t){return e(function(e,i){n.sendReport(t).then(function(t){e(t)},function(e){i(e)})})},C=function(t){return e(function(e,i){n.preparePayment(t).then(function(t){e(t)},function(e){i(e)})})},T=function(t){return e(function(e,i){n.preparePaymentByRequest(t).then(function(t){e(t)},function(e){i(e)})})},_=function(t){return e(function(e,i){n.checkPayment(t).then(function(t){e(t)},function(e){i(e)})})},$=function(e){},w=function(t){return e(function(e,i){n.setPaymentCanceled(t).then(function(t){e(t)},function(e){i(e)})})},E=function(){return e(function(e,t){n.getOrderFees().then(function(t){e(t)},function(e){t(e)})})},U=function(t){return e(function(e,i){n.saveView(t).then(function(t){e(t)},function(e){i(e)})})},A=function(){n.resetUpdateTime()};return{create:a,update:r,getMyProducts:c,findMyProducts:p,findProduct:g,findUserProducts:u,checkNewUserProducts:l,sellProduct:m,publishProduct:h,unpublishProduct:v,setSoldProduct:y,setUnsoldProduct:S,deleteProduct:b,reportProduct:P,preparePayment:C,checkPayment:_,doPayment:$,setPaymentCanceled:w,preparePaymentByRequest:T,saveView:U,getOrderFees:E,getLastUpdateTime:f,checkNewMyProducts:d,resetUpdateTime:A}}]),angular.module("mellonapp.api").service("ApiProduct",["$q","$http","$ionicLoading","$ionicScrollDelegate","$log","$filter","ApiUrl","$translate",function(e,t,n,i,o,a,r,s){function c(o,a,c,u,l){return e(function(e,d){a="undefined"!=typeof a?a:1,c="undefined"!=typeof c?c:!0,u="undefined"!=typeof u?u:0,l="undefined"!=typeof l?l:"";var f=o.join(",");c&&n.show();var p="?page="+a+"&expand="+f;u&&(p+=3==u?"&transaction_type_id=free":"&transaction_type_id="+u),l&&(p+="&search="+encodeURIComponent(l)),t.get(r.get("PRODUCTS_WALL")+p).then(function(t){t.data.success?(L(u,l),c&&i.$getByHandle("wallScroll").scrollTop(!1),e(t.data.data)):d(s.instant("Cannot get Wall"))},function(e){d(s.instant("Server call failed!"))})})}function u(n){return e(function(e,i){t.post(r.get("PRODUCT_CREATE"),n).then(function(t){t.data.success?e(t.data.data):i(t.data.data)},function(e){i(s.instant("Server call failed!"))})})}function l(n,i){return e(function(e,o){t.put(r.get("PRODUCT_UPDATE")+n,i).then(function(t){t.data.success?e(t.data.data):o(t.data.data)},function(e){o(s.instant("Server call failed!"))})})}function d(n,i,o,c){return e(function(e,u){var l=[];if(l.push("page="+n),i&&(3==i?l.push("transaction_type_id=free"):l.push("transaction_type_id="+i)),void 0!==o&&null!==o&&l.push("expand="+o.join(",")),void 0!==c&&null!==c&&c.length>0)for(var d in c)l.push(c[d].key+"="+c[d].value);var f="";l.length>0&&(f="?"+l.join("&")),t.get(r.get("MY_PRODUCTS")+f).then(function(t){if(t.data.success){var n=a("filter")(c,{key:"draft"});n.length>0&&(n=n[0].value),L(i,null,"me"+(n?"_draft":"")),e(t.data.data)}else u(s.instant("Cannot get My Products"))},function(e){u(s.instant("Server call failed!"))})})}function f(n,i,o,a){return o="undefined"!=typeof o?o:1,e(function(e,i){var a="",a="?page="+o;t.get(r.get("PRODUCTS_BY_USER")+"/"+n+a).then(function(t){t.data.success?(L(null,null,n),e(t.data.data)):i(s.instant("Cannot get user's products"))},function(e){i(s.instant("Server call failed!"))})})}function p(n,i){return e(function(e,o){var a=[];void 0!==i&&null!==i&&a.push("expand="+i.join(","));var c="";a.length>0&&(c="?"+a.join("&")),t.get(r.get("GET_PRODUCT")+n+c).then(function(t){t.data.success?e(t.data.data):o(s.instant("Cannot get Product"))},function(e){o(s.instant("Server call failed!"))})})}function g(n,i,o,a){return i="undefined"!=typeof i?i:0,a="undefined"!=typeof a?a:"",3==i&&(i="free"),e(function(e,c){var u="?page_size="+o;a&&(u+="&search="+a),t.get(r.get("CHECK_NEW_WALL_PRODUCTS")+"/"+n+"/"+i+u).then(function(t){t.data.success?e(t.data.data):c(s.instant("Cannot get Product"))},function(e){c(s.instant("Server call failed!"))})})}function m(n,i,o){return e(function(e,a){var c="?page_size="+o;t.get(r.get("CHECK_NEW_PRODUCTS_BY_USER")+"/"+n+"/"+i+c).then(function(t){t.data.success?e(t.data.data):a(s.instant("Cannot get Product"))},function(e){a(s.instant("Server call failed!"))})})}function h(n,i,o,a){return 3==i&&(i="free"),e(function(e,c){var u=[];if(u.push("page_size="+o),void 0!==a&&null!==a&&a.length>0)for(var l in a)u.push(a[l].key+"="+a[l].value);var d="";u.length>0&&(d="?"+u.join("&")),t.get(r.get("CHECK_NEW_MY_PRODUCTS")+"/"+n+"/"+i+d).then(function(t){t.data.success?e(t.data.data):c(s.instant("Cannot get Product"))},function(e){c(s.instant("Server call failed!"))})})}function v(n){return e(function(e,i){var o={product_id:n};t.post(r.get("SELL_PRODUCT"),o).then(function(t){t.data.success?e(t.data.data):i(t.data.data)},function(){i(s.instant("Server call failed!"))})})}function y(n){return e(function(e,i){var o={id:n};t.put(r.get("PRODUCT_PUBLISH")+"?expand=user",o).then(function(t){t.data.success?e(t.data.data):i(t.data.data)},function(){i(s.instant("Server call failed!"))})})}function S(n){return e(function(e,i){var o={id:n};t.put(r.get("PRODUCT_UNPUBLISH")+"?expand=user",o).then(function(t){t.data.success?e(t.data.data):i(t.data.data)},function(){i(s.instant("Server call failed!"))})})}function b(n){return e(function(e,i){var o={id:n};t.put(r.get("PRODUCT_SET_SOLD")+"?expand=user",o).then(function(t){t.data.success?e(t.data.data):i(t.data.data)},function(){i(s.instant("Server call failed!"))})})}function P(n){return e(function(e,i){var o={id:n};t.put(r.get("PRODUCT_SET_UNSOLD")+"?expand=user",o).then(function(t){t.data.success?e(t.data.data):i(t.data.data)},function(){i(s.instant("Server call failed!"))})})}function C(n){return e(function(e,i){t["delete"](r.get("PRODUCT_DELETE")+n).then(function(t){204==t.status?e(t):i(t.data)},function(){i(s.instant("Server call failed!"))})})}function T(n){return e(function(e,i){t.post(r.get("PRODUCT_REPORT"),n).then(function(t){t.data.success?e(t.data.success):i(s.instant("Cannot send request"))},function(){i(s.instant("Server call failed!"))})})}function _(n){return e(function(e,i){t.post(r.get("ORDER_PREPARE_PAYMENT"),n).then(function(t){t.data.success?t.data.data.success?e(t.data.data):i(t.data.data.error):i(t.data.data&&t.data.data.message?t.data.data.message:s.instant("Cannot send request"))},function(){i(s.instant("Server call failed!"))})})}function $(n){return e(function(e,i){t.post(r.get("ORDER_PREPARE_PAYMENT_BY_REQUEST"),n).then(function(t){t.data.success?t.data.data.success?e(t.data.data):i(t.data.data.error):i(t.data.data&&t.data.data.message?t.data.data.message:s.instant("Cannot send request"))},function(){i(s.instant("Server call failed!"))})})}function w(n){return e(function(e,i){t.post(r.get("ORDER_CHECK_PAYMENT"),n).then(function(t){t.data.success?e(t.data.data):i(s.instant("Cannot send request"))},function(){i(s.instant("Server call failed!"))})})}function E(e){}function U(n){return e(function(e,i){t.post(r.get("ORDER_SET_PAYMENT_CANCELED"),n).then(function(t){t.data.success?e(t.data.data):i(s.instant("Cannot send request"))},function(){i(s.instant("Server call failed!"))})})}function A(e,t,n){n="undefined"!=typeof n?n:null;var i=a("filter")(k,{type:e,search:t,userId:n},!0);return i.length?i[0].value:0}function L(e,t,n){n="undefined"!=typeof n?n:null;var i=a("filter")(k,{type:e,search:t,userId:n},!0);i.length?i[0].value=Date.now():k.push({type:e,search:t,userId:n,value:Date.now()})}function R(){k=[]}function M(n){return e(function(e,i){t.get(r.get("PRODUCT_SAVE_VIEW")+n).then(function(t){t.data.success?e(t.data.data):i(s.instant("Cannot send request"))},function(){i(s.instant("Server call failed!"))})})}function I(){return e(function(e,n){t.get(r.get("ORDER_GET_FEES")).then(function(t){t.data.success?e(t.data.data):n(s.instant("Cannot send request"))},function(){n(s.instant("Server call failed!"))})})}var k=[];return{getUpdateTime:A,getWall:c,createProduct:u,updateProduct:l,myProducts:d,userProducts:f,getProduct:p,checkNewWallProducts:g,sellProduct:v,publish:y,unpublish:S,setSold:b,setUnsold:P,deleteProduct:C,sendReport:T,preparePayment:_,checkPayment:w,doPayment:E,setPaymentCanceled:U,preparePaymentByRequest:$,saveView:M,getOrderFees:I,checkNewUserProducts:m,checkNewMyProducts:h,resetUpdateTime:R}}]),angular.module("mellonapp").controller("FriendsCtrl",["$timeout","$scope","$rootScope","$state","$ionicLoading","$log","$localStorage","$ionicScrollDelegate","$filter","Friends","AppInstalled","InviteService","$translate","$ionicModal","Text","AuthService",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m){function h(e){var n=angular.isUndefined(e)?!1:e;return u.getAll(n,!1).then(function(e){t.friends=[],t.friends[1]=e[1],t.friends[2]=e[2],t.hasFriends=!u.hasNoFriends(),t.apiRequested=!0,t.page=1,t.listLimit=t.getListLimit()})}t.friends=[],t.selectedFriends=[],t.search={};var v=30;t.pageSize=10,t.page=1,t.getListLimit=function(){return t.page*t.pageSize},t.listLimit=t.getListLimit(),t.apiRequested=!1,t.friendLevel=1,t.basilicataOverlayShown=!1,t.getNow=function(){var e=new Date;return new Date(e.getFullYear(),e.getMonth(),e.getDate())},t.$watch("invites",function(e){r.set("invites",e?"1":"0")}),t.$on("$ionicView.beforeEnter",function(e){n.hideTabs=!1,t.user=m.getUser();var i=!t.friends.length;i&&o.show({delay:0}),u.getAll(!0,!1).then(function(e){t.friends[1]=e[1],t.friends[2]=e[2]},function(e){t.friends[1]=[],t.friends[2]=[]})["finally"](function(){t.hasFriends=!u.hasNoFriends(),t.checkBasilicataOverlay(),t.initializeInvites(),t.apiRequested=!0,t.selectedFriends=t.friends[t.friendLevel],i&&o.hide({delay:1e3})})}),t.checkBasilicataOverlay=function(){t.hasFriends||0!=t.user.friend_to_all||t.basilicataOverlayShown&&+t.basilicataOverlayShown==+t.getNow()||g.getFriendsBasilicataModal().then(function(e){t.modalTitle=e.title,t.modalText=e.text,t.openModal(),t.basilicataOverlayShown=t.getNow()})},t.initializeInvites=function(){if(angular.isUndefined(t.invites)){var e=t.friends[1].length>=v?"0":"1";t.invites=parseInt(r.get("invites",e))>0}},t.doRefresh=function(){h(!0)["finally"](function(){t.$broadcast("scroll.refreshComplete")})},n.$on("$translateChangeSuccess",function(){t.doRefresh()}),t.hasSearchName=function(e){var n=t.search.name||"";return-1!==e.name.toLocaleLowerCase().indexOf(n)?!0:-1!==e.surname.toLocaleLowerCase().indexOf(n)},l.query("facebook").then(function(e){t.hasFB=e}),l.query("fb-messenger").then(function(e){t.hasFBmessenger=e}),l.query("whatsapp").then(function(e){t.hasWA=e}),t.FBinvite=function(){d.Facebook()},t.FBmesssenger=function(){d.FBmessenger()},t.WAinvite=function(){d.Whatsapp()},t.MAILinvite=function(){d.Email()},t.SMSinvite=function(){d.SMS()},t.goFriendDetail=function(e){i.go("main.friend-detail",{friendId:e})},t.closeKeyboard=function(){cordova.plugins.Keyboard.close()},t.loadMore=function(){e(function(){t.page++,t.listLimit=t.getListLimit(),e(function(){t.$broadcast("scroll.infiniteScrollComplete")})},500)},t.moreDataCanBeLoaded=function(){var e=c("filter")(t.selectedFriends,t.hasSearchName);return e&&e.length>0?t.page*t.pageSize<e.length:!1},t.changeLevel=function(e){t.friendLevel=e,t.selectedFriends=t.friends[t.friendLevel],t.page=1,t.listLimit=t.getListLimit(),s.$getByHandle("friendScroll").scrollTop(!1)},t.searchChange=function(){s.$getByHandle("friendScroll").scrollTop(!1),t.page=1,t.listLimit=t.getListLimit()},t.getViaString=function(e){if(!e.friends1)return!1;var t=e.friends1.split(","),n=t[0];return t.length>1&&(n+=" + "+(t.length-1)),n},p.fromTemplateUrl("templates/friends-basilicata-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.modal=e}),t.openModal=function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!1),t.modal.show()},t.closeModal=function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),t.modal.hide()},t.$on("modal.hidden",function(){}),t.$on("modal.removed",function(){})}]).controller("FriendDetailCtrl",["$scope","$rootScope","$state","$cordovaDialogs","$ionicModal","$stateParams","$ionicActionSheet","$ionicLoading","$log","$ionicHistory","$timeout","$q","$filter","Friends","Product","$translate",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m){e.productsList=null,e.transactionTypeSelected=0,e.apiCalling=!1,e.reportUser={description:""},e.expand=["user","media","currency"],e.friend=null,e.initApiCounter=function(){e.apiCurrentPage=1,e.apiPageCount=0,e.apiTotalCount=0,e.apiPerPage=0},e.initApiCounter(),e.$on("$ionicView.beforeEnter",function(n){t.hideTabs=!0,null===e.friend&&s.show(),p.getUser(a.friendId,!1,!1).then(function(t){e.friend=t,e.noProductString=e.friend.name+" "+m.instant("hasn’t posted any deal yet!"),"2"===e.friend.level&&p.getSecondLevelViaConnection(a.friendId).then(function(t){e.friend.conn2=t}),e.apiCalling?l(function(){c.debug("FRIEND beforeEnter busy"),e.productsListBeforeEnter()},100):e.productsListBeforeEnter()},function(t){e.productsList=null,e.initApiCounter(),s.hide()}),e.previousPage=u.backView()}),e.productsListBeforeEnter=function(){e.productsList&&e.productsList.length&&g.getLastUpdateTime(null,a.friendId)?e.checkNewWallProducts().then(function(t){t&&e.apiWallBeforeEnter(!0)},function(e){s.hide()}):e.apiWallBeforeEnter()},e.apiWallBeforeEnter=function(t){t="undefined"==typeof t?!1:t,e.apiCalling=!0,s.show(),e.apiWallCall(t,1,!0,e.transactionTypeSelected,!0)["finally"](function(){e.apiCalling=!1,s.hide()})},e.apiWallCall=function(t,n,i,o,r){return g.findUserProducts(a.friendId,e.expand,n).then(function(t){return r&&(t?(e.productsList=t.items,e.setApiCounter(t)):(e.productsList=[],e.initApiCounter())),t},function(e){return e})},e.setApiCounter=function(t){e.apiCurrentPage=t._meta.currentPage,e.apiPageCount=t._meta.pageCount,e.apiTotalCount=t._meta.totalCount,e.apiPerPage=t._meta.perPage},e.setProductsList=function(t){t=f("unique")(t,"id"),e.productsList=t},e.setApiCalling=function(t){e.apiCalling=t},e.checkNewWallProducts=function(){return g.checkNewUserProducts(a.friendId,g.getLastUpdateTime(null,a.friendId),e.apiPerPage).then(function(e){return e.newElements>0},function(e){return e})},e.showReportActionSheet=function(){r.show({buttons:[{text:m.instant("REPORT USER"),view:"modalReportUser"}],cancelText:m.instant("Cancel"),cancel:function(){},buttonClicked:function(t){return"modalReportUser"==this.buttons[t].view&&e.openModalReportUser(),!0}})},e.goToThread=function(t,i){var o={userId:t};void 0==i?(o.productId=a.prodId,o.productTitle=e.product.title):(o.friendInformationId=i,o.friendName=e.friend.name+" "+e.friend.surname),n.go("main.messages",o),e.closeModalFriends()},o.fromTemplateUrl("templates/product-detail-friends.html",{scope:e,animation:"slide-in-right"}).then(function(t){e.modalFriends=t}),e.openModalFriends=function(t){p.getFollowingFirstLevel(t).then(function(t){e.friendsList=t,e.modalFriends.show()})},e.closeModalFriends=function(){cordova.plugins.Keyboard.close(),e.modalFriends.hide()},o.fromTemplateUrl("templates/report-user.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modalReportUser=t}),e.openModalReportUser=function(){e.reportUser.description="",e.modalReportUser.show()},e.closeModalReportUser=function(t){t.$setPristine(),e.modalReportUser.hide()},e.$on("$destroy",function(){e.modalFriends.remove(),e.modalReportUser.remove()}),e.pleaseShowProfile=function(){p.pleaseShowProfile(e.friend.id).then(function(e){i.alert(m.instant("Now you need to wait for your friend to accept your request."),m.instant("Request Sent"),m.instant("OK")).then(function(){})})},e.goFriendDetail=function(e){n.go("main.friend-detail",{friendId:e})},e.setFriendInformation=function(t){e.goToThread(t,e.friend.id)},e.goFriendSettings=function(e){n.go("main.friend-settings",{friendId:e})},e.openVia=function(t){e.friend.conn2.length>1?n.go("main.friend-detail-via",{friendId:t}):e.goFriendDetail(e.friend.conn2[0].id)},e.sendReportUser=function(t){if(e.reportUser.description){var n={id:e.friend.id,description:e.reportUser.description,level:e.friend.level};s.show(),p.sendReport(n).then(function(){s.show({template:m.instant("Your report has been sent"),templateUrl:"",duration:3e3}),e.closeModalReportUser(t)},function(e){s.show({template:m.instant("Error!"),templateUrl:"",duration:3e3})})}},e.backButton=function(){u.backView()?u.goBack():n.go("main.friends")}}]).controller("FriendDetailViaCtrl",["$scope","$rootScope","$state","$stateParams","$ionicLoading","Friends",function(e,t,n,i,o,a){e.$on("$ionicView.beforeEnter",function(n){t.hideTabs=!0,o.show(),a.getFollowingFirstLevel(i.friendId).then(function(t){e.secondList=t})["finally"](function(){o.hide()})}),e.goFriendDetail=function(e){n.go("main.friend-detail",{friendId:e})}}]).controller("FriendSettingsCtrl",["$scope","$ionicHistory","AuthService","$stateParams","$cordovaDialogs","$log","$state","Friends","$ionicLoading","$rootScope","friendSettingData","$translate",function(e,t,n,i,o,a,r,s,c,u,l,d){e.$on("$ionicView.beforeEnter",function(t){u.hideTabs=!0,e.friend=l,c.hide(),e.user=n.getUser()}),e.updateBestFriend=function(){s.changeState("bestfriend",e.friend.best_friend,e.friend.id,e.friend.level).then(function(){},function(t){e.friend.best_friend="0"===e.friend.best_friend?"1":"0"})},e.updateFollowing=function(){s.changeState("following",e.friend.out_following,e.friend.id,e.friend.level).then(function(){},function(t){e.friend.out_following="0"===e.friend.out_following?"1":"0"})},e.setAllowFriend=function(){s.setAllowFriend(e.friend.id,e.friend.in_following).then(function(){},function(e){})},e.updateBlock=function(t){c.show(),s.changeState("block",t,e.friend.id,e.friend.level).then(function(){c.hide(),r.go("main.friend-settings",{friendId:e.friend.id})},function(e){c.show({template:"Error!",templateUrl:"",duration:3e3})})},e.updateHideMe=function(){e.textPopup="1"===e.friend.in_hidden_friend?d.instant("This user won't be able to see your deals anymore. Are you sure?"):d.instant("This user will be able to see your deals (even the past ones). Do you want to proceed? "),e.titlePopUp="1"===e.friend.in_hidden_friend?d.instant("Hide my deals"):d.instant("Show my deals");o.confirm(e.textPopup,e.titlePopUp,[d.instant("Yes"),d.instant("Nope")]).then(function(t){var n=t;1===n?s.changeState("follower",e.friend.in_hidden_friend,e.friend.id,e.friend.level).then(function(){},function(t){e.friend.in_hidden_friend="0"===e.friend.in_hidden_friend?"1":"0"}):e.friend.in_hidden_friend="0"===e.friend.in_hidden_friend?"1":"0"})},e.goBlockFriend=function(e){r.go("main.friend-block-friend",{friendId:e})},e.goBack=function(){t.goBack()}}]),angular.module("mellonapp").service("Friends",["$rootScope","$q","$filter","$ionicLoading","$log","ApiFriends","$translate",function(e,t,n,i,o,a,r){var s,c={valid:!1,lastUpdated:0,interval:60,data:{},hit:function(){if(this.valid===!1)return!1;var e=new Date,t=(e-this.lastUpdated)/1e3<this.interval;return o.debug("hit"),t},miss:function(){return!this.hit()},set:function(e){this.valid=!0,this.lastUpdated=new Date,this.data=e},invalidate:function(){this.valid=!1,this.lastUpdated=0,this.data={}}};e.$on("mellon:logout",function(){c.invalidate(),s=void 0});var u=function(){return angular.isDefined(s)?s:!1},l=function(){return t(function(e,t){angular.isUndefined(s)?d()["finally"](function(){e(s)}):e(s)})},d=function(e,o){return o="undefined"!=typeof o?o:!0,t(function(t,u){e||c.miss()?(o&&i.show(),a.getFriends().then(function(e){s=0===n("filter")(e[1],{from_friend_to_all:0}).length,c.set(e),t(c.data)},function(e){u(e)})["finally"](function(){o&&i.hide()})):c.valid?t(c.data):u(r.instant("no valid cached data"))})},f=function(e,i,o){return o="undefined"!=typeof o?o:!0,t(function(t,a){d(i,o).then(function(i){var o=n("filter")(i[1],{id:e},!0);o.length?t(o[0]):(o=n("filter")(i[2],{id:e},!0),o.length?t(o[0]):a(r.instant("User not found")))},function(e){a(e)})})},p=function(e){return t(function(t,n){a.getFollowingFirstLevel(e).then(function(e){t(e)},function(e){n(e)})})},g=function(e){return t(function(t,n){a.getConnectionLevel(e).then(function(e){t(e)},function(e){n(e)})})},m=function(e){return t(function(t,n){a.getSecondLevelViaConnection(e).then(function(e){t(e)},function(e){n(e)})})},h=function(e){var n=[],i=e;for(var o in i){var a=function(e){return m(i[e].id).then(function(t){i[e].conn2=t})}(o);n.push(a)}return t.all(n).then(function(){return i})},v=function(e,n){return t(function(t,i){a.setAllowFriend(e,n).then(function(){t()},function(e){i(e)})})},y=function(e){return t(function(t,n){a.pleaseShowProfile(e).then(function(){t()},function(e){n(e)})})},S=function(e,n,i,o){return t(function(t,r){a.changeState(e,n,i,o).then(function(){t()},function(e){r(e)})})},b=function(e){return t(function(t,n){a.sendReport(e).then(function(e){t(e)},function(e){n(e)})})};return{dumpCache:function(){o.log(c)},getAll:d,getUser:f,getFollowingFirstLevel:p,getConnectionLevel:g,getSecondLevelViaConnection:m,getAllSecondLevelViaConnection:h,setAllowFriend:v,pleaseShowProfile:y,changeState:S,sendReport:b,hasNoFriends:u,hasNoFriendsAsync:l}}]),angular.module("mellonapp.api").service("ApiFriends",["$q","$http","$log","ApiUrl","$translate",function(e,t,n,i,o){function a(){return e(function(e,n){t.get(i.get("USER_FRIEND_LIST")).then(function(t){t.data.success?e(t.data.data):n(o.instant("Cannot get friend list"))},function(e){n(o.instant("Server call failed!"))})})}function r(a){return e(function(e,r){t.get(i.get("USER_DETAIL")+"/"+a).then(function(t){t.data.success?e(t.data.data):(n.debug(t),r(o.instant("Cannot get friend detail")))},function(e){r(o.instant("Server call failed!"))})})}function s(a){return e(function(e,r){t.get(i.get("FIRST_LEVEL_FRIENDS")+"/"+a).then(function(t){t.data.success?e(t.data.data):(n.debug(t),r(o.instant("Cannot get first level friends list")))},function(e){r(o.instant("Server call failed!"))})})}function c(a){return e(function(e,r){t.get(i.get("FRIEND_CONNECTION_LEVEL")+"/"+a).then(function(t){t.data.success?e(t.data.data):(n.debug(t),r(o.instant("Cannot get connection level")))},function(e){r(o.instant("Server call failed!"))})})}function u(a){return e(function(e,r){t.get(i.get("USER_SECONDLEV_CONNECTION")+"/"+a).then(function(t){t.data.success?e(t.data.data):(n.debug(t),r(o.instant("Cannot get second level via connection")))},function(e){r(o.instant("Server call failed!"))})})}function l(a,r){return e(function(e,s){n.debug(i.get("USER_ALLOW_FRIEND")+"/"+a+"/"+r),t.get(i.get("USER_ALLOW_FRIEND")+"/"+a+"/"+r).then(function(t){t.data.success?(e(t.data.data),n.debug(t)):(n.debug(t),s(o.instant("Cannot set")))},function(e){s(o.instant("Server call failed!"))})})}function d(a){return e(function(e,r){t.post(i.get("FOLLOW_FRIEND_REQUEST"),{id:a}).then(function(t){t.data.success?e(t.data.data):(n.debug(t),r(o.instant("Cannot send request")))},function(e){r(o.instant("Server call failed!"))})})}function f(a,r,s,c){var u={following:i.get("USER_CHG_FOLLOWING"),follower:i.get("USER_CHG_FOLLOWER"),block:i.get("USER_CHG_BLOCK")},l={};return l[a]=r,l.id=s,l.level=c,e(function(e,i){return angular.isUndefined(u[a])?(n.warn(o.instant("stateType unknown")),void i(o.instant("stateType unknown"))):void t.post(u[a],l).then(function(t){t.data.success===!0&&t.data.data.success===!0?e():(n.warn(t),i(o.instant("Cannot set new state: statetype",{statetype:a}+a)))},function(e){i(o.instant("Server call failed!"))})})}function p(a){return e(function(e,r){t.post(i.get("USER_REPORT_FRIEND"),a).then(function(t){t.data.success?e(t.data.success):(n.debug(t),r(o.instant("Cannot send request")))},function(e){r(o.instant("Server call failed!"))})})}return{getFriends:a,getDetail:r,getFollowingFirstLevel:s,getConnectionLevel:c,getSecondLevelViaConnection:u,setAllowFriend:l,pleaseShowProfile:d,changeState:f,sendReport:p}}]),angular.module("mellonapp").controller("MessageTabsCtrl",["$log","$scope",function(e,t){t.$on("$ionicView.beforeEnter",function(e,n){t.$broadcast("messageTabs.beforeEnter",{})}),t.$on("$ionicView.enter",function(e,n){t.$broadcast("messageTabs.enter",{})}),t.$on("$ionicView.beforeLeave",function(e,n){t.$broadcast("messageTabs.beforeLeave",{})}),t.$on("$ionicView.leave",function(e,n){t.$broadcast("messageTabs.leave",{})})}]),angular.module("mellonapp").controller("MessagesCtrl",["$scope","messageData","friendData","$state","$stateParams","$ionicScrollDelegate","$ionicLoading","$ionicHistory","$timeout","$log","$ionicActionSheet","$ionicModal","$filter","$rootScope","$ionicPlatform","Messages","MessageRealtime","AuthService","Product","CommonService","Notifications","$translate",function(e,t,n,i,o,a,r,s,c,u,l,d,f,p,g,m,h,v,y,S,b,P){function C(){var e=$(".scroll").get(0).scrollHeight,t=e-A;u.debug("difference",t,"height",e,"lastHeight",A),a.$getByHandle("mainMessageScroll").scrollTo(0,t,!1)}function T(){L&&c(function(){L=!1,C()},1e3)}var _=5e3;e.apiRealtime=!1,e.pageSize=10,e.platform=ionic.Platform,e.currencies=[],e.myProducts=[],e.moreDataCanBeLoaded=null,e.friendId=o.userId,e.userPaypalAccount=v.getUser().paypal_account,e.user=v.getUser(),e.userLoggedId=e.user.id,e.userLoggedImageUrl=e.user.imageUrl,e.firstLoad=!0,e.updatingMessageList=!1,e.input={},e.input.message="",e.friendData={},e.sendingMessage=!1,e.messageList=[],g.on("resume",function(t){c(function(){p.messageRefreshing!==!1&&p.messageRefreshing==e.friendId&&(u.debug(e.friendId),1!=p.updateMessagestRefresh&&(p.updateMessagestRefresh=!0,console.log("$rootScope.updateMessagestRefresh doRefresh"),e.doRefresh()))},10)}),e.$on("$ionicView.beforeEnter",function(t,n){u.debug("$ionicView.beforeEnter messages"),p.hideTabs=!0,e.hideMessageTabs=!0,e.myProducts.length||y.findMyProducts(null,null,["media"],[{key:"status",value:1},{key:"transaction_type_id",value:["1","2"]}]).then(function(t){e.myProducts=t.items})}),e.$on("$ionicView.enter",function(){u.debug("$ionicView.enter messages"),p.hideTabs=!0,void 0!=m.getWritingMessage(e.friendId)&&""!=m.getWritingMessage(e.friendId)&&(e.input.message=m.getWritingMessage(e.friendId)),p.messageRefreshing=e.friendId,p.hideTabs=!0,e.hideMessageTabs=!0,window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),e.firstLoad=!0,e.apiRealtime?e.initRealtime():m.getMessages(o.userId).then(function(t){e.initStatic(t)}),e.friendName=n.name,e.friendPrivate=0==n.visibility&&0==n.out_following,e.friendData=n,c(function(){e.footerBar=document.body.querySelector("ion-view[nav-view=active] .message-footer"),e.scroller=document.body.querySelector("ion-view[nav-view=active] .messages-content.scroll-content"),e.txtInput=e.footerBar.querySelector("ion-view[nav-view=active] textarea"),null!==e.txtInput?e.txtInputInitialHeight=e.txtInput.offsetHeight:e.txtInputInitialHeight=0,e.elasticInit()},0),u.debug("$ionicHistory.viewHistory()"),u.debug(s.viewHistory().histories),u.debug(s.viewHistory().views)}),e.$on("$ionicView.afterEnter",function(t,n){p.hideTabs=!0,e.hideMessageTabs=!0});var w=function(){e.apiRealtime&&(p.listenerUpdateMessage(),p.listenerUpdateMessageCount(),p.listenerUpdateMessageStatic())};e.$on("$ionicView.beforeLeave",function(){u.debug("$ionicView.beforeLeave messages"),""!=e.input.message&&m.setWritingMessage(e.friendId,e.input.message),w(),p.messageRefreshing=!1,c.cancel(p.updateMessagesTimeout),p.updateMessagestRefresh=!1}),e.$on("$ionicView.leave",function(){p.hideTabs=!1,e.hideMessageTabs=!1;
}),e.$on("$destroy",function(t,n,i,o,a){u.debug("$destroy messages"),e.modal.remove(),w(),c.cancel(p.updateMessagesTimeout),p.updateMessagestRefresh=!1}),e.backButton=function(){s.backView()?s.goBack():i.go("main.message-threads")},e.doRefresh=function(){if(0==e.sendingMessage){var t=Math.floor(Date.now()/1e3);m.getMessages(e.friendId,t).then(function(t){e.updatingMessageList=!0,e.messageList.length&&angular.isDefined(e.messageList[0].local)&&1==e.messageList[0].local&&e.messageList.splice(0,1),e.setMessageList(t.items.concat(e.messageList)),a.resize(),c(function(){R(),e.updatingMessageList=!1}),p.updateMessagestRefresh&&(p.updateMessagesTimeout=c(function(){e.doRefresh()},5e3))})}},e.initStatic=function(t){e.page=1,e.listLimit=e.getListLimit(),e.apiCurrentPage=0,e.apiPerPage=150,e.setMessageList(t.items),c(function(){R()}),e.$watchCollection("input",function(t,n){m.setWritingMessage(e.friendId,t.message)}),e.firstLoad&&(e.$broadcast("scroll.refreshComplete"),a.resize(),c(function(){a.$getByHandle("mainMessageScroll").scrollBottom()},0),e.firstLoad=!1,r.hide(),1!=p.updateMessagestRefresh&&(c(function(){e.doRefresh()},5e3),p.updateMessagestRefresh=!0))},e.initRealtime=function(){e.page=1,e.listLimit=e.getListLimit(),e.apiCurrentPage=0,e.apiPerPage=100,h.openSocket(v.getUser()),h.joinRoom(o.userId),u.debug("$scope.firstUpdateMessageCall "+e.firstUpdateMessageCall),p.listenerUpdateMessage=p.$on("updateMessage",function(t,n){e.setMessageList(n),e.$apply(),e.sendingMessage=!1,e.closeModal(),c(function(){a.$getByHandle("mainMessageScroll").scrollBottom(),u.debug("$ionicScrollDelegate.$getByHandle('mainMessageScroll').scrollBottom();"),e.$broadcast("scroll.refreshComplete"),e.firstLoad=!1,c(function(){R()})},500),b.setNotificationMessageThreadRead(e.friendId),r.hide()}),p.listenerUpdateMessageCount=p.$on("updateMessageCount",function(t,n){e.setApiCounter(n)}),p.listenerUpdateMessageStatic=p.$on("updateMessageStatic",function(t,n,i){var o;o=1==i?n:e.messageList.concat(n),u.debug(o),e.setMessageList(o),1!=i?e.loadMoreTimeout():(c(function(){a.$getByHandle("mainMessageScroll").scrollBottom(),u.debug("$ionicScrollDelegate.$getByHandle('mainMessageScroll').scrollBottom();"),e.$broadcast("scroll.refreshComplete"),e.firstLoad=!1,c(function(){R()})},500),r.hide()),e.$apply(),e.sendingMessage=!1})};var E,U=function(e,t,n){return t.substring(0,10)===E?!1:(E=t.substring(0,10),!0)};e.displayMessageTitle=function(t,n){return 0==t&&(e.messageTitle=null),n===e.messageTitle?!1:(e.messageTitle=n,n)},e.elasticInit=function(){var t=e.txtInput.offsetHeight;e.$emit("elastic:resize",e.txtInput,t,t)},e.$on("elastic:resize",function(t,n,i,o){if(n){var a;o>=32&&36>=o?a=32:o>36&&41>=o?a=54:o>42&&58>=o?a=54:o>58&&74>=o?a=70:o>74&&90>=o?a=86:o>90&&106>=o&&(a=102);var r;r=void 0!=e.scroller&&null!=e.scroller.className.match(/has-subfooter/)?"has-footer-has-subfooter-textarea"+a:"has-footer-textarea"+a;var s=12,c=0;if(void 0!=e.scroller&&null!=e.scroller.className.match(/has-subfooter/)&&(c=51),e.footerBar){var u=o>150?150:o;u+=s;e.footerBar.style.height=u+"px";var l=e.scroller.className.match(/has-footer-has-subfooter-textarea[0-9]*/);null!=l&&angular.element(e.scroller).removeClass(l[0]);var d=e.scroller.className.match(/has-footer-textarea[0-9]*/);null!=d&&angular.element(e.scroller).removeClass(d[0]),angular.element(e.scroller).addClass(r)}}}),e.sendMessage=function(t){m.setWritingMessage(e.friendId,""),c(function(){c.cancel(p.updateMessagesTimeout),p.updateMessagestRefresh=!1}),e.sendingMessage=!0,r.show({templateUrl:"./templates/sending.html"}),u.debug("show sending");var n={friend_id:e.friendId,text:f("emojioneToShort")(e.input.message)};""!==o.productId&&(n.product_id=o.productId),""!==o.friendInformationId&&(n.friend_information_id=o.friendInformationId),m.sendMessage(n).then(function(t){if(e.input.message="",n.id=(new Date).getTime(),n.recipient_id=e.friendId,n.created_at=moment().utc().format("YYYY-MM-DD HH:mm:ss"),n.sender_id=e.userLoggedId,n.sender={},n.sender.imageUrl=e.userLoggedImageUrl,n.title=null,n.local=!0,""!==o.productTitle&&(n.title=""+o.productTitle),""!==o.friendName&&(n.title=""+o.friendName),e.apiRealtime)c(function(){e.sendingMessage&&(u.debug("no response, static call"),h.getStaticList(e.apiPerPage,0,e.friendId,!0).then(function(){e.setApiCalling(!1)}))},_);else{var i=[n];e.setMessageList(i.concat(e.messageList)),c(function(){a.resize(),a.$getByHandle("mainMessageScroll").scrollBottom()},0),r.hide(),u.debug("hide sending success"),e.sendingMessage=!1,p.updateMessagestRefresh=!0,c(function(){e.doRefresh()},7e3)}},function(t){e.apiRealtime||(r.hide(),u.debug("hide sending err"),e.sendingMessage=!1,p.updateMessagestRefresh=!0,c(function(){e.doRefresh()},6e3))})["finally"](function(){e.apiRealtime||(r.hide(),u.debug("hide sending final"))})},e.sendPaymentRequest=function(t){c(function(){c.cancel(p.updateMessagesTimeout)}),e.sendingMessage=!0,r.show({templateUrl:"./templates/sending.html"});var n={friend_id:e.friendId,text:"",price:this.inputPaymentRequest.price,currency_id:this.inputPaymentRequest.currency.id,product_id:this.inputPaymentRequest.product_id,payment_request:1};m.sendMessage(n).then(function(t){if(n.id=(new Date).getTime(),n.created_at=moment().format(),n.sender_id=e.userLoggedId,n.text=t.message.text,n.title=null,n.local=!0,n.paymentRequest=t.message.paymentRequest,n.payment_request_id=t.message.payment_request_id,e.closeModal(),e.apiRealtime)c(function(){e.sendingMessage&&(u.debug("no response, static call"),h.getStaticList(e.apiPerPage,0,e.friendId,!0).then(function(){e.setApiCalling(!1)}))},_);else{var i=[n];e.setMessageList(i.concat(e.messageList)),c(function(){a.resize(),a.$getByHandle("mainMessageScroll").scrollBottom()},0),r.hide(),u.debug("hide sending success"),e.sendingMessage=!1,console.log(p.updateMessagesTimeout),e.doRefresh()}})},d.fromTemplateUrl("templates/message-modal.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t}),e.openModal=function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!1),e.inputPaymentRequest={},0==e.currencies.length?S.getCurrencies().then(function(t){e.currencies=t,e.initializeProductCurrency()}):e.initializeProductCurrency(),e.initializePaymentRequestProductId(),e.modal.show()},e.closeModal=function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),e.modal.hide(),e.inputPaymentRequest={}},e.$on("modal.hidden",function(){}),e.$on("modal.removed",function(){}),e.showMessageActionSheet=function(){l.show({buttons:[{text:'<i class="icon ion-cash"></i>'+P.instant("Send a payment request")}],cancelText:"Cancel",cancel:function(){},buttonClicked:function(t){return e.openModal(),!0}})},e.initializeProductCurrency=function(){if(e.currencies.length){var t=e.user.settings.currency;if("undefined"!=typeof t){var n=Number(t);angular.forEach(e.currencies,function(t){t.id==n&&(e.inputPaymentRequest.currency=t)})}else{var i=f("filter")(e.currencies,{is_default:1},!0)[0];e.inputPaymentRequest.currency=i}}},e.initializePaymentRequestProductId=function(){e.myProducts&&1==e.myProducts.length&&(e.inputPaymentRequest.product_id=e.myProducts[0].id)},e.goToThreads=function(){i.go("main.message-threads")},e.setApiCounter=function(t){e.apiPageCount=Math.round(t/e.apiPerPage)+1,e.apiTotalCount=t,R()},e.setApiCalling=function(t){e.apiCalling=t},e.setMessageList=function(t,n){t=f("unique")(t,"id"),E=null;for(var i=t.length-1;i>=0;i--)t[i].display_message_day=U(i,t[i].created_at,t[i].id);e.messageList=t};var A,L;e.$on("scroll.loaded",T),e.loadMoreTimeout=function(){A=$(".scroll").get(0).scrollHeight,e.page++,e.listLimit=e.getListLimit(),c(function(){e.$broadcast("scroll.refreshComplete"),c(function(){R()},2e3)}),u.debug("loadMore finished, page "+e.page+", listLimit "+e.listLimit)},e.loadMoreUpdate=function(){e.setApiCalling(!0);var t=e.messageList.length,n=e.messageList.length+e.apiPerPage;h.getStaticList(n,t,e.friendId).then(function(){e.setApiCalling(!1)})},e.loadMore=function(){if(e.moreDataCanBeLoaded){u.debug("loadMore");var t=e.messageList.length-e.page*e.pageSize;0>=t?e.apiCalling?(u.debug("loadMore busy - TIMEOUT"),c(function(){e.loadMore()},100)):e.messageList.length<e.apiTotalCount&&(e.page=Math.ceil(e.messageList.length/e.pageSize),e.loadMoreUpdate()):c(function(){e.loadMoreTimeout()},500)}},e.getListLimit=function(){return e.page*e.pageSize};var R=function(){void 0!=e.messageList&&e.messageList.length>0?e.moreDataCanBeLoaded=e.page*e.pageSize<e.messageList.length||e.messageList.length<e.apiTotalCount:e.moreDataCanBeLoaded=!1}}]),angular.module("mellonapp").service("Messages",["$q","ApiMessages",function(e,t){var n="",i="",o=[],a=function(i){return e(function(e,o){t.getLastThreadMessage(i).then(function(t){n=t,e(t)},function(e){o(e)})})},r=function(n,o){return e(function(e,a){t.getMessages(n,o).then(function(t){i=t,e(t)},function(e){a(e)})})},s=function(n){return e(function(e,i){t.sendMessage(n).then(function(t){e(t)},function(e){i(e)})})},c=function(e,t){o[e]=t},u=function(e){return o[e]};return{getLastThreadMessage:a,getMessages:r,sendMessage:s,setWritingMessage:c,getWritingMessage:u}}]),angular.module("mellonapp").factory("MessageRealtime",["$http","$q","$rootScope","$log","ApiUrl",function(e,t,n,i,o){var a=null,r=!1,s=[],c=0,u=function(e){null==a&&(a=io(o.getSocket("MESSAGE"),{secure:!0,forceNew:!0,query:"user_id="+e.access_token})),p(),a.on("error",function(e){i.log(e)}),a.on("connected",function(e){i.log(e)})},l=function(e){a.on("room_joined",function(){}),a.emit("leave_room",e),a.emit("join_room",e)},d=function(){null!=a&&(r=!1,h(),a.disconnect(),a=null)},f=function(e,n,i,o){return t(function(t,r){a.emit("get_static",e,n,i,o),t(!0)})},p=function(){0===a.listeners("count_value").length&&a.on("count_value",function(e){i.log(e),c=e,n.$emit("updateMessageCount",c)}),0===a.listeners("static_value").length&&a.on("static_value",function(e,t,o){i.log("static_value message"),i.log(e),n.$emit("updateMessageStatic",e,o)}),0===a.listeners("initial_value").length&&a.on("initial_value",function(e){i.log("initial_value message"),i.log(e),s=e,n.$emit("updateMessage",s)}),0===a.listeners("new_value").length&&a.on("new_value",function(e){i.log("new_value message"),i.log(e);var t=0;void 0!==e.new_val&&(angular.forEach(s,function(n,i){n.id==e.new_val.id&&(s[i]=e.new_val,t=1)}),0==t&&s.unshift(e.new_val)),n.$emit("updateMessage",s)})},g=function(){return s},m=function(){return c},h=function(){s=[]},v=function(){return r};return{openSocket:u,closeSocket:d,getStaticList:f,getMessageList:g,getMessageCount:m,emptyMessageList:h,getSocketConnected:v,joinRoom:l}}]),angular.module("mellonapp.api").service("ApiMessages",["$q","$http","ApiUrl","$translate",function(e,t,n,i){function o(o){var a="user1";return e(function(e,r){t.get(n.get("LAST_THREAD_MESSAGE")+"/"+o+"?expand="+a).then(function(t){t.data.success?e(t.data.data):r(i.instant("Cannot get last message thread"))},function(){r(i.instant("Server call failed!"))})})}function a(o,a){var r="sender,recipient,paymentRequest,paymentRequest.currency",s="";return void 0!==a&&(s="&time="+a),e(function(e,a){t.get(n.get("MESSAGES")+"/"+o+"?expand="+r+s).then(function(t){t.data.success?e(t.data.data):a(i.instant("Cannot get messages"))},function(){a(i.instant("Server call failed!"))})})}function r(o){return e(function(e,a){t.post(n.get("SEND_MESSAGE"),o).then(function(t){t.data.success?e(t.data.data):a(i.instant("Cannot send messages"))},function(){a(i.instant("Server call failed!"))})})}return{getLastThreadMessage:o,getMessages:a,sendMessage:r}}]),angular.module("mellonapp").controller("MessageThreadsCtrl",["$log","$scope","messageThreadData","$state","$ionicLoading","$rootScope","$timeout","$filter","$ionicPlatform","MessageThreads","MessageThreadRealtime","Messages","AuthService",function(e,t,n,i,o,a,r,s,c,u,l,d,f){t.apiRealtime=!1,t.userLoggedId=f.getUser().id,t.messageThreads=[],t.page=1,t.pageSize=10,t.moreDataCanBeLoaded=null,t.firstLoad=!0;var p=!1,g=!1,m=!1;a.messageThreadRefreshing=!1;var h=function(n){m=!1,a.hideTabs=!1,p||(e.debug("messageThreads "+n.name),a.messageThreadRefreshing=!0,t.hideMessageTabs=!1,S(),b(),p=!0)},v=function(n){a.hideTabs=!1,g||(e.debug("messageThreads "+n.name),e.debug("MessageThread init"),t.apiRealtime?t.initRealtime():(o.show(),u.getThreads().then(function(e){t.initStatic(e)})),g=!0)},y=function(t){p=!1,g=!1,m||(e.debug("messageThreads "+t.name),a.messageThreadRefreshing=!1,r.cancel(a.updateMessageThreadsTimeout),a.updateMessageThreadsRefresh=!1,m=!0)};c.on("resume",function(e){r(function(){1!=a.updateMessageThreadsRefresh&&(a.updateMessageThreadsRefresh=!0,t.doRefresh())},10)}),a.$on("$translateChangeSuccess",function(){1!=a.updateMessageThreadsRefresh&&(a.updateMessageThreadsRefresh=!0,t.doRefresh())}),t.$on("messageTabs.beforeEnter",h),t.$on("$ionicView.beforeEnter",h),t.$on("$ionicView.enter",v),t.$on("messageTabs.enter",v),t.$on("$ionicView.beforeLeave",y),t.$on("messageTabs.beforeLeave",y),t.$on("$destroy",y);var S=function(){void 0!==a.listenerUpdateMessage&&(a.listenerUpdateMessage(),a.listenerUpdateMessageCount(),a.listenerUpdateMessageStatic())},b=function(){void 0!==a.updateMessagesTimeout&&(r.cancel(a.updateMessagesTimeout),a.updateMessagestRefresh=!1,a.messageRefreshing=!1)};t.initStatic=function(e){t.socketConnected=!0,t.apiTotalCount=e.items.length,t.listLimit=t.getListLimit(),t.apiCurrentPage=0,t.apiPerPage=1e4,t.setMessageThreadList(e.items),r(function(){P()}),t.firstLoad=!1,o.hide(),1!=a.updateMessageThreadsRefresh&&(r(function(){t.doRefresh()},5e3),a.updateMessageThreadsRefresh=!0)},t.initRealtime=function(){t.listLimit=t.getListLimit(),t.apiCurrentPage=0,t.apiPerPage=20,t.apiCalling=!1,t.socketConnected=l.getSocketConnected(),t.socketConnected||(e.debug("Chat $ionicLoading.show();"),o.show()),l.openSocket(f.getUser()),0==t.messageThreads.length&&(t.messageThreads=l.getMessageThreadList()),a.$on("MessageThreadConnected",function(){t.socketConnected=l.getSocketConnected()}),void 0==t.listenerUpdateMessageThread&&(t.listenerUpdateMessageThread=a.$on("updateMessageThread",function(n,i){t.firstLoad=!1,t.setMessageThreadsList(i),t.$apply(),P(),e.debug("Chat $ionicLoading.hide();"),o.hide()})),void 0==t.listenerUpdateMessageThreadCount&&(t.listenerUpdateMessageThreadCount=a.$on("updateMessageThreadCount",function(e,n){t.setApiCounter(n)})),void 0==t.listenerUpdateMessageThreadStatic&&(t.listenerUpdateMessageThreadStatic=a.$on("updateMessageThreadStatic",function(e,n){t.setMessageThreadsList(t.messageThreads.concat(n)),t.setApiCalling(!1),t.$apply(),t.loadMoreTimeout()}))},t.doRefresh=function(){var e=Math.floor(Date.now()/1e3);u.getThreads(e).then(function(e){t.setMessageThreadList(e.items),r(function(){P()}),a.updateMessageThreadsRefresh&&(a.updateMessageThreadsTimeout=r(function(){t.doRefresh()},5e3))})},t.setMessageThreadList=function(e,n){e=s("unique")(e,"chatter_ids"),t.messageThreads=e},t.goToThread=function(e){i.go("main.messages",{userId:e})};t.setApiCounter=function(e){t.apiPageCount=Math.round(e/t.apiPerPage)+1,t.apiTotalCount=e,P()},t.setApiCalling=function(e){t.apiCalling=e},t.setMessageThreadsList=function(e){e=s("unique")(e,"chatterIds"),t.messageThreads=e},t.loadMoreTimeout=function(){t.page++,t.listLimit=t.getListLimit(),P(),r(function(){t.$broadcast("scroll.infiniteScrollComplete")}),e.debug("loadMore finished, page "+t.page+", listLimit "+t.listLimit)},t.loadMoreUpdate=function(){t.setApiCalling(!0);var e=t.messageThreads.length,n=t.messageThreads.length+t.apiPerPage;l.getStaticList(n,e).then(function(){})},t.loadMore=function(){if(t.moreDataCanBeLoaded){e.debug("loadMore");var n=t.messageThreads.length-t.page*t.pageSize;0>=n?t.apiCalling?(e.debug("loadMore busy - TIMEOUT"),r(function(){t.loadMore()},100)):t.messageThreads.length<t.apiTotalCount&&(t.page=Math.ceil(t.messageThreads.length/t.pageSize),t.loadMoreUpdate()):r(function(){t.loadMoreTimeout()},500)}},t.getListLimit=function(){return t.page*t.pageSize};var P=function(){1==t.firstLoad?t.moreDataCanBeLoaded=!0:void 0!=t.messageThreads&&t.messageThreads.length>0?t.moreDataCanBeLoaded=t.page*t.pageSize<t.messageThreads.length||t.messageThreads.length<t.apiTotalCount:t.moreDataCanBeLoaded=!1}}]),angular.module("mellonapp").service("MessageThreads",["$q","ApiMessageThreads",function(e,t){var n=[],i="",o=function(i){return e(function(e,o){void 0==i&&(i=void 0),t.getThreads(i).then(function(t){n=t,e(t)},function(e){o(e)})})},a=function(n){return e(function(e,o){t.getLastThreadMessage(n).then(function(t){i=t,e(t)},function(e){o(e)})})};return{getThreads:o,getLastThreadMessage:a}}]),angular.module("mellonapp").factory("MessageThreadRealtime",["$http","$q","$rootScope","$log","ApiUrl",function(e,t,n,i,o){var a=null,r=!1,s=[],c=0,u=function(e){i.debug("MessageThreadRealtime openSocket"),null==a&&(a=io(o.getSocket("MESSAGE_THREAD"),{secure:!0,forceNew:!0,query:"user_id="+e.access_token})),f(),a.on("error",function(e){i.log(e)}),a.on("connected",function(e){r=!0,n.$emit("MessageThreadConnected"),i.log(e),a.on("room_joined",function(){}),a.emit("join_room")})},l=function(){null!=a&&(r=!1,m(),a.disconnect(),a=null)},d=function(e,n){return t(function(t,i){a.emit("get_static",e,n),t(!0)})},f=function(){0===a.listeners("count_value").length&&a.on("count_value",function(e){i.log("count_value message-thread"),i.log(e),c=e,n.$emit("updateMessageThreadCount",c)}),0===a.listeners("static_value").length&&a.on("static_value",function(e){i.log("static_value message-thread"),i.log(e),n.$emit("updateMessageThreadStatic",e)}),0===a.listeners("initial_value").length&&a.on("initial_value",function(e){i.log("initial_value message-thread"),i.log(e),s=e,n.$emit("updateMessageThread",s)}),0===a.listeners("new_value").length&&a.on("new_value",function(e){i.log("new_value message-thread"),i.log(e);s=e,n.$emit("updateMessageThread",s)})},p=function(){return s},g=function(){return c},m=function(){s=[]},h=function(){return r};return{openSocket:u,closeSocket:l,getStaticList:d,getMessageThreadList:p,getMessageThreadCount:g,emptyMessageThreadList:m,getSocketConnected:h}}]),angular.module("mellonapp.api").service("ApiMessageThreads",["$q","$http","ApiUrl","$translate",function(e,t,n,i){function o(o){return e(function(e,a){var r="user1,user2",s="";void 0!==o&&(s="&time="+o),t.get(n.get("MESSAGE_THREADS")+"?expand="+r+s).then(function(t){t.data.success?e(t.data.data):a(i.instant("Cannot get message thread list"))},function(){a(i.instant("Server call failed!"))})})}function a(o){var a="user1";return e(function(e,r){t.get(n.get("LAST_THREAD_MESSAGE")+"/"+o+"?expand="+a).then(function(t){t.data.success?e(t.data.data):r(i.instant("Cannot get last message thread"))},function(){r(i.instant("Server call failed!"))})})}return{getThreads:o,getLastThreadMessage:a}}]),angular.module("mellonapp").controller("NotificationsCtrl",["$q","$log","$scope","$state","$ionicScrollDelegate","$ionicHistory","$ionicLoading","$timeout","$filter","$rootScope","Notifications","NotificationRealtime","AuthService",function(e,t,n,i,o,a,r,s,c,u,l,d,f){n.notificationsList=[],n.page=1,n.pageSize=20,n.moreDataCanBeLoaded=null,n.firstLoad=!0,n.$on("$ionicView.loaded",function(e){t.debug("ROUTER: $ionicView.loaded->Notification")}),n.$on("$ionicView.beforeEnter",function(e){u.hideTabs=!1,n.hideMessageTabs=!1}),n.$on("$ionicView.enter",function(){t.debug("Notification init"),u.hideTabs=!1,n.init(),u.updateNotificationsListRefresh=!0}),n.$on("$destroy",function(e,t,n,i,o){s.cancel(u.updateNotificationsListTimeout)}),n.doRefresh=function(){l.getNotificationsTabList().then(function(e){n.listLimit=n.getListLimit(),n.notificationsList=e.items,o.resize(),u.updateNotificationsListRefresh&&(u.updateNotificationsListTimeout=s(function(){n.doRefresh()},5e3))})["finally"](function(){n.$broadcast("scroll.refreshComplete")})},n.setApiCounter=function(e){n.apiPageCount=Math.round(e/n.apiPerPage)+1,n.apiTotalCount=e,p()},n.setApiCalling=function(e){n.apiCalling=e},n.setNotificationsList=function(e){e=c("unique")(e,"id"),n.notificationsList=e},n.init=function(){n.listLimit=n.getListLimit(),n.apiCurrentPage=0,n.apiPerPage=100,n.apiCalling=!1,n.socketConnected=d.getSocketConnected(),n.socketConnected||(t.debug("Notifiche $ionicLoading.show();"),r.show()),d.openSocket(f.getUser()),0==n.notificationsList.length&&(n.notificationsList=d.getNotificationList()),n.setApiCounter(d.getNotificationCount()),u.$on("NotificationConnected",function(){n.socketConnected=d.getSocketConnected()}),u.$on("updateNotification",function(e,i){n.firstLoad=!1,n.setNotificationsList(i),n.$apply(),p(),t.debug("Notifiche $ionicLoading.hide();"),r.hide()}),u.$on("updateNotificationListCount",function(e,t){n.setApiCounter(t)}),u.$on("updateNotificationStatic",function(e,t){n.setNotificationsList(n.notificationsList.concat(t)),n.loadMoreTimeout(),n.$apply()}),o.resize(),l.setNotificationTypeRead(["link-friend","follow-friend-request","welcome-user","activation-reminder","new-friend","new-deal","order-completed-buyer","order-completed-seller","order-error-seller"])},n.notificationLink=function(e){switch(e.type){case"new-friend":case"link-friend":case"follow-friend-request":i.go("main.friend-detail",{friendId:e.params[0].value});break;case"new-deal":case"welcome-user":case"order-completed-buyer":case"order-completed-seller":case"order-error-seller":}},n.isActiveNotification=function(e){return"welcome-user"!==e.type&&"new-deal"!==e.type&&"activation-reminder"!==e.type&&"order-completed-buyer"!==e.type&&"order-completed-seller"!==e.type&&"order-error-seller"!==e.type},n.loadMoreTimeout=function(){n.page++,n.listLimit=n.getListLimit(),p(),s(function(){n.$broadcast("scroll.infiniteScrollComplete")}),t.debug("loadMore finished, page "+n.page+", listLimit "+n.listLimit)},n.loadMoreUpdate=function(){n.setApiCalling(!0);var e=n.notificationsList.length,t=n.notificationsList.length+n.apiPerPage;d.getStaticList(t,e).then(function(){n.setApiCalling(!1)})},n.loadMore=function(){if(n.moreDataCanBeLoaded){t.debug("loadMore");var e=n.notificationsList.length-n.page*n.pageSize;0>=e?n.apiCalling?(t.debug("loadMore busy - TIMEOUT"),s(function(){n.loadMore()},100)):n.notificationsList.length<n.apiTotalCount&&(n.page=Math.ceil(n.notificationsList.length/n.pageSize),n.loadMoreUpdate()):s(function(){n.loadMoreTimeout()},500)}},n.getListLimit=function(){return n.page*n.pageSize};var p=function(){void 0!=n.notificationsList&&n.notificationsList.length>0?n.moreDataCanBeLoaded=n.page*n.pageSize<n.notificationsList.length||n.notificationsList.length<n.apiTotalCount:n.moreDataCanBeLoaded=!1}}]),angular.module("mellonapp").service("Notifications",["$q","$rootScope","$timeout","$sce","ApiNotifications","filterFilter","AuthService",function(e,t,n,i,o,a,r){var s=!1,c=function(){return e(function(e,t){o.getNotifications().then(function(t){e(t)},function(e){t(e)})})},u=function(){return e(function(e,t){o.getNotificationsTabList().then(function(t){e(t)},function(e){t(e)})})},l=function(t){return e(function(e,n){o.setNotificationRead(t).then(function(t){e(t)},function(e){n(e)})})},d=function(t){return e(function(e,n){o.setNotificationTypeRead(t).then(function(t){e(t)},function(e){n(e)})})},f=function(t){return e(function(e,n){o.setNotificationMessageThreadRead(t).then(function(t){e(t)},function(e){n(e)})})},p=0,g=function(){n.cancel(p)},m=function(e){if(t.notificationCount={},Object.keys(e).length>0){var n=0;angular.forEach(e,function(e,i){t.notificationCount[e.type]=e.numero,n+=parseInt(e.numero)}),t.notificationCount.total=n,void 0!==t.notificationCount["new-deal"]&&(t.notificationCount.total-=t.notificationCount["new-deal"]),cordova.plugins.notification.badge.set(t.notificationCount.total),t.notificationCount.noMessage=t.notificationCount.total,void 0!==t.notificationCount.message&&(t.notificationCount.noMessage-=t.notificationCount.message)}else cordova.plugins.notification.badge.clear()},h=function(){return r.isAuthenticated()?e(function(e,t){o.countNewNotifications().then(function(t){e(t),m(t)},function(e){t(e)})["finally"](function(){s||(p=n(function(){h()},5e3))})}):void(p=n(function(){h()},2e3))},v=function(e){s=e};return{getNotifications:c,getNotificationsTabList:u,setNotificationRead:l,setNotificationTypeRead:d,setNotificationMessageThreadRead:f,cancelCountNewNotifications:g,countNewNotifications:h,countNewNotificationsCalculation:m,setStopRefresh:v}}]),angular.module("mellonapp").factory("NotificationCountRealtime",["$http","$q","$log","$rootScope","ApiUrl",function(e,t,n,i,o){var a=null,r=!1,s={},c=function(e){null==a&&(a=io(o.getSocket("NOTIFICATIONS_COUNT"),{secure:!0,query:"user_id="+e.access_token})),d(),a.on("error",function(e){n.debug(e)}),a.on("connected",function(e){n.debug(e),n.debug("socket.listeners(initial_value)"),n.debug(a.listeners("initial_value")),a.on("room_joined",function(){}),a.emit("join_room")})},u=function(){null!=a&&(r=!1,p(),a.disconnect(),a=null)},l=function(e,n){return t(function(t,i){a.emit("get_static",e,n),t(!0)})},d=function(){0===a.listeners("initial_value").length&&a.on("initial_value",function(e){n.log("initial_value notification-count"),n.debug(e);for(var t in e)s[e[t].type]=e[t];i.$emit("updateNotificationCount",s)}),0===a.listeners("new_value").length&&a.on("new_value",function(e){n.log("count_value notification-count"),n.debug(e),void 0!==e.new_val&&(s[e.new_val.type]=e.new_val),i.$emit("updateNotificationCount",s)})},f=function(){return s},p=function(){s=[]},g=function(){return r};return{openSocket:c,closeSocket:u,getStaticList:l,getNotificationCountList:f,emptyNotificationCountList:p,getSocketConnected:g}}]),angular.module("mellonapp").factory("NotificationRealtime",["$http","$q","$rootScope","$log","ApiUrl",function(e,t,n,i,o){var a=null,r=!1,s=[],c=0,u=function(e){i.debug("NotificationRealtime openSocket"),null==a&&(a=io(o.getSocket("NOTIFICATION"),{secure:!0,forceNew:!0,query:"user_id="+e.access_token})),f(),a.on("error",function(e){i.log(e)}),a.on("connected",function(e){r=!0,n.$emit("MessageThreadConnected"),i.log(e),a.on("room_joined",function(){}),a.emit("join_room")})},l=function(){null!=a&&(r=!1,m(),a.disconnect(),a=null)},d=function(e,n){return t(function(t,i){a.emit("get_static",e,n),t(!0)})},f=function(){0===a.listeners("count_value").length&&a.on("count_value",function(e){i.log("count_value notification"),i.log(e),c=e,n.$emit("updateNotificationListCount",c)}),0===a.listeners("static_value").length&&a.on("static_value",function(e){i.log("static_value notification"),i.log(e),n.$emit("updateNotificationStatic",e)}),0===a.listeners("initial_value").length&&a.on("initial_value",function(e){i.log("initial_value notification"),i.log(e),s=e,n.$emit("updateNotification",s)}),0===a.listeners("new_value").length&&a.on("new_value",function(e){i.log("new_value notification"),i.log(e);var t=0;void 0!==e.new_val&&(angular.forEach(s,function(n,i){n.id==e.new_val.id&&(s[i]=e.new_val,t=1)}),0==t&&s.unshift(e.new_val)),n.$emit("updateNotification",s)})},p=function(){return s},g=function(){return c},m=function(){s=[]},h=function(){return r};return{openSocket:u,closeSocket:l,getStaticList:d,getNotificationList:p,getNotificationCount:g,emptyNotificationList:m,getSocketConnected:h}}]),angular.module("mellonapp.api").service("ApiNotifications",["$q","$http","ApiUrl","$translate",function(e,t,n,i){function o(){return e(function(e,o){var a="params";t.get(n.get("NOTIFICATIONS")+"?expand="+a).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get notifications"))},function(){o(i.instant("Server call failed!"))})})}function a(){return e(function(e,o){var a="params";t.get(n.get("NOTIFICATIONS_TAB_LIST")+"?expand="+a).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get notifications"))},function(){o(i.instant("Server call failed!"))})})}function r(o){return e(function(e,a){var r={id:o};t.post(n.get("SET_NOTIFICATION_READ"),r).then(function(t){t.data.success?e(t.data.data):a(i.instant("Cannot set notifications read"))},function(){a(i.instant("Server call failed!"))})})}function s(o){return e(function(e,a){var r={type:o};t.post(n.get("SET_NOTIFICATION_TYPE_READ"),r).then(function(t){t.data.success?e(t.data.data):a(i.instant("Cannot set notifications type read"))},function(){a(i.instant("Server call failed!"))})})}function c(o){return e(function(e,a){var r={sender_id:o};t.post(n.get("SET_NOTIFICATION_MESSAGE_THREAD_READ"),r).then(function(t){t.data.success?e(t.data.data):a(i.instant("Cannot set notifications thread read"))},function(){a(i.instant("Server call failed!"))})})}function u(){return e(function(e,o){t.get(n.get("COUNT_NOTIFICATIONS")).then(function(t){t.data.success?e(t.data.data):o(i.instant("Cannot get new notifications"))},function(){o(i.instant("Server call failed!"))})})}return{getNotifications:o,getNotificationsTabList:a,setNotificationRead:r,setNotificationTypeRead:s,setNotificationMessageThreadRead:c,countNewNotifications:u}}]),angular.module("mellonapp").factory("PaypalService",["$q","$ionicPlatform","PaypalSettings","$filter","$timeout",function(e,t,n,i,o){function a(){return l=e.defer(),t.ready().then(function(){var e={PayPalEnvironmentProduction:n.payPalProductionId,PayPalEnvironmentSandbox:n.payPalSandboxId};PayPalMobile.init(e,c)}),l.promise}function r(e,t,n){var i=new PayPalPayment(""+e,n,""+t,"Sale");return i}function s(){var e=new PayPalConfiguration({merchantName:n.payPalShopName,merchantPrivacyPolicyURL:n.payPalMerchantPrivacyPolicyURL,merchantUserAgreementURL:n.payPalMerchantUserAgreementURL});return e}function c(){t.ready().then(function(){PayPalMobile.prepareToRender(n.payPalEnv,s(),function(){o(function(){l.resolve()})})})}function u(n,a,s){var c=e.defer();return n=i("number")(n,2),t.ready().then(function(){PayPalMobile.renderSinglePaymentUI(r(n,a,s),function(e){o(function(){c.resolve(e)})},function(e){o(function(){c.reject(e)})})}),c.promise}var l,d={initPaymentUI:a,createPayment:r,configuration:s,onPayPalMobileInit:c,makePayment:u};return d}]),angular.module("mellonapp").service("Text",["$q","$filter","ApiText","$translate",function(e,t,n,i){var o=null,a=function(t){return e(function(e,i){"undefined"==typeof t&&(t=!1),t||!o?n.getIntro().then(function(t){o=t,e(o)},function(e){i(e)}):e(o)})},r=null,s=function(t){return e(function(e,i){"undefined"==typeof t&&(t=!1),t||!r?n.getWallBasilicataModal().then(function(t){s=t,e(s)},function(e){i(e)}):e(s)})},c=null,u=function(t){return e(function(e,i){"undefined"==typeof t&&(t=!1),t||!c?n.getFriendsBasilicataModal().then(function(t){c=t,e(c)},function(e){i(e)}):e(c)})},l=null,d=function(t){return e(function(e,i){"undefined"==typeof t&&(t=!1),t||!l?n.getRegistrationWelcome().then(function(t){l=t,e(l)},function(e){i(e)}):e(l)})};return{getIntro:a,getWallBasilicataModal:s,getFriendsBasilicataModal:u,getRegistrationWelcome:d}}]),angular.module("mellonapp.api").service("ApiText",["$q","$http","$ionicLoading","$ionicScrollDelegate","$log","$filter","ApiUrl","$translate",function(e,t,n,i,o,a,r,s){function c(){return e(function(e,n){t.get(r.get("TEXT_INTRO")).then(function(t){t.data.success?e(t.data.data):n(t.data.data)},function(e){n(s.instant("Server call failed!"))})})}function u(){return e(function(e,n){t.get(r.get("TEXT_WALL_BASILICATA_MODAL")).then(function(t){t.data.success?e(t.data.data):n(t.data.data)},function(e){n(s.instant("Server call failed!"))})})}function l(){return e(function(e,n){t.get(r.get("TEXT_FRIENDS_BASILICATA_MODAL")).then(function(t){t.data.success?e(t.data.data):n(t.data.data)},function(e){n(s.instant("Server call failed!"))})})}function d(){return e(function(e,n){t.get(r.get("TEXT_REGISTRATION_WELCOME")).then(function(t){t.data.success?e(t.data.data):n(t.data.data)},function(e){n(s.instant("Server call failed!"))})})}return{getIntro:c,getWallBasilicataModal:u,getFriendsBasilicataModal:l,getRegistrationWelcome:d}}]);